{
  "summary": {
    "total": 554,
    "skipped": 0,
    "succeeded": 540,
    "failed": 14
  },
  "results": {
    "updated": [
      {
        "name": "Unusual Discovery Signal Alert with Unusual Process Executable",
        "description": "This rule leverages Discovery building block rule alert data to alert on signals with unusual unique host.id, user.id and process.executable entries.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: Higher-Order Rule"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kibana.alert.rule.rule_id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "5671173e-f11d-47c4-8703-2b55890579d7",
        "rule_id": "72ed9140-fe9d-4a34-a026-75b50e484b17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.113Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.894Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:\"1d72d014-e2ab-4707-b056-9b96abe7b511\"",
        "new_terms_fields": [
          "host.id",
          "user.id",
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          ".alerts-security.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "GitHub Owner Role Granted To User",
        "description": "This rule detects when a member is granted the organization owner role of a GitHub organization. This role provides admin level privileges. Any new owner role should be investigated to determine its validity. Unauthorized owner roles could indicate compromise within your organization and provide unlimited access to data and settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.permission",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "a60777bf-5e9a-4c59-84b1-87c81a0ce652",
        "rule_id": "9b343b62-d173-4cfd-bd8b-e6379f964ca4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.115Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.938Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.update_member\" and github.permission == \"admin\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "File with Suspicious Extension Downloaded",
        "description": "Identifies unusual files downloaded from outside the local network that have the potential to be abused for code execution.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://x.com/Laughing_Mantis/status/1518766501385318406",
          "https://wikileaks.org/ciav7p1/cms/page_13763375.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.windows.zone_identifier",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "12b58768-482a-4c57-988f-60f5e3fc5d09",
        "rule_id": "8d366588-cbd6-43ba-95b4-0971c3f906e5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.141Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.913Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.extension : (\n    \"appinstaller\", \"application\", \"appx\", \"appxbundle\", \"cpl\", \"diagcab\", \"diagpkg\", \"diagcfg\", \"manifest\",\n    \"msix\", \"pif\", \"search-ms\", \"searchConnector-ms\", \"settingcontent-ms\", \"symlink\", \"theme\", \"themepack\" \n  ) and file.Ext.windows.zone_identifier > 1 and\n  not\n  (\n    (\n      file.extension : \"msix\" and \n      file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\WinGet\\\\Microsoft.Winget.Source*\",\n        \"?:\\\\Windows\\\\system32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\Microsoft\\\\WinGet\\\\State\\\\defaultState\\\\Microsoft.PreIndexed.Package\\\\Microsoft.Winget.Source*\"\n      )\n    ) or\n    (\n      process.name : \"Teams.exe\" and process.code_signature.trusted == true and\n      file.extension : \"msix\" and \n      file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Teams\\\\tmp\\\\*\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Discovery of Internet Capabilities via Built-in Tools",
        "description": "Identifies the use of built-in tools attackers can use to check for Internet connectivity on compromised systems. These results may be used to determine communication capabilities with C2 servers, or to identify routes, redirectors, and proxy servers.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/",
                "subtechnique": [
                  {
                    "id": "T1016.001",
                    "name": "Internet Connection Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1016/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "5e79146a-0085-46e4-9122-965166d8e17a",
        "rule_id": "7f89afef-9fc5-4e7b-bf16-75ffdf27f8db",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.111Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.747Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and \nprocess.name.caseless:(\"ping.exe\" or \"tracert.exe\" or \"pathping.exe\") and\nnot process.args:(\"127.0.0.1\" or \"0.0.0.0\" or \"localhost\" or \"::1\")",
        "new_terms_fields": [
          "host.id",
          "user.id",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious PowerShell Engine ImageLoad",
        "description": "Identifies the PowerShell engine being invoked by unexpected processes. Rather than executing PowerShell functionality with powershell.exe, some attackers do this to operate more stealthily.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious PowerShell Engine ImageLoad\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell without having to execute `PowerShell.exe` directly. This technique, often called \"PowerShell without PowerShell,\" works by using the underlying System.Management.Automation namespace and can bypass application allowlisting and PowerShell security features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Retrieve the implementation (DLL, executable, etc.) and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity can happen legitimately. Some vendors have their own PowerShell implementations that are shipped with some products. These benign true positives (B-TPs) can be added as exceptions if necessary after analysis.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-security-labs-steps-through-the-r77-rootkit"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable.caseless",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "e36d3a10-9b9b-4b8b-b3f5-9fd33201469b",
        "rule_id": "852c1f19-68e8-43a6-9dce-340771fe1be3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.143Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.224Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:library and \n  dll.name:(\"System.Management.Automation.dll\" or \"System.Management.Automation.ni.dll\") and \n  not (\n    process.code_signature.subject_name:(\"Microsoft Corporation\" or \"Microsoft Dynamic Code Publisher\" or \"Microsoft Windows\") and process.code_signature.trusted:true and not process.name.caseless:(\"regsvr32.exe\" or \"rundll32.exe\")\n  ) and \n  not (\n    process.executable.caseless:(C\\:\\\\Program*Files*\\(x86\\)\\\\*.exe or C\\:\\\\Program*Files\\\\*.exe) and\n    process.code_signature.trusted:true\n  ) and \n  not (\n    process.executable.caseless: C\\:\\\\Windows\\\\Lenovo\\\\*.exe and process.code_signature.subject_name:\"Lenovo\" and \n    process.code_signature.trusted:true\n  ) and \n  not (\n    process.executable.caseless: \"C:\\\\ProgramData\\\\chocolatey\\\\choco.exe\" and\n    process.code_signature.subject_name:\"Chocolatey Software, Inc.\" and process.code_signature.trusted:true\n  ) and not process.executable.caseless : \"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"",
        "new_terms_fields": [
          "host.id",
          "process.executable",
          "user.id"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Windows System Network Connections Discovery",
        "description": "This rule identifies the execution of commands that can be used to enumerate network connections. Adversaries may attempt to get a listing of network connections to or from a compromised system to identify targets within an environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "99b7299d-affe-41ed-880f-ca2e57fb1c3a",
        "rule_id": "c4e9ed3e-55a2-4309-a012-bc3c78dad10a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.145Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.596Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\n(\n  process.name : \"netstat.exe\" or\n  (\n   (\n    (process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n    (\n     (process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n     not process.parent.name : \"net.exe\"\n    )\n   ) and process.args : (\"use\", \"user\", \"session\", \"config\") and not process.args: (\"/persistent:*\", \"/delete\", \"\\\\\\\\*\")\n  ) or\n  (process.name : \"nbtstat.exe\" and process.args : \"-s*\")\n) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Enumerating Domain Trusts via NLTEST.EXE",
        "description": "Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC) replication in a Microsoft Windows NT Domain.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumerating Domain Trusts via NLTEST.EXE\n\nActive Directory (AD) domain trusts define relationships between domains within a Windows AD environment. In this setup, a \"trusting\" domain permits users from a \"trusted\" domain to access resources. These trust relationships can be configurable as one-way, two-way, transitive, or non-transitive, enabling controlled access and resource sharing across domains.\n\nThis rule identifies the usage of the `nltest.exe` utility to enumerate domain trusts. Attackers can use this information to enable the next actions in a target environment, such as lateral movement.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation and are done within the user business context (e.g., an administrator in this context). As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Enumerating Domain Trusts via DSQUERY.EXE - 06a7a03c-c735-47a6-a313-51c354aef6c3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain administrators may use this command-line utility for legitimate information gathering purposes, but it is not common for environments with Windows Server 2012 and newer."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731935(v=ws.11)",
          "https://redcanary.com/blog/how-one-hospital-thwarted-a-ryuk-ransomware-outbreak/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "06ab3a69-edd7-46cc-81f8-af837ebd1434",
        "rule_id": "84da2554-e12a-11ec-b896-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.147Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.240Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.name : \"nltest.exe\" and process.args : (\n        \"/DCLIST:*\", \"/DCNAME:*\", \"/DSGET*\",\n        \"/LSAQUERYFTI:*\", \"/PARENTDOMAIN\",\n        \"/DOMAIN_TRUSTS\", \"/BDC_QUERY:*\"\n        ) and \nnot process.parent.name : \"PDQInventoryScanner.exe\" and \nnot user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "System Service Discovery through built-in Windows Utilities",
        "description": "Detects the usage of commonly used system service discovery techniques, which attackers may use during the reconnaissance phase after compromising a system in order to gain a better understanding of the environment and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1007",
                "name": "System Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1007/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1ea048ba-adbf-41b5-8c24-0e7d1389e2e5",
        "rule_id": "e0881d20-54ac-457f-8733-fe0bc5d44c55",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.149Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.483Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n  ((process.name: \"net.exe\" or process.pe.original_file_name == \"net.exe\" or (process.name : \"net1.exe\" and \n    not process.parent.name : \"net.exe\")) and process.args : (\"start\", \"use\") and process.args_count == 2) or\n  ((process.name: \"sc.exe\" or process.pe.original_file_name == \"sc.exe\") and process.args: (\"query\", \"q*\")) or\n  ((process.name: \"tasklist.exe\" or process.pe.original_file_name == \"tasklist.exe\") and process.args: \"/svc\") or\n  (process.name : \"psservice.exe\" or process.pe.original_file_name == \"psservice.exe\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Discovery Activity by User",
        "description": "This rule leverages alert data from various Discovery building block rules to alert on signals with unusual unique host.id and user.id entries.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: Higher-Order Rule",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kibana.alert.rule.rule_id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "1ef588df-169e-4d30-9a7a-74738e501d78",
        "rule_id": "cf575427-0839-4c69-a9e6-99fde02606f3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.151Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.705Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:(\n  \"d68e95ad-1c82-4074-a12a-125fe10ac8ba\" or \"7b8bfc26-81d2-435e-965c-d722ee397ef1\" or\n  \"0635c542-1b96-4335-9b47-126582d2c19a\" or \"6ea55c81-e2ba-42f2-a134-bccf857ba922\" or\n  \"e0881d20-54ac-457f-8733-fe0bc5d44c55\" or \"06568a02-af29-4f20-929c-f3af281e41aa\" or\n  \"c4e9ed3e-55a2-4309-a012-bc3c78dad10a\" or \"51176ed2-2d90-49f2-9f3d-17196428b169\" or\n  \"1d72d014-e2ab-4707-b056-9b96abe7b511\"\n)",
        "new_terms_fields": [
          "host.id",
          "user.id"
        ],
        "history_window_start": "now-14d",
        "index": [
          ".alerts-security.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "RDP (Remote Desktop Protocol) from the Internet",
        "description": "This rule detects network events that may indicate the use of RDP traffic from the Internet. RDP is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "300afc76-072d-4261-864d-4149714bf3f1",
        "timeline_title": "Comprehensive Network Timeline",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Tactic: Command and Control",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some network security policies allow RDP directly from the Internet but usage that is unfamiliar to server or network owners can be unexpected and suspicious. RDP services may be exposed directly to the Internet in some networks such as cloud environments. In such cases, only RDP gateways, bastions or jump servers may be expected expose RDP directly to the Internet and can be exempted from this rule. RDP may be required by some work-flows such as remote access and support for specialized software products and servers. Such work-flows are usually known and not unexpected."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "145a5999-b3d3-4ce2-af28-2df6548ecf0a",
        "rule_id": "8c1bdde8-4204-45c0-9e0c-c85ca3902488",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.157Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.502Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:3389 or event.dataset:zeek.rdp) and\n  not source.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  ) and\n  destination.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  )",
        "language": "kuery"
      },
      {
        "name": "SMTP on Port 26/TCP",
        "description": "This rule detects events that may indicate use of SMTP on TCP port 26. This port is commonly used by several popular mail transfer agents to deconflict with the default SMTP port 25. This port has also been used by a malware family called BadPatch for command and control of Windows systems.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Tactic: Command and Control",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Servers that process email traffic may cause false positives and should be excluded from this rule as this is expected behavior."
        ],
        "references": [
          "https://unit42.paloaltonetworks.com/unit42-badpatch/",
          "https://isc.sans.edu/forums/diary/Next+up+whats+up+with+TCP+port+26/25564/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1048",
                "name": "Exfiltration Over Alternative Protocol",
                "reference": "https://attack.mitre.org/techniques/T1048/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bf3822b5-6e92-48e2-878f-d25a5d059932",
        "rule_id": "d7e62693-aab9-4f66-a21a-3d79ecdd603d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.153Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.581Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset: (network_traffic.flow or zeek.smtp) or event.category:(network or network_traffic)) and network.transport:tcp and destination.port:26",
        "language": "kuery"
      },
      {
        "name": "File Compressed or Archived into Common Format",
        "description": "Detects files being compressed or archived into common formats. This is a common technique used to obfuscate files to evade detection or to staging data for exfiltration.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 5,
        "tags": [
          "Data Source: Elastic Defend",
          "Domain: Endpoint",
          "OS: macOS",
          "OS: Windows",
          "Tactic: Collection",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://en.wikipedia.org/wiki/List_of_file_signatures"
        ],
        "max_signals": 1000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1074",
                "name": "Data Staged",
                "reference": "https://attack.mitre.org/techniques/T1074/",
                "subtechnique": [
                  {
                    "id": "T1074.001",
                    "name": "Local Data Staging",
                    "reference": "https://attack.mitre.org/techniques/T1074/001/"
                  }
                ]
              },
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/",
                "subtechnique": [
                  {
                    "id": "T1560.001",
                    "name": "Archive via Utility",
                    "reference": "https://attack.mitre.org/techniques/T1560/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1132",
                "name": "Data Encoding",
                "reference": "https://attack.mitre.org/techniques/T1132/",
                "subtechnique": [
                  {
                    "id": "T1132.001",
                    "name": "Standard Encoding",
                    "reference": "https://attack.mitre.org/techniques/T1132/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "936ec913-0d3d-4f45-97a8-76933d377bee",
        "rule_id": "79124edf-30a8-4d48-95c4-11522cad94b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.155Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.904Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and process.executable != null and not user.id : (\"S-1-5-18\", \"S-1-5-17\") and\n file.Ext.header_bytes : (\n                          /* compression formats */\n                          \"1F9D*\",             /* tar zip, tar.z (Lempel-Ziv-Welch algorithm) */\n                          \"1FA0*\",             /* tar zip, tar.z (LZH algorithm) */\n                          \"425A68*\",           /* Bzip2 */\n                          \"524E4301*\",         /* Rob Northen Compression */\n                          \"524E4302*\",         /* Rob Northen Compression */\n                          \"4C5A4950*\",         /* LZIP */\n                          \"504B0*\",            /* ZIP */\n                          \"526172211A07*\",     /* RAR compressed */\n                          \"44434D0150413330*\", /* Windows Update Binary Delta Compression file */\n                          \"50413330*\",         /* Windows Update Binary Delta Compression file */\n                          \"377ABCAF271C*\",     /* 7-Zip */\n                          \"1F8B*\",             /* GZIP */\n                          \"FD377A585A00*\",     /* XZ, tar.xz */\n                          \"7801*\",\t           /* zlib: No Compression (no preset dictionary) */\n                          \"785E*\",\t           /* zlib: Best speed (no preset dictionary) */\n                          \"789C*\",\t           /* zlib: Default Compression (no preset dictionary) */\n                          \"78DA*\", \t           /* zlib: Best Compression (no preset dictionary) */\n                          \"7820*\",\t           /* zlib: No Compression (with preset dictionary) */\n                          \"787D*\",\t           /* zlib: Best speed (with preset dictionary) */\n                          \"78BB*\",\t           /* zlib: Default Compression (with preset dictionary) */\n                          \"78F9*\",\t           /* zlib: Best Compression (with preset dictionary) */\n                          \"62767832*\",         /* LZFSE */\n                          \"28B52FFD*\",         /* Zstandard, zst */\n                          \"5253564B44415441*\", /* QuickZip rs compressed archive */\n                          \"2A2A4143452A2A*\",   /* ACE */\n\n                          /* archive formats */\n                          \"2D686C302D*\",       /* lzh */\n                          \"2D686C352D*\",       /* lzh */\n                          \"303730373037*\",     /* cpio */\n                          \"78617221*\",         /* xar */\n                          \"4F4152*\",           /* oar */\n                          \"49536328*\"          /* cab archive */\n ) and\n not (\n   (\n     process.name : \"firefox.exe\" and\n     process.code_signature.subject_name : \"Mozilla Corporation\" and process.code_signature.trusted == true\n   ) or\n   (\n     process.name : \"wazuh-agent.exe\" and\n     process.code_signature.subject_name : \"Wazuh, Inc\" and process.code_signature.trusted == true and\n     file.name : (\"ossec-*.log.gz\", \"tmp-entry.gz\", \"tmp-entry\", \"last-entry.gz\")\n   ) or\n   (\n     process.name : (\"excel.exe\", \"winword.exe\", \"powerpnt.exe\") and\n     process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true\n   ) or\n   (\n     process.name : \"OneDrive.exe\" and\n     process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true and\n     (\n      file.extension : (\"xlsx\", \"docx\", \"pptx\", \"xlsm\") or\n      file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\logs\\\\*\"\n     )\n   ) or\n   (\n     process.name : \"Dropbox.exe\" and\n     process.code_signature.subject_name : \"Dropbox, Inc\" and process.code_signature.trusted == true and\n     file.name : \"store.bin\"\n   ) or\n   (\n     process.name : \"DellSupportAssistRemedationService.exe\" and\n     process.code_signature.subject_name : \"Dell Inc\" and process.code_signature.trusted == true and\n     file.extension : \"manifest\"\n   ) or\n   (\n     process.name : \"w3wp.exe\" and\n     process.code_signature.subject_name : \"Microsoft Windows\" and process.code_signature.trusted == true and\n     file.path : \"?:\\\\inetpub\\\\temp\\\\IIS Temporary Compressed Files\\\\*\"\n   )\n )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Browser Extension Install",
        "description": "Identifies the install of browser extensions. Malicious browser extensions can be installed via app store downloads masquerading as legitimate extensions, social engineering, or by an adversary that has already compromised a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1176",
                "name": "Browser Extensions",
                "reference": "https://attack.mitre.org/techniques/T1176/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d4670d58-2501-49dd-9565-59e22c361fae",
        "rule_id": "f97504ac-1053-498f-aeaa-c6d01e76b379",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.223Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.774Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type : \"creation\" and \n(\n  /* Firefox-Based Browsers */\n  (\n    file.name : \"*.xpi\" and\n    file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\\\\Profiles\\\\*\\\\Extensions\\\\*.xpi\" and\n    not \n    (\n      process.name : \"firefox.exe\" and\n      file.name : (\"langpack-*@firefox.mozilla.org.xpi\", \"*@dictionaries.addons.mozilla.org.xpi\")\n    )\n  ) or\n  /* Chromium-Based Browsers */\n  (\n    file.name : \"*.crx\" and\n    file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\*\\\\*\\\\User Data\\\\Webstore Downloads\\\\*\"\n  )\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious WMI Event Subscription Created",
        "description": "Detects the creation of a WMI Event Subscription. Attackers can abuse this mechanism for persistence or to elevate to SYSTEM privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf",
          "https://medium.com/threatpunter/detecting-removing-wmi-persistence-60ccbb7dff96"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.003",
                    "name": "Windows Management Instrumentation Event Subscription",
                    "reference": "https://attack.mitre.org/techniques/T1546/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.Consumer",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Operation",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "f7f67987-f0d7-4633-bb06-e15b396a9595",
        "rule_id": "e72f87d0-a70e-4f8d-8443-a6407bc34643",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.160Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.858Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.dataset == \"windows.sysmon_operational\" and event.code == \"21\" and\n    winlog.event_data.Operation : \"Created\" and winlog.event_data.Consumer : (\"*subscription:CommandLineEventConsumer*\", \"*subscription:ActiveScriptEventConsumer*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potentially Suspicious Process Started via tmux or screen",
        "description": "This rule monitors for the execution of suspicious commands via screen and tmux. When launching a command and detaching directly, the commands will be executed in the background via its parent process. Attackers may leverage screen or tmux to execute commands while attempting to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3b424472-a23a-44ab-9e28-725908dea235",
        "rule_id": "e0cc3807-e108-483c-bf66-5a4fbe0d7e89",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.245Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.731Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.parent.name in (\"screen\", \"tmux\") and process.name like (\n  \"nmap\", \"nc\", \"ncat\", \"netcat\", \"socat\", \"nc.openbsd\", \"ngrok\", \"ping\", \"java\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n  \"openssl\", \"telnet\", \"wget\", \"curl\", \"id\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Service Path Modification",
        "description": "Identifies attempts to modify a service path by an unusual process. Attackers may attempt to modify existing services for persistence or privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "482f4777-7c8d-452f-afe3-67e7b26f1004",
        "rule_id": "f243fe39-83a4-46f3-a3b6-707557a102df",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.247Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.764Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\"\n  ) and not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\services.exe\",\n      \"?:\\\\Windows\\\\WinSxS\\\\*\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Roshal Archive (RAR) or PowerShell File Downloaded from the Internet",
        "description": "Detects a Roshal Archive (RAR) file or PowerShell script downloaded from the internet by an internal host. Gaining initial access to a system and then downloading encoded or encrypted tools to move laterally is a common practice for adversaries as a way to protect their more valuable tools and tactics, techniques, and procedures (TTPs). This may be atypical behavior for a managed network and can be indicative of malware, exfiltration, or command and control.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Threat intel\n\nThis activity has been observed in FIN7 campaigns.",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Domain: Endpoint",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Downloading RAR or PowerShell files from the Internet may be expected for certain systems. This rule should be tailored to either exclude systems as sources or destinations in which this behavior is expected."
        ],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2017/04/fin7-phishing-lnk.html",
          "https://www.justice.gov/opa/press-release/file/1084361/download",
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "url.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "url.path",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "e963d5ce-a706-4b85-a5cf-c8431b2a1f15",
        "rule_id": "ff013cb4-274d-434a-96bb-fe15ddd3ae92",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.250Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.733Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset: (network_traffic.http or network_traffic.tls) or\n  (event.category: (network or network_traffic) and network.protocol: http)) and\n  (url.extension:(ps1 or rar) or url.path:(*.ps1 or *.rar)) and\n    not destination.ip:(\n      10.0.0.0/8 or\n      127.0.0.0/8 or\n      169.254.0.0/16 or\n      172.16.0.0/12 or\n      192.0.0.0/24 or\n      192.0.0.0/29 or\n      192.0.0.8/32 or\n      192.0.0.9/32 or\n      192.0.0.10/32 or\n      192.0.0.170/32 or\n      192.0.0.171/32 or\n      192.0.2.0/24 or\n      192.31.196.0/24 or\n      192.52.193.0/24 or\n      192.168.0.0/16 or\n      192.88.99.0/24 or\n      224.0.0.0/4 or\n      100.64.0.0/10 or\n      192.175.48.0/24 or\n      198.18.0.0/15 or\n      198.51.100.0/24 or\n      203.0.113.0/24 or\n      240.0.0.0/4 or\n      \"::1\" or\n      \"FE80::/10\" or\n      \"FF00::/8\"\n    ) and\n    source.ip:(\n      10.0.0.0/8 or\n      172.16.0.0/12 or\n      192.168.0.0/16\n    )",
        "language": "kuery"
      },
      {
        "name": "SoftwareUpdate Preferences Modification",
        "description": "Identifies changes to the SoftwareUpdate preferences using the built-in defaults command. Adversaries may abuse this in an attempt to disable security updates.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Authorized SoftwareUpdate Settings Changes"
        ],
        "references": [
          "https://blog.checkpoint.com/2017/07/13/osxdok-refuses-go-away-money/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5ee1ae5c-bd6a-4e5e-8ecc-e5ba6847e035",
        "rule_id": "f683dcdf-a018-4801-b066-193d4ae6c8e5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.252Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.709Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n process.name:defaults and\n process.args:(write and \"-bool\" and (com.apple.SoftwareUpdate or /Library/Preferences/com.apple.SoftwareUpdate.plist) and not (TRUE or true))",
        "language": "kuery"
      },
      {
        "name": "Host Files System Changes via Windows Subsystem for Linux",
        "description": "Detects files creation and modification on the host system from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/microsoft/WSL"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9fc9902a-6d4e-49aa-9401-9215eb4c9eb1",
        "rule_id": "e88d1fe9-b2f4-48d4-bace-a026dc745d4b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.254Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.673Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=5m\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"dllhost.exe\" and \n   /* Plan9FileSystem CLSID - WSL Host File System Worker */\n  process.command_line : \"*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*\"]\n [file where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and not file.path : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Execution of Persistent Suspicious Program",
        "description": "Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage and command line usage.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "248cb353-9805-4995-8d09-1d61c7d649a2",
        "rule_id": "e7125cea-9fe1-42a5-9a05-b0792cf86f5a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.256Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.670Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */\nsequence by host.id, user.name with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"userinit.exe\" and process.parent.name : \"winlogon.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"explorer.exe\" and\n   /* add suspicious programs here */\n   process.pe.original_file_name in (\"cscript.exe\",\n                                     \"wscript.exe\",\n                                     \"PowerShell.EXE\",\n                                     \"MSHTA.EXE\",\n                                     \"RUNDLL32.EXE\",\n                                     \"REGSVR32.EXE\",\n                                     \"RegAsm.exe\",\n                                     \"MSBuild.exe\",\n                                     \"InstallUtil.exe\") and\n    /* add potential suspicious paths here */\n    process.args : (\"C:\\\\Users\\\\*\", \"C:\\\\ProgramData\\\\*\", \"C:\\\\Windows\\\\Temp\\\\*\", \"C:\\\\Windows\\\\Tasks\\\\*\", \"C:\\\\PerfLogs\\\\*\", \"C:\\\\Intel\\\\*\")\n   ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Authorization Plugin Modification",
        "description": "Authorization plugins are used to extend the authorization services API and implement mechanisms that are not natively supported by the OS, such as multi-factor authentication with third party software. Adversaries may abuse this feature to persist and/or collect clear text credentials as they traverse the registered plugins during user logon.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.apple.com/documentation/security/authorization_plug-ins",
          "https://www.xorrior.com/persistent-credential-theft/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.002",
                    "name": "Authentication Package",
                    "reference": "https://attack.mitre.org/techniques/T1547/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "593eebc0-08ef-454d-8520-bc844a46a7e2",
        "rule_id": "e6c98d38-633d-4b3e-9387-42112cd5ac10",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.261Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.663Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and not event.type:deletion and\n  file.path:(/Library/Security/SecurityAgentPlugins/* and\n  not (/Library/Security/SecurityAgentPlugins/KandjiPassport.bundle/* or /Library/Security/SecurityAgentPlugins/TeamViewerAuthPlugin.bundle/*)) and\n  not (process.name:shove and process.code_signature.trusted:true)",
        "language": "kuery"
      },
      {
        "name": "IPSEC NAT Traversal Port Activity",
        "description": "This rule detects events that could be describing IPSEC NAT Traversal traffic. IPSEC is a VPN technology that allows one system to talk to another using encrypted tunnels. NAT Traversal enables these tunnels to communicate over the Internet where one of the sides is behind a NAT router gateway. This may be common on your network, but this technique is also used by threat actors to avoid detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Tactic: Command and Control",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some networks may utilize these protocols but usage that is unfamiliar to local network administrators can be unexpected and suspicious. Because this port is in the ephemeral range, this rule may false under certain conditions, such as when an application server with a public IP address replies to a client which has used a UDP port in the range by coincidence. This is uncommon but such servers can be excluded."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ca1b01ed-f6f6-44b4-80fb-cfc4195f9509",
        "rule_id": "a9cb3641-ff4b-4cdc-a063-b4b8d02a67c7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.262Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.446Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and network.transport:udp and destination.port:4500",
        "language": "kuery"
      },
      {
        "name": "Downloaded URL Files",
        "description": "Identifies .url shortcut files downloaded from outside the local network. These shortcut files are commonly used in phishing campaigns.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.windows.zone_identifier",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2ca62cd6-8b96-45ce-b31c-c83941732c20",
        "rule_id": "cd82e3d6-1346-4afd-8f22-38388bbf34cb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.267Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.702Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension == \"url\"\n   and file.Ext.windows.zone_identifier > 1 and not process.name : \"explorer.exe\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "WMI WBEMTEST Utility Execution",
        "description": "Adversaries may abuse the WMI diagnostic tool, wbemtest.exe, to enumerate WMI object instances or invoke methods against local or remote endpoints.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9d8f9ef4-99dd-49c1-b63f-c7e87d1a8a36",
        "rule_id": "d3551433-782f-4e22-bbea-c816af2d41c6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.259Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.721Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"wbemtest.exe\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Linux Process Hooking via GDB",
        "description": "This rule monitors for potential memory dumping through gdb. Attackers may leverage memory dumping techniques to attempt secret extraction from privileged processes. Tools that display this behavior include \"truffleproc\" and \"bash-memory-dump\". This behavior should not happen by default, and should be investigated thoroughly.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/controlplaneio/truffleproc",
          "https://github.com/hajzer/bash-memory-dump"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.007",
                    "name": "Proc Filesystem",
                    "reference": "https://attack.mitre.org/techniques/T1003/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "026cfae1-30f2-4c1f-8755-36e8ac9617d1",
        "rule_id": "66c058f3-99f4-4d18-952b-43348f2577a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.269Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.887Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"gdb\" and process.args in (\"--pid\", \"-p\") and \n/* Covered by d4ff2f53-c802-4d2e-9fb9-9ecc08356c3f */\nprocess.args != \"1\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Account or Group Discovery via Built-In Tools",
        "description": "Adversaries may use built-in applications to get a listing of local system or domain accounts and groups.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  },
                  {
                    "id": "T1069.002",
                    "name": "Domain Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/002/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9cf5e69b-43a6-41dd-a085-68b904713676",
        "rule_id": "f638a66d-3bbf-46b1-a52c-ef6f39fb6caf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.271Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.912Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and ( \n  (process.name in (\"groups\", \"id\")) or \n  (process.name == \"dscl\" and process.args : (\"/Active Directory/*\", \"/Users*\", \"/Groups*\")) or\n  (process.name == \"dscacheutil\" and process.args in (\"user\", \"group\")) or\n  (process.args in (\"/etc/passwd\", \"/etc/master.passwd\", \"/etc/sudoers\")) or\n  (process.name == \"getent\" and process.args in (\"passwd\", \"group\"))\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious macOS MS Office Child Process",
        "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, and Excel). These child processes are often launched during exploitation of Office applications or by documents with malicious macros.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.malwarebytes.com/cybercrime/2017/02/microsoft-office-macro-malware-targets-macs/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3f749aa9-5550-401e-ab93-505f4906da95",
        "rule_id": "66da12b1-ac83-40eb-814c-07ed1d82b7b9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.273Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:19.683Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.action == \"exec\" and host.os.type == \"macos\" and\n    process.parent.name: (\n      \"Microsoft Word\",\n      \"Microsoft Outlook\",\n      \"Microsoft Excel\",\n      \"Microsoft PowerPoint\",\n      \"Microsoft OneNote\"\n    ) and\n  process.name : (\n    \"curl\",\n    \"nscurl\",\n    \"bash\",\n    \"sh\",\n    \"osascript\",\n    \"python*\",\n    \"perl*\",\n    \"mktemp\",\n    \"chmod\",\n    \"php\",\n    \"nohup\",\n    \"openssl\",\n    \"plutil\",\n    \"PlistBuddy\",\n    \"xattr\",\n    \"mktemp\",\n    \"sqlite3\",\n    \"funzip\",\n    \"popen\"\n  ) and\n\n  // Filter FPs related to product version discovery and Office error reporting behavior\n  not process.args:\n    (\n      \"ProductVersion\",\n      \"hw.model\",\n      \"ioreg\",\n      \"ProductName\",\n      \"ProductUserVisibleVersion\",\n      \"ProductBuildVersion\",\n      \"/Library/Application Support/Microsoft/MERP*/Microsoft Error Reporting.app/Contents/MacOS/Microsoft Error Reporting\",\n      \"open -a Safari *\",\n      \"defaults read *\",\n      \"sysctl hw.model*\",\n      \"ioreg -d2 -c IOPlatformExpertDevice *\",\n      \"ps aux | grep 'ToDesk_Desktop' | grep -v grep\",\n      \"PIPE=\\\"$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\"\n    ) and\n\n   not process.parent.executable :\n        (\n          \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n          \"/usr/local/Privacy-i/PISupervisor\",\n          \"/Library/Addigy/lan-cache\",\n          \"/Library/Elastic/Agent/*\",\n          \"/opt/jc/bin/jumpcloud-agent\",\n          \"/usr/sbin/networksetup\"\n        ) and\n   not (process.name : \"sh\" and process.command_line : \"*$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\") and\n\n   not process.Ext.effective_parent.executable : (\n        \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n        \"/usr/local/Privacy-i/PISupervisor\",\n        \"/Library/Addigy/auditor\",\n        \"/Library/Elastic/Agent/*\",\n        \"/opt/jc/bin/jumpcloud-agent\",\n        \"/usr/sbin/networksetup\"\n      )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Shortcut File Written or Modified on Startup Folder",
        "description": "Identifies shortcut files written to or modified in the startup folder. Adversaries may use this technique to maintain persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  },
                  {
                    "id": "T1547.009",
                    "name": "Shortcut Modification",
                    "reference": "https://attack.mitre.org/techniques/T1547/009/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "194a24b9-2b5a-49e4-aef8-ac66e2779fdd",
        "rule_id": "ee53d67a-5f0c-423c-a53c-8084ae562b5c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.276Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.757Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension == \"lnk\" and\n  file.path : (\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n    \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\"\n  ) and\n  not (\n    (process.name : \"ONENOTE.EXE\" and process.code_signature.status: \"trusted\" and file.name : \"*OneNote.lnk\") or\n    (process.name : \"OktaVerifySetup.exe\" and process.code_signature.status: \"trusted\" and file.name : \"Okta Verify.lnk\") or\n    (process.name : \"OneLaunch.exe\" and process.code_signature.status: \"trusted\" and file.name : \"OneLaunch*.lnk\") or\n    (process.name : \"APPServerClient.exe\" and process.code_signature.status: \"trusted\" and file.name : \"Parallels Client.lnk\")\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious CertUtil Commands",
        "description": "Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part of Certificate Services. CertUtil is often abused by attackers to live off the land for stealthier command and control or data exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious CertUtil Commands\n\n`certutil.exe` is a command line utility program that is included with Microsoft Windows operating systems. It is used to manage and manipulate digital certificates and certificate services on computers running Windows.\n\nAttackers can abuse `certutil.exe` utility to download and/or deobfuscate malware, offensive security tools, and certificates from external sources to take the next steps in a compromised environment. This rule identifies command line arguments used to accomplish these behaviors.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine the nature of the execution.\n  - If files were downloaded, retrieve them and check whether they were run, and under which security context.\n  - If files were obfuscated or deobfuscated, retrieve them.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the involved files using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/Moriarty_Meng/status/984380793383370752",
          "https://twitter.com/egre55/status/1087685529016193025",
          "https://www.sysadmins.lv/blog-en/certutil-tips-and-tricks-working-with-x509-file-format.aspx",
          "https://docs.microsoft.com/en-us/archive/blogs/pki/basic-crl-checking-with-certutil",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ece65da4-2241-4399-af7b-f04e4fed7f43",
        "rule_id": "fd70c98a-c410-42dc-a2e3-761c71848acf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.278Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.612Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"certutil.exe\" or ?process.pe.original_file_name == \"CertUtil.exe\") and\n  process.args : (\"?decode\", \"?encode\", \"?urlcache\", \"?verifyctl\", \"?encodehex\", \"?decodehex\", \"?exportPFX\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Query Registry using Built-in Tools",
        "description": "This rule identifies the execution of commands that can be used to query the Windows Registry. Adversaries may query the registry to gain situational awareness about the host, like installed security software, programs and settings.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "24h",
        "from": "now-86400s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1012",
                "name": "Query Registry",
                "reference": "https://attack.mitre.org/techniques/T1012/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "205b3a9a-e7b7-43ae-b6fc-e2688b7316ad",
        "rule_id": "ded09d02-0137-4ccc-8005-c45e617e8d4c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.280Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.726Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and\n  (\n    (process.name.caseless:\"reg.exe\" and process.args:\"query\") or\n    (process.name.caseless:(\"powershell.exe\" or \"powershell_ise.exe\" or \"pwsh.exe\") and\n     process.args:(\n       (\"get-childitem\" or \"Get-ChildItem\" or \"gci\" or \"dir\" or \"ls\" or\n        \"get-item\" or \"Get-Item\" or \"gi\" or\n        \"get-itemproperty\" or \"Get-ItemProperty\" or \"gp\") and\n       (\"hkcu\" or \"HKCU\" or \"hkey_current_user\" or \"HKEY_CURRENT_USER\" or\n        \"hkey_local_machine\" or \"HKEY_LOCAL_MACHINE\" or\n        \"hklm\" or \"HKLM\" or registry\\:\\:*)\n      )\n    )\n  ) and\n  not process.command_line : (\n    \"C:\\\\Windows\\\\system32\\\\reg.exe  query hklm\\\\software\\\\microsoft\\\\windows\\\\softwareinventorylogging /v collectionstate /reg:64\" or\n    \"reg  query \\\"HKLM\\\\Software\\\\WOW6432Node\\\\Npcap\\\" /ve  \"\n  )",
        "new_terms_fields": [
          "host.id",
          "user.id"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Child Process of Adobe Acrobat Reader Update Service",
        "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Adobe Acrobat Reader PrivilegedHelperTool responsible for installing updates. For more information, refer to CVE-2020-9615, CVE-2020-9614 and CVE-2020-9613 and verify that the impacted system is patched.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted system or Adobe Acrobat Related processes."
        ],
        "references": [
          "https://rekken.github.io/2020/05/14/Security-Flaws-in-Adobe-Acrobat-Reader-Allow-Malicious-Program-to-Gain-Root-on-macOS-Silently/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b0d61e2c-a87f-4e6b-bf03-cdc46c9c2e77",
        "rule_id": "f85ce03f-d8a8-4c83-acdc-5c8cd0592be7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.282Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.713Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n  process.parent.name:com.adobe.ARMDC.SMJobBlessHelper and\n  user.name:root and\n  not process.executable: (/Library/PrivilegedHelperTools/com.adobe.ARMDC.SMJobBlessHelper or\n                           /usr/bin/codesign or\n                           /private/var/folders/zz/*/T/download/ARMDCHammer or\n                           /usr/sbin/pkgutil or\n                           /usr/bin/shasum or\n                           /usr/bin/perl* or\n                           /usr/sbin/spctl or\n                           /usr/sbin/installer or\n                           /usr/bin/csrutil)",
        "language": "kuery"
      },
      {
        "name": "First Time Seen Commonly Abused Remote Access Tool Execution",
        "description": "Adversaries may install legitimate remote access tools (RAT) to compromised endpoints for further command-and-control (C2). Adversaries can rely on installed RATs for persistence, execution of native commands and more. This rule detects when a process is started whose name or code signature resembles commonly abused RATs. This is a New Terms rule type indicating the host has not seen this RAT process started before within the last 30 days.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Time Seen Commonly Abused Remote Access Tool Execution\n\nRemote access software is a class of tools commonly used by IT departments to provide support by connecting securely to users' computers. Remote access is an ever-growing market where new companies constantly offer new ways of quickly accessing remote systems.\n\nAt the same pace as IT departments adopt these tools, the attackers also adopt them as part of their workflow to connect into an interactive session, maintain access with legitimate software as a persistence mechanism, drop malicious software, etc.\n\nThis rule detects when a remote access tool is seen in the environment for the first time in the last 15 days, enabling analysts to investigate and enforce the correct usage of such tools.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Check if the execution of the remote access tool is approved by the organization's IT department.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n  - If the tool is not approved for use in the organization, the employee could have been tricked into installing it and providing access to a malicious third party. Investigate whether this third party could be attempting to scam the end-user or gain access to the environment through social engineering.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- If an authorized support person or administrator used the tool to conduct legitimate support or remote access, consider reinforcing that only tooling approved by the IT policy should be used. The analyst can dismiss the alert if no other suspicious behavior is observed involving the host or users.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full scan using the antimalware tool in place. This scan can reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If an unauthorized third party did the access via social engineering, consider improvements to the security awareness program.\n- Enforce that only tooling approved by the IT policy should be used for remote access purposes and only by authorized staff.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/",
          "https://attack.mitre.org/techniques/T1219/",
          "https://github.com/redcanaryco/surveyor/blob/master/definitions/remote-admin.json"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2098c67e-a262-4539-81b8-743f8cd9ad00",
        "rule_id": "6e1a2cc4-d260-11ed-8829-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.290Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.400Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type: \"windows\" and\n\n   event.category: \"process\" and event.type : \"start\" and\n\n    (\n        process.code_signature.subject_name : (\n            \"Action1 Corporation\" or\n            \"AeroAdmin LLC\" or\n            \"Ammyy LLC\" or\n            \"Atera Networks Ltd\" or\n            \"AWERAY PTE. LTD.\" or\n            \"BeamYourScreen GmbH\" or\n            \"Bomgar Corporation\" or\n            \"DUC FABULOUS CO.,LTD\" or\n            \"DOMOTZ INC.\" or\n            \"DWSNET O\" or\n            \"FleetDeck Inc\" or\n            \"GlavSoft LLC\" or\n            \"GlavSoft LLC.\" or\n            \"Hefei Pingbo Network Technology Co. Ltd\" or\n            \"IDrive, Inc.\" or\n            \"IMPERO SOLUTIONS LIMITED\" or\n            \"Instant Housecall\" or\n            \"ISL Online Ltd.\" or\n            \"LogMeIn, Inc.\" or\n            \"Monitoring Client\" or\n            \"MMSOFT Design Ltd.\" or\n            \"Nanosystems S.r.l.\" or\n            \"NetSupport Ltd\" or\n            \"NinjaRMM, LLC\" or\n            \"Parallels International GmbH\" or\n            \"philandro Software GmbH\" or\n            \"Pro Softnet Corporation\" or\n            \"RealVNC\" or\n            \"RealVNC Limited\" or\n            \"BreakingSecurity.net\" or\n            \"Remote Utilities LLC\" or\n            \"Rocket Software, Inc.\" or\n            \"SAFIB\" or\n            \"Servably, Inc.\" or\n            \"ShowMyPC INC\" or\n            \"Splashtop Inc.\" or\n            \"Superops Inc.\" or\n            \"TeamViewer\" or\n            \"TeamViewer GmbH\" or\n            \"TeamViewer Germany GmbH\" or\n            \"Techinline Limited\" or\n            \"uvnc bvba\" or\n            \"Yakhnovets Denis Aleksandrovich IP\" or\n            \"Zhou Huabing\"\n        ) or\n\n        process.name.caseless : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        ) or\n        process.name : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        )\n\t) and\n\n\tnot (process.pe.original_file_name : (\"G2M.exe\" or \"Updater.exe\" or \"powershell.exe\") and process.code_signature.subject_name : \"LogMeIn, Inc.\")",
        "new_terms_fields": [
          "host.id"
        ],
        "history_window_start": "now-15d",
        "index": [
          "logs-endpoint.events.process-*",
          "endgame-*",
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "System Hosts File Access",
        "description": "Identifies the use of built-in tools to read the contents of \\etc\\hosts on a local machine. Attackers may use this data to discover remote machines in an environment that may be used for Lateral Movement from the current system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6da42446-45f3-43c0-9386-c797228d8c63",
        "rule_id": "f75f65cf-ed04-48df-a7ff-b02a8bfe636e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.292Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.916Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in (\"vi\", \"nano\", \"cat\", \"more\", \"less\") and process.args == \"/etc/hosts\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Execution with Explicit Credentials via Scripting",
        "description": "Identifies execution of the security_authtrampoline process via a scripting interpreter. This occurs when programs use AuthorizationExecute-WithPrivileges from the Security.framework to run another program with root privileges. It should not be run by itself, as this is a sign of execution with explicit logon credentials.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://objectivebythesea.com/v2/talks/OBTS_v2_Thomas.pdf",
          "https://www.manpagez.com/man/8/security_authtrampoline/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.004",
                    "name": "Elevated Execution with Prompt",
                    "reference": "https://attack.mitre.org/techniques/T1548/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e6ae8f68-9df1-43f9-994a-dab90e01d174",
        "rule_id": "f0eb70e9-71e9-40cd-813f-bf8e8c812cb1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.296Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.693Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n process.name:\"security_authtrampoline\" and\n process.parent.name:(osascript or com.apple.automator.runner or sh or bash or dash or zsh or python* or Python or perl* or php* or ruby or pwsh)",
        "language": "kuery"
      },
      {
        "name": "Sudo Heap-Based Buffer Overflow Attempt",
        "description": "Identifies the attempted use of a heap-based buffer overflow vulnerability for the Sudo binary in Unix-like systems (CVE-2021-3156). Successful exploitation allows an unprivileged user to escalate to the root user.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "This rule could generate false positives if the process arguments leveraged by the exploit are shared by custom scripts using the Sudo or Sudoedit binaries. Only Sudo versions 1.8.2 through 1.8.31p2 and 1.9.0 through 1.9.5p1 are affected; if those versions are not present on the endpoint, this could be a false positive."
        ],
        "references": [
          "https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3156",
          "https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit",
          "https://www.bleepingcomputer.com/news/security/latest-macos-big-sur-also-has-sudo-root-privilege-escalation-flaw",
          "https://www.sudo.ws/alerts/unescape_overflow.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9aaaeca6-1090-4206-acdb-c12b90adccd4",
        "rule_id": "f37f3054-d40b-49ac-aa9b-a786c74c58b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.294Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.703Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and event.type:start and\n  process.name:(sudo or sudoedit) and\n  process.args:(*\\\\ and (\"-i\" or \"-s\"))",
        "threshold": {
          "field": [
            "host.hostname"
          ],
          "value": 100
        },
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual Child Processes of RunDLL32",
        "description": "Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse of RunDLL32 could indicate malicious activity.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Child Processes of RunDLL32\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nRunDLL32 is a legitimate Windows utility used to load and execute functions within dynamic-link libraries (DLLs). However, adversaries may abuse RunDLL32 to execute malicious code, bypassing security measures and evading detection. This rule identifies potential abuse by looking for an unusual process creation with no arguments followed by the creation of a child process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate the behavior of child processes, such as network connections, registry or file modifications, and any spawned processes.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related Rules\n\n- Unusual Network Connection via RunDLL32 - 52aaab7b-b51c-441a-89ce-4387b3aea886\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "30m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bff77ed9-792b-415d-b3db-8eb9ac0f11bf",
        "rule_id": "f036953a-4615-4707-a1ca-dc53bf69dcd5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.298Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.689Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1h\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"rundll32.exe\" or process.pe.original_file_name == \"RUNDLL32.EXE\") and\n      process.args_count == 1\n  ] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"rundll32.exe\"\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "SMB (Windows File Sharing) Activity to the Internet",
        "description": "This rule detects network events that may indicate the use of Windows file sharing (also called SMB or CIFS) traffic to the Internet. SMB is commonly used within networks to share files, printers, and other system resources amongst trusted systems. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector or for data exfiltration.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Tactic: Initial Access",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1048",
                "name": "Exfiltration Over Alternative Protocol",
                "reference": "https://attack.mitre.org/techniques/T1048/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "8d2ba263-2989-4981-afed-ccc1552b17dd",
        "rule_id": "c82b2bd8-d701-420c-ba43-f11a155b681a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.300Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.545Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:(139 or 445) or event.dataset:zeek.smb) and\n  source.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  ) and\n  not destination.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  )",
        "language": "kuery"
      },
      {
        "name": "SIP Provider Modification",
        "description": "Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the Windows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signature validation checks or inject code into critical processes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/mattifestation/PoCSubjectInterfacePackage"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.003",
                    "name": "SIP and Trust Provider Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1553/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d7d2890f-8eba-4047-8b7f-9972c6be368b",
        "rule_id": "f2c7b914-eda3-40c2-96ac-d23ef91776ca",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.302Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.696Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : (\"Dll\", \"$Dll\") and\n  registry.path: (\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\"\n    ) and\n  registry.data.strings:\"*.dll\" and\n  not (process.name : \"msiexec.exe\" and registry.data.strings : \"mso.dll\") and\n  not (process.name : \"regsvr32.exe\" and registry.data.strings == \"WINTRUST.DLL\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Antimalware Scan Interface DLL",
        "description": "Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate an attempt to bypass AMSI by loading a rogue AMSI module instead of the legit one.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Antimalware Scan Interface DLL\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product on a machine. AMSI integrates with multiple Windows components, ranging from User Account Control (UAC) to VBA macros and PowerShell.\n\nAttackers might copy a rogue AMSI DLL to an unusual location to prevent the process from loading the legitimate module, achieving a bypass to execute malicious code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the process that created the DLL and which account was used.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the execution of scripts and macros after the registry modification.\n- Investigate other processes launched from the directory that the DLL was created.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team as these modifications expose the host to malware infections.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "352dcaf1-6456-4705-a809-abc900a6e4ea",
        "rule_id": "fa488440-04cc-41d7-9279-539387bf2a17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.309Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.347Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.path != null and\n  file.name : (\"amsi.dll\", \"amsi\") and\n  not file.path : (\n    \"?:\\\\Windows\\\\system32\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\Syswow64\\\\amsi.dll\",\n    \"?:\\\\$WINDOWS.~BT\\\\DUImageSandbox\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSXS\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\servicing\\\\LCU\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\*\",\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\",\n    \"?:\\\\Windows\\\\WinSxS\\\\amd64_microsoft-antimalware-scan-interface_*\\\\amsi.dll\"\n  ) and\n  not\n  (\n    process.executable : \"C:\\\\Windows\\\\System32\\\\wbengine.exe\" and\n    file.path : (\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\system32\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\syswow64\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Potential LSA Authentication Package Abuse",
        "description": "Adversaries can use the autostart mechanism provided by the Local Security Authority (LSA) authentication packages for privilege escalation or persistence by placing a reference to a binary in the Windows registry. The binary will then be executed by SYSTEM when the authentication packages are loaded.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.002",
                    "name": "Authentication Package",
                    "reference": "https://attack.mitre.org/techniques/T1547/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.002",
                    "name": "Authentication Package",
                    "reference": "https://attack.mitre.org/techniques/T1547/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9e5776fe-f66b-4ebe-9ea1-ab3322dda18c",
        "rule_id": "e9abe69b-1deb-4e19-ac4a-5d5ac00f72eb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.311Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.676Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\"\n  ) and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Remote Computer Account DnsHostName Update",
        "description": "Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain controller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation step to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4",
          "https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2022-26923"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.DnsHostName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "1ac295f1-70b1-4358-9c41-934f81cda0cf",
        "rule_id": "6bed021a-0afb-461c-acbe-ffdb9574d3f3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.313Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.394Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"changed-computer-account\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Delete Volume USN Journal with Fsutil",
        "description": "Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidence of files created during post-exploitation activities.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Delete Volume USN Journal with Fsutil\n\nThe Update Sequence Number (USN) Journal is a feature in the NTFS file system used by Microsoft Windows operating systems to keep track of changes made to files and directories on a disk volume. The journal records metadata for changes such as file creation, deletion, modification, and permission changes. It is used by the operating system for various purposes, including backup and recovery, file indexing, and file replication.\n\nThis artifact can provide valuable information in forensic analysis, such as programs executed (prefetch file operations), file modification events in suspicious directories, deleted files, etc. Attackers may delete this artifact in an attempt to cover their tracks, and this rule identifies the usage of the `fsutil.exe` utility to accomplish it.\n\nConsider using the Elastic Defend integration instead of USN Journal, as the Elastic Defend integration provides more visibility and context in the file operations it records.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Review file operation logs from Elastic Defend for suspicious activity the attacker tried to hide.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6e5ef371-b7bc-474d-9bbf-63bd0979fd24",
        "rule_id": "f675872f-6d85-40a3-b502-c0d2ef101e92",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.318Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.582Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"deletejournal\" and process.args : \"usn\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "High Variance in RDP Session Duration",
        "description": "A machine learning job has detected unusually high variance of RDP session duration. Long RDP sessions can be used to evade detection mechanisms via session persistence, and might be used to perform tasks such as lateral movement, that might require uninterrupted access to a compromised machine.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Lateral Movement Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-43200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/lmd",
          "https://www.elastic.co/blog/detecting-lateral-movement-activity-a-new-kibana-integration",
          "https://www.elastic.co/blog/remote-desktop-protocol-connections-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Lateral Movement Detection integration assets to be installed, as well as file and Windows RDP process events collected by the Elastic Defend integration.  \n\n### Lateral Movement Detection Setup\nThe Lateral Movement Detection integration detects lateral movement activity by identifying abnormalities in file and Windows RDP events. Anomalies are detected using Elastic's Anomaly Detection feature.\n\n#### Prerequisite Requirements:\n- Fleet is required for Lateral Movement Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows RDP process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n#### The following steps should be executed to install assets associated with the Lateral Movement Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Lateral Movement Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "lmd",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "47b5144f-a8cb-4bca-96aa-1e1218528ca3",
        "rule_id": "a8d35ca0-ad8d-48a9-9f6c-553622dca61a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.524Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.948Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 70,
        "machine_learning_job_id": [
          "lmd_high_var_rdp_session_duration"
        ]
      },
      {
        "name": "High Mean of RDP Session Duration",
        "description": "A machine learning job has detected unusually high mean of RDP session duration. Long RDP sessions can be used to evade detection mechanisms via session persistence, and might be used to perform tasks such as lateral movement, that might require uninterrupted access to a compromised machine.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Lateral Movement Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-43200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/lmd",
          "https://www.elastic.co/blog/detecting-lateral-movement-activity-a-new-kibana-integration",
          "https://www.elastic.co/blog/remote-desktop-protocol-connections-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Lateral Movement Detection integration assets to be installed, as well as file and Windows RDP process events collected by the Elastic Defend integration.  \n\n### Lateral Movement Detection Setup\nThe Lateral Movement Detection integration detects lateral movement activity by identifying abnormalities in file and Windows RDP events. Anomalies are detected using Elastic's Anomaly Detection feature.\n\n#### Prerequisite Requirements:\n- Fleet is required for Lateral Movement Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows RDP process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n#### The following steps should be executed to install assets associated with the Lateral Movement Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Lateral Movement Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "lmd",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "7a1db5a4-a678-4eee-aaea-c15862ca0707",
        "rule_id": "a74c60cb-70ee-4629-a127-608ead14ebf1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.941Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 70,
        "machine_learning_job_id": [
          "lmd_high_mean_rdp_session_duration"
        ]
      },
      {
        "name": "Unusual Remote File Extension",
        "description": "An anomaly detection job has detected a remote file transfer with a rare extension, which could indicate potential lateral movement activity on the host.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Lateral Movement Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-5400s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/lmd",
          "https://www.elastic.co/blog/detecting-lateral-movement-activity-a-new-kibana-integration",
          "https://www.elastic.co/blog/remote-desktop-protocol-connections-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Lateral Movement Detection integration assets to be installed, as well as file and Windows RDP process events collected by the Elastic Defend integration.  \n\n### Lateral Movement Detection Setup\nThe Lateral Movement Detection integration detects lateral movement activity by identifying abnormalities in file and Windows RDP events. Anomalies are detected using Elastic's Anomaly Detection feature.\n\n#### Prerequisite Requirements:\n- Fleet is required for Lateral Movement Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- File events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n#### The following steps should be executed to install assets associated with the Lateral Movement Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Lateral Movement Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "lmd",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "51eb097d-30d4-40dc-9491-49144c75dc08",
        "rule_id": "814d96c7-2068-42aa-ba8e-fe0ddd565e2e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.496Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.910Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 70,
        "machine_learning_job_id": [
          "lmd_rare_file_extension_remote_transfer"
        ]
      },
      {
        "name": "Unusual Process For a Windows Host",
        "description": "Identifies rare processes that do not usually run on individual hosts, which can indicate execution of unauthorized services, malware, or persistence mechanisms. Processes are considered rare when they only run occasionally as compared with other processes running on the host.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n###  Investigating Unusual Process For a Windows Host\n\nSearching for abnormal Windows processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect a Windows process that is rare and unusual for an individual Windows host in your environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n  - Investigate the process metadata  such as the digital signature, directory, etc.  to obtain more context that can indicate whether the executable is associated with an expected software vendor or package.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Retrieve Service Unisgned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Unusual Process For a Windows Host - 6d448b96-c922-4adb-b51c-b767f1ea5b76\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Unusual Windows Process Calling the Metadata Service - abae61a8-c560-4dbd-acca-1e1438bff36b\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Windows and select the integration to see more details about it.\n- Click Add Windows.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed windows to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "2cc13c10-d24f-44c6-982e-e2552770f0ba",
        "rule_id": "6d448b96-c922-4adb-b51c-b767f1ea5b76",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.592Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.397Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_rare_process_by_host_windows"
        ]
      },
      {
        "name": "Spike in Remote File Transfers",
        "description": "A machine learning job has detected an abnormal volume of remote files shared on the host indicating potential lateral movement activity. One of the primary goals of attackers after gaining access to a network is to locate and exfiltrate valuable information. Attackers might perform multiple small transfers to match normal egress activity in the network, to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Lateral Movement Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-5400s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/lmd",
          "https://www.elastic.co/blog/detecting-lateral-movement-activity-a-new-kibana-integration",
          "https://www.elastic.co/blog/remote-desktop-protocol-connections-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Lateral Movement Detection integration assets to be installed, as well as file and Windows RDP process events collected by the Elastic Defend integration.  \n\n### Lateral Movement Detection Setup\nThe Lateral Movement Detection integration detects lateral movement activity by identifying abnormalities in file and Windows RDP events. Anomalies are detected using Elastic's Anomaly Detection feature.\n\n#### Prerequisite Requirements:\n- Fleet is required for Lateral Movement Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- File events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n#### The following steps should be executed to install assets associated with the Lateral Movement Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Lateral Movement Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "lmd",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "ad497f42-aaf9-48e8-acb8-93d68fc99c9a",
        "rule_id": "e9b0902b-c515-413b-b80b-a8dcebc81a66",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.594Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.744Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 70,
        "machine_learning_job_id": [
          "lmd_high_count_remote_file_transfer"
        ]
      },
      {
        "name": "Unusual Remote File Directory",
        "description": "An anomaly detection job has detected a remote file transfer on an unusual directory indicating a potential lateral movement activity on the host. Many Security solutions monitor well-known directories for suspicious activities, so attackers might use less common directories to bypass monitoring.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Lateral Movement Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-5400s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/lmd",
          "https://www.elastic.co/blog/detecting-lateral-movement-activity-a-new-kibana-integration",
          "https://www.elastic.co/blog/remote-desktop-protocol-connections-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Lateral Movement Detection integration assets to be installed, as well as file and Windows RDP process events collected by the Elastic Defend integration.  \n\n### Lateral Movement Detection Setup\nThe Lateral Movement Detection integration detects lateral movement activity by identifying abnormalities in file and Windows RDP events. Anomalies are detected using Elastic's Anomaly Detection feature.\n\n#### Prerequisite Requirements:\n- Fleet is required for Lateral Movement Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- File events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n#### The following steps should be executed to install assets associated with the Lateral Movement Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Lateral Movement Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "lmd",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "47ef5e47-95cc-44b8-b9a0-b6198eebd094",
        "rule_id": "be4c5aed-90f5-4221-8bd5-7ab3a4334751",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.617Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.970Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 70,
        "machine_learning_job_id": [
          "lmd_rare_file_path_remote_transfer"
        ]
      },
      {
        "name": "Unusual Linux Network Configuration Discovery",
        "description": "Looks for commands related to system network configuration discovery from an unusual user context. This can be due to uncommon troubleshooting activity or due to a compromised account. A compromised account may be used by a threat actor to engage in system network configuration discovery in order to increase their understanding of connected networks and hosts. This information may be used to shape follow-up behaviors such as lateral movement or additional discovery.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user command activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "e9334a8f-8859-4725-83b7-4d7288ac5a08",
        "rule_id": "f9590f47-6bd5-4a49-bd49-a2f886476fb9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.619Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.588Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 25,
        "machine_learning_job_id": [
          "v3_linux_network_configuration_discovery"
        ]
      },
      {
        "name": "Spike in Firewall Denies",
        "description": "A machine learning job detected an unusually large spike in network traffic that was denied by network access control lists (ACLs) or firewall rules. Such a burst of denied traffic is usually caused by either 1) a mis-configured application or firewall or 2) suspicious or malicious activity. Unsuccessful attempts at network transit, in order to connect to command-and-control (C2), or engage in data exfiltration, may produce a burst of failed connections. This could also be due to unusually large amounts of reconnaissance or enumeration traffic. Denial-of-service attacks or traffic floods may also produce such a surge in traffic.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A misconfgured network application or firewall may trigger this alert. Security scans or test cycles may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "fbe665e1-7759-4090-b3ac-f49e61ca1739",
        "rule_id": "eaa77d63-9679-4ce3-be25-3ba8b795e5fa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:56.615Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.683Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "high_count_network_denies"
        ]
      },
      {
        "name": "Persistence via WMI Standard Registry Provider",
        "description": "Identifies use of the Windows Management Instrumentation StdRegProv (registry provider) to modify commonly abused registry locations for persistence.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via WMI Standard Registry Provider\n\nThe Windows Management Instrumentation (WMI) StdRegProv is a registry provider that allows users to manage registry keys and values on Windows systems. Adversaries may abuse this functionality to modify registry locations commonly used for persistence, enabling them to maintain unauthorized access to a system.\n\nThis rule identifies instances where the WMI StdRegProv is used to modify specific registry paths associated with persistence mechanisms.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Identify which process triggered this behavior.\n- Verify whether the file specified in the run key is signed.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Examine the file specified in the run key using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/desktop/regprov/stdregprov",
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              },
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3f2f5718-300a-49a8-960b-2ce24e4ea6cd",
        "rule_id": "70d12c9c-0dbd-4a1a-bc44-1467502c9cf6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.029Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.929Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.data.strings != null and process.name : \"WmiPrvSe.exe\" and\n registry.path : (\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\"\n                  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Anomalous Process For a Windows Population",
        "description": "Searches for rare processes running on multiple hosts in an entire fleet or network. This reduces the detection of false positives since automated maintenance processes usually only run occasionally on a single machine but are common to all or many hosts in a fleet.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n###  Investigating Anomalous Process For a Windows Population\n\nSearching for abnormal Windows processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect a Windows process that is rare and unusual for all of the monitored Windows hosts in your environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n  - Investigate the process metadata  such as the digital signature, directory, etc.  to obtain more context that can indicate whether the executable is associated with an expected software vendor or package.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSyste' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Retrieve Service Unisgned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Unusual Process For a Windows Host - 6d448b96-c922-4adb-b51c-b767f1ea5b76\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Unusual Windows Process Calling the Metadata Service - abae61a8-c560-4dbd-acca-1e1438bff36b\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Windows and select the integration to see more details about it.\n- Click Add Windows.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed windows to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "0e028cf0-40e1-4c41-b5fb-006c73b0e3c8",
        "rule_id": "6e40d56f-5c0e-4ac6-aece-bee96645b172",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.032Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.403Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_process_all_hosts"
        ]
      },
      {
        "name": "Attempt to Unload Elastic Endpoint Security Kernel Extension",
        "description": "Identifies attempts to unload the Elastic Endpoint Security kernel extension via the kextunload command.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2a67dc62-1238-4f17-b695-f687feba7533",
        "rule_id": "70fa1af4-27fd-4f26-bd03-50b6af6b9e24",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.074Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.568Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n process.name:kextunload and process.args:(\"/System/Library/Extensions/EndpointSecurity.kext\" or \"EndpointSecurity.kext\")",
        "language": "kuery"
      },
      {
        "name": "Modification of Environment Variable via Unsigned or Untrusted Parent",
        "description": "Identifies modifications to an environment variable using the built-in launchctl command. Adversaries may execute their own malicious payloads by hijacking certain environment variables to load arbitrary libraries or bypass certain restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/rapid7/metasploit-framework/blob/master//modules/post/osx/escalate/tccbypass.rb"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.007",
                    "name": "Path Interception by PATH Environment Variable",
                    "reference": "https://attack.mitre.org/techniques/T1574/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "37b9cee3-f263-44d7-a6a4-93ddd669b957",
        "rule_id": "7453e19e-3dbf-4e4e-9ae0-33d6c6ed15e1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.076Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.573Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:start and \n  process.name:launchctl and \n  (process.parent.code_signature.exists : false or process.parent.code_signature.trusted : false) and\n  process.args:(setenv and not (ANT_HOME or \n                                DBUS_LAUNCHD_SESSION_BUS_SOCKET or \n                                EDEN_ENV or \n                                LG_WEBOS_TV_SDK_HOME or \n                                RUNTIME_JAVA_HOME or \n                                WEBOS_CLI_TV or \n                                JAVA*_HOME) and \n                not *.vmoptions) and \n  not process.parent.executable:(\"/Applications/IntelliJ IDEA CE.app/Contents/jbr/Contents/Home/lib/jspawnhelper\" or \n                                  /Applications/NoMachine.app/Contents/Frameworks/bin/nxserver.bin or \n                                  /Applications/NoMachine.app/Contents/Frameworks/bin/nxserver.bin or \n                                  /usr/local/bin/kr)",
        "language": "kuery"
      },
      {
        "name": "Unusual Hour for a User to Logon",
        "description": "A machine learning job detected a user logging in at a time of day that is unusual for the user. This can be due to credentialed access via a compromised account when the user and the threat actor are in different time zones. In addition, unauthorized user activity often takes place during non-business hours.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Hour for a User to Logon\n\nThis rule uses a machine learning job to detect a user logging in at a time of day that is unusual for the user. This can be due to credentialed access via a compromised account when the user and the threat actor are in different time zones. It can also indicate unauthorized user activity, as it often occurs during non-business hours.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, network connections, data access, and logon events.\n- Investigate other alerts associated with the involved users during the past 48 hours.\n\n### False positive analysis\n\n- Users may need to log in during non-business hours to perform work-related tasks. Examine whether the company policies authorize this or if the activity is done under change management.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users working late, or logging in from unusual time zones while traveling, may trigger this rule."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n- System\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n\n### System Integration Setup\nThe System integration allows you to collect system logs and metrics from your servers with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"system\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for System and select the integration to see more details about it.\n- Click Add System.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed system to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [],
        "id": "c7eeb53d-ff49-4862-9c9f-88e370989ece",
        "rule_id": "745b0119-0560-43ba-860a-7235dd8cee8d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.079Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.578Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "auth_rare_hour_for_a_user"
        ]
      },
      {
        "name": "Unusual DNS Activity",
        "description": "A machine learning job detected a rare and unusual DNS query that indicate network activity with unusual DNS domains. This can be due to initial access, persistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing email or opens a malicious document, a request may be sent to download and run a payload from an uncommon domain. When malware is already running, it may send requests to an uncommon DNS domain the malware uses for command-and-control communication.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert. Network activity that occurs rarely, in small quantities, can trigger this alert. Possible examples are browsing technical support or vendor networks sparsely. A user who visits a new or unique web destination may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.004",
                    "name": "DNS",
                    "reference": "https://attack.mitre.org/techniques/T1071/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "f479e669-8842-4f68-8024-f69a9f8da277",
        "rule_id": "746edc4c-c54c-49c6-97a1-651223819448",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.082Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.583Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "packetbeat_rare_dns_question"
        ]
      },
      {
        "name": "Service Disabled via Registry Modification",
        "description": "Identifies attempts to modify services start settings using processes other than services.exe. Attackers may attempt to modify security and monitoring services to avoid detection or delay response.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "02919200-a2d3-4e6e-83a1-c4070b5cc977",
        "rule_id": "75dcb176-a575-4e33-a020-4a52aaa1b593",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.084Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.900Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\"\n  ) and registry.data.strings : (\"3\", \"4\") and\n  not \n    (\n      process.name : \"services.exe\" and user.id : \"S-1-5-18\"\n    )\n  and not registry.path : \"HKLM\\\\SYSTEM\\\\ControlSet001\\\\Services\\\\MrxSmb10\\\\Start\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Sudoers File Modification",
        "description": "A sudoers file specifies the commands users or groups can run and from which terminals. Adversaries can take advantage of these configurations to execute commands as other users or spawn processes with higher privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "656fea51-3377-43ac-a52b-2853cc720662",
        "rule_id": "76152ca1-71d0-4003-9e37-0983e12832da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.087Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.587Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and event.type:start and process.args:(echo and *NOPASSWD*ALL*)",
        "language": "kuery"
      },
      {
        "name": "InstallUtil Process Making Network Connections",
        "description": "Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3489e500-9645-4689-951d-89d575d40922",
        "rule_id": "a13167f1-eec2-4015-9631-1fee60406dcf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.089Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.785Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */\n\nsequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"installutil.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"installutil.exe\" and network.direction : (\"outgoing\", \"egress\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Windows Subsystem for Linux Distribution Installed",
        "description": "Detects changes to the registry that indicates the install of a new Windows Subsystem for Linux distribution by name. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "3e47ef71-ebfc-4520-975c-cb27fc090799",
        "timeline_title": "Comprehensive Registry Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Subsystem for Linux Distribution Installed\n\nThe Windows Subsystem for Linux (WSL) lets developers install a Linux distribution (such as Ubuntu, OpenSUSE, Kali, Debian, Arch Linux, etc) and use Linux applications, utilities, and Bash command-line tools directly on Windows, unmodified, without the overhead of a traditional virtual machine or dualboot setup. Attackers may abuse WSL to avoid security protections on a Windows host and perform a wide range of attacks.\n\nThis rule identifies the installation of a new Windows Subsystem for Linux distribution via registry events.\n\n### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine which distribution was installed. Some distributions such as Kali Linux can facilitate the compromise of the environment.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate that the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This is a dual-use tool, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the administrator is aware of the activity, no other suspicious activity was identified, and the WSL distribution is homologated and approved in the environment.\n\n### Related Rules\n\n- Host Files System Changes via Windows Subsystem for Linux - e88d1fe9-b2f4-48d4-bace-a026dc745d4b\n- Execution via Windows Subsystem for Linux - db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd\n- Suspicious Execution via Windows Subsystem for Linux - 3e0eeb75-16e8-4f2f-9826-62461ca128b7\n- Windows Subsystem for Linux Enabled via Dism Utility - e2e0537d-7d8f-4910-a11d-559bcf61295a\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8098d5da-133b-4285-a996-4018cf16348f",
        "rule_id": "a1699af0-8e1e-4ed0-8ec1-89783538a061",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.092Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.845Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"PackageFamilyName\" and\n registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Lxss\\\\*\\\\PackageFamilyName\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Remotely Started Services via RPC",
        "description": "Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral movement, but will be noisy if commonly done by administrators.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remotely Started Services via RPC\n\nThe Service Control Manager Remote Protocol is a client/server protocol used for configuring and controlling service programs running on a remote computer. A remote service management session begins with the client initiating the connection request to the server. If the server grants the request, the connection is established. The client can then make multiple requests to modify, query the configuration, or start and stop services on the server by using the same session until the session is terminated.\n\nThis rule detects the remote creation or start of a service by correlating a `services.exe` network connection and the spawn of a child process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Review login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action. Use the `source.address` field to help identify the source system.\n- Review network events from the source system using the source port identified on the alert and try to identify the program used to initiate the action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- Remote management software like SCCM may trigger this rule. If noisy on your environment, consider adding exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "5f32626d-56b4-4b2a-b388-84cfbff73b10",
        "rule_id": "aa9a274d-6b53-424d-ac5e-cb8ca4251650",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.094Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.343Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1s\n   [network where host.os.type == \"windows\" and process.name : \"services.exe\" and\n      network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n      source.port >= 49152 and destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ] by host.id, process.entity_id\n   [process where host.os.type == \"windows\" and \n       event.type == \"start\" and process.parent.name : \"services.exe\" and\n       not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"/V\") and\n       not process.executable : (\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\srmhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\"\n       )] by host.id, process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Process Calling the Metadata Service",
        "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs very rarely as part of a monthly or quarterly workflow could trigger this detection rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Windows and select the integration to see more details about it.\n- Click Add Windows.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed windows to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "0983f3d4-1636-4e0f-a7db-e75a24c6c304",
        "rule_id": "abae61a8-c560-4dbd-acca-1e1438bff36b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.097Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.873Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_metadata_process"
        ]
      },
      {
        "name": "Potential Persistence via Login Hook",
        "description": "Identifies the creation or modification of the login window property list (plist). Adversaries may modify plist files to run a program during system boot or user login for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nStarting in Mac OS X 10.7 (Lion), users can specify certain applications to be re-opened when a user reboots their machine. This can be abused to establish or maintain persistence on a compromised system.",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/D00MFist/PersistentJXA/blob/master/LoginScript.js"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1647",
                "name": "Plist File Modification",
                "reference": "https://attack.mitre.org/techniques/T1647/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a4c670f1-8668-4e57-931a-bf7e235318b9",
        "rule_id": "ac412404-57a5-476f-858f-4e8fbb4f48d8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.100Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.881Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and not event.type:\"deletion\" and\n file.name:\"com.apple.loginwindow.plist\" and\n not process.name: (systemmigrationd or DesktopServicesHelper or diskmanagementd or rsync or launchd or cfprefsd or xpcproxy or ManagedClient or MCXCompositor or backupd or \"iMazing Profile Editor\" or storagekitd or CloneKitService)",
        "language": "kuery"
      },
      {
        "name": "Potential Command and Control via Internet Explorer",
        "description": "Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) making unusual network connections. Adversaries could abuse Internet Explorer via COM to avoid suspicious processes making network connections and bypass host-based firewall restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Processes such as MS Office using IEproxy to render HTML content."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "185415ff-e504-4cb2-a269-7f8fcc0ac0b0",
        "rule_id": "acd611f3-2b93-47b3-a0a3-7723bcc46f6d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.102Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.900Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.name with maxspan = 5s\n  [library where host.os.type == \"windows\" and dll.name : \"IEProxy.dll\" and process.name : (\"rundll32.exe\", \"regsvr32.exe\")]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"iexplore.exe\" and process.parent.args : \"-Embedding\"]\n  /* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */\n  [network where host.os.type == \"windows\" and network.protocol == \"dns\" and process.name : \"iexplore.exe\" and\n   not dns.question.name :\n   (\n    \"*.microsoft.com\",\n    \"*.digicert.com\",\n    \"*.msocsp.com\",\n    \"*.windowsupdate.com\",\n    \"*.bing.com\",\n    \"*.identrust.com\",\n    \"*.sharepoint.com\",\n    \"*.office365.com\",\n    \"*.office.com\"\n    )\n  ] /* with runs=5 */",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Potential macOS SSH Brute Force Detected",
        "description": "Identifies a high number (20) of macOS SSH KeyGen process executions from the same host. An adversary may attempt a brute force attack to obtain unauthorized access to user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://themittenmac.com/detecting-ssh-activity-via-process-monitoring/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "310c95cf-7fba-4902-a29a-e420cfd4e63d",
        "rule_id": "ace1e989-a541-44df-93a8-a8b0591b63c0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.105Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.903Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and host.os.type:macos and event.type:start and process.name:\"sshd-keygen-wrapper\" and process.parent.name:launchd",
        "threshold": {
          "field": [
            "host.id"
          ],
          "value": 20
        },
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kerberos Cached Credentials Dumping",
        "description": "Identifies the use of the Kerberos credential cache (kcc) utility to dump locally cached Kerberos tickets. Adversaries may attempt to dump credential material in the form of tickets that can be leveraged for lateral movement.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/EmPyre/blob/master/lib/modules/collection/osx/kerberosdump.py",
          "https://opensource.apple.com/source/Heimdal/Heimdal-323.12/kuser/kcc-commands.in.auto.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "121d02d8-fdf5-4ee0-8c91-eae5e16660b9",
        "rule_id": "ad88231f-e2ab-491c-8fc6-64746da26cfe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.107Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.915Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n  process.name:kcc and\n  process.args:copy_cred_cache",
        "language": "kuery"
      },
      {
        "name": "TCC Bypass via Mounted APFS Snapshot Access",
        "description": "Identifies the use of the mount_apfs command to mount the entire file system through Apple File System (APFS) snapshots as read-only and with the noowners flag set. This action enables the adversary to access almost any file in the file system, including all user data and files protected by Apples privacy framework (TCC).",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://theevilbit.github.io/posts/cve_2020_9771/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1006",
                "name": "Direct Volume Access",
                "reference": "https://attack.mitre.org/techniques/T1006/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d68f7c9a-82e5-459e-81eb-07de5d941beb",
        "rule_id": "b00bcd89-000c-4425-b94c-716ef67762f6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.116Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.527Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and process.name:mount_apfs and\n  process.args:(/System/Volumes/Data and noowners)",
        "language": "kuery"
      },
      {
        "name": "Local Scheduled Task Creation",
        "description": "Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1",
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-2",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ff73d54b-80fb-4f2d-af5e-b401793b530a",
        "rule_id": "afcce5ad-65de-4ed2-8516-5e093d3ac99a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.113Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.732Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type != \"end\" and\n    ((process.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                      \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") or\n    process.pe.original_file_name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                                     \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\",\n                                     \"winrshost.exe\")) or\n    ?process.code_signature.trusted == false)] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"schtasks.exe\" or process.pe.original_file_name == \"schtasks.exe\") and\n    process.args : (\"/create\", \"-create\") and process.args : (\"/RU\", \"/SC\", \"/TN\", \"/TR\", \"/F\", \"/XML\") and\n    /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */\n    not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Execution via Microsoft Office Add-Ins",
        "description": "Identifies execution of common Microsoft Office applications to launch an Office Add-In from a suspicious path or with an unusual parent process. This may indicate an attempt to get initial access via a malicious phishing MS Office Add-In.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/Octoberfest7/XLL_Phishing",
          "https://labs.f-secure.com/archive/add-in-opportunities-for-office-persistence/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1137",
                "name": "Office Application Startup",
                "reference": "https://attack.mitre.org/techniques/T1137/",
                "subtechnique": [
                  {
                    "id": "T1137.006",
                    "name": "Add-ins",
                    "reference": "https://attack.mitre.org/techniques/T1137/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "18ae0210-6af3-4e05-9d91-33e5525febbd",
        "rule_id": "ae8a142c-6a1d-4918-bea7-0b617e99ecfa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.110Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.920Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where \n    \n    host.os.type == \"windows\" and event.type == \"start\" and  \n    \n    process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSACCESS.EXE\", \"VSTOInstaller.exe\") and \n    \n    process.args regex~ \"\"\".+\\.(wll|xll|ppa|ppam|xla|xlam|vsto)\"\"\" and \n    \n    /* Office Add-In from suspicious paths */\n    (process.args :\n             (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\",\n              \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n              \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\",\n              \"?:\\\\Users\\\\Public\\\\*\",\n              \"?:\\\\ProgramData\\\\*\",\n              \"?:\\\\Windows\\\\Temp\\\\*\",\n              \"\\\\Device\\\\*\",\n              \"http*\") or\n\t      \n    process.parent.name : (\"explorer.exe\", \"OpenWith.exe\") or \n    \n    /* Office Add-In from suspicious parent */\n    process.parent.name : (\"cmd.exe\", \"powershell.exe\")) and\n\t  \n    /* False Positives */\n    not (process.args : \"*.vsto\" and\n         process.parent.executable :\n                   (\"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility.exe\",\n                    \"?:\\\\Program Files\\\\LogiOptionsPlus\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\VSTO\\\\*\\\\VSTOInstaller.exe\")) and\n    not (process.args : \"/Uninstall\" and process.name : \"VSTOInstaller.exe\") and\n    not (process.parent.name : \"rundll32.exe\" and\n         process.parent.args : \"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\") and\n    not (process.name : \"VSTOInstaller.exe\" and process.args : \"https://dl.getsidekick.com/outlook/vsto/Sidekick.vsto\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Netsh Helper DLL",
        "description": "Identifies the addition of a Netsh Helper DLL, netsh.exe supports the addition of these DLLs to extend its functionality. Attackers may abuse this mechanism to execute malicious payloads every time the utility is executed, which can be done by administrators or a scheduled task.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.007",
                    "name": "Netsh Helper DLL",
                    "reference": "https://attack.mitre.org/techniques/T1546/007/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3f22e666-2c2b-4615-b50b-20bf5e211c48",
        "rule_id": "b0638186-4f12-48ac-83d2-47e686d08e82",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.119Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.951Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\Software\\\\Microsoft\\\\netsh\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\netsh\\\\*\",\n    \"MACHINE\\\\Software\\\\Microsoft\\\\netsh\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Spike in Network Traffic",
        "description": "A machine learning job detected an unusually large spike in network traffic. Such a burst of traffic, if not caused by a surge in business activity, can be due to suspicious or malicious activity. Large-scale data exfiltration may produce a burst of network traffic; this could also be due to unusually large amounts of reconnaissance or enumeration traffic. Denial-of-service attacks or traffic floods may also produce such a surge in traffic.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Business workflows that occur very occasionally, and involve an unusual surge in network traffic, can trigger this alert. A new business workflow or a surge in business activity may trigger this alert. A misconfigured network application or firewall may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "776bc229-7dd1-4246-8401-87f6279f4376",
        "rule_id": "b240bfb8-26b7-4e5e-924e-218144a3fa71",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.128Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.532Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "high_count_network_events"
        ]
      },
      {
        "name": "Network Connection via Compiled HTML File",
        "description": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe).",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Compiled HTML File\n\nCHM (Compiled HTML) files are a format for delivering online help files on Windows. CHM files are compressed compilations of various content, such as HTML documents, images, and scripting/web-related programming languages such as VBA, JScript, Java, and ActiveX.\n\nWhen users double-click CHM files, the HTML Help executable program (`hh.exe`) will execute them. `hh.exe` also can be used to execute code embedded in those files, PowerShell scripts, and executables. This makes it useful for attackers not only to proxy the execution of malicious payloads via a signed binary that could bypass security controls, but also to gain initial access to environments via social engineering methods.\n\nThis rule identifies network connections done by `hh.exe`, which can potentially indicate abuse to download malicious files or tooling, or masquerading.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Examine the command lines for suspicious activities.\n  - Retrieve `.chm`, `.ps1`, and other files that were involved for further examination.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executables, scripts and help files retrieved from the system using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.001",
                    "name": "Compiled HTML File",
                    "reference": "https://attack.mitre.org/techniques/T1218/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5550dd70-422f-4c5c-854b-693faad1cbdb",
        "rule_id": "b29ee2be-bf99-446c-ab1a-2dc0183394b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.131Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.463Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"hh.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"hh.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and\n     not dns.question.name : \"localhost\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Linux Username",
        "description": "A machine learning job detected activity for a username that is not normally active, which can indicate unauthorized changes, activity by unauthorized users, lateral movement, or compromised credentials. In many organizations, new usernames are not often created apart from specific types of system activities, such as creating new accounts for new employees. These user accounts quickly become active and routine. Events from rarely used usernames can point to suspicious activity. Additionally, automated Linux fleets tend to see activity from rarely used usernames only when personnel log in to make authorized or unauthorized changes, or threat actors have acquired credentials and log in for malicious purposes. Unusual usernames can also indicate pivoting, where compromised credentials are used to try and move laterally from one host to another.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating an Unusual Linux User\nDetection alerts from this rule indicate activity for a Linux user name that is rare and unusual. Here are some possible avenues of investigation:\n- Consider the user as identified by the username field. Is this program part of an expected workflow for the user who ran this program on this host? Could this be related to troubleshooting or debugging activity by a developer or site reliability engineer?\n- Examine the history of user activity. If this user only manifested recently, it might be a service account for a new software package. If it has a consistent cadence (for example if it runs monthly or quarterly), it might be part of a monthly or quarterly business process.\n- Examine the process arguments, title and working directory. These may provide indications as to the source of the program or the nature of the tasks that the user is performing.",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "4cc9d3f6-6bf5-4e5e-a223-fb2b8a7028b3",
        "rule_id": "b347b919-665f-4aac-b9e8-68369bf2340c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.133Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.537Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_linux_anomalous_user_name"
        ]
      },
      {
        "name": "Potential Persistence via Atom Init Script Modification",
        "description": "Identifies modifications to the Atom desktop text editor Init File. Adversaries may add malicious JavaScript code to the init.coffee file that will be executed upon the Atom application opening.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/D00MFist/PersistentJXA/blob/master/AtomPersist.js",
          "https://flight-manual.atom.io/hacking-atom/sections/the-init-file/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cc28c337-4d75-4f46-9751-cfbde9b9e890",
        "rule_id": "b4449455-f986-4b5a-82ed-e36b129331f7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.139Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.542Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and not event.type:\"deletion\" and\n file.path:/Users/*/.atom/init.coffee and not process.name:(Atom or xpcproxy) and not user.name:root",
        "language": "kuery"
      },
      {
        "name": "Code Signing Policy Modification Through Built-in tools",
        "description": "Identifies attempts to disable/modify the code signing policy through system native utilities. Code signing provides authenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By allowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Code Signing Policy Modification Through Built-in tools\n\nWindows Driver Signature Enforcement (DSE) is a security feature introduced by Microsoft to enforce that only signed drivers can be loaded and executed into the kernel (ring 0). This feature was introduced to prevent attackers from loading their malicious drivers on targets. If the driver has an invalid signature, the system will not allow it to be loaded.\n\nThis protection is essential for maintaining the security of the system. However, attackers or even administrators can disable this feature and load untrusted drivers, as this can put the system at risk. Therefore, it is important to keep this feature enabled and only load drivers from trusted sources to ensure the integrity and security of the system.\n\nThis rule identifies commands that can disable the Driver Signature Enforcement feature.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Use Osquery and endpoint driver events (`event.category = \"driver\"`) to investigate if suspicious drivers were loaded into the system after the command was executed.\n  - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n- Identify the driver's `Device Name` and `Service Name`.\n- Check for alerts from the rules specified in the `Related Rules` section.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Related Rules\n\n- First Time Seen Driver Loaded - df0fd41e-5590-4965-ad5e-cd079ec22fa9\n- Untrusted Driver Loaded - d8ab1ec1-feeb-48b9-89e7-c12e189448aa\n- Code Signing Policy Modification Through Registry - da7733b1-fe08-487e-b536-0a04c6d8b0cd\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Disable and uninstall all suspicious drivers found in the system. This can be done via Device Manager. (Note that this step may require you to boot the system into Safe Mode.)\n- Remove the related services and registry keys found in the system. Note that the service will probably not stop if the driver is still installed.\n  - This can be done via PowerShell `Remove-Service` cmdlet.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Remove and block malicious artifacts identified during triage.\n- Ensure that the Driver Signature Enforcement is enabled on the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.006",
                    "name": "Code Signing Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1553/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a9613ba3-1d07-43b3-9021-43c7b5241b77",
        "rule_id": "b43570de-a908-4f7f-8bdb-b2df6ffd8c80",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.136Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.466Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name: \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and process.args: (\"-set\", \"/set\") and \n  process.args: (\"TESTSIGNING\", \"nointegritychecks\", \"loadoptions\", \"DISABLE_INTEGRITY_CHECKS\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Linux System Information Discovery",
        "description": "Enrich process events with uname and other command lines that imply Linux system information discovery.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8f5390b9-84cc-454b-84e2-1c17a9ba5e85",
        "rule_id": "b81bd314-db5b-4d97-82e8-88e3e5fc9de5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.142Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.868Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and (\n  process.name: \"uname\" or (\n  process.name: (\"cat\", \"more\", \"less\") and process.args: (\"*issue*\", \"*version*\", \"*profile*\", \"*services*\", \"*cpuinfo*\")\n  )\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via MsXsl",
        "description": "Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged by adversaries to execute malicious scripts and evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1220",
                "name": "XSL Script Processing",
                "reference": "https://attack.mitre.org/techniques/T1220/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fbf607cf-6867-46ad-8713-a054171a56f4",
        "rule_id": "b86afe07-0d98-4738-b15d-8d7465f95ff5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.145Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.552Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Discovery of Domain Groups",
        "description": "Identifies the execution of Linux built-in commands related to account or group enumeration. Adversaries may use account and group information to orient themselves before deciding how to act.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9529744f-d074-4123-9a0e-30b20b5a3267",
        "rule_id": "b92d5eae-70bb-4b66-be27-f98ba9d0ccdc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.148Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.955Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and (\n  process.name in (\"ldapsearch\", \"dscacheutil\") or (process.name == \"dscl\" and process.args : \"*-list*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Network Activity",
        "description": "Identifies Windows processes that do not usually use the network but have unexpected network activity, which can indicate command-and-control, lateral movement, persistence, or data exfiltration activity. A process with unusual network activity can denote process exploitation or injection, where the process is used to run persistence mechanisms that allow a malicious actor remote access or control of the host, data exfiltration, and execution of unauthorized network applications.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Activity\nDetection alerts from this rule indicate the presence of network activity from a Windows process for which network activity is very unusual.  Here are some possible avenues of investigation:\n- Consider the IP addresses, protocol and ports. Are these used by normal but infrequent network workflows? Are they expected or unexpected?\n- If the destination IP address is remote or external, does it associate with an expected domain, organization or geography? Note: avoid interacting directly with suspected malicious IP addresses.\n- Consider the user as identified by the username field. Is this network activity part of an expected workflow for the user who ran the program?\n- Examine the history of execution. If this process only manifested recently, it might be part of a new software package. If it has a consistent cadence (for example if it runs monthly or quarterly), it might be part of a monthly or quarterly business process.\n- Examine the process arguments, title and working directory. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Consider the same for the parent process. If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n- If you have file hash values in the event data, and you suspect malware, you can optionally run a search for the file hash to see if the file is identified as malware by anti-malware tools.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that rarely uses the network could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Windows and select the integration to see more details about it.\n- Click Add Windows.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed windows to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "58229e99-1ffc-4fc7-a16a-d04f276be330",
        "rule_id": "ba342eb2-583c-439f-b04d-1fdd7c1417cc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.150Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.556Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_network_activity"
        ]
      },
      {
        "name": "Attempt to Install Root Certificate",
        "description": "Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to their command and control servers. Root certificates are used in public key cryptography to identify a root certificate authority (CA). When a root certificate is installed, the system or application will trust certificates in the root's chain of trust that have been signed by the root certificate.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain applications may install root certificates for the purpose of inspecting SSL traffic."
        ],
        "references": [
          "https://ss64.com/osx/security-cert.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.004",
                    "name": "Install Root Certificate",
                    "reference": "https://attack.mitre.org/techniques/T1553/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "32105b52-5d25-43ee-9a15-585bbc8d3970",
        "rule_id": "bc1eeacf-2972-434f-b782-3a532b100d67",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.153Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.561Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n  process.name:security and process.args:\"add-trusted-cert\" and\n  not process.parent.executable:(\"/Library/Bitdefender/AVP/product/bin/BDCoreIssues\" or \"/Applications/Bitdefender/SecurityNetworkInstallerApp.app/Contents/MacOS/SecurityNetworkInstallerApp\"\n)",
        "language": "kuery"
      },
      {
        "name": "File and Directory Permissions Modification",
        "description": "Identifies the change of permissions/ownership of files/folders through built-in Windows utilities. Threat actors may require permission modification of files/folders to change, modify or delete them.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.001",
                    "name": "Windows File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "37229912-e249-4ff2-8a62-f1cb0299581e",
        "rule_id": "bc9e4f5a-e263-4213-a2ac-1edf9b417ada",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.156Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.958Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and host.os.type == \"windows\" and\n(\n  ((process.name: \"icacls.exe\" or process.pe.original_file_name == \"iCACLS.EXE\") and process.args: (\"*:F\", \"/reset\", \"/setowner\", \"*grant*\")) or\n  ((process.name: \"cacls.exe\" or process.pe.original_file_name == \"CACLS.EXE\") and process.args: (\"/g\", \"*:f\")) or\n  ((process.name: \"takeown.exe\" or process.pe.original_file_name == \"takeown.exe\") and process.args: (\"/F\")) or\n  ((process.name: \"attrib.exe\" or process.pe.original_file_name== \"ATTRIB.EXE\") and process.args: \"-r\")\n) and not user.id : \"S-1-5-18\" and\nnot (\n  process.args : (\"C:\\\\ProgramData\\\\Lenovo\\\\*\", \"C:\\\\ProgramData\\\\Adobe\\\\*\", \"C:\\\\ProgramData\\\\ASUS\\\\ASUS*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Defense Evasion via CMSTP.exe",
        "description": "The Microsoft Connection Manager Profile Installer (CMSTP.exe) is a command-line program to install Connection Manager service profiles, which accept installation information file (INF) files. Adversaries may abuse CMSTP to proxy the execution of malicious code by supplying INF files that contain malicious commands.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1218/003/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.003",
                    "name": "CMSTP",
                    "reference": "https://attack.mitre.org/techniques/T1218/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6ebb2472-3080-4776-be97-99b1b0b0e665",
        "rule_id": "bd3d058d-5405-4cee-b890-337f09366ba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.159Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.964Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmstp.exe\" and process.args == \"/s\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Print Spooler Point and Print DLL",
        "description": "Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service. Exploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running as SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.accenture.com/us-en/blogs/cyber-defense/discovering-exploiting-shutting-down-dangerous-windows-print-spooler-vulnerability",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Privilege%20Escalation/privesc_sysmon_cve_20201030_spooler.evtx",
          "https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1030"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9638730e-5fb6-4179-a29a-c09a003c23c7",
        "rule_id": "bd7eefee-f671-494e-98df-f01daf9e5f17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.162Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.566Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\"]\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\\\\*\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "System Owner/User Discovery Linux",
        "description": "Identifies the use of built-in tools which adversaries may use to enumerate the system owner/user of a compromised system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              },
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "51ea2613-16a4-4f53-ba24-2201abfb6c80",
        "rule_id": "bf8c007c-7dee-4842-8e9a-ee534c09d205",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.165Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.762Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and \nprocess.name : (\"whoami\", \"w\", \"who\", \"users\", \"id\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Linux Network Connection Discovery",
        "description": "Looks for commands related to system network connection discovery from an unusual user context. This can be due to uncommon troubleshooting activity or due to a compromised account. A compromised account may be used by a threat actor to engage in system network connection discovery in order to increase their understanding of connected services and systems. This information may be used to shape follow-up behaviors such as lateral movement or additional discovery.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user command activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "549fd50d-dc6b-446f-971f-af53422d2c5e",
        "rule_id": "c28c4d8c-f014-40ef-88b6-79a1d67cd499",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.168Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.571Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 25,
        "machine_learning_job_id": [
          "v3_linux_network_connection_discovery"
        ]
      },
      {
        "name": "Persistence via Folder Action Script",
        "description": "Detects modification of a Folder Action script. A Folder Action script is executed when the folder to which it is attached has items added or removed, or when its window is opened, closed, moved, or resized. Adversaries may abuse this feature to establish persistence by utilizing a malicious script.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/folder-actions-for-persistence-on-macos-8923f222343d"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "70b5ab44-08e2-4f5e-9a6b-b6adad58d344",
        "rule_id": "c292fa52-4115-408a-b897-e14f684b3cb7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.171Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.575Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type : \"start\" and process.name in (\"osascript\", \"python\", \"tcl\", \"node\", \"perl\", \"ruby\", \"php\", \"bash\", \"csh\", \"zsh\", \"sh\") and\n  process.parent.name == \"com.apple.foundation.UserScriptService\" and not process.args : (\"/Users/*/Library/Application Support/iTerm2/Scripts/AutoLaunch/*.scpt\", \"/Users/*/Library/Application Scripts/com.microsoft.*/FoxitUtils.applescript\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Mshta Making Network Connections",
        "description": "Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is often leveraged by adversaries to execute malicious scripts and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cbbee54c-6b44-474d-b4bb-da1ad1508bd8",
        "rule_id": "c2d90150-0133-451c-a783-533e736c12d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.174Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.587Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=10m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     not process.parent.name : \"Microsoft.ConfigurationManagement.exe\" and\n     not (process.parent.executable : \"C:\\\\Amazon\\\\Amazon Assistant\\\\amazonAssistantService.exe\" or\n          process.parent.executable : \"C:\\\\TeamViewer\\\\TeamViewer.exe\") and\n     not process.args : \"ADSelfService_Enroll.hta\"]\n  [network where host.os.type == \"windows\" and process.name : \"mshta.exe\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Attempted Private Key Access",
        "description": "Attackers may try to access private keys, e.g. ssh, in order to gain further authenticated access to the environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "583dc3a6-bfc5-4ee2-a6fa-b360fb8d41e2",
        "rule_id": "c55badd3-3e61-4292-836f-56209dc8a601",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.177Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.692Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"*.pem *\", \"*.pem\", \"*.id_rsa*\") and\n  not process.args: (\"--tls-cert\", \"--ssl-cert\") and\n  not process.executable : (\n    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Software\\\\*\\\\LogiLuUpdater.exe\",\n    \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\*\\\\osqueryd.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-controller.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-deception-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-detection-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-enforcement-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-guest-agent.exe\",\n    \"?:\\\\Program Files\\\\Logi\\\\LogiBolt\\\\LogiBoltUpdater.exe\",\n    \"?:\\\\Program Files (x86)\\\\Schneider Electric EcoStruxure\\\\Building Operation 5.0\\\\Device Administrator\\\\Python\\\\python.exe\",\n    \"?:\\\\Program Files\\\\Splunk\\\\bin\\\\openssl.exe\",\n    \"?:\\\\Program Files\\\\SplunkUniversalForwarder\\\\bin\\\\openssl.exe\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Logi\\\\LogiBolt\\\\LogiBoltUpdater.exe\",\n    \"?:\\\\Windows\\\\system32\\\\icacls.exe\",\n    \"?:\\\\Windows\\\\System32\\\\OpenSSH\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Service Path Modification via sc.exe",
        "description": "Identifies attempts to modify a service path setting using sc.exe. Attackers may attempt to modify existing services for persistence or privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "099cc81f-ea64-408a-acc2-cd5447908bd5",
        "rule_id": "c5677997-f75b-4cda-b830-a75920514096",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.205Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.695Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and process.name : \"sc.exe\" and\n  process.args : \"*config*\" and process.args : \"*binPath*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Installation of Custom Shim Databases",
        "description": "Identifies the installation of custom Application Compatibility Shim databases. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.011",
                    "name": "Application Shimming",
                    "reference": "https://attack.mitre.org/techniques/T1546/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8d1ac08a-e32a-46b3-9bb1-494819514d30",
        "rule_id": "c5ce48a6-7f57-4ee8-9313-3d0024caee10",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.207Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.601Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\",\n        \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\"\n    ) and\n    not process.executable : \n                       (\"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\swrepository\\\\1\\\\swuploads\\\\SAP-SLC\\\\SAPSetupSLC02_14-80001954\\\\Setup\\\\NwSapSetup.exe\", \n                        \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupPlatform.exe\", \n                         \"?:\\\\Program Files (x86)\\\\SAP\\\\SAPsetup\\\\setup\\\\NwSapSetup.exe\", \n                         \"?:\\\\Program Files (x86)\\\\SAP\\\\SapSetup\\\\OnRebootSvc\\\\NWSAPSetupOnRebootInstSvc.exe\", \n                         \"?:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\Kaspersky Security for Windows Server\\\\kavfs.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Network Connection via DllHost",
        "description": "Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Command and Control activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/",
          "https://www.volexity.com/blog/2021/05/27/suspected-apt29-operation-launches-election-fraud-themed-phishing-campaigns/",
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b5025f9f-10d4-4e46-bd3f-98baaff4c0a4",
        "rule_id": "c7894234-7814-44c2-92a9-f7d851ea246a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.217Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.606Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"dllhost.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n    \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n    \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n    \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n    \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Spike in Network Traffic To a Country",
        "description": "A machine learning job detected an unusually large spike in network activity to one destination country in the network logs. This could be due to unusually large amounts of reconnaissance or enumeration traffic. Data exfiltration activity may also produce such a surge in traffic to a destination country that does not normally appear in network traffic or business workflows. Malware instances and persistence mechanisms may communicate with command-and-control (C2) infrastructure in their country of origin, which may be an unusual destination country for the source network.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Spike in Network Traffic To a Country\n\nMonitoring network traffic for anomalies is a good methodology for uncovering various potentially suspicious activities. For example, data exfiltration or infected machines may communicate with a command-and-control (C2) server in another country your company doesn't have business with.\n\nThis rule uses a machine learning job to detect a significant spike in the network traffic to a country, which can indicate reconnaissance or enumeration activities, an infected machine being used as a bot in a DDoS attack, or potentially data exfiltration.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as role, criticality, and associated users.\n- Investigate other alerts associated with the involved assets during the past 48 hours.\n- Examine the data available and determine the exact users and processes involved in those connections.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Consider the time of day. If the user is a human (not a program or script), did the activity occurs during working hours?\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n\n### False positive analysis\n\n- Understand the context of the connections by contacting the asset owners. If this activity is related to a new business process or newly implemented (approved) technology, consider adding exceptions  preferably with a combination of user and source conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n  - Remove and block malicious artifacts identified during triage.\n- Consider implementing temporary network border rules to block or alert connections to the target country, if relevant.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Business workflows that occur very occasionally, and involve an unusual surge in network traffic to one destination country, can trigger this alert. A new business workflow or a surge in business activity in a particular country may trigger this alert. Business travelers who roam to many countries for brief periods may trigger this alert if they engage in volumetric network activity."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "3b25bc1d-4066-4aaf-93fb-62861cf798c0",
        "rule_id": "c7db5533-ca2a-41f6-a8b0-ee98abe0f573",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.370Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.610Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "high_count_by_destination_country"
        ]
      },
      {
        "name": "Trap Signals Execution",
        "description": "Identify activity related where adversaries can include a trap command which then allows programs and shells to specify commands that will be executed upon receiving interrupt signals.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.005",
                    "name": "Trap",
                    "reference": "https://attack.mitre.org/techniques/T1546/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4408561e-f6bc-4e68-9998-0dc9859796d9",
        "rule_id": "cf6995ec-32a9-4b2d-9340-f8e61acf3f4e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.513Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.711Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name == \"trap\" and process.args : \"SIG*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Compression DLL Loaded by Unusual Process",
        "description": "Identifies the image load of a compression DLL. Adversaries will often compress and encrypt data in preparation for exfiltration.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7d695946-cf67-4e26-89ff-f5b8a14727b1",
        "rule_id": "d197478e-39f0-4347-a22f-ba654718b148",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.524Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.802Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where host.os.type == \"windows\" and event.action == \"load\" and\n  dll.name : (\"System.IO.Compression.FileSystem.ni.dll\", \"System.IO.Compression.ni.dll\") and\n  not \n  (\n    (\n      process.executable : (\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\mscorsvw.exe\",\n        \"?:\\\\Windows\\\\System32\\\\sdiagnhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*\\\\OpenHandleCollector.exe\"\n      ) and process.code_signature.trusted == true\n    ) or\n    (\n      process.name : \"NuGet.exe\" and process.code_signature.trusted == true and user.id : (\"S-1-5-18\", \"S-1-5-20\")\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Anomalous Linux Compiler Activity",
        "description": "Looks for compiler activity by a user context which does not normally run compilers. This can be the result of ad-hoc software changes or unauthorized software deployment. This can also be due to local privilege elevation via locally run exploits or malware activity.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Resource Development"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon compiler activity can be due to an engineer running a local build on a production or staging instance in the course of troubleshooting or fixing a software issue."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0042",
              "name": "Resource Development",
              "reference": "https://attack.mitre.org/tactics/TA0042/"
            },
            "technique": [
              {
                "id": "T1588",
                "name": "Obtain Capabilities",
                "reference": "https://attack.mitre.org/techniques/T1588/",
                "subtechnique": [
                  {
                    "id": "T1588.001",
                    "name": "Malware",
                    "reference": "https://attack.mitre.org/techniques/T1588/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "b3e331c2-bc66-4d84-ab9d-0deaceab5512",
        "rule_id": "cd66a419-9b3f-4f57-8ff8-ac4cd2d5f530",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.641Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_linux_rare_user_compiler"
        ]
      },
      {
        "name": "Attempt to Enable the Root Account",
        "description": "Identifies attempts to enable the root account using the dsenableroot command. This command may be abused by adversaries for persistence, as the root account is disabled by default.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://ss64.com/osx/dsenableroot.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "98baab83-bba0-4653-8173-9a497e55e3f4",
        "rule_id": "cc2fd2d0-ba3a-4939-b87f-2901764ed036",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.530Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.626Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n process.name:dsenableroot and not process.args:\"-d\"",
        "language": "kuery"
      },
      {
        "name": "Suspicious Calendar File Modification",
        "description": "Identifies suspicious modifications of the calendar file by an unusual process. Adversaries may create a custom calendar notification procedure to execute a malicious program at a recurring interval to establish persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted applications for managing calendars and reminders."
        ],
        "references": [
          "https://labs.f-secure.com/blog/operationalising-calendar-alerts-persistence-on-macos",
          "https://github.com/FSecureLABS/CalendarPersist",
          "https://github.com/D00MFist/PersistentJXA/blob/master/CalendarPersist.js"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9a6bf005-add6-4a75-a180-f3b2ec7fb6d3",
        "rule_id": "cb71aa62-55c8-42f0-b0dd-afb0bb0b1f51",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.532Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.621Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and event.action:modification and\n  file.path:/Users/*/Library/Calendars/*.calendar/Events/*.ics and\n  process.executable:\n  (* and not\n    (\n      /System/Library/* or\n      /System/Applications/Calendar.app/Contents/MacOS/* or\n      /System/Applications/Mail.app/Contents/MacOS/Mail or\n      /usr/libexec/xpcproxy or\n      /sbin/launchd or\n      /Applications/*\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Microsoft Office Sandbox Evasion",
        "description": "Identifies the creation of a suspicious zip file prepended with special characters. Sandboxed Microsoft Office applications on macOS are allowed to write files that start with special characters, which can be combined with an AutoStart location to achieve sandbox evasion.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://i.blackhat.com/USA-20/Wednesday/us-20-Wardle-Office-Drama-On-macOS.pdf",
          "https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/",
          "https://desi-jarvis.medium.com/office365-macos-sandbox-escape-fcce4fa4123c"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1497",
                "name": "Virtualization/Sandbox Evasion",
                "reference": "https://attack.mitre.org/techniques/T1497/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "59f341d7-474d-4ab2-b27c-3b378dfd3f30",
        "rule_id": "d22a85c6-d2ad-4cc4-bf7b-54787473669a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.543Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.681Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:(macos and macos) and not event.type:deletion and file.name:~$*.zip",
        "language": "kuery"
      },
      {
        "name": "SMB Connections via LOLBin or Untrusted Process",
        "description": "Identifies potentially suspicious processes that are not trusted or living-off-the-land binaries (LOLBin) making Server Message Block (SMB) network connections over port 445. Windows File Sharing is typically implemented over SMB, which communicates between hosts using port 445. Legitimate connections are generally established by the kernel (PID 4). This rule helps to detect processes that might be port scanners, exploits, or user-level processes attempting lateral movement within the network by leveraging SMB connections.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Performance\n\nThis rule may have low to medium performance impact due to filtering for LOLBins processes starting, followed by network connections over port 445. Additional filtering is applied to reduce the volume of matching events and improve performance.\n\n### Investigating Untrusted Non-Microsoft or LOLBin SMB Connections\n\nThis rule looks for unexpected processes or LOLBins making network connections over port 445. Windows file sharing is typically implemented over Server Message Block (SMB), which communicates between hosts using port 445. When legitimate, these network connections are established by the kernel (PID 4). Occurrences of non-system processes using this port can indicate port scanners, exploits, and tools used to move laterally on the environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- In hybrid environments, SMB may be used for legitimate purposes if operations are performed in Azure. In such cases, consider adding exceptions for known Azure services and operations.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "96652113-31cc-4662-97ad-0c97465460be",
        "rule_id": "c82c7d8f-fb9e-4874-a4bd-fd9e3f9becf1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.534Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.548Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n\n  /* first sequence to capture the start of Windows processes */\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.pid != 4 and\n\n    /* ignore NT Authority and Network Service accounts */\n    not user.id : (\"S-1-5-19\", \"S-1-5-20\") and\n\n    /* filter out anything trusted but not from Microsoft */\n    /* LOLBins will be inherently trusted and signed, so ignore everything else trusted */\n    not (process.code_signature.trusted == true and not startsWith(process.code_signature.subject_name, \"Microsoft\")) and\n\n    /* filter out PowerShell scripts from Windows Defender ATP */\n    not (\n      process.name : \"powershell.exe\" and\n      process.args :\"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\PSScript_*.ps1\")]\n\n  /* second sequence to capture network connections over port 445 related to SMB */\n  [network where host.os.type == \"windows\" and destination.port == 445 and process.pid != 4]\n\n/* end the sequence when the process ends where joining was on process.entity_id */\nuntil [process where host.os.type == \"windows\" and event.type == \"end\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Docker Shortcut Modification",
        "description": "An adversary can establish persistence by modifying an existing macOS dock property list in order to execute a malicious application instead of the intended one when invoked.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/specterops/presentations/raw/master/Leo%20Pitt/Hey_Im_Still_in_Here_Modern_macOS_Persistence_SO-CON2020.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "508cedd4-3046-4ec7-99df-a7caa8d98f0e",
        "rule_id": "c81cefcb-82b9-4408-a533-3c3df549e62d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:22:58.566Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.615Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and event.action:modification and\n file.path:/Users/*/Library/Preferences/com.apple.dock.plist and\n not process.name:(xpcproxy or cfprefsd or plutil or jamf or PlistBuddy or InstallerRemotePluginService) and\n not process.executable:(/Library/Addigy/download-cache/* or \"/Library/Kandji/Kandji Agent.app/Contents/MacOS/kandji-library-manager\")",
        "language": "kuery"
      },
      {
        "name": "Spike in Successful Logon Events from a Source IP",
        "description": "A machine learning job found an unusually large spike in successful authentication events from a particular source IP address. This can be due to password spraying, user enumeration or brute force activity.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Spike in Successful Logon Events from a Source IP\n\nThis rule uses a machine learning job to detect a substantial spike in successful authentication events. This could indicate post-exploitation activities that aim to test which hosts, services, and other resources the attacker can access with the compromised credentials.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as role, criticality, and associated users.\n- Check if the authentication comes from different sources.\n- Use the historical data available to determine if the same behavior happened in the past.\n- Investigate other alerts associated with the involved users during the past 48 hours.\n- Check whether the involved credentials are used in automation or scheduled tasks.\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n\n### False positive analysis\n\n- Understand the context of the authentications by contacting the asset owners. If this activity is related to a new business process or newly implemented (approved) technology, consider adding exceptions  preferably with a combination of user and source conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Build servers and CI systems can sometimes trigger this alert. Security test cycles that include brute force or password spraying activities may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  },
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n- System\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n\n### System Integration Setup\nThe System integration allows you to collect system logs and metrics from your servers with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"system\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for System and select the integration to see more details about it.\n- Click Add System.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed system to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [],
        "id": "8803b4aa-5c4a-49c0-a8d9-0605f4de4add",
        "rule_id": "e26aed74-c816-40d3-a810-48d6fbd8b2fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.085Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.834Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "auth_high_count_logon_events_for_a_source_ip"
        ]
      },
      {
        "name": "Unusual Windows User Calling the Metadata Service",
        "description": "Looks for anomalous access to the cloud platform metadata service by an unusual user. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program, or one that runs under a new or rarely used user context, could trigger this detection rule. Manual interrogation of the metadata service during debugging or troubleshooting could trigger this rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Windows and select the integration to see more details about it.\n- Click Add Windows.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed windows to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "ecd55b0e-0d1b-4226-a723-634109cebec0",
        "rule_id": "df197323-72a8-46a9-a08e-3f5b04a4a97a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.087Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.729Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "v3_windows_rare_metadata_user"
        ]
      },
      {
        "name": "Attempt to Install Kali Linux via WSL",
        "description": "Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1142ef14-6f70-41b1-9531-1c56538035a3",
        "rule_id": "dd34b062-b9e3-4a6b-8c0c-6c8ca6dd450e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.089Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.591Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.name : \"wsl.exe\" and process.args : (\"-d\", \"--distribution\", \"-i\", \"--install\") and process.args : \"kali*\") or \n  process.executable : (\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"?:\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Execution via Windows Subsystem for Linux",
        "description": "Detects attempts to execute a program on the host from the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "23231e58-edcb-45d9-a9d1-3db50ecee123",
        "rule_id": "db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.090Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.722Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : (\"wsl.exe\", \"wslhost.exe\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n  ) and\n  not (\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n      )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Spike in Logon Events",
        "description": "A machine learning job found an unusually large spike in successful authentication events. This can be due to password spraying, user enumeration or brute force activity.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Build servers and CI systems can sometimes trigger this alert. Security test cycles that include brute force or password spraying activities may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n- System\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n\n### System Integration Setup\nThe System integration allows you to collect system logs and metrics from your servers with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"system\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for System and select the integration to see more details about it.\n- Click Add System.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed system to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [],
        "id": "ef786175-da33-4638-9e07-694fb304169d",
        "rule_id": "d7d5c059-c19a-4a96-8ae3-41496ef3bcf9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.092Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.719Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "auth_high_count_logon_events"
        ]
      },
      {
        "name": "SystemKey Access via Command Line",
        "description": "Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos. Adversaries may collect the keychain storage data from a system to acquire credentials.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/AlessandroZ/LaZagne/blob/master/Mac/lazagne/softwares/system/chainbreaker.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.001",
                    "name": "Keychain",
                    "reference": "https://attack.mitre.org/techniques/T1555/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "533ad071-4654-4c03-afec-5d4cdad1e40c",
        "rule_id": "d75991f2-b989-419d-b797-ac1e54ec2d61",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.094Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.711Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n  process.args:(\"/private/var/db/SystemKey\" or \"/var/db/SystemKey\") and\n  not process.Ext.effective_parent.executable : \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\"",
        "language": "kuery"
      },
      {
        "name": "Service Command Lateral Movement",
        "description": "Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversary lateral movement but will be noisy if commonly done by admins.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "10e79865-cce4-44c0-835b-e3eefc3ce255",
        "rule_id": "d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.096Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.708Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan = 1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"sc.exe\" or process.pe.original_file_name : \"sc.exe\") and\n      process.args : \"\\\\\\\\*\" and process.args : (\"binPath=*\", \"binpath=*\") and\n      process.args : (\"create\", \"config\", \"failure\", \"start\")]\n  [network where host.os.type == \"windows\" and process.name : \"sc.exe\" and destination.ip != \"127.0.0.1\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Privilege Escalation via Windir Environment Variable",
        "description": "Identifies a privilege escalation attempt via a rogue Windows directory (Windir) environment variable. This is a known primitive that is often combined with other vulnerabilities to elevate privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.tiraniddo.dev/2017/05/exploiting-environment-variables-in.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.007",
                    "name": "Path Interception by PATH Environment Variable",
                    "reference": "https://attack.mitre.org/techniques/T1574/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e1e024bf-0f50-44ef-a724-02cbbf6ab225",
        "rule_id": "d563aaba-2e72-462b-8658-3e5ea22db3a6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.098Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.704Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\nregistry.value : (\"windir\", \"systemroot\") and\nregistry.path : (\n    \"HKEY_USERS\\\\*\\\\Environment\\\\windir\",\n    \"HKEY_USERS\\\\*\\\\Environment\\\\systemroot\",\n    \"HKU\\\\*\\\\Environment\\\\windir\",\n    \"HKU\\\\*\\\\Environment\\\\systemroot\",\n    \"HKCU\\\\*\\\\Environment\\\\windir\",\n    \"HKCU\\\\*\\\\Environment\\\\systemroot\",\n    \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\windir\",\n    \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\systemroot\",\n    \"USER\\\\*\\\\Environment\\\\windir\",\n    \"USER\\\\*\\\\Environment\\\\systemroot\"\n    ) and\n not registry.data.strings : (\"C:\\\\windows\", \"%SystemRoot%\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Source IP for a User to Logon from",
        "description": "A machine learning job detected a user logging in from an IP address that is unusual for the user. This can be due to credentialed access via a compromised account when the user and the threat actor are in different locations. An unusual source IP address for a username could also be due to lateral movement when a compromised account is used to pivot between hosts.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Business travelers who roam to new locations may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n- System\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n\n### System Integration Setup\nThe System integration allows you to collect system logs and metrics from your servers with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"system\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for System and select the integration to see more details about it.\n- Click Add System.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed system to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [],
        "id": "6ff7927b-2b17-4e9e-8997-bd8f7b3ba2ed",
        "rule_id": "d4b73fa0-9d43-465e-b8bf-50230da6718b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.100Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.696Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "auth_rare_source_ip_for_a_user"
        ]
      },
      {
        "name": "Unusual Linux System Information Discovery Activity",
        "description": "Looks for commands related to system information discovery from an unusual user context. This can be due to uncommon troubleshooting activity or due to a compromised account. A compromised account may be used to engage in system information discovery in order to gather detailed information about system configuration and software versions. This may be a precursor to selection of a persistence mechanism or a method of privilege elevation.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user command activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "24e9bd6a-00d9-4073-aeff-c1fda2c48164",
        "rule_id": "d4af3a06-1e0a-48ec-b96a-faf2309fae46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.101Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.693Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "v3_linux_system_information_discovery"
        ]
      },
      {
        "name": "Windows Subsystem for Linux Enabled via Dism Utility",
        "description": "Detects attempts to enable the Windows Subsystem for Linux using Microsoft Dism utility. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Subsystem for Linux Enabled via Dism Utility\n\nThe Windows Subsystem for Linux (WSL) lets developers install a Linux distribution (such as Ubuntu, OpenSUSE, Kali, Debian, Arch Linux, etc) and use Linux applications, utilities, and Bash command-line tools directly on Windows, unmodified, without the overhead of a traditional virtual machine or dualboot setup. Attackers may abuse WSL to avoid security protections on a Windows host and perform a wide range of attacks.\n\nThis rule identifies attempts to enable WSL using the Dism utility. It monitors for the execution of Dism and checks if the command line contains the string \"Microsoft-Windows-Subsystem-Linux\". \n\n### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This is a dual-use tool, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the administrator is aware of the activity, no other suspicious activity was identified, and WSL is homologated and approved in the environment.\n\n### Related Rules\n\n- Execution via Windows Subsystem for Linux - db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd\n- Suspicious Execution via Windows Subsystem for Linux - 3e0eeb75-16e8-4f2f-9826-62461ca128b7\n- Host Files System Changes via Windows Subsystem for Linux - e88d1fe9-b2f4-48d4-bace-a026dc745d4b\n- Windows Subsystem for Linux Distribution Installed - a1699af0-8e1e-4ed0-8ec1-89783538a061\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.f-secure.com/hunting-for-windows-subsystem-for-linux/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "00bfeff3-a10a-4274-be0f-0853ecd31ce3",
        "rule_id": "e2e0537d-7d8f-4910-a11d-559bcf61295a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.253Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.654Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n (process.name : \"Dism.exe\" or ?process.pe.original_file_name == \"DISM.EXE\") and \n process.command_line : \"*Microsoft-Windows-Subsystem-Linux*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "System Network Connections Discovery",
        "description": "Adversaries may attempt to get a listing of network connections to or from a compromised system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "702922c8-d34c-41bf-bd48-781d201c5f11",
        "rule_id": "e2dc8f8c-5f16-42fa-b49e-0eb8057f7444",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.255Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.848Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in (\"netstat\", \"lsof\", \"who\", \"w\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Shell Execution via Apple Scripting",
        "description": "Identifies the execution of the shell process (sh) via scripting (JXA or AppleScript). Adversaries may use the doShellScript functionality in JXA or do shell script in AppleScript to execute system commands.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.apple.com/library/archive/technotes/tn2065/_index.html",
          "https://objectivebythesea.com/v2/talks/OBTS_v2_Thomas.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "89214c9e-4573-48c8-a1a2-f35d956c79a1",
        "rule_id": "d461fac0-43e8-49e2-85ea-3a58fe120b4f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.297Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.689Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\", \"info\") and process.name == \"osascript\" and process.args : \"-e\"] by process.entity_id\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name : (\"sh\", \"bash\", \"zsh\") and process.args == \"-c\" and process.args : (\"*curl*\", \"*pbcopy*\", \"*http*\", \"*chmod*\")] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Linux Clipboard Activity Detected",
        "description": "This rule monitors for the usage of the most common clipboard utilities on unix systems by an uncommon process group leader. Adversaries may collect data stored in the clipboard from users copying information within or between applications.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ec529cb7-2067-4cd0-9a41-2af146364bba",
        "rule_id": "884e87cc-c67b-4c90-a4ed-e1e24a940c82",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.299Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.766Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:\"linux\" and event.type:\"start\" and\nevent.action:(\"exec\" or \"exec_event\" or \"executed\" or \"process_started\") and\nprocess.name:(\"xclip\" or \"xsel\" or \"wl-clipboard\" or \"clipman\" or \"copyq\") and\nnot process.parent.name:(\"bwrap\" or \"micro\")",
        "new_terms_fields": [
          "host.id",
          "process.group_leader.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Command Prompt Network Connection",
        "description": "Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from a remote URL.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Command Prompt Network Connection\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using a command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThis rule looks for a network connection to an external address from the `cmd.exe` utility, which can indicate the abuse of the utility to download malicious files and tools.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Examine if any file was downloaded and check if it is an executable or script.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the downloaded file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of destination IP address and file name conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may use the command prompt for regular administrative tasks. It's important to baseline your environment for network connections being made from the command prompt to determine any abnormal use of this tool."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cb9d8f9a-5c12-499b-a9d8-680b6710b87f",
        "rule_id": "89f9a4b0-9f8f-4ee0-8823-c4751a6d6696",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.301Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.486Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"cmd.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"cmd.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                  \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                  \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                  \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                  \"FE80::/10\", \"FF00::/8\") and\n    not dns.question.name : (\n          \"wpad\", \"localhost\", \"ocsp.comodoca.com\", \"ocsp.digicert.com\", \"ocsp.sectigo.com\", \"crl.comodoca.com\"\n    )]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via DirectoryService Plugin Modification",
        "description": "Identifies the creation or modification of a DirectoryService PlugIns (dsplug) file. The DirectoryService daemon launches on each system boot and automatically reloads after crash. It scans and executes bundles that are located in the DirectoryServices PlugIns folder and can be abused by adversaries to maintain persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.chichou.me/2019/11/21/two-macos-persistence-tricks-abusing-plugins/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ece358d2-676a-44b7-a2d7-2fa9b8f5a409",
        "rule_id": "89fa6cb7-6b53-4de2-b604-648488841ab8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.303Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.606Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and not event.type:deletion and\n  file.path:/Library/DirectoryServices/PlugIns/*.dsplug",
        "language": "kuery"
      },
      {
        "name": "Potential SharpRDP Behavior",
        "description": "Identifies potential behavior of SharpRDP, which is a tool that can be used to perform authenticated command execution against a remote target via Remote Desktop Protocol (RDP) for the purposes of lateral movement.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Lateral%20Movement/LM_sysmon_3_12_13_1_SharpRDP.evtx",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "d9744604-7819-41ba-81ce-a2d70c99410d",
        "rule_id": "8c81e506-6e82-4884-9b9a-75d3d252f967",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.305Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.621Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Incoming RDP followed by a new RunMRU string value set to cmd, powershell, taskmgr or tsclient, followed by process execution within 1m */\n\nsequence by host.id with maxspan=1m\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"svchost.exe\" and destination.port == 3389 and\n   network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ]\n\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and process.name : \"explorer.exe\" and\n   registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\RunMRU\\\\*\") and\n   registry.data.strings : (\"cmd.exe*\", \"powershell.exe*\", \"taskmgr*\", \"\\\\\\\\tsclient\\\\*.exe\\\\*\")\n  ]\n\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.parent.name : (\"cmd.exe\", \"powershell.exe\", \"taskmgr.exe\") or process.args : (\"\\\\\\\\tsclient\\\\*.exe\")) and\n   not process.name : \"conhost.exe\"\n   ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.registry-*",
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Outgoing RDP Connection by Unusual Process",
        "description": "Adversaries may attempt to connect to a remote system over Windows Remote Desktop Protocol (RDP) to achieve lateral movement. Adversaries may avoid using the Microsoft Terminal Services Client (mstsc.exe) binary to establish an RDP connection to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2964b13d-d691-4dbe-b1ca-a0a33d79dd2d",
        "rule_id": "8e39f54e-910b-4adb-a87e-494fbba5fb65",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.306Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.916Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and\n  event.action == \"connection_attempted\" and destination.port == 3389 and\n  destination.ip != \"::1\" and destination.ip != \"127.0.0.1\" and\n  not (\n    process.executable : (\n      \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n      \"?:\\\\Program Files (x86)\\\\mRemoteNG\\\\mRemoteNG.exe\",\n      \"?:\\\\Program Files (x86)\\\\PRTG Network Monitor\\\\PRTG Probe.exe\",\n      \"?:\\\\Program Files\\\\Azure Advanced Threat Protection Sensor\\\\*\\\\Microsoft.Tri.Sensor.exe\",\n      \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Remote Desktop Connection Manager\\\\RDCMan.exe\",\n      \"?:\\\\Program Files\\\\SentinelOne\\\\Sentinel Agent*\\\\Ranger\\\\SentinelRanger.exe\",\n      \"?:\\\\Program Files\\\\Devolutions\\\\Remote Desktop Manager\\\\RemoteDesktopManager.exe\",\n      \"?:\\\\Program Files (x86)\\\\Devolutions\\\\Remote Desktop Manager\\\\RemoteDesktopManager.exe\"\n    ) and process.code_signature.trusted == true\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Bitsadmin Activity",
        "description": "Windows Background Intelligent Transfer Service (BITS) is a low-bandwidth, asynchronous file transfer mechanism. Adversaries may abuse BITS to persist, download, execute, and even clean up after running malicious code.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "92e98784-a3bd-4f07-85ce-bfa2a3024dfe",
        "rule_id": "8eec4df1-4b4b-4502-b6c3-c788714604c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.308Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.920Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   (process.name : \"bitsadmin.exe\" and process.args : (\n        \"*Transfer*\", \"*Create*\", \"AddFile\", \"*SetNotifyFlags*\", \"*SetNotifyCmdLine*\",\n        \"*SetMinRetryDelay*\", \"*SetCustomHeaders*\", \"*Resume*\")\n   ) or\n   (process.name : \"powershell.exe\" and process.args : (\n        \"*Start-BitsTransfer*\", \"*Add-BitsFile*\",\n        \"*Resume-BitsTransfer*\", \"*Set-BitsTransfer*\", \"*BITS.Manager*\")\n   )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Incoming DCOM Lateral Movement with ShellBrowserWindow or ShellWindows",
        "description": "Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the ShellBrowserWindow or ShellWindows Application COM Object. This behavior may indicate an attacker abusing a DCOM application to stealthily move laterally.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.003",
                    "name": "Distributed Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1021/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "bbec72ea-fd86-44d0-842d-53a83e4457f2",
        "rule_id": "8f919d4b-a5af-47ca-a594-6be59cd924a4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.310Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.633Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n  source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"explorer.exe\"\n ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "InstallUtil Activity",
        "description": "InstallUtil is a command-line utility that allows for installation and uninstallation of resources by executing specific installer components specified in .NET binaries. Adversaries may use InstallUtil to proxy the execution of code through a trusted Windows utility.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a0988a0d-164b-4e75-a51c-c40d99735491",
        "rule_id": "90babaa8-5216-4568-992d-d4a01a105d98",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.312Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.923Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"installutil.exe\" and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Web User Agent",
        "description": "A machine learning job detected a rare and unusual user agent indicating web browsing activity by an unusual process other than a web browser. This can be due to persistence, command-and-control, or exfiltration activity. Uncommon user agents coming from remote sources to local destinations are often the result of scanners, bots, and web scrapers, which are part of common Internet background traffic. Much of this is noise, but more targeted attacks on websites using tools like Burp or SQLmap can sometimes be discovered by spotting uncommon user agents. Uncommon user agents in traffic from local sources to remote destinations can be any number of things, including harmless programs like weather monitoring or stock-trading programs. However, uncommon user agents from local sources can also be due to malware or scanning activity.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Web activity that is uncommon, like security scans, may trigger this alert and may need to be excluded. A new or rarely used program that calls web services may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "ad36d292-1786-4a81-9768-232163ce6293",
        "rule_id": "91f02f01-969f-4167-8d77-07827ac4cee0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.314Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.637Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "packetbeat_rare_user_agent"
        ]
      },
      {
        "name": "Unusual Web Request",
        "description": "A machine learning job detected a rare and unusual URL that indicates unusual web browsing activity. This can be due to initial access, persistence, command-and-control, or exfiltration activity. For example, in a strategic web compromise or watering hole attack, when a trusted website is compromised to target a particular sector or organization, targeted users may receive emails with uncommon URLs for trusted websites. These URLs can be used to download and run a payload. When malware is already running, it may send requests to uncommon URLs on trusted websites the malware uses for command-and-control communication. When rare URLs are observed being requested for a local web server by a remote source, these can be due to web scanning, enumeration or attack traffic, or they can be due to bots and web scrapers which are part of common Internet background traffic.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Web activity that occurs rarely in small quantities can trigger this alert. Possible examples are browsing technical support or vendor URLs that are used very sparsely. A user who visits a new and unique web destination may trigger this alert when the activity is sparse. Web applications that generate URLs unique to a transaction may trigger this when they are used sparsely. Web domains can be excluded in cases such as these."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "0f9bcbb3-5b7f-41be-8ad7-a6f65155f159",
        "rule_id": "91f02f01-969f-4167-8f55-07827ac3acc9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.315Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.642Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "packetbeat_rare_urls"
        ]
      },
      {
        "name": "DNS Tunneling",
        "description": "A machine learning job detected unusually large numbers of DNS queries for a single top-level DNS domain, which is often used for DNS tunneling. DNS tunneling can be used for command-and-control, persistence, or data exfiltration activity. For example, dnscat tends to generate many DNS questions for a top-level domain as it uses the DNS protocol to tunnel data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "DNS domains that use large numbers of child domains, such as software or content distribution networks, can trigger this alert and such parent domains can be excluded."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment  ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Network Packet Capture and select the integration to see more details about it.\n- Click Add Network Packet Capture.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed network_traffic to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "f721e6e0-457a-40da-ae51-c00b87e9d885",
        "rule_id": "91f02f01-969f-4167-8f66-07827ac3bdd9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.317Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.647Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "packetbeat_dns_tunneling"
        ]
      },
      {
        "name": "Encoded Executable Stored in the Registry",
        "description": "Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversary defense evasion by avoiding the storing of malicious content directly on disk.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 411,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "149363e3-a649-4efb-83fc-7e1291983ca8",
        "rule_id": "93c1ce76-494c-4f01-8167-35edfb52f7b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.319Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.663Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and\n/* update here with encoding combinations */\n registry.data.strings : \"TVqQAAMAAAAEAAAA*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "winlogbeat-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Kernel Module",
        "description": "Identifies activity related to loading kernel modules on Linux via creation of new ko files in the LKM directory.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c32caa1-4a0a-4d91-a627-08abf98f89f8",
        "rule_id": "947827c6-9ed6-4dec-903e-c856c86e72f3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.321Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.926Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type in (\"change\", \"creation\") and file.path : \"/lib/modules/*\" and\nfile.extension == \"ko\" and not process.name : (\n  \"dpkg\", \"systemd\", \"falcon-sensor*\", \"dnf\", \"yum\", \"rpm\", \"cp\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Group Policy Discovery via Microsoft GPResult Utility",
        "description": "Detects the usage of gpresult.exe to query group policy objects. Attackers may query group policy objects during the reconnaissance phase after compromising a system to gain a better understanding of the active directory environment and possible methods to escalate privileges or move laterally.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Group Policy Discovery via Microsoft GPResult Utility\n\nGroup Policy is a Windows feature that allows administrators to manage and configure settings for users and computers in an Active Directory environment. The Microsoft GPResult utility (gpresult.exe) is a command-line tool used to query and display Group Policy Objects (GPOs) applied to a system. Attackers may abuse this utility to gain insights into the active directory environment and identify potential privilege escalation or lateral movement opportunities.\n\nThe detection rule 'Group Policy Discovery via Microsoft GPResult Utility' is designed to identify the usage of gpresult.exe with specific arguments (\"/z\", \"/v\", \"/r\", \"/x\") that are commonly used by adversaries during the reconnaissance phase to perform group policy discovery.\n\n#### Possible investigation steps\n\n- Review the alert details to understand the context of the gpresult.exe usage, such as the user account, system, and time of execution.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate any abnormal behavior by the parent process, such as network connections, registry or file modifications, and any other spawned child processes.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1615",
                "name": "Group Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1615/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b8864211-878c-4ce4-94c3-15997dbafb0d",
        "rule_id": "94a401ba-4fa2-455c-b7ae-b6e037afc0b7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.322Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.687Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(process.name: \"gpresult.exe\" or ?process.pe.original_file_name == \"gprslt.exe\") and process.args: (\"/z\", \"/v\", \"/r\", \"/x\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Remote Scheduled Task Creation",
        "description": "Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Scheduled Task Creation\n\n[Scheduled tasks](https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler) are a great mechanism for persistence and program execution. These features can be used remotely for a variety of legitimate reasons, but at the same time used by malware and adversaries. When investigating scheduled tasks that were set up remotely, one of the first steps should be to determine the original intent behind the configuration and to verify if the activity is tied to benign behavior such as software installation or any kind of network administrator work. One objective for these alerts is to understand the configured action within the scheduled task. This is captured within the registry event data for this rule and can be base64 decoded to view the value.\n\n#### Possible investigation steps\n\n- Review the base64 encoded tasks actions registry value to investigate the task configured action.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Further examination should include review of host-based artifacts and network logs from around when the scheduled task was created, on both the source and target machines.\n\n### False positive analysis\n\n- There is a high possibility of benign activity tied to the creation of remote scheduled tasks as it is a general feature within Windows and used for legitimate purposes for a wide range of activity. Any kind of context should be found to further understand the source of the activity and determine the intent based on the scheduled task's contents.\n\n### Related rules\n\n- Service Command Lateral Movement - d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc\n- Remotely Started Services via RPC - aa9a274d-6b53-424d-ac5e-cb8ca4251650\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove scheduled task and any other related artifacts.\n- Review privileged account management and user account management settings. Consider implementing group policy object (GPO) policies to further restrict activity, or configuring settings that only allow administrators to create remote scheduled tasks.\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "fda1316a-fda6-4d42-8d8c-f27541f094ac",
        "rule_id": "954ee7c8-5437-49ae-b2d6-2960883898e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.324Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.705Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Task Scheduler service incoming connection followed by TaskCache registry modification  */\n\nsequence by host.id, process.entity_id with maxspan = 1m\n   [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and\n   network.direction : (\"incoming\", \"ingress\") and source.port >= 49152 and destination.port >= 49152 and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ]\n   [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Startup or Run Key Registry Modification",
        "description": "Identifies run key or startup key registry modifications. In order to survive reboots and other system interrupts, attackers will modify run keys within the registry or leverage startup folder items as a form of persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "3e47ef71-ebfc-4520-975c-cb27fc090799",
        "timeline_title": "Comprehensive Registry Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Startup or Run Key Registry Modification\n\nAdversaries may achieve persistence by referencing a program with a registry run key. Adding an entry to the run keys in the registry will cause the program referenced to be executed when a user logs in. These programs will executed under the context of the user and will have the account's permissions. This rule looks for this behavior by monitoring a range of registry run keys.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- There is a high possibility of benign legitimate programs being added to registry run keys. This activity could be based on new software installations, patches, or any kind of network administrator related activity. Before undertaking further investigation, verify that this activity is not benign.\n\n### Related rules\n\n- Suspicious Startup Shell Folder Modification - c8b150f0-0164-475b-a75e-74b47800a9ff\n- Persistent Scripts in the Startup Directory - f7c4dc5a-a58d-491d-9f14-9b66507121c0\n- Startup Folder Persistence via Unsigned Process - 2fba96c0-ade5-4bce-b92f-a5df2509da3f\n- Startup Persistence by a Suspicious Process - 440e2db4-bc7f-4c96-a068-65b78da59bde\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-security-uncovers-blister-malware-campaign"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.hive",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "09984ee4-2e72-45a8-a9fb-042c21b9fc8a",
        "rule_id": "97fc44d3-8dae-4019-ae83-298c3015600f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.329Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.241Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and \n registry.data.strings != null and registry.hive : (\"HKEY_USERS\", \"HKLM\") and\n registry.path : (\n     /* Machine Hive */\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n     /* Users Hive */\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\"\n     ) and\n  /* add common legitimate changes without being too restrictive as this is one of the most abused AESPs */\n  not registry.data.strings : \"ctfmon.exe /n\" and\n  not (registry.value : \"Application Restart #*\" and process.name : \"csrss.exe\") and\n  not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  not registry.data.strings : (\"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\") and\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\") and\n  not (\n    /* Logitech G Hub */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Logitech Inc\" and\n      (\n        process.name : \"lghub_agent.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files\\\\LGHUB\\\\lghub.exe\\\" --background\",\n          \"\\\"?:\\\\Program Files\\\\LGHUB\\\\system_tray\\\\lghub_system_tray.exe\\\" --minimized\"\n        )\n      ) or\n      (\n        process.name : \"LogiBolt.exe\" and registry.data.strings : (\n          \"?:\\\\Program Files\\\\Logi\\\\LogiBolt\\\\LogiBolt.exe --startup\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Logi\\\\LogiBolt\\\\LogiBolt.exe --startup\"\n        )\n      )\n    ) or\n\n    /* Google Drive File Stream, Chrome, and Google Update */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Google LLC\" and\n      (\n        process.name : \"GoogleDriveFS.exe\" and registry.data.strings : (\n        \"\\\"?:\\\\Program Files\\\\Google\\\\Drive File Stream\\\\*\\\\GoogleDriveFS.exe\\\" --startup_mode\"\n        ) or\n\n        process.name : \"chrome.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --no-startup-window /prefetch:5\",\n          \"\\\"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --no-startup-window /prefetch:5\"\n        ) or\n\n        process.name : \"GoogleUpdate.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Update\\\\*\\\\GoogleUpdateCore.exe\\\"\"\n        )\n      )\n    ) or\n\n    /* MS Programs */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name in (\"Microsoft Windows\", \"Microsoft Corporation\") and\n      (\n        process.name : \"msedge.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\" --no-startup-window --win-session-start /prefetch:5\",\n          \"\\\"C:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\" --win-session-start\",\n          \"\\\"C:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\" --no-startup-window --win-session-start\"\n        ) or\n\n        process.name : (\"Update.exe\", \"Teams.exe\") and registry.data.strings : (\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\Update.exe --processStart \\\"Teams.exe\\\" --process-start-args \\\"--system-initiated\\\"\",\n          \"?:\\\\ProgramData\\\\*\\\\Microsoft\\\\Teams\\\\Update.exe --processStart \\\"Teams.exe\\\" --process-start-args \\\"--system-initiated\\\"\"\n        ) or\n\n        process.name : \"OneDriveStandaloneUpdater.exe\" and registry.data.strings : (\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\*\\\\Microsoft.SharePoint.exe\"\n        ) or\n\n        process.name : \"OneDriveSetup.exe\" and\n          registry.data.strings : (\n            \"?:\\\\Windows\\\\system32\\\\cmd.exe /q /c * \\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\*\\\"\",\n            \"?:\\\\Program Files (x86)\\\\Microsoft OneDrive\\\\OneDrive.exe /background*\",\n            \"\\\"?:\\\\Program Files (x86)\\\\Microsoft OneDrive\\\\OneDrive.exe\\\" /background*\",\n            \"?:\\\\Program Files\\\\Microsoft OneDrive\\\\OneDrive.exe /background *\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\??.???.????.????\\\\Microsoft.SharePoint.exe\"\n          ) or\n        \n        process.name : \"OneDrive.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files\\\\Microsoft OneDrive\\\\OneDrive.exe\\\" /background\",\n          \"\\\"?:\\\\Program Files (x86)\\\\Microsoft OneDrive\\\\OneDrive.exe\\\" /background\",\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\\\" /background\"\n        ) or\n        \n        process.name : \"Microsoft.SharePoint.exe\" and registry.data.strings : (\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\??.???.????.????\\\\Microsoft.SharePoint.exe\"\n        ) or\n        \n        process.name : \"MicrosoftEdgeUpdate.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Users\\\\Expedient\\\\AppData\\\\Local\\\\Microsoft\\\\EdgeUpdate\\\\*\\\\MicrosoftEdgeUpdateCore.exe\\\"\"\n        ) or\n        \n        process.executable : \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\Installer\\\\setup.exe\" and\n        registry.data.strings : (\n          \"\\\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\Installer\\\\setup.exe\\\" --msedgewebview --delete-old-versions --system-level --verbose-logging --on-logon\"\n        )\n      )\n    ) or\n\n    /* Slack */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name in (\n       \"Slack Technologies, Inc.\", \"Slack Technologies, LLC\"\n      ) and process.name : \"slack.exe\" and registry.data.strings : (\n        \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\slack.exe\\\" --process-start-args --startup\",\n        \"\\\"?:\\\\ProgramData\\\\*\\\\slack\\\\slack.exe\\\" --process-start-args --startup\",\n        \"\\\"?:\\\\Program Files\\\\Slack\\\\slack.exe\\\" --process-start-args --startup\"\n      )\n    ) or\n\n    /* Cisco */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and\n      (\n        process.name : \"WebexHost.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\WebEx\\\\WebexHost.exe\\\" /daemon /runFrom=autorun\"\n        )\n      ) or\n      (\n        process.name : \"CiscoJabber.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files (x86)\\\\Cisco Systems\\\\Cisco Jabber\\\\CiscoJabber.exe\\\" /min\"\n        )\n      )\n    ) or\n\n    /* Loom */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Loom, Inc.\" and\n      process.name : \"Loom.exe\" and registry.data.strings : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Loom\\\\Loom.exe --process-start-args \\\"--loomHidden\\\"\"\n      )\n    ) or\n\n    /* Adobe */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Adobe Inc.\" and\n      process.name : (\"Acrobat.exe\", \"FlashUtil32_*_Plugin.exe\") and registry.data.strings : (\n        \"\\\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\AdobeCollabSync.exe\\\"\",\n        \"\\\"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\AdobeCollabSync.exe\\\"\",\n        \"?:\\\\WINDOWS\\\\SysWOW64\\\\Macromed\\\\Flash\\\\FlashUtil32_*_Plugin.exe -update plugin\"\n      )\n    ) or\n\n    /* CCleaner */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"PIRIFORM SOFTWARE LIMITED\" and\n      process.name : (\"CCleanerBrowser.exe\", \"CCleaner64.exe\") and registry.data.strings : (\n        \"\\\"C:\\\\Program Files (x86)\\\\CCleaner Browser\\\\Application\\\\CCleanerBrowser.exe\\\" --check-run=src=logon --auto-launch-at-startup --profile-directory=\\\"Default\\\"\",\n        \"\\\"C:\\\\Program Files\\\\CCleaner\\\\CCleaner64.exe\\\" /MONITOR\"\n      )\n    ) or\n\n    /* Opera */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Opera Norway AS\" and\n      process.name : \"opera.exe\" and registry.data.strings : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\launcher.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera GX\\\\launcher.exe\"\n      )\n    ) or\n\n    /* Avast */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Avast Software s.r.o.\" and\n      process.name : \"AvastBrowser.exe\" and registry.data.strings : (\n        \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\AVAST Software\\\\Browser\\\\Application\\\\AvastBrowser.exe\\\" --check-run=src=logon --auto-launch-at-startup*\",\n        \"\\\"?:\\\\Program Files (x86)\\\\AVAST Software\\\\Browser\\\\Application\\\\AvastBrowser.exe\\\" --check-run=src=logon --auto-launch-at-startup*\",\n        \"\"\n      )\n    ) or\n\n    /* Grammarly */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Grammarly, Inc.\" and\n      process.name : \"GrammarlyInstaller.exe\" and registry.data.strings : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Grammarly\\\\DesktopIntegrations\\\\Grammarly.Desktop.exe\"\n      )\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*"
        ],
        "filters": []
      },
      {
        "name": "Indirect Command Execution via Forfiles/Pcalua",
        "description": "Identifies indirect command execution via Program Compatibility Assistant (pcalua.exe) or forfiles.exe.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0df8373d-41fb-4d2b-aa65-767071149df4",
        "rule_id": "98843d35-645e-4e66-9d6a-5049acd96ce1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.331Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.929Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"pcalua.exe\", \"forfiles.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "MacOS Installer Package Spawns Network Event",
        "description": "Detects the execution of a MacOS installer package with an abnormal child process (e.g bash) followed immediately by a network connection via a suspicious process (e.g curl). Threat actors will build and distribute malicious MacOS installer packages, which have a .pkg extension, many times imitating valid software in order to persuade and infect their victims often using the package files (e.g pre/post install scripts etc.) to download additional tools or malicious software. If this rule fires it should indicate the installation of a malicious or suspicious package.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Custom organization-specific macOS packages that use .pkg files to run cURL could trigger this rule. If known behavior is causing false positives, it can be excluded from the rule."
        ],
        "references": [
          "https://redcanary.com/blog/clipping-silver-sparrows-wings",
          "https://posts.specterops.io/introducing-mystikal-4fbd2f7ae520",
          "https://github.com/D00MFist/Mystikal"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.007",
                    "name": "JavaScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/007/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ba47525e-258b-4c00-a0df-505689b68080",
        "rule_id": "99239e7d-b0d4-46e3-8609-acafcf99f68c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.333Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.733Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=15s\n[process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name : (\"installer\", \"package_script_service\") and process.name : (\"bash\", \"sh\", \"zsh\", \"python\", \"osascript\", \"tclsh*\")] by process.entity_id\n[network where host.os.type == \"macos\" and event.type == \"start\" and process.name : (\"curl\", \"osascript\", \"wget\", \"python\", \"java\", \"ruby\", \"node\")] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Spike in Failed Logon Events",
        "description": "A machine learning job found an unusually large spike in authentication failure events. This can be due to password spraying, user enumeration or brute force activity and may be a precursor to account takeover or credentialed access.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Spike in Failed Logon Events\n\nThis rule uses a machine learning job to detect a substantial spike in failed authentication events. This could indicate attempts to enumerate users, password spraying, brute force, etc.\n\n#### Possible investigation steps\n\n- Identify the users involved and if the activity targets a specific user or a set of users.\n- Check if the authentication comes from different sources.\n- Investigate if the host where the failed authentication events occur is exposed to the internet.\n  - If the host is exposed to the internet, and the source of these attempts is external, the activity can be related to bot activity and possibly not directed at your organization.\n  - If the host is not exposed to the internet, investigate the hosts where the authentication attempts are coming from, as this can indicate that they are compromised and the attacker is trying to move laterally.\n- Investigate other alerts associated with the involved users and hosts during the past 48 hours.\n- Check whether the involved credentials are used in automation or scheduled tasks.\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n- Investigate whether there are successful authentication events from the involved sources. This could indicate a successful brute force or password spraying attack.\n\n### False positive analysis\n\n- If the account is used in automation tasks, it is possible that they are using expired credentials, causing a spike in authentication failures.\n- Authentication failures can be related to permission issues.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Assess whether the asset should be exposed to the internet, and take action to reduce your attack surface.\n  - If the asset needs to be exposed to the internet, restrict access to remote login services to specific IPs.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A misconfigured service account can trigger this alert. A password change on an account used by an email client can trigger this alert. Security test cycles that include brute force or password spraying activities may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n- System\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n\n### System Integration Setup\nThe System integration allows you to collect system logs and metrics from your servers with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"system\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for System and select the integration to see more details about it.\n- Click Add System.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed system to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [],
        "id": "fc047448-33f3-479a-951c-ed5d39baf2fb",
        "rule_id": "99dcf974-6587-4f65-9252-d866a3fdfd9c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.335Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.741Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "auth_high_count_logon_fails"
        ]
      },
      {
        "name": "LaunchDaemon Creation or Modification and Immediate Loading",
        "description": "Indicates the creation or modification of a launch daemon, which adversaries may use to repeatedly execute malicious payloads as part of persistence.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted applications persisting via LaunchDaemons"
        ],
        "references": [
          "https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "edb90354-1385-400d-93b8-f9935bb9703e",
        "rule_id": "9d19ece6-c20e-481a-90c5-ccca596537de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.337Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.766Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n [file where host.os.type == \"macos\" and event.type != \"deletion\" and file.path : (\"/System/Library/LaunchDaemons/*\", \"/Library/LaunchDaemons/*\")]\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"launchctl\" and process.args == \"load\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Linux Process Calling the Metadata Service",
        "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs very rarely as part of a monthly or quarterly workflow could trigger this detection rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "343c9ec1-b20d-4036-a1cb-e0dd7c95c9d3",
        "rule_id": "9d302377-d226-4e12-b54c-1906b5aec4f6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.338Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.777Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_linux_rare_metadata_process"
        ]
      },
      {
        "name": "Suspicious Service was Installed in the System",
        "description": "Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically run as SYSTEM and can be used for privilege escalation and persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Service was Installed in the System\n\nAttackers may create new services to execute system shells and other command execution utilities to elevate their privileges from administrator to SYSTEM. They can also configure services to execute these utilities with persistence payloads.\n\nThis rule looks for suspicious services being created with suspicious traits compatible with the above behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify how the service was created or modified. Look for registry changes events or Windows events related to service activities (for example, 4697 and/or 7045).\n  - Examine the created and existent services, the executables or drivers referenced, and command line arguments for suspicious entries.\n    - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n  - Retrieve the referenced files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- Certain services such as PSEXECSVC may happen legitimately. The security team should address any potential benign true positive (B-TP) by excluding the relevant FP by pattern.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ImagePath",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ServiceFileName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "8f91eaf1-e3dd-4350-8878-5142c5471005",
        "rule_id": "da87eee1-129c-4661-a7aa-57d0b9645fad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.340Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.386Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where\n  (event.code : \"4697\" and\n   (winlog.event_data.ServiceFileName : \n           (\"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\", \n            \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\", \n            \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n            \"*regsvr32*\", \"*msbuild*\") or\n   winlog.event_data.ServiceFileName regex~ \"\"\"%systemroot%\\\\[a-z0-9]+\\.exe\"\"\")) or\n\n  (event.code : \"7045\" and\n   winlog.event_data.ImagePath : (\n       \"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\",\n       \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\",\n       \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n       \"*regsvr32*\", \"*msbuild*\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Invoke-NinjaCopy script",
        "description": "Detects PowerShell scripts that contain the default exported functions used on Invoke-NinjaCopy. Attackers can use Invoke-NinjaCopy to read SYSTEM files that are normally locked, such as the NTDS.dit file or registry hives.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Invoke-NinjaCopy script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nInvoke-NinjaCopy is a PowerShell script capable of reading SYSTEM files that were normally locked, such as `NTDS.dit` or sensitive registry locations. It does so by using the direct volume access technique, which enables attackers to bypass access control mechanisms and file system monitoring by reading the raw data directly from the disk and extracting the file by parsing the file system structures.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Check if the imported function was executed and which file it targeted.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/collection/Invoke-NinjaCopy.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1006",
                "name": "Direct Volume Access",
                "reference": "https://attack.mitre.org/techniques/T1006/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e81852bb-a549-4be3-930d-72d527cc14dd",
        "rule_id": "b8386923-b02c-4b94-986a-d223d9b01f88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.342Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.546Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"StealthReadFile\" or\n    \"StealthReadFileAddr\" or\n    \"StealthCloseFileDelegate\" or\n    \"StealthOpenFile\" or\n    \"StealthCloseFile\" or\n    \"StealthReadFile\" or\n    \"Invoke-NinjaCopy\"\n   )\n  and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )",
        "language": "kuery"
      },
      {
        "name": "A scheduled task was updated",
        "description": "Indicates the update of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, by changing the configuration of a legit scheduled task. Some changes such as disabling or enabling a scheduled task are common and may may generate noise.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "4d153d52-ae19-4e08-91e9-7a5ae1b8a85a",
        "rule_id": "a02cb68e-7c93-48d1-93b2-2c39023308eb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.344Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.423Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-updated\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and \n not winlog.event_data.TaskName : \"*Microsoft*\" and \n not winlog.event_data.TaskName :\n          (\"\\\\User_Feed_Synchronization-*\",\n           \"\\\\OneDrive Reporting Task-S-1-5-21*\",\n           \"\\\\OneDrive Reporting Task-S-1-12-1-*\",\n           \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n           \"\\\\Hewlett-Packard\\\\HPDeviceCheck\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistant\", \n           \"\\\\IpamDnsProvisioning\",  \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantAllUsersRun\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantCalendarRun\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantWakeupRun\", \n           \"\\\\Microsoft\\\\Windows\\\\.NET Framework\\\\.NET Framework NGEN v*\", \n           \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\") and \n  not winlog.event_data.SubjectUserSid :  (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "My First Rule",
        "description": "This rule helps you test and practice using alerts with Elastic Security as you get set up. Its not a sign of threat activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "This is a test alert.\n\nThis alert does not show threat activity. Elastic created this alert to help you understand how alerts work.\n\nFor normal rules, the Investigation Guide will help analysts investigate alerts.\n\nThis alert will show once every 24 hours for each host. It is safe to disable this rule.\n",
        "output_index": "",
        "version": 3,
        "tags": [
          "Use Case: Guided Onboarding"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "24h",
        "from": "now-86400s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "This rule is not looking for threat activity. Disable the rule if you're already familiar with alerts."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-rules.html"
        ],
        "max_signals": 1,
        "threat": [],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "573ecaed-670b-408b-b434-c48f4e2176c8",
        "rule_id": "a198fbbd-9413-45ec-a269-47ae4ccf59ce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": true
        },
        "updated_at": "2024-12-16T10:23:00.345Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.826Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.kind:event",
        "threshold": {
          "field": [
            "host.name"
          ],
          "value": 1
        },
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "logs-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Google Workspace Restrictions for Marketplace Modified to Allow Any App",
        "description": "Detects when the Google Marketplace restrictions are changed to allow any application for users in Google Workspace. Malicious APKs created by adversaries may be uploaded to the Google marketplace but not installed on devices managed within Google Workspace. Administrators should set restrictions to not allow any application from the marketplace for security reasons. Adversaries may enable any app to be installed and executed on mobile devices within a Google Workspace environment prior to distributing the malicious APK to the end user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Restrictions for Marketplace Modified to Allow Any App\n\nGoogle Workspace Marketplace is an online store for free and paid web applications that work with Google Workspace services and third-party software. Listed applications are based on Google APIs or Google Apps Script and created by both Google and third-party developers.\n\nMarketplace applications require access to specific Google Workspace resources. Applications can be installed by individual users, if they have permission, or can be installed for an entire Google Workspace domain by administrators. Consent screens typically display what permissions and privileges the application requires during installation. As a result, malicious Marketplace applications may require more permissions than necessary or have malicious intent.\n\nGoogle clearly states that they are not responsible for any product on the Marketplace that originates from a source other than Google.\n\nThis rule identifies when the global allow-all setting is enabled for Google Workspace Marketplace applications.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- This rule relies on data from `google_workspace.admin`, thus indicating the associated user has administrative privileges to the Marketplace.\n- Search for `event.action` is `ADD_APPLICATION` to identify applications installed after these changes were made.\n    - The `google_workspace.admin.application.name` field will help identify what applications were added.\n- With the user account, review other potentially related events within the last 48 hours.\n- Re-assess the permissions and reviews of the Marketplace applications to determine if they violate organizational policies or introduce unexpected risks.\n- With access to the Google Workspace admin console, determine if the application was installed domain-wide or individually by visiting `Apps > Google Workspace Marketplace Apps`.\n\n### False positive analysis\n\n- Identify the user account associated with this action and assess their administrative privileges with Google Workspace Marketplace.\n- Google Workspace administrators may intentionally add an application from the marketplace based on organizational needs.\n    - Follow up with the user who added the application to ensure this was intended.\n- Verify the application identified has been assessed thoroughly by an administrator.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Applications can be added and removed from blocklists by Google Workspace administrators, but they can all be explicitly allowed for users. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/6089179?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.application.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.admin.new_value",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.admin.setting.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.event.type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "4fc8abb0-c7e5-4686-8f5d-36c14ccae5be",
        "rule_id": "a2795334-2499-11ed-9e1a-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.347Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.855Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.action:\"CHANGE_APPLICATION_SETTING\" and event.category:(iam or configuration)\n    and google_workspace.event.type:\"APPLICATION_SETTINGS\" and google_workspace.admin.application.name:\"Google Workspace Marketplace\"\n        and google_workspace.admin.setting.name:\"Apps Access Setting Allowlist access\"  and google_workspace.admin.new_value:\"ALLOW_ALL\"",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Exchange Safe Link Policy Disabled",
        "description": "Identifies when a Safe Link policy is disabled in Microsoft 365. Safe Link policies for Office applications extend phishing protection to documents that contain hyperlinks, even after they have been delivered to a user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Disabling safe links may be done by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/disable-safelinksrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/atp-safe-links?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "edcae16b-9df9-4901-aea8-c9eff9adefc4",
        "rule_id": "a989fa1b-9a11-4dd8-a3e9-f0de9c6eb5f2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.349Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.846Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Disable-SafeLinksRule\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Password Policy Modified",
        "description": "Detects when a Google Workspace password policy is modified. An adversary may attempt to modify a password policy in order to weaken an organizations security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Password Policy Modified\n\nGoogle Workspace administrators manage password policies to enforce password requirements for an organization's compliance needs. Administrators have the capability to set restrictions on password length, reset frequency, reuse capability, expiration, and much more. Google Workspace also allows multi-factor authentication (MFA) and 2-step verification (2SV) for authentication.\n\nThreat actors might rely on weak password policies or restrictions to attempt credential access by using password stuffing or spraying techniques for cloud-based user accounts. Administrators might introduce increased risk to credential access from a third-party by weakening the password restrictions for an organization.\n\nThis rule detects when a Google Workspace password policy is modified to decrease password complexity or to adjust the reuse and reset frequency.\n\n#### Possible investigation steps\n\n- Identify associated user account(s) by reviewing the `user.name` or `source.user.email` fields in the alert.\n- Identify the password setting that was created or adjusted by reviewing `google_workspace.admin.setting.name` field.\n- Check if a password setting was enabled or disabled by reviewing the `google_workspace.admin.new_value` and `google_workspace.admin.old_value` fields.\n- After identifying the involved user, verify administrative privileges are scoped properly to change.\n- Filter `event.dataset` for `google_workspace.login` and aggregate by `user.name`, `event.action`.\n  - The `google_workspace.login.challenge_method` field can be used to identify the challenge method used for failed and successful logins.\n\n### False positive analysis\n\n- After identifying the user account that updated the password policy, verify whether the action was intentional.\n- Verify whether the user should have administrative privileges in Google Workspace to modify password policies.\n- Review organizational units or groups the role may have been added to and ensure the new privileges align properly.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider resetting passwords for potentially affected users.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate multi-factor authentication for the user.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators might observe lag times ranging from several minutes to 3 days between the event occurrence time and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Password policies may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/7061566",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, the Filebeat module, or data that's similarly structured is required for this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.setting.name",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "735d44ef-a89a-4db8-9465-4206dd4e9eb2",
        "rule_id": "a99f82f5-8e77-4f8b-b3ce-10c0f6afbc73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.351Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.866Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and\n  event.action:(CHANGE_APPLICATION_SETTING or CREATE_APPLICATION_SETTING) and\n  google_workspace.admin.setting.name:(\n    \"Password Management - Enforce strong password\" or\n    \"Password Management - Password reset frequency\" or\n    \"Password Management - Enable password reuse\" or\n    \"Password Management - Enforce password policy at next login\" or\n    \"Password Management - Minimum password length\" or\n    \"Password Management - Maximum password length\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Google Workspace API Access Granted via Domain-Wide Delegation",
        "description": "Detects when a domain-wide delegation of authority is granted to a service account. Domain-wide delegation can be configured to grant third-party and internal applications to access the data of Google Workspace users. An adversary may configure domain-wide delegation to maintain access to their targets data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace API Access Granted via Domain-Wide Delegation\n\nDomain-wide delegation is a feature that allows apps to access users' data across an organization's Google Workspace environment. Only super admins can manage domain-wide delegation, and they must specify each API scope that the application can access. Google Workspace services all have APIs that can be interacted with after domain-wide delegation is established with an OAuth2 client ID of the application. Typically, GCP service accounts and applications are created where the Google Workspace APIs are enabled, thus allowing the application to access resources and services in Google Workspace.\n\nApplications authorized to interact with Google Workspace resources and services through APIs have a wide range of capabilities depending on the scopes applied. If the principle of least privilege (PoLP) is not practiced when setting API scopes, threat actors could abuse additional privileges if the application is compromised. New applications created and given API access could indicate an attempt by a threat actor to register their malicious application with the Google Workspace domain in an attempt to establish a command and control foothold.\n\nThis rule identifies when an application is authorized API client access.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n  - Only users with super admin privileges can authorize API client access.\n- Identify the API client name by reviewing the `google_workspace.admin.api.client.name` field in the alert.\n  - If GCP audit logs are ingested, pivot to reviewing the last 48 hours of activity related to the service account ID.\n  - Search for the `google_workspace.admin.api.client.name` value with wildcards in the `gcp.audit.resource_name` field.\n  - Search for API client name and aggregated results on `event.action` to determine what the service account is being used for in GWS.\n- After identifying the involved user, verify super administrative privileges to access domain-wide delegation settings.\n\n### False positive analysis\n\n- Changes to domain-wide delegation require super admin privileges. Check with the user to ensure these changes were expected.\n- Review scheduled maintenance notes related to expected API access changes.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Review the scope of the authorized API client access in Google Workspace.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain-wide delegation of authority may be granted to service accounts by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://developers.google.com/admin-sdk/directory/v1/guides/delegation",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d6ee6814-3674-4ae8-aa65-620644e9d0f5",
        "rule_id": "acbc8bb9-2486-49a8-8779-45fb5f9a93ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.352Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.892Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin\n  and event.provider:admin\n  and event.category:iam\n  and event.action:AUTHORIZE_API_CLIENT_ACCESS\n  and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Custom Admin Role Created",
        "description": "Detects when a custom admin role is created in Google Workspace. An adversary may create a custom admin role in order to elevate the permissions of other user accounts and persist in their targets environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Custom Admin Role Created\n\nGoogle Workspace roles allow administrators to assign specific permissions to users or groups where the principle of least privilege (PoLP) is recommended. Admin roles in Google Workspace grant users access to the Google Admin console, where more domain-wide settings are accessible. Google Workspace contains prebuilt administrator roles for performing business functions related to users, groups, and services. Custom administrator roles can be created where prebuilt roles are not preferred.\n\nRoles assigned to users will grant them additional permissions and privileges within the Google Workspace domain. Threat actors might create new admin roles with privileges to advance their intrusion efforts and laterally move throughout the organization if existing roles or users do not have privileges aligned with their modus operandi. Users with unexpected privileges from new admin roles may also cause operational dysfunction if unfamiliar settings are adjusted without warning. Instead of modifying existing roles, administrators might create new roles to accomplish short-term goals and unintentionally introduce additional risk exposure.\n\nThis rule identifies when a Google Workspace administrative role is added within the Google Workspace admin console.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- Identify the role added by reviewing the `google_workspace.admin.role.name` field in the alert.\n- After identifying the involved user, verify if they should have administrative privileges to add administrative roles.\n- To identify if users have been assigned this role, search for `event.action: ASSIGN_ROLE`.\n    - Add `google_workspace.admin.role.name` with the role added as an additional filter.\n    - Adjust the relative time accordingly to identify all users that were possibly assigned this admin role.\n- Monitor users assigned the admin role for the next 24 hours and look for attempts to use related privileges.\n  - The `event.provider` field will help filter for specific services in Google Workspace such as Drive or Admin.\n  - The `event.action` field will help trace what actions are being taken by users.\n\n### False positive analysis\n\n- After identifying the user account that created the role, verify whether the action was intentional.\n- Verify that the user who created the role should have administrative privileges in Google Workspace to create custom roles.\n- Review organizational units or groups the role may have been added to and ensure the new privileges align properly.\n- Create a filter with the user's `user.name` and filter for `event.action`. In the results, check if there are multiple `CREATE_ROLE` actions and note whether they are new or historical.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Custom Google Workspace admin roles may be created by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/2406043?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "95bd2dc3-81ad-46a3-a8e9-2f7618564770",
        "rule_id": "ad3f2807-2b3e-47d7-b282-f84acbbe14be",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.354Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.912Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:CREATE_ROLE",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Unusual Volume of File Deletion",
        "description": "Identifies that a user has deleted an unusually large volume of files as reported by Microsoft Cloud App Security.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "Users or System Administrator cleaning out folders."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/cloud-app-security/anomaly-detection-policy",
          "https://docs.microsoft.com/en-us/cloud-app-security/policy-template-reference"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2697132c-3a00-4be3-be20-37ec0e517f9c",
        "rule_id": "b2951150-658f-4a60-832f-a00d1e6c6745",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.356Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.858Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Unusual volume of file deletion\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Teams Custom Application Interaction Allowed",
        "description": "Identifies when custom applications are allowed in Microsoft Teams. If an organization requires applications other than those available in the Teams app store, custom applications can be developed as packages and uploaded. An adversary may abuse this behavior to establish persistence in an environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Custom applications may be allowed by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/microsoftteams/platform/concepts/deploy-and-publish/apps-upload"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "o365.audit.Name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "o365.audit.NewValue",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9c682633-d5f7-4d69-a476-7576239d2a03",
        "rule_id": "bbd1a775-8267-41fa-9232-20e5582596ac",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.359Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.926Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:MicrosoftTeams and\nevent.category:web and event.action:TeamsTenantSettingChanged and\no365.audit.Name:\"Allow sideloading and interaction of custom apps\" and\no365.audit.NewValue:True and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "OneDrive Malware File Upload",
        "description": "Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain initial access to other endpoints in the environment.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Benign files can trigger signatures in the built-in virus protection"
        ],
        "references": [
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1080",
                "name": "Taint Shared Content",
                "reference": "https://attack.mitre.org/techniques/T1080/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "14cb7bb6-ac97-460a-826f-8d0a2bf16d3f",
        "rule_id": "bba1b212-b85c-41c6-9b28-be0e5cdfc9b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.358Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.880Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected",
        "language": "kuery"
      },
      {
        "name": "O365 Mailbox Audit Logging Bypass",
        "description": "Detects the occurrence of mailbox audit bypass associations. The mailbox audit is responsible for logging specified mailbox events (like accessing a folder or a message or permanently deleting a message). However, actions taken by some authorized accounts, such as accounts used by third-party tools or accounts used for lawful monitoring, can create a large number of mailbox audit log entries and may not be of interest to your organization. Because of this, administrators can create bypass associations, allowing certain accounts to perform their tasks without being logged. Attackers can abuse this allowlist mechanism to conceal actions taken, as the mailbox audit will log no activity done by the account.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate allowlisting of noisy accounts"
        ],
        "references": [
          "https://twitter.com/misconfig/status/1476144066807140355"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f506c675-d731-477d-beaf-18fc9993ab47",
        "rule_id": "675239ea-c1bc-4467-a6d3-b9e2cc7f676d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.361Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.806Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.action:Set-MailboxAuditBypassAssociation and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Credential Manipulation - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected Credential Manipulation. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "91fe56f9-43cd-4071-a6a8-7f412b847f9b",
        "rule_id": "c0be5f31-e180-48ed-aa08-96b36899d48f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.372Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.765Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:token_manipulation_event or endgame.event_subtype_full:token_manipulation_event)",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Admin Role Assigned to a User",
        "description": "Assigning the administrative role to a user will grant them access to the Google Admin console and grant them administrator privileges which allow them to access and manage various resources and applications. An adversary may create a new administrator account for persistence or apply the admin role to an existing user to carry out further intrusion efforts. Users with super-admin privileges can bypass single-sign on if enabled in Google Workspace.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Admin Role Assigned to a User\n\nGoogle Workspace roles allow administrators to assign specific permissions to users or groups. These assignments should follow the principle of least privilege (PoLP). Admin roles in Google Workspace grant users access to the Google Admin console, where more domain-wide settings are accessible. Google Workspace contains prebuilt administrator roles for performing business functions related to users, groups, and services. Custom administrator roles can be created when prebuilt roles are not sufficient.\n\nAdministrator roles assigned to users will grant them additional permissions and privileges within the Google Workspace domain. Administrative roles also give users access to the admin console, where domain-wide settings can be adjusted. Threat actors might rely on these new privileges to advance their intrusion efforts and laterally move throughout the organization. Users with unexpected administrative privileges may also cause operational dysfunction if unfamiliar settings are adjusted without warning.\n\nThis rule identifies when a Google Workspace administrative role is assigned to a user.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n  - The `user.target.email` field contains the user who received the admin role.\n- Identify the role given to the user by reviewing the `google_workspace.admin.role.name` field in the alert.\n- After identifying the involved user, verify their administrative privileges are scoped properly.\n- To identify other users with this role, search the alert for `event.action: ASSIGN_ROLE`.\n  - Add `google_workspace.admin.role.name` with the role added as an additional filter.\n  - Adjust the relative time accordingly to identify all users that were assigned this admin role.\n- Identify if the user account was recently created by searching for `event.action: CREATE_USER`.\n  - Add `user.email` with the target user account that recently received this new admin role.\n- After identifying the involved user, create a filter with their `user.name` or `user.target.email`. Review the last 48 hours of their activity for anything that may indicate a compromise.\n\n### False positive analysis\n\n- After identifying user account that added the admin role, verify the action was intentional.\n- Verify that the target user who was assigned the admin role should have administrative privileges in Google Workspace.\n- Review organizational units or groups the target user might have been added to and ensure the admin role permissions align.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Google Workspace admin role assignments may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/172176?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.role.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.event.type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "890436fc-e800-4b11-9431-e97cbe172dab",
        "rule_id": "68994a6c-c7ba-4e82-b476-26a26877adf6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.474Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:19.686Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.category:\"iam\" and event.action:\"ASSIGN_ROLE\"\n  and google_workspace.event.type:\"DELEGATED_ADMIN_SETTINGS\" and google_workspace.admin.role.name : *_ADMIN_ROLE",
        "language": "kuery"
      },
      {
        "name": "New or Modified Federation Domain",
        "description": "Identifies a new or modified federation domain, which can be used to create a trust between O365 and an external identity provider.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-accepteddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-federateddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-accepteddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/add-federateddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/set-accepteddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/msonline/set-msoldomainfederationsettings?view=azureadps-1.0"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.002",
                    "name": "Trust Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "10646601-0edc-4279-82b8-6f5ce80c4a8c",
        "rule_id": "684554fc-0777-47ce-8c9b-3d01f198d7f8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:00.476Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.810Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Set-AcceptedDomain\" or\n\"Set-MsolDomainFederationSettings\" or \"Add-FederatedDomain\" or \"New-AcceptedDomain\" or \"Remove-AcceptedDomain\" or \"Remove-FederatedDomain\") and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Exchange Malware Filter Rule Modification",
        "description": "Identifies when a malware filter rule has been deleted or disabled in Microsoft 365. An adversary or insider threat may want to modify a malware filter rule to evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A malware filter rule may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-malwarefilterrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/disable-malwarefilterrule?view=exchange-ps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3cf0fe90-cf7c-4f2b-9b14-af3d8b975569",
        "rule_id": "ca79768e-40e1-4e45-a097-0e5fbc876ac2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.245Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.792Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-MalwareFilterRule\" or \"Disable-MalwareFilterRule\") and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Credential Manipulation - Prevented - Elastic Endgame",
        "description": "Elastic Endgame prevented Credential Manipulation. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1122029b-ba20-425c-b0b2-c51887748026",
        "rule_id": "c9e38e64-3f4c-4bf3-ad48-0e61a60ea1fa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.247Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.788Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:token_manipulation_event or endgame.event_subtype_full:token_manipulation_event)",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Privileged Pod Created",
        "description": "This rule detects when a user creates a pod/container running in privileged mode. A highly privileged container has access to the node's resources and breaks the isolation between containers. If compromised, an attacker can use the privileged container to gain access to the underlying host. Gaining access to the host may provide the adversary with the opportunity to achieve follow-on objectives, such as establishing persistence, moving laterally within the environment, or setting up a command and control channel on the host.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "By default a container is not allowed to access any devices on the host, but a \"privileged\" container is given access to all devices on the host. This allows the container nearly all the same access as processes running on the host. An administrator may want to run a privileged container to use operating system administrative capabilities such as manipulating the network stack or accessing hardware devices from within the cluster. Add exceptions for trusted container images using the query field \"kubernetes.audit.requestObject.spec.container.image\""
        ],
        "references": [
          "https://media.defense.gov/2021/Aug/03/2002820425/-1/-1/1/CTR_KUBERNETES%20HARDENING%20GUIDANCE.PDF",
          "https://kubernetes.io/docs/tasks/configure-pod-container/security-context/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1610",
                "name": "Deploy Container",
                "reference": "https://attack.mitre.org/techniques/T1610/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.image",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.securityContext.privileged",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ff56bdb3-6fb8-4dbc-a9ed-a644022e1a78",
        "rule_id": "c7908cac-337a-4f38-b50d-5eeb78bdb531",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.249Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.785Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:pods\n  and kubernetes.audit.verb:create\n  and kubernetes.audit.requestObject.spec.containers.securityContext.privileged:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")",
        "language": "kuery"
      },
      {
        "name": "Permission Theft - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected Permission Theft. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f9033138-2089-4c91-8e27-d31394f6f970",
        "rule_id": "c3167e1b-f73c-41be-b60b-87f4df707fe3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.251Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.775Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:token_protection_event or endgame.event_subtype_full:token_protection_event)",
        "language": "kuery"
      },
      {
        "name": "Google Workspace MFA Enforcement Disabled",
        "description": "Detects when multi-factor authentication (MFA) enforcement is disabled for Google Workspace users. An adversary may disable MFA enforcement in order to weaken an organizations security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace MFA Enforcement Disabled\n\nMulti-factor authentication is a process in which users are prompted during the sign-in process for an additional form of identification, such as a code on their cellphone or a fingerprint scan.\n\nIf you only use a password to authenticate a user, it leaves an insecure vector for attack. If the password is weak or has been exposed elsewhere, an attacker could be using it to gain access. When you require a second form of authentication, security is increased because this additional factor isn't something that's easy for an attacker to obtain or duplicate.\n\nFor more information about using MFA in Google Workspace, access the [official documentation](https://support.google.com/a/answer/175197).\n\nThis rule identifies the disabling of MFA enforcement in Google Workspace. This modification weakens the security of the accounts and can lead to the compromise of accounts and other assets.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity can be done by administrators, all users must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the user and domain.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate the multi-factor authentication enforcement.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Impact",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "MFA policies may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/9176657?hl=en#",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.new_value",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "83889ebf-7e51-46a3-8832-c52df96fc150",
        "rule_id": "cad4500a-abd7-4ef3-b5d3-95524de7cfe1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.264Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.796Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin\n  and event.category:iam and event.action:ENFORCE_STRONG_AUTHENTICATION\n  and google_workspace.admin.new_value:false",
        "language": "kuery"
      },
      {
        "name": "Google Workspace User Organizational Unit Changed",
        "description": "Users in Google Workspace are typically assigned a specific organizational unit that grants them permissions to certain services and roles that are inherited from this organizational unit. Adversaries may compromise a valid account and change which organizational account the user belongs to which then could allow them to inherit permissions to applications and resources inaccessible prior to.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace User Organizational Unit Changed\n\nAn organizational unit is a group that an administrator can create in the Google Admin console to apply settings to a specific set of users for Google Workspace. By default, all users are placed in the top-level (parent) organizational unit. Child organizational units inherit the settings from the parent but can be changed to fit the needs of the child organizational unit.\n\nPermissions and privileges for users are often inherited from the organizational unit they are placed in. Therefore, if a user is changed to a separate organizational unit, they will inherit all privileges and permissions. User accounts may have unexpected privileges when switching organizational units that would allow a threat actor to gain a stronger foothold within the organization. The principle of least privileged (PoLP) should be followed when users are switched to different groups in Google Workspace.\n\nThis rule identifies when a user has been moved to a different organizational unit.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n  - The `user.target.email` field contains the user that had their assigned organizational unit switched.\n- Identify the user's previously assigned unit and new organizational unit by checking the `google_workspace.admin.org_unit.name` and `google_workspace.admin.new_value` fields.\n- Identify Google Workspace applications whose settings were explicitly set for this organizational unit.\n    - Search for `event.action` is `CREATE_APPLICATION_SETTING` where `google_workspace.admin.org_unit.name` is the new organizational unit.\n- After identifying the involved user, verify administrative privileges are scoped properly to allow changing user organizational units.\n- Identify if the user account was recently created by searching for `event.action: CREATE_USER`.\n  - Add `user.email` with the target user account that recently had their organizational unit changed.\n- Filter on `user.name` or `user.target.email` of the user who took this action and review the last 48 hours of activity for anything that may indicate a compromise.\n\n### False positive analysis\n\n- After identifying the user account that changed another user's organizational unit, verify the action was intentional.\n- Verify whether the target user who received this update is expected to inherit privileges from the new organizational unit.\n- Review potential maintenance notes or organizational changes. They might explain why a user's organization was changed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Google Workspace administrators may adjust change which organizational unit a user belongs to as a result of internal role adjustments."
        ],
        "references": [
          "https://support.google.com/a/answer/6328701?hl=en#",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.event.type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "54d9e23a-57e9-4013-8efb-dc18ff88e06f",
        "rule_id": "cc6a8a20-2df2-11ed-8378-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.266Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.631Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.type:change and event.category:iam\n    and google_workspace.event.type:\"USER_SETTINGS\" and event.action:\"MOVE_USER_TO_ORG_UNIT\"",
        "language": "kuery"
      },
      {
        "name": "Domain Added to Google Workspace Trusted Domains",
        "description": "Detects when a domain is added to the list of trusted Google Workspace domains. An adversary may add a trusted domain in order to collect and exfiltrate data from their targets organization with less restrictive security controls.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Domain Added to Google Workspace Trusted Domains\n\nOrganizations use trusted domains in Google Workspace to give external users access to resources.\n\nA threat actor with administrative privileges may be able to add a malicious domain to the trusted domain list. Based on the configuration, potentially sensitive resources may be exposed or accessible by an unintended third-party.\n\nThis rule detects when a third-party domain is added to the list of trusted domains in Google Workspace.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- After identifying the user, verify if the user should have administrative privileges to add external domains.\n- Check the `google_workspace.admin.domain.name` field to find the newly added domain.\n- Use reputational services, such as VirusTotal, for the trusted domain's third-party intelligence reputation.\n- Filter your data. Create a filter where `event.dataset` is `google_workspace.drive` and `google_workspace.drive.file.owner.email` is being compared to `user.email`.\n    - If mismatches are identified, this could indicate access from an external Google Workspace domain.\n\n### False positive analysis\n\n- Verify that the user account should have administrative privileges that allow them to edit trusted domains in Google Workspace.\n- Talk to the user to evaluate why they added the third-party domain and if the domain has confidentiality risks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted domains may be added by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/6160020?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0fe54820-36c7-47e3-a9f9-a565f4911b77",
        "rule_id": "cf549724-c577-4fd6-8f9b-d1b8ec519ec0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.268Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.647Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ADD_TRUSTED_DOMAINS",
        "language": "kuery"
      },
      {
        "name": "Remote Windows Service Installed",
        "description": "Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateral movement, but will be noisy if commonly done by administrators.\"",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ServiceFileName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "f9245fa0-ca22-4c93-a0a7-3f612e437cd6",
        "rule_id": "d33ea3bf-9a11-463e-bd46-f648f2a0f4b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.270Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.685Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.logon.id, winlog.computer_name with maxspan=1m\n[authentication where event.action == \"logged-in\" and winlog.logon.type : \"Network\" and\nevent.outcome==\"success\" and source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n[iam where event.action == \"service-installed\" and\n not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n not winlog.event_data.ServiceFileName :\n               (\"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\WINDOWS\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft 365 Exchange Anti-Phish Policy Deletion",
        "description": "Identifies the deletion of an anti-phishing policy in Microsoft 365. By default, Microsoft 365 includes built-in features that help protect users from phishing attacks. Anti-phishing polices increase this protection by refining settings to better detect and prevent attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An anti-phishing policy may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-antiphishpolicy?view=exchange-ps",
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/set-up-anti-phishing-policies?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8199a654-84d9-47ea-a561-4fde7cf17c2c",
        "rule_id": "d68eb1b5-5f1c-4b6d-9e63-5b6b145cd4aa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.271Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.812Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-AntiPhishPolicy\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Exchange Malware Filter Policy Deletion",
        "description": "Identifies when a malware filter policy has been deleted in Microsoft 365. A malware filter policy is used to alert administrators that an internal user sent a message that contained malware. This may indicate an account or machine compromise that would need to be investigated. Deletion of a malware filter policy may be done to evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A malware filter policy may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-malwarefilterpolicy?view=exchange-ps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a46e4acb-c597-42d4-9e23-4fa80ba030ab",
        "rule_id": "d743ff2a-203e-4a46-a3e3-40512cfe8fbb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.273Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.818Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-MalwareFilterPolicy\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Pass-the-Hash (PtH) Attempt",
        "description": "Adversaries may pass the hash using stolen password hashes to move laterally within an environment, bypassing normal system access controls. Pass the hash (PtH) is a method of authenticating as a user without having access to the user's cleartext password.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1550/002/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.002",
                    "name": "Pass the Hash",
                    "reference": "https://attack.mitre.org/techniques/T1550/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.LogonProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "b4a9cab5-4ad6-47dd-b9e0-2f5a5785c2de",
        "rule_id": "daafdf96-e7b1-4f14-b494-27e0d24b11f6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.278Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.822Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:\"windows\" and \nevent.category : \"authentication\" and event.action : \"logged-in\" and \nwinlog.logon.type : \"NewCredentials\" and event.outcome : \"success\" and \nuser.id : (S-1-5-21-* or S-1-12-1-*) and winlog.event_data.LogonProcessName : \"seclogo\"",
        "new_terms_fields": [
          "user.id"
        ],
        "history_window_start": "now-10d",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Credential Dumping - Prevented - Elastic Endgame",
        "description": "Elastic Endgame prevented Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bd336098-d2c6-4268-bfd9-9b3bd7e83046",
        "rule_id": "db8c33a8-03cd-4988-9e2c-d0a4863adb13",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.280Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.832Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event)",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Pod Created With HostPID",
        "description": "This rule detects an attempt to create or modify a pod attached to the host PID namespace. HostPID allows a pod to access all the processes running on the host and could allow an attacker to take malicious action. When paired with ptrace this can be used to escalate privileges outside of the container. When paired with a privileged container, the pod can see all of the processes on the host. An attacker can enter the init system (PID 1) on the host. From there, they could execute a shell and continue to escalate privileges to root.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An administrator or developer may want to use a pod that runs as root and shares the hosts IPC, Network, and PID namespaces for debugging purposes. If something is going wrong in the cluster and there is no easy way to SSH onto the host nodes directly, a privileged pod of this nature can be useful for viewing things like iptable rules and network namespaces from the host's perspective. Add exceptions for trusted container images using the query field \"kubernetes.audit.requestObject.spec.container.image\""
        ],
        "references": [
          "https://research.nccgroup.com/2021/11/10/detection-engineering-for-kubernetes-clusters/#part3-kubernetes-detections",
          "https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces",
          "https://bishopfox.com/blog/kubernetes-pod-privilege-escalation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1610",
                "name": "Deploy Container",
                "reference": "https://attack.mitre.org/techniques/T1610/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.image",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.hostPID",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ff25a613-32b5-49c8-a817-7f27b3a4a199",
        "rule_id": "df7fda76-c92b-4943-bc68-04460a5ea5ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.282Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.838Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.hostPID:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Role Modified",
        "description": "Detects when a custom admin role or its permissions are modified. An adversary may modify a custom admin role in order to elevate the permissions of other user accounts and persist in their targets environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Role Modified\n\nGoogle Workspace roles allow administrators to assign specific permissions to users or groups where the principle of least privilege (PoLP) is recommended. Admin roles in Google Workspace grant users access to the Google Admin console, where more domain-wide settings are accessible. Google Workspace contains prebuilt admin roles for performing business functions related to users, groups, and services. Custom administrator roles can be created where prebuilt roles are not preferred. Each Google Workspace service has a set of custodial privileges that can be added to custom roles.\n\nRoles assigned to users will grant them additional permissions and privileges within the Google Workspace domain. Threat actors might modify existing roles with new privileges to advance their intrusion efforts and laterally move throughout the organization. Users with unexpected privileges might also cause operational dysfunction if unfamiliar settings are adjusted without warning.\n\nThis rule identifies when a Google Workspace role is modified.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- Identify the role modified by reviewing the `google_workspace.admin.role.name` field in the alert.\n- Identify the privilege that was added or removed by reviewing the `google_workspace.admin.privilege.name` field in the alert.\n- After identifying the involved user, verify administrative privileges are scoped properly.\n- To identify other users with this role, search for `event.action: ASSIGN_ROLE`\n  - Add `google_workspace.admin.role.name` with the role added as an additional filter.\n  - Adjust the relative time accordingly to identify all users that were assigned this role.\n- Identify if the user account was recently created by searching for `event.action: CREATE_USER`.\n- If a privilege was added, monitor users assigned this role for the next 24 hours and look for attempts to use the new privilege.\n  - The `event.provider` field will help filter for specific services in Google Workspace such as Drive or Admin.\n  - The `event.action` field will help trace actions that are being taken by users.\n\n### False positive analysis\n\n- After identifying the user account that modified the role, verify the action was intentional.\n- Verify that the user is expected to have administrative privileges in Google Workspace to modify roles.\n- Review organizational units or groups the role might have been added to and ensure the new privileges align properly.\n- Use the `user.name` to filter for `event.action` where `ADD_PRIVILEGE` or `UPDATE_ROLE` has been seen before to check if these actions are new or historical.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Google Workspace admin roles may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/2406043?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cdf75cb0-4082-4d1f-aac2-2af64cde3e2e",
        "rule_id": "6f435062-b7fc-4af9-acea-5b1ead65c5a5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.284Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:19.699Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(ADD_PRIVILEGE or UPDATE_ROLE)",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Container Created with Excessive Linux Capabilities",
        "description": "This rule detects a container deployed with one or more dangerously permissive Linux capabilities. An attacker with the ability to deploy a container with added capabilities could use this for further execution, lateral movement, or privilege escalation within a cluster. The capabilities detected in this rule have been used in container escapes to the host machine.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kubernetes Container Created with Excessive Linux Capabilities\n\nLinux capabilities were designed to divide root privileges into smaller units. Each capability grants a thread just enough power to perform specific privileged tasks. In Kubernetes, containers are given a set of default capabilities that can be dropped or added to at the time of creation. Added capabilities entitle containers in a pod with additional privileges that can be used to change\ncore processes, change network settings of a cluster, or directly access the underlying host. The following have been used in container escape techniques:\n\nBPF - Allow creating BPF maps, loading BPF Type Format (BTF) data, retrieve JITed code of BPF programs, and more.\nDAC_READ_SEARCH - Bypass file read permission checks and directory read and execute permission checks.\nNET_ADMIN - Perform various network-related operations.\nSYS_ADMIN - Perform a range of system administration operations.\nSYS_BOOT - Use reboot(2) and kexec_load(2), reboot and load a new kernel for later execution.\nSYS_MODULE - Load and unload kernel modules.\nSYS_PTRACE - Trace arbitrary processes using ptrace(2).\nSYS_RAWIO - Perform I/O port operations (iopl(2) and ioperm(2)).\nSYSLOG - Perform privileged syslog(2) operations.\n\n### False positive analysis\n\n- While these capabilities are not included by default in containers, some legitimate images may need to add them. This rule leaves space for the exception of trusted container images. To add an exception, add the trusted container image name to the query field, kubernetes.audit.requestObject.spec.containers.image.",
        "output_index": "",
        "version": 5,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some container images require the addition of privileged capabilities. This rule leaves space for the exception of trusted container images. To add an exception, add the trusted container image name to the query field, kubernetes.audit.requestObject.spec.containers.image."
        ],
        "references": [
          "https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container",
          "https://0xn3va.gitbook.io/cheat-sheets/container/escaping/excessive-capabilities",
          "https://man7.org/linux/man-pages/man7/capabilities.7.html",
          "https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1610",
                "name": "Deploy Container",
                "reference": "https://attack.mitre.org/techniques/T1610/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.image",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.securityContext.capabilities.add",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "833d8231-a9ad-450b-94b9-07c1e508657a",
        "rule_id": "7164081a-3930-11ed-a261-0242ac120002",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.285Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.816Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset: kubernetes.audit_logs\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb: create\n  and kubernetes.audit.objectRef.resource: pods\n  and kubernetes.audit.requestObject.spec.containers.securityContext.capabilities.add: (\"BPF\" or \"DAC_READ_SEARCH\"  or \"NET_ADMIN\" or \"SYS_ADMIN\" or \"SYS_BOOT\" or \"SYS_MODULE\" or \"SYS_PTRACE\" or \"SYS_RAWIO\"  or \"SYSLOG\")\n  and not kubernetes.audit.requestObject.spec.containers.image : (\"docker.elastic.co/beats/elastic-agent:8.4.0\" or \"rancher/klipper-lb:v0.3.5\" or \"\")",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Potential ransomware activity",
        "description": "Identifies when Microsoft Cloud App Security reports that a user has uploaded files to the cloud that might be infected with ransomware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "If Cloud App Security identifies, for example, a high rate of file uploads or file deletion activities it may represent an adverse encryption process."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/cloud-app-security/anomaly-detection-policy",
          "https://docs.microsoft.com/en-us/cloud-app-security/policy-template-reference"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "24c6a4a4-f21b-4888-9b8b-9f80f809f037",
        "rule_id": "721999d0-7ab2-44bf-b328-6e63367b9b29",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.287Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.823Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Potential ransomware activity\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Pod Created With HostIPC",
        "description": "This rule detects an attempt to create or modify a pod using the host IPC namespace. This gives access to data used by any pod that also use the hosts IPC namespace. If any process on the host or any processes in a pod uses the hosts inter-process communication mechanisms (shared memory, semaphore arrays, message queues, etc.), an attacker can read/write to those same mechanisms. They may look for files in /dev/shm or use ipcs to check for any IPC facilities being used.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An administrator or developer may want to use a pod that runs as root and shares the host's IPC, Network, and PID namespaces for debugging purposes. If something is going wrong in the cluster and there is no easy way to SSH onto the host nodes directly, a privileged pod of this nature can be useful for viewing things like iptable rules and network namespaces from the host's perspective. Add exceptions for trusted container images using the query field \"kubernetes.audit.requestObject.spec.container.image\""
        ],
        "references": [
          "https://research.nccgroup.com/2021/11/10/detection-engineering-for-kubernetes-clusters/#part3-kubernetes-detections",
          "https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces",
          "https://bishopfox.com/blog/kubernetes-pod-privilege-escalation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1610",
                "name": "Deploy Container",
                "reference": "https://attack.mitre.org/techniques/T1610/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.image",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.hostIPC",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "eeaf8138-3103-4d92-bb1f-dc41235f0f0b",
        "rule_id": "764c8437-a581-4537-8060-1fdb0e92c92d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.289Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.712Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.hostIPC:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")",
        "language": "kuery"
      },
      {
        "name": "Adversary Behavior - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected an Adversary Behavior. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c9e00703-9543-4dfa-99e7-14a8fb0683c5",
        "rule_id": "77a3c3df-8ec4-4da4-b758-878f551dee69",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.291Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.726Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and (event.action:behavior_protection_event or endgame.event_subtype_full:behavior_protection_event)",
        "language": "kuery"
      },
      {
        "name": "Application Added to Google Workspace Domain",
        "description": "Detects when a Google marketplace application is added to the Google Workspace domain. An adversary may add a malicious application to an organizations Google Workspace domain in order to maintain a presence in their targets organization and steal data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Application Added to Google Workspace Domain\n\nGoogle Workspace Marketplace is an online store for free and paid web applications that work with Google Workspace services and third-party software. Listed applications are based on Google APIs or on Google Apps Script and created by both Google and third-party developers.\n\nMarketplace applications require access to specific Google Workspace resources. Applications can be installed by individual users, if they have permission, or can be installed for an entire Google Workspace domain by administrators. Consent screens typically display what permissions and privileges the application requires during installation. As a result, malicious Marketplace applications may require more permissions than necessary or have malicious intent.\n\nGoogle clearly states that they are not responsible for any product on the Marketplace that originates from a source other than Google.\n\nThis rule checks for applications that were manually added to the Marketplace by a Google Workspace account.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- This rule relies on data from `google_workspace.admin`, thus indicating the associated user has administrative privileges to the Marketplace.\n- With access to the Google Workspace admin console, visit the `Security > Investigation tool` with filters for the user email and event is `Assign Role` or `Update Role` to determine if new cloud roles were recently updated.\n- With the user account, review other potentially related events within the last 48 hours.\n- Re-assess the permissions and reviews of the Marketplace applications to determine if they violate organizational policies or introduce unexpected risks.\n- With access to the Google Workspace admin console, determine if the application was installed domain-wide or individually by visiting `Apps > Google Workspace Marketplace Apps`.\n\n### False positive analysis\n\n- Google Workspace administrators might intentionally remove an application from the blocklist due to a re-assessment or a domain-wide required need for the application.\n- Identify the user account associated with this action and assess their administrative privileges with Google Workspace Marketplace.\n- Contact the user to verify that they intentionally removed the application from the blocklist and their reasoning.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Applications can be added to a Google Workspace domain by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/6328701?hl=en#",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "55ebbaf2-e129-4846-9992-d1a2f8176dc4",
        "rule_id": "785a404b-75aa-4ffd-8be5-3334a5a544dd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.292Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.597Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ADD_APPLICATION",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Bitlocker Setting Disabled",
        "description": "Google Workspace administrators whom manage Windows devices and have Windows device management enabled may also enable BitLocker drive encryption to mitigate unauthorized data access on lost or stolen computers. Adversaries with valid account access may disable BitLocker to access sensitive data on an endpoint added to Google Workspace device management.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Bitlocker Setting Disabled\n\nBitLocker Drive Encryption is a data protection feature that integrates with the Windows operating system to address the data theft or exposure threats from lost, stolen, or inappropriately decommissioned computers. BitLocker helps mitigate unauthorized data access by enhancing file and system protections, such as data encryption and rendering data inaccessible. Google Workspace can sync with Windows endpoints that are registered in inventory, where BitLocker can be enabled and disabled.\n\nDisabling Bitlocker on an endpoint decrypts data at rest and makes it accessible, which raises the risk of exposing sensitive endpoint data.\n\nThis rule identifies a user with administrative privileges and access to the admin console, disabling BitLocker for Windows endpoints.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- After identifying the user, verify if the user should have administrative privileges to disable BitLocker on Windows endpoints.\n- From the Google Workspace admin console, review `Reporting > Audit` and `Investigation > Device` logs, filtering on the user email identified from the alert.\n    - If a Google Workspace user logged into their account using a potentially compromised account, this will create an `Device sync event` event.\n\n### False positive analysis\n\n- An administrator may have intentionally disabled BitLocker for routine maintenance or endpoint updates.\n   - Verify with the user that they intended to disable BitLocker on Windows endpoints.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may temporarily disabled Bitlocker on managed devices for maintenance, testing or to resolve potential endpoint conflicts."
        ],
        "references": [
          "https://support.google.com/a/answer/9176657?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.new_value",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.admin.setting.name",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "2a1a6d2a-1bb5-488a-b789-62ead2050792",
        "rule_id": "7caa8e60-2df0-11ed-b814-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.294Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.602Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.action:\"CHANGE_APPLICATION_SETTING\" and event.category:(iam or configuration)\n    and google_workspace.admin.new_value:\"Disabled\" and google_workspace.admin.setting.name:BitLocker*",
        "language": "kuery"
      },
      {
        "name": "Process Injection - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected Process Injection. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ec464ec0-95af-4326-8c57-734b939b17f9",
        "rule_id": "80c52164-c82a-402c-9964-852533d58be1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.296Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.753Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:kernel_shellcode_event or endgame.event_subtype_full:kernel_shellcode_event)",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Global Administrator Role Assigned",
        "description": "In Azure Active Directory (Azure AD), permissions to manage resources are assigned using roles. The Global Administrator is a role that enables users to have access to all administrative features in Azure AD and services that use Azure AD identities like the Microsoft 365 Defender portal, the Microsoft 365 compliance center, Exchange, SharePoint Online, and Skype for Business Online. Attackers can add users as Global Administrators to maintain access and manage all subscriptions and their settings and resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1500s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#global-administrator"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "o365.audit.ModifiedProperties.Role_DisplayName.NewValue",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "794f0d3a-bfaf-46da-a657-4d0fab6ef6f9",
        "rule_id": "88671231-6626-4e1b-abb7-6e361a171fbb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.298Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.769Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.code:\"AzureActiveDirectory\" and event.action:\"Add member to role.\" and\no365.audit.ModifiedProperties.Role_DisplayName.NewValue:\"Global Administrator\"",
        "language": "kuery"
      },
      {
        "name": "Ransomware - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected ransomware. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c1f0df81-d68c-41b2-81a1-624e538df264",
        "rule_id": "8cb4f625-7743-4dfb-ae1b-ad92be9df7bd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.299Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.775Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event)",
        "language": "kuery"
      },
      {
        "name": "A scheduled task was created",
        "description": "Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "dcfd0a5a-5697-43fd-9df3-0cbf6166debd",
        "rule_id": "92a6faf5-78ec-4e25-bea1-73bacc9b59d9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.301Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.658Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-created\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and\n\n /* TaskContent is not parsed, exclude by full taskname noisy ones */\n not winlog.event_data.TaskName : (\n              \"\\\\CreateExplorerShellUnelevatedTask\",\n              \"\\\\Hewlett-Packard\\\\HPDeviceCheck\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker_backup\",\n              \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n              \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\",\n              \"\\\\OneDrive Standalone Update Task-S-1-5-21*\",\n              \"\\\\OneDrive Standalone Update Task-S-1-12-1-*\"\n )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Google Workspace Admin Role Deletion",
        "description": "Detects when a custom admin role is deleted. An adversary may delete a custom admin role in order to impact the permissions or capabilities of system administrators.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Admin Role Deletion\n\nGoogle Workspace roles allow administrators to assign specific permissions to users or groups where the principle of least privilege (PoLP) is recommended. Admin roles in Google Workspace grant users access to the Google Admin console, where further domain-wide settings are accessible. Google Workspace contains prebuilt administrator roles for performing business functions related to users, groups, and services. Custom administrator roles can be created where prebuilt roles are not preferred.\n\nDeleted administrator roles may render some user accounts inaccessible or cause operational failure where these roles are relied upon to perform daily administrative tasks. The deletion of roles may also hinder the response and remediation actions of administrators responding to security-related alerts and events. Without specific roles assigned, users will inherit the permissions and privileges of the root organizational unit.\n\nThis rule identifies when a Google Workspace administrative role is deleted within the Google Admin console.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- Identify the role deleted by reviewing `google_workspace.admin.role.name` in the alert.\n- With the user identified, verify if he has administrative privileges to disable or delete administrative roles.\n- To identify other users affected by this role removed, search for `event.action: ASSIGN_ROLE`.\n    - Add `google_workspace.admin.role.name` with the role deleted as an additional filter.\n    - Adjust the relative time accordingly to identify all users that were assigned this admin role.\n\n### False positive analysis\n\n- After identifying the user account that disabled the admin role, verify the action was intentional.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Discuss with the user the affected users as a result of this action to mitigate operational discrepencies.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Tactic: Impact",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Google Workspace admin roles may be deleted by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/2406043?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e70abbab-0fee-4761-8cdc-e168246899c6",
        "rule_id": "93e63c3e-4154-4fc6-9f86-b411e0987bbf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.303Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.678Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:DELETE_ROLE",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Custom Gmail Route Created or Modified",
        "description": "Detects when a custom Gmail route is added or modified in Google Workspace. Adversaries can add a custom e-mail route for outbound mail to route these e-mails to their own inbox of choice for data gathering. This allows adversaries to capture sensitive information from e-mail and potential attachments, such as invoices or payment documents. By default, all email from current Google Workspace users with accounts are routed through a domain's mail server for inbound and outbound mail.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Custom Gmail Route Created or Modified\n\nGmail is a popular cloud-based email service developed and managed by Google. Gmail is one of many services available for users with Google Workspace accounts.\n\nThreat actors often send phishing emails containing malicious URL links or attachments to corporate Gmail accounts. Google Workspace identity relies on the corporate user Gmail account and if stolen, allows threat actors to further their intrusion efforts from valid user accounts.\n\nThis rule identifies the creation of a custom global Gmail route by an administrator from the Google Workspace admin console. Custom email routes could indicate an attempt to secretly forward sensitive emails to unintentional recipients.\n\n#### Possible investigation steps\n\n- Identify the user account that created the custom email route and verify that they should have administrative privileges.\n- Review the added recipients from the custom email route and confidentiality of potential email contents.\n- Identify the user account, then review `event.action` values for related activity within the last 48 hours.\n- If the Google Workspace license is Enterprise Plus or Education Plus, search for emails matching the route filters. To find the Gmail event logs, go to `Reporting > Audit and investigation > Gmail log events`.\n- If existing emails have been sent and match the custom route criteria, review the sender and contents for malicious URL links and attachments.\n- Identified URLs or attachments can be submitted to VirusTotal for reputational services.\n\n### False positive analysis\n\n- This rule searches for domain-wide custom email routes created in the admin console of Google Workspace. Administrators might create custom email routes to fulfill organizational requirements.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Tactic: Collection",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may create custom email routes in Google Workspace based on organizational policies, administrative preference or for security purposes regarding spam."
        ],
        "references": [
          "https://support.google.com/a/answer/2685650?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.003",
                    "name": "Email Forwarding Rule",
                    "reference": "https://attack.mitre.org/techniques/T1114/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.setting.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.event.type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "32632669-7252-4dd3-b80d-dca0fd43a4bc",
        "rule_id": "9510add4-3392-11ed-bd01-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.305Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.696Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.action:(\"CREATE_GMAIL_SETTING\" or \"CHANGE_GMAIL_SETTING\")\n  and google_workspace.event.type:\"EMAIL_SETTINGS\" and google_workspace.admin.setting.name:(\"EMAIL_ROUTE\" or \"MESSAGE_SECURITY_RULE\")",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Exchange Anti-Phish Rule Modification",
        "description": "Identifies the modification of an anti-phishing rule in Microsoft 365. By default, Microsoft 365 includes built-in features that help protect users from phishing attacks. Anti-phishing rules increase this protection by refining settings to better detect and prevent attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An anti-phishing rule may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-antiphishrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/disable-antiphishrule?view=exchange-ps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7feff3c3-b083-4c86-a6b6-91cca9396504",
        "rule_id": "97314185-2568-4561-ae81-f3e480e5e695",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.306Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.798Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-AntiPhishRule\" or \"Disable-AntiPhishRule\") and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Drive Encryption Key(s) Accessed from Anonymous User",
        "description": "Detects when an external (anonymous) user has viewed, copied or downloaded an encryption key file from a Google Workspace drive. Adversaries may gain access to encryption keys stored in private drives from rogue access links that do not have an expiration. Access to encryption keys may allow adversaries to access sensitive data or authenticate on behalf of users.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A user may generate a shared access link to encryption key files to share with others. It is unlikely that the intended recipient is an external or anonymous user."
        ],
        "references": [
          "https://support.google.com/drive/answer/2494822",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.drive.visibility",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "source.user.email",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "daf76ed0-483d-444b-8280-b8f4a6d9b8e4",
        "rule_id": "980b70a0-c820-11ed-8799-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.308Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.804Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where event.dataset == \"google_workspace.drive\" and event.action : (\"copy\", \"view\", \"download\") and\n    google_workspace.drive.visibility: \"people_with_link\" and source.user.email == \"\" and\n    file.extension: (\n        \"token\",\"assig\", \"pssc\", \"keystore\", \"pub\", \"pgp.asc\", \"ps1xml\", \"pem\", \"gpg.sig\", \"der\", \"key\",\n        \"p7r\", \"p12\", \"asc\", \"jks\", \"p7b\", \"signature\", \"gpg\", \"pgp.sig\", \"sst\", \"pgp\", \"gpgz\", \"pfx\", \"crt\",\n        \"p8\", \"sig\", \"pkcs7\", \"jceks\", \"pkcs8\", \"psc1\", \"p7c\", \"csr\", \"cer\", \"spc\", \"ps2xml\")",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft 365 Exchange Management Group Role Assignment",
        "description": "Identifies when a new role is assigned to a management group in Microsoft 365. An adversary may attempt to add a role in order to maintain persistence in an environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A new role may be assigned to a management group by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-managementroleassignment?view=exchange-ps",
          "https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "858d1796-420e-47e8-b741-723f7c0cb4da",
        "rule_id": "98995807-5b09-4e37-8a54-5cae5dc932d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.310Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.810Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"New-ManagementRoleAssignment\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Process Injection - Prevented - Elastic Endgame",
        "description": "Elastic Endgame prevented Process Injection. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2f0d9cd8-cda5-4a40-8181-033d9623e178",
        "rule_id": "990838aa-a953-4f3e-b3cb-6ddf7584de9e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.312Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.814Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:kernel_shellcode_event or endgame.event_subtype_full:kernel_shellcode_event)",
        "language": "kuery"
      },
      {
        "name": "Remote Scheduled Task Creation via RPC",
        "description": "Identifies scheduled task creation from a remote source. This could be indicative of adversary lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Scheduled Task Creation\n\n[Scheduled tasks](https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler) are a great mechanism for persistence and program execution. These features can be used remotely for a variety of legitimate reasons, but at the same time used by malware and adversaries. When investigating scheduled tasks that were set up remotely, one of the first steps should be to determine the original intent behind the configuration and to verify if the activity is tied to benign behavior such as software installation or any kind of network administrator work. One objective for these alerts is to understand the configured action within the scheduled task. This is captured within the registry event data for this rule and can be base64 decoded to view the value.\n\n#### Possible investigation steps\n\n- Review the TaskContent value to investigate the task configured action.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Further examination should include review of host-based artifacts and network logs from around when the scheduled task was created, on both the source and target machines.\n\n### False positive analysis\n\n- There is a high possibility of benign activity tied to the creation of remote scheduled tasks as it is a general feature within Windows and used for legitimate purposes for a wide range of activity. Any kind of context should be found to further understand the source of the activity and determine the intent based on the scheduled task's contents.\n\n### Related rules\n\n- Service Command Lateral Movement - d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc\n- Remotely Started Services via RPC - aa9a274d-6b53-424d-ac5e-cb8ca4251650\n- Remote Scheduled Task Creation - 954ee7c8-5437-49ae-b2d6-2960883898e9\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove scheduled task and any other related artifacts.\n- Review privileged account management and user account management settings. Consider implementing group policy object (GPO) policies to further restrict activity, or configuring settings that only allow administrators to create remote scheduled tasks.\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ClientProcessId",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.RpcCallClientLocality",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "2175b6ca-1057-4aa1-b525-562a4436d025",
        "rule_id": "9c865691-5599-447a-bac9-b3f2df5f9a9d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.313Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.750Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-created\" and \n winlog.event_data.RpcCallClientLocality : \"0\" and winlog.event_data.ClientProcessId : \"0\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Ransomware - Prevented - Elastic Endgame",
        "description": "Elastic Endgame prevented ransomware. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a8dca312-4a0f-4939-8817-d342dba9d790",
        "rule_id": "e3c5d5cb-41d5-4206-805c-f30561eae3ac",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.315Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.855Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event)",
        "language": "kuery"
      },
      {
        "name": "Service Creation via Local Kerberos Authentication",
        "description": "Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to localhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberos relay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/Dec0ne/KrbRelayUp",
          "https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html",
          "https://github.com/cube0x0/KrbRelay",
          "https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AuthenticationPackageName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "fbdf5fd2-f805-43f4-8ffd-6951e094bf8b",
        "rule_id": "e4e31051-ee01-4307-a6ee-b21b186958f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.317Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.657Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name with maxspan=5m\n [authentication where\n\n  /* event 4624 need to be logged */\n  event.action == \"logged-in\" and event.outcome == \"success\" and\n\n  /* authenticate locally using relayed kerberos Ticket */\n  winlog.event_data.AuthenticationPackageName :\"Kerberos\" and winlog.logon.type == \"Network\" and\n  cidrmatch(source.ip, \"127.0.0.0/8\", \"::1\") and source.port > 0] by winlog.event_data.TargetLogonId\n\n  [any where\n   /* event 4697 need to be logged */\n   event.action : \"service-installed\"] by winlog.event_data.SubjectLogonId",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "MFA Disabled for Google Workspace Organization",
        "description": "Detects when multi-factor authentication (MFA) is disabled for a Google Workspace organization. An adversary may attempt to modify a password policy in order to weaken an organizations security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating MFA Disabled for Google Workspace Organization\n\nMulti-factor authentication (MFA) is a process in which users are prompted for an additional form of identification, such as a code on their cell phone or a fingerprint scan, during the sign-in process.\n\nIf you only use a password to authenticate a user, it leaves an insecure vector for attack. If the users's password is weak or has been exposed elsewhere, an attacker could use it to gain access. Requiring a second form of authentication increases security because attackers cannot easily obtain or duplicate the additional authentication factor.\n\nFor more information about using MFA in Google Workspace, access the [official documentation](https://support.google.com/a/answer/175197).\n\nThis rule identifies when MFA enforcement is turned off in Google Workspace. This modification weakens account security and can lead to accounts and other assets being compromised.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity can be done by administrators, all users must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the user and domain.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate the multi-factor authentication enforcement.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "MFA settings may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/7061566",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.new_value",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "58794f71-8e91-45d0-8b30-506dc6cb420d",
        "rule_id": "e555105c-ba6d-481f-82bb-9b633e7b4827",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.319Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.660Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(ENFORCE_STRONG_AUTHENTICATION or ALLOW_STRONG_AUTHENTICATION) and google_workspace.admin.new_value:false",
        "language": "kuery"
      },
      {
        "name": "External Alerts",
        "description": "Generates a detection alert for each external alert written to the configured indices. Enabling this rule allows you to immediately begin investigating external alerts in the app.",
        "risk_score": 47,
        "severity": "medium",
        "rule_name_override": "message",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "OS: Windows",
          "Data Source: APM",
          "OS: macOS",
          "OS: Linux"
        ],
        "enabled": false,
        "risk_score_mapping": [
          {
            "field": "event.risk_score",
            "operator": "equals",
            "value": ""
          }
        ],
        "severity_mapping": [
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "low",
            "value": "21"
          },
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "medium",
            "value": "47"
          },
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "high",
            "value": "73"
          },
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "critical",
            "value": "99"
          }
        ],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6128b8b8-66b4-4174-a7e2-1228f2cc5964",
        "rule_id": "eb079c62-4481-4d6e-9643-3ca499df7aaa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.320Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.872Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "apm-*-transaction*",
          "traces-apm*",
          "auditbeat-*",
          "filebeat-*",
          "logs-*",
          "packetbeat-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "query": "event.kind:alert and not event.module:(endgame or endpoint or cloud_defend)",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Inbox Forwarding Rule Created",
        "description": "Identifies when a new Inbox forwarding rule is created in Microsoft 365. Inbox rules process messages in the Inbox based on conditions and take actions. In this case, the rules will forward the emails to a defined address. Attackers can abuse Inbox Rules to intercept and exfiltrate email data without making organization-wide configuration changes or having the corresponding privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Collection"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Gary Blackwell",
          "Austin Songer"
        ],
        "false_positives": [
          "Users and Administrators can create inbox rules for legitimate purposes. Verify if it complies with the company policy and done with the user's consent. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/responding-to-a-compromised-email-account?view=o365-worldwide",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-inboxrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-outlook-rules-forms-attack?view=o365-worldwide",
          "https://raw.githubusercontent.com/PwC-IR/Business-Email-Compromise-Guide/main/Extractor%20Cheat%20Sheet.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.003",
                    "name": "Email Forwarding Rule",
                    "reference": "https://attack.mitre.org/techniques/T1114/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "o365.audit.Parameters.ForwardAsAttachmentTo",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "o365.audit.Parameters.ForwardTo",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "o365.audit.Parameters.RedirectTo",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "44c3325a-563e-4b1e-9d76-e278e0fbfc43",
        "rule_id": "ec8efb0c-604d-42fa-ac46-ed1cfbc38f78",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.325Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.881Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and\nevent.category:web and event.action:(\"New-InboxRule\" or \"Set-InboxRule\") and\n    (\n        o365.audit.Parameters.ForwardTo:* or\n        o365.audit.Parameters.ForwardAsAttachmentTo:* or\n        o365.audit.Parameters.RedirectTo:*\n    )\n    and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Forwarded Google Workspace Security Alert",
        "description": "Identifies the occurrence of a security alert from the Google Workspace alerts center. Google Workspace's security alert center provides an overview of actionable alerts that may be affecting an organization's domain. An alert is a warning of a potential security issue that Google has detected.",
        "risk_score": 73,
        "severity": "high",
        "rule_name_override": "google_workspace.alert.type",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThis is a promotion rule for Google Workspace security events, which are alertable events per the vendor.\nConsult vendor documentation on interpreting specific events.",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Log Auditing",
          "Use Case: Threat Detection"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [
          {
            "field": "google_workspace.alert.metadata.severity",
            "operator": "equals",
            "severity": "low",
            "value": "LOW"
          },
          {
            "field": "google_workspace.alert.metadata.severity",
            "operator": "equals",
            "severity": "medium",
            "value": "MEDIUM"
          },
          {
            "field": "google_workspace.alert.metadata.severity",
            "operator": "equals",
            "severity": "high",
            "value": "HIGH"
          }
        ],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "To tune this rule, add exceptions to exclude any google_workspace.alert.type which should not trigger this rule.",
          "For additional tuning, severity exceptions for google_workspace.alert.metadata.severity can be added."
        ],
        "references": [
          "https://workspace.google.com/products/admin/alert-center/",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "28aee6a2-be92-4e74-b7e9-8cc3d94bdefa",
        "rule_id": "f1a6d0f4-95b8-11ed-9517-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.327Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.890Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset: google_workspace.alert",
        "language": "kuery"
      },
      {
        "name": "Google Workspace Object Copied to External Drive with App Consent",
        "description": "Detects when a user copies a Google spreadsheet, form, document or script from an external drive. Sequence logic has been added to also detect when a user grants a custom Google application permission via OAuth shortly after. An adversary may send a phishing email to the victim with a Drive object link where \"copy\" is included in the URI, thus copying the object to the victim's drive. If a container-bound script exists within the object, execution will require permission access via OAuth in which the user has to accept.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Object Copied to External Drive with App Consent\n\nGoogle Workspace users can share access to Drive objects such as documents, sheets, and forms via email delivery or a shared link. Shared link URIs have parameters like `view` or `edit` to indicate the recipient's permissions. The `copy` parameter allows the recipient to copy the object to their own Drive, which grants the object with the same privileges as the recipient. Specific objects in Google Drive allow container-bound scripts that run on Google's Apps Script platform. Container-bound scripts can contain malicious code that executes with the recipient's privileges if in their Drive.\n\nThis rule aims to detect when a user copies an external Drive object to their Drive storage and then grants permissions to a custom application via OAuth prompt.\n\n#### Possible investigation steps\n- Identify user account(s) associated by reviewing `user.name` or `source.user.email` in the alert.\n- Identify the name of the file copied by reviewing `file.name` as well as the `file.id` for triaging.\n- Identify the file type by reviewing `google_workspace.drive.file.type`.\n- With the information gathered so far, query across data for the file metadata to determine if this activity is isolated or widespread.\n- Within the OAuth token event, identify the application name by reviewing `google_workspace.token.app_name`.\n    - Review the application ID as well from `google_workspace.token.client.id`.\n    - This metadata can be used to report the malicious application to Google for permanent blacklisting.\n- Identify the permissions granted to the application by the user by reviewing `google_workspace.token.scope.data.scope_name`.\n    - This information will help pivot and triage into what services may have been affected.\n- If a container-bound script was attached to the copied object, it will also exist in the user's drive.\n    - This object should be removed from all users affected and investigated for a better understanding of the malicious code.\n\n### False positive analysis\n- Communicate with the affected user to identify if these actions were intentional\n- If a container-bound script exists, review code to identify if it is benign or malicious\n\n### Response and remediation\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n    - Resetting passwords will revoke OAuth tokens which could have been stolen.\n- Reactivate multi-factor authentication for the user.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security defaults [provided by Google](https://cloud.google.com/security-command-center/docs/how-to-investigate-threats).\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n## Setup\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Tactic: Initial Access",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Google Workspace users typically share Drive resources with a shareable link where parameters are edited to indicate when it is viewable or editable by the intended recipient. It is uncommon for a user in an organization to manually copy a Drive object from an external drive to their corporate drive. This may happen where users find a useful spreadsheet in a public drive, for example, and replicate it to their Drive. It is uncommon for the copied object to execute a container-bound script either unless the user was intentionally aware, suggesting the object uses container-bound scripts to accomplish a legitimate task."
        ],
        "references": [
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two",
          "https://developers.google.com/apps-script/guides/bound",
          "https://support.google.com/a/users/answer/13004165#share_make_a_copy_links"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.drive.copy_type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "google_workspace.drive.file.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.drive.owner_is_team_drive",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "google_workspace.token.client.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "source.user.email",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "68920960-9b91-4e7a-820c-9d211302056c",
        "rule_id": "f33e68a4-bd19-11ed-b02f-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.329Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.699Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by source.user.email with maxspan=3m\n[file where event.dataset == \"google_workspace.drive\" and event.action == \"copy\" and\n\n    /* Should only match if the object lives in a Drive that is external to the user's GWS organization */\n    google_workspace.drive.owner_is_team_drive == \"false\" and google_workspace.drive.copy_type == \"external\" and\n\n    /* Google Script, Forms, Sheets and Document can have container-bound scripts */\n    google_workspace.drive.file.type: (\"script\", \"form\", \"spreadsheet\", \"document\")]\n\n[any where event.dataset == \"google_workspace.token\" and event.action == \"authorize\" and\n\n    /* Ensures application ID references custom app in Google Workspace and not GCP */\n    google_workspace.token.client.id : \"*apps.googleusercontent.com\"]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": []
      },
      {
        "name": "SSH Authorized Keys File Modified Inside a Container",
        "description": "This rule detects the creation or modification of an authorized_keys or sshd_config file inside a container. The Secure Shell (SSH) authorized_keys file specifies which users are allowed to log into a server using public key authentication. Adversaries may modify it to maintain persistence on a victim host by adding their own public key(s). Unexpected and unauthorized SSH usage inside a container can be an indicator of compromise and should be investigated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Data Source: Elastic Defend for Containers",
          "Domain: Container",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.004",
                    "name": "SSH Authorized Keys",
                    "reference": "https://attack.mitre.org/techniques/T1098/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "cloud_defend",
            "version": "^1.0.5"
          }
        ],
        "required_fields": [
          {
            "name": "container.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a2395cab-4201-4605-a0c2-5f578a4cde38",
        "rule_id": "f7769104-e8f9-4931-94a2-68fc04eadec3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.331Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.923Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where container.id:\"*\" and\n  event.type in (\"change\", \"creation\") and file.name: (\"authorized_keys\", \"authorized_keys2\", \"sshd_config\")",
        "language": "eql",
        "index": [
          "logs-cloud_defend*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft 365 Exchange Transport Rule Creation",
        "description": "Identifies a transport rule creation in Microsoft 365. As a best practice, Exchange Online mail transport rules should not be set to forward email to domains outside of your organization. An adversary may create transport rules to exfiltrate data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A new transport rule may be created by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-transportrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1537",
                "name": "Transfer Data to Cloud Account",
                "reference": "https://attack.mitre.org/techniques/T1537/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "064a9ac4-e033-4db0-a86d-d119aa350859",
        "rule_id": "ff4dd44a-0ac6-44c4-8609-3f81bc820f02",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.332Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.820Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"New-TransportRule\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Sudoers File Modification",
        "description": "A sudoers file specifies the commands that users or groups can run and from which terminals. Adversaries can take advantage of these configurations to execute commands as other users or spawn processes with higher privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1707cfcf-9678-4696-a731-19a2145e911e",
        "rule_id": "931e25a5-0f5e-4ae0-ba0d-9e94eff7e3a4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.334Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.521Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:file and event.type:change and file.path:(/etc/sudoers* or /private/etc/sudoers*) and\nnot process.name:(dpkg or platform-python or puppet or yum or dnf) and \nnot process.executable:(/opt/chef/embedded/bin/ruby or /opt/puppetlabs/puppet/bin/ruby or /usr/bin/dockerd)",
        "new_terms_fields": [
          "host.id",
          "process.executable",
          "file.path"
        ],
        "history_window_start": "now-7d",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS VPC Flow Logs Deletion",
        "description": "Identifies the deletion of one or more flow logs in AWS Elastic Compute Cloud (EC2). An adversary may delete flow logs in an attempt to evade defenses.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS VPC Flow Logs Deletion\n\nVPC Flow Logs is an AWS feature that enables you to capture information about the IP traffic going to and from network interfaces in your virtual private cloud (VPC). Flow log data can be published to Amazon CloudWatch Logs or Amazon S3.\n\nThis rule identifies the deletion of VPC flow logs using the API `DeleteFlowLogs` action. Attackers can do this to cover their tracks and impact security monitoring that relies on this source.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n- Administrators may rotate these logs after a certain period as part of their retention policy or after importing them to a SIEM.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Flow log deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/delete-flow-logs.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteFlowLogs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "44aa7396-acee-4e76-ae69-9b37b0755a21",
        "rule_id": "9395fd2c-9947-4472-86ef-4aceb2f7e872",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.336Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.524Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:DeleteFlowLogs and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Attempt to Create Okta API Token",
        "description": "Detects attempts to create an Okta API token. An adversary may create an Okta API token to maintain access to an organization's network while they work to achieve their objectives. An attacker may abuse an API token to execute techniques such as creating user accounts or disabling security rules or policies.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of creating Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f06c2c67-100d-477a-8b2a-5dfe5ea59d62",
        "rule_id": "96b9f4ea-0e8c-435b-8d53-2096e75fcac5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.338Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.531Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.create",
        "language": "kuery"
      },
      {
        "name": "Machine Learning Detected a Suspicious Windows Event with a High Malicious Probability Score",
        "description": "A supervised machine learning model (ProblemChild) has identified a suspicious Windows process event with high probability of it being malicious activity. Alternatively, the model's blocklist identified the event as being malicious.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.004",
                    "name": "Masquerade Task or Service",
                    "reference": "https://attack.mitre.org/techniques/T1036/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Configure the ingest pipeline**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "blocklist_label",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "problemchild.prediction",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "problemchild.prediction_probability",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b14f08ca-cddf-42d5-bac8-3ba8f89e6b22",
        "rule_id": "994e40aa-8c85-43de-825e-15f665375ee8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.480Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.932Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where ((problemchild.prediction == 1 and problemchild.prediction_probability > 0.98) or\nblocklist_label == 1) and not process.args : (\"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.txt*\", \"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.tmp*\")",
        "language": "eql",
        "index": [
          "endgame-*",
          "logs-endpoint.events.process-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potentially Successful MFA Bombing via Push Notifications",
        "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Abuse of Repeated MFA Push Notifications\n\nMulti-Factor Authentication (MFA) is an effective method to prevent unauthorized access. However, some adversaries may abuse the system by repeatedly sending MFA push notifications until the user unwittingly approves the access.\n\nThis rule detects when a user denies MFA Okta Verify push notifications twice, followed by a successful authentication event within a 10-minute window. This sequence could indicate an adversary's attempt to bypass the Okta MFA policy.\n\n#### Possible investigation steps:\n\n- Identify the user who received the MFA notifications by reviewing the `user.email` field.\n- Identify the time, source IP, and geographical location of the MFA requests and the subsequent successful login.\n- Review the `event.action` field to understand the nature of the events. It should include two `user.mfa.okta_verify.deny_push` actions and one `user.authentication.sso` action.\n- Ask the user if they remember receiving the MFA notifications and subsequently logging into their account.\n- Check if the MFA requests and the successful login occurred during the user's regular activity hours.\n- Look for any other suspicious activity on the account around the same time.\n- Identify whether the same pattern is repeated for other users in your organization. Multiple users receiving push notifications simultaneously might indicate a larger attack.\n\n### False positive analysis:\n\n- Determine if the MFA push notifications were legitimate. Sometimes, users accidentally trigger MFA requests or deny them unintentionally and later approve them.\n- Check if there are known issues with the MFA system causing false denials.\n\n### Response and remediation:\n\n- If unauthorized access is confirmed, initiate your incident response process.\n- Alert the user and your IT department immediately.\n- If possible, isolate the user's account until the issue is resolved.\n- Investigate the source of the unauthorized access.\n- If the account was accessed by an unauthorized party, determine the actions they took after logging in.\n- Consider enhancing your MFA policy to prevent such incidents in the future.\n- Encourage users to report any unexpected MFA notifications immediately.\n- Review and update your incident response plans and security policies based on the findings from the incident.",
        "output_index": "",
        "version": 413,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/russian-targeting-gov-business",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1621",
                "name": "Multi-Factor Authentication Request Generation",
                "reference": "https://attack.mitre.org/techniques/T1621/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "310f57ca-cb74-4043-b77b-ec32e5322e73",
        "rule_id": "97a8e584-fd3b-421f-9b9d-9c9d9e57e9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.483Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.238Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and event.action == \"user.mfa.okta_verify.deny_push\"] with runs=3\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and (event.action : (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "event_category_override": "event.category"
      },
      {
        "name": "AWS IAM SAML Provider Updated",
        "description": "Identifies when a user has updated a SAML provider in AWS. SAML providers are used to enable federated access to the AWS Management Console. This activity could be an indication of an attacker attempting to escalate privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "SAML Provider could be updated by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. SAML Provider updates by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateSAMLProvider.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.002",
                    "name": "Trust Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2caa840e-5a60-4a5c-bc6c-9ef0558762e0",
        "rule_id": "979729e7-0c52-4c4c-b71e-88103304a79f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.485Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.537Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail\n    and event.provider: iam.amazonaws.com\n    and event.action: UpdateSAMLProvider\n    and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS EC2 Snapshot Activity",
        "description": "An attempt was made to modify AWS EC2 snapshot attributes. Snapshots are sometimes shared by threat actors in order to exfiltrate bulk data from an EC2 fleet. If the permissions were modified, verify the snapshot was not shared with an unauthorized or unexpected AWS account.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS EC2 Snapshot Activity\n\nAmazon EC2 snapshots are a mechanism to create point-in-time references to data that reside in storage volumes. System administrators commonly use this for backup operations and data recovery.\n\nThis rule looks for the modification of snapshot attributes using the API `ModifySnapshotAttribute` action. This can be used to share snapshots with unauthorized third parties, giving others access to all the data on the snapshot.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Search for dry run attempts against the resource ID of the snapshot from other user accounts within CloudTrail.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Check if the shared permissions of the snapshot were modified to `Public` or include unknown account IDs.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Asset Visibility",
          "Tactic: Exfiltration",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "IAM users may occasionally share EC2 snapshots with another AWS account belonging to the same organization. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/modify-snapshot-attribute.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_ModifySnapshotAttribute.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1537",
                "name": "Transfer Data to Cloud Account",
                "reference": "https://attack.mitre.org/techniques/T1537/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2c7b2321-67ca-46b9-a875-5a21b831ce87",
        "rule_id": "98fd7407-0bd5-5817-cda0-3fcc33113a56",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.487Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.595Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:ModifySnapshotAttribute",
        "language": "kuery"
      },
      {
        "name": "Unsigned BITS Service Client Process",
        "description": "Identifies an unsigned Windows Background Intelligent Transfer Service (BITS) client process. Attackers may abuse BITS functionality to download or upload data using the BITS service.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://web.archive.org/web/20230531215706/https://blog.menasec.net/2021/05/hunting-for-suspicious-usage-of.html",
          "https://www.elastic.co/blog/hunting-for-persistence-using-elastic-security-part-2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              },
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7ee0e4aa-b358-477d-affd-19e91e8de211",
        "rule_id": "9a3884d0-282d-45ea-86ce-b9c81100f026",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.478Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.935Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where dll.name : \"Bitsproxy.dll\" and process.executable != null and\nnot process.code_signature.trusted == true and\nnot process.code_signature.status : (\"errorExpired\", \"errorCode_endpoint*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Zoom Child Process",
        "description": "A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details such as command line, network connections, file writes and associated file signature details as well.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Zoom Child Process\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading, and deserve further investigation.\n\nThis rule identifies a potential malicious process masquerading as `Zoom.exe` or exploiting a vulnerability in the application causing it to execute code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line of the child process to determine which commands or scripts were executed.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4f36ef97-85ff-4001-8d5f-936392c37d5e",
        "rule_id": "97aba1ef-6034-4bd3-8c1a-1e0996b27afa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:02.489Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.285Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Reset MFA Factors for an Okta User Account",
        "description": "Detects attempts to reset an Okta user's enrolled multi-factor authentication (MFA) factors. An adversary may attempt to reset the MFA factors for an Okta user's account in order to register new MFA factors and abuse the account to blend in with normal activity in the victim's environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if the MFA factors for Okta user accounts are regularly reset in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b447923e-f165-4d53-aeee-ff8a1295af57",
        "rule_id": "729aa18d-06a6-41c7-b175-b65b739b1181",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.345Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.459Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.mfa.factor.reset_all",
        "language": "kuery"
      },
      {
        "name": "Endpoint Security",
        "description": "Generates a detection alert each time an Elastic Endpoint Security alert is received. Enabling this rule allows you to immediately begin investigating your Endpoint alerts.",
        "risk_score": 47,
        "severity": "medium",
        "rule_name_override": "message",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Defend"
        ],
        "enabled": true,
        "risk_score_mapping": [
          {
            "field": "event.risk_score",
            "operator": "equals",
            "value": ""
          }
        ],
        "severity_mapping": [
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "low",
            "value": "21"
          },
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "medium",
            "value": "47"
          },
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "high",
            "value": "73"
          },
          {
            "field": "event.severity",
            "operator": "equals",
            "severity": "critical",
            "value": "99"
          }
        ],
        "interval": "5m",
        "from": "now-600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [
          {
            "id": "endpoint_list",
            "list_id": "endpoint_list",
            "type": "endpoint",
            "namespace_type": "agnostic"
          }
        ],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c77d8480-451e-48de-835f-3f3145e536ad",
        "rule_id": "9a1a2dae-0b5f-4c3d-8305-a268d404c306",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:03.104Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.900Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.alerts-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:(endpoint and not endgame)",
        "language": "kuery"
      },
      {
        "name": "Suspicious Execution via MSIEXEC",
        "description": "Identifies suspicious execution of the built-in Windows Installer, msiexec.exe, to install a package from usual paths or parent process. Adversaries may abuse msiexec.exe to launch malicious local MSI files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Msiexec/",
          "https://www.guardicore.com/labs/purple-fox-rootkit-now-propagates-as-a-worm/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.007",
                    "name": "Msiexec",
                    "reference": "https://attack.mitre.org/techniques/T1218/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "432cf306-91f8-4c12-b967-efcd1d74089e",
        "rule_id": "708c9d92-22a3-4fe0-b6b9-1f861c55502d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.347Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.891Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.name : \"msiexec.exe\" and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and process.parent.executable != null and\n  (\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     process.args : (\"?:\\\\Users\\\\*\", \"?:\\\\ProgramData\\\\*\") and\n     not process.parent.executable : (\"?:\\\\Program Files (x86)\\\\*.exe\",\n                                      \"?:\\\\Program Files\\\\*.exe\",\n                                      \"?:\\\\Windows\\\\explorer.exe\",\n                                      \"?:\\\\Users\\\\*\\\\Desktop\\\\*\",\n                                      \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n                                      \"?:\\\\programdata\\\\*\")) or\n\n    (process.args_count == 1 and not process.parent.executable : (\"?:\\\\Windows\\\\explorer.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\explorer.exe\")) or\n\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     (process.parent.args : \"Schedule\" or process.parent.name : \"wmiprvse.exe\" or\n     process.parent.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\*\" or\n     (process.parent.name : (\"powershell.exe\", \"cmd.exe\") and length(process.parent.command_line) >= 200))) or\n\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     ?process.working_directory : \"?:\\\\\" and process.parent.name : (\"cmd.exe\", \"powershell.exe\"))\n  ) and\n\n  /* noisy pattern */\n  not (process.parent.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\" and ?process.parent.args_count >= 2 and\n       process.args : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\*.msi\") and\n\n  not process.args : (\"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Program Files\\\\*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS Config Resource Deletion",
        "description": "Identifies attempts to delete an AWS Config Service resource. An adversary may tamper with Config services in order to reduce visibility into the security posture of an account and / or its workload instances.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS Config Resource Deletion\n\nAWS Config provides a detailed view of the configuration of AWS resources in your AWS account. This includes how the resources are related to one another and how they were configured in the past so that you can see how the configurations and relationships change over time.\n\nThis rule looks for the deletion of AWS Config resources using various API actions. Attackers can do this to cover their tracks and impact security monitoring that relies on these sources.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify the AWS resource that was involved and its criticality, ownership, and role in the environment. Also investigate if the resource is security-related.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Privileged IAM users with security responsibilities may be expected to make changes to the Config service in order to align with local security policies and requirements. Automation, orchestration, and security tools may also make changes to the Config service, where they are used to automate setup or configuration of AWS accounts. Other kinds of user or service contexts do not commonly make changes to this service."
        ],
        "references": [
          "https://docs.aws.amazon.com/config/latest/developerguide/how-does-config-work.html",
          "https://docs.aws.amazon.com/config/latest/APIReference/API_Operations.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1b450530-a59f-4bb1-82fa-778bdde8873c",
        "rule_id": "7024e2a0-315d-4334-bb1a-552d604f27bc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.349Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.419Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:config.amazonaws.com and\n    event.action:(DeleteConfigRule or DeleteOrganizationConfigRule or DeleteConfigurationAggregator or\n    DeleteConfigurationRecorder or DeleteConformancePack or DeleteOrganizationConformancePack or\n    DeleteDeliveryChannel or DeleteRemediationConfiguration or DeleteRetentionConfiguration)",
        "language": "kuery"
      },
      {
        "name": "AWS CloudTrail Log Deleted",
        "description": "Identifies the deletion of an AWS log trail. An adversary may delete trails in an attempt to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudTrail Log Deleted\n\nAmazon CloudTrail is a service that enables governance, compliance, operational auditing, and risk auditing of your Amazon Web Services account. With CloudTrail, you can log, continuously monitor, and retain account activity related to actions across your Amazon Web Services infrastructure. CloudTrail provides event history of your Amazon Web Services account activity, including actions taken through the Amazon Management Console, Amazon SDKs, command line tools, and other Amazon Web Services services. This event history simplifies security analysis, resource change tracking, and troubleshooting.\n\nThis rule identifies the deletion of an AWS log trail using the API `DeleteTrail` action. Attackers can do this to cover their tracks and impact security monitoring that relies on this source.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log trail's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "source.address",
            "user_agent.original",
            "aws.cloudtrail.flattened.request_parameters.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trail deletions may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_DeleteTrail.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudtrail/delete-trail.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "13968263-3a49-47f9-a24b-d5615aaa7f00",
        "rule_id": "7024e2a0-315d-4334-bb1a-441c593e16ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.351Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.416Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail\n    and event.provider:cloudtrail.amazonaws.com\n    and event.action:DeleteTrail\n    and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Windows Error Manager Masquerading",
        "description": "Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matching command-line and process executable values performing outgoing network connections. This may be indicative of a masquerading attempt to evade suspicious child process behavior detections.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Windows Error Manager Masquerading\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nThis rule identifies a potential malicious process masquerading as `wermgr.exe` or `WerFault.exe`, by looking for a process creation with no arguments followed by a network connection.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legit Application Crash with rare Werfault commandline value"
        ],
        "references": [
          "https://twitter.com/SBousseaden/status/1235533224337641473",
          "https://www.hexacorn.com/blog/2019/09/20/werfault-command-line-switches-v0-1/",
          "https://app.any.run/tasks/26051d84-b68e-4afb-8a9a-76921a271b81/",
          "https://www.elastic.co/security-labs/elastic-security-uncovers-blister-malware-campaign"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c81f3b1d-0589-472d-bac7-8d195b35e760",
        "rule_id": "6ea41894-66c3-4df7-ad6b-2c5074eb3df8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.353Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.453Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan = 5s\n  [process where host.os.type == \"windows\" and event.type:\"start\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and network.protocol != \"dns\" and\n    network.direction : (\"outgoing\", \"egress\") and destination.ip !=\"::1\" and destination.ip !=\"127.0.0.1\"\n  ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "AdminSDHolder Backdoor",
        "description": "Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent backdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their Administrative Privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://adsecurity.org/?p=1906",
          "https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#adminsdholder"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ObjectDN",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "2667ac06-c026-420a-8d21-75f782059256",
        "rule_id": "6e9130a5-9be6-48e5-943a-9628bfc74b18",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.354Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.410Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:5136 and\n  winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*",
        "language": "kuery"
      },
      {
        "name": "Potential Network Share Discovery",
        "description": "Adversaries may look for folders and drives shared on remote systems to identify sources of information to gather as a precursor for collection and identify potential systems of interest for Lateral Movement.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ShareName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "792a778b-a827-46c0-b857-5ce8c6cdc7e4",
        "rule_id": "b2318c71-5959-469a-a3ce-3a0768e63b9c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.356Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.855Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by user.name, source.port, source.ip with maxspan=15s \n [file where event.action == \"network-share-object-access-checked\" and \n  winlog.event_data.ShareName in (\"\\\\\\\\*\\\\ADMIN$\", \"\\\\\\\\*\\\\C$\") and \n  source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::1\" and source.ip != \"::\" and source.ip != \"127.0.0.1\"]\n [file where event.action == \"network-share-object-access-checked\" and \n  winlog.event_data.ShareName in (\"\\\\\\\\*\\\\ADMIN$\", \"\\\\\\\\*\\\\C$\") and \n  source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::1\" and source.ip != \"::\" and source.ip != \"127.0.0.1\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Communication App Child Process",
        "description": "Identifies suspicious child processes of communications apps, which can indicate a potential masquerading as the communication app or the exploitation of a vulnerability on the application causing it to execute code.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  },
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "51acf23f-3868-49c8-9c80-e733e8fb4eef",
        "rule_id": "adbfa3ee-777e-4747-b6b0-7bd645f30880",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.358Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.852Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    /* Slack */\n    (process.parent.name : \"slack.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Zoom\\\\bin*\\\\Zoom.exe\",\n            \"?:\\\\Windows\\\\System32\\\\rundll32.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Windows\\\\System32\\\\notepad.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Slack Technologies, Inc.\",\n            \"Slack Technologies, LLC\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"powershell.exe\" and process.command_line : \"powershell.exe -c Invoke-WebRequest -Uri https://slackb.com/*\") or\n          (process.name : \"cmd.exe\" and process.command_line : \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /d /s /c \\\"%windir%\\\\System32\\\\rundll32.exe User32.dll,SetFocus 0\\\"\")\n        )\n      )\n    ) or\n\n    /* WebEx */\n    (process.parent.name : (\"CiscoCollabHost.exe\", \"WebexHost.exe\") and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Cisco Systems, Inc.\",\n            \"Cisco WebEx LLC\",\n            \"Cisco Systems Inc.\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Teams */\n    (process.parent.name : \"Teams.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\BrowserCore\\\\BrowserCore.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Microsoft Corporation\",\n            \"Microsoft 3rd Party Application Component\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"taskkill.exe\" and process.args : \"Teams.exe\")\n        )\n      )\n    ) or\n\n    /* Discord */\n    (process.parent.name : \"Discord.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Windows\\\\System32\\\\reg.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\reg.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Discord Inc.\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.name : \"cmd.exe\" and \n          (\n            process.command_line : (\n              \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /d /s /c \\\"chcp\\\"\",\n              \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /q /d /s /c \\\"C:\\\\Program^ Files\\\\NVIDIA^ Corporation\\\\NVSMI\\\\nvidia-smi.exe\\\"\"\n            ) or\n            process.args : (\n              \"C:\\\\WINDOWS/System32/nvidia-smi.exe\",\n              \"C:\\\\WINDOWS\\\\System32\\\\nvidia-smi.exe\",\n              \"C:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository/*/nvidia-smi.exe*\"\n            )\n          )\n        )\n      )\n    ) or\n\n    /* WhatsApp */\n    (process.parent.name : \"Whatsapp.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\System32\\\\reg.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\reg.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"WhatsApp LLC\",\n            \"WhatsApp, Inc\",\n            \"24803D75-212C-471A-BC57-9EF86AB91435\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"cmd.exe\" and process.command_line : \"C:\\\\Windows\\\\system32\\\\cmd.exe /d /s /c \\\"C:\\\\Windows\\\\system32\\\\wbem\\\\wmic.exe*\")\n        )\n      )\n    ) or\n\n    /* Zoom */\n    (process.parent.name : \"Zoom.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Zoom Video Communications, Inc.\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Outlook */\n    (process.parent.name : \"outlook.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\system32\\\\wermgr.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\NewOutlookInstall\\\\NewOutlookInstaller.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Zoom\\\\bin\\\\Zoom.exe\",\n            \"?:\\\\Windows\\\\System32\\\\IME\\\\SHARED\\\\IMEWDBLD.EXE\",\n            \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\prevhost.exe\",\n            \"?:\\\\Windows\\\\System32\\\\dwwin.exe\",\n            \"?:\\\\Windows\\\\System32\\\\mspaint.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\mspaint.exe\",\n            \"?:\\\\Windows\\\\System32\\\\notepad.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\notepad.exe\",\n            \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n            \"?:\\\\Windows\\\\explorer.exe\",\n            \"?:\\\\Windows\\\\splwow64.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.name : \"rundll32.exe\" and\n          process.args : \"*hpmsn???.dll,MonitorPrintJobStatus*\"\n        )\n      )\n    ) or\n\n    /* Thunderbird */\n    (process.parent.name : \"thunderbird.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\splwow64.exe\"\n          ) and process.code_signature.trusted == true  \n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Mozilla Corporation\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Managed Code Hosting Process",
        "description": "Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious code execution.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://web.archive.org/web/20230329154538/https://blog.menasec.net/2019/07/interesting-difr-traces-of-net-clr.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "86d5a576-ba79-41ea-b6ee-460a2a87e1d1",
        "rule_id": "acf738b5-b5b2-4acc-bad9-1e18ee234f40",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.360Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.449Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : (\"wscript.exe.log\",\n               \"cscript.exe.log\",\n               \"mshta.exe.log\",\n               \"wmic.exe.log\",\n               \"svchost.exe.log\",\n               \"dllhost.exe.log\",\n               \"cmstp.exe.log\",\n               \"regsvr32.exe.log\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual AWS Command for a User",
        "description": "A machine learning job detected an AWS API command that, while not inherently suspicious or abnormal, is being made by a user context that does not normally use the command. This can be the result of compromised credentials or keys as someone uses a valid account to persist, move laterally, or exfiltrate data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual AWS Command for a User\n\nCloudTrail logging provides visibility on actions taken within an AWS environment. By monitoring these events and understanding what is considered normal behavior within an organization, you can spot suspicious or malicious activity when deviations occur.\n\nThis rule uses a machine learning job to detect an AWS API command that while not inherently suspicious or abnormal, is being made by a user context that does not normally use the command. This can be the result of compromised credentials or keys as someone uses a valid account to persist, move laterally, or exfiltrate data.\n\nDetection alerts from this rule indicate an AWS API command or method call that is rare and unusual for the calling IAM user.\n\n#### Possible investigation steps\n\n- Identify the user account involved and the action performed. Verify whether it should perform this kind of action.\n    - Examine the user identity in the `aws.cloudtrail.user_identity.arn` field and the access key ID in the `aws.cloudtrail.user_identity.access_key_id` field, which can help identify the precise user context.\n    - The user agent details in the `user_agent.original` field may also indicate what kind of a client made the request.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Examine the history of the command. If the command only manifested recently, it might be part of a new automation module or script. If it has a consistent cadence (for example, it appears in small numbers on a weekly or monthly cadence), it might be part of a housekeeping or maintenance process. You can find the command in the `event.action field` field.\n\n### Related Rules\n\n- Unusual City For an AWS Command - 809b70d3-e2c3-455e-af1b-2626a5a1a276\n- Unusual Country For an AWS Command - dca28dee-c999-400f-b640-50a081cc0fd1\n- Rare AWS Error Code - 19de8096-e2b0-4bd8-80c9-34a820813fff\n- Spike in AWS Error Messages - 78d3d8d9-b476-451d-a9e0-7a5addd70670\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "New or unusual user command activity can be due to manual troubleshooting or reconfiguration; changes in cloud automation scripts or workflows; adoption of new services; or changes in the way services are used."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from AWS.\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### AWS Integration Setup\nThe AWS integration allows you to collect logs and metrics from Amazon Web Services (AWS) with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"aws\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for AWS and select the integration to see more details about it.\n- Click Add AWS.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed aws to an existing or a new agent policy, and deploy the agent on your system from which aws log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://www.elastic.co/docs/current/integrations/aws).\n",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "424dc261-db13-4a34-bc2e-5a3cbbca4ed5",
        "rule_id": "ac706eae-d5ec-4b14-b4fd-e8ba8086f0e1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.365Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.356Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "rare_method_for_a_username"
        ]
      },
      {
        "name": "Remote Execution via File Shares",
        "description": "Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movement via network file shares.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Execution via File Shares\n\nAdversaries can use network shares to host tooling to support the compromise of other hosts in the environment. These tools can include discovery utilities, credential dumpers, malware, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Review adjacent login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity can happen legitimately. Consider adding exceptions if it is expected and noisy in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges needed to write to the network share and restrict write access as needed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://web.archive.org/web/20230329172636/https://blog.menasec.net/2020/08/new-trick-to-detect-lateral-movement.html",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "00a56278-e06f-48a8-a975-9e2a819f59ac",
        "rule_id": "ab75c24b-2502-43a0-bf7c-e60e662c811e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.366Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.349Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and \n   process.pid == 4 and (file.extension : \"exe\" or file.Ext.header_bytes : \"4d5a*\")] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    not (\n      /* Veeam related processes */\n      (\n        process.name : (\n          \"VeeamGuestHelper.exe\", \"VeeamGuestIndexer.exe\", \"VeeamAgent.exe\", \"VeeamLogShipper.exe\", \"Veeam.VSS.Sharepoint20??.exe\"\n        ) and process.code_signature.trusted == true and process.code_signature.subject_name : \"Veeam Software Group GmbH\"\n      ) or\n      /* PDQ related processes */\n      (\n        process.name : (\n          \"PDQInventoryScanner.exe\", \"PDQInventoryMonitor.exe\", \"PDQInventory-Scanner-?.exe\",\n          \"PDQInventoryWakeCommand-?.exe\", \"PDQDeployRunner-?.exe\"\n        ) and process.code_signature.trusted == true and process.code_signature.subject_name : \"PDQ.com Corporation\"\n      ) or\n      /* CrowdStrike related processes */\n      (\n        (process.executable : \"?:\\\\Windows\\\\System32\\\\drivers\\\\CrowdStrike\\\\*-WindowsSensor.*.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"CrowdStrike, Inc.\") or\n        (process.executable : \"?:\\\\Windows\\\\System32\\\\drivers\\\\CrowdStrike\\\\*-CsInstallerService.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Windows Hardware Compatibility Publisher\")\n      ) or\n      /* MS related processes */\n      (\n        process.executable == \"System\" or\n        (process.executable : \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Corporation\")\n      ) or\n      /* CyberArk processes */\n      (\n        process.executable : \"?:\\\\Windows\\\\CAInvokerService.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"CyberArk Software Ltd.\"\n      )  or\n      /* Sophos processes */\n      (\n        process.executable : \"?:\\\\ProgramData\\\\Sophos\\\\AutoUpdate\\\\Cache\\\\sophos_autoupdate1.dir\\\\SophosUpdate.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"Sophos Ltd\"\n      ) \n    )\n  ] by host.id, process.executable",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Assume Role Policy Update",
        "description": "Identifies attempts to modify an AWS IAM Assume Role Policy. An adversary may attempt to modify the AssumeRolePolicy of a misconfigured role in order to gain the privileges of that role.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM Assume Role Policy Update\n\nAn IAM role is an IAM identity that you can create in your account that has specific permissions. An IAM role is similar to an IAM user, in that it is an AWS identity with permission policies that determine what the identity can and cannot do in AWS. However, instead of being uniquely associated with one person, a role is intended to be assumable by anyone who needs it. Also, a role does not have standard long-term credentials such as a password or access keys associated with it. Instead, when you assume a role, it provides you with temporary security credentials for your role session.\n\nThe role trust policy is a JSON document in which you define the principals you trust to assume the role. This policy is a required resource-based policy that is attached to a role in IAM. An attacker may attempt to modify this policy by using the `UpdateAssumeRolePolicy` API action to gain the privileges of that role.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions  preferably with a combination of the user agent and user ID conditions  to cover administrator activities and infrastructure as code tooling.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Use AWS [policy versioning](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-versioning.html) to restore the trust policy to the desired state.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Policy updates from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://labs.bishopfox.com/tech-blog/5-privesc-attack-vectors-in-aws"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1504d81d-ed8d-49c4-8c45-afec2748a587",
        "rule_id": "a60326d7-dca7-4fb7-93eb-1ca03a1febbd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.368Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.433Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:UpdateAssumeRolePolicy and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "First Time Seen AWS Secret Value Accessed in Secrets Manager",
        "description": "An adversary with access to a compromised AWS service such as an EC2 instance, Lambda function, or other service may attempt to leverage the compromised service to access secrets in AWS Secrets Manager. This rule looks for the first time a specific user identity has programmatically retrieved a secret value from Secrets Manager using the `GetSecretValue` or `BatchGetSecretValue` actions. This rule assumes that AWS services such as Lambda functions and EC2 instances are setup with IAM role's assigned that have the necessary permissions to access the secrets in Secrets Manager. An adversary with access to a compromised AWS service such as an EC2 instance, Lambda function, or other service would rely on the compromised service's IAM role to access the secrets in Secrets Manager.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Time Seen AWS Secret Value Accessed in Secrets Manager\n\nAWS Secrets Manager is a service that enables the replacement of hardcoded credentials in code, including passwords, with an API call to Secrets Manager to retrieve the secret programmatically.\n\nThis rule looks for the retrieval of credentials using `GetSecretValue` action in Secrets Manager programmatically. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule indicating this is the first time a specific user identity has successfuly retrieved a specific secret value from Secrets Manager within the last 15 days.\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment, and inspect the related policy.\n- Identify the applications that should use this account.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Review IAM permission policies for the user identity and specific secrets accessed.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions  preferably with a combination of user agent and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Secrets Manager",
          "Tactic: Credential Access",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Nick Jones",
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be using GetSecretString API for the specified SecretId. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html",
          "https://detectioninthe.cloud/ttps/credential_access/access_secret_in_secrets_manager/",
          "https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_BatchGetSecretValue.html",
          "https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-services/aws-secrets-manager-enum"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.006",
                    "name": "Cloud Secrets Management Stores",
                    "reference": "https://attack.mitre.org/techniques/T1555/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user_agent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "656d2577-ce26-4380-90f0-761d224198ea",
        "rule_id": "a00681e3-9ed6-447c-ab2c-be648821c622",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.370Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.314Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:aws.cloudtrail and event.provider:secretsmanager.amazonaws.com and\n    event.action: (GetSecretValue or BatchGetSecretValue) and event.outcome:success and\n    not user_agent.name: (\"Chrome\" or \"Firefox\" or \"Safari\" or \"Edge\" or \"Brave\" or \"Opera\")",
        "new_terms_fields": [
          "user.id"
        ],
        "history_window_start": "now-10d",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Credential Access via Trusted Developer Utility",
        "description": "An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows credential management. This technique is sometimes used for credential dumping.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via Trusted Developer Utility\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software.\n\nAdversaries can abuse MSBuild to proxy the execution of malicious code. The inline task capability of MSBuild that was introduced in .NET version 4 allows for C# or Visual Basic code to be inserted into an XML project file. MSBuild will compile and execute the inline task. `MSBuild.exe` is a signed Microsoft binary, and the execution of code using it can bypass application control defenses that are configured to allow `MSBuild.exe` execution.\n\nThis rule looks for the MSBuild process loading `vaultcli.dll` or `SAMLib.DLL`, which indicates the execution of credential access activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify the `.csproj` file location.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1565e5f0-4daf-49fb-a160-94e32271ee37",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.372Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.311Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\")]\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : (\"vaultcli.dll\", \"SAMLib.DLL\") or file.name : (\"vaultcli.dll\", \"SAMLib.DLL\"))]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Network Sweep Detected",
        "description": "This rule identifies a potential network sweep. A network sweep is a method used by attackers to scan a target network, identifying active hosts, open ports, and available services to gather information on vulnerabilities and weaknesses. This reconnaissance helps them plan subsequent attacks and exploit potential entry points for unauthorized access, data theft, or other malicious activities. This rule proposes threshold logic to check for connection attempts from one source host to 10 or more destination hosts on commonly used network services.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Network",
          "Tactic: Discovery",
          "Tactic: Reconnaissance",
          "Use Case: Network Security Monitoring",
          "Data Source: Elastic Defend",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1046",
                "name": "Network Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1046/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0043",
              "name": "Reconnaissance",
              "reference": "https://attack.mitre.org/tactics/TA0043/"
            },
            "technique": [
              {
                "id": "T1595",
                "name": "Active Scanning",
                "reference": "https://attack.mitre.org/techniques/T1595/",
                "subtechnique": [
                  {
                    "id": "T1595.001",
                    "name": "Scanning IP Blocks",
                    "reference": "https://attack.mitre.org/techniques/T1595/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "8a8024ec-cb80-416d-bb2e-78f745db74b0",
        "rule_id": "781f8746-2180-4691-890c-4c96d11ca91d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.420Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.423Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "destination.port : (21 or 22 or 23 or 25 or 139 or 445 or 3389 or 5985 or 5986) and\nsource.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)",
        "threshold": {
          "field": [
            "source.ip"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "destination.ip",
              "value": 100
            }
          ]
        },
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-endpoint.events.network-*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Spike in AWS Error Messages",
        "description": "A machine learning job detected a significant spike in the rate of a particular error in the CloudTrail messages. Spikes in error messages may accompany attempts at privilege escalation, lateral movement, or discovery.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Spike in AWS Error Messages\n\nCloudTrail logging provides visibility on actions taken within an AWS environment. By monitoring these events and understanding what is considered normal behavior within an organization, you can spot suspicious or malicious activity when deviations occur.\n\nThis rule uses a machine learning job to detect a significant spike in the rate of a particular error in the CloudTrail messages. Spikes in error messages may accompany attempts at privilege escalation, lateral movement, or discovery.\n\n#### Possible investigation steps\n\n- Examine the history of the error. If the error only manifested recently, it might be related to recent changes in an automation module or script. You can find the error in the `aws.cloudtrail.error_code field` field.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These may indicate the source of the program or the nature of the task being performed when the error occurred.\n    - Check whether the error is related to unsuccessful attempts to enumerate or access objects, data, or secrets.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Examine the history of the command. If the command only manifested recently, it might be part of a new automation module or script. If it has a consistent cadence (for example, it appears in small numbers on a weekly or monthly cadence), it might be part of a housekeeping or maintenance process. You can find the command in the `event.action field` field.\n- The adoption of new services or the addition of new functionality to scripts may generate false positives.\n\n### Related Rules\n\n- Unusual City For an AWS Command - 809b70d3-e2c3-455e-af1b-2626a5a1a276\n- Unusual Country For an AWS Command - dca28dee-c999-400f-b640-50a081cc0fd1\n- Unusual AWS Command for a User - ac706eae-d5ec-4b14-b4fd-e8ba8086f0e1\n- Rare AWS Error Code - 19de8096-e2b0-4bd8-80c9-34a820813fff\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Spikes in error message activity can also be due to bugs in cloud automation scripts or workflows; changes to cloud automation scripts or workflows; adoption of new services; changes in the way services are used; or changes to IAM privileges."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from AWS.\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### AWS Integration Setup\nThe AWS integration allows you to collect logs and metrics from Amazon Web Services (AWS) with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"aws\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for AWS and select the integration to see more details about it.\n- Click Add AWS.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed aws to an existing or a new agent policy, and deploy the agent on your system from which aws log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://www.elastic.co/docs/current/integrations/aws).\n",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "0dedca2f-2c98-4a0f-9cb3-c105c26c9b18",
        "rule_id": "78d3d8d9-b476-451d-a9e0-7a5addd70670",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.422Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.482Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "high_distinct_count_error_message"
        ]
      },
      {
        "name": "Potential Masquerading as System32 Executable",
        "description": "Identifies suspicious instances of default system32 executables, either unsigned or signed with non-MS certificates. This could indicate the attempt to masquerade as system executables or backdoored and resigned legitimate executables.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "Data Source: Elastic Defend",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  },
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d323dfab-4727-4139-b9c6-72278d5e8964",
        "rule_id": "79ce2c96-72f7-44f9-88ef-60fa1ac2ce47",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.426Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.736Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and \n  (process.code_signature.status : \"?*\" or process.code_signature.exists != null) and\n  process.name: (\n      \"agentactivationruntimestarter.exe\", \"agentservice.exe\", \"aitstatic.exe\", \"alg.exe\", \"apphostregistrationverifier.exe\", \"appidcertstorecheck.exe\", \"appidpolicyconverter.exe\", \"appidtel.exe\", \"applicationframehost.exe\", \"applysettingstemplatecatalog.exe\", \"applytrustoffline.exe\", \"approvechildrequest.exe\", \"appvclient.exe\", \"appvdllsurrogate.exe\", \"appvnice.exe\", \"appvshnotify.exe\", \"arp.exe\", \"assignedaccessguard.exe\", \"at.exe\", \"atbroker.exe\", \"attrib.exe\", \"audiodg.exe\", \"auditpol.exe\", \"authhost.exe\", \"autochk.exe\", \"autoconv.exe\", \"autofmt.exe\", \"axinstui.exe\", \"baaupdate.exe\", \"backgroundtaskhost.exe\", \"backgroundtransferhost.exe\", \"bcdboot.exe\", \"bcdedit.exe\", \"bdechangepin.exe\", \"bdehdcfg.exe\", \"bdeuisrv.exe\", \"bdeunlock.exe\", \"bioiso.exe\", \"bitlockerdeviceencryption.exe\", \"bitlockerwizard.exe\", \"bitlockerwizardelev.exe\", \"bitsadmin.exe\", \"bootcfg.exe\", \"bootim.exe\", \"bootsect.exe\", \"bridgeunattend.exe\", \"browserexport.exe\", \"browser_broker.exe\", \"bthudtask.exe\", \"bytecodegenerator.exe\", \"cacls.exe\", \"calc.exe\", \"camerasettingsuihost.exe\", \"castsrv.exe\", \"certenrollctrl.exe\", \"certreq.exe\", \"certutil.exe\", \"change.exe\", \"changepk.exe\", \"charmap.exe\", \"checknetisolation.exe\", \"chglogon.exe\", \"chgport.exe\", \"chgusr.exe\", \"chkdsk.exe\", \"chkntfs.exe\", \"choice.exe\", \"cidiag.exe\", \"cipher.exe\", \"cleanmgr.exe\", \"cliconfg.exe\", \"clip.exe\", \"clipup.exe\", \"cloudexperiencehostbroker.exe\", \"cloudnotifications.exe\", \"cmd.exe\", \"cmdkey.exe\", \"cmdl32.exe\", \"cmmon32.exe\", \"cmstp.exe\", \"cofire.exe\", \"colorcpl.exe\", \"comp.exe\", \"compact.exe\", \"compattelrunner.exe\", \"compmgmtlauncher.exe\", \"comppkgsrv.exe\", \"computerdefaults.exe\", \"conhost.exe\", \"consent.exe\", \"control.exe\", \"convert.exe\", \"convertvhd.exe\", \"coredpussvr.exe\", \"credentialenrollmentmanager.exe\", \"credentialuibroker.exe\", \"credwiz.exe\", \"cscript.exe\", \"csrss.exe\", \"ctfmon.exe\", \"cttune.exe\", \"cttunesvr.exe\", \"custominstallexec.exe\", \"customshellhost.exe\", \"dashost.exe\", \"dataexchangehost.exe\", \"datastorecachedumptool.exe\", \"dccw.exe\", \"dcomcnfg.exe\", \"ddodiag.exe\", \"defrag.exe\", \"deploymentcsphelper.exe\", \"desktopimgdownldr.exe\", \"devicecensus.exe\", \"devicecredentialdeployment.exe\", \"deviceeject.exe\", \"deviceenroller.exe\", \"devicepairingwizard.exe\", \"deviceproperties.exe\", \"dfdwiz.exe\", \"dfrgui.exe\", \"dialer.exe\", \"directxdatabaseupdater.exe\", \"diskpart.exe\", \"diskperf.exe\", \"diskraid.exe\", \"disksnapshot.exe\", \"dism.exe\", \"dispdiag.exe\", \"displayswitch.exe\", \"djoin.exe\", \"dllhost.exe\", \"dllhst3g.exe\", \"dmcertinst.exe\", \"dmcfghost.exe\", \"dmclient.exe\", \"dmnotificationbroker.exe\", \"dmomacpmo.exe\", \"dnscacheugc.exe\", \"doskey.exe\", \"dpapimig.exe\", \"dpiscaling.exe\", \"dpnsvr.exe\", \"driverquery.exe\", \"drvinst.exe\", \"dsmusertask.exe\", \"dsregcmd.exe\", \"dstokenclean.exe\", \"dusmtask.exe\", \"dvdplay.exe\", \"dwm.exe\", \"dwwin.exe\", \"dxdiag.exe\", \"dxgiadaptercache.exe\", \"dxpserver.exe\", \"eap3host.exe\", \"easeofaccessdialog.exe\", \"easinvoker.exe\", \"easpolicymanagerbrokerhost.exe\", \"edpcleanup.exe\", \"edpnotify.exe\", \"eduprintprov.exe\", \"efsui.exe\", \"ehstorauthn.exe\", \"eoaexperiences.exe\", \"esentutl.exe\", \"eudcedit.exe\", \"eventcreate.exe\", \"eventvwr.exe\", \"expand.exe\", \"extrac32.exe\", \"fc.exe\", \"fclip.exe\", \"fhmanagew.exe\", \"filehistory.exe\", \"find.exe\", \"findstr.exe\", \"finger.exe\", \"fixmapi.exe\", \"fltmc.exe\", \"fodhelper.exe\", \"fondue.exe\", \"fontdrvhost.exe\", \"fontview.exe\", \"forfiles.exe\", \"fsavailux.exe\", \"fsiso.exe\", \"fsquirt.exe\", \"fsutil.exe\", \"ftp.exe\", \"fvenotify.exe\", \"fveprompt.exe\", \"gamebarpresencewriter.exe\", \"gamepanel.exe\", \"genvalobj.exe\", \"getmac.exe\", \"gpresult.exe\", \"gpscript.exe\", \"gpupdate.exe\", \"grpconv.exe\", \"hdwwiz.exe\", \"help.exe\", \"hostname.exe\", \"hvax64.exe\", \"hvix64.exe\", \"hvsievaluator.exe\", \"icacls.exe\", \"icsentitlementhost.exe\", \"icsunattend.exe\", \"ie4uinit.exe\", \"ie4ushowie.exe\", \"iesettingsync.exe\", \"ieunatt.exe\", \"iexpress.exe\", \"immersivetpmvscmgrsvr.exe\", \"infdefaultinstall.exe\", \"inputswitchtoasthandler.exe\", \"iotstartup.exe\", \"ipconfig.exe\", \"iscsicli.exe\", \"iscsicpl.exe\", \"isoburn.exe\", \"klist.exe\", \"ksetup.exe\", \"ktmutil.exe\", \"label.exe\", \"languagecomponentsinstallercomhandler.exe\", \"launchtm.exe\", \"launchwinapp.exe\", \"legacynetuxhost.exe\", \"licensemanagershellext.exe\", \"licensingdiag.exe\", \"licensingui.exe\", \"locationnotificationwindows.exe\", \"locator.exe\", \"lockapphost.exe\", \"lockscreencontentserver.exe\", \"lodctr.exe\", \"logagent.exe\", \"logman.exe\", \"logoff.exe\", \"logonui.exe\", \"lpkinstall.exe\", \"lpksetup.exe\", \"lpremove.exe\", \"lsaiso.exe\", \"lsass.exe\", \"magnify.exe\", \"makecab.exe\", \"manage-bde.exe\", \"mavinject.exe\", \"mbaeparsertask.exe\", \"mblctr.exe\", \"mbr2gpt.exe\", \"mcbuilder.exe\", \"mdeserver.exe\", \"mdmagent.exe\", \"mdmappinstaller.exe\", \"mdmdiagnosticstool.exe\", \"mdres.exe\", \"mdsched.exe\", \"mfpmp.exe\", \"microsoft.uev.cscunpintool.exe\", \"microsoft.uev.synccontroller.exe\", \"microsoftedgebchost.exe\", \"microsoftedgecp.exe\", \"microsoftedgedevtools.exe\", \"microsoftedgesh.exe\", \"mmc.exe\", \"mmgaserver.exe\", \"mobsync.exe\", \"mountvol.exe\", \"mousocoreworker.exe\", \"mpnotify.exe\", \"mpsigstub.exe\", \"mrinfo.exe\", \"mschedexe.exe\", \"msconfig.exe\", \"msdt.exe\", \"msdtc.exe\", \"msfeedssync.exe\", \"msg.exe\", \"mshta.exe\", \"msiexec.exe\", \"msinfo32.exe\", \"mspaint.exe\", \"msra.exe\", \"msspellcheckinghost.exe\", \"mstsc.exe\", \"mtstocom.exe\", \"muiunattend.exe\", \"multidigimon.exe\", \"musnotification.exe\", \"musnotificationux.exe\", \"musnotifyicon.exe\", \"narrator.exe\", \"nbtstat.exe\", \"ndadmin.exe\", \"ndkping.exe\", \"net.exe\", \"net1.exe\", \"netbtugc.exe\", \"netcfg.exe\", \"netcfgnotifyobjecthost.exe\", \"netevtfwdr.exe\", \"nethost.exe\", \"netiougc.exe\", \"netplwiz.exe\", \"netsh.exe\", \"netstat.exe\", \"newdev.exe\", \"ngciso.exe\", \"nltest.exe\", \"notepad.exe\", \"nslookup.exe\", \"ntoskrnl.exe\", \"ntprint.exe\", \"odbcad32.exe\", \"odbcconf.exe\", \"ofdeploy.exe\", \"omadmclient.exe\", \"omadmprc.exe\", \"openfiles.exe\", \"openwith.exe\", \"optionalfeatures.exe\", \"osk.exe\", \"pacjsworker.exe\", \"packagedcwalauncher.exe\", \"packageinspector.exe\", \"passwordonwakesettingflyout.exe\", \"pathping.exe\", \"pcalua.exe\", \"pcaui.exe\", \"pcwrun.exe\", \"perfmon.exe\", \"phoneactivate.exe\", \"pickerhost.exe\", \"pinenrollmentbroker.exe\", \"ping.exe\", \"pkgmgr.exe\", \"pktmon.exe\", \"plasrv.exe\", \"pnpunattend.exe\", \"pnputil.exe\", \"poqexec.exe\", \"pospaymentsworker.exe\", \"powercfg.exe\", \"presentationhost.exe\", \"presentationsettings.exe\", \"prevhost.exe\", \"printbrmui.exe\", \"printfilterpipelinesvc.exe\", \"printisolationhost.exe\", \"printui.exe\", \"proquota.exe\", \"provlaunch.exe\", \"provtool.exe\", \"proximityuxhost.exe\", \"prproc.exe\", \"psr.exe\", \"pwlauncher.exe\", \"qappsrv.exe\", \"qprocess.exe\", \"query.exe\", \"quser.exe\", \"qwinsta.exe\", \"rasautou.exe\", \"rasdial.exe\", \"raserver.exe\", \"rasphone.exe\", \"rdpclip.exe\", \"rdpinit.exe\", \"rdpinput.exe\", \"rdpsa.exe\", \"rdpsaproxy.exe\", \"rdpsauachelper.exe\", \"rdpshell.exe\", \"rdpsign.exe\", \"rdrleakdiag.exe\", \"reagentc.exe\", \"recdisc.exe\", \"recover.exe\", \"recoverydrive.exe\", \"refsutil.exe\", \"reg.exe\", \"regedt32.exe\", \"regini.exe\", \"register-cimprovider.exe\", \"regsvr32.exe\", \"rekeywiz.exe\", \"relog.exe\", \"relpost.exe\", \"remoteapplifetimemanager.exe\", \"remoteposworker.exe\", \"repair-bde.exe\", \"replace.exe\", \"reset.exe\", \"resetengine.exe\", \"resmon.exe\", \"rmactivate.exe\", \"rmactivate_isv.exe\", \"rmactivate_ssp.exe\", \"rmactivate_ssp_isv.exe\", \"rmclient.exe\", \"rmttpmvscmgrsvr.exe\", \"robocopy.exe\", \"route.exe\", \"rpcping.exe\", \"rrinstaller.exe\", \"rstrui.exe\", \"runas.exe\", \"rundll32.exe\", \"runexehelper.exe\", \"runlegacycplelevated.exe\", \"runonce.exe\", \"runtimebroker.exe\", \"rwinsta.exe\", \"sc.exe\", \"schtasks.exe\", \"scriptrunner.exe\", \"sdbinst.exe\", \"sdchange.exe\", \"sdclt.exe\", \"sdiagnhost.exe\", \"searchfilterhost.exe\", \"searchindexer.exe\", \"searchprotocolhost.exe\", \"secedit.exe\", \"secinit.exe\", \"securekernel.exe\", \"securityhealthhost.exe\", \"securityhealthservice.exe\", \"securityhealthsystray.exe\", \"sensordataservice.exe\", \"services.exe\", \"sessionmsg.exe\", \"sethc.exe\", \"setspn.exe\", \"settingsynchost.exe\", \"setupcl.exe\", \"setupugc.exe\", \"setx.exe\", \"sfc.exe\", \"sgrmbroker.exe\", \"sgrmlpac.exe\", \"shellappruntime.exe\", \"shrpubw.exe\", \"shutdown.exe\", \"sigverif.exe\", \"sihclient.exe\", \"sihost.exe\", \"slidetoshutdown.exe\", \"slui.exe\", \"smartscreen.exe\", \"smss.exe\", \"sndvol.exe\", \"snippingtool.exe\", \"snmptrap.exe\", \"sort.exe\", \"spaceagent.exe\", \"spaceman.exe\", \"spatialaudiolicensesrv.exe\", \"spectrum.exe\", \"spoolsv.exe\", \"sppextcomobj.exe\", \"sppsvc.exe\", \"srdelayed.exe\", \"srtasks.exe\", \"stordiag.exe\", \"subst.exe\", \"svchost.exe\", \"sxstrace.exe\", \"syncappvpublishingserver.exe\", \"synchost.exe\", \"sysreseterr.exe\", \"systeminfo.exe\", \"systempropertiesadvanced.exe\", \"systempropertiescomputername.exe\", \"systempropertiesdataexecutionprevention.exe\", \"systempropertieshardware.exe\", \"systempropertiesperformance.exe\", \"systempropertiesprotection.exe\", \"systempropertiesremote.exe\", \"systemreset.exe\", \"systemsettingsadminflows.exe\", \"systemsettingsbroker.exe\", \"systemsettingsremovedevice.exe\", \"systemuwplauncher.exe\", \"systray.exe\", \"tabcal.exe\", \"takeown.exe\", \"tapiunattend.exe\", \"tar.exe\", \"taskhostw.exe\", \"taskkill.exe\", \"tasklist.exe\", \"taskmgr.exe\", \"tcblaunch.exe\", \"tcmsetup.exe\", \"tcpsvcs.exe\", \"thumbnailextractionhost.exe\", \"tieringengineservice.exe\", \"timeout.exe\", \"tokenbrokercookies.exe\", \"tpminit.exe\", \"tpmtool.exe\", \"tpmvscmgr.exe\", \"tpmvscmgrsvr.exe\", \"tracerpt.exe\", \"tracert.exe\", \"tscon.exe\", \"tsdiscon.exe\", \"tskill.exe\", \"tstheme.exe\", \"tswbprxy.exe\", \"ttdinject.exe\", \"tttracer.exe\", \"typeperf.exe\", \"tzsync.exe\", \"tzutil.exe\", \"ucsvc.exe\", \"uevagentpolicygenerator.exe\", \"uevappmonitor.exe\", \"uevtemplatebaselinegenerator.exe\", \"uevtemplateconfigitemgenerator.exe\", \"uimgrbroker.exe\", \"unlodctr.exe\", \"unregmp2.exe\", \"upfc.exe\", \"upgraderesultsui.exe\", \"upnpcont.exe\", \"upprinterinstaller.exe\", \"useraccountbroker.exe\", \"useraccountcontrolsettings.exe\", \"userinit.exe\", \"usoclient.exe\", \"utcdecoderhost.exe\", \"utilman.exe\", \"vaultcmd.exe\", \"vds.exe\", \"vdsldr.exe\", \"verclsid.exe\", \"verifier.exe\", \"verifiergui.exe\", \"vssadmin.exe\", \"vssvc.exe\", \"w32tm.exe\", \"waasmedicagent.exe\", \"waitfor.exe\", \"wallpaperhost.exe\", \"wbadmin.exe\", \"wbengine.exe\", \"wecutil.exe\", \"werfault.exe\", \"werfaultsecure.exe\", \"wermgr.exe\", \"wevtutil.exe\", \"wextract.exe\", \"where.exe\", \"whoami.exe\", \"wiaacmgr.exe\", \"wiawow64.exe\", \"wifitask.exe\", \"wimserv.exe\", \"winbiodatamodeloobe.exe\", \"windows.media.backgroundplayback.exe\", \"windows.warp.jitservice.exe\", \"windowsactiondialog.exe\", \"windowsupdateelevatedinstaller.exe\", \"wininit.exe\", \"winload.exe\", \"winlogon.exe\", \"winresume.exe\", \"winrs.exe\", \"winrshost.exe\", \"winrtnetmuahostserver.exe\", \"winsat.exe\", \"winver.exe\", \"wkspbroker.exe\", \"wksprt.exe\", \"wlanext.exe\", \"wlrmdr.exe\", \"wmpdmc.exe\", \"workfolders.exe\", \"wowreg32.exe\", \"wpcmon.exe\", \"wpctok.exe\", \"wpdshextautoplay.exe\", \"wpnpinst.exe\", \"wpr.exe\", \"write.exe\", \"wscadminui.exe\", \"wscollect.exe\", \"wscript.exe\", \"wsl.exe\", \"wsmanhttpconfig.exe\", \"wsmprovhost.exe\", \"wsqmcons.exe\", \"wsreset.exe\", \"wuapihost.exe\", \"wuauclt.exe\", \"wudfcompanionhost.exe\", \"wudfhost.exe\", \"wusa.exe\", \"wwahost.exe\", \"xblgamesavetask.exe\", \"xcopy.exe\", \"xwizard.exe\", \"aggregatorhost.exe\", \"diskusage.exe\", \"dtdump.exe\", \"ism.exe\", \"ndkperfcmd.exe\", \"ntkrla57.exe\", \"securekernella57.exe\", \"spaceutil.exe\", \"configure-smremoting.exe\", \"dcgpofix.exe\", \"dcpromo.exe\", \"dimc.exe\", \"diskshadow.exe\", \"drvcfg.exe\", \"escunattend.exe\", \"iashost.exe\", \"ktpass.exe\", \"lbfoadmin.exe\", \"netdom.exe\", \"rdspnf.exe\", \"rsopprov.exe\", \"sacsess.exe\", \"servermanager.exe\", \"servermanagerlauncher.exe\", \"setres.exe\", \"tsecimp.exe\", \"vssuirun.exe\", \"webcache.exe\", \"win32calc.exe\", \"certoc.exe\", \"sdndiagnosticstask.exe\", \"xpsrchvw.exe\"\n    ) and\n  not (\n    process.code_signature.subject_name in (\n      \"Microsoft Windows\",\n      \"Microsoft Corporation\",\n      \"Microsoft Windows Publisher\"\n    ) and process.code_signature.trusted == true\n  ) and not process.code_signature.status: (\"errorCode_endpoint*\", \"errorUntrustedRoot\", \"errorChaining\") and\n  not\n  (\n    process.executable: (\n      \"?:\\\\Program Files\\\\Git\\\\usr\\\\bin\\\\hostname.exe\",\n      \"?:\\\\Windows\\\\Temp\\\\{*}\\\\taskkill.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\{*}\\\\taskkill.exe\",\n      \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\System32\\\\ie4ushowIE.exe\",\n      \"?:\\\\Program Files\\\\Git\\\\usr\\\\bin\\\\find.exe\",\n      \"?:\\\\Program Files (x86)\\\\Axence\\\\nVision Agent 2\\\\nss\\\\certutil.exe\"\n    )\n  ) and\n  not\n  (\n    (process.name: \"ucsvc.exe\" and process.code_signature.subject_name == \"Wellbia.com Co., Ltd.\" and process.code_signature.status: \"trusted\") or\n    (process.name: \"pnputil.exe\" and process.code_signature.subject_name: (\"Lenovo\", \"HP Inc.\", \"Dell Inc\") and process.code_signature.status: \"trusted\") or\n    (process.name: \"convert.exe\" and process.code_signature.subject_name: \"ImageMagick Studio LLC\" and process.code_signature.status: \"trusted\") or\n    (process.name: \"systeminfo.exe\" and process.code_signature.subject_name: \"Arctic Wolf Networks, Inc.\" and process.code_signature.status: \"trusted\") or\n    (\n      process.name: \"certutil.exe\" and\n      process.code_signature.subject_name: (\n        \"Intel(R) Online Connect Access\",\n        \"Fortinet Technologies (Canada) ULC\"\n      ) and process.code_signature.status: \"trusted\"\n    ) or\n    (\n      process.name: \"sfc.exe\" and\n      process.code_signature.subject_name: (\n        \"Cisco Systems, Inc.\",\n        \"CISCO SYSTEMS CANADA CO\"\n      ) and process.code_signature.status: \"trusted\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious WMIC XSL Script Execution",
        "description": "Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scripting libraries it may be indicative of an allowlist bypass.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1220",
                "name": "XSL Script Processing",
                "reference": "https://attack.mitre.org/techniques/T1220/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6875c78d-d2d9-4d63-a65a-278f542eb7ea",
        "rule_id": "7f370d54-c0eb-4270-ac5a-9a6020585dc6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.431Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.445Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan = 2m\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.name : \"WMIC.exe\" or process.pe.original_file_name : \"wmic.exe\") and\n   process.args : (\"format*:*\", \"/format*:*\", \"*-format*:*\") and\n   not process.command_line : (\"* /format:table *\", \"* /format:table\")]\n[any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : (\"jscript.dll\", \"vbscript.dll\") or file.name : (\"jscript.dll\", \"vbscript.dll\"))]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Process Extension",
        "description": "Identifies processes running with unusual extensions that are not typically valid for Windows executables.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.008",
                    "name": "Masquerade File Type",
                    "reference": "https://attack.mitre.org/techniques/T1036/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dd206c20-9415-4010-b1d6-aa3f779cc836",
        "rule_id": "800e01be-a7a4-46d0-8de9-69f3c9582b44",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.433Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.750Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : \"?*\" and \n  not process.name : (\"*.exe\", \"*.com\", \"*.scr\", \"*.tmp\", \"*.dat\") and\n  not process.executable : \n    (\n      \"MemCompression\",\n      \"Registry\",\n      \"vmmem\",\n      \"vmmemWSL\",\n      \"?:\\\\Program Files\\\\Dell\\\\SupportAssistAgent\\\\*.p5x\",\n      \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\com.docker.service\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Intel\\\\AGS\\\\Libs\\\\AGSRunner.bin\",\n      \"\\\\Device\\\\Mup\\\\*\\\\Software Management\\\\Select.Html.dep\",\n      \"?:\\\\DJJApplications\\\\MedicalRecords\\\\bin\\\\Select.Html.dep\",\n      \"?:\\\\ProgramData\\\\Software Management\\\\Select.Html.dep\",\n      \"?:\\\\Program Files (x86)\\\\EnCase Applications\\\\Examiner Service\\\\EnCase64\\\\enhkey.dll\",\n      \"?:\\\\Program Files (x86)\\\\Panda Security\\\\WAC\\\\PSNAEInj64.dll\",\n      \"?:\\\\Program Files (x86)\\\\Johnson Controls\\\\LicenseActivator\\\\crp32002.ngn\"\n    ) and\n  not (\n    (process.name : \"C9632CF058AE4321B6B0B5EA39B710FE\" and process.code_signature.subject_name == \"Dell Inc\") or\n    (process.name : \"*.upd\" and process.code_signature.subject_name == \"Bloomberg LP\") or\n    (process.name: \"FD552E21-686E-413C-931D-3B82A9D29F3B\" and process.code_signature.subject_name: \"Adobe Inc.\") or\n    (process.name: \"3B91051C-AE82-43C9-BCEF-0309CD2DD9EB\" and process.code_signature.subject_name: \"McAfee, LLC\") or\n    (process.name: \"soffice.bin\" and process.code_signature.subject_name: \"The Document Foundation\") or\n    (process.name: (\"VeeamVixProxy_*\", \"{????????-????-????-????-????????????}\") and process.code_signature.subject_name: \"Veeam Software Group GmbH\") or\n    (process.name: \"1cv8p64.bin\" and process.code_signature.subject_name: \"LLC 1C-Soft\") or\n    (process.name: \"AGSRunner.bin\" and process.code_signature.subject_name: \"Intel Corporation\")\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Unsigned DLL Loaded by Svchost",
        "description": "Identifies an unsigned library created in the last 5 minutes and subsequently loaded by a shared windows service (svchost). Adversaries may use this technique to maintain persistence or run with System privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/Hunting-for-Suspicious-Windows-Libraries-for-Execution-and-Evasion"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.Ext.relative_file_creation_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "dll.hash.sha256",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f179ceb5-cb32-4fc0-8a7a-e8aaa9762739",
        "rule_id": "78ef0c95-9dc2-40ac-a8da-5deb6293a14e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.424Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.426Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where host.os.type == \"windows\" and\n\n process.executable : \n     (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \"?:\\\\Windows\\\\Syswow64\\\\svchost.exe\") and \n     \n dll.code_signature.trusted != true and \n \n not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and \n \n dll.hash.sha256 != null and \n \n (\n       /* DLL created within 5 minutes of the library load event - compatible with Elastic Endpoint 8.4+ */\n       dll.Ext.relative_file_creation_time <= 300 or \n   \n       /* unusual paths */\n       dll.path :(\"?:\\\\ProgramData\\\\*\",\n                  \"?:\\\\Users\\\\*\",\n                  \"?:\\\\PerfLogs\\\\*\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*\",\n                  \"?:\\\\Intel\\\\*\",\n                  \"?:\\\\AMD\\\\Temp\\\\*\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"?:\\\\Windows\\\\Branding\\\\*\",\n                  \"?:\\\\Windows\\\\csc\\\\*\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"?:\\\\Windows\\\\en-US\\\\*\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*\",\n                  \"?:\\\\Windows\\\\INF\\\\*\",\n                  \"?:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"?:\\\\windows\\\\tracing\\\\*\",\n                  \"?:\\\\windows\\\\IME\\\\*\",\n                  \"?:\\\\Windows\\\\Performance\\\\*\",\n                  \"?:\\\\windows\\\\intel\\\\*\",\n                  \"?:\\\\windows\\\\ms\\\\*\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"?:\\\\Windows\\\\panther\\\\*\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"?:\\\\Windows\\\\OCR\\\\*\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*\",\n                  \"?:\\\\Windows\\\\addins\\\\*\",\n                  \"?:\\\\Windows\\\\Setup\\\\*\",\n                  \"?:\\\\Windows\\\\Help\\\\*\",\n                  \"?:\\\\Windows\\\\SKB\\\\*\",\n                  \"?:\\\\Windows\\\\Vss\\\\*\",\n                  \"?:\\\\Windows\\\\servicing\\\\*\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"?:\\\\Windows\\\\Logs\\\\*\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"?:\\\\Windows\\\\PLA\\\\*\",\n                  \"?:\\\\Windows\\\\Migration\\\\*\",\n                  \"?:\\\\Windows\\\\debug\\\\*\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*\",\n                  \"?:\\\\Windows\\\\Containers\\\\*\",\n                  \"?:\\\\Windows\\\\Boot\\\\*\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\schemas\\\\*\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*\",\n                  \"?:\\\\Windows\\\\Resources\\\\*\",\n                  \"?:\\\\Windows\\\\rescache\\\\*\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"?:\\\\Windows\\\\media\\\\*\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"?:\\\\$Recycle.Bin\\\\*\")\n  ) and \n  \n  not dll.hash.sha256 : \n            (\"3ed33e71641645367442e65dca6dab0d326b22b48ef9a4c2a2488e67383aa9a6\", \n             \"b4db053f6032964df1b254ac44cb995ffaeb4f3ade09597670aba4f172cf65e4\", \n             \"214c75f678bc596bbe667a3b520aaaf09a0e50c364a28ac738a02f867a085eba\", \n             \"23aa95b637a1bf6188b386c21c4e87967ede80242327c55447a5bb70d9439244\", \n             \"5050b025909e81ae5481db37beb807a80c52fc6dd30c8aa47c9f7841e2a31be7\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Troubleshooting Pack Cabinet Execution",
        "description": "Identifies the execution of the Microsoft Diagnostic Wizard to open a diagcab file from a suspicious path and with an unusual parent process. This may indicate an attempt to execute malicious Troubleshooting Pack Cabinet files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://irsl.medium.com/the-trouble-with-microsofts-troubleshooters-6e32fc80b8bd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7c4571f7-c69d-4ccb-aafd-5a1fd7929f3a",
        "rule_id": "808291d3-e918-4a3a-86cd-73052a0c9bdc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.435Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.907Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  (process.name : \"msdt.exe\" or ?process.pe.original_file_name == \"msdt.exe\") and process.args : \"/cab\" and\n  process.parent.name : (\n    \"firefox.exe\", \"chrome.exe\", \"msedge.exe\", \"explorer.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\",\n    \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\",\n    \"winrar.exe\", \"winrar.exe\", \"7zFM.exe\", \"outlook.exe\", \"winword.exe\", \"excel.exe\"\n  ) and\n  process.args : (\n    \"?:\\\\Users\\\\*\",\n    \"\\\\\\\\*\",\n    \"http*\",\n    \"ftp://*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script Block Logging Disabled",
        "description": "Identifies attempts to disable PowerShell Script Block Logging via registry modification. Attackers may disable this logging to conceal their activities in the host and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Script Block Logging Disabled\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available in various environments and creating an attractive way for attackers to execute code.\n\nPowerShell Script Block Logging is a feature of PowerShell that records the content of all script blocks that it processes, giving defenders visibility of PowerShell scripts and sequences of executed commands.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether it makes sense for the user to use PowerShell to complete tasks.\n- Investigate if PowerShell scripts were run after logging was disabled.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n- PowerShell Suspicious Script with Audio Capture Capabilities - 2f2f4939-0b34-40c2-a0a3-844eb7889f43\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell Suspicious Script with Screenshot Capabilities - 959a7353-1129-4aa7-9084-30746b256a70\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://admx.help/?Category=Windows_10_2016&Policy=Microsoft.Policies.PowerShell::EnableScriptBlockLogging"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.002",
                    "name": "Disable Windows Event Logging",
                    "reference": "https://attack.mitre.org/techniques/T1562/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ddb24e96-f68c-4de0-944f-e64114ca7acb",
        "rule_id": "818e23e6-2094-4f0e-8c01-22d30f3506c6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.438Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.448Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\",\n        \"MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\"\n    ) and registry.data.strings : (\"0\", \"0x00000000\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual City For an AWS Command",
        "description": "A machine learning job detected AWS command activity that, while not inherently suspicious or abnormal, is sourcing from a geolocation (city) that is unusual for the command. This can be the result of compromised credentials or keys being used by a threat actor in a different geography than the authorized user(s).",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual City For an AWS Command\n\nCloudTrail logging provides visibility on actions taken within an AWS environment. By monitoring these events and understanding what is considered normal behavior within an organization, you can spot suspicious or malicious activity when deviations occur.\n\nThis rule uses a machine learning job to detect an AWS API command that while not inherently suspicious or abnormal, is sourcing from a geolocation (city) that is unusual for the command. This can be the result of compromised credentials or keys used by a threat actor in a different geography than the authorized user(s).\n\nDetection alerts from this rule indicate an AWS API command or method call that is rare and unusual for the geolocation of the source IP address.\n\n#### Possible investigation steps\n\n- Identify the user account involved and the action performed. Verify whether it should perform this kind of action.\n    - Examine the user identity in the `aws.cloudtrail.user_identity.arn` field and the access key ID in the `aws.cloudtrail.user_identity.access_key_id` field, which can help identify the precise user context.\n    - The user agent details in the `user_agent.original` field may also indicate what kind of a client made the request.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives can occur if activity is coming from new employees based in a city with no previous history in AWS.\n- Examine the history of the command. If the command only manifested recently, it might be part of a new automation module or script. If it has a consistent cadence (for example, it appears in small numbers on a weekly or monthly cadence), it might be part of a housekeeping or maintenance process. You can find the command in the `event.action field` field.\n\n### Related Rules\n\n- Unusual Country For an AWS Command - dca28dee-c999-400f-b640-50a081cc0fd1\n- Unusual AWS Command for a User - ac706eae-d5ec-4b14-b4fd-e8ba8086f0e1\n- Rare AWS Error Code - 19de8096-e2b0-4bd8-80c9-34a820813fff\n- Spike in AWS Error Messages - 78d3d8d9-b476-451d-a9e0-7a5addd70670\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "New or unusual command and user geolocation activity can be due to manual troubleshooting or reconfiguration; changes in cloud automation scripts or workflows; adoption of new services; expansion into new regions; increased adoption of work from home policies; or users who travel frequently."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from AWS.\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### AWS Integration Setup\nThe AWS integration allows you to collect logs and metrics from Amazon Web Services (AWS) with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"aws\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for AWS and select the integration to see more details about it.\n- Click Add AWS.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed aws to an existing or a new agent policy, and deploy the agent on your system from which aws log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://www.elastic.co/docs/current/integrations/aws).\n",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "19716766-ea68-42eb-b28e-1629683b195e",
        "rule_id": "809b70d3-e2c3-455e-af1b-2626a5a1a276",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.436Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.404Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "rare_method_for_a_city"
        ]
      },
      {
        "name": "AWS ElastiCache Security Group Created",
        "description": "Identifies when an ElastiCache security group has been created.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "A ElastiCache security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AmazonElastiCache/latest/APIReference/API_CreateCacheSecurityGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "57e5be2c-7ab5-4c03-8208-ba982c0cdf40",
        "rule_id": "7b3da11a-60a2-412e-8aa7-011e1eb9ed47",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.429Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.438Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:elasticache.amazonaws.com and event.action:\"Create Cache Security Group\" and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential File Transfer via Certreq",
        "description": "Identifies Certreq making an HTTP Post request. Adversaries could abuse Certreq to download files or upload data to a remote URL.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential File Transfer via Certreq\n\nCertreq is a command-line utility in Windows operating systems that allows users to request and manage certificates from certificate authorities. It is primarily used for generating certificate signing requests (CSRs) and installing certificates. However, adversaries may abuse Certreq's functionality to download files or upload data to a remote URL by making an HTTP POST request.\n\nThis rule identifies the potential abuse of Certreq to download files or upload data to a remote URL.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the details of the dropped file, and whether it was executed.\n- Check the reputation of the domain or IP address used to host the downloaded file or if the user downloaded the file from an internal system.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unusual but can be done by administrators. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Command and Control",
          "Tactic: Exfiltration",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Certreq/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1567",
                "name": "Exfiltration Over Web Service",
                "reference": "https://attack.mitre.org/techniques/T1567/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "62583f78-f98e-420d-8c82-895cffe586c7",
        "rule_id": "79f0a1f7-ed6b-471c-8eb1-23abd6470b1c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.427Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.429Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"CertReq.exe\" or ?process.pe.original_file_name == \"CertReq.exe\") and process.args : \"-Post\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Temporarily Scheduled Task Creation",
        "description": "Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxy malicious execution via the schedule service and perform clean up.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "254383a0-2efe-40e9-962c-c0300b7e8817",
        "rule_id": "81ff45f8-f8c2-4e28-992e-5a0e8d98e0fe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.440Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.451Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m\n   [iam where event.action == \"scheduled-task-created\" and not user.name : \"*$\"]\n   [iam where event.action == \"scheduled-task-deleted\" and not user.name : \"*$\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Network Access Control List Deletion",
        "description": "Identifies the deletion of an Amazon Elastic Compute Cloud (EC2) network access control list (ACL) or one of its ingress/egress entries.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Network ACL's may be deleted by a network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Network ACL deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/delete-network-acl.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteNetworkAcl.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/delete-network-acl-entry.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteNetworkAclEntry.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5c89df78-10cf-4a58-8b20-2594f2847cd3",
        "rule_id": "8623535c-1e17-44e1-aa97-7a0699c3037d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.441Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.464Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(DeleteNetworkAcl or DeleteNetworkAclEntry) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS RDS Security Group Deletion",
        "description": "Identifies the deletion of an Amazon Relational Database Service (RDS) Security group.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS RDS",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "An RDS security group deletion may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_DeleteDBSecurityGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ef31db41-6c5b-42f5-a3bc-d4bbdb7afaaa",
        "rule_id": "863cdf31-7fd3-41cf-a185-681237ea277b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.443Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.467Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:DeleteDBSecurityGroup and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS EventBridge Rule Disabled or Deleted",
        "description": "Identifies when a user has disabled or deleted an EventBridge rule. This activity can result in an unintended loss of visibility in applications or a break in the flow with other AWS services.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "EventBridge Rules could be deleted or disabled by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. EventBridge Rules being deleted or disabled by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_DeleteRule.html",
          "https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_DisableRule.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4f164700-56ec-4406-b912-95e2c4603bc4",
        "rule_id": "87594192-4539-4bc4-8543-23bc3d5bd2b4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.447Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.473Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:eventbridge.amazonaws.com and event.action:(DeleteRule or DisableRule) and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Network Zone",
        "description": "Detects attempts to deactivate an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Network Zone\n\nThe Okta network zones can be configured to restrict or limit access to a network based on IP addresses or geolocations. Deactivating a network zone in Okta may remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deactivation of a network zone.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the network zone that was deactivated.\n- Investigate the `event.time` field to understand when the event happened.\n- Review the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis\n\n- Check the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's normal behavior, it might be a false positive.\n- Check if the actor is a known administrator or part of the IT team who might have a legitimate reason to deactivate a network zone.\n- Verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor account and require a password change.\n- Re-enable the deactivated network zone if it was deactivated without authorization.\n- Review and update the privileges of the actor who initiated the deactivation.\n- Check the security policies and procedures to identify any gaps and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e38f5fb1-a30e-4b67-b3dc-f5990f722dd6",
        "rule_id": "8a5c1e5f-ad63-481e-b53a-ef959230f7f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.448Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.262Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.deactivate",
        "language": "kuery"
      },
      {
        "name": "AWS Deletion of RDS Instance or Cluster",
        "description": "Identifies the deletion of an Amazon Relational Database Service (RDS) Aurora database cluster, global database cluster, or database instance.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS RDS",
          "Use Case: Asset Visibility",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Clusters or instances may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster or instance deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/delete-db-cluster.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_DeleteDBCluster.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/delete-global-cluster.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_DeleteGlobalCluster.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/delete-db-instance.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_DeleteDBInstance.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5a569613-bac5-4eb2-ac16-0cc57cce677e",
        "rule_id": "9055ece6-2689-4224-a0e0-b04881e1f8ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.452Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.508Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(DeleteDBCluster or DeleteGlobalCluster or DeleteDBInstance)\nand event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS IAM Group Deletion",
        "description": "Identifies the deletion of a specified AWS Identity and Access Management (IAM) resource group. Deleting a resource group does not delete resources that are members of the group; it only deletes the group structure.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A resource group may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Resource group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/delete-group.html",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e9111bed-3295-46a9-b73a-b652a800a98f",
        "rule_id": "867616ec-41e5-4edc-ada2-ab13ab45de8a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.445Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.470Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:DeleteGroup and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Port Monitor or Print Processor Registration Abuse",
        "description": "Identifies port monitor and print processor registry modifications. Adversaries may abuse port monitor and print processors to run malicious DLLs during system boot that will be executed as SYSTEM for privilege escalation and/or persistence, if permissions allow writing a fully-qualified pathname for that DLL.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/2020/05/21/no-game-over-winnti-group/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.010",
                    "name": "Port Monitors",
                    "reference": "https://attack.mitre.org/techniques/T1547/010/"
                  },
                  {
                    "id": "T1547.012",
                    "name": "Print Processors",
                    "reference": "https://attack.mitre.org/techniques/T1547/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.010",
                    "name": "Port Monitors",
                    "reference": "https://attack.mitre.org/techniques/T1547/010/"
                  },
                  {
                    "id": "T1547.012",
                    "name": "Print Processors",
                    "reference": "https://attack.mitre.org/techniques/T1547/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "faf9ca70-076e-4da1-9e41-b91579058e55",
        "rule_id": "8f3e91c7-d791-4704-80a1-42c160d7aa27",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.450Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.505Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\"\n  ) and registry.data.strings : \"*.dll\" and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "AWS WAF Access Control List Deletion",
        "description": "Identifies the deletion of a specified AWS Web Application Firewall (WAF) access control list.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Firewall ACL's may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Web ACL deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/waf-regional/delete-web-acl.html",
          "https://docs.aws.amazon.com/waf/latest/APIReference/API_wafRegional_DeleteWebACL.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fd5d1946-95aa-4e3c-bb5e-997e558aff90",
        "rule_id": "91d04cd4-47a9-4334-ab14-084abe274d49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.454Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.515Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.action:DeleteWebACL and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS STS GetSessionToken Abuse",
        "description": "Identifies the suspicious use of GetSessionToken. Tokens could be created and used by attackers to move laterally and escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "GetSessionToken may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. GetSessionToken from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/STS/latest/APIReference/API_GetSessionToken.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "14d7e03f-2dc9-44b5-a33e-6648e875a3dc",
        "rule_id": "b45ab1d2-712f-4f01-a751-df3826969807",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.455Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.469Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:sts.amazonaws.com and event.action:GetSessionToken and\naws.cloudtrail.user_identity.type:IAMUser and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "At.exe Command Lateral Movement",
        "description": "Identifies use of at.exe to interact with the task scheduler on remote hosts. Remote task creations, modifications or execution could be indicative of adversary lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.002",
                    "name": "At",
                    "reference": "https://attack.mitre.org/techniques/T1053/002/"
                  },
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "15f9d3ac-11d9-405d-a702-5f548c894359",
        "rule_id": "b483365c-98a8-40c0-92d8-0458ca25058a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.457Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.862Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"at.exe\" and process.args : \"\\\\\\\\*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Windows Script Interpreter Executing Process via WMI",
        "description": "Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process via Windows Management Instrumentation (WMI). This may be indicative of malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "877a4aea-6e7a-4af2-8589-da8c9c00c13f",
        "rule_id": "b64b183e-1a76-422d-9179-7b389513e74d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.578Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.479Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 5s\n    [any where host.os.type == \"windows\" and \n     (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n     (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\") and process.name : (\"wscript.exe\", \"cscript.exe\")]\n    [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.parent.name : \"wmiprvse.exe\" and\n     user.domain != \"NT AUTHORITY\" and\n     (process.pe.original_file_name :\n        (\n          \"cscript.exe\",\n          \"wscript.exe\",\n          \"PowerShell.EXE\",\n          \"Cmd.Exe\",\n          \"MSHTA.EXE\",\n          \"RUNDLL32.EXE\",\n          \"REGSVR32.EXE\",\n          \"MSBuild.exe\",\n          \"InstallUtil.exe\",\n          \"RegAsm.exe\",\n          \"RegSvcs.exe\",\n          \"msxsl.exe\",\n          \"CONTROL.EXE\",\n          \"EXPLORER.EXE\",\n          \"Microsoft.Workflow.Compiler.exe\",\n          \"msiexec.exe\"\n        ) or\n      process.executable : (\"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n     )\n    ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Deactivate an Okta Policy",
        "description": "Detects attempts to deactivate an Okta policy. An adversary may attempt to deactivate an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to deactivate an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy\n\nOkta policies define rules to manage user access to resources. Policies such as multi-factor authentication (MFA) are critical for enforcing strong security measures. Deactivation of an Okta policy could potentially weaken the security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule is designed to detect attempts to deactivate an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. For example, disabling an MFA policy could lower the security of user authentication processes.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy deactivation attempt.\n- Check if there are multiple policy deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of deactivating Okta policies is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cf8ccb5d-6c7c-4e65-90a2-45a13ffc80c7",
        "rule_id": "b719a170-3bdb-4141-b0e3-13e3cf627bfe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.580Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.388Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Policy",
        "description": "Detects attempts to delete an Okta policy. An adversary may attempt to delete an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to delete an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy\n\nOkta policies are critical to managing user access and enforcing security controls within an organization. The deletion of an Okta policy could drastically weaken an organization's security posture by allowing unrestricted access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. Adversaries may do this to bypass security barriers and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy deletion attempt.\n- Check if there are multiple policy deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "48f02c07-209c-4811-b320-c1f58dfdb5e8",
        "rule_id": "b4bb1440-0fcb-4ed1-87e5-b06d58efc5e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.581Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.378Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "Administrator Privileges Assigned to an Okta Group",
        "description": "Detects when an administrator role is assigned to an Okta group. An adversary may attempt to assign administrator privileges to an Okta group in order to assign additional permissions to compromised user accounts and maintain access to their target organization.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8bbdee06-9965-46f8-8a95-c50bd3e80129",
        "rule_id": "b8075894-0b62-46e5-977c-31275da34419",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.583Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.482Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:group.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "Kirbi File Creation",
        "description": "Identifies the creation of .kirbi files. The creation of this kind of file is an indicator of an attacker running Kerberos ticket dump utilities, such as Mimikatz, and precedes attacks such as Pass-The-Ticket (PTT), which allows the attacker to impersonate users using Kerberos tickets.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Elastic Endgame",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c662b6ec-9d0b-489b-af4d-66c41798a826",
        "rule_id": "b8f8da2d-a9dc-48c0-90e4-955c0aa1259a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.585Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.871Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"kirbi\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "winlogbeat-*",
          "endgame-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Encryption Disabled",
        "description": "Identifies disabling of Amazon Elastic Block Store (EBS) encryption by default in the current region. Disabling encryption by default does not change the encryption status of your existing volumes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Disabling encryption may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Disabling encryption by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/disable-ebs-encryption-by-default.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DisableEbsEncryptionByDefault.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1565",
                "name": "Data Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1565/",
                "subtechnique": [
                  {
                    "id": "T1565.001",
                    "name": "Stored Data Manipulation",
                    "reference": "https://attack.mitre.org/techniques/T1565/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ee4ec39d-107c-4b71-ab68-a075a6348917",
        "rule_id": "bb9b13b2-1700-48a8-a750-b43b0a72ab69",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.587Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.492Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:DisableEbsEncryptionByDefault and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential SYN-Based Network Scan Detected",
        "description": "This rule identifies a potential SYN-Based port scan. A SYN port scan is a technique employed by attackers to scan a target network for open ports by sending SYN packets to multiple ports and observing the response. Attackers use this method to identify potential entry points or services that may be vulnerable to exploitation, allowing them to launch targeted attacks or gain unauthorized access to the system or network, compromising its security and potentially leading to data breaches or further malicious activities. This rule proposes threshold logic to check for connection attempts from one source host to 10 or more destination ports using 2 or less packets per port.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Network",
          "Tactic: Discovery",
          "Tactic: Reconnaissance",
          "Use Case: Network Security Monitoring",
          "Data Source: Elastic Defend",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1046",
                "name": "Network Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1046/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0043",
              "name": "Reconnaissance",
              "reference": "https://attack.mitre.org/tactics/TA0043/"
            },
            "technique": [
              {
                "id": "T1595",
                "name": "Active Scanning",
                "reference": "https://attack.mitre.org/techniques/T1595/",
                "subtechnique": [
                  {
                    "id": "T1595.001",
                    "name": "Scanning IP Blocks",
                    "reference": "https://attack.mitre.org/techniques/T1595/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "network.packets",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "0667bd5a-f43a-42bd-833f-93ec6a235fcf",
        "rule_id": "bbaa96b9-f36c-4898-ace2-581acb00a409",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.589Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.496Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "destination.port : * and network.packets <= 2 and source.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)",
        "threshold": {
          "field": [
            "destination.ip",
            "source.ip"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "destination.port",
              "value": 250
            }
          ]
        },
        "index": [
          "logs-endpoint.events.network-*",
          "logs-network_traffic.*",
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS Root Login Without MFA",
        "description": "Identifies attempts to login to AWS as the root user without using multi-factor authentication (MFA). Amazon AWS best practices indicate that the root user should be protected by MFA.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS Root Login Without MFA\n\nMulti-factor authentication (MFA) in AWS is a simple best practice that adds an extra layer of protection on top of your user name and password. With MFA enabled, when a user signs in to an AWS Management Console, they will be prompted for their user name and password, as well as for an authentication code from their AWS MFA device. Taken together, these multiple factors provide increased security for your AWS account settings and resources.\n\nFor more information about using MFA in AWS, access the [official documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html).\n\nThe AWS root account is the one identity that has complete access to all AWS services and resources in the account, which is created when the AWS account is created. AWS strongly recommends that you do not use the root user for your everyday tasks, even the administrative ones. Instead, adhere to the best practice of using the root user only to create your first IAM user. Then securely lock away the root user credentials and use them to perform only a few account and service management tasks. Amazon provides a [list of the tasks that require root user](https://docs.aws.amazon.com/general/latest/gr/root-vs-iam.html#aws_tasks-that-require-root).\n\nThis rule looks for attempts to log in to AWS as the root user without using multi-factor authentication (MFA), meaning the account is not secured properly.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Examine whether this activity is common in the environment by looking for past occurrences on your logs.\n- Consider the source IP address and geolocation for the calling user who issued the command. Do they look normal for the calling user?\n- Examine the commands, API calls, and data management actions performed by the account in the last 24 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking access to servers,\nservices, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity is not inherently malicious, the root account must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the entire cloud environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify the services or servers involved criticality.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify if there are any regulatory or legal ramifications related to this activity.\n- Configure multi-factor authentication for the user.\n- Follow security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some organizations allow login with the root user without MFA, however, this is not considered best practice by AWS and increases the risk of compromised credentials."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.console_login.additional_eventdata.mfa_used",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9c198212-a60f-473b-91ce-922df225cca2",
        "rule_id": "bc0c6f0d-dab0-47a3-b135-0925f0a333bc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.591Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.499Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and\n  aws.cloudtrail.user_identity.type:Root and\n  aws.cloudtrail.console_login.additional_eventdata.mfa_used:false and\n  event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Non-Standard Port SSH connection",
        "description": "Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For example, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to the standard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "OS: macOS",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "SSH over ports apart from the traditional port 22 is highly uncommon. This rule alerts the usage of the such uncommon ports by the ssh service. Tuning is needed to have higher confidence. If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination whitelisted ports for such legitimate ssh activities."
        ],
        "references": [
          "https://attack.mitre.org/techniques/T1571/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1571",
                "name": "Non-Standard Port",
                "reference": "https://attack.mitre.org/techniques/T1571/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "43314590-ec70-49f3-bb03-6c8ddf7cca2d",
        "rule_id": "bc8ca7e0-92fd-4b7c-b11e-ee0266b8d9c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.593Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.502Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n  [process where event.action == \"exec\" and process.name in (\"ssh\", \"sshd\") and not process.parent.name in (\n   \"rsync\", \"pyznap\", \"git\", \"ansible-playbook\", \"scp\", \"pgbackrest\", \"git-lfs\", \"expect\", \"Sourcetree\", \"ssh-copy-id\",\n   \"run\"\n   )\n  ]\n  [network where process.name:\"ssh\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n   destination.port != 22 and network.transport == \"tcp\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\"\n     )\n   )\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Machine Learning Detected DGA activity using a known SUNBURST DNS domain",
        "description": "A supervised machine learning model has identified a DNS question name that used by the SUNBURST malware and is predicted to be the result of a Domain Generation Algorithm.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Network",
          "Domain: Endpoint",
          "Data Source: Elastic Defend",
          "Use Case: Domain Generation Algorithm Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/dga",
          "https://www.elastic.co/security-labs/detect-domain-generation-algorithm-activity-with-new-kibana-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1568",
                "name": "Dynamic Resolution",
                "reference": "https://attack.mitre.org/techniques/T1568/",
                "subtechnique": [
                  {
                    "id": "T1568.002",
                    "name": "Domain Generation Algorithms",
                    "reference": "https://attack.mitre.org/techniques/T1568/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Domain Generation Algorithm (DGA) Detection integration assets to be installed, as well as DNS events collected by integrations such as Elastic Defend, Network Packet Capture, or Packetbeat.  \n\n### DGA Detection Setup\nThe DGA Detection integration consists of an ML-based framework to detect DGA activity in DNS events.\n\n#### Prerequisite Requirements:\n- Fleet is required for DGA Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- DNS events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint), [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration, or [Packetbeat](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n- To set up and run Packetbeat, follow [this](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html) guide.\n\n#### The following steps should be executed to install assets associated with the DGA Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Domain Generation Algorithm Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Configure the ingest pipeline**.\n",
        "related_integrations": [
          {
            "package": "dga",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.registered_domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "ml_is_dga.malicious_prediction",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "316065a3-c6bf-4b24-8ebf-689965ea9e49",
        "rule_id": "bcaa15ce-2d41-44d7-a322-918f9db77766",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.595Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.961Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*",
          "logs-network_traffic.*"
        ],
        "filters": [],
        "query": "ml_is_dga.malicious_prediction:1 and dns.question.registered_domain:avsvmcloud.com",
        "language": "kuery"
      },
      {
        "name": "Suspicious Windows Process Cluster Spawned by a Host",
        "description": "A machine learning job combination has detected a set of one or more suspicious Windows processes with unusually high scores for malicious probability. These process(es) have been classified as malicious in several ways. The process(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of suspicious processes, each process has the same host name, and the aggregate score of the event cluster was calculated to be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "3f4b956b-65f0-4988-8c0e-54de4f148c2c",
        "rule_id": "bdfebe11-e169-42e3-b344-c5d2015533d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.967Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_high_sum_by_host"
        ]
      },
      {
        "name": "Potential Data Exfiltration Activity to an Unusual Region",
        "description": "A machine learning job has detected data exfiltration to a particular geo-location (by region name). Data transfers to geo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command and control channels.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Data Exfiltration Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-21600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/ded",
          "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1041",
                "name": "Exfiltration Over C2 Channel",
                "reference": "https://attack.mitre.org/techniques/T1041/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  \n\n### Data Exfiltration Detection Setup\nThe Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. \n\n#### Prerequisite Requirements:\n- Fleet is required for Data Exfiltration Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Network events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) or [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n\n#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "ded",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "840458fb-ffa3-48f0-9091-08475682f230",
        "rule_id": "bfba5158-1fd6-4937-a205-77d96213b341",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.599Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.973Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "ded_high_sent_bytes_destination_region_name"
        ]
      },
      {
        "name": "Memory Dump File with Unusual Extension",
        "description": "Identifies the creation of a memory dump file with an unusual extension, which can indicate an attempt to disguise a memory dump as another file type to bypass security defenses.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.008",
                    "name": "Masquerade File Type",
                    "reference": "https://attack.mitre.org/techniques/T1036/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3d95e6bb-5306-4aeb-a284-998aa5ecb300",
        "rule_id": "c0b9dc99-c696-4779-b086-0d37dc2b3778",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:04.638Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.787Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n\n  /* MDMP header */\n  file.Ext.header_bytes : \"4d444d50*\" and\n  not file.extension : (\"dmp\", \"mdmp\", \"hdmp\", \"edmp\", \"full\", \"tdref\", \"cg\", \"tmp\", \"dat\") and\n  not \n  (\n    process.executable : \"?:\\\\Program Files\\\\Endgame\\\\esensor.exe\" and\n    process.code_signature.trusted == true and length(file.extension) == 0\n  ) and\n  not\n  (\n    process.name : \"System\" and file.extension : \"tmpscan\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Full Network Packet Capture Detected",
        "description": "Identifies potential Traffic Mirroring in an Amazon Elastic Compute Cloud (EC2) instance. Traffic Mirroring is an Amazon VPC feature that you can use to copy network traffic from an Elastic network interface. This feature can potentially be abused to exfiltrate sensitive data from unencrypted internal traffic.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Network Security Monitoring",
          "Tactic: Exfiltration",
          "Tactic: Collection"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Traffic Mirroring may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Traffic Mirroring from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_TrafficMirrorFilter.html",
          "https://github.com/easttimor/aws-incident-response"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1020",
                "name": "Automated Exfiltration",
                "reference": "https://attack.mitre.org/techniques/T1020/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1074",
                "name": "Data Staged",
                "reference": "https://attack.mitre.org/techniques/T1074/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "69f02bab-4396-42f5-a2ff-5df0b3f7e48d",
        "rule_id": "c1812764-0788-470f-8e74-eb4a14d47573",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.493Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.522Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and\nevent.action:(CreateTrafficMirrorFilter or CreateTrafficMirrorFilterRule or CreateTrafficMirrorSession or CreateTrafficMirrorTarget) and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Unsigned DLL Loaded by a Trusted Process",
        "description": "Identifies digitally signed (trusted) processes loading unsigned DLLs. Attackers may plant their payloads into the application folder and invoke the legitimate application to execute the payload, masking actions they perform under a legitimate, trusted, and potentially elevated system or software process.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  },
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.Ext.device.product_id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.Ext.relative_file_creation_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.Ext.relative_file_name_modify_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.hash.sha256",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9f2167db-1ffa-495b-a9d6-8f5b0d17c69e",
        "rule_id": "c20cd758-07b1-46a1-b03f-fa66158258b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.495Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.771Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where host.os.type == \"windows\" and\n   (dll.Ext.relative_file_creation_time <= 500 or\n    dll.Ext.relative_file_name_modify_time <= 500 or\n    dll.Ext.device.product_id : (\"Virtual DVD-ROM\", \"Virtual Disk\")) and dll.hash.sha256 != null and\n    process.code_signature.status :\"trusted\" and not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and\n    /* DLL loaded from the process.executable current directory */\n    endswith~(substring(dll.path, 0, length(dll.path) - (length(dll.name) + 1)), substring(process.executable, 0, length(process.executable) - (length(process.name) + 1)))\n    and not user.id : \"S-1-5-18\" and\n    not dll.hash.sha256 : (\n        \"19588e6a318894abe8094374bee233e666f319de909c69f12a6047b14473e299\",\n        \"6e8bee250c8cc1b65150522f33794759f5c65f58fff17c5cbf6422ad68b421d2\",\n        \"55de11531dc0e566cb91f26e48d1301a161a4b8b24abed42304d711412368760\",\n        \"56a5148d00c2d9e58415be2d64eca922a58063fe26d9af1c87084aa383c9058e\",\n        \"83ee0ff920144edb2c2f4ea10130f55443493290886985a63233fa2431e450f9\",\n        \"0d0d8f2eaff6b5f75e63d9721d5a0480b30e70792fe0d3a24d76fd3e61b05982\",\n        \"8b6ce3a640e2d6f36b0001be2a1abb765ae51e62c314a15911e75138cbb544bb\",\n        \"ea02a19dd824cb7d611b8821d1b9e6a076714a195d027d1ff918128a64ac5220\",\n        \"02a6d001e6dd944738e09b720e49dcb1272cb782b870e5ae319d4600bc192225\",\n        \"e7714a1d6ac3f4c4ae22564b9ca301e486f5f42691859c0a687246c47b5cf5c9\",\n        \"17f0f709fb7f6190c03b19b6198fd863b6f0d79f46ccfebac6064be747a4cb3e\",\n        \"cb7ab3788d10940df874acd97b1821bbb5ee4a91f3eec11982bb5bf7a3c96443\",\n        \"c944ee510721a1d30d42227cc3061dfdcbc144c952381afcfe4f6e82c5435ffc\",\n        \"967189adfbc889fde89aafc867f7a1f02731f8592cf6fd5a4ace1929213e2e13\",\n        \"4a824526749790603eb66777f79787128dd282162a3904a4c1135de43b14d029\",\n        \"620a7e658af05cc848091b8a639854b9b15700a9061b4a3d078523653133a4af\",\n        \"cb220267fb0116b298bab6a09a764420d630c52026f7d750f8ffca4818389327\",\n        \"0da1f856d92d6b95f10ed8c3f629cd15468c906de9352fb4ae629139d1412eed\",\n        \"e1646c7778c24407a17881908037a49ecfcb5a980d155212d544302653a3ef62\",\n        \"e102c9c5b22ceb60dc516ab4124bea8ec8e808b08eec48ea7ac674d13fca82ef\",\n        \"c7544e1f9927afdf6e8cd7063020b572e60fe8f00af39227eb831d331df38225\",\n        \"3668c6749db59a6cbc5293d0a4f904f76d6fb5048704449dd53894916f408a57\",\n        \"7705851ba047a8154402aca92621b60be0e0e9d9b52b19bf8be540305bd53dba\",\n        \"b5acf358ff97127eac9ef4c664a980b937376b5295ef23d77ee338225de10d60\",\n        \"394d2d862f2ddce71f28d9b933b21a7d6c621c80ef28652574f758f77f01f716\",\n        \"e958d03db79e9f1d2770c70a5bc24904aa3e2d27a8d5637684cf8166b38908f2\",\n        \"284701380f33a30b25e8eb9822e7f47179238e91d08bd3fb5a117145de7e0d8d\",\n        \"497471497886f18ca16f7facab7d76dc9bfadd69deb9c6e4ea9bdc0869a15628\",\n        \"739bedcfc8eb860927eb2057474be5b39518aaaa6703f9f85307a432fa1f236e\",\n        \"8f4c72e3c7de1ab5d894ec7813f65c5298ecafc183f31924b44a427433ffca42\",\n        \"1ac4753056179b358132c55ca3086d550849ae30259ba94f334826c2fbf6c57e\",\n        \"53e8fecd7d4b1b74064eba9bfa6a361d52929f440954931b4ba65615148bf0ea\",\n        \"e9088afd8871dbad5eda47a9d8abf3b08dd2e17c423ba8a05f9b6ad6751f9b7c\",\n        \"ab27eb05130db2f92499234b69ff97ee6429c7824efcb7324ae3e404e2b405bf\",\n        \"553451008520a5f0110d84192cba40208fb001c27454f946e85e6fb2e6553292\"\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Delete an Okta Network Zone",
        "description": "Detects attempts to delete an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Network Zone\n\nOkta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. Deleting a network zone in Okta might remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps:\n\n- Identify the actor associated with the alert by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deletion of a network zone.\n- Investigate the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` fields to identify the network zone that was deleted.\n- Review the `event.time` field to understand when the event happened.\n- Check the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis:\n\n- Verify the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's typical behavior, it might be a false positive.\n- Check if the actor is a known administrator or a member of the IT team who might have a legitimate reason to delete a network zone.\n- Cross-verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation:\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor's account and require a password change.\n- If a network zone was deleted without authorization, create a new network zone with similar settings as the deleted one.\n- Review and update the privileges of the actor who initiated the deletion.\n- Identify any gaps in the security policies and procedures and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly deleted."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ef78fff7-2792-473a-98a3-e2513bd14fde",
        "rule_id": "c749e367-a069-4a73-b1f2-43a3798153ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.497Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.317Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Modify an Okta Application",
        "description": "Detects attempts to modify an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly modified and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b6b922c8-0c26-4536-8e6b-274df96eeb52",
        "rule_id": "c74fd275-ab2c-4d49-8890-e2943fa65c09",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.499Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.542Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Parent Process PID Spoofing",
        "description": "Identifies parent process spoofing used to thwart detection. Adversaries may spoof the parent process identifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.didierstevens.com/2017/03/20/",
          "https://www.elastic.co/security-labs/elastic-security-labs-steps-through-the-r77-rootkit"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.004",
                    "name": "Parent PID Spoofing",
                    "reference": "https://attack.mitre.org/techniques/T1134/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.004",
                    "name": "Parent PID Spoofing",
                    "reference": "https://attack.mitre.org/techniques/T1134/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.Ext.real.pid",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ded77764-860f-4074-b6a6-cf263f68f86b",
        "rule_id": "c88d4bd0-5649-4c52-87ea-9be59dbfbcf2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.500Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.558Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* This rule is compatible with Elastic Endpoint only */\n\nsequence by host.id, user.id with maxspan=3m \n\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.Ext.token.integrity_level_name != \"system\" and \n  (\n    process.pe.original_file_name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\",\n                                     \"fltldr.exe\", \"mspub.exe\", \"msaccess.exe\", \"powershell.exe\", \"pwsh.exe\",\n                                     \"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"msbuild.exe\",\n                                     \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") or \n                                     \n    (process.executable : (\"?:\\\\Users\\\\*.exe\",\n                           \"?:\\\\ProgramData\\\\*.exe\",\n                           \"?:\\\\Windows\\\\Temp\\\\*.exe\",\n                           \"?:\\\\Windows\\\\Tasks\\\\*\") and \n      (process.code_signature.exists == false or process.code_signature.status : \"errorBadDigest\")) or \n                          \n    process.executable : \"?:\\\\Windows\\\\Microsoft.NET\\\\*.exe\"                      \n  ) and \n  \n  not process.executable : \n             (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\", \n              \"?:\\\\WINDOWS\\\\SysWOW64\\\\WerFaultSecure.exe\",\n              \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n              \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\")\n  ] by process.pid\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.Ext.real.pid > 0 and \n \n  /* process.parent.Ext.real.pid is only populated if the parent process pid doesn't match */\n  not (process.name : \"msedge.exe\" and process.parent.name : \"sihost.exe\") and \n  \n   not process.executable : \n             (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\", \n              \"?:\\\\WINDOWS\\\\SysWOW64\\\\WerFaultSecure.exe\",\n              \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n              \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\")\n ] by process.parent.Ext.real.pid",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Startup Shell Folder Modification",
        "description": "Identifies suspicious startup shell folder modifications to change the default Startup directory in order to bypass detections monitoring file creation in the Windows Startup folder.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Startup Shell Folder Modification\n\nTechniques used within malware and by adversaries often leverage the Windows registry to store malicious programs for persistence. Startup shell folders are often targeted as they are not as prevalent as normal Startup folder paths so this behavior may evade existing AV/EDR solutions. These programs may also run with higher privileges which can be ideal for an attacker.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Review the source process and related file tied to the Windows Registry entry.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- There is a high possibility of benign legitimate programs being added to shell folders. This activity could be based on new software installations, patches, or other network administrator activity. Before undertaking further investigation, it should be verified that this activity is not benign.\n\n### Related rules\n\n- Startup or Run Key Registry Modification - 97fc44d3-8dae-4019-ae83-298c3015600f\n- Persistent Scripts in the Startup Directory - f7c4dc5a-a58d-491d-9f14-9b66507121c0\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-security-uncovers-blister-malware-campaign",
          "https://www.elastic.co/security-labs/revisiting-blister-new-developments-of-the-blister-loader"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f4093d7d-4ef6-435b-bb69-b0ee6e4bc943",
        "rule_id": "c8b150f0-0164-475b-a75e-74b47800a9ff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.502Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.324Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.value : (\"Common Startup\", \"Startup\") and\n registry.path : (\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"HKCU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKCU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\"\n     ) and\n  registry.data.strings != null and\n  /* Normal Startup Folder Paths */\n  not registry.data.strings : (\n           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%ProgramData%\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%USERPROFILE%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\"\n           )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Masquerading as Communication Apps",
        "description": "Identifies suspicious instances of communications apps, both unsigned and renamed ones, that can indicate an attempt to conceal malicious activity, bypass security features such as allowlists, or trick users into executing malware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  },
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "04049867-673c-4602-99a4-ca9ffb93aead",
        "rule_id": "c9482bfa-a553-4226-8ea2-4959bd4f7923",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.504Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.561Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and\n  (\n    /* Slack */\n    (process.name : \"slack.exe\" and not\n      (process.code_signature.subject_name in (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"WebexHost.exe\" and not\n      (process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"Teams.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"Discord.exe\" and not\n      (process.code_signature.subject_name == \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* RocketChat */\n    (process.name : \"Rocket.Chat.exe\" and not\n      (process.code_signature.subject_name == \"Rocket.Chat Technologies Corp.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Mattermost */\n    (process.name : \"Mattermost.exe\" and not\n      (process.code_signature.subject_name == \"Mattermost, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"WhatsApp.exe\" and not\n      (process.code_signature.subject_name in (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : \"Zoom.exe\" and not\n      (process.code_signature.subject_name == \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"outlook.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"thunderbird.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Data Exfiltration Activity to an Unusual IP Address",
        "description": "A machine learning job has detected data exfiltration to a particular geo-location (by IP address). Data transfers to geo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command and control channels.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Data Exfiltration Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-21600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/ded",
          "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1041",
                "name": "Exfiltration Over C2 Channel",
                "reference": "https://attack.mitre.org/techniques/T1041/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  \n\n### Data Exfiltration Detection Setup\nThe Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. \n\n#### Prerequisite Requirements:\n- Fleet is required for Data Exfiltration Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Network events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) or [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n\n#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "ded",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "2a63e5fd-059e-414a-91c6-31f41489bc5d",
        "rule_id": "cc653d77-ddd2-45b1-9197-c75ad19df66c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.506Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.698Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "ded_high_sent_bytes_destination_ip"
        ]
      },
      {
        "name": "Attempt to Deactivate an Okta Policy Rule",
        "description": "Detects attempts to deactivate a rule within an Okta policy. An adversary may attempt to deactivate a rule within an Okta policy in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy Rule\n\nIdentity and Access Management (IAM) systems like Okta serve as the first line of defense for an organization's network, and are often targeted by adversaries. By disabling security rules, adversaries can circumvent multi-factor authentication, access controls, or other protective measures enforced by these policies, enabling unauthorized access, privilege escalation, or other malicious activities.\n\nThis rule detects attempts to deactivate a rule within an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. A threat actor may do this to remove barriers to their activities or enable future attacks.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deactivation attempt.\n- Check if there are multiple policy rule deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly deactivated in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "91727ad0-ea98-470a-a8ef-693f62001ff3",
        "rule_id": "cc92c835-da92-45c9-9f29-b4992ad621a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.507Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.281Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.deactivate",
        "language": "kuery"
      },
      {
        "name": "Modification or Removal of an Okta Application Sign-On Policy",
        "description": "Detects attempts to modify or delete a sign on policy for an Okta application. An adversary may attempt to modify or delete the sign on policy for an Okta application in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if sign on policies for Okta applications are regularly modified or deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/App_Based_Signon.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9a2ce057-7937-4cce-a698-277c9b540edc",
        "rule_id": "cd16fb10-0261-46e8-9932-a0336278cdbe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.509Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.337Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(application.policy.sign_on.update or application.policy.sign_on.rule.delete)",
        "language": "kuery"
      },
      {
        "name": "Okta User Session Impersonation",
        "description": "A user has initiated a session impersonation granting them access to the environment with the permissions of the user they are impersonating. This would likely indicate Okta administrative access and should only ever occur if requested and expected.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta User Session Impersonation\n\nThe detection of an Okta User Session Impersonation indicates that a user has initiated a session impersonation which grants them access with the permissions of the user they are impersonating. This type of activity typically indicates Okta administrative access and should only ever occur if requested and expected.\n\n#### Possible investigation steps\n\n- Identify the actor associated with the impersonation event by checking the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Review the `event.action` field to confirm the initiation of the impersonation event.\n- Check the `event.time` field to understand the timing of the event.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the user who was impersonated.\n- Review any activities that occurred during the impersonation session. Look for any activities related to the impersonated user's account during and after the impersonation event.\n\n### False positive analysis\n\n- Verify if the session impersonation was part of an approved activity. Check if it was associated with any documented administrative tasks or troubleshooting efforts.\n- Ensure that the impersonation session was initiated by an authorized individual. You can check this by verifying the `okta.actor.id` or `okta.actor.display_name` against the list of approved administrators.\n\n### Response and remediation\n\n- If the impersonation was not authorized, consider it as a breach. Suspend the user account of the impersonator immediately.\n- Reset the user session and invalidate any active sessions related to the impersonated user.\n- If a specific impersonation technique was used, ensure that systems are patched or configured to prevent such techniques.\n- Conduct a thorough investigation to understand the extent of the breach and the potential impact on the systems and data.\n- Review and update your security policies to prevent such incidents in the future.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "200eb6b5-153a-40b6-8e1b-c3ea8ad4b413",
        "rule_id": "cdbebdc1-dc97-43c6-a538-f26a20c0a911",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.511Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.284Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.session.impersonation.initiate",
        "language": "kuery"
      },
      {
        "name": "Archive File with Unusual Extension",
        "description": "Identifies the creation of an archive file with an unusual extension. Attackers may attempt to evade detection by masquerading files using the file extension values used by image, audio, or document file types.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.008",
                    "name": "Masquerade File Type",
                    "reference": "https://attack.mitre.org/techniques/T1036/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6fb5ddd1-b96a-444f-8e84-1799509ccd64",
        "rule_id": "cffbaf47-9391-4e09-a83c-1f27d7474826",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.513Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.715Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n\n  /* common archive file headers - Rar, 7z, GZIP, MSCF, XZ, ZIP */\n  file.Ext.header_bytes : (\"52617221*\", \"377ABCAF271C*\", \"1F8B*\", \"4d534346*\", \"FD377A585A00*\", \"504B0304*\", \"504B0708*\") and\n\n  (\n    /* common image file extensions */\n    file.extension : (\"jpg\", \"jpeg\", \"emf\", \"tiff\", \"gif\", \"png\", \"bmp\", \"ico\", \"fpx\", \"eps\", \"inf\") or\n\n    /* common audio and video file extensions */\n    file.extension : (\"mp3\", \"wav\", \"avi\", \"mpeg\", \"flv\", \"wma\", \"wmv\", \"mov\", \"mp4\", \"3gp\") or\n\n    /* common document file extensions */\n    (file.extension : (\"doc\", \"docx\", \"rtf\", \"ppt\", \"pptx\", \"xls\", \"xlsx\") and\n\n    /* exclude ZIP file header values for OPENXML documents */\n    not file.Ext.header_bytes : (\"504B0304*\", \"504B0708*\"))\n  ) and\n\n  not (process.executable : \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\" and file.path : \"?:\\\\inetpub\\\\temp\\\\IIS Temporary Compressed Files\\\\*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Expired or Revoked Driver Loaded",
        "description": "Identifies an attempt to load a revoked or expired driver. Adversaries may bring outdated drivers with vulnerabilities to gain code execution in kernel mode or abuse revoked certificates to sign their drivers.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/hardware/design/dn653559(v=vs.85)?redirectedfrom=MSDN"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "128b35f6-6d28-4bb9-8462-d8d63c0ac47d",
        "rule_id": "d12bac54-ab2a-4159-933f-d7bcefa7b61d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.514Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.651Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  dll.code_signature.status : (\"errorExpired\", \"errorRevoked\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Delete an Okta Application",
        "description": "Detects attempts to delete an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deleted and the behavior is expected."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8b6a3394-d50e-4f3d-978b-271194a2f53f",
        "rule_id": "d48e1c13-4aca-4d1f-a7b1-a9161c0ad86f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.519Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.568Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Policy Rule",
        "description": "Detects attempts to delete a rule within an Okta policy. An adversary may attempt to delete an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy Rule\n\nOkta policy rules are integral components of an organization's security controls, as they define how user access to resources is managed. Deletion of a rule within an Okta policy could potentially weaken the organization's security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy rule, which could indicate an adversary's attempt to weaken an organization's security controls. Adversaries may do this to circumvent security measures and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deletion attempt.\n- Check if there are multiple policy rule deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2ca23b63-43bf-438c-a0ea-78b431c076f9",
        "rule_id": "d5d86bf5-cf0c-4c06-b688-53fdc072fdfd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.521Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.367Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.delete",
        "language": "kuery"
      },
      {
        "name": "AWS CloudWatch Log Stream Deletion",
        "description": "Identifies the deletion of an AWS CloudWatch log stream, which permanently deletes all associated archived log events with the stream.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudWatch Log Stream Deletion\n\nAmazon CloudWatch is a monitoring and observability service that collects monitoring and operational data in the form of logs, metrics, and events for resources and applications. This data can be used to detect anomalous behavior in your environments, set alarms, visualize logs and metrics side by side, take automated actions, troubleshoot issues, and discover insights to keep your applications running smoothly.\n\nA log stream is a sequence of log events that share the same source. Each separate source of logs in CloudWatch Logs makes up a separate log stream.\n\nThis rule looks for the deletion of a log stream using the API `DeleteLogStream` action. Attackers can do this to cover their tracks and impact security monitoring that relies on these sources.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log stream's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS CloudWatch",
          "Use Case: Log Auditing",
          "Tactic: Impact",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A log stream may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Log stream deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/logs/delete-log-stream.html",
          "https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DeleteLogStream.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "76cff2bb-95a3-43c7-8185-9a75abcb8e6e",
        "rule_id": "d624f0ae-3dd1-4856-9aad-ccfe4d4bfa17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.523Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.574Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogStream and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Untrusted Driver Loaded",
        "description": "Identifies attempt to load an untrusted driver. Adversaries may modify code signing policies to enable execution of unsigned or self-signed code.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Untrusted Driver Loaded\n\nMicrosoft created the Windows Driver Signature Enforcement (DSE) security feature to prevent drivers with invalid signatures from loading and executing into the kernel (ring 0). DSE aims to protect systems by blocking attackers from loading malicious drivers on targets. \n\nThis protection is essential for maintaining system security. However, attackers or administrators can disable DSE and load untrusted drivers, which can put the system at risk. Therefore, it's important to keep this feature enabled and only load drivers from trusted sources to ensure system integrity and security.\n\nThis rule identifies an attempt to load an untrusted driver, which effectively means that DSE was disabled or bypassed. This can indicate that the system was compromised.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the driver loaded to identify potentially suspicious characteristics. The following actions can help you gain context:\n  - Identify the path that the driver was loaded from. If you're using Elastic Defend, path information can be found in the `dll.path` field.\n  - Examine the file creation and modification timestamps:\n    - On Elastic Defend, those can be found in the `dll.Ext.relative_file_creation_time` and `dll.Ext.relative_file_name_modify_time` fields. The values are in seconds.\n    - Search for file creation events sharing the same file name as the `dll.name` field and identify the process responsible for the operation.\n      - Investigate any other abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n  - Use the driver SHA-256 (`dll.hash.sha256` field) hash value to search for the existence and reputation in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Use Osquery to investigate the drivers loaded into the system.\n  - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n- Identify the driver's `Device Name` and `Service Name`.\n- Check for alerts from the rules specified in the `Related Rules` section.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Related Rules\n\n- First Time Seen Driver Loaded - df0fd41e-5590-4965-ad5e-cd079ec22fa9\n- Code Signing Policy Modification Through Registry - da7733b1-fe08-487e-b536-0a04c6d8b0cd\n- Code Signing Policy Modification Through Built-in tools - b43570de-a908-4f7f-8bdb-b2df6ffd8c80\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Disable and uninstall all suspicious drivers found in the system. This can be done via Device Manager. (Note that this step may require you to boot the system into Safe Mode.)\n- Remove the related services and registry keys found in the system. Note that the service will probably not stop if the driver is still installed.\n  - This can be done via PowerShell `Remove-Service` cmdlet.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Ensure that the Driver Signature Enforcement is enabled on the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/hfiref0x/TDL",
          "https://docs.microsoft.com/en-us/previous-versions/windows/hardware/design/dn653559(v=vs.85)?redirectedfrom=MSDN"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "7b14aaad-d10e-4af1-ae9b-4f950e1cd3e0",
        "rule_id": "d8ab1ec1-feeb-48b9-89e7-c12e189448aa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.524Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.373Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  dll.code_signature.trusted != true and \n  not dll.code_signature.status : (\"errorExpired\", \"errorRevoked\", \"errorCode_endpoint:*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Deactivation of MFA Device",
        "description": "Identifies the deactivation of a specified multi-factor authentication (MFA) device and removes it from association with the user name for which it was originally enabled. In AWS Identity and Access Management (IAM), a device must be deactivated before it can be deleted.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM Deactivation of MFA Device\n\nMulti-factor authentication (MFA) in AWS is a simple best practice that adds an extra layer of protection on top of your user name and password. With MFA enabled, when a user signs in to an AWS Management Console, they will be prompted for their user name and password (the first factorwhat they know), as well as for an authentication code from their AWS MFA device (the second factorwhat they have). Taken together, these multiple factors provide increased security for your AWS account settings and resources.\n\nFor more information about using MFA in AWS, access the [official documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html).\n\nThis rule looks for the deactivation or deletion of AWS MFA devices. These modifications weaken account security and can lead to the compromise of accounts and other assets.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity can be done by administrators, all users must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the user and domain.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate multi-factor authentication for the user.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Resources: Investigation Guide",
          "Tactic: Impact",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A MFA device may be deactivated by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. MFA device deactivations from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/deactivate-mfa-device.html",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeactivateMFADevice.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9b2b5cda-2f92-474a-92a2-b56eda1ded8f",
        "rule_id": "d8fc1cca-93ed-43c1-bbb6-c0dd3eff2958",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.584Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:(DeactivateMFADevice or DeleteVirtualMFADevice) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Code Signing Policy Modification Through Registry",
        "description": "Identifies attempts to disable the code signing policy through the registry. Code signing provides authenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By allowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Code Signing Policy Modification Through Registry\n\nMicrosoft created the Windows Driver Signature Enforcement (DSE) security feature to prevent drivers with invalid signatures from loading and executing into the kernel (ring 0). DSE aims to protect systems by blocking attackers from loading malicious drivers on targets. \n\nThis protection is essential for maintaining system security. However, attackers or administrators can disable DSE and load untrusted drivers, which can put the system at risk. Therefore, it's important to keep this feature enabled and only load drivers from trusted sources to ensure system integrity and security.\n\nThis rule identifies registry modifications that can disable DSE.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Use Osquery and endpoint driver events (`event.category = \"driver\"`) to investigate if suspicious drivers were loaded into the system after the registry was modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n- Identify the driver's `Device Name` and `Service Name`.\n- Check for alerts from the rules specified in the `Related Rules` section.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Related Rules\n\n- First Time Seen Driver Loaded - df0fd41e-5590-4965-ad5e-cd079ec22fa9\n- Untrusted Driver Loaded - d8ab1ec1-feeb-48b9-89e7-c12e189448aa\n- Code Signing Policy Modification Through Built-in tools - b43570de-a908-4f7f-8bdb-b2df6ffd8c80\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Disable and uninstall all suspicious drivers found in the system. This can be done via Device Manager. (Note that this step may require you to boot the system into Safe Mode.)\n- Remove the related services and registry keys found in the system. Note that the service will probably not stop if the driver is still installed.\n  - This can be done via PowerShell `Remove-Service` cmdlet.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Remove and block malicious artifacts identified during triage.\n- Ensure that the Driver Signature Enforcement is enabled on the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.006",
                    "name": "Code Signing Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1553/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "06c5973f-7dfa-4147-a8e7-99dc0b79c2e1",
        "rule_id": "da7733b1-fe08-487e-b536-0a04c6d8b0cd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.528Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.379Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value: \"BehaviorOnFailedVerify\" and registry.data.strings : (\"0\", \"0x00000000\", \"1\", \"0x00000001\")\n\n  /*\n    Full registry key path omitted due to data source variations:\n    \"HKEY_USERS\\\\*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Driver Signing\\\\BehaviorOnFailedVerify\"\n  */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Machine Learning Detected a DNS Request With a High DGA Probability Score",
        "description": "A supervised machine learning model has identified a DNS question name with a high probability of sourcing from a Domain Generation Algorithm (DGA), which could indicate command and control network activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Network",
          "Domain: Endpoint",
          "Data Source: Elastic Defend",
          "Use Case: Domain Generation Algorithm Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/dga",
          "https://www.elastic.co/security-labs/detect-domain-generation-algorithm-activity-with-new-kibana-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1568",
                "name": "Dynamic Resolution",
                "reference": "https://attack.mitre.org/techniques/T1568/",
                "subtechnique": [
                  {
                    "id": "T1568.002",
                    "name": "Domain Generation Algorithms",
                    "reference": "https://attack.mitre.org/techniques/T1568/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Domain Generation Algorithm (DGA) Detection integration assets to be installed, as well as DNS events collected by integrations such as Elastic Defend, Network Packet Capture, or Packetbeat.  \n\n### DGA Detection Setup\nThe DGA Detection integration consists of an ML-based framework to detect DGA activity in DNS events.\n\n#### Prerequisite Requirements:\n- Fleet is required for DGA Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- DNS events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint), [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration, or [Packetbeat](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n- To set up and run Packetbeat, follow [this](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html) guide.\n\n#### The following steps should be executed to install assets associated with the DGA Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Domain Generation Algorithm Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Configure the ingest pipeline**.\n",
        "related_integrations": [
          {
            "package": "dga",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "ml_is_dga.malicious_probability",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "c1164fff-8f83-4784-a83f-e255fb7431d4",
        "rule_id": "da7f5803-1cd4-42fd-a890-0173ae80ac69",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.529Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.724Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*",
          "logs-network_traffic.*"
        ],
        "filters": [],
        "query": "ml_is_dga.malicious_probability > 0.98",
        "language": "kuery"
      },
      {
        "name": "Network-Level Authentication (NLA) Disabled",
        "description": "Identifies the attempt to disable Network-Level Authentication (NLA) via registry modification. Network Level Authentication (NLA) is a feature on Windows that provides an extra layer of security for Remote Desktop (RDP) connections, as it requires users to authenticate before allowing a full RDP session. Attackers can disable NLA to enable persistence methods that require access to the Windows sign-in screen without authenticating, such as Accessibility Features persistence methods, like Sticky Keys.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/en-us/security/blog/2023/08/24/flax-typhoon-using-legitimate-software-to-quietly-access-taiwanese-organizations/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a7b3f5cb-d294-432c-98cd-091b214ed58c",
        "rule_id": "db65f5ba-d1ef-4944-b9e8-7e51060c2b42",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.531Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.829Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and registry.value : \"UserAuthentication\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\"\n  ) and registry.data.strings :  (\"0\", \"0x00000000\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Country For an AWS Command",
        "description": "A machine learning job detected AWS command activity that, while not inherently suspicious or abnormal, is sourcing from a geolocation (country) that is unusual for the command. This can be the result of compromised credentials or keys being used by a threat actor in a different geography than the authorized user(s).",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Country For an AWS Command\n\nCloudTrail logging provides visibility on actions taken within an AWS environment. By monitoring these events and understanding what is considered normal behavior within an organization, you can spot suspicious or malicious activity when deviations occur.\n\nThis rule uses a machine learning job to detect an AWS API command that while not inherently suspicious or abnormal, is sourcing from a geolocation (country) that is unusual for the command. This can be the result of compromised credentials or keys used by a threat actor in a different geography than the authorized user(s).\n\nDetection alerts from this rule indicate an AWS API command or method call that is rare and unusual for the geolocation of the source IP address.\n\n#### Possible investigation steps\n\n- Identify the user account involved and the action performed. Verify whether it should perform this kind of action.\n    - Examine the user identity in the `aws.cloudtrail.user_identity.arn` field and the access key ID in the `aws.cloudtrail.user_identity.access_key_id` field, which can help identify the precise user context.\n    - The user agent details in the `user_agent.original` field may also indicate what kind of a client made the request.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False Positive Analysis\n\n- False positives can occur if activity is coming from new employees based in a country with no previous history in AWS.\n- Examine the history of the command. If the command only manifested recently, it might be part of a new automation module or script. If it has a consistent cadence (for example, it appears in small numbers on a weekly or monthly cadence), it might be part of a housekeeping or maintenance process. You can find the command in the `event.action field` field.\n\n### Related Rules\n\n- Unusual City For an AWS Command - 809b70d3-e2c3-455e-af1b-2626a5a1a276\n- Unusual AWS Command for a User - ac706eae-d5ec-4b14-b4fd-e8ba8086f0e1\n- Rare AWS Error Code - 19de8096-e2b0-4bd8-80c9-34a820813fff\n- Spike in AWS Error Messages - 78d3d8d9-b476-451d-a9e0-7a5addd70670\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "New or unusual command and user geolocation activity can be due to manual troubleshooting or reconfiguration; changes in cloud automation scripts or workflows; adoption of new services; expansion into new regions; increased adoption of work from home policies; or users who travel frequently."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from AWS.\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### AWS Integration Setup\nThe AWS integration allows you to collect logs and metrics from Amazon Web Services (AWS) with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"aws\" to your system:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for AWS and select the integration to see more details about it.\n- Click Add AWS.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed aws to an existing or a new agent policy, and deploy the agent on your system from which aws log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://www.elastic.co/docs/current/integrations/aws).\n",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "4fe21876-2069-4ace-9f07-afd9c80da8df",
        "rule_id": "dca28dee-c999-400f-b640-50a081cc0fd1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.533Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.396Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "rare_method_for_a_country"
        ]
      },
      {
        "name": "NullSessionPipe Registry Modification",
        "description": "Identifies NullSessionPipe registry modifications that specify which pipes can be accessed anonymously. This could be indicative of adversary lateral movement preparation by making the added pipe available to everyone.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/",
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-anonymous-access-to-named-pipes-and-shares"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d5a3a140-6421-4a7d-956c-c3b117b9c000",
        "rule_id": "ddab1f5f-7089-44f5-9fda-de5b11322e77",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.535Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.647Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\nregistry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\"\n) and length(registry.data.strings) > 0 and\nnot registry.data.strings : \"(empty)\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "First Time Seen Driver Loaded",
        "description": "Identifies the load of a driver with an original file name and signature values that were observed for the first time during the last 30 days. This rule type can help baseline drivers installation within your environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Time Seen Driver Loaded\n\nA driver is a software component that allows the operating system to communicate with hardware devices. It works at a high privilege level, the kernel level, having high control over the system's security and stability.\n\nAttackers may exploit known good but vulnerable drivers to execute code in their context because once an attacker can execute code in the kernel, security tools can no longer effectively protect the host. They can leverage these drivers to tamper, bypass and terminate security software, elevate privileges, create persistence mechanisms, and disable operating system protections and monitoring features. Attackers were seen in the wild conducting these actions before acting on their objectives, such as ransomware.\n\nRead the complete research on \"Stopping Vulnerable Driver Attacks\" done by Elastic Security Labs [here](https://www.elastic.co/kr/security-labs/stopping-vulnerable-driver-attacks).\n\nThis rule identifies the load of a driver with an original file name and signature values observed for the first time during the last 30 days. This rule type can help baseline drivers installation within your environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the driver loaded to identify potentially suspicious characteristics. The following actions can help you gain context:\n  - Identify the path that the driver was loaded from. If using Elastic Defend, this information can be found in the `dll.path` field.\n  - Examine the digital signature of the driver, and check if it's valid.\n  - Examine the creation and modification timestamps of the file:\n    - On Elastic Defend, those can be found in the `dll.Ext.relative_file_creation_time` and `\"dll.Ext.relative_file_name_modify_time\"` fields, with the values being seconds.\n    - Search for file creation events sharing the same file name as the `dll.name` field and identify the process responsible for the operation.\n      - Investigate any other abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n  - Use the driver SHA-256 (`dll.hash.sha256` field) hash value to search for the existence and reputation in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Use Osquery to investigate the drivers loaded into the system.\n  - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n- Identify the driver's `Device Name` and `Service Name`.\n- Check for alerts from the rules specified in the `Related Rules` section.\n\n### False positive analysis\n\n- Matches derived from these rules are not inherently malicious. The security team should investigate them to ensure they are legitimate and needed, then include them in an allowlist only if required. The security team should address any vulnerable driver installation as it can put the user and the domain at risk.\n\n### Related Rules\n\n- Untrusted Driver Loaded - d8ab1ec1-feeb-48b9-89e7-c12e189448aa\n- Code Signing Policy Modification Through Registry - da7733b1-fe08-487e-b536-0a04c6d8b0cd\n- Code Signing Policy Modification Through Built-in tools - b43570de-a908-4f7f-8bdb-b2df6ffd8c80\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Disable and uninstall all suspicious drivers found in the system. This can be done via Device Manager. (Note that this step may require you to boot the system into Safe Mode)\n- Remove the related services and registry keys found in the system. Note that the service will probably not stop if the driver is still installed.\n  - This can be done via PowerShell `Remove-Service` cmdlet.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Ensure that the Driver Signature Enforcement is enabled on the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/kr/security-labs/stopping-vulnerable-driver-attacks"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "18e71897-c7f0-4d8b-b445-d0ee7ea02203",
        "rule_id": "df0fd41e-5590-4965-ad5e-cd079ec22fa9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.536Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.402Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:\"driver\" and host.os.type:windows and event.action:\"load\"",
        "new_terms_fields": [
          "dll.pe.original_file_name",
          "dll.code_signature.subject_name"
        ],
        "history_window_start": "now-30d",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Delayed Execution via Ping",
        "description": "Identifies the execution of commonly abused Windows utilities via a delayed Ping execution. This behavior is often observed during malware installation and is consistent with an attacker attempting to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1216",
                "name": "System Script Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1216/"
              },
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.003",
                    "name": "CMSTP",
                    "reference": "https://attack.mitre.org/techniques/T1218/003/"
                  },
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  },
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  },
                  {
                    "id": "T1218.009",
                    "name": "Regsvcs/Regasm",
                    "reference": "https://attack.mitre.org/techniques/T1218/009/"
                  },
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  },
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              },
              {
                "id": "T1220",
                "name": "XSL Script Processing",
                "reference": "https://attack.mitre.org/techniques/T1220/"
              },
              {
                "id": "T1497",
                "name": "Virtualization/Sandbox Evasion",
                "reference": "https://attack.mitre.org/techniques/T1497/",
                "subtechnique": [
                  {
                    "id": "T1497.003",
                    "name": "Time Based Evasion",
                    "reference": "https://attack.mitre.org/techniques/T1497/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "080b43b7-9e5f-42c0-b000-70dd49e398d5",
        "rule_id": "e00b8d49-632f-4dc6-94a5-76153a481915",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.538Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.728Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.parent.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.action == \"start\" and process.name : \"ping.exe\" and\n   process.args : \"-n\" and process.parent.name : \"cmd.exe\" and not user.id : \"S-1-5-18\"]\n  [process where host.os.type == \"windows\" and event.action == \"start\" and\n   process.parent.name : \"cmd.exe\" and\n   (\n        process.name : (\n            \"rundll32.exe\", \"powershell.exe\",\n            \"mshta.exe\", \"msbuild.exe\",\n            \"certutil.exe\", \"regsvr32.exe\",\n            \"powershell.exe\", \"cscript.exe\",\n            \"wscript.exe\", \"wmic.exe\",\n            \"installutil.exe\", \"msxsl.exe\",\n            \"Microsoft.Workflow.Compiler.exe\",\n            \"ieexec.exe\", \"iexpress.exe\",\n            \"RegAsm.exe\", \"installutil.exe\",\n            \"RegSvcs.exe\", \"RegAsm.exe\"\n        ) or\n        (process.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\*.exe\" and not process.code_signature.trusted == true)\n    ) and\n\n    not process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\") and\n    not (process.name : (\"openssl.exe\", \"httpcfg.exe\", \"certutil.exe\") and process.parent.command_line : \"*ScreenConnectConfigurator.cmd*\") and\n    not (process.pe.original_file_name : \"DPInst.exe\" and process.command_line : \"driver\\\\DPInst_x64  /f \") and\n    not (process.name : \"powershell.exe\" and process.args : \"Write-Host ======*\") and\n    not (process.name : \"wscript.exe\" and process.args : \"launchquiet_args.vbs\" and process.parent.args : \"?:\\\\Windows\\\\TempInst\\\\7z*\") and\n    not (process.name : \"regsvr32.exe\" and process.args : (\"?:\\\\windows\\\\syswow64\\\\msxml?.dll\", \"msxml?.dll\", \"?:\\\\Windows\\\\SysWOW64\\\\mschrt20.ocx\")) and \n    not (process.name : \"wscript.exe\" and\n         process.working_directory :\n                    (\"?:\\\\Windows\\\\TempInst\\\\*\",\n                     \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\BackupBootstrapper\\\\Logs\\\\\",\n                     \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\QBTools\\\\\"))\n    ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Attempts to Brute Force an Okta User Account",
        "description": "Identifies when an Okta user account is locked out 3 times within a 3 hour window. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts. The default Okta authentication policy ensures that a user account is locked out after 10 failed authentication attempts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempts to Brute Force an Okta User Account\n\nBrute force attacks aim to guess user credentials through exhaustive trial-and-error attempts. In this context, Okta accounts are targeted.\n\nThis rule fires when an Okta user account has been locked out 3 times within a 3-hour window. This could indicate an attempted brute force or password spraying attack to gain unauthorized access to the user account. Okta's default authentication policy locks a user account after 10 failed authentication attempts.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.alternate_id` field in the alert. This should give the username of the account being targeted.\n- Review the `okta.event_type` field to understand the nature of the events that led to the account lockout.\n- Check the `okta.severity` and `okta.display_message` fields for more context around the lockout events.\n- Look for correlation of events from the same IP address. Multiple lockouts from the same IP address might indicate a single source for the attack.\n- If the IP is not familiar, investigate it. The IP could be a proxy, VPN, Tor node, cloud datacenter, or a legitimate IP turned malicious.\n- Determine if the lockout events occurred during the user's regular activity hours. Unusual timing may indicate malicious activity.\n- Examine the authentication methods used during the lockout events by checking the `okta.authentication_context.credential_type` field.\n\n### False positive analysis:\n\n- Determine whether the account owner or an internal user made repeated mistakes in entering their credentials, leading to the account lockout.\n- Ensure there are no known network or application issues that might cause these events.\n\n### Response and remediation:\n\n- Alert the user and your IT department immediately.\n- If unauthorized access is confirmed, initiate your incident response process.\n- Investigate the source of the attack. If a specific machine or network is compromised, additional steps may need to be taken to address the issue.\n- Require the affected user to change their password.\n- If the attack is ongoing, consider blocking the IP address initiating the brute force attack.\n- Implement account lockout policies to limit the impact of brute force attacks.\n- Encourage users to use complex, unique passwords and consider implementing multi-factor authentication.\n- Check if the compromised account was used to access or alter any sensitive data or systems.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-10800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "487ff318-9a8a-4791-b484-443a6ec5cd70",
        "rule_id": "e08ccd49-0380-4b2b-8d71-8000377d6e49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.297Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.action:user.account.lock",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 3
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS Route Table Created",
        "description": "Identifies when an AWS Route Table has been created.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Network Security Monitoring",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Route Tables may be created by a system or network administrators. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Route Table creation by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule. Automated processes that use Terraform may lead to false positives."
        ],
        "references": [
          "https://docs.datadoghq.com/security_platform/default_rules/aws-ec2-route-table-modified/",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_CreateRoute.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_CreateRouteTable"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "406894d8-5fdb-439c-87cf-613cedd5c49e",
        "rule_id": "e12c0318-99b1-44f2-830c-3a38a43207ca",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.542Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.487Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(CreateRoute or CreateRouteTable) and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS RDS Cluster Creation",
        "description": "Identifies the creation of a new Amazon Relational Database Service (RDS) Aurora DB cluster or global database spread across multiple regions.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS RDS",
          "Use Case: Asset Visibility",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Valid clusters may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/create-db-cluster.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_CreateDBCluster.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/create-global-cluster.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_CreateGlobalCluster.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1133",
                "name": "External Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1133/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "abc1886a-7096-4da0-8e26-9e78f775ef9b",
        "rule_id": "e14c5fd7-fdd7-49c2-9e5b-ec49d817bc8d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.545Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.490Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(CreateDBCluster or CreateGlobalCluster) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS Management Console Root Login",
        "description": "Identifies a successful login to the AWS Management Console by the Root user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS Management Console Root Login\n\nThe AWS root account is the one identity that has complete access to all AWS services and resources in the account, which is created when the AWS account is created. AWS strongly recommends that you do not use the root user for your everyday tasks, even the administrative ones. Instead, adhere to the best practice of using the root user only to create your first IAM user. Then securely lock away the root user credentials and use them to perform only a few account and service management tasks. AWS provides a [list of the tasks that require root user](https://docs.aws.amazon.com/general/latest/gr/root-vs-iam.html#aws_tasks-that-require-root).\n\nThis rule looks for attempts to log in to the AWS Management Console as the root user.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Examine whether this activity is common in the environment by looking for past occurrences on your logs.\n- Consider the source IP address and geolocation for the calling user who issued the command. Do they look normal for the calling user?\n- Examine the commands, API calls, and data management actions performed by the account in the last 24 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking access to servers,\nservices, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- The alert can be dismissed if this operation is done under change management and approved according to the organization's policy for performing a task that needs this privilege level.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify the services or servers involved criticality.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify if there are any regulatory or legal ramifications related to this activity.\n- Configure multi-factor authentication for the user.\n- Follow security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Signin",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "It's strongly recommended that the root user is not used for everyday tasks, including the administrative ones. Verify whether the IP address, location, and/or hostname should be logging in as root in your environment. Unfamiliar root logins should be investigated immediately. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8aca70de-9375-4692-9a13-93031dff9627",
        "rule_id": "e2a67480-3b79-403d-96e3-fdd2992c50ef",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.549Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.493Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and aws.cloudtrail.user_identity.type:Root and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS Route53 private hosted zone associated with a VPC",
        "description": "Identifies when a Route53 private hosted zone has been associated with VPC.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Asset Visibility",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "A private hosted zone may be asssociated with a VPC by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/Route53/latest/APIReference/API_AssociateVPCWithHostedZone.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6f4e003b-38e1-45ea-af8d-7c54b98d602b",
        "rule_id": "e3c27562-709a-42bd-82f2-3ed926cced19",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.551Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.497Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:AssociateVPCWithHostedZone and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Data Exfiltration Activity to an Unusual ISO Code",
        "description": "A machine learning job has detected data exfiltration to a particular geo-location (by region name). Data transfers to geo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command and control channels.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Data Exfiltration Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-21600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/ded",
          "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1041",
                "name": "Exfiltration Over C2 Channel",
                "reference": "https://attack.mitre.org/techniques/T1041/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  \n\n### Data Exfiltration Detection Setup\nThe Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. \n\n#### Prerequisite Requirements:\n- Fleet is required for Data Exfiltration Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Network events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) or [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n\n#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "ded",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "262de09e-d5d0-4c0c-afe1-503f25bdf115",
        "rule_id": "e1db8899-97c1-4851-8993-3a3265353601",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.547Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.734Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "ded_high_sent_bytes_destination_geo_country_iso_code"
        ]
      },
      {
        "name": "Attempt to Modify an Okta Network Zone",
        "description": "Detects attempts to modify an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Network Zone\n\nThe modification of an Okta network zone is a critical event as it could potentially allow an adversary to gain unrestricted access to your network. This rule detects attempts to modify, delete, or deactivate an Okta network zone, which may suggest an attempt to remove or weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the network zone modification attempt.\n- Check if there are multiple network zone modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5820217f-bdd2-46be-bb47-972eba5ae804",
        "rule_id": "e48236ca-b67a-4b4e-840c-fdc7782bc0c3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.418Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(zone.update or network_zone.rule.disabled or zone.remove_blacklist)",
        "language": "kuery"
      },
      {
        "name": "Possible Okta DoS Attack",
        "description": "Detects possible Denial of Service (DoS) attacks against an Okta organization. An adversary may attempt to disrupt an organization's business operations by performing a DoS attack against its Okta service.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1498",
                "name": "Network Denial of Service",
                "reference": "https://attack.mitre.org/techniques/T1498/"
              },
              {
                "id": "T1499",
                "name": "Endpoint Denial of Service",
                "reference": "https://attack.mitre.org/techniques/T1499/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "27b5ff34-bb4c-4195-804e-8ec71b60e112",
        "rule_id": "e6e3ecff-03dd-48ec-acbd-54a04de10c68",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.554Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.506Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(application.integration.rate_limit_exceeded or system.org.rate_limit.warning or system.org.rate_limit.violation or core.concurrency.org.limit.violation)",
        "language": "kuery"
      },
      {
        "name": "Potential Credential Access via Memory Dump File Creation",
        "description": "Identifies the creation or modification of a medium size memory dump file which can indicate an attempt to access credentials from a process memory.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.size",
            "type": "long",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c88266fa-a562-4a17-9f92-a2b3cf6e66f1",
        "rule_id": "e707a7be-cc52-41ac-8ab3-d34b38c20005",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.556Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.737Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n\n  /* MDMP header */\n  file.Ext.header_bytes : \"4d444d50*\" and file.size >= 30000 and\n  not\n\n  (\n    (\n      process.name : \"System\" or\n      process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\Wermgr.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\Wermgr.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WUDFHost.exe\",\n        \"C:\\\\Windows\\\\System32\\\\rdrleakdiag.exe\",\n        \"?:\\\\Windows\\\\System32\\\\Taskmgr.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\Taskmgr.exe\",\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Windows\\\\SystemApps\\\\*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Zoom\\\\bin\\\\zCrashReport64.exe\",\n        \"?:\\\\Windows\\\\CCM\\\\ccmdump.exe\"\n      ) and process.code_signature.trusted == true\n    ) or\n    (\n      file.path : (\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\WER\\\\*\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\WDF\\\\*\",\n        \"?:\\\\ProgramData\\\\Alteryx\\\\ErrorLogs\\\\*\",\n        \"?:\\\\ProgramData\\\\Goodix\\\\*\",\n        \"?:\\\\Windows\\\\system32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\CrashDumps\\\\*\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Zoom\\\\logs\\\\zoomcrash*\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\*\\\\Crashpad\\\\*\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\*\\\\crashpaddb\\\\*\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\*\\\\HungReports\\\\*\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\*\\\\CrashDumps\\\\*\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\*\\\\NativeCrashReporting\\\\*\"\n      ) and (process.code_signature.trusted == true or process.executable == null)\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Process For MSSQL Service Accounts",
        "description": "Identifies unusual process executions using MSSQL Service accounts, which can indicate the exploitation/compromise of SQL instances. Attackers may exploit exposed MSSQL instances for initial access or lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/en-us/security/blog/2023/08/24/flax-typhoon-using-legitimate-software-to-quietly-access-taiwanese-organizations/",
          "https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?view=sql-server-ver16"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.001",
                    "name": "SQL Stored Procedures",
                    "reference": "https://attack.mitre.org/techniques/T1505/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e7623ac7-e9d4-4a73-953f-068ca7e1a9e0",
        "rule_id": "e74d645b-fec6-431e-bf93-ca64a538e0de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.558Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.862Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and host.os.type == \"windows\" and\n  user.name : (\n    \"SQLSERVERAGENT\", \"SQLAGENT$*\",\n    \"MSSQLSERVER\", \"MSSQL$*\",\n    \"MSSQLServerOLAPService\",\n    \"ReportServer*\", \"MsDtsServer150\",\n    \"MSSQLFDLauncher*\",\n    \"SQLServer2005SQLBrowserUser$*\",\n    \"SQLWriter\", \"winmgmt\"\n  ) and user.domain : \"NT SERVICE\" and\n  not (\n    (\n      process.name : (\n        \"sqlceip.exe\", \"sqlservr.exe\", \"sqlagent.exe\",\n        \"msmdsrv.exe\", \"ReportingServicesService.exe\",\n        \"MsDtsSrvr.exe\", \"sqlbrowser.exe\", \"DTExec.exe\",\n        \"SQLPS.exe\", \"fdhost.exe\", \"fdlauncher.exe\",\n        \"SqlDumper.exe\", \"sqlsqm.exe\", \"DatabaseMail.exe\",\n        \"ISServerExec.exe\", \"Microsoft.ReportingServices.Portal.WebHost.exe\",\n        \"bcp.exe\", \"SQLCMD.exe\", \"DatabaseMail.exe\"\n      ) or\n      process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n        \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\"\n      )\n    ) and\n    (\n      process.code_signature.subject_name : (\"Microsoft Corporation\", \"Microsoft Windows\") and\n      process.code_signature.trusted == true\n    )\n  ) and\n  not (\n    (process.name : \"cmd.exe\" and process.parent.name : \"sqlservr.exe\") or\n    (process.name : \"cmd.exe\" and process.parent.name : \"forfiles.exe\" and process.command_line : \"/c echo *\")\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "AWS Route Table Modified or Deleted",
        "description": "Identifies when an AWS Route Table has been modified or deleted.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Network Security Monitoring",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Route Table could be modified or deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Route Table being modified from unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule. Also automated processes that use Terraform may lead to false positives."
        ],
        "references": [
          "https://github.com/easttimor/aws-incident-response#network-routing",
          "https://docs.datadoghq.com/security_platform/default_rules/aws-ec2-route-table-modified/",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_ReplaceRoute.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_ReplaceRouteTableAssociation",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteRouteTable.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteRoute.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DisassociateRouteTable.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ef2283ae-88c3-49e9-9be5-d48a73f6d9f6",
        "rule_id": "e7cd5982-17c8-4959-874c-633acde7d426",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.560Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.517Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(ReplaceRoute or ReplaceRouteTableAssociation or\nDeleteRouteTable or DeleteRoute or DisassociateRouteTable) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Service Control Spawned via Script Interpreter",
        "description": "Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services. This can potentially indicate an attempt to elevate privileges or maintain persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Service Control Spawned via Script Interpreter\n\nWindows services are background processes that run with SYSTEM privileges and provide specific functionality or support to other applications and system components.\n\nThe `sc.exe` command line utility is used to manage and control Windows services on a local or remote computer. Attackers may use `sc.exe` to create, modify, and start services to elevate their privileges from administrator to SYSTEM.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the command line, registry changes events, and Windows events related to service activities (for example, 4697 and/or 7045) for suspicious characteristics.\n  - Examine the created and existent services, the executables or drivers referenced, and command line arguments for suspicious entries.\n    - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the referenced files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is not inherently malicious if it occurs in isolation. As long as the analyst did not identify suspicious activity related to the user, host, and service, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  },
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "72d35769-adb4-4c8b-8f33-5dd3660e8cb4",
        "rule_id": "e8571d5f-bea1-46c2-9f56-998de2d3ed95",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.561Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.424Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* This rule is not compatible with Sysmon due to user.id issues */\n\nprocess where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name == \"sc.exe\") and\n  process.parent.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                         \"wmic.exe\", \"mshta.exe\",\"powershell.exe\", \"pwsh.exe\") and\n  process.args:(\"config\", \"create\", \"start\", \"delete\", \"stop\", \"pause\") and\n  /* exclude SYSTEM SID - look for service creations by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "High Number of Okta User Password Reset or Unlock Attempts",
        "description": "Identifies a high number of Okta user password reset or account unlock attempts. An adversary may attempt to obtain unauthorized access to Okta user accounts using these methods and attempt to blend in with normal activity in their target's environment and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Okta User Password Reset or Unlock Attempts\n\nThis rule is designed to detect a suspiciously high number of password reset or account unlock attempts in Okta. Excessive password resets or account unlocks can be indicative of an attacker's attempt to gain unauthorized access to an account.\n\n#### Possible investigation steps:\n- Identify the actor associated with the excessive attempts. The `okta.actor.alternate_id` field can be used for this purpose.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Review the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the password reset or unlock attempts.\n- Review the event actions associated with these attempts. Look at the `event.action` field and filter for actions related to password reset and account unlock attempts.\n- Check for other similar patterns of behavior from the same actor or IP address. If there is a high number of failed login attempts before the password reset or unlock attempts, this may suggest a brute force attack.\n- Also, look at the times when these attempts were made. If these were made during off-hours, it could further suggest an adversary's activity.\n\n### False positive analysis:\n- This alert might be a false positive if there are legitimate reasons for a high number of password reset or unlock attempts. This could be due to the user forgetting their password or account lockouts due to too many incorrect attempts.\n- Check the actor's past behavior. If this is their usual behavior and they have a valid reason for it, then it might be a false positive.\n\n### Response and remediation:\n- If unauthorized attempts are confirmed, initiate the incident response process.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [
          "The number of Okta user password reset or account unlock attempts will likely vary between organizations. To fit this rule to their organization, users can duplicate this rule and edit the schedule and threshold values in the new rule."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a8ee9610-bab1-484f-beb9-704db1535dd2",
        "rule_id": "e90ee3af-45fc-432e-a850-4a58cf14a457",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.567Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.191Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and\n  event.action:(system.email.account_unlock.sent_message or system.email.password_reset.sent_message or\n                system.sms.send_account_unlock_message or system.sms.send_password_reset_message or\n                system.voice.send_account_unlock_call or system.voice.send_password_reset_call or\n                user.account.unlock_token)",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 5
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS EC2 VM Export Failure",
        "description": "Identifies an attempt to export an AWS EC2 instance. A virtual machine (VM) export may indicate an attempt to extract or exfiltrate information.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Asset Visibility",
          "Tactic: Exfiltration",
          "Tactic: Collection"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "VM exports may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. VM exports from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/vm-import/latest/userguide/vmexport.html#export-instance"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1537",
                "name": "Transfer Data to Cloud Account",
                "reference": "https://attack.mitre.org/techniques/T1537/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6e7b331d-d042-4e75-a782-73f70f5f9774",
        "rule_id": "e919611d-6b6f-493b-8314-7ed6ac2e413b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.569Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.524Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:CreateInstanceExportTask and event.outcome:failure",
        "language": "kuery"
      },
      {
        "name": "Spike in Bytes Sent to an External Device via Airdrop",
        "description": "A machine learning job has detected high bytes of data written to an external device via Airdrop. In a typical operational setting, there is usually a predictable pattern or a certain range of data that is written to external devices. An unusually large amount of data being written is anomalous and can signal illicit data copying or transfer activities.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Data Exfiltration Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/ded",
          "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1011",
                "name": "Exfiltration Over Other Network Medium",
                "reference": "https://attack.mitre.org/techniques/T1011/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  \n\n### Data Exfiltration Detection Setup\nThe Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. \n\n#### Prerequisite Requirements:\n- Fleet is required for Data Exfiltration Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- File events collected by the Elastic Defend integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "ded",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "12af7faf-d24c-4146-964f-98d79cf718bf",
        "rule_id": "e92c99b6-c547-4bb6-b244-2f27394bc849",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.570Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.741Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "ded_high_bytes_written_to_external_device_airdrop"
        ]
      },
      {
        "name": "Unusual Process Spawned by a Parent Process",
        "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as malicious in two ways. It was predicted to be malicious by the ProblemChild supervised ML model, and it was found to be an unusual child process name, for the parent process, by an unsupervised ML model. Such a process may be an instance of suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "06dfdb1e-4e23-4935-8dfd-8e9b74a31355",
        "rule_id": "ea09ff26-3902-4c53-bb8e-24b7a5d029dd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.572Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.747Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_rare_process_by_parent"
        ]
      },
      {
        "name": "AWS IAM Brute Force of Assume Role Policy",
        "description": "Identifies a high number of failed attempts to assume an AWS Identity and Access Management (IAM) role. IAM roles are used to delegate access to users or services. An adversary may attempt to enumerate IAM roles in order to determine if a role exists before attempting to assume or hijack the discovered role.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM Brute Force of Assume Role Policy\n\nAn IAM role is an IAM identity that you can create in your account that has specific permissions. An IAM role is similar to an IAM user, in that it is an AWS identity with permission policies that determine what the identity can and cannot do in AWS. However, instead of being uniquely associated with one person, a role is intended to be assumable by anyone who needs it. Also, a role does not have standard long-term credentials such as a password or access keys associated with it. Instead, when you assume a role, it provides you with temporary security credentials for your role session.\n\nAttackers may attempt to enumerate IAM roles in order to determine if a role exists before attempting to assume or hijack the discovered role.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Verify if the `RoleName` parameter contains a unique value in all requests or if the activity is potentially a brute force attack.\n- Verify if the user account successfully updated a trust policy in the last 24 hours.\n- Examine whether this role existed in the environment by looking for past occurrences in your logs.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's commands, API calls, and data management actions in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the roles targeted in the failed attempts, and whether the subject role previously existed in the environment. If only one role was targeted in the requests and that role previously existed, it may be a false positive, since automations can continue targeting roles that existed in the environment in the past and cause false positives (FPs).\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.praetorian.com/blog/aws-iam-assume-role-vulnerabilities",
          "https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.error_code",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "118343ee-c613-437c-8758-5b1ba7bb415c",
        "rule_id": "ea248a02-bc47-4043-8e94-2885b19b2636",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.796Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.527Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:aws.cloudtrail and\n  event.provider:iam.amazonaws.com and event.action:UpdateAssumeRolePolicy and\n  aws.cloudtrail.error_code:MalformedPolicyDocumentException and event.outcome:failure",
        "threshold": {
          "field": [],
          "value": 25
        },
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS RDS Instance/Cluster Stoppage",
        "description": "Identifies that an Amazon Relational Database Service (RDS) cluster or instance has been stopped.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS RDS",
          "Use Case: Asset Visibility",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Valid clusters or instances may be stopped by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster or instance stoppages from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/stop-db-cluster.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_StopDBCluster.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/rds/stop-db-instance.html",
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_StopDBInstance.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4de44f90-8036-4fad-8b71-4b4f7fc88a7c",
        "rule_id": "ecf2b32c-e221-4bd4-aa3b-c7d59b3bc01d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.798Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.540Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(StopDBCluster or StopDBInstance) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Application",
        "description": "Detects attempts to deactivate an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Application\n\nThis rule detects attempts to deactivate an Okta application. Unauthorized deactivation could lead to disruption of services and pose a significant risk to the organization.\n\n#### Possible investigation steps:\n- Identify the actor associated with the deactivation attempt by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Understand the context of the event from the `okta.debug_context.debug_data` and `okta.authentication_context` fields.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Analyze the `okta.transaction.id` and `okta.transaction.type` fields to understand the context of the transaction.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity, performed by an authorized person, or if the `okta.outcome.result` field shows a failure.\n- An unsuccessful attempt might also indicate an authorized user having trouble rather than a malicious activity.\n\n### Response and remediation:\n- If unauthorized deactivation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated application was crucial for business operations, coordinate with the relevant team to reactivate it and minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deactivated and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7ab6a2b2-7cbf-4938-9fd6-38c6ac289bfd",
        "rule_id": "edb91186-1c7e-4db8-b53e-bfa33a1a0a8a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.800Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.444Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Administrator Role Assigned to an Okta User",
        "description": "Identifies when an administrator role is assigned to an Okta user. An adversary may attempt to assign an administrator role to an Okta user in order to assign additional permissions to a user account and maintain access to their target's environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Data Source: Okta",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f5ba22ee-60b3-4f04-bde6-b030528328d8",
        "rule_id": "f06414a6-f2a4-466d-8eba-10f85e8abf71",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.801Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.555Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.account.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "Image File Execution Options Injection",
        "description": "The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing a different process to be executed. This functionality can be abused by an adversary to establish persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.012",
                    "name": "Image File Execution Options Injection",
                    "reference": "https://attack.mitre.org/techniques/T1546/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b45f364e-3a9a-4d4c-9300-733ef1efc212",
        "rule_id": "6839c821-011d-43bd-bd5b-acff00257226",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.808Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.540Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : (\"Debugger\", \"MonitorProcess\") and length(registry.data.strings) > 0 and\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\"\n  ) and\n    /* add FPs here */\n  not registry.data.strings regex~ (\"\"\"C:\\\\Program Files( \\(x86\\))?\\\\ThinKiosk\\\\thinkiosk\\.exe\"\"\", \"\"\".*\\\\PSAppDeployToolkit\\\\.*\"\"\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Executable File with Unusual Extension",
        "description": "Identifies the creation or modification of an executable file with an unexpected file extension. Attackers may attempt to evade detection by masquerading files using the file extension values used by image, audio, or document file types.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.008",
                    "name": "Masquerade File Type",
                    "reference": "https://attack.mitre.org/techniques/T1036/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "332ce03d-297a-4442-a860-85ed646fab49",
        "rule_id": "ecd4857b-5bac-455e-a7c9-a88b66e56a9e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.823Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.750Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n\n /* MZ header or its common base64 equivalent TVqQ */\n file.Ext.header_bytes : (\"4d5a*\", \"54567151*\") and\n\n (\n   /* common image file extensions */\n   file.extension : (\"jpg\", \"jpeg\", \"emf\", \"tiff\", \"gif\", \"png\", \"bmp\", \"fpx\", \"eps\", \"svg\", \"inf\") or\n\n   /* common audio and video file extensions */\n   file.extension : (\"mp3\", \"wav\", \"avi\", \"mpeg\", \"flv\", \"wma\", \"wmv\", \"mov\", \"mp4\", \"3gp\") or\n\n   /* common document file extensions */\n   file.extension : (\"txt\", \"pdf\", \"doc\", \"docx\", \"rtf\", \"ppt\", \"pptx\", \"xls\", \"xlsx\", \"hwp\", \"html\")\n  ) and\n  not process.pid == 4 and\n  not process.executable : \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Client Server Security Agent\\\\Ntrtscan.exe\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Data Exfiltration Activity to an Unusual Destination Port",
        "description": "A machine learning job has detected data exfiltration to a particular destination port. Data transfer patterns that are outside the normal traffic patterns of an organization could indicate exfiltration over command and control channels.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Use Case: Data Exfiltration Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-21600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/ded",
          "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1041",
                "name": "Exfiltration Over C2 Channel",
                "reference": "https://attack.mitre.org/techniques/T1041/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  \n\n### Data Exfiltration Detection Setup\nThe Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. \n\n#### Prerequisite Requirements:\n- Fleet is required for Data Exfiltration Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Network events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) or [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration.\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n\n#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "ded",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "32be2d0f-5c64-454e-b1b2-a5676a1b6e25",
        "rule_id": "ef8cc01c-fc49-4954-a175-98569c646740",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.824Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.761Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "ded_high_sent_bytes_destination_port"
        ]
      },
      {
        "name": "Attempt to Modify an Okta Policy",
        "description": "Detects attempts to modify an Okta policy. An adversary may attempt to modify an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to modify an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy\n\nModifications to Okta policies may indicate attempts to weaken an organization's security controls. If such an attempt is detected, consider the following steps for investigation.\n\n#### Possible investigation steps:\n- Identify the actor associated with the event. Check the fields `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name`.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Check the nature of the policy modification. You can review the `okta.target` field, especially `okta.target.display_name` and `okta.target.id`.\n- Examine the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the modification attempt.\n- Check if there have been other similar modification attempts in a short time span from the same actor or IP address.\n\n### False positive analysis:\n- This alert might be a false positive if Okta policies are regularly updated in your organization as a part of normal operations.\n- Check if the actor associated with the event has legitimate rights to modify the Okta policies.\n- Verify the actor's geographical location and the time of the modification attempt. If these align with the actor's regular behavior, it could be a false positive.\n\n### Response and remediation:\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Lock the actor's account and enforce password change as an immediate response.\n- Reset MFA tokens for the actor and enforce re-enrollment, if applicable.\n- Review any other actions taken by the actor to assess the overall impact.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly modified in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0da0ce7d-04e3-41a2-a435-9ed575465ef0",
        "rule_id": "6731fbf2-8f28-49ed-9ab9-9a918ceb5a45",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.803Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.422Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Attempt to Revoke Okta API Token",
        "description": "Identifies attempts to revoke an Okta API token. An adversary may attempt to revoke or delete an Okta API token to disrupt an organization's business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Revoke Okta API Token\n\nThe rule alerts when attempts are made to revoke an Okta API token. The API tokens are critical for integration services, and revoking them may lead to disruption in services. Therefore, it's important to validate these activities.\n\n#### Possible investigation steps:\n- Identify the actor associated with the API token revocation attempt. You can use the `okta.actor.alternate_id` field for this purpose.\n- Determine the client used by the actor. Review the `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context` fields.\n- Verify if the API token revocation was authorized or part of some planned activity.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Analyze the past activities of the actor involved in this action. An actor who usually performs such activities may indicate a legitimate reason.\n- Evaluate the actions that happened just before and after this event. It can help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity or was performed by an authorized person.\n\n### Response and remediation:\n- If unauthorized revocation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the revoked token was used for critical integrations, coordinate with the relevant team to minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of revoking Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "00bbddf2-f10d-4bd6-ab7e-d4256268710b",
        "rule_id": "676cff2b-450b-4cf1-8ed2-c0c58a4a2dd7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:06.821Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.426Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.revoke",
        "language": "kuery"
      },
      {
        "name": "Okta ThreatInsight Threat Suspected Promotion",
        "description": "Okta ThreatInsight is a feature that provides valuable debug data regarding authentication and authorization processes, which is logged in the system. Within this data, there is a specific field called threat_suspected, which represents Okta's internal evaluation of the authentication or authorization workflow. When this field is set to True, it suggests the presence of potential credential access techniques, such as password-spraying, brute-forcing, replay attacks, and other similar threats.",
        "risk_score": 47,
        "severity": "medium",
        "rule_name_override": "okta.display_message",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThis is a promotion rule for Okta ThreatInsight suspected threat events, which are alertable events per the vendor.\nConsult vendor documentation on interpreting specific events.",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "low",
            "value": "LOW"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "medium",
            "value": "MEDIUM"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "high",
            "value": "HIGH"
          }
        ],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://help.okta.com/en-us/Content/Topics/Security/threat-insight/configure-threatinsight-system-log.html",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.debug_context.debug_data.threat_suspected",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "0d8744c8-bdce-4029-8b5e-fe2fdbe0c341",
        "rule_id": "6885d2ae-e008-4762-b98a-e8e1cd3a81e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.341Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.374Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and (event.action:security.threat.detected or okta.debug_context.debug_data.threat_suspected: true)",
        "language": "kuery"
      },
      {
        "name": "Command Shell Activity Started via RunDLL32",
        "description": "Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Microsoft Windows installers leveraging RunDLL32 for installation."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "357c90df-10b8-4cfb-bced-8a71d3c1ddf5",
        "rule_id": "9ccf3ce0-0057-440a-91f5-870c6ad39093",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.346Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.304Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"cmd.exe\", \"powershell.exe\") and\n  process.parent.name : \"rundll32.exe\" and process.parent.command_line != null and\n  /* common FPs can be added here */\n  not process.parent.args : (\"C:\\\\Windows\\\\System32\\\\SHELL32.dll,RunAsNewUser_RunDLL\",\n                             \"C:\\\\WINDOWS\\\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Hosts File Modified",
        "description": "The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the first point of lookup for DNS hostname resolution so if adversaries can modify the endpoint hosts file, they can route traffic to malicious infrastructure. This rule detects modifications to the hosts file on Microsoft Windows, Linux (Ubuntu or RHEL) and macOS systems.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "4d4c0b59-ea83-483f-b8c1-8c360ee53c5c",
        "timeline_title": "Comprehensive File Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Hosts File Modified\n\nOperating systems use the hosts file to map a connection between an IP address and domain names before going to domain name servers. Attackers can abuse this mechanism to route traffic to malicious infrastructure or disrupt security that depends on server communications. For example, Russian threat actors modified this file on a domain controller to redirect Duo MFA calls to localhost instead of the Duo server, which prevented the MFA service from contacting its server to validate MFA login. This effectively disabled MFA for active domain accounts because the default policy of Duo for Windows is to \"Fail open\" if the MFA server is unreachable. This can happen in any MFA implementation and is not exclusive to Duo. Find more details in this [CISA Alert](https://www.cisa.gov/uscert/ncas/alerts/aa22-074a).\n\nThis rule identifies modifications in the hosts file across multiple operating systems using process creation events for Linux and file events in Windows and macOS.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as role, criticality, and associated users.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the changes to the hosts file by comparing it against file backups, volume shadow copies, and other restoration mechanisms.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and the configuration was justified.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of the administrator account that performed the action.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/auditbeat/current/auditbeat-reference-yml.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1565",
                "name": "Data Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1565/",
                "subtechnique": [
                  {
                    "id": "T1565.001",
                    "name": "Stored Data Manipulation",
                    "reference": "https://attack.mitre.org/techniques/T1565/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nFor Windows systems using Auditbeat, this rule requires adding `C:/Windows/System32/drivers/etc` as an additional path in the 'file_integrity' module of auditbeat.yml.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9f05590e-b367-43dc-8a77-8115e594f829",
        "rule_id": "9c260313-c811-4ec8-ab89-8f6530e0246c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.348Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.301Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where\n\n  /* file events for creation; file change events are not captured by some of the included sources for linux and so may\n     miss this, which is the purpose of the process + command line args logic below */\n  (\n   event.category == \"file\" and event.type in (\"change\", \"creation\") and\n     file.path : (\"/private/etc/hosts\", \"/etc/hosts\", \"?:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts\") and \n     not process.name in (\"dockerd\", \"rootlesskit\", \"podman\", \"crio\")\n  )\n  or\n\n  /* process events for change targeting linux only */\n  (\n   event.category == \"process\" and event.type in (\"start\") and\n     process.name in (\"nano\", \"vim\", \"vi\", \"emacs\", \"echo\", \"sed\") and\n     process.args : (\"/etc/hosts\") and \n     not process.parent.name in (\"dhclient-script\", \"google_set_hostname\")\n  )",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "winlogbeat-*",
          "logs-endpoint.events.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via WMI Event Subscription",
        "description": "An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to an event and execute arbitrary code when that event occurs, providing persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.003",
                    "name": "Windows Management Instrumentation Event Subscription",
                    "reference": "https://attack.mitre.org/techniques/T1546/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "94107c85-2971-466c-96ba-be19ce04f98b",
        "rule_id": "9b6813a1-daf1-457e-b0e6-0bb4e55b8a4c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.350Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.298Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"create\" and\n  process.args : (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Scheduled Tasks AT Command Enabled",
        "description": "Identifies attempts to enable the Windows scheduled tasks AT command via the registry. Attackers may use this method to move laterally or persist locally. The AT command has been deprecated since Windows 8 and Windows Server 2012, but still exists for backwards compatibility.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-scheduledjob"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.002",
                    "name": "At",
                    "reference": "https://attack.mitre.org/techniques/T1053/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6ac1c06a-d283-4e4f-be58-7ce2876e143e",
        "rule_id": "9aa0e1f6-52ce-42e1-abb3-09657cee2698",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.352Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.294Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\"\n  ) and registry.data.strings : (\"1\", \"0x00000001\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Scheduled Task Created by a Windows Script",
        "description": "A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by an adversary to establish persistence.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDecode the base64 encoded Tasks Actions registry value to investigate the task's configured action.",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c26a591e-96f7-4b2e-9017-d26fec7d575b",
        "rule_id": "689b9d57-e4d5-4357-ad17-9c334609d79a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.372Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.378Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 30s\n  [any where host.os.type == \"windows\" and \n    (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n    (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and\n    process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"\n  )]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS CloudWatch Log Group Deletion",
        "description": "Identifies the deletion of a specified AWS CloudWatch log group. When a log group is deleted, all the archived log events associated with the log group are also permanently deleted.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudWatch Log Group Deletion\n\nAmazon CloudWatch is a monitoring and observability service that collects monitoring and operational data in the form of logs, metrics, and events for resources and applications. This data can be used to detect anomalous behavior in your environments, set alarms, visualize logs and metrics side by side, take automated actions, troubleshoot issues, and discover insights to keep your applications running smoothly.\n\nA log group is a group of log streams that share the same retention, monitoring, and access control settings. You can define log groups and specify which streams to put into each group. There is no limit on the number of log streams that can belong to one log group.\n\nThis rule looks for the deletion of a log group using the API `DeleteLogGroup` action. Attackers can do this to cover their tracks and impact security monitoring that relies on these sources.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log group's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS CloudWatch",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Log group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/logs/delete-log-group.html",
          "https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DeleteLogGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3f812a47-f0ae-4f47-a24c-51c41849bb49",
        "rule_id": "68a7a5a5-a2fc-4a76-ba9f-26849de881b4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.374Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.381Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogGroup and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS KMS Customer Managed Key Disabled or Scheduled for Deletion",
        "description": "Identifies attempts to disable or schedule the deletion of an AWS KMS Customer Managed Key (CMK). Deleting an AWS KMS key is destructive and potentially dangerous. It deletes the key material and all metadata associated with the KMS key and is irreversible. After a KMS key is deleted, the data that was encrypted under that KMS key can no longer be decrypted, which means that data becomes unrecoverable.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS KMS",
          "Use Case: Log Auditing",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Xavier Pich"
        ],
        "false_positives": [
          "A KMS customer managed key may be disabled or scheduled for deletion by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Key deletions by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/cli/latest/reference/kms/disable-key.html",
          "https://docs.aws.amazon.com/cli/latest/reference/kms/schedule-key-deletion.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dd8828a6-b062-4b9d-ab0a-62a1a1c2f9ec",
        "rule_id": "6951f15e-533c-4a60-8014-a3c3ab851a1b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.376Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.384Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:kms.amazonaws.com and event.action:(\"DisableKey\" or \"ScheduleKeyDeletion\") and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS IAM Password Recovery Requested",
        "description": "Identifies AWS IAM password recovery requests. An adversary may attempt to gain unauthorized AWS access by abusing password recovery mechanisms.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Signin",
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be requesting changes in your environment. Password reset attempts from unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://www.cadosecurity.com/an-ongoing-aws-phishing-campaign/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5a59918e-b307-491e-8041-d3b10de3233b",
        "rule_id": "69c420e8-6c9e-4d28-86c0-8a2be2d1e78c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.377Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.391Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:PasswordRecoveryRequested and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "AWS RDS Instance Creation",
        "description": "Identifies the creation of an Amazon Relational Database Service (RDS) Aurora database instance.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS RDS",
          "Use Case: Asset Visibility",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A database instance may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Instances creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_CreateDBInstance.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1df83edf-627b-4cea-ae72-eba7f13d955a",
        "rule_id": "f30f3443-4fbb-4c27-ab89-c3ad49d62315",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.379Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.569Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:CreateDBInstance and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "WMI Incoming Lateral Movement",
        "description": "Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "7f66aae1-653e-458f-88f2-a2c7d89c214c",
        "rule_id": "f3475224-b179-4f78-8877-c2bd64c26b88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.383Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.210Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 2s\n\n /* Accepted Incoming RPC connection by Winmgmt service */\n\n  [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and network.direction : (\"incoming\", \"ingress\") and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\" and source.port >= 49152 and destination.port >= 49152\n  ]\n\n  /* Excluding Common FPs Nessus and SCCM */\n\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"WmiPrvSE.exe\" and\n   not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n   not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n   not process.executable :\n               (\"?:\\\\Program Files\\\\HPWBEM\\\\Tools\\\\hpsum_swdiscovery.exe\",\n                \"?:\\\\Windows\\\\CCM\\\\Ccm32BitLauncher.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\mofcomp.exe\",\n                \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\csc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\powercfg.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"REBOOT=ReallySuppress\") and\n   not (process.executable : \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\appcmd.exe\" and process.args : \"uninstall\")\n   ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Machine Learning Detected a DNS Request Predicted to be a DGA Domain",
        "description": "A supervised machine learning model has identified a DNS question name that is predicted to be the result of a Domain Generation Algorithm (DGA), which could indicate command and control network activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Network",
          "Domain: Endpoint",
          "Data Source: Elastic Defend",
          "Use Case: Domain Generation Algorithm Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/dga",
          "https://www.elastic.co/security-labs/detect-domain-generation-algorithm-activity-with-new-kibana-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1568",
                "name": "Dynamic Resolution",
                "reference": "https://attack.mitre.org/techniques/T1568/",
                "subtechnique": [
                  {
                    "id": "T1568.002",
                    "name": "Domain Generation Algorithms",
                    "reference": "https://attack.mitre.org/techniques/T1568/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Domain Generation Algorithm (DGA) Detection integration assets to be installed, as well as DNS events collected by integrations such as Elastic Defend, Network Packet Capture, or Packetbeat.  \n\n### DGA Detection Setup\nThe DGA Detection integration consists of an ML-based framework to detect DGA activity in DNS events.\n\n#### Prerequisite Requirements:\n- Fleet is required for DGA Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- DNS events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint), [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration, or [Packetbeat](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n- To set up and run Packetbeat, follow [this](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html) guide.\n\n#### The following steps should be executed to install assets associated with the DGA Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Domain Generation Algorithm Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Configure the ingest pipeline**.\n",
        "related_integrations": [
          {
            "package": "dga",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.registered_domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "ml_is_dga.malicious_prediction",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "11340d89-c44d-4abe-ad18-1446e3e04daf",
        "rule_id": "f3403393-1fd9-4686-8f6e-596c58bc00b4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.381Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.768Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*",
          "logs-network_traffic.*"
        ],
        "filters": [],
        "query": "ml_is_dga.malicious_prediction:1 and not dns.question.registered_domain:avsvmcloud.com",
        "language": "kuery"
      },
      {
        "name": "WRITEDAC Access on Active Directory Object",
        "description": "Identifies the access on an object with WRITEDAC permissions. With the WRITEDAC permission, the user can perform a Write Discretionary Access Control List (WriteDACL) operation, which is used to modify the access control rules associated with a specific object within Active Directory. Attackers may abuse this privilege to grant themselves or other compromised accounts additional rights, ultimately compromising the target object, resulting in privilege escalation, lateral movement, and persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.blackhat.com/docs/us-17/wednesday/us-17-Robbins-An-ACE-Up-The-Sleeve-Designing-Active-Directory-DACL-Backdoors.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.001",
                    "name": "Windows File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "5c11858c-b840-40d5-8e70-00759f9eb5bb",
        "rule_id": "f5861570-e39a-4b8a-9259-abd39f84cb97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.384Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.897Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "host.os.type: \"windows\" and event.action : (\"Directory Service Access\" or \"object-operation-performed\") and\n  event.code : \"4662\" and winlog.event_data.AccessMask:\"0x40000\"",
        "language": "kuery"
      },
      {
        "name": "WMIC Remote Command",
        "description": "Identifies the use of wmic.exe to run commands on remote hosts. While this can be used by administrators legitimately, attackers can abuse this built-in utility to achieve lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7df8e8c0-ed42-435e-82e3-8aece560bc1c",
        "rule_id": "f59668de-caa0-4b84-94c1-3a1549e1e798",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.386Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.903Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"WMIC.exe\" and\n  process.args : \"*node:*\" and\n  process.args : (\"call\", \"set\", \"get\") and\n  not process.args : (\"*/node:localhost*\", \"*/node:\\\"127.0.0.1\\\"*\", \"/node:127.0.0.1\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Windows Process Cluster Spawned by a Parent Process",
        "description": "A machine learning job combination has detected a set of one or more suspicious Windows processes with unusually high scores for malicious probability. These process(es) have been classified as malicious in several ways. The process(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of suspicious processes, each process has the same parent process name, and the aggregate score of the event cluster was calculated to be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "1299a230-b1c8-4a81-94ad-d4cd251fd768",
        "rule_id": "f5d9d36d-7c30-4cdb-a856-9f653c13d4e0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.388Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.771Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_high_sum_by_parent"
        ]
      },
      {
        "name": "AWS CloudWatch Alarm Deletion",
        "description": "Identifies the deletion of an AWS CloudWatch alarm. An adversary may delete alarms in an attempt to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudWatch Alarm Deletion\n\nAmazon CloudWatch is a monitoring and observability service that collects monitoring and operational data in the form of\nlogs, metrics, and events for resources and applications. This data can be used to detect anomalous behavior in your environments, set alarms, visualize\nlogs and metrics side by side, take automated actions, troubleshoot issues, and discover insights to keep your\napplications running smoothly.\n\nCloudWatch Alarms is a feature that allows you to watch CloudWatch metrics and to receive notifications when the metrics\nfall outside of the levels (high or low thresholds) that you configure.\n\nThis rule looks for the deletion of a alarm using the API `DeleteAlarms` action. Attackers can do this to cover their\ntracks and evade security defenses.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if there is a justification for this behavior.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Alarm deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudwatch/delete-alarms.html",
          "https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_DeleteAlarms.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0605eecc-e0ed-42c1-a9c2-563914dc0ab8",
        "rule_id": "f772ec8a-e182-483c-91d2-72058f76a44c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.390Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.585Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:monitoring.amazonaws.com and event.action:DeleteAlarms and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious Activity Reported by Okta User",
        "description": "Detects when a user reports suspicious activity for their Okta account. These events should be investigated, as they can help security teams identify when an adversary is attempting to gain access to their network.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A user may report suspicious activity on their Okta account in error."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3c438ed2-2571-49f6-865f-1b5efa7b2a5f",
        "rule_id": "f994964f-6fce-4d75-8e79-e16ccc412588",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.392Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.595Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.account.report_suspicious_activity_by_enduser",
        "language": "kuery"
      },
      {
        "name": "Network Connection via Registration Utility",
        "description": "Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection. This may be indicative of an attacker bypassing allowlists or running arbitrary scripts via a signed Microsoft binary.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Registration Utility\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity such as masquerading, and deserve further investigation.\n\nThis rule looks for the execution of `regsvr32.exe`, `RegAsm.exe`, or `RegSvcs.exe` utilities followed by a network connection to an external address. Attackers can abuse utilities to execute malicious files or masquerade as those utilities in order to bypass detections and evade defenses.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of destination IP address and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security testing may produce events like this. Activity of this kind performed by non-engineers and ordinary users is unusual."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.009",
                    "name": "Regsvcs/Regasm",
                    "reference": "https://attack.mitre.org/techniques/T1218/009/"
                  },
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "519695dd-c630-494b-b726-ab936a3f31c0",
        "rule_id": "fb02b8d3-71ee-4af1-bacd-215d23f17efa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.395Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.350Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\") and\n   not (\n         (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n         (process.parent.name : \"msiexec.exe\" or process.parent.executable : (\"C:\\\\Program Files (x86)\\\\*.exe\", \"C:\\\\Program Files\\\\*.exe\"))\n       )\n   ]\n  [network where host.os.type == \"windows\" and process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\")  and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and network.protocol != \"dns\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Masquerading as System32 DLL",
        "description": "Identifies suspicious instances of default system32 DLLs either unsigned or signed with non-MS certificates. This can potentially indicate the attempt to masquerade as system DLLs, perform DLL Search Order Hijacking or backdoor and resign legitimate DLLs.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "Data Source: Elastic Defend",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  },
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  },
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.Ext.relative_file_creation_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6d0a458d-dc62-4187-afd7-2f298256f789",
        "rule_id": "fb01d790-9f74-4e76-97dd-b4b0f7bf6435",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.394Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.977Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where event.action == \"load\" and dll.Ext.relative_file_creation_time <= 3600 and\n    not (\n      dll.path : (\n        \"?:\\\\Windows\\\\System32\\\\*\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\*\",\n        \"?:\\\\Windows\\\\SystemTemp\\\\*\",\n        \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSxS\\\\*\",\n        \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\System32\\\\*\",\n        \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\*\",\n        \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\",\n        \"?:\\\\Windows\\\\WinSxS\\\\*\",\n        \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\",\n        \"?:\\\\Windows\\\\assembly\\\\NativeImages_v*\"\n      )\n    ) and\n    not (\n      dll.code_signature.subject_name in (\n        \"Microsoft Windows\",\n        \"Microsoft Corporation\",\n        \"Microsoft Windows Hardware Abstraction Layer Publisher\",\n        \"Microsoft Windows Publisher\",\n        \"Microsoft Windows 3rd party Component\",\n        \"Microsoft 3rd Party Application Component\"\n      ) and dll.code_signature.trusted == true\n    ) and not dll.code_signature.status : (\"errorCode_endpoint*\", \"errorUntrustedRoot\", \"errorChaining\") and\n    dll.name : (\n      \"aadauthhelper.dll\", \"aadcloudap.dll\", \"aadjcsp.dll\", \"aadtb.dll\", \"aadwamextension.dll\", \"aarsvc.dll\", \"abovelockapphost.dll\", \"accessibilitycpl.dll\", \"accountaccessor.dll\", \"accountsrt.dll\", \"acgenral.dll\", \"aclayers.dll\", \"acledit.dll\", \"aclui.dll\", \"acmigration.dll\", \"acppage.dll\", \"acproxy.dll\", \"acspecfc.dll\", \"actioncenter.dll\", \"actioncentercpl.dll\", \"actionqueue.dll\", \"activationclient.dll\", \"activeds.dll\", \"activesynccsp.dll\", \"actxprxy.dll\", \"acwinrt.dll\", \"acxtrnal.dll\", \"adaptivecards.dll\", \"addressparser.dll\", \"adhapi.dll\", \"adhsvc.dll\", \"admtmpl.dll\", \"adprovider.dll\", \"adrclient.dll\", \"adsldp.dll\", \"adsldpc.dll\", \"adsmsext.dll\", \"adsnt.dll\", \"adtschema.dll\", \"advancedemojids.dll\", \"advapi32.dll\", \"advapi32res.dll\", \"advpack.dll\", \"aeevts.dll\", \"aeinv.dll\", \"aepic.dll\", \"ajrouter.dll\", \"altspace.dll\", \"amsi.dll\", \"amsiproxy.dll\", \"amstream.dll\", \"apds.dll\", \"aphostclient.dll\", \"aphostres.dll\", \"aphostservice.dll\", \"apisampling.dll\", \"apisetschema.dll\", \"apmon.dll\", \"apmonui.dll\", \"appcontracts.dll\", \"appextension.dll\", \"apphelp.dll\", \"apphlpdm.dll\", \"appidapi.dll\", \"appidsvc.dll\", \"appinfo.dll\", \"appinfoext.dll\", \"applicationframe.dll\", \"applockercsp.dll\", \"appmgmts.dll\", \"appmgr.dll\", \"appmon.dll\", \"appointmentapis.dll\", \"appraiser.dll\", \"appreadiness.dll\", \"apprepapi.dll\", \"appresolver.dll\", \"appsruprov.dll\", \"appvcatalog.dll\", \"appvclientps.dll\", \"appvetwclientres.dll\", \"appvintegration.dll\", \"appvmanifest.dll\", \"appvpolicy.dll\", \"appvpublishing.dll\", \"appvreporting.dll\", \"appvscripting.dll\", \"appvsentinel.dll\", \"appvstreamingux.dll\", \"appvstreammap.dll\", \"appvterminator.dll\", \"appxalluserstore.dll\", \"appxpackaging.dll\", \"appxsip.dll\", \"appxsysprep.dll\", \"archiveint.dll\", \"asferror.dll\", \"aspnet_counters.dll\", \"asycfilt.dll\", \"atl.dll\", \"atlthunk.dll\", \"atmlib.dll\", \"audioeng.dll\", \"audiohandlers.dll\", \"audiokse.dll\", \"audioses.dll\", \"audiosrv.dll\", \"auditcse.dll\", \"auditpolcore.dll\", \"auditpolmsg.dll\", \"authbroker.dll\", \"authbrokerui.dll\", \"authentication.dll\", \"authext.dll\", \"authfwcfg.dll\", \"authfwgp.dll\", \"authfwsnapin.dll\", \"authfwwizfwk.dll\", \"authhostproxy.dll\", \"authui.dll\", \"authz.dll\", \"autopilot.dll\", \"autopilotdiag.dll\", \"autoplay.dll\", \"autotimesvc.dll\", \"avicap32.dll\", \"avifil32.dll\", \"avrt.dll\", \"axinstsv.dll\", \"azroles.dll\", \"azroleui.dll\", \"azsqlext.dll\", \"basecsp.dll\", \"basesrv.dll\", \"batmeter.dll\", \"bcastdvrbroker.dll\", \"bcastdvrclient.dll\", \"bcastdvrcommon.dll\", \"bcd.dll\", \"bcdprov.dll\", \"bcdsrv.dll\", \"bcp47langs.dll\", \"bcp47mrm.dll\", \"bcrypt.dll\", \"bcryptprimitives.dll\", \"bdehdcfglib.dll\", \"bderepair.dll\", \"bdesvc.dll\", \"bdesysprep.dll\", \"bdeui.dll\", \"bfe.dll\", \"bi.dll\", \"bidispl.dll\", \"bindfltapi.dll\", \"bingasds.dll\", \"bingfilterds.dll\", \"bingmaps.dll\", \"biocredprov.dll\", \"bisrv.dll\", \"bitlockercsp.dll\", \"bitsigd.dll\", \"bitsperf.dll\", \"bitsproxy.dll\", \"biwinrt.dll\", \"blbevents.dll\", \"blbres.dll\", \"blb_ps.dll\", \"bluetoothapis.dll\", \"bnmanager.dll\", \"bootmenuux.dll\", \"bootstr.dll\", \"bootux.dll\", \"bootvid.dll\", \"bridgeres.dll\", \"brokerlib.dll\", \"browcli.dll\", \"browserbroker.dll\", \"browseui.dll\", \"btagservice.dll\", \"bthavctpsvc.dll\", \"bthavrcp.dll\", \"bthavrcpappsvc.dll\", \"bthci.dll\", \"bthpanapi.dll\", \"bthradiomedia.dll\", \"bthserv.dll\", \"bthtelemetry.dll\", \"btpanui.dll\", \"bwcontexthandler.dll\", \"cabapi.dll\", \"cabinet.dll\", \"cabview.dll\", \"callbuttons.dll\", \"cameracaptureui.dll\", \"capauthz.dll\", \"capiprovider.dll\", \"capisp.dll\", \"captureservice.dll\", \"castingshellext.dll\", \"castlaunch.dll\", \"catsrv.dll\", \"catsrvps.dll\", \"catsrvut.dll\", \"cbdhsvc.dll\", \"cca.dll\", \"cdd.dll\", \"cdosys.dll\", \"cdp.dll\", \"cdprt.dll\", \"cdpsvc.dll\", \"cdpusersvc.dll\", \"cemapi.dll\", \"certca.dll\", \"certcli.dll\", \"certcredprovider.dll\", \"certenc.dll\", \"certenroll.dll\", \"certenrollui.dll\", \"certmgr.dll\", \"certpkicmdlet.dll\", \"certpoleng.dll\", \"certprop.dll\", \"cewmdm.dll\", \"cfgbkend.dll\", \"cfgmgr32.dll\", \"cfgspcellular.dll\", \"cfgsppolicy.dll\", \"cflapi.dll\", \"cfmifs.dll\", \"cfmifsproxy.dll\", \"chakra.dll\", \"chakradiag.dll\", \"chakrathunk.dll\", \"chartv.dll\", \"chatapis.dll\", \"chkwudrv.dll\", \"chsstrokeds.dll\", \"chtbopomofods.dll\", \"chtcangjieds.dll\", \"chthkstrokeds.dll\", \"chtquickds.dll\", \"chxapds.dll\", \"chxdecoder.dll\", \"chxhapds.dll\", \"chxinputrouter.dll\", \"chxranker.dll\", \"ci.dll\", \"cic.dll\", \"cimfs.dll\", \"circoinst.dll\", \"ciwmi.dll\", \"clb.dll\", \"clbcatq.dll\", \"cldapi.dll\", \"cleanpccsp.dll\", \"clfsw32.dll\", \"cliconfg.dll\", \"clipboardserver.dll\", \"clipc.dll\", \"clipsvc.dll\", \"clipwinrt.dll\", \"cloudap.dll\", \"cloudidsvc.dll\", \"clrhost.dll\", \"clusapi.dll\", \"cmcfg32.dll\", \"cmdext.dll\", \"cmdial32.dll\", \"cmgrcspps.dll\", \"cmifw.dll\", \"cmintegrator.dll\", \"cmlua.dll\", \"cmpbk32.dll\", \"cmstplua.dll\", \"cmutil.dll\", \"cngcredui.dll\", \"cngprovider.dll\", \"cnvfat.dll\", \"cofiredm.dll\", \"colbact.dll\", \"colorcnv.dll\", \"colorui.dll\", \"combase.dll\", \"comcat.dll\", \"comctl32.dll\", \"comdlg32.dll\", \"coml2.dll\", \"comppkgsup.dll\", \"compstui.dll\", \"computecore.dll\", \"computenetwork.dll\", \"computestorage.dll\", \"comrepl.dll\", \"comres.dll\", \"comsnap.dll\", \"comsvcs.dll\", \"comuid.dll\", \"configmanager2.dll\", \"conhostv1.dll\", \"connect.dll\", \"consentux.dll\", \"consentuxclient.dll\", \"console.dll\", \"consolelogon.dll\", \"contactapis.dll\", \"container.dll\", \"coredpus.dll\", \"coreglobconfig.dll\", \"coremas.dll\", \"coremessaging.dll\", \"coremmres.dll\", \"coreshell.dll\", \"coreshellapi.dll\", \"coreuicomponents.dll\", \"correngine.dll\", \"courtesyengine.dll\", \"cpfilters.dll\", \"creddialogbroker.dll\", \"credprovhelper.dll\", \"credprovhost.dll\", \"credprovs.dll\", \"credprovslegacy.dll\", \"credssp.dll\", \"credui.dll\", \"crypt32.dll\", \"cryptbase.dll\", \"cryptcatsvc.dll\", \"cryptdlg.dll\", \"cryptdll.dll\", \"cryptext.dll\", \"cryptnet.dll\", \"cryptngc.dll\", \"cryptowinrt.dll\", \"cryptsp.dll\", \"cryptsvc.dll\", \"crypttpmeksvc.dll\", \"cryptui.dll\", \"cryptuiwizard.dll\", \"cryptxml.dll\", \"cscapi.dll\", \"cscdll.dll\", \"cscmig.dll\", \"cscobj.dll\", \"cscsvc.dll\", \"cscui.dll\", \"csplte.dll\", \"cspproxy.dll\", \"csrsrv.dll\", \"cxcredprov.dll\", \"c_g18030.dll\", \"c_gsm7.dll\", \"c_is2022.dll\", \"c_iscii.dll\", \"d2d1.dll\", \"d3d10.dll\", \"d3d10core.dll\", \"d3d10level9.dll\", \"d3d10warp.dll\", \"d3d10_1.dll\", \"d3d10_1core.dll\", \"d3d11.dll\", \"d3d11on12.dll\", \"d3d12.dll\", \"d3d12core.dll\", \"d3d8thk.dll\", \"d3d9.dll\", \"d3d9on12.dll\", \"d3dscache.dll\", \"dab.dll\", \"dabapi.dll\", \"daconn.dll\", \"dafbth.dll\", \"dafdnssd.dll\", \"dafescl.dll\", \"dafgip.dll\", \"dafiot.dll\", \"dafipp.dll\", \"dafmcp.dll\", \"dafpos.dll\", \"dafprintprovider.dll\", \"dafupnp.dll\", \"dafwcn.dll\", \"dafwfdprovider.dll\", \"dafwiprov.dll\", \"dafwsd.dll\", \"damediamanager.dll\", \"damm.dll\", \"das.dll\", \"dataclen.dll\", \"datusage.dll\", \"davclnt.dll\", \"davhlpr.dll\", \"davsyncprovider.dll\", \"daxexec.dll\", \"dbgcore.dll\", \"dbgeng.dll\", \"dbghelp.dll\", \"dbgmodel.dll\", \"dbnetlib.dll\", \"dbnmpntw.dll\", \"dciman32.dll\", \"dcntel.dll\", \"dcomp.dll\", \"ddaclsys.dll\", \"ddcclaimsapi.dll\", \"ddds.dll\", \"ddisplay.dll\", \"ddoiproxy.dll\", \"ddores.dll\", \"ddpchunk.dll\", \"ddptrace.dll\", \"ddputils.dll\", \"ddp_ps.dll\", \"ddraw.dll\", \"ddrawex.dll\", \"defragproxy.dll\", \"defragres.dll\", \"defragsvc.dll\", \"deploymentcsps.dll\", \"deskadp.dll\", \"deskmon.dll\", \"desktopshellext.dll\", \"devenum.dll\", \"deviceaccess.dll\", \"devicecenter.dll\", \"devicecredential.dll\", \"devicepairing.dll\", \"deviceuxres.dll\", \"devinv.dll\", \"devmgr.dll\", \"devobj.dll\", \"devpropmgr.dll\", \"devquerybroker.dll\", \"devrtl.dll\", \"dfdts.dll\", \"dfscli.dll\", \"dfshim.dll\", \"dfsshlex.dll\", \"dggpext.dll\", \"dhcpcmonitor.dll\", \"dhcpcore.dll\", \"dhcpcore6.dll\", \"dhcpcsvc.dll\", \"dhcpcsvc6.dll\", \"dhcpsapi.dll\", \"diagcpl.dll\", \"diagnosticlogcsp.dll\", \"diagperf.dll\", \"diagsvc.dll\", \"diagtrack.dll\", \"dialclient.dll\", \"dialserver.dll\", \"dictationmanager.dll\", \"difxapi.dll\", \"dimsjob.dll\", \"dimsroam.dll\", \"dinput.dll\", \"dinput8.dll\", \"direct2ddesktop.dll\", \"directml.dll\", \"discan.dll\", \"dismapi.dll\", \"dispbroker.dll\", \"dispex.dll\", \"display.dll\", \"displaymanager.dll\", \"dlnashext.dll\", \"dmappsres.dll\", \"dmcfgutils.dll\", \"dmcmnutils.dll\", \"dmcsps.dll\", \"dmdlgs.dll\", \"dmdskmgr.dll\", \"dmdskres.dll\", \"dmdskres2.dll\", \"dmenrollengine.dll\", \"dmintf.dll\", \"dmiso8601utils.dll\", \"dmloader.dll\", \"dmocx.dll\", \"dmoleaututils.dll\", \"dmpushproxy.dll\", \"dmpushroutercore.dll\", \"dmrcdecoder.dll\", \"dmrserver.dll\", \"dmsynth.dll\", \"dmusic.dll\", \"dmutil.dll\", \"dmvdsitf.dll\", \"dmwappushsvc.dll\", \"dmwmicsp.dll\", \"dmxmlhelputils.dll\", \"dnsapi.dll\", \"dnscmmc.dll\", \"dnsext.dll\", \"dnshc.dll\", \"dnsrslvr.dll\", \"docprop.dll\", \"dolbydecmft.dll\", \"domgmt.dll\", \"dosettings.dll\", \"dosvc.dll\", \"dot3api.dll\", \"dot3cfg.dll\", \"dot3conn.dll\", \"dot3dlg.dll\", \"dot3gpclnt.dll\", \"dot3gpui.dll\", \"dot3hc.dll\", \"dot3mm.dll\", \"dot3msm.dll\", \"dot3svc.dll\", \"dot3ui.dll\", \"dpapi.dll\", \"dpapiprovider.dll\", \"dpapisrv.dll\", \"dpnaddr.dll\", \"dpnathlp.dll\", \"dpnet.dll\", \"dpnhpast.dll\", \"dpnhupnp.dll\", \"dpnlobby.dll\", \"dps.dll\", \"dpx.dll\", \"drprov.dll\", \"drt.dll\", \"drtprov.dll\", \"drttransport.dll\", \"drvsetup.dll\", \"drvstore.dll\", \"dsauth.dll\", \"dsccore.dll\", \"dsccoreconfprov.dll\", \"dsclient.dll\", \"dscproxy.dll\", \"dsctimer.dll\", \"dsdmo.dll\", \"dskquota.dll\", \"dskquoui.dll\", \"dsound.dll\", \"dsparse.dll\", \"dsprop.dll\", \"dsquery.dll\", \"dsreg.dll\", \"dsregtask.dll\", \"dsrole.dll\", \"dssec.dll\", \"dssenh.dll\", \"dssvc.dll\", \"dsui.dll\", \"dsuiext.dll\", \"dswave.dll\", \"dtsh.dll\", \"ducsps.dll\", \"dui70.dll\", \"duser.dll\", \"dusmapi.dll\", \"dusmsvc.dll\", \"dwmapi.dll\", \"dwmcore.dll\", \"dwmghost.dll\", \"dwminit.dll\", \"dwmredir.dll\", \"dwmscene.dll\", \"dwrite.dll\", \"dxcore.dll\", \"dxdiagn.dll\", \"dxgi.dll\", \"dxgwdi.dll\", \"dxilconv.dll\", \"dxmasf.dll\", \"dxp.dll\", \"dxpps.dll\", \"dxptasksync.dll\", \"dxtmsft.dll\", \"dxtrans.dll\", \"dxva2.dll\", \"dynamoapi.dll\", \"eapp3hst.dll\", \"eappcfg.dll\", \"eappcfgui.dll\", \"eappgnui.dll\", \"eapphost.dll\", \"eappprxy.dll\", \"eapprovp.dll\", \"eapputil.dll\", \"eapsimextdesktop.dll\", \"eapsvc.dll\", \"eapteapauth.dll\", \"eapteapconfig.dll\", \"eapteapext.dll\", \"easconsent.dll\", \"easwrt.dll\", \"edgeangle.dll\", \"edgecontent.dll\", \"edgehtml.dll\", \"edgeiso.dll\", \"edgemanager.dll\", \"edpauditapi.dll\", \"edpcsp.dll\", \"edptask.dll\", \"edputil.dll\", \"eeprov.dll\", \"eeutil.dll\", \"efsadu.dll\", \"efscore.dll\", \"efsext.dll\", \"efslsaext.dll\", \"efssvc.dll\", \"efsutil.dll\", \"efswrt.dll\", \"ehstorapi.dll\", \"ehstorpwdmgr.dll\", \"ehstorshell.dll\", \"els.dll\", \"elscore.dll\", \"elshyph.dll\", \"elslad.dll\", \"elstrans.dll\", \"emailapis.dll\", \"embeddedmodesvc.dll\", \"emojids.dll\", \"encapi.dll\", \"energy.dll\", \"energyprov.dll\", \"energytask.dll\", \"enrollmentapi.dll\", \"enterpriseapncsp.dll\", \"enterprisecsps.dll\", \"enterpriseetw.dll\", \"eqossnap.dll\", \"errordetails.dll\", \"errordetailscore.dll\", \"es.dll\", \"esclprotocol.dll\", \"esclscan.dll\", \"esclwiadriver.dll\", \"esdsip.dll\", \"esent.dll\", \"esentprf.dll\", \"esevss.dll\", \"eshims.dll\", \"etwrundown.dll\", \"euiccscsp.dll\", \"eventaggregation.dll\", \"eventcls.dll\", \"evr.dll\", \"execmodelclient.dll\", \"execmodelproxy.dll\", \"explorerframe.dll\", \"exsmime.dll\", \"extrasxmlparser.dll\", \"f3ahvoas.dll\", \"facilitator.dll\", \"familysafetyext.dll\", \"faultrep.dll\", \"fcon.dll\", \"fdbth.dll\", \"fdbthproxy.dll\", \"fddevquery.dll\", \"fde.dll\", \"fdeploy.dll\", \"fdphost.dll\", \"fdpnp.dll\", \"fdprint.dll\", \"fdproxy.dll\", \"fdrespub.dll\", \"fdssdp.dll\", \"fdwcn.dll\", \"fdwnet.dll\", \"fdwsd.dll\", \"feclient.dll\", \"ffbroker.dll\", \"fhcat.dll\", \"fhcfg.dll\", \"fhcleanup.dll\", \"fhcpl.dll\", \"fhengine.dll\", \"fhevents.dll\", \"fhshl.dll\", \"fhsrchapi.dll\", \"fhsrchph.dll\", \"fhsvc.dll\", \"fhsvcctl.dll\", \"fhtask.dll\", \"fhuxadapter.dll\", \"fhuxapi.dll\", \"fhuxcommon.dll\", \"fhuxgraphics.dll\", \"fhuxpresentation.dll\", \"fidocredprov.dll\", \"filemgmt.dll\", \"filterds.dll\", \"findnetprinters.dll\", \"firewallapi.dll\", \"flightsettings.dll\", \"fltlib.dll\", \"fluencyds.dll\", \"fmapi.dll\", \"fmifs.dll\", \"fms.dll\", \"fntcache.dll\", \"fontext.dll\", \"fontprovider.dll\", \"fontsub.dll\", \"fphc.dll\", \"framedyn.dll\", \"framedynos.dll\", \"frameserver.dll\", \"frprov.dll\", \"fsutilext.dll\", \"fthsvc.dll\", \"fundisc.dll\", \"fveapi.dll\", \"fveapibase.dll\", \"fvecerts.dll\", \"fvecpl.dll\", \"fveskybackup.dll\", \"fveui.dll\", \"fvewiz.dll\", \"fwbase.dll\", \"fwcfg.dll\", \"fwmdmcsp.dll\", \"fwpolicyiomgr.dll\", \"fwpuclnt.dll\", \"fwremotesvr.dll\", \"gameinput.dll\", \"gamemode.dll\", \"gamestreamingext.dll\", \"gameux.dll\", \"gamingtcui.dll\", \"gcdef.dll\", \"gdi32.dll\", \"gdi32full.dll\", \"gdiplus.dll\", \"generaltel.dll\", \"geocommon.dll\", \"geolocation.dll\", \"getuname.dll\", \"glmf32.dll\", \"globinputhost.dll\", \"glu32.dll\", \"gmsaclient.dll\", \"gpapi.dll\", \"gpcsewrappercsp.dll\", \"gpedit.dll\", \"gpprefcl.dll\", \"gpprnext.dll\", \"gpscript.dll\", \"gpsvc.dll\", \"gptext.dll\", \"graphicscapture.dll\", \"graphicsperfsvc.dll\", \"groupinghc.dll\", \"hal.dll\", \"halextpl080.dll\", \"hascsp.dll\", \"hashtagds.dll\", \"hbaapi.dll\", \"hcproviders.dll\", \"hdcphandler.dll\", \"heatcore.dll\", \"helppaneproxy.dll\", \"hgcpl.dll\", \"hhsetup.dll\", \"hid.dll\", \"hidcfu.dll\", \"hidserv.dll\", \"hlink.dll\", \"hmkd.dll\", \"hnetcfg.dll\", \"hnetcfgclient.dll\", \"hnetmon.dll\", \"hologramworld.dll\", \"holoshellruntime.dll\", \"holoshextensions.dll\", \"hotplug.dll\", \"hrtfapo.dll\", \"httpapi.dll\", \"httpprxc.dll\", \"httpprxm.dll\", \"httpprxp.dll\", \"httpsdatasource.dll\", \"htui.dll\", \"hvhostsvc.dll\", \"hvloader.dll\", \"hvsigpext.dll\", \"hvsocket.dll\", \"hydrogen.dll\", \"ia2comproxy.dll\", \"ias.dll\", \"iasacct.dll\", \"iasads.dll\", \"iasdatastore.dll\", \"iashlpr.dll\", \"iasmigplugin.dll\", \"iasnap.dll\", \"iaspolcy.dll\", \"iasrad.dll\", \"iasrecst.dll\", \"iassam.dll\", \"iassdo.dll\", \"iassvcs.dll\", \"icfupgd.dll\", \"icm32.dll\", \"icmp.dll\", \"icmui.dll\", \"iconcodecservice.dll\", \"icsigd.dll\", \"icsvc.dll\", \"icsvcext.dll\", \"icu.dll\", \"icuin.dll\", \"icuuc.dll\", \"idctrls.dll\", \"idlisten.dll\", \"idndl.dll\", \"idstore.dll\", \"ieadvpack.dll\", \"ieapfltr.dll\", \"iedkcs32.dll\", \"ieframe.dll\", \"iemigplugin.dll\", \"iepeers.dll\", \"ieproxy.dll\", \"iernonce.dll\", \"iertutil.dll\", \"iesetup.dll\", \"iesysprep.dll\", \"ieui.dll\", \"ifmon.dll\", \"ifsutil.dll\", \"ifsutilx.dll\", \"igddiag.dll\", \"ihds.dll\", \"ikeext.dll\", \"imagehlp.dll\", \"imageres.dll\", \"imagesp1.dll\", \"imapi.dll\", \"imapi2.dll\", \"imapi2fs.dll\", \"imgutil.dll\", \"imm32.dll\", \"implatsetup.dll\", \"indexeddblegacy.dll\", \"inetcomm.dll\", \"inetmib1.dll\", \"inetpp.dll\", \"inetppui.dll\", \"inetres.dll\", \"inked.dll\", \"inkobjcore.dll\", \"inproclogger.dll\", \"input.dll\", \"inputcloudstore.dll\", \"inputcontroller.dll\", \"inputhost.dll\", \"inputservice.dll\", \"inputswitch.dll\", \"inseng.dll\", \"installservice.dll\", \"internetmail.dll\", \"internetmailcsp.dll\", \"invagent.dll\", \"iologmsg.dll\", \"iphlpapi.dll\", \"iphlpsvc.dll\", \"ipnathlp.dll\", \"ipnathlpclient.dll\", \"ippcommon.dll\", \"ippcommonproxy.dll\", \"iprtprio.dll\", \"iprtrmgr.dll\", \"ipsecsnp.dll\", \"ipsecsvc.dll\", \"ipsmsnap.dll\", \"ipxlatcfg.dll\", \"iri.dll\", \"iscsicpl.dll\", \"iscsidsc.dll\", \"iscsied.dll\", \"iscsiexe.dll\", \"iscsilog.dll\", \"iscsium.dll\", \"iscsiwmi.dll\", \"iscsiwmiv2.dll\", \"ism.dll\", \"itircl.dll\", \"itss.dll\", \"iuilp.dll\", \"iumbase.dll\", \"iumcrypt.dll\", \"iumdll.dll\", \"iumsdk.dll\", \"iyuv_32.dll\", \"joinproviderol.dll\", \"joinutil.dll\", \"jpmapcontrol.dll\", \"jpndecoder.dll\", \"jpninputrouter.dll\", \"jpnranker.dll\", \"jpnserviceds.dll\", \"jscript.dll\", \"jscript9.dll\", \"jscript9diag.dll\", \"jsproxy.dll\", \"kbd101.dll\", \"kbd101a.dll\", \"kbd101b.dll\", \"kbd101c.dll\", \"kbd103.dll\", \"kbd106.dll\", \"kbd106n.dll\", \"kbda1.dll\", \"kbda2.dll\", \"kbda3.dll\", \"kbdadlm.dll\", \"kbdal.dll\", \"kbdarme.dll\", \"kbdarmph.dll\", \"kbdarmty.dll\", \"kbdarmw.dll\", \"kbdax2.dll\", \"kbdaze.dll\", \"kbdazel.dll\", \"kbdazst.dll\", \"kbdbash.dll\", \"kbdbe.dll\", \"kbdbene.dll\", \"kbdbgph.dll\", \"kbdbgph1.dll\", \"kbdbhc.dll\", \"kbdblr.dll\", \"kbdbr.dll\", \"kbdbu.dll\", \"kbdbug.dll\", \"kbdbulg.dll\", \"kbdca.dll\", \"kbdcan.dll\", \"kbdcher.dll\", \"kbdcherp.dll\", \"kbdcr.dll\", \"kbdcz.dll\", \"kbdcz1.dll\", \"kbdcz2.dll\", \"kbdda.dll\", \"kbddiv1.dll\", \"kbddiv2.dll\", \"kbddv.dll\", \"kbddzo.dll\", \"kbdes.dll\", \"kbdest.dll\", \"kbdfa.dll\", \"kbdfar.dll\", \"kbdfc.dll\", \"kbdfi.dll\", \"kbdfi1.dll\", \"kbdfo.dll\", \"kbdfr.dll\", \"kbdfthrk.dll\", \"kbdgae.dll\", \"kbdgeo.dll\", \"kbdgeoer.dll\", \"kbdgeome.dll\", \"kbdgeooa.dll\", \"kbdgeoqw.dll\", \"kbdgkl.dll\", \"kbdgn.dll\", \"kbdgr.dll\", \"kbdgr1.dll\", \"kbdgrlnd.dll\", \"kbdgthc.dll\", \"kbdhau.dll\", \"kbdhaw.dll\", \"kbdhe.dll\", \"kbdhe220.dll\", \"kbdhe319.dll\", \"kbdheb.dll\", \"kbdhebl3.dll\", \"kbdhela2.dll\", \"kbdhela3.dll\", \"kbdhept.dll\", \"kbdhu.dll\", \"kbdhu1.dll\", \"kbdibm02.dll\", \"kbdibo.dll\", \"kbdic.dll\", \"kbdinasa.dll\", \"kbdinbe1.dll\", \"kbdinbe2.dll\", \"kbdinben.dll\", \"kbdindev.dll\", \"kbdinen.dll\", \"kbdinguj.dll\", \"kbdinhin.dll\", \"kbdinkan.dll\", \"kbdinmal.dll\", \"kbdinmar.dll\", \"kbdinori.dll\", \"kbdinpun.dll\", \"kbdintam.dll\", \"kbdintel.dll\", \"kbdinuk2.dll\", \"kbdir.dll\", \"kbdit.dll\", \"kbdit142.dll\", \"kbdiulat.dll\", \"kbdjav.dll\", \"kbdjpn.dll\", \"kbdkaz.dll\", \"kbdkhmr.dll\", \"kbdkni.dll\", \"kbdkor.dll\", \"kbdkurd.dll\", \"kbdkyr.dll\", \"kbdla.dll\", \"kbdlao.dll\", \"kbdlisub.dll\", \"kbdlisus.dll\", \"kbdlk41a.dll\", \"kbdlt.dll\", \"kbdlt1.dll\", \"kbdlt2.dll\", \"kbdlv.dll\", \"kbdlv1.dll\", \"kbdlvst.dll\", \"kbdmac.dll\", \"kbdmacst.dll\", \"kbdmaori.dll\", \"kbdmlt47.dll\", \"kbdmlt48.dll\", \"kbdmon.dll\", \"kbdmonmo.dll\", \"kbdmonst.dll\", \"kbdmyan.dll\", \"kbdne.dll\", \"kbdnec.dll\", \"kbdnec95.dll\", \"kbdnecat.dll\", \"kbdnecnt.dll\", \"kbdnepr.dll\", \"kbdnko.dll\", \"kbdno.dll\", \"kbdno1.dll\", \"kbdnso.dll\", \"kbdntl.dll\", \"kbdogham.dll\", \"kbdolch.dll\", \"kbdoldit.dll\", \"kbdosa.dll\", \"kbdosm.dll\", \"kbdpash.dll\", \"kbdphags.dll\", \"kbdpl.dll\", \"kbdpl1.dll\", \"kbdpo.dll\", \"kbdro.dll\", \"kbdropr.dll\", \"kbdrost.dll\", \"kbdru.dll\", \"kbdru1.dll\", \"kbdrum.dll\", \"kbdsf.dll\", \"kbdsg.dll\", \"kbdsl.dll\", \"kbdsl1.dll\", \"kbdsmsfi.dll\", \"kbdsmsno.dll\", \"kbdsn1.dll\", \"kbdsora.dll\", \"kbdsorex.dll\", \"kbdsors1.dll\", \"kbdsorst.dll\", \"kbdsp.dll\", \"kbdsw.dll\", \"kbdsw09.dll\", \"kbdsyr1.dll\", \"kbdsyr2.dll\", \"kbdtaile.dll\", \"kbdtajik.dll\", \"kbdtam99.dll\", \"kbdtat.dll\", \"kbdth0.dll\", \"kbdth1.dll\", \"kbdth2.dll\", \"kbdth3.dll\", \"kbdtifi.dll\", \"kbdtifi2.dll\", \"kbdtiprc.dll\", \"kbdtiprd.dll\", \"kbdtt102.dll\", \"kbdtuf.dll\", \"kbdtuq.dll\", \"kbdturme.dll\", \"kbdtzm.dll\", \"kbdughr.dll\", \"kbdughr1.dll\", \"kbduk.dll\", \"kbdukx.dll\", \"kbdur.dll\", \"kbdur1.dll\", \"kbdurdu.dll\", \"kbdus.dll\", \"kbdusa.dll\", \"kbdusl.dll\", \"kbdusr.dll\", \"kbdusx.dll\", \"kbduzb.dll\", \"kbdvntc.dll\", \"kbdwol.dll\", \"kbdyak.dll\", \"kbdyba.dll\", \"kbdycc.dll\", \"kbdycl.dll\", \"kd.dll\", \"kdcom.dll\", \"kdcpw.dll\", \"kdhvcom.dll\", \"kdnet.dll\", \"kdnet_uart16550.dll\", \"kdscli.dll\", \"kdstub.dll\", \"kdusb.dll\", \"kd_02_10df.dll\", \"kd_02_10ec.dll\", \"kd_02_1137.dll\", \"kd_02_14e4.dll\", \"kd_02_15b3.dll\", \"kd_02_1969.dll\", \"kd_02_19a2.dll\", \"kd_02_1af4.dll\", \"kd_02_8086.dll\", \"kd_07_1415.dll\", \"kd_0c_8086.dll\", \"kerbclientshared.dll\", \"kerberos.dll\", \"kernel32.dll\", \"kernelbase.dll\", \"keycredmgr.dll\", \"keyiso.dll\", \"keymgr.dll\", \"knobscore.dll\", \"knobscsp.dll\", \"ksuser.dll\", \"ktmw32.dll\", \"l2gpstore.dll\", \"l2nacp.dll\", \"l2sechc.dll\", \"laprxy.dll\", \"legacynetux.dll\", \"lfsvc.dll\", \"libcrypto.dll\", \"licensemanager.dll\", \"licensingcsp.dll\", \"licensingdiagspp.dll\", \"licensingwinrt.dll\", \"licmgr10.dll\", \"linkinfo.dll\", \"lltdapi.dll\", \"lltdres.dll\", \"lltdsvc.dll\", \"lmhsvc.dll\", \"loadperf.dll\", \"localsec.dll\", \"localspl.dll\", \"localui.dll\", \"locationapi.dll\", \"lockappbroker.dll\", \"lockcontroller.dll\", \"lockscreendata.dll\", \"loghours.dll\", \"logoncli.dll\", \"logoncontroller.dll\", \"lpasvc.dll\", \"lpk.dll\", \"lsasrv.dll\", \"lscshostpolicy.dll\", \"lsm.dll\", \"lsmproxy.dll\", \"lstelemetry.dll\", \"luainstall.dll\", \"luiapi.dll\", \"lz32.dll\", \"magnification.dll\", \"maintenanceui.dll\", \"manageci.dll\", \"mapconfiguration.dll\", \"mapcontrolcore.dll\", \"mapgeocoder.dll\", \"mapi32.dll\", \"mapistub.dll\", \"maprouter.dll\", \"mapsbtsvc.dll\", \"mapsbtsvcproxy.dll\", \"mapscsp.dll\", \"mapsstore.dll\", \"mapstoasttask.dll\", \"mapsupdatetask.dll\", \"mbaeapi.dll\", \"mbaeapipublic.dll\", \"mbaexmlparser.dll\", \"mbmediamanager.dll\", \"mbsmsapi.dll\", \"mbussdapi.dll\", \"mccsengineshared.dll\", \"mccspal.dll\", \"mciavi32.dll\", \"mcicda.dll\", \"mciqtz32.dll\", \"mciseq.dll\", \"mciwave.dll\", \"mcrecvsrc.dll\", \"mdmcommon.dll\", \"mdmdiagnostics.dll\", \"mdminst.dll\", \"mdmmigrator.dll\", \"mdmregistration.dll\", \"memorydiagnostic.dll\", \"messagingservice.dll\", \"mf.dll\", \"mf3216.dll\", \"mfaacenc.dll\", \"mfasfsrcsnk.dll\", \"mfaudiocnv.dll\", \"mfc42.dll\", \"mfc42u.dll\", \"mfcaptureengine.dll\", \"mfcore.dll\", \"mfcsubs.dll\", \"mfds.dll\", \"mfdvdec.dll\", \"mferror.dll\", \"mfh263enc.dll\", \"mfh264enc.dll\", \"mfksproxy.dll\", \"mfmediaengine.dll\", \"mfmjpegdec.dll\", \"mfmkvsrcsnk.dll\", \"mfmp4srcsnk.dll\", \"mfmpeg2srcsnk.dll\", \"mfnetcore.dll\", \"mfnetsrc.dll\", \"mfperfhelper.dll\", \"mfplat.dll\", \"mfplay.dll\", \"mfps.dll\", \"mfreadwrite.dll\", \"mfsensorgroup.dll\", \"mfsrcsnk.dll\", \"mfsvr.dll\", \"mftranscode.dll\", \"mfvdsp.dll\", \"mfvfw.dll\", \"mfwmaaec.dll\", \"mgmtapi.dll\", \"mi.dll\", \"mibincodec.dll\", \"midimap.dll\", \"migisol.dll\", \"miguiresource.dll\", \"mimefilt.dll\", \"mimofcodec.dll\", \"minstoreevents.dll\", \"miracastinputmgr.dll\", \"miracastreceiver.dll\", \"mirrordrvcompat.dll\", \"mispace.dll\", \"mitigationclient.dll\", \"miutils.dll\", \"mlang.dll\", \"mmcbase.dll\", \"mmcndmgr.dll\", \"mmcshext.dll\", \"mmdevapi.dll\", \"mmgaclient.dll\", \"mmgaproxystub.dll\", \"mmres.dll\", \"mobilenetworking.dll\", \"modemui.dll\", \"modernexecserver.dll\", \"moricons.dll\", \"moshost.dll\", \"moshostclient.dll\", \"moshostcore.dll\", \"mosstorage.dll\", \"mp3dmod.dll\", \"mp43decd.dll\", \"mp4sdecd.dll\", \"mpeval.dll\", \"mpg4decd.dll\", \"mpr.dll\", \"mprapi.dll\", \"mprddm.dll\", \"mprdim.dll\", \"mprext.dll\", \"mprmsg.dll\", \"mpssvc.dll\", \"mpunits.dll\", \"mrmcorer.dll\", \"mrmdeploy.dll\", \"mrmindexer.dll\", \"mrt100.dll\", \"mrt_map.dll\", \"msaatext.dll\", \"msac3enc.dll\", \"msacm32.dll\", \"msafd.dll\", \"msajapi.dll\", \"msalacdecoder.dll\", \"msalacencoder.dll\", \"msamrnbdecoder.dll\", \"msamrnbencoder.dll\", \"msamrnbsink.dll\", \"msamrnbsource.dll\", \"msasn1.dll\", \"msauddecmft.dll\", \"msaudite.dll\", \"msauserext.dll\", \"mscandui.dll\", \"mscat32.dll\", \"msclmd.dll\", \"mscms.dll\", \"mscoree.dll\", \"mscorier.dll\", \"mscories.dll\", \"msctf.dll\", \"msctfmonitor.dll\", \"msctfp.dll\", \"msctfui.dll\", \"msctfuimanager.dll\", \"msdadiag.dll\", \"msdart.dll\", \"msdelta.dll\", \"msdmo.dll\", \"msdrm.dll\", \"msdtckrm.dll\", \"msdtclog.dll\", \"msdtcprx.dll\", \"msdtcspoffln.dll\", \"msdtctm.dll\", \"msdtcuiu.dll\", \"msdtcvsp1res.dll\", \"msfeeds.dll\", \"msfeedsbs.dll\", \"msflacdecoder.dll\", \"msflacencoder.dll\", \"msftedit.dll\", \"msheif.dll\", \"mshtml.dll\", \"mshtmldac.dll\", \"mshtmled.dll\", \"mshtmler.dll\", \"msi.dll\", \"msicofire.dll\", \"msidcrl40.dll\", \"msident.dll\", \"msidle.dll\", \"msidntld.dll\", \"msieftp.dll\", \"msihnd.dll\", \"msiltcfg.dll\", \"msimg32.dll\", \"msimsg.dll\", \"msimtf.dll\", \"msisip.dll\", \"msiso.dll\", \"msiwer.dll\", \"mskeyprotcli.dll\", \"mskeyprotect.dll\", \"msls31.dll\", \"msmpeg2adec.dll\", \"msmpeg2enc.dll\", \"msmpeg2vdec.dll\", \"msobjs.dll\", \"msoert2.dll\", \"msopusdecoder.dll\", \"mspatcha.dll\", \"mspatchc.dll\", \"msphotography.dll\", \"msports.dll\", \"msprivs.dll\", \"msrahc.dll\", \"msrating.dll\", \"msrawimage.dll\", \"msrdc.dll\", \"msrdpwebaccess.dll\", \"msrle32.dll\", \"msscntrs.dll\", \"mssecuser.dll\", \"mssign32.dll\", \"mssip32.dll\", \"mssitlb.dll\", \"mssph.dll\", \"mssprxy.dll\", \"mssrch.dll\", \"mssvp.dll\", \"mstask.dll\", \"mstextprediction.dll\", \"mstscax.dll\", \"msutb.dll\", \"msv1_0.dll\", \"msvcirt.dll\", \"msvcp110_win.dll\", \"msvcp120_clr0400.dll\", \"msvcp140_clr0400.dll\", \"msvcp60.dll\", \"msvcp_win.dll\", \"msvcr100_clr0400.dll\", \"msvcr120_clr0400.dll\", \"msvcrt.dll\", \"msvfw32.dll\", \"msvidc32.dll\", \"msvidctl.dll\", \"msvideodsp.dll\", \"msvp9dec.dll\", \"msvproc.dll\", \"msvpxenc.dll\", \"mswb7.dll\", \"mswebp.dll\", \"mswmdm.dll\", \"mswsock.dll\", \"msxml3.dll\", \"msxml3r.dll\", \"msxml6.dll\", \"msxml6r.dll\", \"msyuv.dll\", \"mtcmodel.dll\", \"mtf.dll\", \"mtfappserviceds.dll\", \"mtfdecoder.dll\", \"mtffuzzyds.dll\", \"mtfserver.dll\", \"mtfspellcheckds.dll\", \"mtxclu.dll\", \"mtxdm.dll\", \"mtxex.dll\", \"mtxoci.dll\", \"muifontsetup.dll\", \"mycomput.dll\", \"mydocs.dll\", \"napcrypt.dll\", \"napinsp.dll\", \"naturalauth.dll\", \"naturallanguage6.dll\", \"navshutdown.dll\", \"ncaapi.dll\", \"ncasvc.dll\", \"ncbservice.dll\", \"ncdautosetup.dll\", \"ncdprop.dll\", \"nci.dll\", \"ncobjapi.dll\", \"ncrypt.dll\", \"ncryptprov.dll\", \"ncryptsslp.dll\", \"ncsi.dll\", \"ncuprov.dll\", \"nddeapi.dll\", \"ndfapi.dll\", \"ndfetw.dll\", \"ndfhcdiscovery.dll\", \"ndishc.dll\", \"ndproxystub.dll\", \"nduprov.dll\", \"negoexts.dll\", \"netapi32.dll\", \"netbios.dll\", \"netcenter.dll\", \"netcfgx.dll\", \"netcorehc.dll\", \"netdiagfx.dll\", \"netdriverinstall.dll\", \"netevent.dll\", \"netfxperf.dll\", \"neth.dll\", \"netid.dll\", \"netiohlp.dll\", \"netjoin.dll\", \"netlogon.dll\", \"netman.dll\", \"netmsg.dll\", \"netplwiz.dll\", \"netprofm.dll\", \"netprofmsvc.dll\", \"netprovfw.dll\", \"netprovisionsp.dll\", \"netsetupapi.dll\", \"netsetupengine.dll\", \"netsetupshim.dll\", \"netsetupsvc.dll\", \"netshell.dll\", \"nettrace.dll\", \"netutils.dll\", \"networkexplorer.dll\", \"networkhelper.dll\", \"networkicon.dll\", \"networkproxycsp.dll\", \"networkstatus.dll\", \"networkuxbroker.dll\", \"newdev.dll\", \"nfcradiomedia.dll\", \"ngccredprov.dll\", \"ngcctnr.dll\", \"ngcctnrsvc.dll\", \"ngcisoctnr.dll\", \"ngckeyenum.dll\", \"ngcksp.dll\", \"ngclocal.dll\", \"ngcpopkeysrv.dll\", \"ngcprocsp.dll\", \"ngcrecovery.dll\", \"ngcsvc.dll\", \"ngctasks.dll\", \"ninput.dll\", \"nlaapi.dll\", \"nlahc.dll\", \"nlasvc.dll\", \"nlhtml.dll\", \"nlmgp.dll\", \"nlmproxy.dll\", \"nlmsprep.dll\", \"nlsbres.dll\", \"nlsdata0000.dll\", \"nlsdata0009.dll\", \"nlsdl.dll\", \"nlslexicons0009.dll\", \"nmadirect.dll\", \"normaliz.dll\", \"npmproxy.dll\", \"npsm.dll\", \"nrpsrv.dll\", \"nshhttp.dll\", \"nshipsec.dll\", \"nshwfp.dll\", \"nsi.dll\", \"nsisvc.dll\", \"ntasn1.dll\", \"ntdll.dll\", \"ntdsapi.dll\", \"ntlanman.dll\", \"ntlanui2.dll\", \"ntlmshared.dll\", \"ntmarta.dll\", \"ntprint.dll\", \"ntshrui.dll\", \"ntvdm64.dll\", \"objsel.dll\", \"occache.dll\", \"ocsetapi.dll\", \"odbc32.dll\", \"odbcbcp.dll\", \"odbcconf.dll\", \"odbccp32.dll\", \"odbccr32.dll\", \"odbccu32.dll\", \"odbcint.dll\", \"odbctrac.dll\", \"oemlicense.dll\", \"offfilt.dll\", \"officecsp.dll\", \"offlinelsa.dll\", \"offlinesam.dll\", \"offreg.dll\", \"ole32.dll\", \"oleacc.dll\", \"oleacchooks.dll\", \"oleaccrc.dll\", \"oleaut32.dll\", \"oledlg.dll\", \"oleprn.dll\", \"omadmagent.dll\", \"omadmapi.dll\", \"onebackuphandler.dll\", \"onex.dll\", \"onexui.dll\", \"opcservices.dll\", \"opengl32.dll\", \"ortcengine.dll\", \"osbaseln.dll\", \"osksupport.dll\", \"osuninst.dll\", \"p2p.dll\", \"p2pgraph.dll\", \"p2pnetsh.dll\", \"p2psvc.dll\", \"packager.dll\", \"panmap.dll\", \"pautoenr.dll\", \"pcacli.dll\", \"pcadm.dll\", \"pcaevts.dll\", \"pcasvc.dll\", \"pcaui.dll\", \"pcpksp.dll\", \"pcsvdevice.dll\", \"pcwum.dll\", \"pcwutl.dll\", \"pdh.dll\", \"pdhui.dll\", \"peerdist.dll\", \"peerdistad.dll\", \"peerdistcleaner.dll\", \"peerdistsh.dll\", \"peerdistsvc.dll\", \"peopleapis.dll\", \"peopleband.dll\", \"perceptiondevice.dll\", \"perfctrs.dll\", \"perfdisk.dll\", \"perfnet.dll\", \"perfos.dll\", \"perfproc.dll\", \"perfts.dll\", \"phoneom.dll\", \"phoneproviders.dll\", \"phoneservice.dll\", \"phoneserviceres.dll\", \"phoneutil.dll\", \"phoneutilres.dll\", \"photowiz.dll\", \"pickerplatform.dll\", \"pid.dll\", \"pidgenx.dll\", \"pifmgr.dll\", \"pimstore.dll\", \"pkeyhelper.dll\", \"pktmonapi.dll\", \"pku2u.dll\", \"pla.dll\", \"playlistfolder.dll\", \"playsndsrv.dll\", \"playtodevice.dll\", \"playtomanager.dll\", \"playtomenu.dll\", \"playtoreceiver.dll\", \"ploptin.dll\", \"pmcsnap.dll\", \"pngfilt.dll\", \"pnidui.dll\", \"pnpclean.dll\", \"pnppolicy.dll\", \"pnpts.dll\", \"pnpui.dll\", \"pnpxassoc.dll\", \"pnpxassocprx.dll\", \"pnrpauto.dll\", \"pnrphc.dll\", \"pnrpnsp.dll\", \"pnrpsvc.dll\", \"policymanager.dll\", \"polstore.dll\", \"posetup.dll\", \"posyncservices.dll\", \"pots.dll\", \"powercpl.dll\", \"powrprof.dll\", \"ppcsnap.dll\", \"prauthproviders.dll\", \"prflbmsg.dll\", \"printui.dll\", \"printwsdahost.dll\", \"prm0009.dll\", \"prncache.dll\", \"prnfldr.dll\", \"prnntfy.dll\", \"prntvpt.dll\", \"profapi.dll\", \"profext.dll\", \"profprov.dll\", \"profsvc.dll\", \"profsvcext.dll\", \"propsys.dll\", \"provcore.dll\", \"provdatastore.dll\", \"provdiagnostics.dll\", \"provengine.dll\", \"provhandlers.dll\", \"provisioningcsp.dll\", \"provmigrate.dll\", \"provops.dll\", \"provplugineng.dll\", \"provsysprep.dll\", \"provthrd.dll\", \"proximitycommon.dll\", \"proximityservice.dll\", \"prvdmofcomp.dll\", \"psapi.dll\", \"pshed.dll\", \"psisdecd.dll\", \"psmsrv.dll\", \"pstask.dll\", \"pstorec.dll\", \"ptpprov.dll\", \"puiapi.dll\", \"puiobj.dll\", \"pushtoinstall.dll\", \"pwlauncher.dll\", \"pwrshplugin.dll\", \"pwsso.dll\", \"qasf.dll\", \"qcap.dll\", \"qdv.dll\", \"qdvd.dll\", \"qedit.dll\", \"qedwipes.dll\", \"qmgr.dll\", \"query.dll\", \"quiethours.dll\", \"qwave.dll\", \"racengn.dll\", \"racpldlg.dll\", \"radardt.dll\", \"radarrs.dll\", \"radcui.dll\", \"rasadhlp.dll\", \"rasapi32.dll\", \"rasauto.dll\", \"raschap.dll\", \"raschapext.dll\", \"rasctrs.dll\", \"rascustom.dll\", \"rasdiag.dll\", \"rasdlg.dll\", \"rasgcw.dll\", \"rasman.dll\", \"rasmans.dll\", \"rasmbmgr.dll\", \"rasmediamanager.dll\", \"rasmm.dll\", \"rasmontr.dll\", \"rasplap.dll\", \"rasppp.dll\", \"rastapi.dll\", \"rastls.dll\", \"rastlsext.dll\", \"rdbui.dll\", \"rdpbase.dll\", \"rdpcfgex.dll\", \"rdpcore.dll\", \"rdpcorets.dll\", \"rdpencom.dll\", \"rdpendp.dll\", \"rdpnano.dll\", \"rdpsaps.dll\", \"rdpserverbase.dll\", \"rdpsharercom.dll\", \"rdpudd.dll\", \"rdpviewerax.dll\", \"rdsappxhelper.dll\", \"rdsdwmdr.dll\", \"rdvvmtransport.dll\", \"rdxservice.dll\", \"rdxtaskfactory.dll\", \"reagent.dll\", \"reagenttask.dll\", \"recovery.dll\", \"regapi.dll\", \"regctrl.dll\", \"regidle.dll\", \"regsvc.dll\", \"reguwpapi.dll\", \"reinfo.dll\", \"remotepg.dll\", \"remotewipecsp.dll\", \"reportingcsp.dll\", \"resampledmo.dll\", \"resbparser.dll\", \"reseteng.dll\", \"resetengine.dll\", \"resetengonline.dll\", \"resourcemapper.dll\", \"resutils.dll\", \"rgb9rast.dll\", \"riched20.dll\", \"riched32.dll\", \"rjvmdmconfig.dll\", \"rmapi.dll\", \"rmclient.dll\", \"rnr20.dll\", \"roamingsecurity.dll\", \"rometadata.dll\", \"rotmgr.dll\", \"rpcepmap.dll\", \"rpchttp.dll\", \"rpcns4.dll\", \"rpcnsh.dll\", \"rpcrt4.dll\", \"rpcrtremote.dll\", \"rpcss.dll\", \"rsaenh.dll\", \"rshx32.dll\", \"rstrtmgr.dll\", \"rtffilt.dll\", \"rtm.dll\", \"rtmediaframe.dll\", \"rtmmvrortc.dll\", \"rtutils.dll\", \"rtworkq.dll\", \"rulebasedds.dll\", \"samcli.dll\", \"samlib.dll\", \"samsrv.dll\", \"sas.dll\", \"sbe.dll\", \"sbeio.dll\", \"sberes.dll\", \"sbservicetrigger.dll\", \"scansetting.dll\", \"scardbi.dll\", \"scarddlg.dll\", \"scardsvr.dll\", \"scavengeui.dll\", \"scdeviceenum.dll\", \"scecli.dll\", \"scesrv.dll\", \"schannel.dll\", \"schedcli.dll\", \"schedsvc.dll\", \"scksp.dll\", \"scripto.dll\", \"scrobj.dll\", \"scrptadm.dll\", \"scrrun.dll\", \"sdcpl.dll\", \"sdds.dll\", \"sdengin2.dll\", \"sdfhost.dll\", \"sdhcinst.dll\", \"sdiageng.dll\", \"sdiagprv.dll\", \"sdiagschd.dll\", \"sdohlp.dll\", \"sdrsvc.dll\", \"sdshext.dll\", \"searchfolder.dll\", \"sechost.dll\", \"seclogon.dll\", \"secproc.dll\", \"secproc_isv.dll\", \"secproc_ssp.dll\", \"secproc_ssp_isv.dll\", \"secur32.dll\", \"security.dll\", \"semgrps.dll\", \"semgrsvc.dll\", \"sendmail.dll\", \"sens.dll\", \"sensapi.dll\", \"sensorsapi.dll\", \"sensorscpl.dll\", \"sensorservice.dll\", \"sensorsnativeapi.dll\", \"sensorsutilsv2.dll\", \"sensrsvc.dll\", \"serialui.dll\", \"servicinguapi.dll\", \"serwvdrv.dll\", \"sessenv.dll\", \"setbcdlocale.dll\", \"settingmonitor.dll\", \"settingsync.dll\", \"settingsynccore.dll\", \"setupapi.dll\", \"setupcl.dll\", \"setupcln.dll\", \"setupetw.dll\", \"sfc.dll\", \"sfc_os.dll\", \"sgrmenclave.dll\", \"shacct.dll\", \"shacctprofile.dll\", \"sharedpccsp.dll\", \"sharedrealitysvc.dll\", \"sharehost.dll\", \"sharemediacpl.dll\", \"shcore.dll\", \"shdocvw.dll\", \"shell32.dll\", \"shellstyle.dll\", \"shfolder.dll\", \"shgina.dll\", \"shimeng.dll\", \"shimgvw.dll\", \"shlwapi.dll\", \"shpafact.dll\", \"shsetup.dll\", \"shsvcs.dll\", \"shunimpl.dll\", \"shutdownext.dll\", \"shutdownux.dll\", \"shwebsvc.dll\", \"signdrv.dll\", \"simauth.dll\", \"simcfg.dll\", \"skci.dll\", \"slc.dll\", \"slcext.dll\", \"slwga.dll\", \"smartscreenps.dll\", \"smbhelperclass.dll\", \"smbwmiv2.dll\", \"smiengine.dll\", \"smphost.dll\", \"smsroutersvc.dll\", \"sndvolsso.dll\", \"snmpapi.dll\", \"socialapis.dll\", \"softkbd.dll\", \"softpub.dll\", \"sortwindows61.dll\", \"sortwindows62.dll\", \"spacebridge.dll\", \"spacecontrol.dll\", \"spatializerapo.dll\", \"spatialstore.dll\", \"spbcd.dll\", \"speechpal.dll\", \"spfileq.dll\", \"spinf.dll\", \"spmpm.dll\", \"spnet.dll\", \"spoolss.dll\", \"spopk.dll\", \"spp.dll\", \"sppc.dll\", \"sppcext.dll\", \"sppcomapi.dll\", \"sppcommdlg.dll\", \"sppinst.dll\", \"sppnp.dll\", \"sppobjs.dll\", \"sppwinob.dll\", \"sppwmi.dll\", \"spwinsat.dll\", \"spwizeng.dll\", \"spwizimg.dll\", \"spwizres.dll\", \"spwmp.dll\", \"sqlsrv32.dll\", \"sqmapi.dll\", \"srchadmin.dll\", \"srclient.dll\", \"srcore.dll\", \"srevents.dll\", \"srh.dll\", \"srhelper.dll\", \"srm.dll\", \"srmclient.dll\", \"srmlib.dll\", \"srmscan.dll\", \"srmshell.dll\", \"srmstormod.dll\", \"srmtrace.dll\", \"srm_ps.dll\", \"srpapi.dll\", \"srrstr.dll\", \"srumapi.dll\", \"srumsvc.dll\", \"srvcli.dll\", \"srvsvc.dll\", \"srwmi.dll\", \"sscore.dll\", \"sscoreext.dll\", \"ssdm.dll\", \"ssdpapi.dll\", \"ssdpsrv.dll\", \"sspicli.dll\", \"sspisrv.dll\", \"ssshim.dll\", \"sstpsvc.dll\", \"starttiledata.dll\", \"startupscan.dll\", \"stclient.dll\", \"sti.dll\", \"sti_ci.dll\", \"stobject.dll\", \"storageusage.dll\", \"storagewmi.dll\", \"storewuauth.dll\", \"storprop.dll\", \"storsvc.dll\", \"streamci.dll\", \"structuredquery.dll\", \"sud.dll\", \"svf.dll\", \"svsvc.dll\", \"swprv.dll\", \"sxproxy.dll\", \"sxs.dll\", \"sxshared.dll\", \"sxssrv.dll\", \"sxsstore.dll\", \"synccenter.dll\", \"synccontroller.dll\", \"synchostps.dll\", \"syncproxy.dll\", \"syncreg.dll\", \"syncres.dll\", \"syncsettings.dll\", \"syncutil.dll\", \"sysclass.dll\", \"sysfxui.dll\", \"sysmain.dll\", \"sysntfy.dll\", \"syssetup.dll\", \"systemcpl.dll\", \"t2embed.dll\", \"tabbtn.dll\", \"tabbtnex.dll\", \"tabsvc.dll\", \"tapi3.dll\", \"tapi32.dll\", \"tapilua.dll\", \"tapimigplugin.dll\", \"tapiperf.dll\", \"tapisrv.dll\", \"tapisysprep.dll\", \"tapiui.dll\", \"taskapis.dll\", \"taskbarcpl.dll\", \"taskcomp.dll\", \"taskschd.dll\", \"taskschdps.dll\", \"tbauth.dll\", \"tbs.dll\", \"tcbloader.dll\", \"tcpipcfg.dll\", \"tcpmib.dll\", \"tcpmon.dll\", \"tcpmonui.dll\", \"tdh.dll\", \"tdlmigration.dll\", \"tellib.dll\", \"termmgr.dll\", \"termsrv.dll\", \"tetheringclient.dll\", \"tetheringmgr.dll\", \"tetheringservice.dll\", \"tetheringstation.dll\", \"textshaping.dll\", \"themecpl.dll\", \"themeservice.dll\", \"themeui.dll\", \"threadpoolwinrt.dll\", \"thumbcache.dll\", \"timebrokerclient.dll\", \"timebrokerserver.dll\", \"timesync.dll\", \"timesynctask.dll\", \"tlscsp.dll\", \"tokenbinding.dll\", \"tokenbroker.dll\", \"tokenbrokerui.dll\", \"tpmcertresources.dll\", \"tpmcompc.dll\", \"tpmtasks.dll\", \"tpmvsc.dll\", \"tquery.dll\", \"traffic.dll\", \"transportdsa.dll\", \"trie.dll\", \"trkwks.dll\", \"tsbyuv.dll\", \"tscfgwmi.dll\", \"tserrredir.dll\", \"tsf3gip.dll\", \"tsgqec.dll\", \"tsmf.dll\", \"tspkg.dll\", \"tspubwmi.dll\", \"tssessionux.dll\", \"tssrvlic.dll\", \"tsworkspace.dll\", \"ttdloader.dll\", \"ttdplm.dll\", \"ttdrecord.dll\", \"ttdrecordcpu.dll\", \"ttlsauth.dll\", \"ttlscfg.dll\", \"ttlsext.dll\", \"tvratings.dll\", \"twext.dll\", \"twinapi.dll\", \"twinui.dll\", \"txflog.dll\", \"txfw32.dll\", \"tzautoupdate.dll\", \"tzres.dll\", \"tzsyncres.dll\", \"ubpm.dll\", \"ucmhc.dll\", \"ucrtbase.dll\", \"ucrtbase_clr0400.dll\", \"ucrtbase_enclave.dll\", \"udhisapi.dll\", \"udwm.dll\", \"ueficsp.dll\", \"uexfat.dll\", \"ufat.dll\", \"uiamanager.dll\", \"uianimation.dll\", \"uiautomationcore.dll\", \"uicom.dll\", \"uireng.dll\", \"uiribbon.dll\", \"uiribbonres.dll\", \"ulib.dll\", \"umb.dll\", \"umdmxfrm.dll\", \"umpdc.dll\", \"umpnpmgr.dll\", \"umpo-overrides.dll\", \"umpo.dll\", \"umpoext.dll\", \"umpowmi.dll\", \"umrdp.dll\", \"unattend.dll\", \"unenrollhook.dll\", \"unimdmat.dll\", \"uniplat.dll\", \"unistore.dll\", \"untfs.dll\", \"updateagent.dll\", \"updatecsp.dll\", \"updatepolicy.dll\", \"upnp.dll\", \"upnphost.dll\", \"upshared.dll\", \"urefs.dll\", \"urefsv1.dll\", \"ureg.dll\", \"url.dll\", \"urlmon.dll\", \"usbcapi.dll\", \"usbceip.dll\", \"usbmon.dll\", \"usbperf.dll\", \"usbpmapi.dll\", \"usbtask.dll\", \"usbui.dll\", \"user32.dll\", \"usercpl.dll\", \"userdataservice.dll\", \"userdatatimeutil.dll\", \"userenv.dll\", \"userinitext.dll\", \"usermgr.dll\", \"usermgrcli.dll\", \"usermgrproxy.dll\", \"usoapi.dll\", \"usocoreps.dll\", \"usosvc.dll\", \"usp10.dll\", \"ustprov.dll\", \"utcutil.dll\", \"utildll.dll\", \"uudf.dll\", \"uvcmodel.dll\", \"uwfcfgmgmt.dll\", \"uwfcsp.dll\", \"uwfservicingapi.dll\", \"uxinit.dll\", \"uxlib.dll\", \"uxlibres.dll\", \"uxtheme.dll\", \"vac.dll\", \"van.dll\", \"vault.dll\", \"vaultcds.dll\", \"vaultcli.dll\", \"vaultroaming.dll\", \"vaultsvc.dll\", \"vbsapi.dll\", \"vbscript.dll\", \"vbssysprep.dll\", \"vcardparser.dll\", \"vdsbas.dll\", \"vdsdyn.dll\", \"vdsutil.dll\", \"vdsvd.dll\", \"vds_ps.dll\", \"verifier.dll\", \"vertdll.dll\", \"vfuprov.dll\", \"vfwwdm32.dll\", \"vhfum.dll\", \"vid.dll\", \"videohandlers.dll\", \"vidreszr.dll\", \"virtdisk.dll\", \"vmbuspipe.dll\", \"vmdevicehost.dll\", \"vmictimeprovider.dll\", \"vmrdvcore.dll\", \"voiprt.dll\", \"vpnike.dll\", \"vpnikeapi.dll\", \"vpnsohdesktop.dll\", \"vpnv2csp.dll\", \"vscmgrps.dll\", \"vssapi.dll\", \"vsstrace.dll\", \"vss_ps.dll\", \"w32time.dll\", \"w32topl.dll\", \"waasassessment.dll\", \"waasmediccapsule.dll\", \"waasmedicps.dll\", \"waasmedicsvc.dll\", \"wabsyncprovider.dll\", \"walletproxy.dll\", \"walletservice.dll\", \"wavemsp.dll\", \"wbemcomn.dll\", \"wbiosrvc.dll\", \"wci.dll\", \"wcimage.dll\", \"wcmapi.dll\", \"wcmcsp.dll\", \"wcmsvc.dll\", \"wcnapi.dll\", \"wcncsvc.dll\", \"wcneapauthproxy.dll\", \"wcneappeerproxy.dll\", \"wcnnetsh.dll\", \"wcnwiz.dll\", \"wc_storage.dll\", \"wdc.dll\", \"wdi.dll\", \"wdigest.dll\", \"wdscore.dll\", \"webauthn.dll\", \"webcamui.dll\", \"webcheck.dll\", \"webclnt.dll\", \"webio.dll\", \"webservices.dll\", \"websocket.dll\", \"wecapi.dll\", \"wecsvc.dll\", \"wephostsvc.dll\", \"wer.dll\", \"werconcpl.dll\", \"wercplsupport.dll\", \"werenc.dll\", \"weretw.dll\", \"wersvc.dll\", \"werui.dll\", \"wevtapi.dll\", \"wevtfwd.dll\", \"wevtsvc.dll\", \"wfapigp.dll\", \"wfdprov.dll\", \"wfdsconmgr.dll\", \"wfdsconmgrsvc.dll\", \"wfhc.dll\", \"whealogr.dll\", \"whhelper.dll\", \"wiaaut.dll\", \"wiadefui.dll\", \"wiadss.dll\", \"wiarpc.dll\", \"wiascanprofiles.dll\", \"wiaservc.dll\", \"wiashext.dll\", \"wiatrace.dll\", \"wificloudstore.dll\", \"wificonfigsp.dll\", \"wifidisplay.dll\", \"wimgapi.dll\", \"win32spl.dll\", \"win32u.dll\", \"winbio.dll\", \"winbiodatamodel.dll\", \"winbioext.dll\", \"winbrand.dll\", \"wincorlib.dll\", \"wincredprovider.dll\", \"wincredui.dll\", \"windowmanagement.dll\", \"windowscodecs.dll\", \"windowscodecsext.dll\", \"windowscodecsraw.dll\", \"windowsiotcsp.dll\", \"windowslivelogin.dll\", \"winethc.dll\", \"winhttp.dll\", \"winhttpcom.dll\", \"winhvemulation.dll\", \"winhvplatform.dll\", \"wininet.dll\", \"wininetlui.dll\", \"wininitext.dll\", \"winipcfile.dll\", \"winipcsecproc.dll\", \"winipsec.dll\", \"winlangdb.dll\", \"winlogonext.dll\", \"winmde.dll\", \"winml.dll\", \"winmm.dll\", \"winmmbase.dll\", \"winmsipc.dll\", \"winnlsres.dll\", \"winnsi.dll\", \"winreagent.dll\", \"winrnr.dll\", \"winrscmd.dll\", \"winrsmgr.dll\", \"winrssrv.dll\", \"winrttracing.dll\", \"winsatapi.dll\", \"winscard.dll\", \"winsetupui.dll\", \"winshfhc.dll\", \"winsku.dll\", \"winsockhc.dll\", \"winsqlite3.dll\", \"winsrpc.dll\", \"winsrv.dll\", \"winsrvext.dll\", \"winsta.dll\", \"winsync.dll\", \"winsyncmetastore.dll\", \"winsyncproviders.dll\", \"wintrust.dll\", \"wintypes.dll\", \"winusb.dll\", \"wirednetworkcsp.dll\", \"wisp.dll\", \"wkscli.dll\", \"wkspbrokerax.dll\", \"wksprtps.dll\", \"wkssvc.dll\", \"wlanapi.dll\", \"wlancfg.dll\", \"wlanconn.dll\", \"wlandlg.dll\", \"wlangpui.dll\", \"wlanhc.dll\", \"wlanhlp.dll\", \"wlanmediamanager.dll\", \"wlanmm.dll\", \"wlanmsm.dll\", \"wlanpref.dll\", \"wlanradiomanager.dll\", \"wlansec.dll\", \"wlansvc.dll\", \"wlansvcpal.dll\", \"wlanui.dll\", \"wlanutil.dll\", \"wldap32.dll\", \"wldp.dll\", \"wlgpclnt.dll\", \"wlidcli.dll\", \"wlidcredprov.dll\", \"wlidfdp.dll\", \"wlidnsp.dll\", \"wlidprov.dll\", \"wlidres.dll\", \"wlidsvc.dll\", \"wmadmod.dll\", \"wmadmoe.dll\", \"wmalfxgfxdsp.dll\", \"wmasf.dll\", \"wmcodecdspps.dll\", \"wmdmlog.dll\", \"wmdmps.dll\", \"wmdrmsdk.dll\", \"wmerror.dll\", \"wmi.dll\", \"wmiclnt.dll\", \"wmicmiplugin.dll\", \"wmidcom.dll\", \"wmidx.dll\", \"wmiprop.dll\", \"wmitomi.dll\", \"wmnetmgr.dll\", \"wmp.dll\", \"wmpdui.dll\", \"wmpdxm.dll\", \"wmpeffects.dll\", \"wmphoto.dll\", \"wmploc.dll\", \"wmpps.dll\", \"wmpshell.dll\", \"wmsgapi.dll\", \"wmspdmod.dll\", \"wmspdmoe.dll\", \"wmvcore.dll\", \"wmvdecod.dll\", \"wmvdspa.dll\", \"wmvencod.dll\", \"wmvsdecd.dll\", \"wmvsencd.dll\", \"wmvxencd.dll\", \"woftasks.dll\", \"wofutil.dll\", \"wordbreakers.dll\", \"workfoldersgpext.dll\", \"workfoldersres.dll\", \"workfoldersshell.dll\", \"workfolderssvc.dll\", \"wosc.dll\", \"wow64.dll\", \"wow64cpu.dll\", \"wow64win.dll\", \"wpbcreds.dll\", \"wpc.dll\", \"wpcapi.dll\", \"wpcdesktopmonsvc.dll\", \"wpcproxystubs.dll\", \"wpcrefreshtask.dll\", \"wpcwebfilter.dll\", \"wpdbusenum.dll\", \"wpdshext.dll\", \"wpdshserviceobj.dll\", \"wpdsp.dll\", \"wpd_ci.dll\", \"wpnapps.dll\", \"wpnclient.dll\", \"wpncore.dll\", \"wpninprc.dll\", \"wpnprv.dll\", \"wpnservice.dll\", \"wpnsruprov.dll\", \"wpnuserservice.dll\", \"wpportinglibrary.dll\", \"wpprecorderum.dll\", \"wptaskscheduler.dll\", \"wpx.dll\", \"ws2help.dll\", \"ws2_32.dll\", \"wscapi.dll\", \"wscinterop.dll\", \"wscisvif.dll\", \"wsclient.dll\", \"wscproxystub.dll\", \"wscsvc.dll\", \"wsdapi.dll\", \"wsdchngr.dll\", \"wsdprintproxy.dll\", \"wsdproviderutil.dll\", \"wsdscanproxy.dll\", \"wsecedit.dll\", \"wsepno.dll\", \"wshbth.dll\", \"wshcon.dll\", \"wshelper.dll\", \"wshext.dll\", \"wshhyperv.dll\", \"wship6.dll\", \"wshqos.dll\", \"wshrm.dll\", \"wshtcpip.dll\", \"wshunix.dll\", \"wslapi.dll\", \"wsmagent.dll\", \"wsmauto.dll\", \"wsmplpxy.dll\", \"wsmres.dll\", \"wsmsvc.dll\", \"wsmwmipl.dll\", \"wsnmp32.dll\", \"wsock32.dll\", \"wsplib.dll\", \"wsp_fs.dll\", \"wsp_health.dll\", \"wsp_sr.dll\", \"wtsapi32.dll\", \"wuapi.dll\", \"wuaueng.dll\", \"wuceffects.dll\", \"wudfcoinstaller.dll\", \"wudfplatform.dll\", \"wudfsmcclassext.dll\", \"wudfx.dll\", \"wudfx02000.dll\", \"wudriver.dll\", \"wups.dll\", \"wups2.dll\", \"wuuhext.dll\", \"wuuhosdeployment.dll\", \"wvc.dll\", \"wwaapi.dll\", \"wwaext.dll\", \"wwanapi.dll\", \"wwancfg.dll\", \"wwanhc.dll\", \"wwanprotdim.dll\", \"wwanradiomanager.dll\", \"wwansvc.dll\", \"wwapi.dll\", \"xamltilerender.dll\", \"xaudio2_8.dll\", \"xaudio2_9.dll\", \"xblauthmanager.dll\", \"xblgamesave.dll\", \"xblgamesaveext.dll\", \"xblgamesaveproxy.dll\", \"xboxgipsvc.dll\", \"xboxgipsynthetic.dll\", \"xboxnetapisvc.dll\", \"xinput1_4.dll\", \"xinput9_1_0.dll\", \"xinputuap.dll\", \"xmlfilter.dll\", \"xmllite.dll\", \"xmlprovi.dll\", \"xolehlp.dll\", \"xpsgdiconverter.dll\", \"xpsprint.dll\", \"xpspushlayer.dll\", \"xpsrasterservice.dll\", \"xpsservices.dll\", \"xwizards.dll\", \"xwreg.dll\", \"xwtpdui.dll\", \"xwtpw32.dll\", \"zipcontainer.dll\", \"zipfldr.dll\", \"bootsvc.dll\", \"halextintcpsedma.dll\", \"icsvcvss.dll\", \"ieproxydesktop.dll\", \"lsaadt.dll\", \"nlansp_c.dll\", \"nrtapi.dll\", \"opencl.dll\", \"pfclient.dll\", \"pnpdiag.dll\", \"prxyqry.dll\", \"rdpnanotransport.dll\", \"servicingcommon.dll\", \"sortwindows63.dll\", \"sstpcfg.dll\", \"tdhres.dll\", \"umpodev.dll\", \"utcapi.dll\", \"windlp.dll\", \"wow64base.dll\", \"wow64con.dll\", \"blbuires.dll\", \"bpainst.dll\", \"cbclient.dll\", \"certadm.dll\", \"certocm.dll\", \"certpick.dll\", \"csdeployres.dll\", \"dsdeployres.dll\", \"eapa3hst.dll\", \"eapacfg.dll\", \"eapahost.dll\", \"elsext.dll\", \"encdump.dll\", \"escmigplugin.dll\", \"fsclient.dll\", \"fsdeployres.dll\", \"fssminst.dll\", \"fssmres.dll\", \"fssprov.dll\", \"ipamapi.dll\", \"kpssvc.dll\", \"lbfoadminlib.dll\", \"mintdh.dll\", \"mmci.dll\", \"mmcico.dll\", \"mprsnap.dll\", \"mstsmhst.dll\", \"mstsmmc.dll\", \"muxinst.dll\", \"personax.dll\", \"rassfm.dll\", \"rasuser.dll\", \"rdmsinst.dll\", \"rdmsres.dll\", \"rtrfiltr.dll\", \"sacsvr.dll\", \"scrdenrl.dll\", \"sdclient.dll\", \"sharedstartmodel.dll\", \"smsrouter.dll\", \"spwizimg_svr.dll\", \"sqlcecompact40.dll\", \"sqlceoledb40.dll\", \"sqlceqp40.dll\", \"sqlcese40.dll\", \"srvmgrinst.dll\", \"svrmgrnc.dll\", \"tapisnap.dll\", \"tlsbrand.dll\", \"tsec.dll\", \"tsprop.dll\", \"tspubiconhelper.dll\", \"tssdjet.dll\", \"tsuserex.dll\", \"ualapi.dll\", \"ualsvc.dll\", \"umcres.dll\", \"updatehandlers.dll\", \"usocore.dll\", \"vssui.dll\", \"wsbappres.dll\", \"wsbonline.dll\", \"wsmselpl.dll\", \"wsmselrr.dll\", \"xpsfilt.dll\", \"xpsshhdr.dll\"\n    ) and\n    not (\n      (\n        dll.name : \"icuuc.dll\" and dll.code_signature.subject_name in (\n          \"Valve\", \"Valve Corp.\", \"Avanquest Software (7270356 Canada Inc)\", \"Adobe Inc.\"\n        ) and dll.code_signature.trusted == true\n      ) or\n      (\n        dll.name : (\"timeSync.dll\", \"appInfo.dll\") and dll.code_signature.subject_name in (\n          \"VMware Inc.\", \"VMware, Inc.\"\n        ) and dll.code_signature.trusted == true\n      ) or\n      (\n        dll.name : \"libcrypto.dll\" and dll.code_signature.subject_name in (\n          \"NoMachine S.a.r.l.\", \"Oculus VR, LLC\"\n        ) and dll.code_signature.trusted == true\n      ) or\n      (\n        dll.name : \"ucrtbase.dll\" and dll.code_signature.subject_name in (\n          \"Proofpoint, Inc.\", \"Rapid7 LLC\", \"Eclipse.org Foundation, Inc.\", \"Amazon.com Services LLC\", \"Windows Phone\"\n        ) and dll.code_signature.trusted == true\n      ) or\n      (\n        dll.name : (\"libcrypto.dll\", \"wmi.dll\", \"geolocation.dll\", \"kerberos.dll\") and\n        dll.code_signature.subject_name == \"Bitdefender SRL\" and dll.code_signature.trusted == true\n      ) or\n      (dll.name : \"ICMP.dll\" and dll.code_signature.subject_name == \"Paessler AG\" and dll.code_signature.trusted == true) or\n      (dll.name : \"dbghelp.dll\" and dll.code_signature.trusted == true) or\n      (dll.name : \"DirectML.dll\" and dll.code_signature.subject_name == \"Adobe Inc.\" and dll.code_signature.trusted == true) or\n      (dll.name : \"icsvc.dll\" and dll.code_signature.subject_name in (\"Dell Inc\", \"Dell Technologies Inc.\") and dll.code_signature.trusted == true) or\n      (dll.name : \"offreg.dll\" and dll.code_signature.subject_name == \"Malwarebytes Inc.\" and dll.code_signature.trusted == true) or\n      (dll.name : \"AppMgr.dll\" and dll.code_signature.subject_name == \"Autodesk, Inc\" and dll.code_signature.trusted == true) or\n      (dll.name : (\"SsShim.dll\", \"Msi.dll\", \"wdscore.dll\") and process.name : \"DismHost.exe\" and dll.path : \"C:\\\\Windows\\\\Temp\\\\*\") or\n      (\n        dll.path : (\n          \"?:\\\\Windows\\\\SystemApps\\\\*\\\\dxgi.dll\",\n          \"?:\\\\Windows\\\\SystemApps\\\\*\\\\wincorlib.dll\",\n          \"?:\\\\Windows\\\\dxgi.dll\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\LINE\\\\bin\\\\current\\\\dbghelp.dll\"\n        )\n      )\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "AWS Configuration Recorder Stopped",
        "description": "Identifies an AWS configuration change to stop recording a designated set of resources.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Recording changes from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/configservice/stop-configuration-recorder.html",
          "https://docs.aws.amazon.com/config/latest/APIReference/API_StopConfigurationRecorder.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cd8f3b15-5d33-4880-8f82-85ca62a936f9",
        "rule_id": "fbd44836-0d69-4004-a0b4-03c20370c435",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.397Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.601Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:config.amazonaws.com and event.action:StopConfigurationRecorder and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Image Loaded with Invalid Signature",
        "description": "Identifies binaries that are loaded and with an invalid code signature. This may indicate an attempt to masquerade as a signed binary.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.Ext.relative_file_creation_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.Ext.relative_file_name_modify_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3d5e94da-cafd-4d97-b5cf-3c27f7d2b007",
        "rule_id": "fd9484f2-1c56-44ae-8b28-dc1354e3a0e8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.399Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.777Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where host.os.type == \"windows\" and event.action == \"load\" and\n  dll.code_signature.status : (\"errorUntrustedRoot\", \"errorBadDigest\", \"errorUntrustedRoot\") and\n  (dll.Ext.relative_file_creation_time <= 500 or dll.Ext.relative_file_name_modify_time <= 500) and\n  not startswith~(dll.name, process.name) and\n  not dll.path : (\n    \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Masquerading as Business App Installer",
        "description": "Identifies executables with names resembling legitimate business applications but lacking signatures from the original developer. Attackers may trick users into downloading malicious executables that masquerade as legitimate applications via malicious ads, forum posts, and tutorials, effectively gaining initial access.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "Data Source: Elastic Defend",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Initial Access",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.rapid7.com/blog/post/2023/08/31/fake-update-utilizes-new-idat-loader-to-execute-stealc-and-lumma-infostealers"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  },
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1189",
                "name": "Drive-by Compromise",
                "reference": "https://attack.mitre.org/techniques/T1189/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "692fa08b-4731-45a8-a19b-5de635a7e7bf",
        "rule_id": "feafdc51-c575-4ed2-89dd-8e20badc2d6c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.401Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.814Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and process.executable : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\" and\n  not process.code_signature.status : (\"errorCode_endpoint*\", \"errorUntrustedRoot\", \"errorChaining\") and\n  (\n    /* Slack */\n    (process.name : \"*slack*.exe\" and not\n      (process.code_signature.subject_name in (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"*webex*.exe\" and not\n      (process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"teams*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"*discord*.exe\" and not\n      (process.code_signature.subject_name == \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"*whatsapp*.exe\" and not\n      (process.code_signature.subject_name in (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : (\"*zoom*installer*.exe\", \"*zoom*setup*.exe\", \"zoom.exe\")  and not\n      (process.code_signature.subject_name == \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"*outlook*.exe\" and not\n      (\n        (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) or\n        (\n          process.name: \"MSOutlookHelp-PST-Viewer.exe\" and process.code_signature.subject_name == \"Aryson Technologies Pvt. Ltd\" and\n          process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"*thunderbird*.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Grammarly */\n    (process.name : \"*grammarly*.exe\" and not\n      (process.code_signature.subject_name == \"Grammarly, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Dropbox */\n    (process.name : \"*dropbox*.exe\" and not\n      (process.code_signature.subject_name == \"Dropbox, Inc\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Tableau */\n    (process.name : \"*tableau*.exe\" and not\n      (process.code_signature.subject_name == \"Tableau Software LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Google Drive */\n    (process.name : \"*googledrive*.exe\" and not\n      (process.code_signature.subject_name == \"Google LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* MSOffice */\n    (process.name : \"*office*setup*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Okta */\n    (process.name : \"*okta*.exe\" and not\n      (process.code_signature.subject_name == \"Okta, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* OneDrive */\n    (process.name : \"*onedrive*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Chrome */\n    (process.name : \"*chrome*.exe\" and not\n      (process.code_signature.subject_name in (\"Google LLC\", \"Google Inc\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Firefox */\n    (process.name : \"*firefox*.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Edge */\n    (process.name : (\"*microsoftedge*.exe\", \"*msedge*.exe\") and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Brave */\n    (process.name : \"*brave*.exe\" and not\n      (process.code_signature.subject_name == \"Brave Software, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* GoogleCloud Related Tools */\n    (process.name : \"*GoogleCloud*.exe\" and not\n      (process.code_signature.subject_name == \"Google LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Github Related Tools */\n    (process.name : \"*github*.exe\" and not\n      (process.code_signature.subject_name == \"GitHub, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Notion */\n    (process.name : \"*notion*.exe\" and not\n      (process.code_signature.subject_name == \"Notion Labs, Inc.\" and process.code_signature.trusted == true)\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Execution via MS VisualStudio Pre/Post Build Events",
        "description": "Identifies the execution of a command via Microsoft Visual Studio Pre or Post build events. Adversaries may backdoor a trusted visual studio project to execute a malicious command during the project build process.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/visualstudio/ide/reference/pre-build-event-post-build-event-command-line-dialog-box?view=vs-2022",
          "https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/threat-actor-of-in-tur-est.html",
          "https://blog.google/threat-analysis-group/new-campaign-targeting-security-researchers/",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Execution/execution_evasion_visual_studio_prebuild_event.evtx"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8631b8bc-ebc4-441b-84d2-fa7cda514989",
        "rule_id": "fec7ccb7-6ed9-4f98-93ab-d6b366b063a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.402Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.781Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.action == \"start\" and\n   process.name : \"cmd.exe\" and process.parent.name : \"MSBuild.exe\" and\n   process.args : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp*.exec.cmd\"] by process.entity_id\n  [process where host.os.type == \"windows\" and event.action == \"start\" and\n    process.name : (\n      \"cmd.exe\", \"powershell.exe\",\n      \"MSHTA.EXE\", \"CertUtil.exe\",\n      \"CertReq.exe\", \"rundll32.exe\",\n      \"regsvr32.exe\", \"MSbuild.exe\",\n      \"cscript.exe\", \"wscript.exe\",\n      \"installutil.exe\"\n    ) and\n    not \n    (\n      process.name : (\"cmd.exe\", \"powershell.exe\") and\n      process.args : (\n        \"*\\\\vcpkg\\\\scripts\\\\buildsystems\\\\msbuild\\\\applocal.ps1\",\n        \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\VisualStudio\\\\SxS\\\\VS?\",\n        \"process.versions.node*\",\n        \"?:\\\\Program Files\\\\nodejs\\\\node.exe\",\n        \"HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\MSBuild\\\\ToolsVersions\\\\*\",\n        \"*Get-ChildItem*Tipasplus.css*\",\n        \"Build\\\\GenerateResourceScripts.ps1\",\n        \"Shared\\\\Common\\\\..\\\\..\\\\BuildTools\\\\ConfigBuilder.ps1\\\"\",\n        \"?:\\\\Projets\\\\*\\\\PostBuild\\\\MediaCache.ps1\"\n      )\n    ) and\n    not process.executable : \"?:\\\\Program Files*\\\\Microsoft Visual Studio\\\\*\\\\MSBuild.exe\" and\n    not (process.name : \"cmd.exe\" and\n         process.command_line :\n                  (\"*vswhere.exe -property catalog_productSemanticVersion*\",\n                   \"*git log --pretty=format*\", \"*\\\\.nuget\\\\packages\\\\vswhere\\\\*\",\n                   \"*Common\\\\..\\\\..\\\\BuildTools\\\\*\"))\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Potential DGA Activity",
        "description": "A population analysis machine learning job detected potential DGA (domain generation algorithm) activity. Such activity is often used by malware command and control (C2) channels. This machine learning job looks for a source IP address making DNS requests that have an aggregate high probability of being DGA activity.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Use Case: Domain Generation Algorithm Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Command and Control"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/dga",
          "https://www.elastic.co/security-labs/detect-domain-generation-algorithm-activity-with-new-kibana-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1568",
                "name": "Dynamic Resolution",
                "reference": "https://attack.mitre.org/techniques/T1568/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Domain Generation Algorithm (DGA) Detection integration assets to be installed, as well as DNS events collected by integrations such as Elastic Defend, Network Packet Capture, or Packetbeat.  \n\n### DGA Detection Setup\nThe DGA Detection integration consists of an ML-based framework to detect DGA activity in DNS events.\n\n#### Prerequisite Requirements:\n- Fleet is required for DGA Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- DNS events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint), [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration, or [Packetbeat](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.\n- To set up and run Packetbeat, follow [this](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html) guide.\n\n#### The following steps should be executed to install assets associated with the DGA Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Domain Generation Algorithm Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n\n### Anomaly Detection Setup\nBefore you can enable this rule, you'll need to enable the corresponding Anomaly Detection job. \n- Go to the Kibana homepage. Under Analytics, click Machine Learning.\n- Under Anomaly Detection, click Jobs, and then click \"Create job\". Select the Data View containing your enriched DNS events. For example, this would be `logs-endpoint.events.*` if you used Elastic Defend to collect events, or `logs-network_traffic.*` if you used Network Packet Capture.\n- If the selected Data View contains events that match the query in [this](https://github.com/elastic/integrations/blob/main/packages/dga/kibana/ml_module/dga-ml.json) configuration file, you will see a card for DGA under \"Use preconfigured jobs\".\n- Keep the default settings and click \"Create jobs\" to start the anomaly detection job and datafeed.\n",
        "related_integrations": [
          {
            "package": "dga",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "3a2fb609-b539-4dd6-9356-ffbaa27bf1f8",
        "rule_id": "ff0d807d-869b-4a0d-a493-52bc46d2f1b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.404Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:26.784Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 70,
        "machine_learning_job_id": [
          "dga_high_sum_probability"
        ]
      },
      {
        "name": "PowerShell Suspicious Script with Screenshot Capabilities",
        "description": "Detects PowerShell scripts that can take screenshots, which is a common feature in post-exploitation kits and remote access tools (RATs).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Screenshot Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, which makes it available for use in various environments and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities and take screen captures of desktops to gather information over the course of an operation.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to take screenshots, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/dotnet/api/system.drawing.graphics.copyfromscreen"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1113",
                "name": "Screen Capture",
                "reference": "https://attack.mitre.org/techniques/T1113/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "05dc6796-6ac0-49a7-a46b-c140b0a5fbf9",
        "rule_id": "959a7353-1129-4aa7-9084-30746b256a70",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.409Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.714Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    CopyFromScreen and\n    (\"System.Drawing.Bitmap\" or \"Drawing.Bitmap\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "File made Immutable by Chattr",
        "description": "Detects a file being made immutable using the chattr binary. Making a file immutable means it cannot be deleted or renamed, no link can be created to this file, most of the file's metadata can not be modified, and the file can not be opened in write mode. Threat actors will commonly utilize this to prevent tampering or modification of their malicious files or any system files they have modified for purposes of persistence (e.g .ssh, /etc/passwd, etc.).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.002",
                    "name": "Linux and Mac File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "710ad6d2-3dfa-4901-b949-e8f45cdbbb1a",
        "rule_id": "968ccab9-da51-4a87-9ce2-d3c9782fd759",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.411Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:08.182Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.parent.executable != null and\nprocess.executable : \"/usr/bin/chattr\" and process.args : (\"-*i*\", \"+*i*\") and not (\n  process.parent.executable: (\"/lib/systemd/systemd\", \"/usr/local/uems_agent/bin/*\", \"/usr/lib/systemd/systemd\") or\n  process.parent.name in (\n    \"systemd\", \"cf-agent\", \"ntpdate\", \"xargs\", \"px\", \"preinst\", \"auth\", \"cf-agent\", \"dcservice\", \"dcagentupgrader\",\n    \"sudo\", \"ephemeral-disk-warning\"\n  )\n)",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Access to Keychain Credentials Directories",
        "description": "Adversaries may collect the keychain storage data from a system to acquire credentials. Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features such as WiFi passwords, websites, secure notes and certificates.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://objective-see.com/blog/blog_0x25.html",
          "https://securelist.com/calisto-trojan-for-macos/86543/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.001",
                    "name": "Keychain",
                    "reference": "https://attack.mitre.org/techniques/T1555/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "75c5922c-8947-407c-981e-9e18fa1fbcc5",
        "rule_id": "96e90768-c3b7-4df6-b5d9-6237f8bc36a8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.413Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.534Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.args :\n    (\n      \"/Users/*/Library/Keychains/*\",\n      \"/Library/Keychains/*\",\n      \"/Network/Library/Keychains/*\",\n      \"System.keychain\",\n      \"login.keychain-db\",\n      \"login.keychain\"\n    ) and\n    not process.args : (\"find-certificate\",\n                        \"add-trusted-cert\",\n                        \"set-keychain-settings\",\n                        \"delete-certificate\",\n                        \"/Users/*/Library/Keychains/openvpn.keychain-db\",\n                        \"show-keychain-info\",\n                        \"lock-keychain\",\n                        \"set-key-partition-list\",\n                        \"import\",\n                        \"find-identity\") and\n    not process.parent.executable :\n      (\n        \"/Applications/OpenVPN Connect/OpenVPN Connect.app/Contents/MacOS/OpenVPN Connect\",\n        \"/Applications/Microsoft Defender.app/Contents/MacOS/wdavdaemon_enterprise.app/Contents/MacOS/wdavdaemon_enterprise\",\n        \"/opt/jc/bin/jumpcloud-agent\"\n      ) and\n    not process.executable : (\"/opt/jc/bin/jumpcloud-agent\", \"/usr/bin/basename\") and\n    not process.Ext.effective_parent.executable : (\"/opt/rapid7/ir_agent/ir_agent\",\n                                                   \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\",\n                                                   \"/Applications/QualysCloudAgent.app/Contents/MacOS/qualys-cloud-agent\",\n                                                   \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon\",\n                                                   \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfManagementService.app/Contents/MacOS/JamfManagementService\",\n                                                   \"/usr/local/jamf/bin/jamf\",\n                                                   \"/Applications/Microsoft Defender.app/Contents/MacOS/wdavdaemon\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "SeDebugPrivilege Enabled by a Suspicious Process",
        "description": "Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4703",
          "https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nWindows Event 4703 logs Token Privileges changes and need to be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDetailed Tracking >\nToken Right Adjusted Events (Success)\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.EnabledPrivilegeList",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "14bfdd6f-be55-4ba9-b5cd-e2e0d6d35ff2",
        "rule_id": "97020e61-e591-4191-8a3b-2861a2b887cd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.415Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.722Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.provider: \"Microsoft-Windows-Security-Auditing\" and\n event.action : \"Token Right Adjusted Events\" and\n\n winlog.event_data.EnabledPrivilegeList : \"SeDebugPrivilege\" and\n\n /* exclude processes with System Integrity  */\n not winlog.event_data.SubjectUserSid : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n\n not winlog.event_data.ProcessName :\n         (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Program Files\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n          \"?:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n          \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n          \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*-*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\auditpol.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSe.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSe.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Renaming of ESXI Files",
        "description": "Identifies instances where VMware-related files, such as those with extensions like \".vmdk\", \".vmx\", \".vmxf\", \".vmsd\", \".vmsn\", \".vswp\", \".vmss\", \".nvram\", and \".vmem\", are renamed on a Linux system. The rule monitors for the \"rename\" event action associated with these file types, which could indicate malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ab8554c3-88e9-4987-8fe3-8b14144931e2",
        "rule_id": "97db8b42-69d8-4bf3-9fd4-c69a1d895d68",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.416Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.288Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action == \"rename\" and\nfile.Ext.original.name : (\"*.vmdk\", \"*.vmx\", \"*.vmxf\", \"*.vmsd\", \"*.vmsn\", \"*.vswp\", \"*.vmss\", \"*.nvram\", \"*.vmem\")\nand not file.name : (\"*.vmdk\", \"*.vmx\", \"*.vmxf\", \"*.vmsd\", \"*.vmsn\", \"*.vswp\", \"*.vmss\", \"*.nvram\", \"*.vmem\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via LSASS Memory Dump",
        "description": "Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export the MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic:Execution",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz",
          "https://www.elastic.co/security-labs/detect-credential-access",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "45dd576d-7df5-4295-8ee1-433ca218715d",
        "rule_id": "9960432d-9b26-409f-972b-839a959e79e2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.418Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.244Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/\n  winlog.event_data.CallTrace : (\"*dbghelp*\", \"*dbgcore*\") and\n\n   /* case of lsass crashing */\n  not process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n      )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shadow File Read via Command Line Utilities",
        "description": "Identifies access to the /etc/shadow file via the commandline using standard system utilities. After elevating privileges to root, threat actors may attempt to read or dump this file in order to gain valid credentials. They may utilize these to move laterally undetected and access additional resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f4bacd0d-7170-4c9c-9216-95261ef98404",
        "rule_id": "9a3a3689-8ed1-4cdb-83fb-9506db54c61f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.420Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.247Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type : \"linux\" and event.category : \"process\" and event.action : (\"exec\" or \"exec_event\") and\n(process.args : \"/etc/shadow\" or (process.working_directory: \"/etc\" and process.args: \"shadow\")) and not (\n  (process.executable : (\"/bin/chown\" or \"/usr/bin/chown\") and process.args : \"root:shadow\") or\n  (process.executable : (\"/bin/chmod\" or \"/usr/bin/chmod\") and process.args : \"640\") or\n  process.executable:(/vz/* or /var/lib/docker/* or /run/containerd/* or /tmp/.criu* or /tmp/newroot/*) or\n  process.parent.name:(gen_passwd_sets or scc_* or wazuh-modulesd)\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Explorer Child Process",
        "description": "Identifies a suspicious Windows explorer child process. Explorer.exe can be abused to launch malicious scripts or executables from a trusted parent process.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "488a6f38-b781-438c-ade0-da8cfd5ee378",
        "rule_id": "9a5b4e31-6cde-4295-9ff7-6be1b8567e1b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.422Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.291Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"rundll32.exe\", \"cmd.exe\", \"mshta.exe\", \"regsvr32.exe\") or\n   ?process.pe.original_file_name in (\"cscript.exe\", \"wscript.exe\", \"PowerShell.EXE\", \"RUNDLL32.EXE\", \"Cmd.Exe\", \"MSHTA.EXE\", \"REGSVR32.EXE\")\n  ) and\n  /* Explorer started via DCOM */\n  process.parent.name : \"explorer.exe\" and process.parent.args : \"-Embedding\" and\n  not process.parent.args:\n          (\n            /* Noisy CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs   */\n            \"/factory,{5BD95610-9434-43C2-886C-57852CC8A120}\",\n            \"/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}\"\n          )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started by a Script Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by a script or the Windows command interpreter. This behavior is unusual and is sometimes used by malicious payloads.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0883edb9-1b76-4790-a402-6d4e9f9bd8e0",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.424Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.250Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and (\n  process.name.caseless:\"msbuild.exe\" or process.pe.original_file_name:\"MSBuild.exe\") and \n  process.parent.name:(\"cmd.exe\" or \"powershell.exe\" or \"pwsh.exe\" or \"powershell_ise.exe\" or \"cscript.exe\" or\n    \"wscript.exe\" or \"mshta.exe\")",
        "new_terms_fields": [
          "host.id",
          "user.name",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Microsoft Build Engine Started by a System Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management Instrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fd4dc866-a934-40e1-8701-7b936e98065d",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.425Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.307Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"explorer.exe\", \"wmiprvse.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Using an Alternate Name",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and may indicate an attempt to run unnoticed or undetected.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Microsoft Build Engine Using an Alternate Name\n\nThe OriginalFileName attribute of a PE (Portable Executable) file is a metadata field that contains the original name of the executable file when compiled or linked. By using this attribute, analysts can identify renamed instances that attackers can use with the intent of evading detections, application allowlists, and other security protections.\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software, and can be abused to proxy execution of code.\n\nThis rule checks for renamed instances of MSBuild, which can indicate an attempt of evading detections, application allowlists, and other security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b66262f8-5b71-450b-a216-4177432f511b",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.427Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:08.188Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name == \"MSBuild.exe\" and\n  not process.name : \"MSBuild.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started an Unusual Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, started a PowerShell script or the Visual C# Command Line Compiler. This technique is sometimes used to deploy a malicious payload using the Build Engine.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. If a build system triggers this rule it can be exempted by process, user or host name."
        ],
        "references": [
          "https://blog.talosintelligence.com/2020/02/building-bypass-with-msbuild.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/",
                "subtechnique": [
                  {
                    "id": "T1027.004",
                    "name": "Compile After Delivery",
                    "reference": "https://attack.mitre.org/techniques/T1027/004/"
                  }
                ]
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bde5cd88-5e28-47dc-843e-6807195ea7c0",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.429Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.254Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and process.parent.name:(\"MSBuild.exe\" or \"msbuild.exe\") and\nprocess.name:(\"csc.exe\" or \"iexplore.exe\" or \"powershell.exe\")",
        "new_terms_fields": [
          "host.id",
          "user.name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Protocol Tunneling via EarthWorm",
        "description": "Identifies the execution of the EarthWorm tunneler. Adversaries may tunnel network communications to and from a victim system within a separate protocol to avoid detection and network filtering, or to enable access to otherwise unreachable systems.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Protocol Tunneling via EarthWorm\n\nAttackers can leverage `earthworm` to clandestinely tunnel network communications and evade security measures, potentially gaining unauthorized access to sensitive systems.\n\nThis rule looks for several command line arguments that are consistent with `earthworm` tunneling behavior. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate protocol tunneling. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Protocol Tunneling via Chisel Client - 3f12325a-4cc6-410b-8d4c-9fbbeb744cfd\n- Potential Protocol Tunneling via Chisel Server - ac8805f6-1e08-406c-962e-3937057fa86f\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://rootkiter.com/EarthWorm/",
          "https://decoded.avast.io/luigicamastra/apt-group-targeting-governmental-agencies-in-east-asia/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in either from Elastic Defend, or Auditbeat integration.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fee8157a-9e78-4cc7-a656-c2badcab4475",
        "rule_id": "9f1c4ca3-44b5-481d-ba42-32dc215a2769",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.430Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.257Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n process.args : \"-s\" and process.args : \"-d\" and process.args : \"rssocks\"",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "File Permission Modification in Writable Directory",
        "description": "Identifies file permission modifications in common writable directories by a non-root user. Adversaries often drop files or payloads into a writable directory and change permissions prior to execution.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain programs or applications may modify files or change ownership in writable directories. These can be exempted by username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "be4246d7-f9c9-4dba-af53-da65fd09db10",
        "rule_id": "9f9a2a82-93a8-4b1a-8778-1780895626d4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.434Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.260Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and\nprocess.name:(chattr or chgrp or chmod or chown) and process.working_directory:(/dev/shm or /tmp or /var/tmp) and\nnot process.parent.name:(apt-key or update-motd-updates-available or apt-get)",
        "new_terms_fields": [
          "host.id",
          "process.parent.executable",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Credential Access via DCSync",
        "description": "This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys used legitimately for tickets creation, but also tickets forging by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for Event ID 4662 (Operation was performed on an Active Directory object) and identifies events that use the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set). It also filters out events that use computer accounts and also Azure AD Connect MSOL accounts (more details [here](https://techcommunity.microsoft.com/t5/microsoft-defender-for-identity/ad-connect-msol-user-suspected-dcsync-attack/m-p/788028)).\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect, investigate if it is the case, and if it is properly secured. If noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. If this rule is noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html",
          "https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md",
          "https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync",
          "https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.006",
                    "name": "DCSync",
                    "reference": "https://attack.mitre.org/techniques/T1003/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c4d8ac9d-c5c7-4116-a41a-8c61e8a48b3b",
        "rule_id": "9f962927-1a4f-45f3-a57b-287f2c7029c1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.432Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:08.191Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action : (\"Directory Service Access\", \"object-operation-performed\") and\n  event.code == \"4662\" and winlog.event_data.Properties : (\n\n    /* Control Access Rights/Permissions Symbol */\n\n    \"*DS-Replication-Get-Changes*\",\n    \"*DS-Replication-Get-Changes-All*\",\n    \"*DS-Replication-Get-Changes-In-Filtered-Set*\",\n\n    /* Identifying GUID used in ACE */\n\n    \"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*89e95b76-444d-4c62-991a-0facbeda640c*\")\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    and winlog.event_data.AccessMask : \"0x100\" and\n    not winlog.event_data.SubjectUserName : (\n          \"*$\", \"MSOL_*\", \"OpenDNS_Connector\", \"adconnect\", \"SyncADConnect\",\n          \"SyncADConnectCM\", \"aadsync\", \"svcAzureADSync\", \"-\"\n        )\n\n    /* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Python cap_setuid",
        "description": "This detection rule monitors for the execution of a system command with setuid or setgid capabilities via Python, followed by a uid or gid change to the root user. This sequence of events may indicate successful privilege escalation. Setuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group. Threat actors can exploit these attributes to escalate privileges to the privileges that are set on the binary that is being executed.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2d63fefe-e3e8-478f-afb9-986f476133d7",
        "rule_id": "a0ddb77b-0318-41f0-91e4-8c1b5528834f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.436Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.817Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args : \"import os;os.set?id(0);os.system(*)\" and process.args : \"*python*\" and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action in (\"uid_change\", \"gid_change\") and event.type == \"change\" and \n   (user.id == \"0\" or group.id == \"0\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential LSASS Clone Creation via PssCaptureSnapShot",
        "description": "Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS process instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/",
          "https://medium.com/@Achilles8284/the-birth-of-a-process-part-2-97c6fb9c42a2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis is meant to run only on datasources using Windows security event 4688 that captures the process clone creation.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e729c6b-b4f3-4ad1-9eee-c167e301d3cb",
        "rule_id": "a16612dd-b30e-4d41-86a0-ebe70974ec00",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.437Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.839Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Reverse Shell Activity via Terminal",
        "description": "Identifies the execution of a shell process with suspicious arguments which may be indicative of reverse shell activity.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Reverse Shell Activity via Terminal\n\nA reverse shell is a mechanism that's abused to connect back to an attacker-controlled system. It effectively redirects the system's input and output and delivers a fully functional remote shell to the attacker. Even private systems are vulnerable since the connection is outgoing. This activity is typically the result of vulnerability exploitation, malware infection, or penetration testing.\n\nThis rule identifies commands that are potentially related to reverse shell activities using shell applications.\n\n#### Possible investigation steps\n\n- Examine the command line and extract the target domain or IP address information.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n  - Scope other potentially compromised hosts in your environment by mapping hosts that also communicated with the domain or IP address.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md",
          "https://github.com/WangYihang/Reverse-Shell-Manager",
          "https://www.netsparker.com/blog/web-security/understanding-reverse-shells/",
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "032652d5-6124-41d9-b797-dbc6a14d0c4b",
        "rule_id": "a1a0375f-22c2-48c0-81a4-7c2d11cc6856",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.439Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.324Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type in (\"start\", \"process_started\") and\n  process.name in (\"sh\", \"bash\", \"zsh\", \"dash\", \"zmodload\") and\n  process.args : (\"*/dev/tcp/*\", \"*/dev/udp/*\", \"*zsh/net/tcp*\", \"*zsh/net/udp*\") and\n\n  /* noisy FPs */\n  not (process.parent.name : \"timeout\" and process.executable : \"/var/lib/docker/overlay*\") and\n  not process.command_line : (\n    \"*/dev/tcp/sirh_db/*\", \"*/dev/tcp/remoteiot.com/*\", \"*dev/tcp/elk.stag.one/*\", \"*dev/tcp/kafka/*\",\n    \"*/dev/tcp/$0/$1*\", \"*/dev/tcp/127.*\", \"*/dev/udp/127.*\", \"*/dev/tcp/localhost/*\", \"*/dev/tcp/itom-vault/*\") and\n  not process.parent.command_line : \"runc init\"",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Linux Group Creation",
        "description": "Identifies attempts to create a new group. Attackers may create new groups to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux Group Creation\n\nThe `groupadd` and `addgroup` commands are used to create new user groups in Linux-based operating systems.\n\nAttackers may create new groups to maintain access to victim systems or escalate privileges by assigning a compromised account to a privileged group.\n\nThis rule identifies the usages of `groupadd` and `addgroup` to create new groups.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the group was created succesfully.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Identify if a user account was added to this group after creation.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Group creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the created group and, in case an account was added to this group, delete the account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete Setup and Run Filebeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the Filebeat System Module to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bdde1e51-b011-44fb-8c55-e9fa8acffbf5",
        "rule_id": "a1c2589e-0c8c-4ca8-9eb6-f83c4bbdbe8f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.441Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.848Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where host.os.type == \"linux\" and (event.type == \"group\" and event.type == \"creation\") and\nprocess.name in (\"groupadd\", \"addgroup\") and group.name != null",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "DNS-over-HTTPS Enabled via Registry",
        "description": "Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltrating data. With this enabled, an organization will lose visibility into data such as query type, response, and originating IP, which are used to determine bad actors.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://www.tenforums.com/tutorials/151318-how-enable-disable-dns-over-https-doh-microsoft-edge.html",
          "https://chromeenterprise.google/policies/?policy=DnsOverHttpsMode"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a6b34495-a39e-44f6-a3ea-0d32085fc835",
        "rule_id": "a22a09c2-2162-4df0-a356-9aacbeb56a04",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.450Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.327Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Edge\\\\BuiltInDnsClientEnabled\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"*\\\\SOFTWARE\\\\Google\\\\Chrome\\\\DnsOverHttpsMode\" and\n  registry.data.strings : \"secure\") or\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Mozilla\\\\Firefox\\\\DNSOverHTTPS\" and\n  registry.data.strings : (\"1\", \"0x00000001\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Mailbox Collection Script",
        "description": "Detects PowerShell scripts that can be used to collect data from mailboxes. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Mailbox Collection Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThis rule identifies scripts that contains methods and classes that can be abused to collect emails from local and remote mailboxes.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Determine whether the script was executed and capture relevant information, such as arguments that reveal intent or are indicators of compromise (IoCs).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n  - Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Related rules\n\n- Exporting Exchange Mailbox via PowerShell - 6aace640-e631-4870-ba8e-5fdda09325db\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/dafthack/MailSniper/blob/master/MailSniper.ps1",
          "https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Archive/CALDERA_DIY/evals/payloads/stepSeventeen_email.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  },
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cd5cc9fe-1e32-4c20-9d8b-055717c23d6b",
        "rule_id": "a2d04374-187c-4fd9-b513-3ad4e7fdd67a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.463Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.330Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (\n      \"Microsoft.Office.Interop.Outlook\" or\n      \"Interop.Outlook.olDefaultFolders\" or\n      \"::olFolderInBox\"\n   ) or\n   powershell.file.script_block_text : (\n      \"Microsoft.Exchange.WebServices.Data.Folder\" or\n      \"Microsoft.Exchange.WebServices.Data.FileAttachment\"\n   )\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Execution via local SxS Shared Module",
        "description": "Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuse shared modules to execute malicious payloads by instructing the Windows module loader to load DLLs from arbitrary local paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThe SxS DotLocal folder is a legitimate feature that can be abused to hijack standard modules loading order by forcing an executable on the same application.exe.local folder to load a malicious DLL module from the same directory.\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-redirection"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1129",
                "name": "Shared Modules",
                "reference": "https://attack.mitre.org/techniques/T1129/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e9db98af-014f-44b0-82bf-2efa308f8534",
        "rule_id": "a3ea12f3-0d4e-4667-8b44-4230c63f3c75",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.630Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.427Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and file.extension : \"dll\" and file.path : \"C:\\\\*\\\\*.exe.local\\\\*.dll\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel Windows Registry Indicator Match",
        "description": "This rule is triggered when a Windows registry indicator from the Threat Intel Filebeat module or integrations has a match against an event that contains registry data.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel Windows Registry Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when a Windows registry indicator from the Threat Intel Filebeat module or a threat intelligence integration matches against an event that contains registry data.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Check related threat reports to gain context about the registry indicator of compromise (IoC) and to understand if it's a system-native mechanism abused for persistence, to store data, to disable security mechanisms, etc. Use this information to define the appropriate triage and respond steps.\n- Identify the process responsible for the registry operation and investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the involved process executable and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- Adversaries can leverage dual-use registry mechanisms that are commonly used by normal applications. These registry keys can be added into indicator lists creating the potential for false positives.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b2e4b4f2-d80d-4662-8d40-9483c08e7b70",
        "rule_id": "a61809f3-fb5b-465c-8bff-23a8a068ac60",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.733Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.436Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "registry.path:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and threat.indicator.registry.path:* and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "registry.path",
                "type": "mapping",
                "value": "threat.indicator.registry.path"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "Potential Reverse Shell via UDP",
        "description": "This detection rule identifies suspicious network traffic patterns associated with UDP reverse shell activity. This activity consists of a sample of an execve, socket and connect syscall executed by the same process, where the auditd.data.a0-1 indicate a UDP connection, ending with an egress connection event. An attacker may establish a Linux UDP reverse shell to bypass traditional firewall restrictions and gain remote access to a target system covertly.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms",
          "https://www.elastic.co/security-labs/linux-detection-engineering-with-auditd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Auditbeat\n- Auditd Manager\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required to be added to the integration.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a1",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "ad8e5ef3-23b5-449b-90e0-df77faf6dbc8",
        "rule_id": "a5eb21b7-13cc-4b94-9fe2-29bb2914e037",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.778Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.862Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sample by host.id, process.pid, process.parent.pid\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"executed\" and process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    )]\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"socket\" and process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    ) and auditd.data.a1 == \"2\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connected-to\" and\n   process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    ) and network.direction == \"egress\" and destination.ip != null and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious MS Office Child Process",
        "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel). These child processes are often launched during exploitation of Office applications or from documents with malicious macros.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious MS Office Child Process\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThis rule looks for suspicious processes spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/blog/vulnerability-summary-follina"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e5600ca2-cbfc-499f-a9c5-1985f31fe21f",
        "rule_id": "a624863f-a70d-417f-a7d2-7a404638d47f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.780Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.333Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\n      \"eqnedt32.exe\", \"excel.exe\", \"fltldr.exe\", \"msaccess.exe\",\n      \"mspub.exe\", \"powerpnt.exe\", \"winword.exe\", \"outlook.exe\"\n  ) and\n  process.name : (\n      \"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\",\n      \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n      \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\", \"iexpress.exe\",\n      \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\", \"net1.exe\", \"netsh.exe\",\n      \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\", \"pwsh.exe\", \"qprocess.exe\",\n      \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\",\n      \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\",\n      \"xwizard.exe\", \"explorer.exe\", \"rundll32.exe\", \"hh.exe\", \"msdt.exe\"\n  ) and\n  not (\n    process.parent.name : \"outlook.exe\" and\n    process.name : \"rundll32.exe\" and\n    process.args : \"shell32.dll,Control_RunDLL\" and\n    process.args : \"srchadmin.dll\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows Registry File Creation in SMB Share",
        "description": "Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, which may indicate an exfiltration attempt of a previously dumped Security Account Manager (SAM) registry hive for credential extraction on an attacker-controlled system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Registry File Creation in SMB Share\n\nDumping registry hives is a common way to access credential information. Some hives store credential material, as is the case for the SAM hive, which stores locally cached credentials (SAM secrets), and the SECURITY hive, which stores domain cached credentials (LSA secrets). Dumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nAttackers can try to evade detection on the host by transferring this data to a system that is not monitored to be parsed and decrypted. This rule identifies the creation or modification of a medium-size registry hive file on an SMB share, which may indicate this kind of exfiltration attempt.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Inspect the source host for suspicious or abnormal behaviors in the alert timeframe.\n- Capture the registry file(s) to determine the extent of the credential compromise in an eventual incident response.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes. Check whether the user should be performing this kind of activity and is aware of it.\n\n### Related rules\n\n- Credential Acquisition via Registry Hive Dumping - a7e7bfa3-088e-4f13-b29e-3986e0e756b8\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.size",
            "type": "long",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "12e83d31-1913-4850-86a1-b4fc69bebf23",
        "rule_id": "a4c7473a-5cb4-4bc1-9d06-e4a75adbc494",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:08.794Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.430Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n /* regf file header */\n file.Ext.header_bytes : \"72656766*\" and file.size >= 30000 and\n process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-1-*\") and\n not file.path : (\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT\",\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT.LASTGOOD.LOAD\",\n    \"?:\\\\*\\\\UPM_Profile\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\UsrClass.dat*\",\n    \"?:\\\\Windows\\\\Netwrix\\\\Temp\\\\????????.???.offreg\",\n    \"?:\\\\*\\\\AppData\\\\Local\\\\Packages\\\\Microsoft.*\\\\Settings\\\\settings.dat*\"\n )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Emond Rules Creation or Modification",
        "description": "Identifies the creation or modification of the Event Monitor Daemon (emond) rules. Adversaries may abuse this service by writing a rule to execute commands when a defined event occurs, such as system start up or user authentication.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.xorrior.com/emond-persistence/",
          "https://www.sentinelone.com/blog/how-malware-persists-on-macos/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.014",
                    "name": "Emond",
                    "reference": "https://attack.mitre.org/techniques/T1546/014/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "46bedb35-4413-4fb9-95f0-9120c6853e4d",
        "rule_id": "a6bf4dd4-743e-4da8-8c03-3ebd753a6c90",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.494Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.440Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"macos\" and event.type != \"deletion\" and\n file.path : (\"/private/etc/emond.d/rules/*.plist\", \"/etc/emon.d/rules/*.plist\", \"/private/var/db/emondClients/*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Print Spooler SPL File Created",
        "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service including CVE-2020-1048 and CVE-2020-1337.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Print Spooler SPL File Created\n\nPrint Spooler is a Windows service enabled by default in all Windows clients and servers. The service manages print jobs by loading printer drivers, receiving files to be printed, queuing them, scheduling, etc.\n\nThe Print Spooler service has some known vulnerabilities that attackers can abuse to escalate privileges to SYSTEM, like CVE-2020-1048 and CVE-2020-1337. This rule looks for unusual processes writing SPL files to the location `?:\\Windows\\System32\\spool\\PRINTERS\\`, which is an essential step in exploiting these vulnerabilities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of process executable and file conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Ensure that the machine has the latest security updates and is not running legacy Windows versions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://safebreach.com/Post/How-we-bypassed-CVE-2020-1048-Patch-and-got-CVE-2020-1337"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "795a3244-afec-46cd-983f-23973fbc5054",
        "rule_id": "a7ccae7b-9d2c-44b2-a061-98e5946971fa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.496Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.337Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : \"spl\" and\n  file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\PRINTERS\\\\*\" and\n  not process.name : (\"spoolsv.exe\",\n                      \"printfilterpipelinesvc.exe\",\n                      \"PrintIsolationHost.exe\",\n                      \"splwow64.exe\",\n                      \"msiexec.exe\",\n                      \"poqexec.exe\",\n                      \"System\") and\n  not user.id : \"S-1-5-18\" and\n  not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"\\\\Device\\\\Mup\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\printui.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\spool\\\\*.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\PROGRA~1\\\\*.exe\",\n             \"?:\\\\PROGRA~2\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\rundll32.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Credential Acquisition via Registry Hive Dumping",
        "description": "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Credential Acquisition via Registry Hive Dumping\n\nDumping registry hives is a common way to access credential information as some hives store credential material.\n\nFor example, the SAM hive stores locally cached credentials (SAM Secrets), and the SECURITY hive stores domain cached credentials (LSA secrets).\n\nDumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nThis rule identifies the usage of `reg.exe` to dump SECURITY and/or SAM hives, which potentially indicates the compromise of the credentials stored in the host.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate if the credential material was exfiltrated or processed locally by other tools.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes using command line tools like `reg.exe`. Check whether the user is legitamitely performing this kind of activity.\n\n### Related rules\n\n- Registry Hive File Creation via SMB - a4c7473a-5cb4-4bc1-9d06-e4a75adbc494\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-attempts-to-steal-passwords-from-the-registry-7512674487f8",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.004",
                    "name": "LSA Secrets",
                    "reference": "https://attack.mitre.org/techniques/T1003/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "97bc1b1d-4f2f-49cf-9618-2985c7934800",
        "rule_id": "a7e7bfa3-088e-4f13-b29e-3986e0e756b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.498Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.443Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"reg.exe\" or process.name : \"reg.exe\") and\n process.args : (\"save\", \"export\") and\n process.args : (\"hklm\\\\sam\", \"hklm\\\\security\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious File Downloaded from Google Drive",
        "description": "Identifies suspicious file download activity from a Google Drive URL. This could indicate an attempt to deliver phishing payloads via a trusted webservice.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Approved third-party applications that use Google Drive download URLs.",
          "Legitimate publicly shared files from Google Drive."
        ],
        "references": [
          "https://intelligence.abnormalsecurity.com/blog/google-drive-matanbuchus-malware"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3f7424ff-6d10-414b-b044-224e7862cc54",
        "rule_id": "a8afdce2-0ec1-11ee-b843-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.500Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.842Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where\n\n    /* common browser processes  */\n    event.action in (\"exec\", \"fork\", \"start\") and \n\n    process.name : (\"Microsoft Edge\", \"chrome.exe\", \"Google Chrome\", \"google-chrome-stable\", \n                    \"google-chrome-beta\", \"google-chrome\", \"msedge.exe\", \"firefox.exe\", \"brave.exe\", \n                    \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"firefox\", \n                    \"powershell.exe\", \"curl\", \"curl.exe\", \"wget\", \"wget.exe\") and \n\n    /* Look for Google Drive download URL with AV flag skipping */\n    (process.command_line : \"*drive.google.com*\" and process.command_line : \"*export=download*\" and process.command_line : \"*confirm=no_antivirus*\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Hidden Run Key Detected",
        "description": "Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated) registry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit).",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/outflanknl/SharpHide",
          "https://github.com/ewhitehats/InvisiblePersistence/blob/master/InvisibleRegValues_Whitepaper.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "705b02cf-415c-4341-94cb-940e24c56d84",
        "rule_id": "a9b05c3b-b304-4bf9-970d-acdfaef2944c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.502Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.340Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Registry Path ends with backslash */\nregistry where host.os.type == \"windows\" and event.type == \"change\" and length(registry.data.strings) > 0 and\n registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "System Log File Deletion",
        "description": "Identifies the deletion of sensitive Linux system logs. This may indicate an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/11/live-off-the-land-an-overview-of-unc1945.html",
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.002",
                    "name": "Clear Linux or Mac System Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bfa3b4f0-4027-4cea-917f-2191d84fced2",
        "rule_id": "aa895aea-b69c-4411-b110-8d7599634b30",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.503Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.263Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"deletion\" and\n  file.path :\n    (\n    \"/var/run/utmp\",\n    \"/var/log/wtmp\",\n    \"/var/log/btmp\",\n    \"/var/log/lastlog\",\n    \"/var/log/faillog\",\n    \"/var/log/syslog\",\n    \"/var/log/messages\",\n    \"/var/log/secure\",\n    \"/var/log/auth.log\",\n    \"/var/log/boot.log\",\n    \"/var/log/kern.log\",\n    \"/var/log/dmesg\"\n    ) and\n    not process.name in (\"gzip\", \"executor\", \"dockerd\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel Hash Indicator Match",
        "description": "This rule is triggered when a hash indicator from the Threat Intel Filebeat module or integrations has a match against an event that contains file hashes, such as antivirus alerts, process creation, library load, and file operation events.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel Hash Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when a hash indicator from the Threat Intel Filebeat module or an indicator ingested from a threat intelligence integration matches against an event that contains file hashes, such as antivirus alerts, file operation events, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Gain context about the field that matched the local observation. This information can be found in the `threat.indicator.matched.field` field.\n- Investigate the hash , which can be found in the `threat.indicator.matched.atomic` field:\n  - Search for the existence and reputation of the hash in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Scope other potentially compromised hosts in your environment by mapping hosts with file operations involving the same hash.\n- Identify the process that created the file.\n  - Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Enrich the information that you have right now by determining how the file was dropped, where it was downloaded from, etc. This can help you determine if the event is part of an ongoing campaign against the organization.\n- Retrieve the involved file and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- Adversaries often use legitimate tools as network administrators, such as `PsExec` or `AdFind`. These tools are often included in indicator lists, which creates the potential for false positives.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "dll.hash.*",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.hash.*",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.hash.*",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "7c0307a5-57c6-472d-b760-ea6ec1b5d31b",
        "rule_id": "aab184d3-72b3-4639-b242-6597c99d8bca",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.505Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.346Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "file.hash.*:* or process.hash.*:* or dll.hash.*:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and (threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:*) and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "file.hash.md5",
                "type": "mapping",
                "value": "threat.indicator.file.hash.md5"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "file.hash.sha1",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha1"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "file.hash.sha256",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha256"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "dll.hash.md5",
                "type": "mapping",
                "value": "threat.indicator.file.hash.md5"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "dll.hash.sha1",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha1"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "dll.hash.sha256",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha256"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "process.hash.md5",
                "type": "mapping",
                "value": "threat.indicator.file.hash.md5"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "process.hash.sha1",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha1"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "process.hash.sha256",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha256"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "Suspicious WerFault Child Process",
        "description": "A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit registry key manipulation. Verify process details such as command line, network connections and file writes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 415,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Custom Windows error reporting debugger or applications restarted by WerFault after a crash."
        ],
        "references": [
          "https://www.hexacorn.com/blog/2019/09/19/silentprocessexit-quick-look-under-the-hood/",
          "https://www.hexacorn.com/blog/2019/09/20/werfault-command-line-switches-v0-1/",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Persistence/persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx",
          "http://web.archive.org/web/20230530011556/https://blog.menasec.net/2021/01/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.012",
                    "name": "Image File Execution Options Injection",
                    "reference": "https://attack.mitre.org/techniques/T1546/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.012",
                    "name": "Image File Execution Options Injection",
                    "reference": "https://attack.mitre.org/techniques/T1546/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bc032c48-9e36-4536-b02b-3698c5d06663",
        "rule_id": "ac5012b8-8da8-440b-aaaf-aedafdea2dff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.507Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.353Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n\n  process.parent.name : \"WerFault.exe\" and\n\n  /* args -s and -t used to execute a process via SilentProcessExit mechanism */\n  (process.parent.args : \"-s\" and process.parent.args : \"-t\" and process.parent.args : \"-c\") and\n\n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\Initcrypt.exe\", \"?:\\\\Program Files (x86)\\\\Heimdal\\\\Heimdal.Guard.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Protocol Tunneling via Chisel Server",
        "description": "This rule monitors for common command line flags leveraged by the Chisel server utility followed by a received connection within a timespan of 1 minute. Chisel is a command-line utility used for creating and managing TCP and UDP tunnels, enabling port forwarding and secure communication between machines. Attackers can abuse the Chisel utility to establish covert communication channels, bypass network restrictions, and carry out malicious activities by creating tunnels that allow unauthorized access to internal systems.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Protocol Tunneling via Chisel Server\n\nAttackers can leverage `chisel` to clandestinely tunnel network communications and evade security measures, potentially gaining unauthorized access to sensitive systems.\n\nThis rule looks for a sequence of command line arguments that are consistent with `chisel` server tunneling behavior, followed by a network event by an uncommon process. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate protocol tunneling. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Protocol Tunneling via Chisel Client - 3f12325a-4cc6-410b-8d4c-9fbbeb744cfd\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n- Potential Protocol Tunneling via EarthWorm - 9f1c4ca3-44b5-481d-ba42-32dc215a2769\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.bitsadmin.com/living-off-the-foreign-land-windows-as-offensive-platform",
          "https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c19b2c63-7f78-4da6-8fd6-2faf28f3b675",
        "rule_id": "ac8805f6-1e08-406c-962e-3937057fa86f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.509Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.885Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"server\" and process.args in (\"--port\", \"-p\", \"--reverse\", \"--backend\", \"--socks5\") and \n   process.args_count >= 3 and process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_accepted\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\", \"hugo\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Invoke-Mimikatz PowerShell Script",
        "description": "Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with many other features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShell script and alike.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Mimikatz PowerShell Activity\n\n[Mimikatz](https://github.com/gentilkiwi/mimikatz) is an open-source tool used to collect, decrypt, and/or use cached credentials. This tool is commonly abused by adversaries during the post-compromise stage where adversaries have gained an initial foothold on an endpoint and are looking to elevate privileges and seek out additional authentication objects such as tokens/hashes/credentials that can then be used to move laterally and pivot across a network.\n\nThis rule looks for PowerShell scripts that load mimikatz in memory, like Invoke-Mimikataz, which are used to dump credentials from the Local Security Authority Subsystem Service (LSASS). Any activity triggered from this rule should be treated with high priority as it typically represents an active adversary.\n\nMore information about Mimikatz components and how to detect/prevent them can be found on [ADSecurity](https://adsecurity.org/?page_id=1821).\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Invoke-Mimitakz and alike scripts heavily use other capabilities covered by other detections described in the \"Related Rules\" section.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host.\n  - Examine network and security events in the environment to identify potential lateral movement using compromised credentials.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Mimikatz Memssp Log File Detected - ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6\n- Modification of WDigest Security Provider - d703a5af-d5b0-43bd-8ddb-7a5d500b7da5\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Validate that cleartext passwords are disabled in memory for use with `WDigest`.\n- Look into preventing access to `LSASS` using capabilities such as LSA protection or antivirus/EDR tools that provide this capability.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/software/S0002/",
          "https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "adad1f84-0740-45e0-a50f-2fa6591c1db8",
        "rule_id": "ac96ceb8-4399-4191-af1d-4feeac1f1f46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.510Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.889Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\npowershell.file.script_block_text:(\n  (DumpCreds and\n  DumpCerts) or\n  \"sekurlsa::logonpasswords\" or\n  (\"crypto::certificates\" and\n  \"CERT_SYSTEM_STORE_LOCAL_MACHINE\")\n)",
        "language": "kuery"
      },
      {
        "name": "Signed Proxy Execution via MS Work Folders",
        "description": "Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working directory. Misuse of Windows Work Folders could indicate malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Signed Proxy Execution via MS Work Folders\n\nWork Folders is a role service for file servers running Windows Server that provides a consistent way for users to access their work files from their PCs and devices. This allows users to store work files and access them from anywhere. When called, Work Folders will automatically execute any Portable Executable (PE) named control.exe as an argument before accessing the synced share.\n\nUsing Work Folders to execute a masqueraded control.exe could allow an adversary to bypass application controls and increase privileges.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n    - Examine the location of the WorkFolders.exe binary to determine if it was copied to the location of the control.exe binary. It resides in the System32 directory by default.\n- Trace the activity related to the control.exe binary to identify any continuing intrusion activity on the host.\n- Review the control.exe binary executed with Work Folders to determine maliciousness such as additional host activity or network traffic.\n- Determine if control.exe was synced to sync share, indicating potential lateral movement.\n- Review how control.exe was originally delivered on the host, such as emailed, downloaded from the web, or written to\ndisk from a separate binary.\n\n### False positive analysis\n\n- Windows Work Folders are used legitimately by end users and administrators for file sharing and syncing but not in the instance where a suspicious control.exe is passed as an argument.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Review the Work Folders synced share to determine if the control.exe was shared and if so remove it.\n- If no lateral movement was identified during investigation, take the affected host offline if possible and remove the control.exe binary as well as any additional artifacts identified during investigation.\n- Review integrating Windows Information Protection (WIP) to enforce data protection by encrypting the data on PCs using Work Folders.\n- Confirm with the user whether this was expected or not, and reset their password.\n",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/storage/work-folders/work-folders-overview",
          "https://twitter.com/ElliotKillick/status/1449812843772227588",
          "https://lolbas-project.github.io/lolbas/Binaries/WorkFolders/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9bcb2c03-6fbf-4738-87e6-8cb94d8010e8",
        "rule_id": "ad0d2742-9a49-11ec-8d6b-acde48001122",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.512Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.907Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and process.parent.name : \"WorkFolders.exe\" and\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\control.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\control.exe\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Portable Executable Encoded in Powershell Script",
        "description": "Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackers embed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Portable Executable Encoded in Powershell Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell in-memory capabilities to inject executables into memory without touching the disk, bypassing file-based security protections. These executables are generally base64 encoded.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dcb2b693-0228-4983-b23e-0ff0f30e01de",
        "rule_id": "ad84d445-b1ce-4377-82d9-7c633f28bf9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.514Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.359Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    TVqQAAMAAAAEAAAA\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "File Transfer or Listener Established via Netcat",
        "description": "A netcat process is engaging in network activity on a Linux host. Netcat is often used as a persistence mechanism by exporting a reverse shell or by serving a shell on a listening port. Netcat is also sometimes used for data exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Netcat Network Activity\n\nNetcat is a dual-use command line tool that can be used for various purposes, such as port scanning, file transfers, and connection tests. Attackers can abuse its functionality for malicious purposes such creating bind shells or reverse shells to gain access to the target system.\n\nA reverse shell is a mechanism that's abused to connect back to an attacker-controlled system. It effectively redirects the system's input and output and delivers a fully functional remote shell to the attacker. Even private systems are vulnerable since the connection is outgoing.\n\nA bind shell is a type of backdoor that attackers set up on the target host and binds to a specific port to listen for an incoming connection from the attacker.\n\nThis rule identifies potential reverse shell or bind shell activity using Netcat by checking for the execution of Netcat followed by a network connection.\n\n#### Possible investigation steps\n\n- Examine the command line to identify if the command is suspicious.\n- Extract and examine the target domain or IP address.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n  - Scope other potentially compromised hosts in your environment by mapping hosts that also communicated with the domain or IP address.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- Netcat is a dual-use tool that can be used for benign or malicious activity. It is included in some Linux distributions, so its presence is not necessarily suspicious. Some normal use of this program, while uncommon, may originate from scripts, automation tools, and frameworks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Block the identified indicators of compromise (IoCs).\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Netcat is a dual-use tool that can be used for benign or malicious activity. Netcat is included in some Linux distributions so its presence is not necessarily suspicious. Some normal use of this program, while uncommon, may originate from scripts, automation tools, and frameworks."
        ],
        "references": [
          "http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet",
          "https://www.sans.org/security-resources/sec560/netcat_cheat_sheet_v1.pdf",
          "https://en.wikipedia.org/wiki/Netcat",
          "https://www.hackers-arise.com/hacking-fundamentals",
          "https://null-byte.wonderhowto.com/how-to/hack-like-pro-use-netcat-swiss-army-knife-hacking-tools-0148657/",
          "https://levelup.gitconnected.com/ethical-hacking-part-15-netcat-nc-and-netcat-f6a8f7df43fd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "324fcc44-7815-494f-ac64-19843a7ff945",
        "rule_id": "adb961e0-cb74-42a0-af9e-29fc41f88f5f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.518Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.365Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and\n      process.name:(\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\") and (\n          /* bind shell to echo for command execution */\n          (process.args:(\"-l\",\"-p\") and process.args:(\"-c\",\"echo\",\"$*\"))\n          /* bind shell to specific port */\n          or process.args:(\"-l\",\"-p\",\"-lp\")\n          /* reverse shell to command-line interpreter used for command execution */\n          or (process.args:(\"-e\") and process.args:(\"/bin/bash\",\"/bin/sh\"))\n          /* file transfer via stdout */\n          or process.args:(\">\",\"<\")\n          /* file transfer via pipe */\n          or (process.args:(\"|\") and process.args:(\"nc\",\"ncat\"))\n      )]\n  [network where host.os.type == \"linux\" and (process.name == \"nc\" or process.name == \"ncat\" or process.name == \"netcat\" or\n                  process.name == \"netcat.openbsd\" or process.name == \"netcat.traditional\")]",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Shared Object Created or Changed by Previously Unknown Process",
        "description": "This rule monitors the creation of shared object files by previously unknown processes. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime. While this process is typically used for legitimate purposes, malicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Shared Object Created or Changed by Previously Unknown Process\n\nA shared object file is a compiled library file (typically with a .so extension) that can be dynamically linked to executable programs at runtime, allowing for code reuse and efficient memory usage. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime.\n\nMalicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.\n\nThis rule monitors the creation of shared object files by previously unknown processes through the usage of the new terms rule type.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the shared object that was created or modified through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path = {{file.path}}\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threatpost.com/sneaky-malware-backdoors-linux/180158/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e20ac745-ad70-4399-b0b9-72ad948956e1",
        "rule_id": "aebaa51f-2a91-4f6a-850b-b601db2293f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.520Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.369Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.action:(creation or file_create_event or file_rename_event or rename) and \nfile.path:(/dev/shm/* or /usr/lib/*) and file.extension:so and process.name:* and not (\n  process.name:(\n    \"dockerd\" or \"dpkg\" or \"rpm\" or \"snapd\" or \"yum\" or \"vmis-launcher\" or \"pacman\" or \"apt-get\" or \"dnf\" or \"podman\" or\n    platform-python* or \"dnf-automatic\" or \"unattended-upgrade\" or \"apk\" or \"snap-update-ns\" or \"install\" or \"exe\" or\n    \"systemd\" or \"root\" or \"sshd\" or \"pip\" or \"jlink\" or python* or \"update-alternatives\" or pip* or\n    \"installer.bin.inst\" or \"uninstall-bin\" or \"linux_agent.inst\"\n  ) or \n  (process.name:vmware-install.pl and file.path:/usr/lib/vmware-tools/*) or\n  process.executable : (/dev/fd/* or \"/\" or \"/kaniko/executor\" or \"/usr/bin/buildah\")\n)",
        "new_terms_fields": [
          "file.path",
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual User Privilege Enumeration via id",
        "description": "This rule monitors for a sequence of 20 \"id\" command executions within 1 second by the same parent process. This behavior is unusual, and may be indicative of the execution of an enumeration script such as LinPEAS or LinEnum. These scripts leverage the \"id\" command to enumerate the privileges of all users present on the system.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4f2d4b51-06d1-4e90-abc4-076e85db0d04",
        "rule_id": "afa135c0-a365-43ab-aa35-fd86df314a47",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.522Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.924Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.name == \"id\" and process.args_count == 2 and \n   not (process.parent.name == \"rpm\" or process.parent.args : \"/var/tmp/rpm-tmp*\")] with runs=20",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Network Activity Detected via cat",
        "description": "This rule monitors for the execution of the cat command, followed by a connection attempt by the same process. Cat is capable of transfering data via tcp/udp channels by redirecting its read output to a /dev/tcp or /dev/udp channel. This activity is highly suspicious, and should be investigated. Attackers may leverage this capability to transfer tools or files to another host in the network or exfiltrate data while attempting to evade detection in the process.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Activity Detected via cat\n\nAttackers may leverage the `cat` utility in conjunction with a listener to read all bytes of a file, and output the content to a `/dev/tcp` or `/dev/udp` channel to transfer/exfiltrate file contents to a remote system. \n\nThis rule looks for a sequence of a `cat` execution event followed by a network connection attempt by the same `cat` process. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate command and control activity or data exfiltration. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Suspicious Network Activity to the Internet by Previously Unknown Executable - 53617418-17b4-4e9c-8a2c-8deb8086ca4b\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7466b991-3253-482c-b833-afba4874caf4",
        "rule_id": "afd04601-12fc-4149-9b78-9c3f8fe45d39",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.524Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.522Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"cat\" and process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [network where host.os.type == \"linux\" and event.action in (\"connection_attempted\", \"disconnect_received\") and\n   process.name == \"cat\" and not (destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n     )\n   )]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Container Misconfiguration",
        "description": "This rule monitors for the execution of processes that interact with Linux containers through an interactive shell without root permissions. Utilities such as runc and ctr are universal command-line utilities leveraged to interact with containers via root permissions. On systems where the access to these utilities are misconfigured, attackers might be able to create and run a container that mounts the root folder or spawn a privileged container vulnerable to a container escape attack, which might allow them to escalate privileges and gain further access onto the host file system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Domain: Container",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/runc-privilege-escalation",
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/containerd-ctr-privilege-escalation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nSession View uses process data collected by the Elastic Defend integration, but this data is not always collected by default. Session View is available on enterprise subscription for versions 8.3 and above.\n#### To confirm that Session View data is enabled:\n- Go to Manage  Policies, and edit one or more of your Elastic Defend integration policies.\n- Select the Policy settings tab, then scroll down to the Linux event collection section near the bottom.\n- Check the box for Process events, and turn on the Include session data toggle.\n- If you want to include file and network alerts in Session View, check the boxes for Network and File events.\n- If you want to enable terminal output capture, turn on the Capture terminal output toggle.\nFor more information about the additional fields collected when this setting is enabled and the usage of Session View for Analysis refer to the [helper guide](https://www.elastic.co/guide/en/security/current/session-view.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.interactive",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.interactive",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "06c064aa-3a5c-45e7-b751-42cd71cbf2a3",
        "rule_id": "afe6b0eb-dd9d-4922-b08a-1910124d524d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.452Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name == \"runc\" and process.args == \"run\") or\n  (process.name == \"ctr\" and process.args == \"run\" and process.args in (\"--privileged\", \"--mount\"))\n) and not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\" and \nprocess.interactive == true and process.parent.interactive == true",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Timestomping using Touch Command",
        "description": "Timestomping is an anti-forensics technique which is used to modify the timestamps of a file, often to mimic files that are in the same folder.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.006",
                    "name": "Timestomp",
                    "reference": "https://attack.mitre.org/techniques/T1070/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eb11ef59-fe6b-407e-84de-5cd737557dc3",
        "rule_id": "b0046934-486e-462f-9487-0d4cf9e429c6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.527Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.456Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\n process.name : \"touch\" and user.id != \"0\" and\n process.args : (\"-r\", \"-t\", \"-a*\",\"-m*\") and\n not process.args : (\n   \"/usr/lib/go-*/bin/go\", \"/usr/lib/dracut/dracut-functions.sh\", \"/tmp/KSInstallAction.*/m/.patch/*\"\n) and not process.parent.name in (\"pmlogger_daily\", \"pmlogger_janitor\", \"systemd\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Remote File Copy via TeamViewer",
        "description": "Identifies an executable or script file remotely downloaded via a TeamViewer transfer session.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Copy via TeamViewer\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse legitimate utilities to drop these files.\n\nTeamViewer is a remote access and remote control tool used by helpdesks and system administrators to perform various support activities. It is also frequently used by attackers and scammers to deploy malware interactively and other malicious activities. This rule looks for the TeamViewer process creating files with suspicious extensions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Contact the user to gather information about who and why was conducting the remote access.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether the company uses TeamViewer for the support activities and if there is a support ticket related to this access.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the company relies on TeamViewer to conduct remote access and the triage has not identified suspicious or malicious files.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://web.archive.org/web/20230329160957/https://blog.menasec.net/2019/11/hunting-for-suspicious-use-of.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              },
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "59985ac7-f0c5-4943-bebf-9298ded7c507",
        "rule_id": "b25a7df2-120a-4db2-bd3f-3e4b86b24bee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.529Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.372Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and process.name : \"TeamViewer.exe\" and\n  file.extension : (\"exe\", \"dll\", \"scr\", \"com\", \"bat\", \"ps1\", \"vbs\", \"vbe\", \"js\", \"wsh\", \"hta\") and\n  not \n  (\n    file.path : (\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\*.js\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\TeamViewer\\\\update.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\?\\\\TeamViewer\\\\update.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\TeamViewer\\\\CustomConfigs\\\\???????\\\\TeamViewer_Resource_??.dll\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\TeamViewer\\\\CustomConfigs\\\\???????\\\\TeamViewer*.exe\"\n    ) and process.code_signature.trusted == true\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Endpoint Security Parent Process",
        "description": "A suspicious Endpoint Security parent process was detected. This may indicate a process hollowing or other form of code injection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a68addad-0570-4e98-a1b4-896831893ac4",
        "rule_id": "b41a13c6-ba45-4bab-a534-df53d0cfed6a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.531Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.375Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"esensor.exe\", \"elastic-endpoint.exe\") and\n  process.parent.executable != null and\n  /* add FPs here */\n  not process.parent.executable : (\n        \"?:\\\\Program Files\\\\Elastic\\\\*\",\n        \"?:\\\\Windows\\\\System32\\\\services.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\"\n  ) and\n  not (\n    process.parent.executable : (\n        \"?:\\\\Windows\\\\System32\\\\cmd.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SecurityHealthHost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"\n    ) and\n    process.args : (\n        \"test\", \"version\",\n        \"top\", \"run\",\n        \"*help\", \"status\",\n        \"upgrade\", \"/launch\",\n        \"/enable\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Clearing Windows Console History",
        "description": "Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Clearing Windows Console History\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can try to cover their tracks by clearing PowerShell console history. PowerShell has two different ways of logging commands: the built-in history and the command history managed by the PSReadLine module. This rule looks for the execution of commands that can clear the built-in PowerShell logs or delete the `ConsoleHost_history.txt` file.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the PowerShell logs on the SIEM to determine if there was suspicious behavior that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n  - Ensure that PowerShell auditing policies and log collection are in place to grant future visibility.\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://stefanos.cloud/kb/how-to-clear-the-powershell-command-history/",
          "https://www.shellhacks.com/clear-history-powershell/",
          "https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.003",
                    "name": "Clear Command History",
                    "reference": "https://attack.mitre.org/techniques/T1070/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f2bdd194-1efe-477f-96c5-7b19ca693637",
        "rule_id": "b5877334-677f-4fb9-86d5-a9721274223b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.534Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.382Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  (\n    process.args : \"*Clear-History*\" or\n    (process.args : (\"*Remove-Item*\", \"rm\") and process.args : (\"*ConsoleHost_history.txt*\", \"*(Get-PSReadlineOption).HistorySavePath*\")) or\n    (process.args : \"*Set-PSReadlineOption*\" and process.args : \"*SaveNothing*\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Volume Shadow Copy Deleted or Resized via VssAdmin",
        "description": "Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deleted or Resized via VssAdmin\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of Vssadmin.exe to either delete or resize shadow copies.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule may produce benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "119aae2a-90d1-481b-a2bb-b29a307885f8",
        "rule_id": "b5ea4bfe-a1b2-421f-9d47-22a75a6f2921",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.536Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.476Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"vssadmin.exe\" or ?process.pe.original_file_name == \"VSSADMIN.EXE\") and\n  process.args : (\"delete\", \"resize\") and process.args : \"shadows*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Elastic Agent Service Terminated",
        "description": "Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to disable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This may also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a stable state.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1b3badd9-1050-45b2-9f2e-87b1b72d7e6d",
        "rule_id": "b627cd12-dac4-11ec-9582-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.538Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.385Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : (\"stop\", \"disable\"))\n  or\n  /* pkill , killall used to stop Elastic Agent on Linux */\n  ( event.type == \"end\" and process.name : (\"pkill\", \"killall\") and process.args: \"elastic-agent\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via OverlayFS",
        "description": "Identifies an attempt to exploit a local privilege escalation (CVE-2023-2640 and CVE-2023-32629) via a flaw in Ubuntu's modifications to OverlayFS. These flaws allow the creation of specialized executables, which, upon execution, grant the ability to escalate privileges to root on the affected machine.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.wiz.io/blog/ubuntu-overlayfs-vulnerability",
          "https://twitter.com/liadeliyahu/status/1684841527959273472"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "243a6650-3465-49d5-83cb-8d92968d84a6",
        "rule_id": "b51dbc92-84e2-4af1-ba47-65183fcd0c57",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.533Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.473Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.parent.entity_id, host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n    process.name == \"unshare\" and process.args : (\"-r\", \"-rm\", \"m\") and process.args : \"*cap_setuid*\"  and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n    user.id == \"0\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Successful Linux FTP Brute Force Attack Detected",
        "description": "An FTP (file transfer protocol) brute force attack is a method where an attacker systematically tries different combinations of usernames and passwords to gain unauthorized access to an FTP server, and if successful, the impact can include unauthorized data access, manipulation, or theft, compromising the security and integrity of the server and potentially exposing sensitive information. This rule identifies multiple consecutive authentication failures targeting a specific user account from the same source address and within a short time interval, followed by a successful authentication.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Auditbeat\n- Auditd Manager\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required to be added to the integration.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.addr",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.terminal",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "related.user",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8222bf97-f3ff-4420-bb06-41faf28d43b0",
        "rule_id": "66712812-e7f2-4a1d-bbda-dd0b5cf20c5d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.507Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, auditd.data.addr, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"failure\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"success\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] | tail 1",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Connection to Commonly Abused Web Services",
        "description": "Adversaries may implement command and control (C2) communications that use common web services to hide their activity. This attack technique is typically targeted at an organization and uses web services common to the victim network, which allows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since they have most likely been used before compromise, which helps malicious traffic blend in.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Connection to Commonly Abused Web Services\n\nAdversaries may use an existing, legitimate external Web service as a means for relaying data to/from a compromised system. Popular websites and social media acting as a mechanism for C2 may give a significant amount of cover due to the likelihood that hosts within a network are already communicating with them prior to a compromise.\n\nThis rule looks for processes outside known legitimate program locations communicating with a list of services that can be abused for exfiltration or command and control.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Verify whether the digital signature exists in the executable.\n- Identify the operation type (upload, download, tunneling, etc.).\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives because it detects communication with legitimate services. Noisy false positives can be added as exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 116,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/operation-bleeding-bear",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1102",
                "name": "Web Service",
                "reference": "https://attack.mitre.org/techniques/T1102/"
              },
              {
                "id": "T1568",
                "name": "Dynamic Resolution",
                "reference": "https://attack.mitre.org/techniques/T1568/",
                "subtechnique": [
                  {
                    "id": "T1568.002",
                    "name": "Domain Generation Algorithms",
                    "reference": "https://attack.mitre.org/techniques/T1568/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1567",
                "name": "Exfiltration Over Web Service",
                "reference": "https://attack.mitre.org/techniques/T1567/",
                "subtechnique": [
                  {
                    "id": "T1567.001",
                    "name": "Exfiltration to Code Repository",
                    "reference": "https://attack.mitre.org/techniques/T1567/001/"
                  },
                  {
                    "id": "T1567.002",
                    "name": "Exfiltration to Cloud Storage",
                    "reference": "https://attack.mitre.org/techniques/T1567/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cab65244-d892-4d5a-8d17-2f86b372eaf6",
        "rule_id": "66883649-f908-4a5b-a1e0-54090a1d3a32",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.541Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.195Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n    process.name != null and user.id not in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n    /* Add new WebSvc domains here */\n    dns.question.name :\n       (\n        \"raw.githubusercontent.*\",\n        \"pastebin.*\",\n        \"paste4btc.com\",\n        \"paste.ee\",\n        \"ghostbin.com\",\n        \"drive.google.com\",\n        \"?.docs.live.net\",\n        \"api.dropboxapi.*\",\n        \"content.dropboxapi.*\",\n        \"dl.dropboxusercontent.*\",\n        \"api.onedrive.com\",\n        \"*.onedrive.org\",\n        \"onedrive.live.com\",\n        \"filebin.net\",\n        \"*.ngrok.io\",\n        \"ngrok.com\",\n        \"*.portmap.*\",\n        \"*serveo.net\",\n        \"*localtunnel.me\",\n        \"*pagekite.me\",\n        \"*localxpose.io\",\n        \"*notabug.org\",\n        \"rawcdn.githack.*\",\n        \"paste.nrecom.net\",\n        \"zerobin.net\",\n        \"controlc.com\",\n        \"requestbin.net\",\n        \"slack.com\",\n        \"api.slack.com\",\n        \"slack-redir.net\",\n        \"slack-files.com\",\n        \"cdn.discordapp.com\",\n        \"discordapp.com\",\n        \"discord.com\",\n        \"apis.azureedge.net\",\n        \"cdn.sql.gg\",\n        \"?.top4top.io\",\n        \"top4top.io\",\n        \"www.uplooder.net\",\n        \"*.cdnmegafiles.com\",\n        \"transfer.sh\",\n        \"gofile.io\",\n        \"updates.peer2profit.com\",\n        \"api.telegram.org\",\n        \"t.me\",\n        \"meacz.gq\",\n        \"rwrd.org\",\n        \"*.publicvm.com\",\n        \"*.blogspot.com\",\n        \"api.mylnikov.org\",\n        \"file.io\",\n        \"stackoverflow.com\",\n        \"*files.1drv.com\",\n        \"api.anonfile.com\",\n        \"*hosting-profi.de\",\n        \"ipbase.com\",\n        \"ipfs.io\",\n        \"*up.freeo*.space\",\n        \"api.mylnikov.org\",\n        \"script.google.com\",\n        \"script.googleusercontent.com\",\n        \"api.notion.com\",\n        \"graph.microsoft.com\",\n        \"*.sharepoint.com\",\n        \"mbasic.facebook.com\",\n        \"login.live.com\",\n        \"api.gofile.io\",\n        \"api.anonfiles.com\",\n        \"api.notion.com\",\n        \"api.trello.com\",\n        \"gist.githubusercontent.com\",\n        \"files.pythonhosted.org\",\n        \"g.live.com\",\n        \"*.zulipchat.com\",\n        \"webhook.site\",\n        \"run.mocky.io\",\n        \"mockbin.org\", \n        \"www.googleapis.com\", \n        \"googleapis.com\",\n        \"global.rel.tunnels.api.visualstudio.com\",\n        \"*.devtunnels.ms\") and\n        \n    /* Insert noisy false positives here */\n    not (\n      (\n        process.executable : (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\BraveSoftware\\\\*\\\\Application\\\\brave.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Vivaldi\\\\Application\\\\vivaldi.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera*\\\\opera.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\",\n          \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\"\n        )\n      ) or\n    \n      /* Discord App */\n      (process.name : \"Discord.exe\" and (process.code_signature.subject_name : \"Discord Inc.\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"discord.com\", \"cdn.discordapp.com\", \"discordapp.com\")\n      ) or \n\n      /* MS Sharepoint */\n      (process.name : \"Microsoft.SharePoint.exe\" and (process.code_signature.subject_name : \"Microsoft Corporation\" and\n       process.code_signature.trusted == true) and dns.question.name : \"onedrive.live.com\"\n      ) or \n\n      /* Firefox */\n      (process.name : \"firefox.exe\" and (process.code_signature.subject_name : \"Mozilla Corporation\" and\n       process.code_signature.trusted == true)\n      ) or \n\n      /* Dropbox */\n      (process.name : \"Dropbox.exe\" and (process.code_signature.subject_name : \"Dropbox, Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"api.dropboxapi.com\", \"*.dropboxusercontent.com\")\n      ) or \n\n      /* Obsidian - Plugins are stored on raw.githubusercontent.com */\n      (process.name : \"Obsidian.exe\" and (process.code_signature.subject_name : \"Dynalist Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : \"raw.githubusercontent.com\"\n      ) or \n\n      /* WebExperienceHostApp */\n      (process.name : \"WebExperienceHostApp.exe\" and (process.code_signature.subject_name : \"Microsoft Windows\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"onedrive.live.com\", \"skyapi.onedrive.live.com\")\n      ) or\n\n      (process.code_signature.subject_name : \"Microsoft *\" and process.code_signature.trusted == true and\n       dns.question.name : (\"*.sharepoint.com\", \"graph.microsoft.com\", \"g.live.com\", \"login.live.com\", \"login.live.com\")) or\n\n      (process.code_signature.trusted == true and\n       process.code_signature.subject_name :\n                             (\"Johannes Schindelin\",\n                              \"Redis Inc.\",\n                              \"Slack Technologies, LLC\",\n                              \"Cisco Systems, Inc.\",\n                              \"Dropbox, Inc\",\n                              \"Amazon.com Services LLC\"))\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Modification of the msPKIAccountCredentials",
        "description": "Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Data Source: Active Directory",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming",
          "https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.OperationType",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "71846625-e7db-4ba4-ab5d-0718538fee61",
        "rule_id": "670b3b5a-35e5-42db-bd36-6c5b9b4b7313",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.543Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.418Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:\"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"msPKIAccountCredentials\" and winlog.event_data.OperationType:\"%%14674\" and\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "High Number of Process Terminations",
        "description": "This rule identifies a high number (10) of process terminations via pkill from the same host within a short time period.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Process Terminations\n\nAttackers can kill processes for a variety of purposes. For example, they can kill process associated with business applications and databases to release the lock on files used by these applications so they may be encrypted,or stop security and backup solutions, etc.\n\nThis rule identifies a high number (10) of process terminations via pkill from the same host within a short time period.\n\n#### Possible investigation steps\n\n- Examine the entry point to the host and user in action via the Analyse View.\n  - Identify the session entry leader and session user.\n- Examine the contents of session leading to the process termination(s) via the Session View.\n  - Examine the command execution pattern in the session, which may lead to suspricous activities.\n- Examine the process killed during the malicious execution\n  - Identify imment threat to the system from the process killed.\n  - Take necessary incident response actions to respawn necessary process.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore it to the operational state.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "753dc1c5-7f23-4a3a-8077-62363379ac8f",
        "rule_id": "67f8443a-4ff3-4a70-916d-3cfa3ae9f02b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.545Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.198Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and host.os.type:linux and event.type:start and process.name:\"pkill\" and process.args:\"-f\"",
        "threshold": {
          "field": [
            "host.id",
            "process.executable",
            "user.name"
          ],
          "value": 10
        },
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Persistence via TelemetryController Scheduled Task Hijack",
        "description": "Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an integrity level of system.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.trustedsec.com/blog/abusing-windows-telemetry-for-persistence"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "03576427-4672-4a29-9d45-30096f7c2691",
        "rule_id": "68921d85-d0dc-48b3-865f-43291ca2c4f2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.546Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.430Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"CompatTelRunner.exe\" and process.args : \"-cv*\" and\n  not process.name : (\"conhost.exe\",\n                      \"DeviceCensus.exe\",\n                      \"CompatTelRunner.exe\",\n                      \"DismHost.exe\",\n                      \"rundll32.exe\",\n                      \"powershell.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass via ICMLuaUtil Elevated COM Interface",
        "description": "Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8a277f72-2959-41cd-8f73-2807029c7650",
        "rule_id": "68d56fdc-7ffa-4419-8e95-81641bd6f845",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.548Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.434Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"dllhost.exe\" and\n process.parent.args in (\"/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}\", \"/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}\") and\n process.pe.original_file_name != \"WerFault.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Modification of Boot Configuration",
        "description": "Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an attacker as a destructive technique.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of Boot Configuration\n\nBoot entry parameters, or boot parameters, are optional, system-specific settings that represent configuration options. These are stored in a boot configuration data (BCD) store, and administrators can use utilities like `bcdedit.exe` to configure these.\n\nThis rule identifies the usage of `bcdedit.exe` to:\n\n- Disable Windows Error Recovery (recoveryenabled).\n- Ignore errors if there is a failed boot, failed shutdown, or failed checkpoint (bootstatuspolicy ignoreallfailures).\n\nThese are common steps in destructive attacks by adversaries leveraging ransomware.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- The usage of these options is not inherently malicious. Administrators can modify these configurations to force a machine to boot for troubleshooting or data recovery purposes.\n\n### Related rules\n\n- Deleting Backup Catalogs with Wbadmin - 581add16-df76-42bb-af8e-c979bfb39a59\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c87e6ee8-cad7-47c7-af87-46698ae5ff70",
        "rule_id": "69c251fb-a5d6-4035-b5ec-40438bd829ff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.550Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.387Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and\n    (\n      (process.args : \"/set\" and process.args : \"bootstatuspolicy\" and process.args : \"ignoreallfailures\") or\n      (process.args : \"no\" and process.args : \"recoveryenabled\")\n    )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Service Host Child Process - Childless Service",
        "description": "Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes. This may indicate a code injection or an equivalent form of exploitation.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Changes to Windows services or a rarely executed child process."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.012",
                    "name": "Process Hollowing",
                    "reference": "https://attack.mitre.org/techniques/T1055/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.012",
                    "name": "Process Hollowing",
                    "reference": "https://attack.mitre.org/techniques/T1055/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2f124c11-7e6e-43fa-b5bc-a605ade3aaa2",
        "rule_id": "6a8ab9cc-4023-4d17-b5df-1a3e16882ce7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.552Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.437Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and\n\n  /* based on svchost service arguments -s svcname where the service is known to be childless */\n  process.parent.args : (\n    \"WdiSystemHost\", \"LicenseManager\", \"StorSvc\", \"CDPSvc\", \"cdbhsvc\", \"BthAvctpSvc\", \"SstpSvc\", \"WdiServiceHost\",\n    \"imgsvc\", \"TrkWks\", \"WpnService\", \"IKEEXT\", \"PolicyAgent\", \"CryptSvc\", \"netprofm\", \"ProfSvc\", \"StateRepository\",\n    \"camsvc\", \"LanmanWorkstation\", \"NlaSvc\", \"EventLog\", \"hidserv\", \"DisplayEnhancementService\", \"ShellHWDetection\",\n    \"AppHostSvc\", \"fhsvc\", \"CscService\", \"PushToInstall\"\n  ) and\n\n  /* unknown FPs can be added here */\n  not process.name : (\"WerFault.exe\", \"WerFaultSecure.exe\", \"wermgr.exe\") and\n  not (process.executable : \"?:\\\\Windows\\\\System32\\\\RelPost.exe\" and process.parent.args : \"WdiSystemHost\") and\n  not (\n    process.name : \"rundll32.exe\" and\n    process.args : \"?:\\\\WINDOWS\\\\System32\\\\winethc.dll,ForceProxyDetectionOnNextRun\" and\n    process.parent.args : \"WdiServiceHost\"\n  ) and\n  not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*\",\n      \"?:\\\\Program Files (x86)\\\\*\",\n      \"?:\\\\Windows\\\\System32\\\\Kodak\\\\kds_?????\\\\lib\\\\lexexe.exe\"\n    ) and process.parent.args : \"imgsvc\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Exporting Exchange Mailbox via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Exporting Exchange Mailbox via PowerShell\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\n\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 417,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "260a6bc1-02db-4ded-bece-d6c4025e6ca7",
        "rule_id": "6aace640-e631-4870-ba8e-5fdda09325db",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.441Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Utility Launched via ProxyChains",
        "description": "This rule monitors for the execution of suspicious linux tools through ProxyChains. ProxyChains is a command-line tool that enables the routing of network connections through intermediary proxies, enhancing anonymity and enabling access to restricted resources. Attackers can exploit the ProxyChains utility to hide their true source IP address, evade detection, and perform malicious activities through a chain of proxy servers, potentially masking their identity and intentions.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Utility Launched via ProxyChains\n\nAttackers can leverage `proxychains` to obfuscate their origin and bypass network defenses by routing their malicious traffic through multiple intermediary servers.\n\nThis rule looks for a list of suspicious processes spawned through `proxychains` by analyzing process command line arguments. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate network obfuscation. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- ProxyChains Activity - 4b868f1f-15ff-4ba3-8c11-d5a7a6356d37\n- Potential Protocol Tunneling via Chisel Client - 3f12325a-4cc6-410b-8d4c-9fbbeb744cfd\n- Potential Protocol Tunneling via Chisel Server - ac8805f6-1e08-406c-962e-3937057fa86f\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n- Potential Protocol Tunneling via EarthWorm - 9f1c4ca3-44b5-481d-ba42-32dc215a2769\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses this utility for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.bitsadmin.com/living-off-the-foreign-land-windows-as-offensive-platform"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1b3b83a5-0ec8-44e9-9f17-3e9975ed3ccd",
        "rule_id": "6ace94ba-f02c-4d55-9f53-87d99b6f9af4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.555Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:19.689Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"proxychains\" and process.args : (\n  \"ssh\", \"sshd\", \"sshuttle\", \"socat\", \"iodine\", \"iodined\", \"dnscat\", \"hans\", \"hans-ubuntu\", \"ptunnel-ng\",\n  \"ssf\", \"3proxy\", \"ngrok\", \"gost\", \"pivotnacci\", \"chisel*\", \"nmap\", \"ping\", \"python*\", \"php*\", \"perl\", \"ruby\",\n  \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\", \"ftp\", \"curl\", \"wget\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Sensitive Files Compression",
        "description": "Identifies the use of a compression utility to collect known files containing sensitive information, such as credentials and system configurations.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.trendmicro.com/en_ca/research/20/l/teamtnt-now-deploying-ddos-capable-irc-bot-tntbotinger.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.001",
                    "name": "Credentials In Files",
                    "reference": "https://attack.mitre.org/techniques/T1552/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/",
                "subtechnique": [
                  {
                    "id": "T1560.001",
                    "name": "Archive via Utility",
                    "reference": "https://attack.mitre.org/techniques/T1560/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2af6c26e-e91b-429f-9aba-a7a47bd6d1a1",
        "rule_id": "6b84d470-9036-4cc0-a27c-6d90bbfe81ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.557Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.445Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:linux and event.type:start and\n  process.name:(zip or tar or gzip or hdiutil or 7z) and\n  process.args:\n    (\n      /root/.ssh/id_rsa or\n      /root/.ssh/id_rsa.pub or\n      /root/.ssh/id_ed25519 or\n      /root/.ssh/id_ed25519.pub or\n      /root/.ssh/authorized_keys or\n      /root/.ssh/authorized_keys2 or\n      /root/.ssh/known_hosts or\n      /root/.bash_history or\n      /etc/hosts or\n      /home/*/.ssh/id_rsa or\n      /home/*/.ssh/id_rsa.pub or\n      /home/*/.ssh/id_ed25519 or\n      /home/*/.ssh/id_ed25519.pub or\n      /home/*/.ssh/authorized_keys or\n      /home/*/.ssh/authorized_keys2 or\n      /home/*/.ssh/known_hosts or\n      /home/*/.bash_history or\n      /root/.aws/credentials or\n      /root/.aws/config or\n      /home/*/.aws/credentials or\n      /home/*/.aws/config or\n      /root/.docker/config.json or\n      /home/*/.docker/config.json or\n      /etc/group or\n      /etc/passwd or\n      /etc/shadow or\n      /etc/gshadow\n    )",
        "new_terms_fields": [
          "host.id",
          "process.command_line",
          "process.parent.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Microsoft Exchange Server UM Writing Suspicious Files",
        "description": "Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26858.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nPositive hits can be checked against the established Microsoft [baselines](https://github.com/microsoft/CSS-Exchange/tree/main/Security/Baselines).\n\nMicrosoft highly recommends that the best course of action is patching, but this may not protect already compromised systems\nfrom existing intrusions. Other tools for detecting and mitigating can be found within their Exchange support\n[repository](https://github.com/microsoft/CSS-Exchange/tree/main/Security)\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Files generated during installation will generate a lot of noise, so the rule should only be enabled after the fact.",
          "This rule was tuned using the following baseline: https://raw.githubusercontent.com/microsoft/CSS-Exchange/main/Security/Baselines/baseline_15.2.792.5.csv from Microsoft. Depending on version, consult https://github.com/microsoft/CSS-Exchange/tree/main/Security/Baselines to help determine normalcy."
        ],
        "references": [
          "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers",
          "https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6929e7f7-bd5c-4e2a-86b0-5cc448848139",
        "rule_id": "6cd1779c-560f-4b68-a8f1-11009b27fe63",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.559Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.449Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : (\"UMWorkerProcess.exe\", \"umservice.exe\") and\n  file.extension : (\"php\", \"jsp\", \"js\", \"aspx\", \"asmx\", \"asax\", \"cfm\", \"shtml\") and\n  (\n    file.path : \"?:\\\\inetpub\\\\wwwroot\\\\aspnet_client\\\\*\" or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\*\" and\n       not (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\version\\\\*\" or\n            file.name : (\"errorFE.aspx\", \"expiredpassword.aspx\", \"frowny.aspx\", \"GetIdToken.htm\", \"logoff.aspx\",\n                        \"logon.aspx\", \"OutlookCN.aspx\", \"RedirSuiteServiceProxy.aspx\", \"signout.aspx\"))) or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\ecp\\\\auth\\\\*\" and\n       not file.name : \"TimeoutLogoff.aspx\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via CVE-2023-4911",
        "description": "This rule detects potential privilege escalation attempts through Looney Tunables (CVE-2023-4911). Looney Tunables is a buffer overflow vulnerability in GNU C Library's dynamic loader's processing of the GLIBC_TUNABLES environment variable.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.qualys.com/vulnerabilities-threat-research/2023/10/03/cve-2023-4911-looney-tunables-local-privilege-escalation-in-the-glibcs-ld-so"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nElastic Defend integration does not collect environment variable logging by default.\nIn order to capture this behavior, this rule requires a specific configuration option set within the advanced settings of the Elastic Defend integration.\n #### To set up environment variable capture for an Elastic Agent policy:\n- Go to Security  Manage  Policies.\n- Select an Elastic Agent policy.\n- Click Show advanced settings.\n- Scroll down or search for linux.advanced.capture_env_vars.\n- Enter the names of environment variables you want to capture, separated by commas.\n- For this rule the linux.advanced.capture_env_vars variable should be set to \"GLIBC_TUNABLES\".\n- Click Save.\nAfter saving the integration change, the Elastic Agents running this policy will be updated and the rule will function properly.\nFor more information on capturing environment variables refer to the [helper guide](https://www.elastic.co/guide/en/security/current/environment-variable-capture.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.env_vars",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "722ccdf7-7e55-4b7e-bf5f-fdf4548e18cd",
        "rule_id": "6d8685a1-94fa-4ef7-83de-59302e7c4ca8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.564Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:19.693Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.entity_id, process.executable with maxspan=5s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n  process.env_vars : \"*GLIBC_TUNABLES=glibc.*=glibc.*=*\"] with runs=5",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Users or Groups via Built-in Commands",
        "description": "Identifies the execution of macOS built-in commands related to account or group enumeration. Adversaries may use account and group information to orient themselves before deciding how to act.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.Ext.effective_parent.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "24668b50-050c-473e-a248-dc3c088770a5",
        "rule_id": "6e9b351e-a531-4bdc-b73e-7034d6eed7ff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.566Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.413Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    process.name : (\"ldapsearch\", \"dsmemberutil\") or\n    (process.name : \"dscl\" and\n      process.args : (\"read\", \"-read\", \"list\", \"-list\", \"ls\", \"search\", \"-search\") and\n      process.args : (\"/Active Directory/*\", \"/Users*\", \"/Groups*\"))\n\t) and\n  ((process.Ext.effective_parent.executable : (\"/Volumes/*\", \"/Applications/*\") or process.parent.executable : (\"/Volumes/*\", \"/Applications/*\")) or\n   (process.Ext.effective_parent.name : \".*\" or process.parent.name : \".*\")) and\n  not process.Ext.effective_parent.executable : (\"/Applications/QualysCloudAgent.app/Contents/MacOS/qualys-cloud-agent\",\n                                                 \"/Applications/Kaspersky Anti-Virus For Mac.app/Contents/MacOS/kavd.app/Contents/MacOS/kavd\",\n                                                 \"/Applications/ESET Endpoint Security.app/Contents/MacOS/esets_ctl\",\n                                                 \"/Applications/NordVPN.app/Contents/MacOS/NordVPN\",\n                                                 \"/Applications/Xcode.app/Contents/MacOS/Xcode\",\n                                                 \"/Applications/ESET Endpoint Security.app/Contents/Helpers/Uninstaller.app/Contents/MacOS/Uninstaller\",\n                                                 \"/Applications/Parallels Desktop.app/Contents/MacOS/prl_client_app\",\n                                                 \"/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler\",\n                                                 \"/Applications/com.avast.av.uninstaller.app/Contents/MacOS/com.avast.av.uninstaller\",\n                                                 \"/Applications/NoMAD.app/Contents/MacOS/NoMAD\",\n                                                 \"/Applications/ESET Management Agent.app/Contents/MacOS/ERAAgent\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Security Software Discovery using WMIC",
        "description": "Identifies the use of Windows Management Instrumentation Command (WMIC) to discover certain System Security Settings such as AntiVirus or Host Firewall details.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Security Software Discovery using WMIC\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `wmic` utility with arguments compatible to the enumeration of the security software installed on the host. Attackers can use this information to decide whether or not to infect a system, disable protections, use bypasses, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "85e2d7d8-e433-4c5e-9794-d8cb269d6e7a",
        "rule_id": "6ea55c81-e2ba-42f2-a134-bccf857ba922",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.567Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.201Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(process.name : \"wmic.exe\" or ?process.pe.original_file_name : \"wmic.exe\") and\nprocess.args : \"/namespace:\\\\\\\\root\\\\SecurityCenter2\" and process.args : \"Get\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Modification of Dynamic Linker Preload Shared Object",
        "description": "Identifies modification of the dynamic linker preload shared object (ld.so.preload). Adversaries may execute malicious payloads by hijacking the dynamic linker used to load libraries.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.anomali.com/blog/rocke-evolves-its-arsenal-with-a-new-malware-family-written-in-golang"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2b7a6b23-d58b-4d1c-bc93-4ed4e12a816f",
        "rule_id": "717f82c2-7741-4f9b-85b8-d06aeb853f4f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.571Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.204Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(updated or renamed or rename or file_rename_event) and \nnot event.type:deletion and file.path:/etc/ld.so.preload and not process.name:(wine or oneagentinstallaction)",
        "new_terms_fields": [
          "host.id",
          "user.id",
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Linux Tunneling and/or Port Forwarding",
        "description": "This rule monitors for a set of Linux utilities that can be used for tunneling and port forwarding. Attackers can leverage tunneling and port forwarding techniques to bypass network defenses, establish hidden communication channels, and gain unauthorized access to internal resources, facilitating data exfiltration, lateral movement, and remote control.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Linux Tunneling and/or Port Forwarding\n\nAttackers can leverage many utilities to clandestinely tunnel network communications and evade security measures, potentially gaining unauthorized access to sensitive systems.\n\nThis rule looks for several utilities that are capable of setting up tunnel network communications by analyzing process names or command line arguments. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate protocol tunneling. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Protocol Tunneling via Chisel Client - 3f12325a-4cc6-410b-8d4c-9fbbeb744cfd\n- Potential Protocol Tunneling via Chisel Server - ac8805f6-1e08-406c-962e-3937057fa86f\n- Potential Protocol Tunneling via EarthWorm - 9f1c4ca3-44b5-481d-ba42-32dc215a2769\n- Suspicious Utility Launched via ProxyChains - 6ace94ba-f02c-4d55-9f53-87d99b6f9af4\n- ProxyChains Activity - 4b868f1f-15ff-4ba3-8c11-d5a7a6356d37\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling/forwarding for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.bitsadmin.com/living-off-the-foreign-land-windows-as-offensive-platform",
          "https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c45a4f2b-f772-4c09-ad44-2b0b9524eaa3",
        "rule_id": "6ee947e9-de7e-4281-a55d-09289bdf947e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.569Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:19.696Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  (\n    // gost & pivotnacci - spawned without process.parent.name\n    (process.name == \"gost\" and process.args : (\"-L*\", \"-C*\", \"-R*\")) or (process.name == \"pivotnacci\")) or (\n    // ssh\n    (process.name in (\"ssh\", \"sshd\") and (process.args in (\"-R\", \"-L\", \"-D\", \"-w\") and process.args_count >= 4 and \n     not process.args : \"chmod\")) or\n    // sshuttle\n    (process.name == \"sshuttle\" and process.args in (\"-r\", \"--remote\", \"-l\", \"--listen\") and process.args_count >= 4) or\n    // socat\n    (process.name == \"socat\" and process.args : (\"TCP4-LISTEN:*\", \"SOCKS*\") and process.args_count >= 3) or\n    // chisel\n    (process.name : \"chisel*\" and process.args in (\"client\", \"server\")) or\n    // iodine(d), dnscat, hans, ptunnel-ng, ssf, 3proxy & ngrok \n    (process.name in (\"iodine\", \"iodined\", \"dnscat\", \"hans\", \"hans-ubuntu\", \"ptunnel-ng\", \"ssf\", \"3proxy\", \"ngrok\"))\n  ) and process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual File Creation - Alternate Data Stream",
        "description": "Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate files and sometimes done by adversaries to hide malware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual File Creation - Alternate Data Stream\n\nAlternate Data Streams (ADS) are file attributes only found on the NTFS file system. In this file system, files are built up from a couple of attributes; one of them is $Data, also known as the data attribute.\n\nThe regular data stream, also referred to as the unnamed data stream since the name string of this attribute is empty, contains the data inside the file. So any data stream that has a name is considered an alternate data stream.\n\nAttackers can abuse these alternate data streams to hide malicious files, string payloads, etc. This rule detects the creation of alternate data streams on highly targeted file types.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Retrieve the contents of the alternate data stream, and analyze it for potential maliciousness. Analysts can use the following PowerShell cmdlet to accomplish this:\n  - `Get-Content C:\\Path\\To\\file.exe -stream SampleAlternateDataStreamName`\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of process executable and file conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.004",
                    "name": "NTFS File Attributes",
                    "reference": "https://attack.mitre.org/techniques/T1564/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "da15fa13-59db-4450-b800-a80fc3ea13e0",
        "rule_id": "71bccb61-e19b-452f-b104-79a60e546a95",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.573Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:07.085Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n\n  file.path : \"C:\\\\*:*\" and\n  not file.path : \n          (\"C:\\\\*:zone.identifier*\",\n           \"C:\\\\users\\\\*\\\\appdata\\\\roaming\\\\microsoft\\\\teams\\\\old_weblogs_*:$DATA\",\n           \"C:\\\\Windows\\\\CSC\\\\*:CscBitmapStream\") and\n\n  not process.executable : (\n          \"?:\\\\Program Files (x86)\\\\Dropbox\\\\Client\\\\Dropbox.exe\",\n          \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n          \"?:\\\\Program Files\\\\ExpressConnect\\\\ExpressConnectNetworkService.exe\",\n          \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n          \"?:\\\\Program Files\\\\Rivet Networks\\\\SmartByte\\\\SmartByteNetworkService.exe\",\n          \"?:\\\\Windows\\\\explorer.exe\",\n          \"?:\\\\Windows\\\\System32\\\\DataExchangeHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\Intel\\\\ICPS\\\\IntelConnectivityNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\RivetNetworks\\\\Killer\\\\KillerNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n          \"?:\\\\Windows\\\\System32\\\\PickerHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\SearchProtocolHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\sihost.exe\",\n          \"?:\\\\windows\\\\System32\\\\svchost.exe\"\n  ) and\n\n  file.extension :\n    (\n      \"pdf\", \"dll\", \"exe\", \"dat\", \"com\", \"bat\", \"cmd\", \"sys\", \"vbs\", \"ps1\", \"hta\", \"txt\", \"vbe\", \"js\",\n      \"wsh\", \"docx\", \"doc\", \"xlsx\", \"xls\", \"pptx\", \"ppt\", \"rtf\", \"gif\", \"jpg\", \"png\", \"bmp\", \"img\", \"iso\"\n    )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious RDP ActiveX Client Loaded",
        "description": "Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate the presence of RDP lateral movement capability.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d30c29dd-cfac-4b42-9588-ed195d02d986",
        "rule_id": "71c5cb27-eca5-4151-bb47-64bc3f883270",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.575Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.456Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : \"mstscax.dll\" or file.name : \"mstscax.dll\") and\n   /* depending on noise in your env add here extra paths  */\n  process.executable : (\n    \"C:\\\\Windows\\\\*\",\n    \"C:\\\\Users\\\\Public\\\\*\",\n    \"C:\\\\Users\\\\Default\\\\*\",\n    \"C:\\\\Intel\\\\*\",\n    \"C:\\\\PerfLogs\\\\*\",\n    \"C:\\\\ProgramData\\\\*\",\n    \"\\\\Device\\\\Mup\\\\*\",\n    \"\\\\\\\\*\"\n  ) and\n  /* add here FPs */\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\System32\\\\vmconnect.exe\",\n    \"?:\\\\Windows\\\\System32\\\\WindowsSandboxClient.exe\",\n    \"?:\\\\Windows\\\\System32\\\\hvsirdpclient.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Modification of Accessibility Binaries",
        "description": "Windows contains accessibility features that may be launched with a key combination before a user has logged in. An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Modification of Accessibility Binaries\n\nAdversaries may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. Windows contains accessibility features that may be launched with a key combination before a user has logged in (ex: when the user is on the Windows logon screen). An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system.\n\nMore details can be found [here](https://attack.mitre.org/techniques/T1546/008/).\n\nThis rule looks for the execution of supposed accessibility binaries that don't match any of the accessibility features binaries' original file names, which is likely a custom binary deployed by the attacker.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/blog/practical-security-engineering-stateful-detection"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.008",
                    "name": "Accessibility Features",
                    "reference": "https://attack.mitre.org/techniques/T1546/008/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.008",
                    "name": "Accessibility Features",
                    "reference": "https://attack.mitre.org/techniques/T1546/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f229b5d3-a958-44b6-bc18-edcdfd9f7e36",
        "rule_id": "7405ddf1-6c8e-41ce-818f-48bea6bcaed8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.576Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.462Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : (\"Utilman.exe\", \"winlogon.exe\") and user.name == \"SYSTEM\" and\n process.pe.original_file_name : \"?*\" and\n process.args :\n    (\n    \"C:\\\\Windows\\\\System32\\\\osk.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Magnify.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Narrator.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Sethc.exe\",\n    \"utilman.exe\",\n    \"ATBroker.exe\",\n    \"DisplaySwitch.exe\",\n    \"sethc.exe\"\n    )\n and not process.pe.original_file_name in\n    (\n    \"osk.exe\",\n    \"sethc.exe\",\n    \"utilman2.exe\",\n    \"DisplaySwitch.exe\",\n    \"ATBroker.exe\",\n    \"ScreenMagnifier.exe\",\n    \"SR.exe\",\n    \"Narrator.exe\",\n    \"magnify.exe\",\n    \"MAGNIFY.EXE\"\n    )\n\n/* uncomment once in winlogbeat to avoid bypass with rogue process with matching pe original file name */\n/* and process.code_signature.subject_name == \"Microsoft Windows\" and process.code_signature.status == \"trusted\" */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Sysctl File Event",
        "description": "Monitors file events on sysctl configuration files (e.g., /etc/sysctl.conf, /etc/sysctl.d/*.conf) to identify potential unauthorized access or manipulation of system-level configuration settings. Attackers may tamper with the sysctl configuration files to modify kernel parameters, potentially compromising system stability, performance, or security.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n\n```\n-w /etc/sysctl.conf -p wa -k sysctl\n-w /etc/sysctl.d -p wa -k sysctl\n```\n\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4a0475bd-aeee-462e-a15b-fd0eb52b8c19",
        "rule_id": "7592c127-89fb-4209-a8f6-f9944dfd7e02",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.578Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.466Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(\"opened-file\" or \"read-file\" or \"wrote-to-file\") and\nfile.path : (\"/etc/sysctl.conf\" or \"/etc/sysctl.d\" or /etc/sysctl.d/*) and not process.name:(\n  dpkg or dockerd or unattended-upg or systemd-sysctl or python* or auditbeat or dpkg or pool*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Volume Shadow Copy Deletion via PowerShell",
        "description": "Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deletion via PowerShell\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of PowerShell cmdlets to interact with the Win32_ShadowCopy WMI class, retrieve shadow copy objects, and delete them.\n\n#### Possible investigation steps\n\n- Investigate the program execution chain (parent process tree).\n- Check whether the account is authorized to perform this operation.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule has chances of producing benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/desktop/vsswmi/win32-shadowcopy",
          "https://powershell.one/wmi/root/cimv2/win32_shadowcopy",
          "https://www.fortinet.com/blog/threat-research/stomping-shadow-copies-a-second-look-into-deletion-methods"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e4e5b730-b6e7-4497-8487-a58d60f79803",
        "rule_id": "d99a037b-c8e2-47a5-97b9-170d076827c4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.580Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.376Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.args : (\"*Get-WmiObject*\", \"*gwmi*\", \"*Get-CimInstance*\", \"*gcim*\") and\n  process.args : (\"*Win32_ShadowCopy*\") and\n  process.args : (\"*.Delete()*\", \"*Remove-WmiObject*\", \"*rwmi*\", \"*Remove-CimInstance*\", \"*rcim*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Content Extracted or Decompressed via Funzip",
        "description": "Identifies when suspicious content is extracted from a file and subsequently decompressed using the funzip utility. Malware may execute the tail utility using the \"-c\" option to read a sequence of bytes from the end of a file. The output from tail can be piped to funzip in order to decompress malicious code before it is executed. This behavior is consistent with malware families such as Bundlore.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/software/S0482/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "58c65905-4bec-4bfb-a639-692860f7cfbc",
        "rule_id": "dc0b7782-0df0-47ff-8337-db0d678bdb66",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.582Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.588Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n((process.args == \"tail\" and process.args == \"-c\" and process.args == \"funzip\")) and\nnot process.args : \"/var/log/messages\" and \nnot process.parent.executable : (\"/usr/bin/dracut\", \"/sbin/dracut\", \"/usr/bin/xargs\") and\nnot (process.parent.name in (\"sh\", \"sudo\") and process.parent.command_line : \"*nessus_su*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Hidden Process via Mount Hidepid",
        "description": "Identifies the execution of mount process with hidepid parameter, which can make processes invisible to other users from the system. Adversaries using Linux kernel version 3.2+ (or RHEL/CentOS v6.5+ above) can hide the process from other users. When hidepid=2 option is executed to mount the /proc filesystem, only the root user can see all processes and the logged-in user can only see their own process. This provides a defense evasion mechanism for the adversaries to hide their process executions from all other commands such as ps, top, pgrep and more. With the Linux kernel hardening hidepid option all the user has to do is remount the /proc filesystem with the option, which can now be monitored and detected.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/linux-hide-processes-from-other-users/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "3992618c-a479-48d2-b652-452798a55cdd",
        "rule_id": "dc71c186-9fe4-4437-a4d0-85ebb32b8204",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.583Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.389Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name == \"mount\" and process.args == \"/proc\" and process.args == \"-o\" and process.args : \"*hidepid=2*\" and\nnot process.parent.command_line like \"/opt/cloudlinux/*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Volume Shadow Copy Deletion via WMIC",
        "description": "Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deletion via WMIC\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of `wmic.exe` to interact with VSS via the `shadowcopy` alias and delete parameter.\n\n#### Possible investigation steps\n\n- Investigate the program execution chain (parent process tree).\n- Check whether the account is authorized to perform this operation.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule has chances of producing benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4dbbb421-4cf8-41a8-98da-fceffa2d2d26",
        "rule_id": "dc9c1f74-dac3-48e3-b47f-eb79db358f57",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.585Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.392Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"WMIC.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"delete\" and process.args : \"shadowcopy\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Child Process from a System Virtual Process",
        "description": "Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "d0501d06-c616-42da-9a88-6ce855a6750d",
        "rule_id": "de9bd7e0-49e9-4e92-a64d-53ade2e66af1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:10.741Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.477Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.pid == 4 and process.executable : \"?*\" and\n  not process.executable : (\"Registry\", \"MemCompression\", \"?:\\\\Windows\\\\System32\\\\smss.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Dynamic Linker Copy",
        "description": "Detects the copying of the Linux dynamic loader binary and subsequent file creation for the purpose of creating a backup copy. This technique was seen recently being utilized by Linux malware prior to patching the dynamic loader in order to inject and preload a malicious shared object file. This activity should never occur and if it does then it should be considered highly suspicious or malicious.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Dynamic Linker Copy\n\nThe Linux dynamic linker is responsible for loading shared libraries required by executables at runtime. It is a critical component of the Linux operating system and should not be tampered with. \n\nAdversaries may attempt to copy the dynamic linker binary and create a backup copy before patching it to inject and preload malicious shared object files. This technique has been observed in recent Linux malware attacks and is considered highly suspicious or malicious.\n\nThe detection rule 'Dynamic Linker Copy' is designed to identify such abuse by monitoring for processes with names \"cp\" or \"rsync\" that involve copying the dynamic linker binary (\"/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\") and modifying the \"/etc/ld.so.preload\" file. Additionally, the rule checks for the creation of new files with the \"so\" extension on Linux systems. By detecting these activities within a short time span (1 minute), the rule aims to alert security analysts to potential malicious behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the dynamic linker that was copied or altered.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE ( path = '/etc/ld.so.preload' OR path = '/lib64/ld-linux-x86-64.so.2' OR path =\\n'/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2' OR path = '/usr/lib64/ld-linux-x86-64.so.2' OR path =\\n'/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2' )\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path = '/etc/ld.so.preload' OR path =\\n'/lib64/ld-linux-x86-64.so.2' OR path = '/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2' OR path =\\n'/usr/lib64/ld-linux-x86-64.so.2' OR path = '/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2' )\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n- The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Modification of Dynamic Linker Preload Shared Object Inside A Container - 342f834b-21a6-41bf-878c-87d116eba3ee\n- Modification of Dynamic Linker Preload Shared Object - 717f82c2-7741-4f9b-85b8-d06aeb853f4f\n- Shared Object Created or Changed by Previously Unknown Process - aebaa51f-2a91-4f6a-850b-b601db2293f4\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Orbit",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/incident-response/orbit-new-undetected-linux-threat/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "50acb8a2-d11c-4a7b-825a-45a2e7fff3fb",
        "rule_id": "df6f62d9-caab-4b88-affa-044f4395a1e0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.686Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.405Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n[process where host.os.type == \"linux\" and event.type == \"start\" and process.name in (\"cp\", \"rsync\") and\n   process.args in (\n     \"/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/etc/ld.so.preload\", \"/lib64/ld-linux-x86-64.so.2\",\n     \"/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/usr/lib64/ld-linux-x86-64.so.2\"\n    )]\n[file where host.os.type == \"linux\" and event.action == \"creation\" and file.extension == \"so\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Connection to External Network via Telnet",
        "description": "Telnet provides a command line interface for communication with a remote device or server. This rule identifies Telnet network connections to publicly routable IP addresses.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Telnet can be used for both benign or malicious purposes. Telnet is included by default in some Linux distributions, so its presence is not inherently suspicious. The use of Telnet to manage devices remotely has declined in recent years in favor of more secure protocols such as SSH. Telnet usage by non-automated tools or frameworks may be suspicious."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "503281c3-5c1d-4042-a6d9-9f0155fd6ce1",
        "rule_id": "e19e64ee-130e-4c07-961f-8a339f0b8362",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.688Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.408Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"linux\" and process.name == \"telnet\" and event.type == \"start\"]\n  [network where host.os.type == \"linux\" and process.name == \"telnet\" and not cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n    )\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Mining Process Creation Event",
        "description": "Identifies service creation events of common mining services, possibly indicating the infection of a system with a cryptominer.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2692aea9-8dc0-46a1-85f0-cb3a53cce631",
        "rule_id": "e2258f48-ba75-4248-951b-7c885edf18c2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.690Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.412Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and event.action : (\"creation\", \"file_create_event\") and \nfile.name : (\"aliyun.service\", \"moneroocean_miner.service\", \"c3pool_miner.service\", \"pnsd.service\", \"apache4.service\", \"pastebin.service\", \"xvf.service\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious .NET Reflection via PowerShell",
        "description": "Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this method to load executables and DLLs without writing to the disk, bypassing security solutions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious .NET Reflection via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use .NET reflection to load PEs and DLLs in memory. These payloads are commonly embedded in the script, which can circumvent file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 316,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1620",
                "name": "Reflective Code Loading",
                "reference": "https://attack.mitre.org/techniques/T1620/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.001",
                    "name": "Dynamic-link Library Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/001/"
                  },
                  {
                    "id": "T1055.002",
                    "name": "Portable Executable Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "36127cc9-9f5c-49d2-96b3-4c7a739b701f",
        "rule_id": "e26f042e-c590-4e82-8e05-41e81bd822ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.691Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.300Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Monitoring Host Temporary Files*\\\\AvailabilityGroupMonitoring.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"[System.Reflection.Assembly]::Load\" or\n    \"[Reflection.Assembly]::Load\"\n  ) and\n  not powershell.file.script_block_text : (\n        (\"CommonWorkflowParameters\" or \"RelatedLinksHelpInfo\") and\n        \"HelpDisplayStrings\"\n  ) and\n  not (powershell.file.script_block_text :\n        (\"Get-SolutionFiles\" or \"Get-VisualStudio\" or \"Select-MSBuildPath\") and\n        file.name : \"PathFunctions.ps1\"\n  ) and\n  not powershell.file.script_block_text : (\n        \"Microsoft.PowerShell.Workflow.ServiceCore\" and \"ExtractPluginProperties([string]$pluginDir\"\n  ) and \n  \n  not powershell.file.script_block_text : (\"reflection.assembly]::Load('System.\" or \"LoadWithPartialName('Microsoft.\" or \"::Load(\\\"Microsoft.\" or \"Microsoft.Build.Utilities.Core.dll\") and \n  \n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Suspicious Process Execution via Renamed PsExec Executable",
        "description": "Identifies suspicious psexec activity which is executing from the psexec service that has been renamed, possibly to evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Process Execution via Renamed PsExec Executable\n\nPsExec is a remote administration tool that enables the execution of commands with both regular and SYSTEM privileges on Windows systems. It operates by executing a service component `Psexecsvc` on a remote system, which then runs a specified process and returns the results to the local system. Microsoft develops PsExec as part of the Sysinternals Suite. Although commonly used by administrators, PsExec is frequently used by attackers to enable lateral movement and execute commands as SYSTEM to disable defenses and bypass security protections.\n\nThis rule identifies instances where the PsExec service component is executed using a custom name. This behavior can indicate an attempt to bypass security controls or detections that look for the default PsExec service component name.\n\n#### Possible investigation steps\n\n- Check if the usage of this tool complies with the organization's administration policy.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify the target computer and its role in the IT environment.\n- Investigate what commands were run, and assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. As long as the analyst did not identify suspicious activity related to the user or involved hosts, and the tool is allowed by the organization's policy, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - Prioritize cases involving critical servers and users.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d15e4c97-d6c3-4e12-abcc-f9ac18df1548",
        "rule_id": "e2f9fdf5-8076-45ad-9427-41e0e03dc9c2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.693Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.303Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name : \"psexesvc.exe\" and not process.name : \"PSEXESVC.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Process Activity via Compiled HTML File",
        "description": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Activity via Compiled HTML File\n\nCHM (Compiled HTML) files are a format for delivering online help files on Windows. CHM files are compressed compilations of various content, such as HTML documents, images, and scripting/web-related programming languages such as VBA, JScript, Java, and ActiveX.\n\nWhen users double-click CHM files, the HTML Help executable program (`hh.exe`) will execute them. `hh.exe` also can be used to execute code embedded in those files, PowerShell scripts, and executables. This makes it useful for attackers not only to proxy the execution of malicious payloads via a signed binary that could bypass security controls, but also to gain initial access to environments via social engineering methods.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate the parent process to gain understanding of what triggered this behavior.\n  - Retrieve `.chm`, `.ps1`, and other files that were involved to further examination.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executables, scripts and help files retrieved from the system using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The HTML Help executable program (hh.exe) runs whenever a user clicks a compiled help (.chm) file or menu item that opens the help file inside the Help Viewer. This is not always malicious, but adversaries may abuse this technology to conceal malicious code."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.001",
                    "name": "Compiled HTML File",
                    "reference": "https://attack.mitre.org/techniques/T1218/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "52b89cf2-cabb-43a8-978b-c8c5372b0718",
        "rule_id": "e3343ab9-4245-4715-b344-e11c56b0a47f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.695Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.415Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"hh.exe\" and\n process.name : (\"mshta.exe\", \"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cscript.exe\", \"wscript.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Connection to Commonly Abused Free SSL Certificate Providers",
        "description": "Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a known encryption algorithm to conceal command and control traffic.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1573",
                "name": "Encrypted Channel",
                "reference": "https://attack.mitre.org/techniques/T1573/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "97a8c770-dc96-4cb4-9fa6-c77ebc424d97",
        "rule_id": "e3cf38fa-d5b8-46cc-87f9-4a7513e4281d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.697Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.500Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n  /* Add new free SSL certificate provider domains here */\n  dns.question.name : (\"*letsencrypt.org\", \"*.sslforfree.com\", \"*.zerossl.com\", \"*.freessl.org\") and\n\n  /* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */\n  process.executable : (\"C:\\\\Windows\\\\System32\\\\*.exe\",\n                        \"C:\\\\Windows\\\\System\\\\*.exe\",\n\t                  \"C:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\explorer.exe\",\n\t\t          \"C:\\\\Windows\\\\notepad.exe\") and\n\n  /* Insert noisy false positives here */\n  not process.name : (\"svchost.exe\", \"MicrosoftEdge*.exe\", \"msedge.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via KDE AutoStart Script or Desktop File Modification",
        "description": "Identifies the creation or modification of a K Desktop Environment (KDE) AutoStart script or desktop file that will execute upon each user logon. Adversaries may abuse this method for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via KDE AutoStart Script or Desktop File Modification\n\nK Desktop Environment (KDE) is a popular graphical desktop environment for Linux systems. It supports AutoStart scripts and desktop files that execute automatically upon user logon.\n\nAdversaries may exploit this feature to maintain persistence on a compromised system by creating or modifying these files.\n\nThe detection rule 'Persistence via KDE AutoStart Script or Desktop File Modification' is designed to identify such activities by monitoring file events on Linux systems. It specifically targets the creation or modification of files with extensions \".sh\" or \".desktop\" in various AutoStart directories. By detecting these events, the rule helps security analysts identify potential abuse of KDE AutoStart functionality by malicious actors.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE ( path LIKE '/home/%/.config/autostart/%.sh' OR path LIKE '/home/%/.config/autostart/%.desktop'\\nOR path LIKE '/root/.config/autostart/%.sh' OR path LIKE '/root/.config/autostart/%.desktop' OR path LIKE\\n'/home/%/.kde/Autostart/%.sh' OR path LIKE '/home/%/.kde/Autostart/%.desktop' OR path LIKE '/root/.kde/Autostart/%.sh'\\nOR path LIKE '/root/.kde/Autostart/%.desktop' OR path LIKE '/home/%/.kde4/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/Autostart/%.desktop' OR path LIKE '/root/.kde4/Autostart/%.sh' OR path LIKE\\n'/root/.kde4/Autostart/%.desktop' OR path LIKE '/home/%/.kde/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde/share/autostart/%.desktop' OR path LIKE '/root/.kde/share/autostart/%.sh' OR path LIKE\\n'/root/.kde/share/autostart/%.desktop' OR path LIKE '/home/%/.kde4/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/share/autostart/%.desktop' OR path LIKE '/root/.kde4/share/autostart/%.sh' OR path LIKE\\n'/root/.kde4/share/autostart/%.desktop' OR path LIKE '/home/%/.local/share/autostart/%.sh' OR path LIKE\\n'/home/%/.local/share/autostart/%.desktop' OR path LIKE '/root/.local/share/autostart/%.sh' OR path LIKE\\n'/root/.local/share/autostart/%.desktop' OR path LIKE '/home/%/.config/autostart-scripts/%.sh' OR path LIKE\\n'/home/%/.config/autostart-scripts/%.desktop' OR path LIKE '/root/.config/autostart-scripts/%.sh' OR path LIKE\\n'/root/.config/autostart-scripts/%.desktop' OR path LIKE '/etc/xdg/autostart/%.sh' OR path LIKE\\n'/etc/xdg/autostart/%.desktop' OR path LIKE '/usr/share/autostart/%.sh' OR path LIKE '/usr/share/autostart/%.desktop' )\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/home/%/.config/autostart/%.sh' OR\\npath LIKE '/home/%/.config/autostart/%.desktop' OR path LIKE '/root/.config/autostart/%.sh' OR path LIKE\\n'/root/.config/autostart/%.desktop' OR path LIKE '/home/%/.kde/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde/Autostart/%.desktop' OR path LIKE '/root/.kde/Autostart/%.sh' OR path LIKE\\n'/root/.kde/Autostart/%.desktop' OR path LIKE '/home/%/.kde4/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/Autostart/%.desktop' OR path LIKE '/root/.kde4/Autostart/%.sh' OR path LIKE\\n'/root/.kde4/Autostart/%.desktop' OR path LIKE '/home/%/.kde/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde/share/autostart/%.desktop' OR path LIKE '/root/.kde/share/autostart/%.sh' OR path LIKE\\n'/root/.kde/share/autostart/%.desktop' OR path LIKE '/home/%/.kde4/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/share/autostart/%.desktop' OR path LIKE '/root/.kde4/share/autostart/%.sh' OR path LIKE\\n'/root/.kde4/share/autostart/%.desktop' OR path LIKE '/home/%/.local/share/autostart/%.sh' OR path LIKE\\n'/home/%/.local/share/autostart/%.desktop' OR path LIKE '/root/.local/share/autostart/%.sh' OR path LIKE\\n'/root/.local/share/autostart/%.desktop' OR path LIKE '/home/%/.config/autostart-scripts/%.sh' OR path LIKE\\n'/home/%/.config/autostart-scripts/%.desktop' OR path LIKE '/root/.config/autostart-scripts/%.sh' OR path LIKE\\n'/root/.config/autostart-scripts/%.desktop' OR path LIKE '/etc/xdg/autostart/%.sh' OR path LIKE\\n'/etc/xdg/autostart/%.desktop' OR path LIKE '/usr/share/autostart/%.sh' OR path LIKE '/usr/share/autostart/%.desktop' )\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://userbase.kde.org/System_Settings/Autostart",
          "https://www.amnesty.org/en/latest/research/2020/09/german-made-finspy-spyware-found-in-egypt-and-mac-and-linux-versions-revealed/",
          "https://www.intezer.com/blog/research/operation-electrorat-attacker-creates-fake-companies-to-drain-your-crypto-wallets/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "49c386c1-a9e3-455a-81ba-166b9b099cc7",
        "rule_id": "e3e904b3-0a8e-4e68-86a8-977a163e21d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.698Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.306Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type != \"deletion\" and\n  file.extension in (\"sh\", \"desktop\") and\n  file.path :\n    (\n      \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n      \"/home/*/.kde/Autostart/*\", \"/root/.kde/Autostart/*\",\n      \"/home/*/.kde4/Autostart/*\", \"/root/.kde4/Autostart/*\",\n      \"/home/*/.kde/share/autostart/*\", \"/root/.kde/share/autostart/*\",\n      \"/home/*/.kde4/share/autostart/*\", \"/root/.kde4/share/autostart/*\",\n      \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\",\n      \"/home/*/.config/autostart-scripts/*\", \"/root/.config/autostart-scripts/*\",\n      \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\"\n    ) and\n    not process.name in (\n      \"yum\", \"dpkg\", \"install\", \"dnf\", \"teams\", \"yum-cron\", \"dnf-automatic\", \"docker\", \"dockerd\", \"rpm\", \"pacman\",\n      \"podman\", \"nautilus\", \"remmina\", \"cinnamon-settings.py\", \"executor\", \"xfce4-clipman\", \"jetbrains-toolbox\",\n      \"ansible-admin\"\n    )",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Kerberos Pre-authentication Disabled for User",
        "description": "Identifies the modification of an account's Kerberos pre-authentication options. An adversary with GenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline password cracking attacks such as AS-REP roasting.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kerberos Pre-authentication Disabled for User\n\nKerberos pre-authentication is an account protection against offline password cracking. When enabled, a user requesting access to a resource initiates communication with the Domain Controller (DC) by sending an Authentication Server Request (AS-REQ) message with a timestamp that is encrypted with the hash of their password. If and only if the DC is able to successfully decrypt the timestamp with the hash of the users password, it will then send an Authentication Server Response (AS-REP) message that contains the Ticket Granting Ticket (TGT) to the user. Part of the AS-REP message is signed with the users password. Microsoft's security monitoring [recommendations](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738) state that `'Don't Require Preauth'  Enabled` should not be enabled for user accounts because it weakens security for the accounts Kerberos authentication.\n\nAS-REP roasting is an attack against Kerberos for user accounts that do not require pre-authentication, which means that if the target user has pre-authentication disabled, an attacker can request authentication data for it and get a TGT that can be brute-forced offline, similarly to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Determine if the target account is sensitive or privileged.\n- Inspect the account activities for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- Disabling pre-authentication is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positives (B-TPs), especially if the target account is privileged.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Reset the target account's password if there is any risk of TGTs having been retrieved.\n- Re-enable the preauthentication option or disable the target account.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://harmj0y.medium.com/roasting-as-reps-e6179a65216b",
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.004",
                    "name": "AS-REP Roasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit User Account Management' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nAccount Management >\nAudit User Account Management (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "message",
            "type": "match_only_text",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "246a3410-da07-4bea-bce8-c08b3e733961",
        "rule_id": "e514d8cd-ed15-4011-84e2-d15147e059f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.700Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.421Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.code:4738 and winlog.api:\"wineventlog\" and message:\"'Don't Require Preauth' - Enabled\"",
        "language": "kuery"
      },
      {
        "name": "Screensaver Plist File Modified by Unexpected Process",
        "description": "Identifies when a screensaver plist file is modified by an unexpected process. An adversary can maintain persistence on a macOS endpoint by creating a malicious screensaver (.saver) file and configuring the screensaver plist file to execute code each time the screensaver is activated.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n- Analyze the plist file modification event to identify whether the change was expected or not\n- Investigate the process that modified the plist file for malicious code or other suspicious behavior\n- Identify if any suspicious or known malicious screensaver (.saver) files were recently written to or modified on the host\n",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/saving-your-access-d562bf5bf90b",
          "https://github.com/D00MFist/PersistentJXA"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e6de3ccb-3c15-45a0-8e81-1fedca4a3792",
        "rule_id": "e6e8912f-283f-4d0d-8442-e0dcaf49944b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.702Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.513Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"macos\" and event.type != \"deletion\" and\n  file.name: \"com.apple.screensaver.*.plist\" and\n   file.path : (\n      \"/Users/*/Library/Preferences/ByHost/*\",\n      \"/Library/Managed Preferences/*\",\n      \"/System/Library/Preferences/*\"\n      ) and\n  (\n    process.code_signature.trusted == false or\n    process.code_signature.exists == false or\n\n    /* common script interpreters and abused native macOS bins */\n    process.name : (\n      \"curl\",\n      \"mktemp\",\n      \"tail\",\n      \"funzip\",\n      \"python*\",\n      \"osascript\",\n      \"perl\"\n      )\n   ) and\n\n  /* Filter OS processes modifying screensaver plist files */\n  not process.executable : (\n    \"/usr/sbin/cfprefsd\",\n    \"/usr/libexec/xpcproxy\",\n    \"/System/Library/CoreServices/ManagedClient.app/Contents/Resources/MCXCompositor\",\n    \"/System/Library/CoreServices/ManagedClient.app/Contents/MacOS/ManagedClient\"\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Credential Dumping via Unshadow",
        "description": "Identifies the execution of the unshadow utility which is part of John the Ripper, a password-cracking tool on the host machine. Malicious actors can use the utility to retrieve the combined contents of the '/etc/shadow' and '/etc/password' files. Using the combined file generated from the utility, the malicious threat actors can use them as input for password-cracking utilities or prepare themselves for future operations by gathering credential information of the victim.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Data Source: Elastic Endgame",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4e53d317-00d3-4a6c-8f2f-4525242998ea",
        "rule_id": "e7cb3cfd-aaa3-4d7b-af18-23b89955062c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.704Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.309Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name == \"unshadow\" and process.args_count >= 3",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Installation of Security Support Provider",
        "description": "Identifies registry modifications related to the Windows Security Support Provider (SSP) configuration. Adversaries may abuse this to establish persistence in an environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.005",
                    "name": "Security Support Provider",
                    "reference": "https://attack.mitre.org/techniques/T1547/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "59c6ccbb-7d9d-43b3-99ce-4788f57c9af9",
        "rule_id": "e86da94d-e54b-4fb5-b96c-cecff87e8787",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.705Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.431Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n   registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\",\n      \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n      \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\"\n   ) and\n   not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\", \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious System Commands Executed by Previously Unknown Executable",
        "description": "This rule monitors for the execution of several commonly used system commands executed by a previously unknown executable located in commonly abused directories. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to run malicious code. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "570123cd-ed2e-45b6-acf0-0e51a9b0936c",
        "rule_id": "e9001ee6-2d00-4d2f-849e-b8b1fb05234c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.707Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.520Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.action:(exec or exec_event or fork or fork_event) and\nprocess.executable:(* and (\n  /etc/crontab or /bin/* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or /etc/update-motd.d/* or\n  /home/*/.* or /tmp/* or /usr/bin/* or /usr/lib/update-notifier/* or /usr/share/* or /var/tmp/*\n) and not /tmp/go-build*) and\nprocess.args:(hostname or id or ifconfig or ls or netstat or ps or pwd or route or top or uptime or whoami) and\nnot (process.name:\n  (apt or dnf or docker or dockerd or dpkg or hostname or id or ls or netstat or ps or pwd or rpm or snap or\n  snapd or sudo or top or uptime or which or whoami or yum) or\nprocess.parent.executable:(\n  /opt/cassandra/bin/cassandra or /opt/nessus/sbin/nessusd or /opt/nessus_agent/sbin/nessus-agent-module or /opt/puppetlabs/puppet/bin/puppet or\n  /opt/puppetlabs/puppet/bin/ruby or /usr/libexec/platform-python or /usr/local/cloudamize/bin/CCAgent or /usr/sbin/sshd or /bin/* or\n  /etc/network/* or /opt/Elastic/* or /opt/TrendMicro* or /opt/aws/* or /opt/eset/* or /opt/rapid7/* or /run/containerd/* or /run/k3s/* or\n  /snap/* or /tmp/dpkg-licenses* or /tmp/newroot/* or /usr/bin/* or /var/lib/amagent/* or /var/lib/docker/* or /vz/*\n  ) or\n  process.executable:(/run/containerd/* or /srv/snp/docker/* or /tmp/.criu*)\n)",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual Executable File Creation by a System Critical Process",
        "description": "Identifies an unexpected executable file being created or modified by a Windows system critical process, which may indicate activity related to remote code execution or other forms of exploitation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Executable File Creation by a System Critical Process\n\nWindows internal/system processes have some characteristics that can be used to spot suspicious activities. One of these characteristics is file operations.\n\nThis rule looks for the creation of executable files done by system-critical processes. This can indicate the exploitation of a vulnerability or a malicious process masquerading as a system-critical process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1211",
                "name": "Exploitation for Defense Evasion",
                "reference": "https://attack.mitre.org/techniques/T1211/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "30864641-cdba-4448-9a9e-5b6ea0cfcf46",
        "rule_id": "e94262f2-c1e9-4d3f-a907-aeab16712e1a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.709Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.373Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : (\"exe\", \"dll\") and\n  process.name : (\"smss.exe\",\n                  \"autochk.exe\",\n                  \"csrss.exe\",\n                  \"wininit.exe\",\n                  \"services.exe\",\n                  \"lsass.exe\",\n                  \"winlogon.exe\",\n                  \"userinit.exe\",\n                  \"LogonUI.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Kerberos Ticket Request",
        "description": "Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step in Kerberoasting toolkits to crack service accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Kerberos Ticket Request\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nAccounts associated with a service principal name (SPN) are viable targets for Kerberoasting attacks, which use brute force to crack the user password, which is used to encrypt a Kerberos TGS ticket.\n\nAttackers can use PowerShell to request these Kerberos tickets, with the intent of extracting them from memory to perform Kerberoasting.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate if the script was executed, and if so, which account was targeted.\n- Validate if the account has an SPN associated with it.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Check if the script has any other functionality that can be potentially malicious.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Review event ID [4769](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4769) related to this account and service name for additional information.\n\n### False positive analysis\n\n- A possible false positive can be identified if the script content is not malicious/harmful or does not request Kerberos tickets for user accounts, as computer accounts are not vulnerable to Kerberoasting due to complex password requirements and policy.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://cobalt.io/blog/kerberoast-attack-techniques",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "10c46770-ebcc-4ff7-858d-1c9d2d91bbb4",
        "rule_id": "eb610e70-f9e6-4949-82b9-f1c5bcd37c39",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.712Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.434Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    KerberosRequestorSecurityToken\n  ) and not user.id : (\"S-1-5-18\" or \"S-1-5-20\") and\n  not powershell.file.script_block_text : (\n    (\"sentinelbreakpoints\" and (\"Set-PSBreakpoint\" or \"Set-HookFunctionTabs\")) or\n    (\"function global\" and \"\\\\windows\\\\sentinel\\\\4\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Mimikatz Memssp Log File Detected",
        "description": "Identifies the password log file from the default Mimikatz memssp module.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Mimikatz Memssp Log File Detected\n\n[Mimikatz](https://github.com/gentilkiwi/mimikatz) is an open-source tool used to collect, decrypt, and/or use cached credentials. This tool is commonly abused by adversaries during the post-compromise stage where adversaries have gained an initial foothold on an endpoint and are looking to elevate privileges and seek out additional authentication objects such as tokens/hashes/credentials that can then be used to laterally move and pivot across a network.\n\nThis rule looks for the creation of a file named `mimilsa.log`, which is generated when using the Mimikatz misc::memssp module, which injects a malicious Windows SSP to collect locally authenticated credentials, which includes the computer account password, running service credentials, and any accounts that logon.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n- Retrieve and inspect the log file contents.\n- Search for DLL files created in the same location as the log file, and retrieve unsigned DLLs.\n  - Use the PowerShell Get-FileHash cmdlet to get the SHA-256 hash value of these files.\n    - Search for the existence of these files in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Identify the process that created the DLL using file creation events.\n\n### False positive analysis\n\n- This file name `mimilsa.log` should not legitimately be created.\n\n### Related rules\n\n- Mimikatz Powershell Module Activity - ac96ceb8-4399-4191-af1d-4feeac1f1f46\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the host is a Domain Controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs to ensure that the least privilege principle is being followed and reduce the attack surface.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reboot the host to remove the injected SSP from memory.\n- Reimage the host operating system or restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b6580a6c-8c7f-4953-821b-d3624f572dc2",
        "rule_id": "ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.714Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.530Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and file.name : \"mimilsa.log\" and process.name : \"lsass.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Webcam Video Capture Capabilities",
        "description": "Detects PowerShell scripts that can be used to record webcam video. Attackers can capture this information to extort or spy on victims.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/lib/modules/powershell/collection/WebcamRecorder.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1125",
                "name": "Video Capture",
                "reference": "https://attack.mitre.org/techniques/T1125/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "2bc2b84a-1a7a-46bf-af59-0b7ca2e9544c",
        "rule_id": "eb44611f-62a8-4036-a5ef-587098be6c43",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.711Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.875Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"NewFrameEventHandler\" or\n    \"VideoCaptureDevice\" or\n    \"DirectX.Capture.Filters\" or\n    \"VideoCompressors\" or\n    \"Start-WebcamRecorder\" or\n    (\n      (\"capCreateCaptureWindowA\" or\n       \"capCreateCaptureWindow\" or\n       \"capGetDriverDescription\") and\n      (\"avicap32.dll\" or \"avicap32\")\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "IIS HTTP Logging Disabled",
        "description": "Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS server access via a webshell or other mechanism can disable HTTP Logging as an effective anti-forensics measure.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating IIS HTTP Logging Disabled\n\nIIS (Internet Information Services) is a Microsoft web server software used to host websites and web applications on Windows. It provides features for serving dynamic and static content, and can be managed through a graphical interface or command-line tools.\n\nIIS logging is a data source that can be used for security monitoring, forensics, and incident response. It contains mainly information related to requests done to the web server, and can be used to spot malicious activities like webshells. Adversaries can tamper, clear, and delete this data to evade detection, cover their tracks, and slow down incident response.\n\nThis rule monitors commands that disable IIS logging.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Verify whether the logs stored in the `C:\\inetpub\\logs\\logfiles\\w3svc1` directory were deleted after this action.\n- Check if this operation is done under change management and approved according to the organization's policy.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Re-enable affected logging components, services, and security monitoring.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.002",
                    "name": "Disable Windows Event Logging",
                    "reference": "https://attack.mitre.org/techniques/T1562/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a9848ec1-c377-4846-adba-9a7be89f8907",
        "rule_id": "ebf1adea-ccf2-4943-8b96-7ab11ca173a5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.716Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.533Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"appcmd.exe\" or ?process.pe.original_file_name == \"appcmd.exe\") and\n  process.args : \"/dontLog*:*True\" and\n  not process.parent.name : \"iissetup.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Process Execution from an Unusual Directory",
        "description": "Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hide malware in trusted paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Execution from an Unusual Directory\n\nThis rule identifies processes that are executed from suspicious default Windows directories. Adversaries may abuse this technique by planting malware in trusted paths, making it difficult for security analysts to discern if their activities are malicious or take advantage of exceptions that may apply to these paths.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes, examining their executable files for prevalence, location, and valid digital signatures.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Examine arguments and working directory to determine the program's source or the nature of the tasks it is performing.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of executable and signature conditions.\n\n### Related Rules\n\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Execution from Unusual Directory - Command Line - cff92c41-2225-4763-b4ce-6f71e5bda5e6\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "38411afc-63b9-43ae-b74c-c301df2b3445",
        "rule_id": "ebfe1448-7fac-4d59-acea-181bd89b1f7f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.718Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.536Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* add suspicious execution paths here */\n  process.executable : (\n    \"?:\\\\PerfLogs\\\\*.exe\", \"?:\\\\Users\\\\Public\\\\*.exe\", \"?:\\\\Windows\\\\Tasks\\\\*.exe\",\n    \"?:\\\\Intel\\\\*.exe\", \"?:\\\\AMD\\\\Temp\\\\*.exe\", \"?:\\\\Windows\\\\AppReadiness\\\\*.exe\",\n    \"?:\\\\Windows\\\\ServiceState\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\IdentityCRL\\\\*.exe\",\n    \"?:\\\\Windows\\\\Branding\\\\*.exe\", \"?:\\\\Windows\\\\csc\\\\*.exe\", \"?:\\\\Windows\\\\DigitalLocker\\\\*.exe\",\n    \"?:\\\\Windows\\\\en-US\\\\*.exe\", \"?:\\\\Windows\\\\wlansvc\\\\*.exe\", \"?:\\\\Windows\\\\Prefetch\\\\*.exe\",\n    \"?:\\\\Windows\\\\Fonts\\\\*.exe\", \"?:\\\\Windows\\\\diagnostics\\\\*.exe\", \"?:\\\\Windows\\\\TAPI\\\\*.exe\",\n    \"?:\\\\Windows\\\\INF\\\\*.exe\", \"?:\\\\Windows\\\\System32\\\\Speech\\\\*.exe\", \"?:\\\\windows\\\\tracing\\\\*.exe\",\n    \"?:\\\\windows\\\\IME\\\\*.exe\", \"?:\\\\Windows\\\\Performance\\\\*.exe\", \"?:\\\\windows\\\\intel\\\\*.exe\",\n    \"?:\\\\windows\\\\ms\\\\*.exe\", \"?:\\\\Windows\\\\dot3svc\\\\*.exe\", \"?:\\\\Windows\\\\panther\\\\*.exe\",\n    \"?:\\\\Windows\\\\RemotePackages\\\\*.exe\", \"?:\\\\Windows\\\\OCR\\\\*.exe\", \"?:\\\\Windows\\\\appcompat\\\\*.exe\",\n    \"?:\\\\Windows\\\\apppatch\\\\*.exe\", \"?:\\\\Windows\\\\addins\\\\*.exe\", \"?:\\\\Windows\\\\Setup\\\\*.exe\",\n    \"?:\\\\Windows\\\\Help\\\\*.exe\", \"?:\\\\Windows\\\\SKB\\\\*.exe\", \"?:\\\\Windows\\\\Vss\\\\*.exe\",\n    \"?:\\\\Windows\\\\Web\\\\*.exe\", \"?:\\\\Windows\\\\servicing\\\\*.exe\", \"?:\\\\Windows\\\\CbsTemp\\\\*.exe\",\n    \"?:\\\\Windows\\\\Logs\\\\*.exe\", \"?:\\\\Windows\\\\WaaS\\\\*.exe\", \"?:\\\\Windows\\\\ShellExperiences\\\\*.exe\",\n    \"?:\\\\Windows\\\\ShellComponents\\\\*.exe\", \"?:\\\\Windows\\\\PLA\\\\*.exe\", \"?:\\\\Windows\\\\Migration\\\\*.exe\",\n    \"?:\\\\Windows\\\\debug\\\\*.exe\", \"?:\\\\Windows\\\\Cursors\\\\*.exe\", \"?:\\\\Windows\\\\Containers\\\\*.exe\",\n    \"?:\\\\Windows\\\\Boot\\\\*.exe\", \"?:\\\\Windows\\\\bcastdvr\\\\*.exe\", \"?:\\\\Windows\\\\assembly\\\\*.exe\",\n    \"?:\\\\Windows\\\\TextInput\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\SchCache\\\\*.exe\", \"?:\\\\Windows\\\\Resources\\\\*.exe\", \"?:\\\\Windows\\\\rescache\\\\*.exe\",\n    \"?:\\\\Windows\\\\Provisioning\\\\*.exe\", \"?:\\\\Windows\\\\PrintDialog\\\\*.exe\", \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.exe\",\n    \"?:\\\\Windows\\\\media\\\\*.exe\", \"?:\\\\Windows\\\\Globalization\\\\*.exe\", \"?:\\\\Windows\\\\L2Schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\LiveKernelReports\\\\*.exe\", \"?:\\\\Windows\\\\ModemLogs\\\\*.exe\",\n    \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.exe\"\n  ) and\n  \n  not process.name : (\n    \"SpeechUXWiz.exe\", \"SystemSettings.exe\", \"TrustedInstaller.exe\",\n    \"PrintDialog.exe\", \"MpSigStub.exe\", \"LMS.exe\", \"mpam-*.exe\"\n  ) and\n  not process.executable :\n            (\"?:\\\\Intel\\\\Wireless\\\\WUSetupLauncher.exe\",\n             \"?:\\\\Intel\\\\Wireless\\\\Setup.exe\",\n             \"?:\\\\Intel\\\\Move Mouse.exe\",\n             \"?:\\\\windows\\\\Panther\\\\DiagTrackRunner.exe\",\n             \"?:\\\\Windows\\\\servicing\\\\GC64\\\\tzupd.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\RemoteLite.exe\",\n             \"?:\\\\Users\\\\Public\\\\IBM\\\\ClientSolutions\\\\*.exe\",\n             \"?:\\\\Users\\\\Public\\\\Documents\\\\syspin.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\FileWatcher.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "AdFind Command Activity",
        "description": "This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequently leveraged by threat actors to perform post-exploitation Active Directory reconnaissance. The AdFind tool has been observed in Trickbot, Ryuk, Maze, and FIN6 campaigns. For Winlogbeat, this rule requires Sysmon.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AdFind Command Activity\n\n[AdFind](http://www.joeware.net/freetools/tools/adfind/) is a freely available command-line tool used to retrieve information from Active Directory (AD). Network discovery and enumeration tools like `AdFind` are useful to adversaries in the same ways they are effective for network administrators. This tool provides quick ability to scope AD person/computer objects and understand subnets and domain information. There are many [examples](https://thedfirreport.com/category/adfind/) of this tool being adopted by ransomware and criminal groups and used in compromises.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine the command line to determine what information was retrieved by the tool.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives as it is a legitimate tool used by network administrators.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- Malicious behavior with `AdFind` should be investigated as part of a step within an attack chain. It doesn't happen in isolation, so reviewing previous logs/activity from impacted machines can be very telling.\n\n### Related rules\n\n- Windows Network Enumeration - 7b8bfc26-81d2-435e-965c-d722ee397ef1\n- Enumeration of Administrator Accounts - 871ea072-1b71-4def-b016-6278b505138d\n- Enumeration Command Spawned via WMIPrvSE - 770e0c4d-b998-41e5-a62e-c7901fd7f470\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://www.joeware.net/freetools/tools/adfind/",
          "https://thedfirreport.com/2020/05/08/adfind-recon/",
          "https://www.fireeye.com/blog/threat-research/2020/05/tactics-techniques-procedures-associated-with-maze-ransomware-incidents.html",
          "https://www.cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware",
          "https://www.fireeye.com/blog/threat-research/2019/04/pick-six-intercepting-a-fin6-intrusion.html",
          "https://usa.visa.com/dam/VCOM/global/support-legal/documents/fin6-cybercrime-group-expands-threat-To-ecommerce-merchants.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/"
              },
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.002",
                    "name": "Domain Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/002/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b01897dd-7366-4454-814b-b49a0d490b2f",
        "rule_id": "eda499b8-a073-4e35-9733-22ec71f57f3a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.719Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.441Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"AdFind*.exe\" or ?process.pe.original_file_name == \"AdFind.exe\") and\n  process.args : (\"objectcategory=computer\", \"(objectcategory=computer)\",\n                  \"objectcategory=person\", \"(objectcategory=person)\",\n                  \"objectcategory=subnet\", \"(objectcategory=subnet)\",\n                  \"objectcategory=group\", \"(objectcategory=group)\",\n                  \"objectcategory=organizationalunit\", \"(objectcategory=organizationalunit)\",\n                  \"objectcategory=attributeschema\", \"(objectcategory=attributeschema)\",\n                  \"domainlist\", \"dcmodes\", \"adinfo\", \"dclist\", \"computers_pwnotreqd\", \"trustdmp\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Linux User Account Creation",
        "description": "Identifies attempts to create new users. Attackers may add new users to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux User Account Creation\n\nThe `useradd` and `adduser` commands are used to create new user accounts in Linux-based operating systems.\n\nAttackers may create new accounts (both local and domain) to maintain access to victim systems.\n\nThis rule identifies the usage of `useradd` and `adduser` to create new accounts.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the user was created succesfully.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Identify if the account was added to privileged groups or assigned special privileges after creation.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Account creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the created account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete Setup and Run Filebeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the Filebeat System Module to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b9133577-138a-432a-887a-fd11875d9f6e",
        "rule_id": "edfd5ca9-9d6c-44d9-b615-1e56b920219c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.723Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.686Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where host.os.type == \"linux\" and (event.type == \"user\" and event.type == \"creation\") and\nprocess.name in (\"useradd\", \"adduser\") and user.name != null",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "ImageLoad via Windows Update Auto Update Client",
        "description": "Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is used as a defense evasion technique to blend-in malicious activity with legitimate Windows software.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating ImageLoad via Windows Update Auto Update Client\n\nThe Windows Update Auto Update Client (wuauclt.exe) is the component responsible for managing system updates. However, adversaries may abuse this process to load a malicious DLL and execute malicious code while blending into a legitimate system mechanism. \n\nThis rule identifies potential abuse for code execution by monitoring for specific process arguments (\"/RunHandlerComServer\" and \"/UpdateDeploymentProvider\") and common writable paths where the target DLL can be placed (e.g., \"C:\\Users\\*.dll\", \"C:\\ProgramData\\*.dll\", etc.).\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line and identify the DLL location.\n- Examine whether the DLL is signed.\n- Retrieve the DLL and determine if it is malicious:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate the behavior of child processes, such as network connections, registry or file modifications, and any spawned processes.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://dtm.uk/wuauclt/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1b4ae74d-8c02-48c8-baae-4faf26cd20b6",
        "rule_id": "edf8ee23-5ea7-4123-ba19-56b41e424ae3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.721Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.447Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name == \"wuauclt.exe\" or process.name : \"wuauclt.exe\") and\n   /* necessary windows update client args to load a dll */\n   process.args : \"/RunHandlerComServer\" and process.args : \"/UpdateDeploymentProvider\" and\n   /* common paths writeable by a standard user where the target DLL can be placed */\n   process.args : (\"C:\\\\Users\\\\*.dll\", \"C:\\\\ProgramData\\\\*.dll\", \"C:\\\\Windows\\\\Temp\\\\*.dll\", \"C:\\\\Windows\\\\Tasks\\\\*.dll\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Print Spooler Child Process",
        "description": "Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege escalation vulnerabilities related to the Printing Service on Windows.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Install or update of a legitimate printing driver. Verify the printer driver file metadata such as manufacturer and signature information."
        ],
        "references": [
          "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "688ac34a-f296-4ad0-9ab9-435a497b3d97",
        "rule_id": "ee5300a7-7e31-4a72-a258-250abb8b3aa1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.725Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.543Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"spoolsv.exe\" and process.command_line != null and \n (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n\n /* exclusions for FP control below */\n not process.name : (\"splwow64.exe\", \"PDFCreator.exe\", \"acrodist.exe\", \"spoolsv.exe\", \"msiexec.exe\", \"route.exe\", \"WerFault.exe\") and\n not process.command_line : \"*\\\\WINDOWS\\\\system32\\\\spool\\\\DRIVERS*\" and\n not (process.name : \"net.exe\" and process.command_line : (\"*stop*\", \"*start*\")) and\n not (process.name : (\"cmd.exe\", \"powershell.exe\") and process.command_line : (\"*.spl*\", \"*\\\\program files*\", \"*route add*\")) and\n not (process.name : \"netsh.exe\" and process.command_line : (\"*add portopening*\", \"*rule name*\")) and\n not (process.name : \"regsvr32.exe\" and process.command_line : \"*PrintConfig.dll*\") and\n not process.executable : (\n    \"?:\\\\Program Files (x86)\\\\CutePDF Writer\\\\CPWriter2.exe\",\n    \"?:\\\\Program Files (x86)\\\\GPLGS\\\\gswin32c.exe\"\n )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privacy Control Bypass via TCCDB Modification",
        "description": "Identifies the use of sqlite3 to directly modify the Transparency, Consent, and Control (TCC) SQLite database. This may indicate an attempt to bypass macOS privacy controls, including access to sensitive resources like the system camera, microphone, address book, and calendar.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://applehelpwriter.com/2016/08/29/discovering-how-dropbox-hacks-your-mac/",
          "https://github.com/bp88/JSS-Scripts/blob/master/TCC.db%20Modifier.sh",
          "https://medium.com/@mattshockl/cve-2020-9934-bypassing-the-os-x-transparency-consent-and-control-tcc-framework-for-4e14806f1de8"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b078384f-02d6-4fc8-9e11-2b287fd5c2bc",
        "rule_id": "eea82229-b002-470e-a9e1-00be38b14d32",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.726Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.546Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name : \"sqlite*\" and\n process.args : \"/*/Application Support/com.apple.TCC/TCC.db\" and\n not process.parent.executable : \"/Library/Bitdefender/AVP/product/bin/*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "BPF filter applied using TC",
        "description": "Detects when the tc (transmission control) binary is utilized to set a BPF (Berkeley Packet Filter) on a network interface. Tc is used to configure Traffic Control in the Linux kernel. It can shape, schedule, police and drop traffic. A threat actor can utilize tc to set a bpf filter on an interface for the purpose of manipulating the incoming traffic. This technique is not at all common and should indicate abnormal, suspicious or malicious activity.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Threat: TripleCross",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/h3xduck/TripleCross/blob/master/src/helpers/deployer.sh",
          "https://man7.org/linux/man-pages/man8/tc.8.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b43cc470-2374-4020-ac08-94f3280323e5",
        "rule_id": "ef04a476-07ec-48fc-8f3d-5e1742de76d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.728Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.450Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type != \"end\" and process.executable == \"/usr/sbin/tc\" and\nprocess.args == \"filter\" and process.args == \"add\" and process.args == \"bpf\" and\nnot process.parent.executable == \"/usr/sbin/libvirtd\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Credential Dumping via Proc Filesystem",
        "description": "Identifies the execution of the mimipenguin exploit script which is linux adaptation of Windows tool mimikatz. Mimipenguin exploit script is used to dump clear text passwords from a currently logged-in user. The tool exploits a known vulnerability CVE-2018-20781. Malicious actors can exploit the cleartext credentials in memory by dumping the process and extracting lines that have a high probability of containing cleartext passwords.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/huntergregal/mimipenguin",
          "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-20781"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.007",
                    "name": "Proc Filesystem",
                    "reference": "https://attack.mitre.org/techniques/T1003/007/"
                  }
                ]
              },
              {
                "id": "T1212",
                "name": "Exploitation for Credential Access",
                "reference": "https://attack.mitre.org/techniques/T1212/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b7138952-6411-48a8-9c52-62faae77673a",
        "rule_id": "ef100a2e-ecd4-4f72-9d1e-2f779ff3c311",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.730Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.454Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.name with maxspan=1m\n  [process where host.os.type == \"linux\" and process.name == \"ps\" and event.action == \"exec\"\n   and process.args in (\"-eo\", \"pid\", \"command\")]\n  [process where host.os.type == \"linux\" and process.name == \"strings\" and event.action == \"exec\"\n   and process.args : \"/tmp/*\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious HTML File Creation",
        "description": "Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggle data and files past content filters by hiding malicious payloads inside of seemingly benign HTML files.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "This rule may have a low to medium performance impact due variety of file paths potentially matching each EQL sequence.",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/",
                "subtechnique": [
                  {
                    "id": "T1027.006",
                    "name": "HTML Smuggling",
                    "reference": "https://attack.mitre.org/techniques/T1027/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.entropy",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.size",
            "type": "long",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4362c39c-094d-41dd-961c-9b218cfd4268",
        "rule_id": "f0493cb4-9b15-43a9-9359-68c23a7f2cf3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.737Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.552Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by user.id with maxspan=2m\n\n [file where host.os.type == \"windows\" and event.action in (\"creation\", \"rename\") and\n\n  /* Check for HTML files with high entropy and size */\n  file.extension : (\"htm\", \"html\") and ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size >= 1000000) and\n\n  /* Check for file paths in common download and temporary directories */\n  file.path : (\n    \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n    \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\")]\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  (\n   /* Check for browser processes opening HTML files with single argument */\n   (process.name in (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\")\n    and process.args == \"--single-argument\") or\n\n   /* Optionally, check for browser processes opening HTML files with two arguments */\n   (process.name == \"iexplore.exe\" and process.args_count == 2) or\n\n   /* Optionally, check for browser processes opening HTML files with URL argument */\n   (process.name in (\"firefox.exe\", \"waterfox.exe\") and process.args == \"-url\")\n  )\n  /* Check for file paths in common download and temporary directories targeted in the process arguments */\n  and process.args : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*.htm*\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Quarantine Attrib Removed by Unsigned or Untrusted Process",
        "description": "Detects deletion of the quarantine attribute by an unusual process (xattr). In macOS, when applications or programs are downloaded from the internet, there is a quarantine flag set on the file. This attribute is read by Apple's Gatekeeper defense program at execution time. An adversary may disable this attribute to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://nixhacker.com/security-protection-in-macos-1/",
          "https://eclecticlight.co/2020/10/29/quarantine-and-the-quarantine-flag/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b946caa7-bc77-46ef-b4b7-93b4f092af99",
        "rule_id": "f0b48bbc-549e-4bcf-8ee0-a7a72586c6a7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.739Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.562Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where event.action == \"extended_attributes_delete\" and host.os.type == \"macos\" and process.executable != null and\n(process.code_signature.trusted == false or process.code_signature.exists == false) and not\nprocess.executable : (\"/usr/bin/xattr\", \n                      \"/System/*\", \n                      \"/private/tmp/KSInstallAction.*/*/Install Google Software Update.app/Contents/Helpers/ksinstall\",\n                      \"/Applications/CEWE Fotoschau.app/Contents/MacOS/FotoPlus\",\n                      \"/Applications/.com.bomgar.scc.*/Remote Support Customer Client.app/Contents/MacOS/sdcust\") and not\nfile.path : \"/private/var/folders/*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Remote Code Execution via Web Server",
        "description": "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access. Attackers may exploit a vulnerability in a web application to execute commands via a web server, or place a backdoor file that can be abused to gain code execution as a mechanism for persistence.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Remote Code Execution via Web Server\n\nAdversaries may backdoor web servers with web shells to establish persistent access to systems. A web shell is a malicious script, often embedded into a compromised web server, that grants an attacker remote access and control over the server. This enables the execution of arbitrary commands, data exfiltration, and further exploitation of the target network.\n\nThis rule detects a web server process spawning script and command line interface programs, potentially indicating attackers executing commands using the web shell.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate abnormal behaviors by the subject process such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential reverse shells or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Investigate the process information for malicious or uncommon processes/process trees.\n    - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n  - Investigate the process tree spawned from the user that is used to run the web application service. A user that is running a web application should not spawn other child processes.\n    - !{osquery{\"label\":\"Osquery - Retrieve Process Info for Webapp User\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes WHERE uid = {{process.user.id}}\"}}\n- Examine the command line to determine which commands or scripts were executed.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n        - Check if the domain is newly registered or unexpected.\n        - Check the reputation of the domain or IP address.\n      - File access, modification, and creation activities.\n      - Cron jobs, services and other persistence mechanisms.\n        - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Initial Access",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Network monitoring or management products may have a web server component that runs shell commands as part of normal behavior."
        ],
        "references": [
          "https://pentestlab.blog/tag/web-shell/",
          "https://www.elastic.co/security-labs/elastic-response-to-the-the-spring4shell-vulnerability-cve-2022-22965"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.003",
                    "name": "Web Shell",
                    "reference": "https://attack.mitre.org/techniques/T1505/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7ccb3c69-d611-4820-b704-69b9c3367b19",
        "rule_id": "f16fca20-4d6c-43f9-aec1-20b6de3b0aeb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.741Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.203Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\") and process.parent.executable : (\n  \"/usr/sbin/nginx\", \"/usr/local/sbin/nginx\",\n  \"/usr/sbin/apache\", \"/usr/local/sbin/apache\",\n  \"/usr/sbin/apache2\", \"/usr/local/sbin/apache2\",\n  \"/usr/sbin/php*\", \"/usr/local/sbin/php*\",\n  \"/usr/sbin/lighttpd\", \"/usr/local/sbin/lighttpd\",\n  \"/usr/sbin/hiawatha\", \"/usr/local/sbin/hiawatha\",\n  \"/usr/local/bin/caddy\", \n  \"/usr/local/lsws/bin/lswsctrl\",\n  \"*/bin/catalina.sh\"\n) and\nprocess.name : (\n  \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\",\n  \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and process.args : (\n  \"whoami\", \"id\", \"uname\", \"cat\", \"hostname\", \"ip\", \"curl\", \"wget\", \"pwd\", \"ls\", \"cd\", \"python*\", \"php*\", \"perl\",\n  \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and not process.name == \"phpquery\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Hidden Login Item via Apple Script",
        "description": "Identifies the execution of osascript to create a hidden login item. This may indicate an attempt to persist a malicious program while concealing its presence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.002",
                    "name": "AppleScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1647",
                "name": "Plist File Modification",
                "reference": "https://attack.mitre.org/techniques/T1647/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eced8c75-224e-4917-85de-811a1f01df3c",
        "rule_id": "f24bcae1-8980-4b30-b5dd-f851b055c9e7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.742Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.566Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name : \"osascript\" and\n process.command_line : \"osascript*login item*hidden:true*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Whoami Process Activity",
        "description": "Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who is currently logged on to the local system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Whoami Process Activity\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `whoami` utility. Attackers commonly use this utility to measure their current privileges, discover the current user, determine if a privilege escalation was successful, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Account Discovery Command via SYSTEM Account - 2856446a-34e6-435b-9fb5-f8f040bfa7ed\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some normal use of this program, at varying levels of frequency, may originate from scripts, automation tools and frameworks. Usage by non-engineers and ordinary users is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "fd520cfc-529e-4d4a-81bb-7cb76dba07ac",
        "rule_id": "ef862985-3f13-4262-a686-5f357bbb9bc2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.732Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.549Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"whoami.exe\" and\n(\n  (\n    /* scoped for whoami execution under system privileges */\n    (\n      user.domain : (\"NT *\", \"* NT\", \"IIS APPPOOL\") and\n      user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\", \"S-1-5-82-*\") and\n      not ?winlog.event_data.SubjectUserName : \"*$\"\n    ) and\n    not (\n      process.parent.name : \"cmd.exe\" and\n      process.parent.args : (\n          \"chcp 437>nul 2>&1 & C:\\\\WINDOWS\\\\System32\\\\whoami.exe  /groups\",\n          \"chcp 437>nul 2>&1 & %systemroot%\\\\system32\\\\whoami /user\",\n          \"C:\\\\WINDOWS\\\\System32\\\\whoami.exe /groups\",\n          \"*WINDOWS\\\\system32\\\\config\\\\systemprofile*\"\n      )\n    ) and\n    not (process.parent.executable : \"C:\\\\Windows\\\\system32\\\\inetsrv\\\\appcmd.exe\" and process.parent.args : \"LIST\") and\n    not process.parent.executable : (\n        \"C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\MonitoringHost.exe\",\n        \"C:\\\\Program Files\\\\Cohesity\\\\cohesity_windows_agent_service.exe\"\n    )\n  ) or\n  process.parent.name : (\"wsmprovhost.exe\", \"w3wp.exe\", \"wmiprvse.exe\", \"rundll32.exe\", \"regsvr32.exe\")\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "logs-system.*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Potential OpenSSH Backdoor Logging Activity",
        "description": "Identifies a Secure Shell (SSH) client or server process creating or writing to a known SSH backdoor log file. Adversaries may modify SSH related binaries for persistence or credential access via patching sensitive functions to enable unauthorized access or to log SSH credentials for exfiltration.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Updates to approved and trusted SSH executables can trigger this rule."
        ],
        "references": [
          "https://github.com/eset/malware-ioc/tree/master/sshdoor",
          "https://www.welivesecurity.com/wp-content/uploads/2021/01/ESET_Kobalos.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "08cc65e8-1737-49dd-8a16-f707b47c95b6",
        "rule_id": "f28e2be4-6eca-4349-bdd9-381573730c22",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.744Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.207Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"change\" and process.executable : (\"/usr/sbin/sshd\", \"/usr/bin/ssh\") and\n  (\n    (file.name : (\".*\", \"~*\", \"*~\") and not file.name : (\".cache\", \".viminfo\", \".bash_history\", \".google_authenticator\",\n      \".jelenv\", \".csvignore\", \".rtreport\")) or\n    file.extension : (\"in\", \"out\", \"ini\", \"h\", \"gz\", \"so\", \"sock\", \"sync\", \"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\") or\n    file.path :\n    (\n      \"/private/etc/*--\",\n      \"/usr/share/*\",\n      \"/usr/include/*\",\n      \"/usr/local/include/*\",\n      \"/private/tmp/*\",\n      \"/private/var/tmp/*\",\n      \"/usr/tmp/*\",\n      \"/usr/share/man/*\",\n      \"/usr/local/share/*\",\n      \"/usr/lib/*.so.*\",\n      \"/private/etc/ssh/.sshd_auth\",\n      \"/usr/bin/ssd\",\n      \"/private/var/opt/power\",\n      \"/private/etc/ssh/ssh_known_hosts\",\n      \"/private/var/html/lol\",\n      \"/private/var/log/utmp\",\n      \"/private/var/lib\",\n      \"/var/run/sshd/sshd.pid\",\n      \"/var/run/nscd/ns.pid\",\n      \"/var/run/udev/ud.pid\",\n      \"/var/run/udevd.pid\"\n    )\n  )",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "LSASS Memory Dump Creation",
        "description": "Identifies the creation of a Local Security Authority Subsystem Service (lsass.exe) default memory dump. This may indicate a credential access attempt via trusted system utilities such as Task Manager (taskmgr.exe) and SQL Dumper (sqldumper.exe) or known pentesting tools such as Dumpert and AndrewSpecial.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "4d4c0b59-ea83-483f-b8c1-8c360ee53c5c",
        "timeline_title": "Comprehensive File Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating LSASS Memory Dump Creation\n\nLocal Security Authority Server Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.\n\nThis rule looks for the creation of memory dump files with file names compatible with credential dumping tools or that start with `lsass`.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the process responsible for creating the dump file.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/outflanknl/Dumpert",
          "https://github.com/hoangprod/AndrewSpecial"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eaa9b054-747a-4ecd-9b95-b2e7f9c2c695",
        "rule_id": "f2f46686-6f3c-4724-bd7d-24e31c70f98f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.746Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.457Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n  file.name : (\"lsass*.dmp\", \"dumpert.dmp\", \"Andrew.dmp\", \"SQLDmpr*.mdmp\", \"Coredump.dmp\") and\n\n  not (\n        process.executable : (\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\SqlDumper.exe\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server Reporting Services\\\\SSRS\\\\ReportServer\\\\bin\\\\SqlDumper.exe\",\n          \"?:\\\\Windows\\\\System32\\\\dllhost.exe\"\n        ) and\n        file.path : (\n          \"?:\\\\*\\\\Reporting Services\\\\Logfiles\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server Reporting Services\\\\SSRS\\\\Logfiles\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\ErrorDumps\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\MSSQL\\\\LOG\\\\SQLDmpr*.mdmp\"\n        )\n      ) and\n\n  not (\n        process.executable : (\n          \"?:\\\\Windows\\\\system32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n          ) and\n        file.path : (\n          \"?:\\\\Windows\\\\System32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\CrashDumps\\\\lsass.exe.*.dmp\",\n          \"?:\\\\Windows\\\\System32\\\\%LOCALAPPDATA%\\\\CrashDumps\\\\lsass.exe.*.dmp\"\n        )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel URL Indicator Match",
        "description": "This rule is triggered when a URL indicator from the Threat Intel Filebeat module or integrations has a match against an event that contains URL data, like DNS events, network logs, etc.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel URL Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when a URL indicator from the Threat Intel Filebeat module or a threat intelligence integration matches against an event that contains URL data, like DNS events, network logs, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the URL, which can be found in the `threat.indicator.matched.atomic` field:\n  - Identify the type of malicious activity related to the URL (phishing, malware, etc.).\n  - Check the reputation of the IP address in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Execute a WHOIS lookup to retrieve information about the domain registration and contacts to report abuse.\n  - If dealing with a phishing incident:\n    - Contact the user to gain more information around the delivery method, information sent, etc.\n    - Analyze whether the URL is trying to impersonate a legitimate address. Look for typosquatting, extra or unusual subdomains, or other anomalies that could lure the user.\n    - Investigate the phishing page to identify which information may have been sent to the attacker by the user.\n- Identify the process responsible for the connection, and investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the involved process executable and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- False positives might occur after large and publicly written campaigns if curious employees interact with attacker infrastructure.\n- Some feeds may include internal or known benign addresses by mistake (e.g., 8.8.8.8, google.com, 127.0.0.1, etc.). Make sure you understand how blocking a specific domain or address might impact the organization or normal system functioning.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Consider reporting the address for abuse using the provided contact information.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "url.full",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "d81cdb0d-bb9f-4277-b340-1d61586b6419",
        "rule_id": "f3e22c8b-ea47-45d1-b502-b57b6de950b3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.748Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.572Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "url.full:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and threat.indicator.url.full:* and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "url.full",
                "type": "mapping",
                "value": "threat.indicator.url.full"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "url.original",
                "type": "mapping",
                "value": "threat.indicator.url.original"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "packetbeat-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "Potential curl CVE-2023-38545 Exploitation",
        "description": "Detects potential exploitation of curl CVE-2023-38545 by monitoring for vulnerable command line arguments in conjunction with an unusual command line length. A flaw in curl version <= 8.3 makes curl vulnerable to a heap based buffer overflow during the SOCKS5 proxy handshake. Upgrade to curl version >= 8.4 to patch this vulnerability. This exploit can be executed with and without the use of environment variables. For increased visibility, enable the collection of http_proxy, HTTPS_PROXY and ALL_PROXY environment variables based on the instructions provided in the setup guide of this rule.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://curl.se/docs/CVE-2023-38545.html",
          "https://daniel.haxx.se/blog/2023/10/11/curl-8-4-0/",
          "https://twitter.com/_JohnHammond/status/1711986412554531015"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nElastic Defend integration does not collect environment variable logging by default.\nIn order to capture this behavior, this rule requires a specific configuration option set within the advanced settings of the Elastic Defend integration.\n #### To set up environment variable capture for an Elastic Agent policy:\n- Go to Security  Manage  Policies.\n- Select an Elastic Agent policy.\n- Click Show advanced settings.\n- Scroll down or search for linux.advanced.capture_env_vars.\n- Enter the names of environment variables you want to capture, separated by commas.\n- For this rule the linux.advanced.capture_env_vars variable should be set to \"http_proxy,HTTPS_PROXY,ALL_PROXY\".\n- Click Save.\nAfter saving the integration change, the Elastic Agents running this policy will be updated and the rule will function properly.\nFor more information on capturing environment variables refer to the [helper guide](https://www.elastic.co/guide/en/security/current/environment-variable-capture.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.env_vars",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d526d908-aa58-4233-b72b-dc4e9595b07d",
        "rule_id": "f41296b4-9975-44d6-9486-514c6f635b2d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.750Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.706Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\" \nand (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or \n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n) and length(process.command_line) > 255 and not (\n  process.parent.name in (\"cf-agent\", \"agent-run\", \"agent-check\", \"rudder\", \"agent-inventory\", \"cf-execd\") or\n  process.args like \"/opt/rudder/*\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/rudder/*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Microsoft Office AddIns",
        "description": "Detects attempts to establish persistence on an endpoint by abusing Microsoft Office add-ins.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://labs.withsecure.com/publications/add-in-opportunities-for-office-persistence"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1137",
                "name": "Office Application Startup",
                "reference": "https://attack.mitre.org/techniques/T1137/",
                "subtechnique": [
                  {
                    "id": "T1137.006",
                    "name": "Add-ins",
                    "reference": "https://attack.mitre.org/techniques/T1137/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b4c44a56-fde9-4252-99c8-7c0ffa5d392e",
        "rule_id": "f44fa4b6-524c-4e87-8d9e-a32599e4fb7c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.751Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.460Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n file.extension : (\"wll\",\"xll\",\"ppa\",\"ppam\",\"xla\",\"xlam\") and\n file.path :\n    (\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Word\\\\Startup\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\AddIns\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Excel\\\\XLSTART\\\\*\"\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Sensitive Privilege SeEnableDelegationPrivilege assigned to a User",
        "description": "Identifies the assignment of the SeEnableDelegationPrivilege sensitive \"user right\" to a user. The SeEnableDelegationPrivilege \"user right\" enables computer and user accounts to be trusted for delegation. Attackers can abuse this right to compromise Active Directory accounts and elevate their privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Sensitive Privilege SeEnableDelegationPrivilege assigned to a User\n\nKerberos delegation is an Active Directory feature that allows user and computer accounts to impersonate other accounts, act on their behalf, and use their privileges. Delegation (constrained and unconstrained) can be configured for user and computer objects.\n\nEnabling unconstrained delegation for a computer causes the computer to store the ticket-granting ticket (TGT) in memory at any time an account connects to the computer, so it can be used by the computer for impersonation when needed. Risk is heightened if an attacker compromises computers with unconstrained delegation enabled, as they could extract TGTs from memory and then replay them to move laterally on the domain. If the attacker coerces a privileged user to connect to the server, or if the user does so routinely, the account will be compromised and the attacker will be able to pass-the-ticket to privileged assets.\n\nSeEnableDelegationPrivilege is a user right that is controlled within the Local Security Policy of a domain controller and is managed through Group Policy. This setting is named **Enable computer and user accounts to be trusted for delegation**.\n\nIt is critical to control the assignment of this privilege. A user with this privilege and write access to a computer can control delegation settings, perform the attacks described above, and harvest TGTs from any user that connects to the system.\n\n#### Possible investigation steps\n\n- Investigate how the privilege was assigned to the user and who assigned it.\n- Investigate other potentially malicious activity that was performed by the user that assigned the privileges using the `user.id` and `winlog.activity_id` fields as a filter during the past 48 hours.\n- Investigate other alerts associated with the users/host during the past 48 hours.\n\n### False positive analysis\n\n- The SeEnableDelegationPrivilege privilege should not be assigned to users. If this rule is triggered in your environment legitimately, the security team should notify the administrators about the risks of using it.\n\n### Related rules\n\n- KRBTGT Delegation Backdoor - e052c845-48d0-4f46-8a13-7d0aba05df82\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Remove the privilege from the account.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.harmj0y.net/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_alert_active_directory_user_control.yml",
          "https://twitter.com/_nwodtuhs/status/1454049485080907776",
          "https://www.thehacker.recipes/ad/movement/kerberos/delegations",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0105_windows_audit_authorization_policy_change.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Authorization Policy Change' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policy Configuration >\nAudit Policies >\nPolicy Change >\nAudit Authorization Policy Change (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.PrivilegeList",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9bc36090-8d9a-4301-a671-de83aaad47d5",
        "rule_id": "f494c678-3c33-43aa-b169-bb3d5198c41d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.753Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.463Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:\"Authorization Policy Change\" and event.code:4704 and\n  winlog.event_data.PrivilegeList:\"SeEnableDelegationPrivilege\"",
        "language": "kuery"
      },
      {
        "name": "Windows Script Executing PowerShell",
        "description": "Identifies a PowerShell process launched by either cscript.exe or wscript.exe. Observing Windows scripting processes executing a PowerShell script, may be indicative of malicious activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Script Executing PowerShell\n\nThe Windows Script Host (WSH) is an Windows automation technology, which is ideal for non-interactive scripting needs, such as logon scripting, administrative scripting, and machine automation.\n\nAttackers commonly use WSH scripts as their initial access method, acting like droppers for second stage payloads, but can also use them to download tools and utilities needed to accomplish their goals.\n\nThis rule looks for the spawn of the `powershell.exe` process with `cscript.exe` or `wscript.exe` as its parent process.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate commands executed by the spawned PowerShell process.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Determine how the script file was delivered (email attachment, dropped by other processes, etc.).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- The usage of these script engines by regular users is unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/operation-bleeding-bear"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7eb0b07e-1fe9-4faf-ac1e-8d783bbae2b9",
        "rule_id": "f545ff26-3c94-4fd0-bd33-3c7f95a3a0fc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.757Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.466Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"cscript.exe\", \"wscript.exe\") and process.name : \"powershell.exe\" and\n  not (\n    process.parent.name : \"wscript.exe\" and\n    process.parent.args : \"?:\\\\ProgramData\\\\intune-drive-mapping-generator\\\\IntuneDriveMapping-VBSHelper.vbs\" and\n    process.parent.args : \"?:\\\\ProgramData\\\\intune-drive-mapping-generator\\\\DriveMapping.ps1\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Data Encryption via OpenSSL Utility",
        "description": "Identifies when the openssl command-line utility is used to encrypt multiple files on a host within a short time window. Adversaries may encrypt data on a single or multiple systems in order to disrupt the availability of their target's data and may attempt to hold the organization's data to ransom for the purposes of extortion.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/2017/06/30/telebots-back-supply-chain-attacks-against-ukraine/",
          "https://www.trendmicro.com/en_us/research/21/f/bash-ransomware-darkradiation-targets-red-hat--and-debian-based-linux-distributions.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e152e18b-7850-404b-9f15-964348c42c2b",
        "rule_id": "f530ca17-153b-4a7a-8cd3-98dd4b4ddf73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.755Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.576Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.name, process.parent.entity_id with maxspan=5s\n  [ process where host.os.type == \"linux\" and event.action == \"exec\" and \n    process.name == \"openssl\" and process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl*\", \"php*\", \"python*\", \"xargs\") and\n    process.args == \"-in\" and process.args == \"-out\" and\n    process.args in (\"-k\", \"-K\", \"-kfile\", \"-pass\", \"-iv\", \"-md\") and\n    /* excluding base64 encoding options and including encryption password or key params */\n    not process.args in (\"-d\", \"-a\", \"-A\", \"-base64\", \"-none\", \"-nosalt\") ] with runs=10",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Setcap setuid/setgid Capability Set",
        "description": "This rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap. Setuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group. Threat actors can exploit these attributes to achieve persistence by creating malicious binaries, allowing them to maintain control over a compromised system with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Setcap setuid/setgid Capability Set\n\nSetuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group.\n\nThreat actors can exploit these attributes to achieve persistence by creating malicious binaries, allowing them to maintain control over a compromised system with elevated permissions.\n\nThis rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the file that was targeted by the addition of the setuid/setgid capability through OSQuery.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "34953975-93a9-4817-93d0-433274328767",
        "rule_id": "f5c005d3-4e17-48b0-9cd7-444d48857f97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.758Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:24.906Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"setcap\" and process.args : \"cap_set?id+ep\" and not (\n  process.parent.name in (\"jem\", \"vzctl\") or\n  process.args like \"/usr/bin/new?idmap\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Masquerading Space After Filename",
        "description": "This rules identifies a process created from an executable with a space appended to the end of the filename. This may indicate an attempt to masquerade a malicious file as benign to gain user execution. When a space is added to the end of certain files, the OS will execute the file according to it's true filetype instead of it's extension. Adversaries can hide a program's true filetype by changing the extension of the file. They can then add a space to the end of the name so that the OS automatically executes the file when it's double-clicked.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.picussecurity.com/resource/blog/picus-10-critical-mitre-attck-techniques-t1036-masquerading"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.006",
                    "name": "Space after Filename",
                    "reference": "https://attack.mitre.org/techniques/T1036/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b17cf869-f6f2-4be5-a919-a83fe13dfafd",
        "rule_id": "f5fb4598-4f10-11ed-bdc3-0242ac120002",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.760Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.579Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type:(\"linux\",\"macos\") and event.type == \"start\" and\nprocess.executable regex~ \"\"\"/[a-z0-9\\s_\\-\\\\./]+\\s\"\"\" and not (\n  process.name in (\"ls\", \"find\", \"grep\", \"xkbcomp\") or\n  process.executable like (\"/opt/nessus_agent/*\", \"/opt/gitlab/sv/gitlab-exporter/*\", \"/tmp/ansible-admin/*\") or\n  process.parent.args in (\n    \"./check_rubrik\", \"/usr/bin/check_mk_agent\", \"/etc/rubrik/start_stop_bootstrap.sh\", \"/etc/rubrik/start_stop_agent.sh\"\n  )\n)",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Creation or Modification of Domain Backup DPAPI private key",
        "description": "Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API (DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDomain DPAPI Backup keys are stored on domain controllers and can be dumped remotely with tools such as Mimikatz. The resulting .pvk private key can be used to decrypt ANY domain user masterkeys, which then can be used to decrypt any secrets protected by those keys.\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.dsinternals.com/en/retrieving-dpapi-backup-keys-from-active-directory/",
          "https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ef6721b9-eb96-433b-b527-750ec02e21cb",
        "rule_id": "b83a7e96-2eb3-4edf-8346-427b6858d3bd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.762Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.486Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Chkconfig Service Add",
        "description": "Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize this technique to maintain persistence on a system. When a new service is added, chkconfig ensures that the service has either a start or a kill entry in every runlevel and when the system is rebooted the service file added will run providing long-term persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Chkconfig Service Add\nService files are configuration files in Linux systems used to define and manage system services. The `Chkconfig` binary can be used to manually add, delete or modify a service. \n\nMalicious actors can leverage services to achieve persistence by creating or modifying service files to execute malicious commands or payloads during system startup. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.\n\nThis rule monitors the usage of the `chkconfig` binary to manually add a service for management by `chkconfig`, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the service that was created or modified.\n- Investigate the currently enabled system services through the following commands `sudo chkconfig --list | grep on` and `sudo systemctl list-unit-files`.\n- Investigate the status of potentially suspicious services through the `chkconfig --list service_name` command. \n- Search for the `rc.d` or `init.d` service files that were created or modified, and analyze their contents.\n- Investigate whether any other files in any of the available `rc.d` or `init.d` directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/init.d/%' OR path LIKE '/etc/rc%.d/%')\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE (path LIKE '/etc/init.d/%' OR path LIKE\\n'/etc/rc%.d/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate syslog through the `sudo cat /var/log/syslog | grep 'LSB'` command to find traces of the LSB header of the script (if present). If syslog is being ingested into Elasticsearch, the same can be accomplished through Kibana.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions  preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses the `chkconfig` binary for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- New Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- New Systemd Service Created by Previously Unknown Process - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Lightning Framework",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/research/lightning-framework-new-linux-threat/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5c1c5221-6003-43c4-90ae-c5af89c43796",
        "rule_id": "b910f25a-2d44-47f2-a873-aabdc0d355e6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.765Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.267Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n( \n  (process.executable : \"/usr/sbin/chkconfig\" and process.args : \"--add\") or\n  (process.args : \"*chkconfig\" and process.args : \"--add\")\n) and not (\n  process.parent.name in (\"rpm\", \"qualys-scan-util\", \"qualys-cloud-agent\", \"update-alternatives\") or\n  process.parent.args : (\"/var/tmp/rpm*\", \"/var/lib/waagent/*\") or\n  process.args in (\"jexec\", \"sapinit\", \"httpd\", \"dbora\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass Attempt with IEditionUpgradeManager Elevated COM Interface",
        "description": "Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue Windows ClipUp program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/hfiref0x/UACME"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fae6a29d-5846-47ca-b3a8-2d02d82581d6",
        "rule_id": "b90cdde7-7e0d-4359-8bf0-2c112ce2008a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.764Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.391Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"Clipup.exe\" and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\ClipUp.exe\" and process.parent.name : \"dllhost.exe\" and\n  /* CLSID of the Elevated COM Interface IEditionUpgradeManager */\n  process.parent.args : \"/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Hidden Files and Directories via CommandLine",
        "description": "Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion. This rule looks for hidden files or folders in common writable directories.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain tools may create hidden temporary files or directories upon installation or as part of their normal behavior. These events can be filtered by the process arguments, username, or process name values."
        ],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3224bb99-4b1a-4983-9cac-ad0ccc260b5b",
        "rule_id": "b9666521-4742-49ce-9ddc-b8e84c35acae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.767Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.270Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.working_directory in (\"/tmp\", \"/var/tmp\", \"/dev/shm\") and\nprocess.args regex~ \"\"\"\\.[a-z0-9_\\-][a-z0-9_\\-\\.]{1,254}\"\"\" and\nnot process.name in (\n  \"ls\", \"find\", \"grep\", \"git\", \"jq\", \"basename\", \"check_snmp\", \"snmpget\", \"snmpwalk\", \"cc1plus\", \"snap\",\n  \"command-not-found\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "SolarWinds Process Disabling Services via Registry",
        "description": "Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse this technique to manipulate relevant security services.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Initial Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cd180560-3691-4718-9742-64ebc0127bf2",
        "rule_id": "b9960fef-82c6-4816-befa-44745030e917",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.769Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.394Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Start\" and\n  process.name : (\n      \"SolarWinds.BusinessLayerHost*.exe\",\n      \"ConfigurationWizard*.exe\",\n      \"NetflowDatabaseMaintenance*.exe\",\n      \"NetFlowService*.exe\",\n      \"SolarWinds.Administration*.exe\",\n      \"SolarWinds.Collector.Service*.exe\",\n      \"SolarwindsDiagnostics*.exe\"\n  ) and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\"\n  ) and\n  registry.data.strings : (\"4\", \"0x00000004\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Image Load (taskschd.dll) from MS Office",
        "description": "Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique can be used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary (schtasks.exe) used to manage scheduled tasks.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Image Load (taskschd.dll) from MS Office\n\nMicrosoft Office, a widely used suite of productivity applications, is frequently targeted by attackers due to its popularity in corporate environments. These attackers exploit its extensive capabilities, like macro scripts in Word and Excel, to gain initial access to systems. They often use Office documents as delivery mechanisms for malware or phishing attempts, taking advantage of their trusted status in professional settings.\n\n`taskschd.dll` provides Command Object Model (COM) interfaces for the Windows Task Scheduler service, allowing developers to programmatically manage scheduled tasks.\n\nThis rule looks for an MS Office process loading `taskschd.dll`, which may indicate an adversary abusing COM to configure a scheduled task. This can happen as part of a phishing attack, when a malicious office document registers the scheduled task to download the malware \"stage 2\" or to establish persistent access.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Analyze the host's scheduled tasks and explore the related Windows events to determine if tasks were created or deleted (Event IDs 4698 and 4699).\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Examine the files downloaded during the past 24 hours.\n  - Identify files that are related or can be executed in MS Office.\n  - Identify and analyze macros that these documents contain.\n    - Identify suspicious traits in the office macros, such as encoded or encrypted sections.\n- Retrieve the suspicious files identified in the previous step and determine if they are malicious:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Related Rules\n\n- Suspicious WMI Image Load from MS Office - 891cb88e-441a-4c3e-be2d-120d99fe7b0d\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16",
          "https://www.clearskysec.com/wp-content/uploads/2020/10/Operation-Quicksand.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4e4a5152-921e-4f46-9966-d244925e962c",
        "rule_id": "baa5d22c-5e1c-4f33-bfc9-efa73bb53022",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.771Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.397Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Keylogging Script",
        "description": "Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers use this technique to capture user input, looking for credentials and/or other valuable data.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Keylogging Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to capture user keystrokes with the goal of stealing credentials and other valuable information as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to capture keystrokes, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-Keystrokes.ps1",
          "https://github.com/MojtabaTajik/FunnyKeylogger/blob/master/FunnyLogger.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1056",
                "name": "Input Capture",
                "reference": "https://attack.mitre.org/techniques/T1056/",
                "subtechnique": [
                  {
                    "id": "T1056.001",
                    "name": "Keylogging",
                    "reference": "https://attack.mitre.org/techniques/T1056/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "da4e42eb-4d5a-4460-9b9d-37884a8c375f",
        "rule_id": "bd2c86a0-8b61-4457-ab38-96943984e889",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.772Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:08.194Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or \"Get-Keystrokes\") or\n   powershell.file.script_block_text : (\n        (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and\n        (GetForegroundWindow or GetWindowTextA or GetWindowTextW or \"WM_KEYBOARD_LL\" or \"WH_MOUSE_LL\")\n   )\n   ) and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Pspy Process Monitoring Detected",
        "description": "This rule leverages auditd to monitor for processes scanning different processes within the /proc directory using the openat syscall. This is a strong indication for the usage of the pspy utility. Attackers may leverage the pspy process monitoring utility to monitor system processes without requiring root permissions, in order to find potential privilege escalation vectors.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/DominicBreuker/pspy"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Auditd Manager.\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Auditd Manager and select the integration to see more details about it.\n- Click Add Auditd Manager.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed auditd manager to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click Save and Continue.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule the following additional audit rules are required to be added to the integration:\n  -- \"-w /proc/ -p r -k audit_proc\"\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a0",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.a2",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "010894b0-b90e-43a6-bfe2-d8015bf2eee7",
        "rule_id": "bdb04043-f0e3-4efa-bdee-7d9d13fa9edc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.774Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.505Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.pid, host.id with maxspan=5s\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"openat\" and file.path == \"/proc\" and\n   auditd.data.a0 : (\"ffffffffffffff9c\", \"ffffff9c\") and auditd.data.a2 : (\"80000\", \"88000\") and\n   not process.name == \"agentbeat\"\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privileged Escalation via SamAccountName Spoofing",
        "description": "Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to elevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a security vulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e",
          "https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing/",
          "https://github.com/cube0x0/noPac",
          "https://twitter.com/exploitph/status/1469157138928914432",
          "https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.NewTargetUserName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.OldTargetUserName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "631b0ecf-4949-42c8-a3fa-786c64358767",
        "rule_id": "bdcf646b-08d4-492c-870a-6c04e3700034",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:12.780Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.401Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"renamed-user-account\" and\n  /* machine account name renamed to user like account name */\n  winlog.event_data.OldTargetUserName : \"*$\" and not winlog.event_data.NewTargetUserName : \"*$\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious DLL Loaded for Persistence or Privilege Escalation",
        "description": "Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or one that can be loaded from a different location by a native Windows process. This may be abused to persist or elevate privileges via privileged file write vulnerabilities.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious DLL Loaded for Persistence or Privilege Escalation\n\nAttackers can execute malicious code by abusing missing modules that processes try to load, enabling them to escalate privileges or gain persistence. This rule identifies the loading of a non-Microsoft-signed DLL that is missing on a default Windows installation or one that can be loaded from a different location by a native Windows process.\n\n#### Possible investigation steps\n\n- Examine the DLL signature and identify the process that created it.\n  - Investigate any abnormal behaviors by the process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the DLL and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://itm4n.github.io/windows-dll-hijacking-clarified/",
          "http://remoteawesomethoughts.blogspot.com/2019/05/windows-10-task-schedulerservice.html",
          "https://googleprojectzero.blogspot.com/2018/04/windows-exploitation-tricks-exploiting.html",
          "https://shellz.club/2020/10/16/edgegdi-dll-for-persistence-and-lateral-movement.html",
          "https://windows-internals.com/faxing-your-way-to-system/",
          "http://waleedassar.blogspot.com/2013/01/wow64logdll.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "dll.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.hash.sha256",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ad5e68fe-4a57-49c1-a2cc-781312db6dee",
        "rule_id": "bfeaf89b-a2a7-48a3-817f-e41829dc61ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.684Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.273Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n(event.category : (\"driver\", \"library\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n(\n  /* compatible with Elastic Endpoint Library Events */\n  (\n    ?dll.name : (\n        \"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n        \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n        \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n        \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\"\n    )\n    and (\n      ?dll.code_signature.trusted != true or\n      ?dll.code_signature.exists != true or\n      (\n        dll.code_signature.trusted == true and\n          not dll.code_signature.subject_name : (\"Microsoft Windows\", \"Microsoft Corporation\", \"Microsoft Windows Publisher\")\n      )\n  ) or\n   /* oci.dll is too noisy due to unsigned Oracle related DLL loaded from random dirs */\n  (\n   (?dll.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and process.executable : \"?:\\\\Windows\\\\*.exe\" and \n    (?dll.code_signature.trusted != true or ?dll.code_signature.exists != true)) or \n    \n   (file.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and not file.code_signature.status == \"Valid\" and process.executable : \"?:\\\\Windows\\\\*.exe\")\n   ) or \n\n  /* compatible with Sysmon EventID 7 - Image Load */\n  (file.name : (\"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n               \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n               \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n               \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\") and \n   not file.hash.sha256 : \n            (\"6e837794fc282446906c36d681958f2f6212043fc117c716936920be166a700f\", \n             \"b14e4954e8cca060ffeb57f2458b6a3a39c7d2f27e94391cbcea5387652f21a4\", \n             \"c258d90acd006fa109dc6b748008edbb196d6168bc75ace0de0de54a4db46662\") and \n   not file.code_signature.status == \"Valid\")\n  ) and\n  not\n  (\n    ?dll.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    ) or\n    file.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    )\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Searching for Saved Credentials via VaultCmd",
        "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16",
          "https://web.archive.org/web/20201004080456/https://rastamouse.me/blog/rdp-jump-boxes/",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0db53896-d5c9-42b8-8fb1-297cfbb54136",
        "rule_id": "be8afaed-4bcd-4e0a-b5f9-5562003dde81",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.686Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.512Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name:\"vaultcmd.exe\" or process.name:\"vaultcmd.exe\") and\n  process.args:\"/list*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privacy Control Bypass via Localhost Secure Copy",
        "description": "Identifies use of the Secure Copy Protocol (SCP) to copy files locally by abusing the auto addition of the Secure Shell Daemon (sshd) to the authorized application list for Full Disk Access. This may indicate attempts to bypass macOS privacy controls to access sensitive files.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.trendmicro.com/en_us/research/20/h/xcsset-mac-malware--infects-xcode-projects--uses-0-days.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e22f674c-826c-4c29-a2ba-807a22ff23df",
        "rule_id": "c02c8b9f-5e1d-463c-a1b0-04edcdfe1a3d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.698Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.519Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name:\"scp\" and\n process.args:\"StrictHostKeyChecking=no\" and\n process.command_line:(\"scp *localhost:/*\", \"scp *127.0.0.1:/*\") and\n not process.args:\"vagrant@*127.0.0.1*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Creation or Modification of a new GPO Scheduled Task or Service",
        "description": "Detects the creation or modification of a new Group Policy based scheduled task or service. These methods are used for legitimate system administration, but can also be abused by an attacker with domain admin permissions to execute a malicious payload remotely on all or a subset of the domain joined machines.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.001",
                    "name": "Group Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "81892531-c74e-40db-8aac-114831ccd417",
        "rule_id": "c0429aa8-9974-42da-bfb6-53a0a515a145",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.700Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.476Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and event.action != \"open\" and \n file.name : (\"ScheduledTasks.xml\", \"Services.xml\") and \n  file.path : (\n    \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\ScheduledTasks\\\\ScheduledTasks.xml\",\n    \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\Services\\\\Services.xml\"\n  ) and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\dfsrs.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Renaming of ESXI index.html File",
        "description": "Identifies instances where the \"index.html\" file within the \"/usr/lib/vmware/*\" directory is renamed on a Linux system. The rule monitors for the \"rename\" event action associated with this specific file and path, which could indicate malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.path",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0a9d0ff5-5477-4fd2-a8a6-8c2efbea5f84",
        "rule_id": "c125e48f-6783-41f0-b100-c3bf1b114d16",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.701Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.304Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action == \"rename\" and file.name : \"index.html\" and\nfile.Ext.original.path : \"/usr/lib/vmware/*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft IIS Connection Strings Decryption",
        "description": "Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web server access via a webshell or alike can decrypt and dump any hardcoded connection strings, such as the MSSQL service account password using aspnet_regiis command.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.netspi.com/decrypting-iis-passwords-to-break-out-of-the-dmz-part-1/",
          "https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/greenbug-espionage-telco-south-asia"
        ],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ee0ac3d1-1a00-49e4-8c79-f20976758d57",
        "rule_id": "c25e9c87-95e1-4368-bfab-9fd34cf867ec",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.703Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.526Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"aspnet_regiis.exe\" or ?process.pe.original_file_name == \"aspnet_regiis.exe\") and\n  process.args : \"connectionStrings\" and process.args : \"-pdf\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via BITS Job Notify Cmdline",
        "description": "An adversary can use the Background Intelligent Transfer Service (BITS) SetNotifyCmdLine method to execute a program that runs after a job finishes transferring data or after a job enters a specified state in order to persist on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pentestlab.blog/2019/10/30/persistence-bits-jobs/",
          "https://docs.microsoft.com/en-us/windows/win32/api/bits1_5/nf-bits1_5-ibackgroundcopyjob2-setnotifycmdline",
          "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin-setnotifycmdline",
          "https://www.elastic.co/blog/hunting-for-persistence-using-elastic-security-part-2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "68885515-56c2-486a-9d30-09b35d1ce94b",
        "rule_id": "c3b915e0-22f3-4bf7-991d-b643513c722f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.705Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.529Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and process.parent.args : \"BITS\" and\n  not process.executable :\n              (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n               \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n               \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n               \"?:\\\\WINDOWS\\\\system32\\\\directxdatabaseupdater.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Mounting Hidden or WebDav Remote Shares",
        "description": "Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement or preparation for data exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "08c651ad-9e05-4a08-b3a0-ec4b654648d1",
        "rule_id": "c4210e1c-64f2-4f48-b67e-b5a8ffe3aa14",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.707Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.532Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n ((process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and\n not process.parent.name : \"net.exe\")) and\n process.args : \"use\" and\n /* including hidden and webdav based online shares such as onedrive  */\n process.args : (\"\\\\\\\\*\\\\*$*\", \"\\\\\\\\*@SSL\\\\*\", \"http*\") and\n /* excluding shares deletion operation */\n not process.args : \"/d*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Print Spooler File Deletion",
        "description": "Detects deletion of print driver files by an unusual process. This may indicate a clean up attempt post successful privilege escalation via Print Spooler service related vulnerabilities.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uninstall or manual deletion of a legitimate printing driver files. Verify the printer file metadata such as manufacturer and signature information."
        ],
        "references": [
          "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ef866535-839c-4f63-bf9f-9c251b364ab4",
        "rule_id": "c4818812-d44f-47be-aaef-4cfb2f9cc799",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.709Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.535Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"deletion\" and\n  file.extension : \"dll\" and file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.dll\" and\n  not process.name : (\"spoolsv.exe\", \"dllhost.exe\", \"explorer.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Remote Desktop Shadowing Activity",
        "description": "Identifies the modification of the Remote Desktop Protocol (RDP) Shadow registry or the execution of processes indicative of an active RDP shadowing session. An adversary may abuse the RDP Shadowing feature to spy on or control other users active RDP sessions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://bitsadm.in/blog/spying-on-users-using-rdp-shadowing",
          "https://swarm.ptsecurity.com/remote-desktop-services-shadowing/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d10d55fe-6ee0-4926-8b38-495b0ab9df89",
        "rule_id": "c57f8579-e2a5-4804-847f-f2732edc5156",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.710Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.307Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Identifies the modification of RDP Shadow registry or\n  the execution of processes indicative of active shadow RDP session */\n\nany where host.os.type == \"windows\" and\n(\n  (event.category == \"registry\" and\n     registry.path : (\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\"\n    )\n  ) or\n  (event.category == \"process\" and event.type == \"start\" and\n     (process.name : (\"RdpSaUacHelper.exe\", \"RdpSaProxy.exe\") and process.parent.name : \"svchost.exe\") or\n     (?process.pe.original_file_name : \"mstsc.exe\" and process.args : \"/shadow:*\")\n  )\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via Renamed COM+ Services DLL",
        "description": "Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump a process memory. This may indicate an attempt to dump LSASS memory while bypassing command-line based detection in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via Renamed COM+ Services DLL\n\nCOMSVCS.DLL is a Windows library that exports the MiniDump function, which can be used to dump a process memory. Adversaries may attempt to dump LSASS memory using a renamed COMSVCS.DLL to bypass command-line based detection and gain unauthorized access to credentials.\n\nThis rule identifies suspicious instances of rundll32.exe loading a renamed COMSVCS.DLL image, which can indicate potential abuse of the MiniDump function for credential theft.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Identify the process that created the DLL using file creation events.\n   - Inspect the file for useful metadata, such as file size and creation or modification time.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable and DLL using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.\n\n### False positive analysis\n\n- False positives may include legitimate instances of rundll32.exe loading a renamed COMSVCS.DLL image for non-malicious purposes, such as during software development, testing, or troubleshooting.\n\n### Related Rules\n\n- Potential Credential Access via LSASS Memory Dump - 9960432d-9b26-409f-972b-839a959e79e2\n- Suspicious Module Loaded by LSASS - 3a6001a0-0939-4bbe-86f4-47d8faeb7b97\n- Suspicious Lsass Process Access - 128468bf-cab1-4637-99ea-fdf3780a4609\n- LSASS Process Access via Windows API - ff4599cb-409f-4910-a239-52e4e6f532ff\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Implement Elastic Endpoint Security to detect and prevent further post exploitation activities in the environment.\n   - Contain the affected system by isolating it from the network to prevent further spread of the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore the affected system to its operational state by applying any necessary patches, updates, or configuration changes.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://modexp.wordpress.com/2019/08/30/minidumpwritedump-via-com-services-dll/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nYou will need to enable logging of ImageLoads in your Sysmon configuration to include COMSVCS.DLL by Imphash or Original\nFile Name.\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.pe.imphash",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3ee31472-fd19-40be-b89e-67a045cb246e",
        "rule_id": "c5c9f591-d111-4cf8-baec-c26a39bc31ef",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.712Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.538Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.category == \"process\" and\n    process.name : \"rundll32.exe\"]\n [process where host.os.type == \"windows\" and event.category == \"process\" and event.dataset : \"windows.sysmon_operational\" and event.code == \"7\" and\n   (file.pe.original_file_name : \"COMSVCS.DLL\" or file.pe.imphash : \"EADBCCBB324829ACB5F2BBE87E5549A8\") and\n    /* renamed COMSVCS */\n    not file.name : \"COMSVCS.DLL\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started by an Office Application",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the Build Engine and could have been caused by an Excel or Word document executing a malicious script payload.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Microsoft Build Engine Started by an Office Application\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software, and can be abused to proxy execution of code.\n\nThis rule looks for the `Msbuild.exe` utility spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. It is quite unusual for this program to be started by an Office application like Word or Excel."
        ],
        "references": [
          "https://blog.talosintelligence.com/2020/02/building-bypass-with-msbuild.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7aa498c8-5eac-416f-9180-f29bcd715e2e",
        "rule_id": "c5dc3223-13a2-44a2-946c-e9dc0aa0449c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.714Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.311Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"eqnedt32.exe\",\n                         \"excel.exe\",\n                         \"fltldr.exe\",\n                         \"msaccess.exe\",\n                         \"mspub.exe\",\n                         \"outlook.exe\",\n                         \"powerpnt.exe\",\n                         \"winword.exe\" )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Remote File Download via MpCmdRun",
        "description": "Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via MpCmdRun\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThe `MpCmdRun.exe` is a command-line tool part of Windows Defender and is used to manage various Microsoft Windows Defender Antivirus settings and perform certain tasks. It can also be abused by attackers to download remote files, including malware and offensive tooling. This rule looks for the patterns used to perform downloads using the utility.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Check the reputation of the domain or IP address used to host the downloaded file.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/mohammadaskar2/status/1301263551638761477",
          "https://www.bleepingcomputer.com/news/microsoft/microsoft-defender-can-ironically-be-used-to-download-malware/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f40183eb-a93e-4d6b-a857-ba856312ea00",
        "rule_id": "c6453e73-90eb-4fe7-a98c-cde7bbfc504a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.716Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.314Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"MpCmdRun.exe\" or ?process.pe.original_file_name == \"MpCmdRun.exe\") and\n   process.args : \"-DownloadFile\" and process.args : \"-url\" and process.args : \"-path\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual File Modification by dns.exe",
        "description": "Identifies an unexpected file being modified by dns.exe, the process responsible for Windows DNS Server services, which may indicate activity related to remote code execution or other forms of exploitation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual File Write\nDetection alerts from this rule indicate potential unusual/abnormal file writes from the DNS Server service process (`dns.exe`) after exploitation from CVE-2020-1350 (SigRed) has occurred. Here are some possible avenues of investigation:\n- Post-exploitation, adversaries may write additional files or payloads to the system as additional discovery/exploitation/persistence mechanisms.\n- Any suspicious or abnormal files written from `dns.exe` should be reviewed and investigated with care.\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/",
          "https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/",
          "https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e218e48-6a07-46f6-9b21-c69cdfa44363",
        "rule_id": "c7ce36c0-32ff-4f9a-bfc2-dcb242bf99f9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.717Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.321Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and process.name : \"dns.exe\" and event.type in (\"creation\", \"deletion\", \"change\") and\n  not file.name : \"dns.log\" and not\n  (file.extension : (\"old\", \"temp\", \"bak\", \"dns\", \"arpa\") and file.path : \"C:\\\\Windows\\\\System32\\\\dns\\\\*\") and\n\n  /* DNS logs with custom names, header converts to \"DNS Server log\" */\n  not ?file.Ext.header_bytes : \"444e5320536572766572206c6f67*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Virtual Machine Fingerprinting via Grep",
        "description": "An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies common locations used to discover virtual machine hardware by a non-root user. This technique has been used by the Pupy RAT and other malware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain tools or automated software may enumerate hardware information. These tools can be exempted via user name or process arguments to eliminate potential noise."
        ],
        "references": [
          "https://objective-see.com/blog/blog_0x4F.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e5f9b274-99ba-4d6b-a21d-e05ae6ea486f",
        "rule_id": "c85eb82c-d2c8-485c-a36f-534f914b7663",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.719Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.551Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\n process.name in (\"grep\", \"egrep\") and user.id != \"0\" and\n process.args : (\"parallels*\", \"vmware*\", \"virtualbox*\") and process.args : \"Manufacturer*\" and\n not process.parent.executable in (\"/Applications/Docker.app/Contents/MacOS/Docker\", \"/usr/libexec/kcare/virt-what\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Ransomware Note Creation Detected",
        "description": "This rule identifies a sequence of a mass file encryption event in conjunction with the creation of a .txt file with a file name containing ransomware keywords executed by the same process in a 1 second timespan. Ransomware is a type of malware that encrypts a victim's files or systems and demands payment (usually in cryptocurrency) in exchange for the decryption key. One important indicator of a ransomware attack is the mass encryption of the file system, after which a new file extension is added to the file.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 10,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c127b912-7525-4d79-9688-fca44b51661c",
        "rule_id": "c8935a8b-634a-4449-98f7-bb24d3b2c0af",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.721Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:08.197Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id, host.id with maxspan=1s \n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\" \n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\") and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\", \"rustup-init\"\n    )\n  ] with runs=25\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   file.name : (\"*restore*\", \"*lock*\", \"*recovery*\", \"*read*\", \"*instruction*\", \"*how_to*\", \"*ransom*\")\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Disabling Windows Defender Security Settings via PowerShell",
        "description": "Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Disabling Windows Defender Security Settings via PowerShell\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows, which makes it popular across multiple environments. Disabling it is a common step in threat actor playbooks.\n\nThis rule monitors the execution of commands that can tamper the Windows Defender antivirus features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine which action was executed. Based on that, examine exceptions, antivirus state, sample submission, etc.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity, the configuration is justified (for example, it is being used to deploy other security solutions or troubleshooting), and no other suspicious activity has been observed.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Microsoft Windows Defender Tampering - fe794edd-487f-4a90-b285-3ee54f2af2d3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Based on the command line, take actions to restore the appropriate Windows Defender antivirus configurations.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Planned Windows Defender configuration changes."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/defender/set-mppreference?view=windowsserver2019-ps",
          "https://www.elastic.co/security-labs/operation-bleeding-bear",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e59c4af9-9172-4e9e-8f40-b748a03bd6a5",
        "rule_id": "c8cccb06-faf2-4cd5-886e-2c9636cfcb87",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.723Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.328Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  process.args : \"Set-MpPreference\" and process.args : (\"-Disable*\", \"Disabled\", \"NeverSend\", \"-Exclusion*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unsigned DLL Side-Loading from a Suspicious Folder",
        "description": "Identifies a Windows trusted program running from locations often abused by adversaries to masquerade as a trusted program and loading a recently dropped DLL. This behavior may indicate an attempt to evade defenses via side-loading a malicious DLL within the memory space of a signed processes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/Hunting-for-Suspicious-Windows-Libraries-for-Execution-and-Evasion"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.Ext.relative_file_creation_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.Ext.relative_file_name_modify_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a52993a2-aca3-496f-a355-978473812be0",
        "rule_id": "ca98c7cf-a56e-4057-a4e8-39603f7f0389",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.724Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.331Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where host.os.type == \"windows\" and\n\n process.code_signature.trusted == true and \n \n (dll.Ext.relative_file_creation_time <= 500 or dll.Ext.relative_file_name_modify_time <= 500) and \n \n  not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\") and \n  \n      /* Suspicious Paths */\n      dll.path : (\"?:\\\\PerfLogs\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Pictures\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Music\\\\*.dll\",\n                  \"?:\\\\Users\\\\Public\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Documents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Windows\\\\System32\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Intel\\\\*.dll\",\n                  \"?:\\\\AMD\\\\Temp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*.dll\",\n                  \"?:\\\\Windows\\\\security\\\\*.dll\",\n\t\t  \"?:\\\\Windows\\\\System\\\\*.dll\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Branding\\\\*.dll\",\n                  \"?:\\\\Windows\\\\csc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*.dll\",\n                  \"?:\\\\Windows\\\\en-US\\\\*.dll\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*.dll\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*.dll\",\n                  \"?:\\\\Windows\\\\INF\\\\*.dll\",\n                  \"?:\\\\windows\\\\tracing\\\\*.dll\",\n                  \"?:\\\\windows\\\\IME\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Performance\\\\*.dll\",\n                  \"?:\\\\windows\\\\intel\\\\*.dll\",\n                  \"?:\\\\windows\\\\ms\\\\*.dll\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceProfiles\\\\*.dll\",\n                  \"?:\\\\Windows\\\\panther\\\\*.dll\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*.dll\",\n                  \"?:\\\\Windows\\\\OCR\\\\*.dll\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*.dll\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\addins\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Setup\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Help\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SKB\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Vss\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Web\\\\*.dll\",\n                  \"?:\\\\Windows\\\\servicing\\\\*.dll\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Logs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*.dll\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PLA\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Migration\\\\*.dll\",\n                  \"?:\\\\Windows\\\\debug\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Containers\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Boot\\\\*.dll\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*.dll\",\n                  \"?:\\\\Windows\\\\schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Resources\\\\*.dll\",\n                  \"?:\\\\Windows\\\\rescache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.dll\",\n                  \"?:\\\\Windows\\\\media\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*.dll\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.dll\",\n                  \"?:\\\\$Recycle.Bin\\\\*.dll\") and \n\t \n\t /* DLL loaded from the process.executable current directory */\n\t endswith~(substring(dll.path, 0, length(dll.path) - (length(dll.name) + 1)), substring(process.executable, 0, length(process.executable) - (length(process.name) + 1)))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Abnormal Process ID or Lock File Created",
        "description": "Identifies the creation of a Process ID (PID), lock or reboot file created in temporary file storage paradigm (tmpfs) directory /var/run. On Linux, the PID files typically hold the process ID to track previous copies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising itself or these files as legitimate PID files.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Abnormal Process ID or Lock File Created\n\nLinux applications may need to save their process identification number (PID) for various purposes: from signaling that a program is running to serving as a signal that a previous instance of an application didn't exit successfully. PID files contain its creator process PID in an integer value.\n\nLinux lock files are used to coordinate operations in files so that conflicts and race conditions are prevented.\n\nThis rule identifies the creation of PID, lock, or reboot files in the /var/run/ directory. Attackers can masquerade malware, payloads, staged data for exfiltration, and more as legitimate PID files.\n\n#### Possible investigation steps\n\n- Retrieve the file and determine if it is malicious:\n    - Check the contents of the PID files. They should only contain integer strings.\n    - Check the file type of the lock and PID files to determine if they are executables. This is only observed in     malicious files.\n    - Check the size of the subject file. Legitimate PID files should be under 10 bytes.\n    - Check if the lock or PID file has high entropy. This typically indicates an encrypted payload.\n        - Analysts can use tools like `ent` to measure entropy.\n    - Examine the reputation of the SHA-256 hash in the PID file. Use a database like VirusTotal to identify additional pivots and artifacts for investigation.\n- Trace the file's creation to ensure it came from a legitimate or authorized process.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- False positives can appear if the PID file is legitimate and holding a process ID as intended. If the PID file is an executable or has a file size that's larger than 10 bytes, it should be ruled suspicious.\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of file name and process executable conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Block the identified indicators of compromise (IoCs).\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Threat: BPFDoor",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "False-Positives (FP) can appear if the PID file is legitimate and holding a process ID as intended. To differentiate, if the PID file is an executable or larger than 10 bytes, it should be ruled suspicious."
        ],
        "references": [
          "https://www.sandflysecurity.com/blog/linux-file-masquerading-and-malicious-pids-sandfly-1-2-6-update/",
          "https://twitter.com/GossiTheDog/status/1522964028284411907",
          "https://exatrack.com/public/Tricephalic_Hellkeeper.pdf",
          "https://www.elastic.co/security-labs/a-peek-behind-the-bpfdoor"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "67fe8298-8e44-42f6-9b64-2211820ebeb3",
        "rule_id": "cac91072-d165-11ec-a764-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.726Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:07.089Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(creation or file_create_event) and\nfile.extension:(pid or lock or reboot) and file.path:(/var/run/* or /run/*) and (\n  (process.name : (\n    bash or dash or sh or tcsh or csh or zsh or ksh or fish or ash or touch or nano or vim or vi or editor or mv or cp)\n  ) or (\n  process.executable : (\n    ./* or /tmp/* or /var/tmp/* or /dev/shm/* or /var/run/* or /boot/* or /srv/* or /run/*\n  ))\n) and not (\n  process.executable : (\n  /tmp/newroot/* or /run/containerd/* or /run/k3s/containerd/* or /run/k0s/container* or /snap/* or /vz/* or\n  /var/lib/docker/* or /etc/*/universal-hooks/pkgs/mysql-community-server/* or /var/lib/snapd/* or /etc/rubrik/* or\n  /run/udev/data/*\n  ) or\n  process.name : (\n    go or git or containerd* or snap-confine or cron or crond or sshd or unattended-upgrade or vzctl or ifup or\n    rpcbind or runc or gitlab-runner-helper or elastic-agent or metricbeat or redis-server or\n    s6-ipcserver-socketbinder or xinetd\n  ) or\n  file.name : (\n    jem.*.pid or lynis.pid or redis.pid or yum.pid or MFS.pid or jenkins.pid or nvmupdate.pid or openlitespeed.pid or\n    rhnsd.pid\n  ) or\n  file.path : (/run/containerd/* or /var/run/docker/containerd/* or /var/run/jem*.pid)\n)",
        "new_terms_fields": [
          "process.executable",
          "file.name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kernel Module Removal",
        "description": "Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This rule identifies attempts to remove a kernel module.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "There is usually no reason to remove modules, but some buggy modules require it. These can be exempted by username. Note that some Linux distributions are not built to support the removal of modules at all."
        ],
        "references": [
          "http://man7.org/linux/man-pages/man8/modprobe.8.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "26fb52ea-a415-4e46-ae02-dbf431cab83a",
        "rule_id": "cd66a5af-e34b-4bb0-8931-57d0a043f2ef",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.728Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.341Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  process.name == \"rmmod\" or\n  (process.name == \"modprobe\" and process.args in (\"--remove\", \"-r\"))\n) and process.parent.name in (\"sudo\", \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential PowerShell HackTool Script by Function Names",
        "description": "Detects known PowerShell offensive tooling functions names in PowerShell scripts. Attackers commonly use out-of-the-box offensive tools without modifying the code. This rule aim is to take advantage of that.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential PowerShell HackTool Script by Function Names\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAdversaries often exploit PowerShell's capabilities to execute malicious scripts and perform various attacks. This rule identifies known offensive tooling function names in PowerShell scripts, as attackers commonly use out-of-the-box tools without modifying the code. By monitoring these specific function names, the rule aims to detect and alert potential malicious PowerShell activity.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the script's execution context, such as the user account, privileges, the role of the system on which it was executed, and any relevant timestamps.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate the origin of the PowerShell script, including its source, download method, and any associated URLs or IP addresses.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This rule may generate false positives if legitimate scripts or tools used by administrators contain any of the listed function names. These function names are commonly associated with offensive tooling, but they may also be present in benign scripts or tools.\n- To handle these false positives consider adding exceptions - preferably with a combination of full file path and users.\n\n### Related Rules\n\n- PowerShell Invoke-NinjaCopy script - b8386923-b02c-4b94-986a-d223d9b01f88\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md",
          "https://github.com/BC-SECURITY/Empire"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4b64a8bf-ddd2-4726-99d9-766d22579cf5",
        "rule_id": "cde1bafa-9f01-4f43-a872-605b678968b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.730Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.287Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Add-DomainGroupMember\" or \"Add-DomainObjectAcl\" or\n    \"Add-RemoteConnection\" or \"Add-ServiceDacl\" or\n    \"Add-Win32Type\" or \"Convert-ADName\" or\n    \"Convert-LDAPProperty\" or \"ConvertFrom-LDAPLogonHours\" or\n    \"ConvertFrom-UACValue\" or \"Copy-ArrayOfMemAddresses\" or\n    \"Create-NamedPipe\" or \"Create-ProcessWithToken\" or\n    \"Create-RemoteThread\" or \"Create-SuspendedWinLogon\" or\n    \"Create-WinLogonProcess\" or \"Emit-CallThreadStub\" or\n    \"Enable-SeAssignPrimaryTokenPrivilege\" or \"Enable-SeDebugPrivilege\" or\n    \"Enum-AllTokens\" or \"Export-PowerViewCSV\" or\n    \"Find-AVSignature\" or \"Find-AppLockerLog\" or\n    \"Find-DomainLocalGroupMember\" or \"Find-DomainObjectPropertyOutlier\" or\n    \"Find-DomainProcess\" or \"Find-DomainShare\" or\n    \"Find-DomainUserEvent\" or \"Find-DomainUserLocation\" or\n    \"Find-InterestingDomainAcl\" or \"Find-InterestingDomainShareFile\" or\n    \"Find-InterestingFile\" or \"Find-LocalAdminAccess\" or\n    \"Find-PSScriptsInPSAppLog\" or \"Find-PathDLLHijack\" or\n    \"Find-ProcessDLLHijack\" or \"Find-RDPClientConnection\" or\n    \"Get-AllAttributesForClass\" or \"Get-CachedGPPPassword\" or\n    \"Get-DecryptedCpassword\" or \"Get-DecryptedSitelistPassword\" or\n    \"Get-DelegateType\" or \"New-RelayEnumObject\" or\n    \"Get-DomainDFSShare\" or \"Get-DomainDFSShareV1\" or\n    \"Get-DomainDFSShareV2\" or \"Get-DomainDNSRecord\" or\n    \"Get-DomainDNSZone\" or \"Get-DomainFileServer\" or\n    \"Get-DomainForeignGroupMember\" or \"Get-DomainForeignUser\" or\n    \"Get-DomainGPO\" or \"Get-DomainGPOComputerLocalGroupMapping\" or\n    \"Get-DomainGPOLocalGroup\" or \"Get-DomainGPOUserLocalGroupMapping\" or\n    \"Get-DomainGUIDMap\" or \"Get-DomainGroup\" or\n    \"Get-DomainGroupMember\" or \"Get-DomainGroupMemberDeleted\" or\n    \"Get-DomainManagedSecurityGroup\" or \"Get-DomainOU\" or\n    \"Get-DomainObject\" or \"Get-DomainObjectAcl\" or\n    \"Get-DomainObjectAttributeHistory\" or \"Get-DomainObjectLinkedAttributeHistory\" or\n    \"Get-DomainPolicyData\" or \"Get-DomainSID\" or\n    \"Get-DomainSPNTicket\" or \"Get-DomainSearcher\" or\n    \"Get-DomainSite\" or \"Get-DomainSubnet\" or\n    \"Get-DomainTrust\" or \"Get-DomainTrustMapping\" or\n    \"Get-DomainUser\" or \"Get-DomainUserEvent\" or\n    \"Get-Forest\" or \"Get-ForestDomain\" or\n    \"Get-ForestGlobalCatalog\" or \"Get-ForestSchemaClass\" or\n    \"Get-ForestTrust\" or \"Get-GPODelegation\" or\n    \"Get-GPPAutologon\" or \"Get-GPPInnerField\" or\n    \"Get-GPPInnerFields\" or \"Get-GPPPassword\" or\n    \"Get-GptTmpl\" or \"Get-GroupsXML\" or\n    \"Get-HttpStatus\" or \"Get-ImageNtHeaders\" or\n    \"Get-Keystrokes\" or \"New-SOASerialNumberArray\" or \n    \"Get-MemoryProcAddress\" or \"Get-MicrophoneAudio\" or\n    \"Get-ModifiablePath\" or \"Get-ModifiableRegistryAutoRun\" or\n    \"Get-ModifiableScheduledTaskFile\" or \"Get-ModifiableService\" or\n    \"Get-ModifiableServiceFile\" or \"Get-Name\" or\n    \"Get-NetComputerSiteName\" or \"Get-NetLocalGroup\" or\n    \"Get-NetLocalGroupMember\" or \"Get-NetLoggedon\" or\n    \"Get-NetRDPSession\" or \"Get-NetSession\" or\n    \"Get-NetShare\" or \"Get-PEArchitecture\" or\n    \"Get-PEBasicInfo\" or \"Get-PEDetailedInfo\" or\n    \"Get-PathAcl\" or \"Get-PrimaryToken\" or\n    \"Get-ProcAddress\" or \"Get-ProcessTokenGroup\" or\n    \"Get-ProcessTokenPrivilege\" or \"Get-ProcessTokenType\" or\n    \"Get-RegLoggedOn\" or \"Get-RegistryAlwaysInstallElevated\" or\n    \"Get-RegistryAutoLogon\" or \"Get-RemoteProcAddress\" or\n    \"Get-Screenshot\" or \"Get-ServiceDetail\" or\n    \"Get-SiteListPassword\" or \"Get-SitelistField\" or\n    \"Get-System\" or \"Get-SystemNamedPipe\" or\n    \"Get-SystemToken\" or \"Get-ThreadToken\" or\n    \"Get-TimedScreenshot\" or \"Get-TokenInformation\" or\n    \"Get-TopPort\" or \"Get-UnattendedInstallFile\" or\n    \"Get-UniqueTokens\" or \"Get-UnquotedService\" or\n    \"Get-VaultCredential\" or \"Get-VaultElementValue\" or\n    \"Get-VirtualProtectValue\" or \"Get-VolumeShadowCopy\" or\n    \"Get-WMIProcess\" or \"Get-WMIRegCachedRDPConnection\" or\n    \"Get-WMIRegLastLoggedOn\" or \"Get-WMIRegMountedDrive\" or\n    \"Get-WMIRegProxy\" or \"Get-WebConfig\" or\n    \"Get-Win32Constants\" or \"Get-Win32Functions\" or\n    \"Get-Win32Types\" or \"Import-DllImports\" or\n    \"Import-DllInRemoteProcess\" or \"Inject-LocalShellcode\" or\n    \"Inject-RemoteShellcode\" or \"Install-ServiceBinary\" or\n    \"Invoke-CompareAttributesForClass\" or \"Invoke-CreateRemoteThread\" or\n    \"Invoke-CredentialInjection\" or \"Invoke-DllInjection\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-ImpersonateUser\" or\n    \"Invoke-Kerberoast\" or \"Invoke-MemoryFreeLibrary\" or\n    \"Invoke-MemoryLoadLibrary\" or\n    \"Invoke-Mimikatz\" or \"Invoke-NinjaCopy\" or\n    \"Invoke-PatchDll\" or \"Invoke-Portscan\" or\n    \"Invoke-PrivescAudit\" or \"Invoke-ReflectivePEInjection\" or\n    \"Invoke-ReverseDnsLookup\" or \"Invoke-RevertToSelf\" or\n    \"Invoke-ServiceAbuse\" or \"Invoke-Shellcode\" or\n    \"Invoke-TokenManipulation\" or \"Invoke-UserImpersonation\" or\n    \"Invoke-WmiCommand\" or \"Mount-VolumeShadowCopy\" or\n    \"New-ADObjectAccessControlEntry\" or \"New-DomainGroup\" or\n    \"New-DomainUser\" or \"New-DynamicParameter\" or\n    \"New-InMemoryModule\" or\n    \"New-ThreadedFunction\" or \"New-VolumeShadowCopy\" or\n    \"Out-CompressedDll\" or \"Out-EncodedCommand\" or\n    \"Out-EncryptedScript\" or \"Out-Minidump\" or\n    \"PortScan-Alive\" or \"Portscan-Port\" or\n    \"Remove-DomainGroupMember\" or \"Remove-DomainObjectAcl\" or\n    \"Remove-RemoteConnection\" or \"Remove-VolumeShadowCopy\" or\n    \"Restore-ServiceBinary\" or \"Set-DesktopACLToAllowEveryone\" or\n    \"Set-DesktopACLs\" or \"Set-DomainObject\" or\n    \"Set-DomainObjectOwner\" or \"Set-DomainUserPassword\" or\n    \"Set-ServiceBinaryPath\" or \"Sub-SignedIntAsUnsigned\" or\n    \"Test-AdminAccess\" or \"Test-MemoryRangeValid\" or\n    \"Test-ServiceDaclPermission\" or \"Update-ExeFunctions\" or\n    \"Update-MemoryAddresses\" or \"Update-MemoryProtectionFlags\" or\n    \"Write-BytesToMemory\" or \"Write-HijackDll\" or\n    \"Write-PortscanOut\" or \"Write-ServiceBinary\" or\n    \"Write-UserAddMSI\" or \"Invoke-Privesc\" or\n    \"func_get_proc_address\" or \"Invoke-BloodHound\" or\n    \"Invoke-HostEnum\" or \"Get-BrowserInformation\" or\n    \"Get-DomainAccountPolicy\" or \"Get-DomainAdmins\" or\n    \"Get-AVProcesses\" or \"Get-AVInfo\" or\n    \"Get-RecycleBin\" or \"Invoke-BruteForce\" or\n    \"Get-PassHints\" or \"Invoke-SessionGopher\" or\n    \"Get-LSASecret\" or \"Get-PassHashes\" or\n    \"Invoke-WdigestDowngrade\" or \"Get-ChromeDump\" or\n    \"Invoke-DomainPasswordSpray\" or \"Get-FoxDump\" or\n    \"New-HoneyHash\" or \"Invoke-DCSync\" or\n    \"Invoke-PowerDump\" or \"Invoke-SSIDExfil\" or\n    \"Invoke-PowerShellTCP\" or \"Add-Exfiltration\" or\n    \"Do-Exfiltration\" or \"Invoke-DropboxUpload\" or\n    \"Invoke-ExfilDataToGitHub\" or \"Invoke-EgressCheck\" or\n    \"Invoke-PostExfil\" or \"Create-MultipleSessions\" or\n    \"Invoke-NetworkRelay\" or \"New-GPOImmediateTask\" or\n    \"Invoke-WMIDebugger\" or \"Invoke-SQLOSCMD\" or\n    \"Invoke-SMBExec\" or \"Invoke-PSRemoting\" or\n    \"Invoke-ExecuteMSBuild\" or \"Invoke-DCOM\" or\n    \"Invoke-InveighRelay\" or \"Invoke-PsExec\" or\n    \"Invoke-SSHCommand\" or \"Find-ActiveUsersWMI\" or\n    \"Get-SystemDrivesWMI\" or \"Get-ActiveNICSWMI\" or\n    \"Remove-Persistence\" or \"DNS_TXT_Pwnage\" or\n    \"Execute-OnTime\" or \"HTTP-Backdoor\" or\n    \"Add-ConstrainedDelegationBackdoor\" or \"Add-RegBackdoor\" or\n    \"Add-ScrnSaveBackdoor\" or \"Gupt-Backdoor\" or\n    \"Invoke-ADSBackdoor\" or \"Add-Persistence\" or\n    \"Invoke-ResolverBackdoor\" or \"Invoke-EventLogBackdoor\" or\n    \"Invoke-DeadUserBackdoor\" or \"Invoke-DisableMachineAcctChange\" or\n    \"Invoke-AccessBinary\" or \"Add-NetUser\" or\n    \"Invoke-Schtasks\" or \"Invoke-JSRatRegsvr\" or\n    \"Invoke-JSRatRundll\" or \"Invoke-PoshRatHttps\" or\n    \"Invoke-PsGcatAgent\" or \"Remove-PoshRat\" or\n    \"Install-SSP\" or \"Invoke-BackdoorLNK\" or\n    \"PowerBreach\" or \"InstallEXE-Persistence\" or\n    \"RemoveEXE-Persistence\" or \"Install-ServiceLevel-Persistence\" or\n    \"Remove-ServiceLevel-Persistence\" or \"Invoke-Prompt\" or\n    \"Invoke-PacketCapture\" or \"Start-WebcamRecorder\" or\n    \"Get-USBKeyStrokes\" or \"Invoke-KeeThief\" or\n    \"Get-Keystrokes\" or \"Invoke-NetRipper\" or\n    \"Get-EmailItems\" or \"Invoke-MailSearch\" or\n    \"Invoke-SearchGAL\" or \"Get-WebCredentials\" or\n    \"Start-CaptureServer\" or \"Invoke-PowerShellIcmp\" or\n    \"Invoke-PowerShellTcpOneLine\" or \"Invoke-PowerShellTcpOneLineBind\" or\n    \"Invoke-PowerShellUdp\" or \"Invoke-PowerShellUdpOneLine\" or\n    \"Run-EXEonRemote\" or \"Download-Execute-PS\" or\n    \"Out-RundllCommand\" or \"Set-RemoteWMI\" or\n    \"Set-DCShadowPermissions\" or \"Invoke-PowerShellWMI\" or\n    \"Invoke-Vnc\" or \"Invoke-LockWorkStation\" or\n    \"Invoke-EternalBlue\" or \"Invoke-ShellcodeMSIL\" or\n    \"Invoke-MetasploitPayload\" or \"Invoke-DowngradeAccount\" or\n    \"Invoke-RunAs\" or \"ExetoText\" or\n    \"Disable-SecuritySettings\" or \"Set-MacAttribute\" or\n    \"Invoke-MS16032\" or \"Invoke-BypassUACTokenManipulation\" or\n    \"Invoke-SDCLTBypass\" or \"Invoke-FodHelperBypass\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-EnvBypass\" or\n    \"Get-ServiceUnquoted\" or \"Get-ServiceFilePermission\" or\n    \"Get-ServicePermission\" or\n    \"Enable-DuplicateToken\" or \"Invoke-PsUaCme\" or\n    \"Invoke-Tater\" or \"Invoke-WScriptBypassUAC\" or\n    \"Invoke-AllChecks\" or \"Find-TrustedDocuments\" or\n    \"Invoke-Interceptor\" or \"Invoke-PoshRatHttp\" or\n    \"Invoke-ExecCommandWMI\" or \"Invoke-KillProcessWMI\" or\n    \"Invoke-CreateShareandExecute\" or \"Invoke-RemoteScriptWithOutput\" or\n    \"Invoke-SchedJobManipulation\" or \"Invoke-ServiceManipulation\" or\n    \"Invoke-PowerOptionsWMI\" or \"Invoke-DirectoryListing\" or\n    \"Invoke-FileTransferOverWMI\" or \"Invoke-WMImplant\" or\n    \"Invoke-WMIObfuscatedPSCommand\" or \"Invoke-WMIDuplicateClass\" or\n    \"Invoke-WMIUpload\" or \"Invoke-WMIRemoteExtract\" or \"Invoke-winPEAS\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  ) and\n  not user.id : (\"S-1-5-18\" or \"S-1-5-19\")",
        "language": "kuery"
      },
      {
        "name": "New ActiveSyncAllowedDeviceID Added via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/set-casmailbox?view=exchange-ps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.002",
                    "name": "Additional Email Delegate Permissions",
                    "reference": "https://attack.mitre.org/techniques/T1098/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f78503a7-5bdd-4d50-a483-047b020f0c55",
        "rule_id": "ce64d965-6cb0-466d-b74f-8d2c76f47f05",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.731Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.347Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and process.args : \"Set-CASMailbox*ActiveSyncAllowedDeviceIDs*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Namespace Manipulation Using Unshare",
        "description": "Identifies suspicious usage of unshare to manipulate system namespaces. Unshare can be utilized to escalate privileges or escape container security boundaries. Threat actors have utilized this binary to allow themselves to escape to the host and access other resources or escalate privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://man7.org/linux/man-pages/man1/unshare.1.html",
          "https://www.crowdstrike.com/blog/cve-2022-0185-kubernetes-container-escape-using-linux-kernel-exploit/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "97bac9d4-fa7d-4157-856b-ab6fc4059989",
        "rule_id": "d00f33e7-b57d-4023-9952-2db91b1767c4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.735Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.354Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action : (\"exec\", \"exec_event\") and\nprocess.executable: \"/usr/bin/unshare\" and\nnot process.parent.executable: (\"/usr/bin/udevadm\", \"*/lib/systemd/systemd-udevd\", \"/usr/bin/unshare\") and\nnot process.args == \"/usr/bin/snap\" and not process.parent.name in (\"zz-proxmox-boot\", \"java\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Execution from Unusual Directory - Command Line",
        "description": "Identifies process execution from suspicious default Windows directories. This may be abused by adversaries to hide malware in trusted paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Execution from Unusual Directory - Command Line\n\nThis rule looks for the execution of scripts from unusual directories. Attackers can use system or application paths to hide malware and make the execution less suspicious.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine which commands or scripts were executed.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of parent process executable and command line conditions.\n\n### Related rules\n\n- Process Execution from an Unusual Directory - ebfe1448-7fac-4d59-acea-181bd89b1f7f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f579840c-9aec-4017-8035-3a43a9c1c51b",
        "rule_id": "cff92c41-2225-4763-b4ce-6f71e5bda5e6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.733Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.350Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"wscript.exe\",\n                  \"cscript.exe\",\n                  \"rundll32.exe\",\n                  \"regsvr32.exe\",\n                  \"cmstp.exe\",\n                  \"RegAsm.exe\",\n                  \"installutil.exe\",\n                  \"mshta.exe\",\n                  \"RegSvcs.exe\",\n                  \"powershell.exe\",\n                  \"pwsh.exe\",\n                  \"cmd.exe\") and\n\n  /* add suspicious execution paths here */\n  process.args : (\"C:\\\\PerfLogs\\\\*\",\n                  \"C:\\\\Users\\\\Public\\\\*\",\n                  \"C:\\\\Windows\\\\Tasks\\\\*\",\n                  \"C:\\\\Intel\\\\*\",\n                  \"C:\\\\AMD\\\\Temp\\\\*\",\n                  \"C:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"C:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"C:\\\\Windows\\\\Branding\\\\*\",\n                  \"C:\\\\Windows\\\\csc\\\\*\",\n                  \"C:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"C:\\\\Windows\\\\en-US\\\\*\",\n                  \"C:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"C:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"C:\\\\Windows\\\\Fonts\\\\*\",\n                  \"C:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"C:\\\\Windows\\\\TAPI\\\\*\",\n                  \"C:\\\\Windows\\\\INF\\\\*\",\n                  \"C:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"C:\\\\windows\\\\tracing\\\\*\",\n                  \"c:\\\\windows\\\\IME\\\\*\",\n                  \"c:\\\\Windows\\\\Performance\\\\*\",\n                  \"c:\\\\windows\\\\intel\\\\*\",\n                  \"c:\\\\windows\\\\ms\\\\*\",\n                  \"C:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"C:\\\\Windows\\\\panther\\\\*\",\n                  \"C:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"C:\\\\Windows\\\\OCR\\\\*\",\n                  \"C:\\\\Windows\\\\appcompat\\\\*\",\n                  \"C:\\\\Windows\\\\apppatch\\\\*\",\n                  \"C:\\\\Windows\\\\addins\\\\*\",\n                  \"C:\\\\Windows\\\\Setup\\\\*\",\n                  \"C:\\\\Windows\\\\Help\\\\*\",\n                  \"C:\\\\Windows\\\\SKB\\\\*\",\n                  \"C:\\\\Windows\\\\Vss\\\\*\",\n                  \"C:\\\\Windows\\\\servicing\\\\*\",\n                  \"C:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"C:\\\\Windows\\\\Logs\\\\*\",\n                  \"C:\\\\Windows\\\\WaaS\\\\*\",\n                  \"C:\\\\Windows\\\\twain_32\\\\*\",\n                  \"C:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"C:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"C:\\\\Windows\\\\PLA\\\\*\",\n                  \"C:\\\\Windows\\\\Migration\\\\*\",\n                  \"C:\\\\Windows\\\\debug\\\\*\",\n                  \"C:\\\\Windows\\\\Cursors\\\\*\",\n                  \"C:\\\\Windows\\\\Containers\\\\*\",\n                  \"C:\\\\Windows\\\\Boot\\\\*\",\n                  \"C:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"C:\\\\Windows\\\\TextInput\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\schemas\\\\*\",\n                  \"C:\\\\Windows\\\\SchCache\\\\*\",\n                  \"C:\\\\Windows\\\\Resources\\\\*\",\n                  \"C:\\\\Windows\\\\rescache\\\\*\",\n                  \"C:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"C:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"C:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"C:\\\\Windows\\\\media\\\\*\",\n                  \"C:\\\\Windows\\\\Globalization\\\\*\",\n                  \"C:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"C:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"C:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"C:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"C:\\\\$Recycle.Bin\\\\*\") and\n\n  /* noisy FP patterns */\n\n  not process.parent.executable : (\"C:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\igfxCUIService*.exe\",\n                                   \"C:\\\\Windows\\\\System32\\\\spacedeskService.exe\",\n                                   \"C:\\\\Program Files\\\\Dell\\\\SupportAssistAgent\\\\SRE\\\\SRE.exe\") and\n  not (process.name : \"rundll32.exe\" and\n       process.args : (\"uxtheme.dll,#64\",\n                       \"PRINTUI.DLL,PrintUIEntry\",\n                       \"?:\\\\Windows\\\\System32\\\\FirewallControlPanel.dll,ShowNotificationDialog\",\n                       \"?:\\\\WINDOWS\\\\system32\\\\Speech\\\\SpeechUX\\\\sapi.cpl\",\n                       \"?:\\\\Windows\\\\system32\\\\shell32.dll,OpenAs_RunDLL\")) and\n\n  not (process.name : \"cscript.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\calluxxprovider.vbs\") and\n\n  not (process.name : \"cmd.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\powercfg.exe\" and process.args : \"?:\\\\WINDOWS\\\\inf\\\\PowerPlan.log\") and\n\n  not (process.name : \"regsvr32.exe\" and process.args : \"?:\\\\Windows\\\\Help\\\\OEM\\\\scripts\\\\checkmui.dll\") and\n\n  not (process.name : \"cmd.exe\" and\n       process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\oobe\\\\windeploy.exe\",\n                                    \"?:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe\",\n                                    \"?:\\\\Windows\\\\System32\\\\igfxCUIService.exe\",\n                                    \"?:\\\\Windows\\\\Temp\\\\IE*.tmp\\\\IE*-support\\\\ienrcore.exe\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Registry Persistence via AppInit DLL",
        "description": "AppInit DLLs are dynamic-link libraries (DLLs) that are loaded into every process that creates a user interface (loads user32.dll) on Microsoft Windows operating systems. The AppInit DLL mechanism is used to load custom code into user-mode processes, allowing for the customization of the user interface and the behavior of Windows-based applications. Attackers who add those DLLs to the registry locations can execute code with elevated privileges, similar to process injection, and provide a solid and constant persistence on the machine.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Registry Persistence via AppInit DLL\n\nAppInit DLLs are dynamic-link libraries (DLLs) that are loaded into every process that creates a user interface (loads `user32.dll`) on Microsoft Windows operating systems. The AppInit DLL mechanism is used to load custom code into user-mode processes, allowing for the customization of the user interface and the behavior of Windows-based applications.\n\nAttackers who add those DLLs to the registry locations can execute code with elevated privileges, similar to process injection, and provide a solid and constant persistence on the machine.\n\nThis rule identifies modifications on the AppInit registry keys.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Review the source process and related DLL file tied to the Windows Registry entry.\n  - Check whether the DLL is signed, and tied to a authorized program used on your environment.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Retrieve all DLLs under the AppInit registry keys:\n  - !{osquery{\"label\":\"Osquery - Retrieve AppInit Registry Value\",\"query\":\"SELECT * FROM registry r where (r.key == 'HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows' or\\nr.key == 'HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows') and r.name ==\\n'AppInit_DLLs'\\n\"}}\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable and the DLLs using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.010",
                    "name": "AppInit DLLs",
                    "reference": "https://attack.mitre.org/techniques/T1546/010/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b1c61fc7-934e-4723-ab28-324a9378f72d",
        "rule_id": "d0e159cf-73e9-40d1-a9ed-077e3158a855",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.737Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.290Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n     \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"HKLM\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"MACHINE\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\"\n  ) and\n  not process.executable : (\n     \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\Display.NvContainer\\\\NVDisplay.Container.exe\",\n     \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n     \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n     \"?:\\\\Program Files\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files (x86)\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files (x86)\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files\\\\NVIDIA Corporation\\\\Display.NvContainer\\\\NVDisplay.Container.exe\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Symbolic Link to Shadow Copy Created",
        "description": "Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadow copy, including sensitive files such as ntds.dit, System Boot Key and browser offline credentials.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Symbolic Link to Shadow Copy Created\n\nShadow copies are backups or snapshots of an endpoint's files or volumes while they are in use. Adversaries may attempt to discover and create symbolic links to these shadow copies in order to copy sensitive information offline. If Active Directory (AD) is in use, often the ntds.dit file is a target as it contains password hashes, but an offline copy is needed to extract these hashes and potentially conduct lateral movement.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine if a volume shadow copy was recently created on this endpoint.\n- Review privileges of the end user as this requires administrative access.\n- Verify if the ntds.dit file was successfully copied and determine its copy destination.\n- Investigate for registry SYSTEM file copies made recently or saved via Reg.exe.\n- Investigate recent deletions of volume shadow copies.\n- Identify other files potentially copied from volume shadow copy paths directly.\n\n### False positive analysis\n\n- This rule should cause very few false positives. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- NTDS or SAM Database File Copied - 3bc6deaa-fbd4-433a-ae21-3e892f95624f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Locate and remove static files copied from volume shadow copies.\n- Command-Line tool mklink should require administrative access by default unless in developer mode.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Legitimate administrative activity related to shadow copies."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mklink",
          "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf",
          "https://blog.netwrix.com/2021/11/30/extracting-password-hashes-from-the-ntds-dit-file/",
          "https://www.hackingarticles.in/credential-dumping-ntds-dit/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nEnsure advanced audit policies for Windows are enabled, specifically:\nObject Access policies [Event ID 4656](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656) (Handle to an Object was Requested)\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nSystem Audit Policies >\nObject Access >\nAudit File System (Success,Failure)\nAudit Handle Manipulation (Success,Failure)\n```\n\nThis event will only trigger if symbolic links are created from a new process spawning cmd.exe or powershell.exe with the correct arguments.\nDirect access to a shell and calling symbolic link creation tools will not generate an event matching this rule.\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8a9bbbea-4d1f-4006-b3d7-6393705f1077",
        "rule_id": "d117cbb4-7d56-41b4-b999-bdf8c25648a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.738Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.357Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (\n    (?process.pe.original_file_name in (\"Cmd.Exe\",\"PowerShell.EXE\")) or\n    (process.name : (\"cmd.exe\", \"powershell.exe\"))\n ) and\n\n /* Create Symbolic Link to Shadow Copies */\n process.args : (\"*mklink*\", \"*SymbolicLink*\") and process.command_line : (\"*HarddiskVolumeShadowCopy*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Disabling User Account Control via Registry Modification",
        "description": "User Account Control (UAC) can help mitigate the impact of malware on Windows hosts. With UAC, apps and tasks always run in the security context of a non-administrator account, unless an administrator specifically authorizes administrator-level access to the system. This rule identifies registry value changes to bypass User Access Control (UAC) protection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Disabling User Account Control via Registry Modification\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nAttackers may disable UAC to execute code directly in high integrity. This rule identifies registry value changes to bypass the UAC protection.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behaviors in the alert timeframe.\n- Investigate abnormal behaviors observed by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Analyze non-system processes executed with high integrity after UAC was disabled for unknown or suspicious processes.\n- Retrieve the suspicious processes' executables and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled tasks creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore UAC settings to the desired state.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.greyhathacker.net/?p=796",
          "https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings",
          "https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-overview",
          "https://www.elastic.co/security-labs/dissecting-remcos-rat-part-four"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "034be9a1-e82e-43f2-a18a-d91625441673",
        "rule_id": "d31f183a-e5b1-451b-8534-ba62bca0b404",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.740Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.360Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path :\n    (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\",\n      \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\"\n    ) and\n  registry.data.strings : (\"0\", \"0x00000000\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Clearing Windows Event Logs",
        "description": "Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Clearing Windows Event Logs\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the execution of the `wevtutil.exe` utility or the `Clear-EventLog` cmdlet to clear event logs.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and there are justifications for this action.\n- Analyze whether the cleared event log is pertinent to security and general monitoring. Administrators can clear non-relevant event logs using this mechanism. If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - This activity is potentially done after the adversary achieves its objectives on the host. Ensure that previous actions, if any, are investigated accordingly with their response playbooks.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.001",
                    "name": "Clear Windows Event Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/001/"
                  },
                  {
                    "id": "T1562.002",
                    "name": "Disable Windows Event Logging",
                    "reference": "https://attack.mitre.org/techniques/T1562/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "de7fa22d-9400-4d62-b013-6338fab1ba6f",
        "rule_id": "d331bbe2-6db4-4941-80a5-8270db72eb61",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.745Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.363Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name : \"wevtutil.exe\" or ?process.pe.original_file_name == \"wevtutil.exe\") and\n    process.args : (\"/e:false\", \"cl\", \"clear-log\")\n  ) or\n  (\n    (\n      process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n    ) and\n    process.args : \"Clear-EventLog\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Linux init (PID 1) Secret Dump via GDB",
        "description": "This rule monitors for the potential memory dump of the init process (PID 1) through gdb. Attackers may leverage memory dumping techniques to attempt secret extraction from privileged processes. Tools that display this behavior include \"truffleproc\" and \"bash-memory-dump\". This behavior should not happen by default, and should be investigated thoroughly.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/controlplaneio/truffleproc",
          "https://github.com/hajzer/bash-memory-dump"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.007",
                    "name": "Proc Filesystem",
                    "reference": "https://attack.mitre.org/techniques/T1003/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d0acf62b-ab60-4d64-aa31-5a7394116f4f",
        "rule_id": "d4ff2f53-c802-4d2e-9fb9-9ecc08356c3f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.747Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:21.700Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"gdb\" and process.args in (\"--pid\", \"-p\") and process.args == \"1\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via UID INT_MAX Bug Detected",
        "description": "This rule monitors for the execution of the systemd-run command by a user with a UID that is larger than the maximum allowed UID size (INT_MAX). Some older Linux versions were affected by a bug which allows user accounts with a UID greater than INT_MAX to escalate privileges by spawning a shell through systemd-run.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/paragonsec/status/1071152249529884674",
          "https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2018-19788.sh",
          "https://gitlab.freedesktop.org/polkit/polkit/-/issues/74"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ac25758d-3fc0-4bc4-8e1b-06b6bcc7efd9",
        "rule_id": "d55436a8-719c-445f-92c4-c113ff2f9ba5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.749Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.571Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"systemd-run\" and process.args == \"-t\" and process.args_count >= 3 and user.id >= \"1000000000\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "System Information Discovery via Windows Command Shell",
        "description": "Identifies the execution of discovery commands to enumerate system information, files, and folders using the Windows Command Shell.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating System Information Discovery via Windows Command Shell\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule identifies commands to enumerate system information, files, and folders using the Windows Command Shell.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              },
              {
                "id": "T1083",
                "name": "File and Directory Discovery",
                "reference": "https://attack.mitre.org/techniques/T1083/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "edca2357-730a-4b95-8fcd-715f46d54023",
        "rule_id": "d68e95ad-1c82-4074-a12a-125fe10ac8ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.750Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.293Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and process.args : \"/c\" and process.args : (\"set\", \"dir\") and\n  not process.parent.executable : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\PROGRA~1\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-endpoint.events.process-*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Modification of WDigest Security Provider",
        "description": "Identifies attempts to modify the WDigest security provider in the registry to force the user's password to be stored in clear text in memory. This behavior can be indicative of an adversary attempting to weaken the security configuration of an endpoint. Once the UseLogonCredential value is modified, the adversary may attempt to dump clear text passwords from memory.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of WDigest Security Provider\n\nIn Windows XP, Microsoft added support for a protocol known as WDigest. The WDigest protocol allows clients to send cleartext credentials to Hypertext Transfer Protocol (HTTP) and Simple Authentication Security Layer (SASL) applications based on RFC 2617 and 2831. Windows versions up to 8 and 2012 store logon credentials in memory in plaintext by default, which is no longer the case with newer Windows versions.\n\nStill, attackers can force WDigest to store the passwords insecurely on the memory by modifying the `HKLM\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredential` registry key. This activity is commonly related to the execution of credential dumping tools.\n\n#### Possible investigation steps\n\n- It is unlikely that the monitored registry key was modified legitimately in newer versions of Windows. Analysts should treat any activity triggered from this rule with high priority as it typically represents an active adversary.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine if credential dumping tools were run on the host, and retrieve and analyze suspicious executables:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences on other hosts.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team, as these modifications expose the entire domain to credential compromises and consequently unauthorized access.\n\n### Related rules\n\n- Mimikatz Powershell Module Activity - ac96ceb8-4399-4191-af1d-4feeac1f1f46\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.csoonline.com/article/3438824/how-to-detect-and-halt-credential-theft-via-windows-wdigest.html",
          "https://www.praetorian.com/blog/mitigating-mimikatz-wdigest-cleartext-credential-theft?edition=2019",
          "https://frsecure.com/compromised-credentials-response-playbook",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e444c687-1e80-4e34-9da2-027dc7e2bf24",
        "rule_id": "d703a5af-d5b0-43bd-8ddb-7a5d500b7da5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.752Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:17.578Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"creation\" and\n    registry.path : (\n        \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\"\n    ) and registry.data.strings : (\"1\", \"0x00000001\") and\n    not (process.executable : \"?:\\\\Windows\\\\System32\\\\svchost.exe\" and user.id : \"S-1-5-18\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Command Execution via SolarWinds Process",
        "description": "A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Initial Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted SolarWinds child processes. Verify process details such as network connections and file writes."
        ],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html",
          "https://github.com/mandiant/sunburst_countermeasures/blob/main/rules/SUNBURST/hxioc/SUNBURST%20SUSPICIOUS%20FILEWRITES%20(METHODOLOGY).ioc"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3178de38-0243-48fa-95ad-8e3380cf144f",
        "rule_id": "d72e33fc-6e91-42ff-ac8b-e573268c5a87",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.754Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.370Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name: (\"cmd.exe\", \"powershell.exe\") and\nprocess.parent.name: (\n     \"ConfigurationWizard*.exe\",\n     \"NetflowDatabaseMaintenance*.exe\",\n     \"NetFlowService*.exe\",\n     \"SolarWinds.Administration*.exe\",\n     \"SolarWinds.Collector.Service*.exe\",\n     \"SolarwindsDiagnostics*.exe\"\n     )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Interactive Terminal Spawned via Python",
        "description": "Identifies when a terminal (tty) is spawned via Python. Attackers may upgrade a simple reverse shell to a fully interactive tty after obtaining initial access to a host.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.006",
                    "name": "Python",
                    "reference": "https://attack.mitre.org/techniques/T1059/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eef39087-7442-4ce9-986f-0a1928a0f7f7",
        "rule_id": "d76b02ef-fc95-4001-9297-01cb7412232f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.756Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:08.200Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\n(\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.parent.args_count >= 3 and process.parent.args : \"*pty.spawn*\" and process.parent.args : \"-c\") or\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.args : \"*sh\" and process.args_count == 1 and process.parent.args_count == 1)\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Access to a Sensitive LDAP Attribute",
        "description": "Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as unixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming",
          "https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "e91ad7b3-ec1e-4ebc-9b8e-2925d38b2632",
        "rule_id": "764c9fcd-4c4c-41e6-a0c7-d6c46c2eff66",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.757Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.208Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action in (\"Directory Service Access\", \"object-operation-performed\") and event.code == \"4662\" and\n\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n  winlog.event_data.Properties : (\n   /* unixUserPassword */\n  \"*612cb747-c0e8-4f92-9221-fdd5f15b550d*\",\n\n  /* ms-PKI-AccountCredentials */\n  \"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*\",\n\n  /*  ms-PKI-DPAPIMasterKeys */\n  \"*b3f93023-9239-4f7c-b99c-6745d87adbc2*\",\n\n  /* msPKI-CredentialRoamingTokens */\n  \"*b7ff5a38-0818-42b0-8110-d3d154c97f24*\"\n  ) and\n\n  /*\n   Excluding noisy AccessMasks\n   0x0 undefined and 0x100 Control Access\n   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n   */\n  not winlog.event_data.AccessMask in (\"0x0\", \"0x100\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Hidden Shared Object File",
        "description": "Identifies the creation of a hidden shared object (.so) file. Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d7e7fafa-ae1d-49f7-b2a4-a8ae31e6b89d",
        "rule_id": "766d3f91-3f12-448c-b65f-20123e9e9e8c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.759Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.211Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.extension == \"so\" and file.name : \".*.so\" and\nnot process.name == \"dockerd\"",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Privilege Escalation via Rogue Named Pipe Impersonation",
        "description": "Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique by masquerading as a known named pipe and manipulating a privileged process to connect to it.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/",
          "https://github.com/zcgonvh/EfsPotato",
          "https://twitter.com/SBousseaden/status/1429530155291193354"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nNamed Pipe Creation Events need to be enabled within the Sysmon configuration by including the following settings:\n`condition equal \"contains\" and keyword equal \"pipe\"`\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "67a8ce8c-ea59-4713-989b-a9866e966a97",
        "rule_id": "76ddb638-abf7-42d5-be22-4a70b0bf7241",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.761Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.592Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.action : \"Pipe Created*\" and\n /* normal sysmon named pipe creation events truncate the pipe keyword */\n  file.name : \"\\\\*\\\\Pipe\\\\*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Reverse Shell via Suspicious Child Process",
        "description": "This detection rule detects the creation of a shell through a suspicious process chain. Any reverse shells spawned by the specified utilities that are initialized from a single process followed by a network connection attempt will be captured through this rule. Attackers may spawn reverse shells to establish persistence onto a target system.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "31fda1f1-6d41-460e-81f9-5c908e43696f",
        "rule_id": "76e4d92b-61c1-4a95-ab61-5fd94179a1ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.763Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.214Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"fork\") and (\n    (process.name : \"python*\" and process.args : \"-c\" and process.args : (\n     \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n    )) or\n    (process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n     \"*exec*\", \"*system*\"\n    )) or\n    (process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n     \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n     )) or\n    (process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n     \"*io.popen*\", \"*os.execute*\"\n    )) or\n    (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or \n    (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or\n    (process.name : \"openssl\" and process.args : \"-connect\") or\n    (process.name : (\"nc\", \"ncat\", \"netcat\") and process.args == \"-e\" and process.args_count >= 3 and \n     not process.args == \"-z\") or\n    (process.name : \"telnet\" and process.args_count >= 3)\n  ) and process.parent.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n    \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n    process.name : (\"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\") and \n    destination.ip != null and not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Remote Desktop Tunneling Detected",
        "description": "Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to enable routing of network packets that would otherwise not reach their intended destination.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Remote Desktop Tunneling Detected\n\nProtocol Tunneling is a mechanism that involves explicitly encapsulating a protocol within another for various use cases, ranging from providing an outer layer of encryption (similar to a VPN) to enabling traffic that network appliances would filter to reach their destination.\n\nAttackers may tunnel Remote Desktop Protocol (RDP) traffic through other protocols like Secure Shell (SSH) to bypass network restrictions that block incoming RDP connections but may be more permissive to other protocols.\n\nThis rule looks for command lines involving the `3389` port, which RDP uses by default and options commonly associated with tools that perform tunneling.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine network data to determine if the host communicated with external servers using the tunnel.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Investigate the command line for the execution of programs that are unrelated to tunneling, like Remote Desktop clients.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Take the necessary actions to disable the tunneling, which can be a process kill, service deletion, registry key modification, etc. Inspect the host to learn which method was used and to determine a response for the case.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.netspi.com/how-to-access-rdp-over-a-reverse-ssh-tunnel/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "05ae68e0-6c73-47f9-b18a-708a444c3707",
        "rule_id": "76fd43b7-3480-4dd9-8ad7-8bd36bfad92f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.765Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.469Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* RDP port and usual SSH tunneling related switches in command line */\n  process.args : \"*:3389\" and\n  process.args : (\"-L\", \"-P\", \"-R\", \"-pw\", \"-ssh\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration Command Spawned via WMIPrvSE",
        "description": "Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation Provider Service (WMIPrvSE).",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/",
                "subtechnique": [
                  {
                    "id": "T1016.001",
                    "name": "Internet Connection Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1016/001/"
                  }
                ]
              },
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/"
              },
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c1993cae-d363-432d-a08f-67ad28ad01e7",
        "rule_id": "770e0c4d-b998-41e5-a62e-c7901fd7f470",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.766Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.472Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.command_line != null and \n  process.name:\n  (\n    \"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n    \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\", \"quser.exe\",\n    \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\"\n  ) and\n  process.parent.name:\"wmiprvse.exe\" and \n  not (\n    process.name : \"sc.exe\" and process.args : \"RemoteRegistry\" and process.args : \"start=\" and \n    process.args : (\"demand\", \"disabled\")\n  ) and\n  not process.args : \"tenable_mw_scan\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shadow Credentials added to AD Object",
        "description": "Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object. Attackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target user or computer object.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Shadow Credentials added to AD Object\n\nThe msDS-KeyCredentialLink is an Active Directory (AD) attribute that links cryptographic certificates to a user or computer for domain authentication.\n\nAttackers with write privileges on this attribute over an object can abuse it to gain access to the object or maintain persistence. This means they can authenticate and perform actions on behalf of the exploited identity, and they can use Shadow Credentials to request Ticket Granting Tickets (TGTs) on behalf of the identity.\n\n#### Possible investigation steps\n\n- Identify whether Windows Hello for Business (WHfB) and/or Azure AD is used in the environment.\n  - Review the event ID 4624 for logon events involving the subject identity (`winlog.event_data.SubjectUserName`).\n    - Check whether the `source.ip` is the server running Azure AD Connect.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Review the event IDs 4768 and 4769 for suspicious ticket requests involving the modified identity (`winlog.event_data.ObjectDN`).\n  - Extract the source IP addresses from these events and use them as indicators of compromise (IoCs) to investigate whether the host is compromised and to scope the attacker's access to the environment.\n\n### False positive analysis\n\n- Administrators might use custom accounts on Azure AD Connect. If this is the case, make sure the account is properly secured. You can also create an exception for the account if expected activity makes too much noise in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n  - Remove the Shadow Credentials from the object.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Modifications in the msDS-KeyCredentialLink attribute can be done legitimately by the Azure AD Connect synchronization account or the ADFS service account. These accounts can be added as Exceptions."
        ],
        "references": [
          "https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab",
          "https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials",
          "https://github.com/OTRF/Set-AuditRule",
          "https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n\nThe above policy does not cover User objects, so we need to set up an AuditRule using https://github.com/OTRF/Set-AuditRule.\nAs this specifies the msDS-KeyCredentialLink Attribute GUID, it is expected to be low noise.\n\n```\nSet-AuditRule -AdObjectPath 'AD:\\CN=Users,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights WriteProperty -InheritanceFlags Children -AttributeGUID 5b47d60f-6090-40b2-9f37-2a4de88f3063 -AuditFlags Success\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "bbab98de-f573-45d8-a073-489599e9fec1",
        "rule_id": "79f97b31-480e-4e63-a7f4-ede42bf2c6de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.768Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.432Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:\"5136\" and\n winlog.event_data.AttributeLDAPDisplayName:\"msDS-KeyCredentialLink\" and winlog.event_data.AttributeValue :B\\:828* and\n not winlog.event_data.SubjectUserName: MSOL_*",
        "language": "kuery"
      },
      {
        "name": "Potential Privilege Escalation through Writable Docker Socket",
        "description": "This rule monitors for the usage of Docker runtime sockets to escalate privileges on Linux systems. Docker sockets by default are only be writable by the root user and docker group. Attackers that have permissions to write to these sockets may be able to create and run a container that allows them to escalate privileges and gain further access onto the host file system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Domain: Container",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation#automatic-enumeration-and-escape"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "607387af-6f23-4eaa-97e8-e28268a587df",
        "rule_id": "7acb2de3-8465-472a-8d9c-ccd7b73d0ed8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.770Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.435Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n(\n  (process.name == \"docker\" and process.args : \"run\" and process.args : \"-it\"  and \n   process.args : (\"unix://*/docker.sock\", \"unix://*/dockershim.sock\")) or \n  (process.name == \"socat\" and process.args : (\"UNIX-CONNECT:*/docker.sock\", \"UNIX-CONNECT:*/dockershim.sock\"))\n) and not user.Ext.real.id : \"0\" and not group.Ext.real.id : \"0\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Windows Network Enumeration",
        "description": "Identifies attempts to enumerate hosts in a network using the built-in Windows net.exe tool.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Network Enumeration\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `net` utility to enumerate servers in the environment that hosts shared drives or printers. This information is useful to attackers as they can identify targets for lateral movements and search for valuable shared data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8d7772b4-a439-48d3-b430-b8d71644c85a",
        "rule_id": "7b8bfc26-81d2-435e-965c-d722ee397ef1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.772Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.217Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  ((process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n   ((process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n       not process.parent.name : \"net.exe\")) and\n  (process.args : \"view\" or (process.args : \"time\" and process.args : \"\\\\\\\\*\")) and\n  not process.command_line : \"net  view \\\\\\\\localhost \"\n\n\n  /* expand when ancestry is available\n  and not descendant of [process where event.type == \"start\" and process.name : \"cmd.exe\" and\n                           ((process.parent.name : \"userinit.exe\") or\n                            (process.parent.name : \"gpscript.exe\") or\n                            (process.parent.name : \"explorer.exe\" and\n                               process.args : \"C:\\\\*\\\\Start Menu\\\\Programs\\\\Startup\\\\*.bat*\"))]\n  */",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious LSASS Access via MalSecLogon",
        "description": "Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access rights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-3.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.GrantedAccess",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "858e205c-7bfd-4daa-babd-1fe26ecdc78d",
        "rule_id": "7ba58110-ae13-439b-8192-357b0fcfa9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.773Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.485Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* seclogon service accessing lsass */\n  winlog.event_data.CallTrace : \"*seclogon.dll*\" and process.name : \"svchost.exe\" and\n\n   /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */\n  winlog.event_data.GrantedAccess == \"0x14c0\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Tampering of Shell Command-Line History",
        "description": "Adversaries may attempt to clear or disable the Bash command-line history in an attempt to evade detection or forensic investigations.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.003",
                    "name": "Clear Command History",
                    "reference": "https://attack.mitre.org/techniques/T1070/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0e0533db-05fa-4a31-a6e5-034c93a6ac14",
        "rule_id": "7bcbb3ac-e533-41ad-a612-d6c3bf666aba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.775Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.441Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and event.type == \"start\" and\n (\n  ((process.args : (\"rm\", \"echo\") or\n    (process.args : \"ln\" and process.args : \"-sf\" and process.args : \"/dev/null\") or\n    (process.args : \"truncate\" and process.args : \"-s0\"))\n    and process.args : (\".bash_history\", \"/root/.bash_history\", \"/home/*/.bash_history\",\"/Users/.bash_history\", \"/Users/*/.bash_history\",\n                        \".zsh_history\", \"/root/.zsh_history\", \"/home/*/.zsh_history\", \"/Users/.zsh_history\", \"/Users/*/.zsh_history\")) or\n  (process.args : \"history\" and process.args : \"-c\") or\n  (process.args : \"export\" and process.args : (\"HISTFILE=/dev/null\", \"HISTFILESIZE=0\")) or\n  (process.args : \"unset\" and process.args : \"HISTFILE\") or\n  (process.args : \"set\" and process.args : \"history\" and process.args : \"+o\")\n )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Kernel Modules via Proc",
        "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module using the /proc/modules filesystem. This filesystem is used by utilities such as lsmod and kmod to list the available kernel modules.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-w /proc/ -p r -k audit_proc\n```\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "29f459e1-ea81-4670-966e-a6d7a718b5d0",
        "rule_id": "80084fa9-8677-4453-8680-b891d3c0c778",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.777Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:12.488Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:\"opened-file\" and file.path:\"/proc/modules\" and\nnot process.name:(python* or chef-client)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "PowerShell Suspicious Payload Encoded and Compressed",
        "description": "Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, which malware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Payload Encoded and Compressed\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can embed compressed and encoded payloads in scripts to load directly into the memory without touching the disk. This strategy can circumvent string and file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell Scripts which makes use of compression and encoding."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b9f4d3e4-f87c-4316-9447-b7f60910fc6a",
        "rule_id": "81fe9dc6-a2d7-4192-a2d8-eed98afc766a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.778Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.220Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"System.IO.Compression.DeflateStream\" or\n      \"System.IO.Compression.GzipStream\" or\n      \"IO.Compression.DeflateStream\" or\n      \"IO.Compression.GzipStream\"\n    ) and\n    FromBase64String\n  ) and\n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Apple Scripting Execution with Administrator Privileges",
        "description": "Identifies execution of the Apple script interpreter (osascript) without a password prompt and with administrator privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://discussions.apple.com/thread/2266150"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "299a6347-d845-4a9a-b013-4240b6e1400e",
        "rule_id": "827f8d8f-4117-4ae4-b551-f56d54b9da6b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.780Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.457Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name : \"osascript\" and\n  process.command_line : \"osascript*with administrator privileges\" and\n  not process.parent.name : \"Electron\" and\n  not process.Ext.effective_parent.executable : (\"/Applications/Visual Studio Code.app/Contents/MacOS/Electron\",\n                                                 \"/Applications/OpenVPN Connect/Uninstall OpenVPN Connect.app/Contents/MacOS/uninstaller\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Local Account Brute Force Detected",
        "description": "Identifies multiple consecutive login attempts executed by one process targeting a local linux user account within a short time interval. Adversaries might brute force login attempts across different users with a default wordlist or a set of customly crafted passwords in an attempt to gain access to these accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "419f0507-3161-4fe9-baa6-7da0145dd30e",
        "rule_id": "835c0622-114e-40b5-a346-f843ea5d01f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.925Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.461Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.executable, user.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"su\" and \n   not process.parent.name in (\n     \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"clickhouse-server\", \"ma\", \"gitlab-runner\",\n     \"updatedb.findutils\", \"cron\", \"perl\", \"sudo\", \"java\", \"cloud-app-identify\", \"ambari-sudo.sh\"\n   )\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Disable IPTables or Firewall",
        "description": "Adversaries may attempt to disable the iptables or firewall service in an attempt to affect how a host is allowed to receive or send network traffic.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5b0a65f7-8ca4-4aca-8a4f-7d71745fa597",
        "rule_id": "83e9c2b3-24ef-4c1d-a8cd-5ebafb5dfa2f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:14.927Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.236Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\n  (\n   /* disable FW */\n   (\n     (process.name == \"ufw\" and process.args == \"disable\") or\n     (process.name == \"iptables\" and process.args in (\"-F\", \"--flush\", \"-X\", \"--delete-chain\") and process.args_count == 2) or\n     (process.name in (\"iptables\", \"ip6tables\") and process.parent.args == \"force-stop\")\n   ) or\n\n   /* stop FW service */\n   (\n     ((process.name == \"service\" and process.args == \"stop\") or\n       (process.name == \"chkconfig\" and process.args == \"off\") or\n       (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))) and\n    process.args in (\"firewalld\", \"ip6tables\", \"iptables\", \"firewalld.service\", \"ip6tables.service\", \"iptables.service\")\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Upgrade of Non-interactive Shell",
        "description": "Identifies when a non-interactive terminal (tty) is being upgraded to a fully interactive shell. Attackers may upgrade a simple reverse shell to a fully interactive tty after obtaining initial access to a host, in order to obtain a more stable connection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "56c6f321-2436-42de-ab71-4b5d76edd5d6",
        "rule_id": "84d1f8db-207f-45ab-a578-921d91c23eb2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.474Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.763Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  (process.name == \"stty\" and process.args == \"raw\" and process.args == \"-echo\" and process.args_count >= 3) or\n  (process.name == \"script\" and process.args in (\"-qc\", \"-c\") and process.args == \"/dev/null\" and \n   process.args_count == 4)\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Remote Credential Access via Registry",
        "description": "Identifies remote access to the registry to potentially dump credential data from the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Remote Credential Access via Registry\n\nDumping registry hives is a common way to access credential information. Some hives store credential material, such as the SAM hive, which stores locally cached credentials (SAM secrets), and the SECURITY hive, which stores domain cached credentials (LSA secrets). Dumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nAttackers can use tools like secretsdump.py or CrackMapExec to dump the registry hives remotely, and use dumped credentials to access other systems in the domain.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as their role, criticality, and associated users.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Determine the privileges of the compromised accounts.\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Related rules\n\n- Credential Acquisition via Registry Hive Dumping - a7e7bfa3-088e-4f13-b29e-3986e0e756b8\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine if other hosts were compromised.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Ensure that the machine has the latest security updates and is not running unsupported Windows versions.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule uses Elastic Endpoint file creation and system integration events for correlation. Both data should be collected from the host for this detection to work.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.size",
            "type": "long",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cb5daef1-e3b1-49da-8222-c6756932322c",
        "rule_id": "850d901a-2a3c-46c6-8b22-55398a01aad8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.476Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.245Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and\n  event.action == \"creation\" and process.name : \"svchost.exe\" and\n  file.Ext.header_bytes : \"72656766*\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and file.size >= 30000 and\n  file.path : (\"?:\\\\Windows\\\\system32\\\\*.tmp\", \"?:\\\\WINDOWS\\\\Temp\\\\*.tmp\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Exchange Transport Agent Install Script",
        "description": "Identifies the use of Cmdlets and methods related to Microsoft Exchange Transport Agents install. Adversaries may leverage malicious Microsoft Exchange Transport Agents to execute tasks in response to adversary-defined criteria, establishing persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.002",
                    "name": "Transport Agent",
                    "reference": "https://attack.mitre.org/techniques/T1505/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\nSteps to implement the logging policy via registry:\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e94e8f35-72e3-4e89-b725-bccb162870af",
        "rule_id": "846fe13f-6772-4c83-bd39-9d16d4ad1a81",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.488Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:23.759Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Exchange\\\\RemotePowerShell\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category: \"process\" and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n    \"Install-TransportAgent\" or\n    \"Enable-TransportAgent\"\n    )\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not powershell.file.script_block_text : (\n    \"'Install-TransportAgent', 'Invoke-MonitoringProbe', 'Mount-Database', 'Move-ActiveMailboxDatabase',\" or\n    \"'Enable-TransportAgent', 'Enable-TransportRule', 'Export-ActiveSyncLog', 'Export-AutoDiscoverConfig',\" or\n    (\"scriptCmd.GetSteppablePipeline\" and \"ForwardHelpTargetName Install-TransportAgent\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Security Software Discovery via Grep",
        "description": "Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirus or Host Firewall details.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Security Software Discovery via Grep\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `grep` utility with arguments compatible to the enumeration of the security software installed on the host. Attackers can use this information to decide whether or not to infect a system, disable protections, use bypasses, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Endpoint Security installers, updaters and post installation verification scripts."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4118da80-5a6d-4038-8580-2e07cee1df96",
        "rule_id": "870aecc0-cea4-4110-af3f-e02e9b373655",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.490Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.249Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\nprocess.name : \"grep\" and user.id != \"0\" and\n not process.parent.executable : (\"/Library/Application Support/*\", \"/opt/McAfee/agent/scripts/ma\") and\n   process.args :\n         (\"Little Snitch*\",\n          \"Avast*\",\n          \"Avira*\",\n          \"ESET*\",\n          \"BlockBlock*\",\n          \"360Sec*\",\n          \"LuLu*\",\n          \"KnockKnock*\",\n          \"kav\",\n          \"KIS\",\n          \"RTProtectionDaemon*\",\n          \"Malware*\",\n          \"VShieldScanner*\",\n          \"WebProtection*\",\n          \"webinspectord*\",\n          \"McAfee*\",\n          \"isecespd*\",\n          \"macmnsvc*\",\n          \"masvc*\",\n          \"kesl*\",\n          \"avscan*\",\n          \"guard*\",\n          \"rtvscand*\",\n          \"symcfgd*\",\n          \"scmdaemon*\",\n          \"symantec*\",\n          \"sophos*\",\n          \"osquery*\",\n          \"elastic-endpoint*\"\n          ) and\n   not (\n     (process.args : \"Avast\" and process.args : \"Passwords\") or\n     (process.args == \"osquery.conf\") or \n     (process.parent.args : \"/opt/McAfee/agent/scripts/ma\" and process.parent.args : \"checkhealth\") or\n     (process.command_line : (\n       \"grep ESET Command-line scanner, version %s -A2\",\n       \"grep -i McAfee Web Gateway Core version:\",\n       \"grep --color=auto ESET Command-line scanner, version %s -A2\"\n       )\n     ) or\n     (process.parent.command_line : (\n       \"\"\"sh -c printf \"command_start_%s\"*; perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1; printf \"command_done_%s*\"\"\",\n       \"\"\"bash -c perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1\"\"\"\n       )\n     )\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "auditbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Administrator Accounts",
        "description": "Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windows tools.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumeration of Administrator Accounts\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `net` and `wmic` utilities to enumerate administrator-related users or groups in the domain and local machine scope. Attackers can use this information to plan their next steps of the attack, such as mapping targets for credential compromise and other post-exploitation activities.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- AdFind Command Activity - eda499b8-a073-4e35-9733-22ec71f57f3a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  },
                  {
                    "id": "T1069.002",
                    "name": "Domain Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/002/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "251c634d-ebbf-42b4-b8fa-2c994f7f249d",
        "rule_id": "871ea072-1b71-4def-b016-6278b505138d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.492Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.252Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      (process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or\n      ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and not process.parent.name : \"net.exe\")\n    ) and\n    process.args : (\"group\", \"user\", \"localgroup\") and\n    process.args : (\"*admin*\", \"Domain Admins\", \"Remote Desktop Users\", \"Enterprise Admins\", \"Organization Management\")\n    and not process.args : (\"/add\", \"/delete\")\n  ) or\n  (\n    (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n    process.args : (\"group\", \"useraccount\")\n  )\n) and not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Sublime Plugin or Application Script Modification",
        "description": "Adversaries may create or modify the Sublime application plugins or scripts to execute a malicious payload each time the Sublime application is started.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/persistent-jxa-66e1c3cd1cf5"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "460ac0b1-b80d-49e4-9727-e615526bcd36",
        "rule_id": "88817a33-60d3-411f-ba79-7c905d865b2a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.494Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.476Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"macos\" and event.type in (\"change\", \"creation\") and file.extension : \"py\" and\n  file.path :\n    (\n      \"/Users/*/Library/Application Support/Sublime Text*/Packages/*.py\",\n      \"/Applications/Sublime Text.app/Contents/MacOS/sublime.py\"\n    ) and\n  not process.executable :\n    (\n      \"/Applications/Sublime Text*.app/Contents/*\",\n      \"/usr/local/Cellar/git/*/bin/git\",\n      \"/Library/Developer/CommandLineTools/usr/bin/git\",\n      \"/usr/libexec/xpcproxy\",\n      \"/System/Library/PrivateFrameworks/DesktopServicesPriv.framework/Versions/A/Resources/DesktopServicesHelper\"\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious WMI Image Load from MS Office",
        "description": "Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where child processes are spawned via Windows Management Instrumentation (WMI). This technique can be used to execute code and evade traditional parent/child processes spawned from Microsoft Office products.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "016737c8-cea1-437b-b757-8530a84621f8",
        "rule_id": "891cb88e-441a-4c3e-be2d-120d99fe7b0d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.496Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.483Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Kerberos Traffic from Unusual Process",
        "description": "Identifies network connections to the standard Kerberos port from an unusual process. On Windows, the only process that normally performs Kerberos traffic from a domain joined host is lsass.exe.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kerberos Traffic from Unusual Process\n\nKerberos is the default authentication protocol in Active Directory, designed to provide strong authentication for client/server applications by using secret-key cryptography.\n\nDomain-joined hosts usually perform Kerberos traffic using the `lsass.exe` process. This rule detects the occurrence of traffic on the Kerberos port (88) by processes other than `lsass.exe` to detect the unusual request and usage of Kerberos tickets.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if the Destination IP is related to a Domain Controller.\n- Review event ID 4769 for suspicious ticket requests.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This rule uses a Kerberos-related port but does not identify the protocol used on that port. HTTP traffic on a non-standard port or destination IP address unrelated to Domain controllers can create false positives.\n- Exceptions can be added for noisy/frequent connections.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n  - Ticket requests can be used to investigate potentially compromised accounts.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "HTTP traffic on a non standard port. Verify that the destination IP address is not related to a Domain Controller."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.address",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "3f6dc69c-6333-43d3-9d08-601c8353b0d9",
        "rule_id": "897dc6b5-b39f-432a-8d75-d3730d50c782",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.498Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.255Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and event.type == \"start\" and network.direction == \"egress\" and\n  destination.port == 88 and source.port >= 49152 and process.pid != 4 and destination.address : \"*\" and\n  not \n  (\n    process.executable : (\n        \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap\\\\nmap.exe\",\n        \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap oem\\\\nmap.exe\",\n        \"\\\\device\\\\harddiskvolume?\\\\windows\\\\system32\\\\lsass.exe\",\n        \"?:\\\\Program Files\\\\Amazon Corretto\\\\jdk1*\\\\bin\\\\java.exe\",\n        \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Proxy Server\\\\bin\\\\prunsrv.exe\",\n        \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Core\\\\tomcat-core\\\\bin\\\\tomcat9.exe\",\n        \"?:\\\\Program Files\\\\DBeaver\\\\dbeaver.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.backend.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.vpnkit.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\vpnkit.exe\",\n        \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files\\\\Internet Explorer\\\\iexplore.exe\",\n        \"?:\\\\Program Files\\\\JetBrains\\\\PyCharm Community Edition*\\\\bin\\\\pycharm64.exe\",\n        \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n        \"?:\\\\Program Files\\\\Oracle\\\\VirtualBox\\\\VirtualBoxVM.exe\",\n        \"?:\\\\Program Files\\\\Puppet Labs\\\\Puppet\\\\puppet\\\\bin\\\\ruby.exe\",\n        \"?:\\\\Program Files\\\\rapid7\\\\nexpose\\\\nse\\\\.DLLCACHE\\\\nseserv.exe\",\n        \"?:\\\\Program Files\\\\Silverfort\\\\Silverfort AD Adapter\\\\SilverfortServer.exe\",\n        \"?:\\\\Program Files\\\\Tenable\\\\Nessus\\\\nessusd.exe\",\n        \"?:\\\\Program Files\\\\VMware\\\\VMware View\\\\Server\\\\bin\\\\ws_TomcatService.exe\",\n        \"?:\\\\Program Files (x86)\\\\Advanced Port Scanner\\\\advanced_port_scanner.exe\",\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcpatchscan.exe\",\n        \"?:\\\\Program Files (x86)\\\\GFI\\\\LanGuard 12 Agent\\\\lnsscomm.exe\",\n        \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files (x86)\\\\Internet Explorer\\\\iexplore.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeUpdate\\\\MicrosoftEdgeUpdate.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft Silverlight\\\\sllauncher.exe\",\n        \"?:\\\\Program Files (x86)\\\\Nmap\\\\nmap.exe\",\n        \"?:\\\\Program Files (x86)\\\\Nmap OEM\\\\nmap.exe\",\n        \"?:\\\\Program Files (x86)\\\\nwps\\\\NetScanTools Pro\\\\NSTPRO.exe\",\n        \"?:\\\\Program Files (x86)\\\\SAP BusinessObjects\\\\tomcat\\\\bin\\\\tomcat9.exe\",\n        \"?:\\\\Program Files (x86)\\\\SuperScan\\\\scanner.exe\",\n        \"?:\\\\Program Files (x86)\\\\Zscaler\\\\ZSATunnel\\\\ZSATunnel.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\vmnat.exe\",\n        \"?:\\\\Windows\\\\SystemApps\\\\Microsoft.MicrosoftEdge_*\\\\MicrosoftEdge.exe\",\n        \"System\"\n    ) and process.code_signature.trusted == true\n  ) and\n destination.address != \"127.0.0.1\" and destination.address != \"::1\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Symbolic Link Created",
        "description": "Identifies the creation of a symbolic link to a suspicious file or location. A symbolic link is a reference to a file or directory that acts as a pointer or shortcut, allowing users to access the target file or directory from a different location in the file system. An attacker can potentially leverage symbolic links for privilege escalation by tricking a privileged process into following the symbolic link to a sensitive file, giving the attacker access to data or capabilities they would not normally have.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "f3b74d3e-8af1-4406-9105-b6b0d3daf492",
        "rule_id": "8a024633-c444-45c0-a4fe-78128d8c1ab6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.499Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.489Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"ln\" and process.args in (\"-s\", \"-sf\") and \n  (\n    /* suspicious files */\n    (process.args in (\"/etc/shadow\", \"/etc/shadow-\", \"/etc/shadow~\", \"/etc/gshadow\", \"/etc/gshadow-\") or \n    (process.working_directory == \"/etc\" and process.args in (\"shadow\", \"shadow-\", \"shadow~\", \"gshadow\", \"gshadow-\"))) or \n    \n    /* suspicious bins */\n    (process.args in (\"/bin/bash\", \"/bin/dash\", \"/bin/sh\", \"/bin/tcsh\", \"/bin/csh\", \"/bin/zsh\", \"/bin/ksh\", \"/bin/fish\") or \n    (process.working_directory == \"/bin\" and process.args : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or \n    (process.args in (\"/usr/bin/bash\", \"/usr/bin/dash\", \"/usr/bin/sh\", \"/usr/bin/tcsh\", \"/usr/bin/csh\", \"/usr/bin/zsh\", \"/usr/bin/ksh\", \"/usr/bin/fish\") or \n    (process.working_directory == \"/usr/bin\" and process.args in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or\n    \n    /* suspicious locations */\n    (process.args : (\"/etc/cron.d/*\", \"/etc/cron.daily/*\", \"/etc/cron.hourly/*\", \"/etc/cron.weekly/*\", \"/etc/cron.monthly/*\")) or\n    (process.args : (\"/home/*/.ssh/*\", \"/root/.ssh/*\",\"/etc/sudoers.d/*\", \"/dev/shm/*\"))\n  ) and \n  process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and \n  not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Execution from a Mounted Device",
        "description": "Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker may use this technique to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/",
          "https://www.volexity.com/blog/2021/05/27/suspected-apt29-operation-launches-election-fraud-themed-phishing-campaigns/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  },
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  },
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a7161a80-b79a-4326-b610-686199755da3",
        "rule_id": "8a1d4831-3ce6-4859-9891-28931fa6101d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.501Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.259Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"C:\\\\*\" and\n  (process.working_directory : \"?:\\\\\" and not process.working_directory: \"C:\\\\\") and\n  process.parent.name : \"explorer.exe\" and\n  process.name : (\"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\", \"cmd.exe\", \"regsvr32.exe\",\n                  \"cscript.exe\", \"wscript.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Deprecated - Suspicious JAVA Child Process",
        "description": "Identifies suspicious child processes of the Java interpreter process. This may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a JAVA specific vulnerability.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Java Child Process\n\nThis rule identifies a suspicious child process of the Java interpreter process. It may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a Java specific vulnerability.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n- Examine the command line to determine if the command executed is potentially harmful or malicious.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of process and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.lunasec.io/docs/blog/log4j-zero-day/",
          "https://github.com/christophetd/log4shell-vulnerable-app",
          "https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf",
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security",
          "https://www.elastic.co/security-labs/analysis-of-log4shell-cve-2021-45046"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.007",
                    "name": "JavaScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d42448b9-0550-4c7b-860d-d6666b4ef0b5",
        "rule_id": "8acb7614-1d92-4359-bfcf-478b6d9de150",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.503Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.265Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and event.type:(\"start\" or \"process_started\") and process.parent.name:\"java\" and process.name:(\n  bash or dash or sh or tcsh or csh or zsh or ksh or fish or python* or php* or perl or ruby or lua* or openssl or\n  nc or netcat or ncat or telnet or awk or socat or wget or curl\n) and process.args :(\n  whoami or id or uname or cat or hostname or ip or curl or wget or pwd or ls or cd or python* or php* or perl or\n  ruby or lua* or openssl or nc or netcat or ncat or telnet or awk or socat\n)",
        "new_terms_fields": [
          "host.id",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Sudo Privilege Escalation via CVE-2019-14287",
        "description": "This rule monitors for the execution of a suspicious sudo command that is leveraged in CVE-2019-14287 to escalate privileges to root. Sudo does not verify the presence of the designated user ID and proceeds to execute using a user ID that can be chosen arbitrarily. By using the sudo privileges, the command \"sudo -u#-1\" translates to an ID of 0, representing the root user. This exploit may work for sudo versions prior to v1.28.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Use Case: Vulnerability",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.exploit-db.com/exploits/47502"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "99a2055b-b45f-446e-9e5c-0f977afc122e",
        "rule_id": "8af5b42f-8d74-48c8-a8d0-6d14b4197288",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.505Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:20.616Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"sudo\" and process.args == \"-u#-1\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Executable File Creation with Multiple Extensions",
        "description": "Masquerading can allow an adversary to evade defenses and better blend in with the environment. One way it occurs is when the name or location of a file is manipulated as a means of tricking a user into executing what they think is a benign file type but is actually executable code.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.007",
                    "name": "Double File Extension",
                    "reference": "https://attack.mitre.org/techniques/T1036/007/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d7eb9bc0-6620-4193-8107-351d9e1162eb",
        "rule_id": "8b2b3a62-a598-4293-bc14-3d5fa22bb98f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.507Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.492Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"exe\" and\n  file.name regex~ \"\"\".*\\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|gif|jpg|png|bmp|hta|txt|img|iso)\\.exe\"\"\" and\n  not (process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"C:\\\\Users\\\\*\\\\QGIS_SCCM\\\\Files\\\\QGIS-OSGeo4W-*-Setup-x86_64.exe\") and\n       file.path : \"?:\\\\Program Files\\\\QGIS *\\\\apps\\\\grass\\\\*.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Enable Host Network Discovery via Netsh",
        "description": "Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-line tool to weaken the host firewall settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enable Host Network Discovery via Netsh\n\nThe Windows Defender Firewall is a native component that provides host-based, two-way network traffic filtering for a device and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can enable Network Discovery on the Windows firewall to find other systems present in the same network. Systems with this setting enabled will communicate with other systems using broadcast messages, which can be used to identify targets for lateral movement. This rule looks for the setup of this setting using the netsh utility.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the Administrator is aware of the activity and there are justifications for this configuration.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Disable Network Discovery:\n    - Using netsh: `netsh advfirewall firewall set rule group=\"Network Discovery\" new enable=No`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Host Windows Firewall planned system administration changes."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0a5d8c8f-9110-4092-84c6-aaa3956effb0",
        "rule_id": "8b4f0816-6a65-4630-86a6-c21c179c0d09",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.511Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.495Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.name : \"netsh.exe\" and\nprocess.args : (\"firewall\", \"advfirewall\") and process.args : \"group=Network Discovery\" and process.args : \"enable=Yes\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Child Process of dns.exe",
        "description": "Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, which may indicate activity related to remote code execution or other forms of exploitation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Child Process of dns.exe\n\nSIGRed (CVE-2020-1350) is a wormable, critical vulnerability in the Windows DNS server that affects Windows Server versions 2003 to 2019 and can be triggered by a malicious DNS response. Because the service is running in elevated privileges (SYSTEM), an attacker that successfully exploits it is granted Domain Administrator rights. This can effectively compromise the entire corporate infrastructure.\n\nThis rule looks for unusual children of the `dns.exe` process, which can indicate the exploitation of the SIGRed or a similar remote code execution vulnerability in the DNS server.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes.\n  - Any suspicious or abnormal child process spawned from dns.exe should be carefully reviewed and investigated. It's impossible to predict what an adversary may deploy as the follow-on process after the exploit, but built-in discovery/enumeration utilities should be top of mind (`whoami.exe`, `netstat.exe`, `systeminfo.exe`, `tasklist.exe`).\n  - Built-in Windows programs that contain capabilities used to download and execute additional payloads should also be considered. This is not an exhaustive list, but ideal candidates to start out would be: `mshta.exe`, `powershell.exe`, `regsvr32.exe`, `rundll32.exe`, `wscript.exe`, `wmic.exe`.\n  - If a denial-of-service (DoS) exploit is successful and DNS Server service crashes, be mindful of potential child processes related to `werfault.exe` occurring.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the host during the past 48 hours.\n- Check whether the server is vulnerable to CVE-2020-1350.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore the compromised server to a clean state.\n- Install the latest patches on systems that run Microsoft DNS Server.\n- Consider the implementation of a patch management system, such as the Windows Server Update Services (WSUS).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Werfault.exe will legitimately spawn when dns.exe crashes, but the DNS service is very stable and so this is a low occurring event. Denial of Service (DoS) attempts by intentionally crashing the service will also cause werfault.exe to spawn."
        ],
        "references": [
          "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/",
          "https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/",
          "https://github.com/maxpl0it/CVE-2020-1350-DoS",
          "https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f74ea4dc-4470-4fe7-ad09-424cc6dce7ef",
        "rule_id": "8c37dc0e-e3ac-4c97-8aa0-cf6a9122de45",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.513Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.271Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"dns.exe\" and\n  not process.name : \"conhost.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Hping Process Activity",
        "description": "Hping ran on a Linux host. Hping is a FOSS command-line packet analyzer and has the ability to construct network packets for a wide variety of network security testing applications, including scanning and firewall auditing.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Normal use of hping is uncommon apart from security testing and research. Use by non-security engineers is very uncommon."
        ],
        "references": [
          "https://en.wikipedia.org/wiki/Hping"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "82f8fda3-3e49-4fae-a01e-a73df4ad951f",
        "rule_id": "90169566-2260-4824-b8e4-8615c3b4ed52",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.519Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.278Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name in (\"hping\", \"hping2\", \"hping3\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Keychain Password Retrieval via Command Line",
        "description": "Adversaries may collect keychain storage data from a system to in order to acquire credentials. Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Applications for password management."
        ],
        "references": [
          "https://www.netmeister.org/blog/keychain-passwords.html",
          "https://github.com/priyankchheda/chrome_password_grabber/blob/master/chrome.py",
          "https://ss64.com/osx/security.html",
          "https://www.intezer.com/blog/research/operation-electrorat-attacker-creates-fake-companies-to-drain-your-crypto-wallets/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.001",
                    "name": "Keychain",
                    "reference": "https://attack.mitre.org/techniques/T1555/001/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.003",
                    "name": "Credentials from Web Browsers",
                    "reference": "https://attack.mitre.org/techniques/T1555/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ce3079e7-e677-4495-ad86-dd888f00683f",
        "rule_id": "9092cd6c-650f-4fa3-8a8a-28256c7489c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.521Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.512Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.action == \"exec\" and\n process.name : \"security\" and\n process.args : (\"-wa\", \"-ga\") and process.args : (\"find-generic-password\", \"find-internet-password\") and\n process.command_line : (\"*Chrome*\", \"*Chromium*\", \"*Opera*\", \"*Safari*\", \"*Brave*\", \"*Microsoft Edge*\", \"*Firefox*\") and\n not process.parent.executable : \"/Applications/Keeper Password Manager.app/Contents/Frameworks/Keeper Password Manager Helper*/Contents/MacOS/Keeper Password Manager Helper*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Successful SSH Brute Force Attack",
        "description": "Identifies multiple SSH login failures followed by a successful one from the same source address. Adversaries can attempt to login into multiple users with a common or known password to gain access to accounts.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Successful SSH Brute Force Attack\n\nThe rule identifies consecutive SSH login failures followed by a successful login from the same source IP address to the same target host indicating a successful attempt of brute force password guessing.\n\n#### Possible investigation steps\n\n- Investigate the login failure user name(s).\n- Investigate the source IP address of the failed ssh login attempt(s).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Infrastructure or availability issue.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Ensure active session(s) on the host(s) are terminated as the attacker could have gained initial access to the system(s).\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 11,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Auditbeat\n- Filebeat\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete Setup and Run Auditbeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete Setup and Run Filebeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the Filebeat System Module to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "be14cfb9-617d-4f58-9f4a-8887ff403dbf",
        "rule_id": "8cb84371-d053-4f4f-bce0-c74990e28f28",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.515Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.227Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"failure\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ] with runs=10\n\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"success\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ]",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via PKEXEC",
        "description": "Identifies an attempt to exploit a local privilege escalation in polkit pkexec (CVE-2021-4034) via unsecure environment variable injection. Successful exploitation allows an unprivileged user to escalate to the root user.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://seclists.org/oss-sec/2022/q1/80",
          "https://haxx.in/files/blasty-vs-pkexec.c"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.007",
                    "name": "Path Interception by PATH Environment Variable",
                    "reference": "https://attack.mitre.org/techniques/T1574/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "37533424-2987-4fd5-bc93-41c881204c78",
        "rule_id": "8da41fc9-7735-4b24-9cc6-c78dfc9fc9c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.517Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:13.275Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and file.path : \"/*GCONV_PATH*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious SolarWinds Child Process",
        "description": "A suspicious SolarWinds child process was detected, which may indicate an attempt to execute malicious programs.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted SolarWinds child processes, verify process details such as network connections and file writes."
        ],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html",
          "https://github.com/mandiant/sunburst_countermeasures/blob/main/rules/SUNBURST/hxioc/SUNBURST%20SUSPICIOUS%20CHILD%20PROCESSES%20(METHODOLOGY).ioc"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "840f3cff-8998-4de9-a1da-43280ac9edfa",
        "rule_id": "93b22c0a-06a0-4131-b830-b10d5e166ff4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.524Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:16.527Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name: (\"SolarWinds.BusinessLayerHost.exe\", \"SolarWinds.BusinessLayerHostx64.exe\") and\n not (\n    process.name : (\n        \"APMServiceControl*.exe\",\n        \"ExportToPDFCmd*.Exe\",\n        \"SolarWinds.Credentials.Orion.WebApi*.exe\",\n        \"SolarWinds.Orion.Topology.Calculator*.exe\",\n        \"Database-Maint.exe\",\n        \"SolarWinds.Orion.ApiPoller.Service.exe\",\n        \"WerFault.exe\",\n        \"WerMgr.exe\",\n        \"SolarWinds.BusinessLayerHost.exe\",\n        \"SolarWinds.BusinessLayerHostx64.exe\",\n        \"SolarWinds.Topology.Calculator.exe\",\n        \"SolarWinds.Topology.Calculatorx64.exe\",\n        \"SolarWinds.APM.RealTimeProcessPoller.exe\") and\n    process.code_signature.trusted == true\n ) and\n not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\ARP.EXE\", \"?:\\\\Windows\\\\SysWOW64\\\\lodctr.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\unlodctr.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Suspicious Script with Clipboard Retrieval Capabilities",
        "description": "Detects PowerShell scripts that can get the contents of the clipboard, which attackers can abuse to retrieve sensitive information like credentials, messages, etc.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Clipboard Retrieval Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to get the contents of the clipboard with the goal of stealing credentials and other valuable information, such as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users are unlikely to use scripting utilities to capture contents of the clipboard, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-clipboard",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-ClipboardContents.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5aa6bf24-60ff-44b5-a7af-3b019fae0590",
        "rule_id": "92984446-aefb-4d5e-ad12-598042ca80ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.522Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:10.234Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\program?files\\\\powershell\\\\?\\\\Modules\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program?Files\\\\WindowsPowerShell\\\\Modules\\\\*.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  (powershell.file.script_block_text : (\n    \"Windows.Clipboard\" or\n    \"Windows.Forms.Clipboard\" or\n    \"Windows.Forms.TextBox\"\n   ) and\n   powershell.file.script_block_text : (\n    \"]::GetText\" or\n    \".Paste()\"\n  )) or powershell.file.script_block_text : \"Get-Clipboard\" and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.path : C\\:\\\\Program?Files\\\\WindowsPowerShell\\\\*Modules*.ps1 and\n    file.name : (\"Convert-ExcelRangeToImage.ps1\" or \"Read-Clipboard.ps1\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Windows Firewall Disabled via PowerShell",
        "description": "Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade network constraints, like internet and network lateral communication restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Firewall Disabled via PowerShell\n\nWindows Defender Firewall is a native component that provides host-based, two-way network traffic filtering for a device and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can disable the Windows firewall or its rules to enable lateral movement and command and control activity.\n\nThis rule identifies patterns related to disabling the Windows firewall or its rules using the `Set-NetFirewallProfile` PowerShell cmdlet.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user is an administrator and is legitimately performing troubleshooting.\n- In case of an allowed benign true positive (B-TP), assess adding rules to allow needed traffic and re-enable the firewall.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Re-enable the firewall with its desired configurations.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "Windows Firewall can be disabled by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Windows Profile being disabled by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/netsecurity/set-netfirewallprofile?view=windowsserver2019-ps",
          "https://www.tutorialspoint.com/how-to-get-windows-firewall-profile-settings-using-powershell",
          "http://powershellhelp.space/commands/set-netfirewallrule-psv5.php",
          "http://woshub.com/manage-windows-firewall-powershell/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ca0ef21a-57a8-4f48-9e21-ae4cd040b2b8",
        "rule_id": "f63c8e3c-d396-404f-b2ea-0379d3942d73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:14.470Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  process.args : \"*Set-NetFirewallProfile*\" and\n  process.args : \"*-Enabled*\" and process.args : \"*False*\" and\n  process.args : (\"*-All*\", \"*Public*\", \"*Domain*\", \"*Private*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Persistent Scripts in the Startup Directory",
        "description": "Identifies script engines creating files in the Startup folder, or the creation of script files in the Startup folder. Adversaries may abuse this technique to maintain persistence in an environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Performance\n\nThis rule may have low to medium performance impact due to the generic nature of VBS and JS scripts being loaded by Windows script engines.\n\n### Investigating Persistent Scripts in the Startup Directory\n\nThe Windows Startup folder is a special folder in Windows. Programs added to this folder are executed during account logon, without user interaction, providing an excellent way for attackers to maintain persistence.\n\nThis rule looks for shortcuts created by wscript.exe or cscript.exe, or js/vbs scripts created by any process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious Startup Shell Folder Modification - c8b150f0-0164-475b-a75e-74b47800a9ff\n- Startup Folder Persistence via Unsigned Process - 2fba96c0-ade5-4bce-b92f-a5df2509da3f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  },
                  {
                    "id": "T1547.009",
                    "name": "Shortcut Modification",
                    "reference": "https://attack.mitre.org/techniques/T1547/009/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4789bb58-d16c-4012-96bc-cbebd1a592be",
        "rule_id": "f7c4dc5a-a58d-491d-9f14-9b66507121c0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.528Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.213Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n\n  /* Call attention to file extensions that may be used for malicious purposes */\n  /* Optionally, Windows scripting engine processes targeting shortcut files */\n  (\n    file.extension : (\"vbs\", \"vbe\", \"wsh\", \"wsf\", \"js\") or\n    process.name : (\"wscript.exe\", \"cscript.exe\")\n  ) and not (startsWith(user.domain, \"NT\") or endsWith(user.domain, \"NT\"))\n\n  /* Identify files created or changed in the startup folder */\n  and file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Exchange Worker Spawning Suspicious Processes",
        "description": "Identifies suspicious processes being spawned by the Microsoft Exchange Server worker process (w3wp). This activity may indicate exploitation activity or access to an existing web shell backdoor.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers",
          "https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities",
          "https://discuss.elastic.co/t/detection-and-response-for-hafnium-activity/266289"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a8bbdd81-f7f9-40b9-b1ed-bc9497adcd71",
        "rule_id": "f81ee52c-297e-46d9-9205-07e66931df26",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.530Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.511Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"w3wp.exe\" and process.parent.args : \"MSExchange*AppPool\" and\n  (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n  ?process.pe.original_file_name in (\"cmd.exe\", \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Modification of AmsiEnable Registry Key",
        "description": "Identifies modifications of the AmsiEnable registry key to 0, which disables the Antimalware Scan Interface (AMSI). An adversary can modify this key to disable AMSI protections.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of AmsiEnable Registry Key\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product on a machine. AMSI integrates with multiple Windows components, ranging from User Account Control (UAC) to VBA macros and PowerShell.\n\nSince AMSI is widely used across security products for increased visibility, attackers can disable it to evade detections that rely on it.\n\nThis rule monitors the modifications to the Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable registry key.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the execution of scripts and macros after the registry modification.\n- Retrieve scripts or Microsoft Office files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences on other hosts.\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team as these modifications expose the host to malware infections.\n\n### Related rules\n\n- Microsoft Windows Defender Tampering - fe794edd-487f-4a90-b285-3ee54f2af2d3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Delete or set the key to its default value.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://hackinparis.com/data/slides/2019/talks/HIP2019-Dominic_Chell-Cracking_The_Perimeter_With_Sharpshooter.pdf",
          "https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e5385340-1068-4169-b20d-b5a5c4d609cc",
        "rule_id": "f874315d-5188-4b4a-8521-d1c73093a7e4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.531Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.336Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"AmsiEnable\" and registry.data.strings: (\"0\", \"0x00000000\")\n\n  /*\n    Full registry key path omitted due to data source variations:\n    HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows Script\\\\Settings\\\\AmsiEnable\"\n  */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Ingress Transfer via Windows BITS",
        "description": "Identifies downloads of executable and archive files via the Windows Background Intelligent Transfer Service (BITS). Adversaries could leverage Windows BITS transfer jobs to download remote payloads.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Ingress Transfer via Windows BITS\n\nWindows Background Intelligent Transfer Service (BITS) is a technology that allows the transfer of files between a client and a server, which makes it a dual-use mechanism, being used by both legitimate apps and attackers. When malicious applications create BITS jobs, files are downloaded or uploaded in the context of the service host process, which can bypass security protections, and it helps to obscure which application requested the transfer.\n\nThis rule identifies such abuse by monitoring for file renaming events involving \"svchost.exe\" and \"BIT*.tmp\" on Windows systems.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Gain context into the BITS transfer.\n  - Try to determine the process that initiated the BITS transfer.\n    - Search `bitsadmin.exe` processes and examine their command lines.\n    - Look for unusual processes loading `Bitsproxy.dll` and other BITS-related DLLs.\n  - Try to determine the origin of the file.\n    - Inspect network connections initiated by `svchost.exe`.\n    - Inspect `Microsoft-Windows-Bits-Client/Operational` Windows logs, specifically the event ID 59, for unusual events.\n      - Velociraptor can be used to extract these entries using the [bitsadmin artifact](https://docs.velociraptor.app/exchange/artifacts/pages/bitsadmin/).\n    - Check the reputation of the remote server involved in the BITS transfer, such as its IP address or domain, using threat intelligence platforms or online reputation services.\n    - Check if the domain is newly registered or unexpected.\n    - Use the identified domain as an indicator of compromise (IoCs) to scope other compromised hosts in the environment.\n  - [BitsParser](https://github.com/fireeye/BitsParser) can be used to parse BITS database files to extract BITS job information.\n- Examine the details of the dropped file, and whether it was executed.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the involved executables using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- Known false positives for the rule include legitimate software and system updates that use BITS for downloading files.\n\n### Related Rules\n\n- Persistence via BITS Job Notify Cmdline - c3b915e0-22f3-4bf7-991d-b643513c722f\n- Unsigned BITS Service Client Process - 9a3884d0-282d-45ea-86ce-b9c81100f026\n- Bitsadmin Activity - 8eec4df1-4b4b-4502-b6c3-c788714604c9\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore the affected system to its operational state by applying any necessary patches, updates, or configuration changes.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1197/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.Ext.original.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "47af5dce-2d17-4621-b499-3319fa0f2630",
        "rule_id": "f95972d3-c23b-463b-89a8-796b3f369b49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.533Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.592Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.action == \"rename\" and\n  process.name : \"svchost.exe\" and file.Ext.original.name : \"BIT*.tmp\" and \n  (file.extension : (\"exe\", \"zip\", \"rar\", \"bat\", \"dll\", \"ps1\", \"vbs\", \"wsh\", \"js\", \"vbe\", \"pif\", \"scr\", \"cmd\", \"cpl\") or\n   file.Ext.header_bytes : \"4d5a*\") and \n \n  /* noisy paths, for hunting purposes you can use the same query without the following exclusions */\n  not file.path : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Windows\\\\*\", \"?:\\\\ProgramData\\\\*\\\\*\") and \n \n  /* lot of third party SW use BITS to download executables with a long file name */\n  not length(file.name) > 30 and\n  not file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp*\\\\wct*.tmp\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Adobe\\\\ARM\\\\*\\\\RdrServicesUpdater*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Adobe\\\\ARM\\\\*\\\\AcroServicesUpdater*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Docker Desktop Installer\\\\update-*.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Privileged Account Brute Force",
        "description": "Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Privileged Account Brute Force\n\nAdversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Without knowledge of the password for an account, an adversary may opt to guess the password using a repetitive or iterative mechanism systematically. More details can be found [here](https://attack.mitre.org/techniques/T1110/001/).\n\nThis rule identifies potential password guessing/brute force activity from a single address against an account that contains the `admin` pattern on its name, which is likely a highly privileged account.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user name.\n  - Prioritize the investigation if the account is critical or has administrative privileges over the domain.\n- Investigate the source IP address of the failed Network Logon attempts.\n  - Identify whether these attempts are coming from the internet or are internal.\n- Investigate other alerts associated with the involved users and source host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n- Check whether the involved credentials are used in automation or scheduled tasks.\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n- Examine the source host for derived artifacts that indicate compromise:\n  - Observe and collect information about the following activities in the alert source host:\n    - Attempts to contact external domains and addresses.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the host which is the source of this activity.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Domain trust relationship issues.\n- Infrastructure or availability issues.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the source host to prevent further post-compromise behavior.\n- If the asset is exposed to the internet with RDP or other remote services available, take the necessary measures to restrict access to the asset. If not possible, limit the access via the firewall to only the needed IP addresses. Also, ensure the system uses robust authentication mechanisms and is patched regularly.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Status",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "34854d62-bcd7-4c17-8078-266e1dcc86c2",
        "rule_id": "f9790abf-bd0c-45f9-8b5f-d0b74015e029",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.535Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.340Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and user.name : \"*admin*\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Remote File Copy to a Hidden Share",
        "description": "Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data staging activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e9fbc4ac-ad1f-4f0b-b534-54a70fba717b",
        "rule_id": "fa01341d-6662-426b-9d0c-6d81e33c8a9d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.537Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.598Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"cmd.exe\", \"powershell.exe\", \"xcopy.exe\") and\n    process.args : (\"copy*\", \"move*\", \"cp\", \"mv\") or\n    process.name : \"robocopy.exe\"\n  ) and process.args : \"*\\\\\\\\*\\\\*$*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential External Linux SSH Brute Force Detected",
        "description": "Identifies multiple external consecutive login failures targeting a user account from the same source address within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to these accounts.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential External Linux SSH Brute Force Detected\n\nThe rule identifies consecutive SSH login failures targeting a user account from the same source IP address to the same target host indicating brute force login attempts.\n\nThis rule will generate a lot of noise for systems with a front-facing SSH service, as adversaries scan the internet for remotely accessible SSH services and try to brute force them to gain unauthorized access. \n\nIn case this rule generates too much noise and external brute forcing is of not much interest, consider turning this rule off and enabling \"Potential Internal Linux SSH Brute Force Detected\" to detect internal brute force attempts.\n\n#### Possible investigation steps\n\n- Investigate the login failure user name(s).\n- Investigate the source IP address of the failed ssh login attempt(s).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Infrastructure or availability issue.\n\n### Related Rules\n\n- Potential Internal Linux SSH Brute Force Detected - 1c27fa22-7727-4dd3-81c0-de6da5555feb\n- Potential SSH Password Guessing - 8cb84371-d053-4f4f-bce0-c74990e28f28\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete Setup and Run Filebeat information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the Filebeat System Module to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9ab3e74d-f838-436f-a92c-e42e1f22f168",
        "rule_id": "fa210b61-b627-4e5e-86f4-17e8270656ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.538Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.344Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   not cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Reverse Shell via Suspicious Binary",
        "description": "This detection rule detects the creation of a shell through a chain consisting of the execution of a suspicious binary (located in a commonly abused location or executed manually) followed by a network event and ending with a shell being spawned. Stageless reverse tcp shells display this behaviour. Attackers may spawn reverse shells to establish persistence onto a target system.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8a66d38d-3df2-4795-844f-9258fe5efa93",
        "rule_id": "fa3a59dc-33c3-43bf-80a9-e8437a922c7f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.216Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.executable : (\n  \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n  \"/etc/crontab\", \"/etc/cron.*\", \"/etc/update-motd.d/*\", \"/usr/lib/update-notifier/*\",\n  \"/boot/*\", \"/srv/*\", \"/run/*\", \"/root/*\", \"/etc/rc.local\"\n   ) and\n  process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not\n  process.name : (\"curl\", \"wget\", \"ping\", \"apt\", \"dpkg\", \"yum\", \"rpm\", \"dnf\", \"dockerd\") ]\n[ network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n  process.executable : (\n  \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n  \"/etc/crontab\", \"/etc/cron.*\", \"/etc/update-motd.d/*\", \"/usr/lib/update-notifier/*\",\n  \"/boot/*\", \"/srv/*\", \"/run/*\", \"/root/*\", \"/etc/rc.local\"\n   ) and destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" ]\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n  process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and \n  process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Disabling of AppArmor",
        "description": "This rule monitors for potential attempts to disable AppArmor. AppArmor is a Linux security module that enforces fine-grained access control policies to restrict the actions and resources that specific applications and processes can access. Adversaries may disable security tools to avoid possible detection of their tools and activities.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c1112905-62b6-4f77-803e-8556d5ad5a65",
        "rule_id": "fac52c69-2646-4e79-89c0-fd7653461010",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.542Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.716Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and (\n  (process.name == \"systemctl\" and process.args in (\"stop\", \"disable\", \"kill\") and process.args in (\"apparmor\", \"apparmor.service\")) or\n  (process.name == \"service\" and process.args == \"apparmor\" and process.args == \"stop\") or \n  (process.name == \"chkconfig\" and process.args == \"apparmor\" and process.args == \"off\") or\n  (process.name == \"ln\" and process.args : \"/etc/apparmor.d/*\" and process.args == \"/etc/apparmor.d/disable/\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass Attempt via Elevated COM Internet Explorer Add-On Installer",
        "description": "Identifies User Account Control (UAC) bypass attempts by abusing an elevated COM Interface to launch a malicious program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://swapcontext.blogspot.com/2020/11/uac-bypasses-from-comautoapprovallist.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f89fd614-8b1b-471a-b7e1-7576605f119f",
        "rule_id": "fc7c0fa4-8f03-4b3e-8336-c5feab0be022",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.544Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.353Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.executable : \"C:\\\\*\\\\AppData\\\\*\\\\Temp\\\\IDC*.tmp\\\\*.exe\" and\n process.parent.name : \"ieinstal.exe\" and process.parent.args : \"-Embedding\"\n\n /* uncomment once in winlogbeat */\n /* and not (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Svchost spawning Cmd",
        "description": "Identifies a suspicious parent child process relationship with cmd.exe descending from svchost.exe",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Svchost spawning Cmd\n\nThe Service Host process (SvcHost) is a system process that can host one, or multiple, Windows services in the Windows NT family of operating systems. Note that `Svchost.exe` is reserved for use by the operating system and should not be used by non-Windows services.\n\nThis rule looks for the creation of the `cmd.exe` process with `svchost.exe` as its parent process. This is an unusual behavior that can indicate the masquerading of a malicious process as `svchost.exe` or exploitation for privilege escalation.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 418,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://nasbench.medium.com/demystifying-the-svchost-exe-process-and-its-command-line-options-508e9114e747"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c1036739-f502-49d7-b28e-71f1abdffae3",
        "rule_id": "fd7a6052-58fa-4397-93c3-4795249ccfa2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.547Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:11.219Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and process.parent.name:\"svchost.exe\" and\nprocess.name:(\"cmd.exe\" or \"Cmd.exe\" or \"CMD.EXE\") and\nnot process.command_line : \"\\\"cmd.exe\\\" /C sc control hptpsmarthealthservice 211\"",
        "new_terms_fields": [
          "host.id",
          "process.command_line",
          "user.id"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.args": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\silcollector.cmd"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.command_line": {
                  "case_insensitive": true,
                  "value": "*?:\\\\Program Files\\\\Npcap\\\\CheckStatus.bat*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.command_line": {
                  "case_insensitive": true,
                  "value": "*?:\\\\Program Files*\\\\Pulseway\\\\watchdog.bat*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.command_line": {
                  "case_insensitive": true,
                  "value": "cmd /C \".\\\\inetsrv\\\\iissetup.exe /keygen \""
                }
              }
            }
          }
        ],
        "language": "kuery"
      },
      {
        "name": "Potential Application Shimming via Sdbinst",
        "description": "The Application Shim was created to allow for backward compatibility of software as the operating system codebase changes over time. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.011",
                    "name": "Application Shimming",
                    "reference": "https://attack.mitre.org/techniques/T1546/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.011",
                    "name": "Application Shimming",
                    "reference": "https://attack.mitre.org/techniques/T1546/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c0647b0f-61e3-4aa9-889a-422cc7deec06",
        "rule_id": "fd4a992d-6130-4802-9ff8-829b89ae801f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.546Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.604Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"sdbinst.exe\" and\n  process.args : \"?*\" and\n  not (process.args : \"-m\" and process.args : \"-bg\") and\n  not process.args : \"-mm\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "System Binary Moved or Copied",
        "description": "This rule monitors for the copying or moving of a system binary. Adversaries may copy/move and rename system binaries to evade detection. Copying a system binary to a different location should not occur often, so if it does, the activity should be investigated.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 13,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://intezer.com/blog/research/kaiji-new-chinese-linux-malware-turning-to-golang/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              },
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.Ext.original.path",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "810a0aaf-9cec-4dd9-82b8-0e7bc05da47c",
        "rule_id": "fda1d332-5e08-4f27-8a9b-8c802e3292a6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.549Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.719Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and process.name != null and\nfile.Ext.original.path : (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/bin/update-alternatives\", \"/bin/update-alternatives\", \"/usr/sbin/update-alternatives\",\n    \"/sbin/update-alternatives\", \"/usr/bin/pip3\", \"/bin/pip3\", \"/usr/local/bin/pip3\", \"/usr/local/bin/node\",\n    \"/bin/node\", \"/usr/bin/node\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/pip\", \"/bin/pip\",\n    \"/usr/local/bin/pip\", \"/usr/libexec/platform-python\", \"/usr/bin/platform-python\", \"/bin/platform-python\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\", \"/sbin/sshd\", \"/usr/local/sbin/sshd\", \"/usr/sbin/crond\", \"/sbin/crond\",\n    \"/usr/local/sbin/crond\", \"/usr/sbin/gdm\"\n  ) or\n  process.name like (\n    \"python*\", \"packagekitd\", \"systemd\", \"ln\", \"platform-python\", \"dnf_install\", \"runc\", \"apt-get\", \"ssm-agent-worker\",\n    \"convert-usrmerge\", \"updatenow.static-cpanelsync\", \"apk\", \"exe\", \"php\", \"containerd-shim-runc-v2\", \"dpkg\", \"sed\",\n    \"platform-python*\", \"gedit\", \"crond\", \"sshd\", \"ruby\", \"sudo\", \"chainctl\", \"update-alternatives\", \"pip*\"\n  ) or\n  file.Ext.original.path : (\n    \"/bin/*.tmp\", \"/usr/bin/*.tmp\", \"/usr/local/bin/*.tmp\", \"/sbin/*.tmp\", \"/usr/sbin/*.tmp\", \"/usr/local/sbin/*.tmp\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Kerberos Ticket Dump",
        "description": "Detects PowerShell scripts that have the capability of dumping Kerberos tickets from LSA, which potentially indicates an attacker's attempt to acquire credentials for lateral movement.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Kerberos Ticket Dump\n\nKerberos is an authentication protocol that relies on tickets to grant access to network resources. Adversaries may abuse this protocol to acquire credentials for lateral movement within a network.\n\nThis rule indicates the use of scripts that contain code capable of dumping Kerberos tickets, which can indicate potential PowerShell abuse for credential theft.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate if the script was executed, and if so, which account was targeted.\n- Identify the account involved and contact the owner to confirm whether they are aware of this activity.\n- Check if the script has any other functionality that can be potentially malicious.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate other potentially compromised accounts and hosts. Review login events (like 4624) for suspicious events involving the subject and target accounts.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination of file path and user ID conditions.\n\n### Related Rules\n\n- PowerShell Kerberos Ticket Request - eb610e70-f9e6-4949-82b9-f1c5bcd37c39\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Disable or limit involved accounts during the investigation and response.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/MzHmO/PowershellKerberos/blob/main/dumper.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "735bdf4d-3c0e-484c-a5b7-ce70913c0161",
        "rule_id": "fddff193-48a3-484d-8d35-90bb3d323a56",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.551Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:25.811Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"LsaCallAuthenticationPackage\" and\n    (\n      \"KerbRetrieveEncodedTicketMessage\" or\n      \"KerbQueryTicketCacheMessage\" or\n      \"KerbQueryTicketCacheExMessage\" or\n      \"KerbQueryTicketCacheEx2Message\" or\n      \"KerbRetrieveTicketMessage\" or\n      \"KerbDecryptDataMessage\"\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "PowerShell Script with Password Policy Discovery Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to remote execution activities using WinRM. Attackers can abuse WinRM to perform lateral movement using built-in tools.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Execution",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1201",
                "name": "Password Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1201/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4159b23b-ded1-4106-bd57-e74238026d03",
        "rule_id": "fe25d5bc-01fa-494a-95ff-535c29cc4c96",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.722Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category: \"process\" and host.os.type:windows and\n(\n  powershell.file.script_block_text: (\n    \"Get-ADDefaultDomainPasswordPolicy\" or\n    \"Get-ADFineGrainedPasswordPolicy\" or\n    \"Get-ADUserResultantPasswordPolicy\" or\n    \"Get-DomainPolicy\" or\n    \"Get-GPPPassword\" or\n    \"Get-PassPol\"\n  )\n  or\n  powershell.file.script_block_text: (\n    (\"defaultNamingContext\" or \"ActiveDirectory.DirectoryContext\" or \"ActiveDirectory.DirectorySearcher\") and\n    (\n      (\n        \".MinLengthPassword\" or\n        \".MinPasswordAge\" or\n        \".MaxPasswordAge\"\n      ) or\n      (\n        \"minPwdAge\" or\n        \"maxPwdAge\" or\n        \"minPwdLength\"\n      ) or\n      (\n        \"msDS-PasswordSettings\"\n      )\n    )\n  )\n) and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )\n  and not \n  (\n    powershell.file.script_block_text : (\"43c15630-959c-49e4-a977-758c5cc93408\" and \"CmdletsToExport\" and \"ActiveDirectory.Types.ps1xml\")\n  )\n  and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Microsoft Windows Defender Tampering",
        "description": "Identifies when one or more features on Microsoft Defender are disabled. Adversaries may disable or tamper with Microsoft Defender features to evade detection and conceal malicious behavior.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Microsoft Windows Defender Tampering\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows, which makes it popular across multiple environments. Disabling it is a common step in threat actor playbooks.\n\nThis rule monitors the registry for modifications that disable Windows Defender features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine which features have been disabled, and check if this operation is done under change management and approved according to the organization's policy.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity, the configuration is justified (for example, it is being used to deploy other security solutions or troubleshooting), and no other suspicious activity has been observed.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Disabling Windows Defender Security Settings via PowerShell - c8cccb06-faf2-4cd5-886e-2c9636cfcb87\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Take actions to restore the appropriate Windows Defender antivirus configurations.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "Legitimate Windows Defender configuration changes"
        ],
        "references": [
          "https://thedfirreport.com/2021/10/18/icedid-to-xinglocker-ransomware-in-24-hours/",
          "https://www.tenforums.com/tutorials/32236-enable-disable-microsoft-defender-pua-protection-windows-10-a.html",
          "https://www.tenforums.com/tutorials/104025-turn-off-core-isolation-memory-integrity-windows-10-a.html",
          "https://www.tenforums.com/tutorials/105533-enable-disable-windows-defender-exploit-protection-settings.html",
          "https://www.tenforums.com/tutorials/123792-turn-off-tamper-protection-microsoft-defender-antivirus.html",
          "https://www.tenforums.com/tutorials/51514-turn-off-microsoft-defender-periodic-scanning-windows-10-a.html",
          "https://www.tenforums.com/tutorials/3569-turn-off-real-time-protection-microsoft-defender-antivirus.html",
          "https://www.tenforums.com/tutorials/99576-how-schedule-scan-microsoft-defender-antivirus-windows-10-a.html",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9abc556a-28a7-413f-abdb-99109b2ae7e3",
        "rule_id": "fe794edd-487f-4a90-b285-3ee54f2af2d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.555Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.357Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and process.executable != null and\n  (\n    (\n      registry.value : (\n        \"PUAProtection\", \"DisallowExploitProtectionOverride\", \"TamperProtection\", \"EnableControlledFolderAccess\",\n        \"SpynetReporting\", \"SubmitSamplesConsent\"\n      ) and registry.data.strings : (\"0\", \"0x00000000\")\n    ) or\n    (\n      registry.path : (\n        \"DisableAntiSpyware\", \"DisableRealtimeMonitoring\", \"DisableIntrusionPreventionSystem\", \"DisableScriptScanning\",\n        \"DisableIOAVProtection\", \"DisableEnhancedNotifications\", \"DisableBlockAtFirstSeen\", \"DisableBehaviorMonitoring\"\n      ) and registry.data.strings : (\"1\", \"0x00000001\")\n    )\n  ) and\n  not process.executable : (\n    \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \n    \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\", \n    \"?:\\\\Windows\\\\System32\\\\DeviceEnroller.exe\", \n    \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\tmuninst.exe\"\n  )\n\n/*\n    Full registry key paths omitted due to data source variations:\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableRealtimeMonitoring\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIntrusionPreventionSystem\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableScriptScanning\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIOAVProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Reporting\\\\DisableEnhancedNotifications\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\DisableBlockAtFirstSeen\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableBehaviorMonitoring\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\PUAProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender Security Center\\\\App and Browser protection\\\\DisallowExploitProtectionOverride\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Features\\\\TamperProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Windows Defender Exploit Guard\\\\Controlled Folder Access\\\\EnableControlledFolderAccess\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SpynetReporting\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SubmitSamplesConsent\"\n*/",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "LSASS Process Access via Windows API",
        "description": "Identifies access attempts to the LSASS handle, which may indicate an attempt to dump credentials from LSASS memory.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating LSASS Process Access via Windows API\n\nThe Local Security Authority Subsystem Service (LSASS) is a critical Windows component responsible for managing user authentication and security policies. Adversaries may attempt to access the LSASS handle to dump credentials from its memory, which can be used for lateral movement and privilege escalation.\n\nThis rule identifies attempts to access LSASS by monitoring for specific API calls (OpenProcess, OpenThread) targeting the \"lsass.exe\" process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) of the process that accessed the LSASS handle.\n  - Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Determine the first time the process executable was seen in the environment and if this behavior happened in the past.\n  - Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n  - Investigate any abnormal behavior by the subject process, such as network connections, DLLs loaded, registry or file modifications, and any spawned child processes.\n- Assess the access rights (`process.Ext.api.parameters.desired_access`field) requested by the process. This [Microsoft documentation](https://learn.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights) may be useful to help the interpretation.\n- If there are traces of LSASS memory being successfully dumped, investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the executables of the processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions  preferably with a combination of `process.executable`, `process.code_signature.subject_name` and `process.Ext.api.parameters.desired_access_numeric` conditions.\n\n### Related Rules\n\n- Suspicious Lsass Process Access - 128468bf-cab1-4637-99ea-fdf3780a4609\n- Potential Credential Access via DuplicateHandle in LSASS - 02a4576a-7480-4284-9327-548a806b5e48\n- LSASS Memory Dump Handle Access - 208dbe77-01ed-4954-8d44-1e5751cb20de\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 10,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.001/T1003.001.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "Target.process.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.api.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "49775a51-ec36-406c-8a73-35aa88f8ab32",
        "rule_id": "ff4599cb-409f-4910-a239-52e4e6f532ff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.568Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:15.360Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "api where host.os.type == \"windows\" and \n  process.Ext.api.name in (\"OpenProcess\", \"OpenThread\") and Target.process.name : \"lsass.exe\" and \n  not \n  (\n    process.executable : (\n        \"?:\\\\ProgramData\\\\GetSupportService*\\\\Updates\\\\Update_*.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files (x86)\\\\Asiainfo Security\\\\OfficeScan Client\\\\NTRTScan.exe\",\n        \"?:\\\\Program Files (x86)\\\\Blackpoint\\\\SnapAgent\\\\SnapAgent.exe\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Security\\\\EFR\\\\EFRService.exe\",\n        \"?:\\\\Program Files (x86)\\\\CyberCNSAgent\\\\osqueryi.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\vpnagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\aciseagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\vpndownloader.exe\",\n        \"?:\\\\Program Files (x86)\\\\eScan\\\\reload.exe\",\n        \"?:\\\\Program Files (x86)\\\\Google\\\\Update\\\\GoogleUpdate.exe\",\n        \"?:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\*\\\\avp.exe\",\n        \"?:\\\\Program Files (x86)\\\\microsoft intune management extension\\\\microsoft.management.services.intunewindowsagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\Reactive\\\\bin\\\\NableReactiveManagement.exe\",\n        \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\Windows Agent\\\\bin\\\\agent.exe\",\n        \"?:\\\\Program Files (x86)\\\\Tanium\\\\Tanium Client\\\\TaniumClient.exe\",\n        \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*\\\\CCSF\\\\TmCCSF.exe\",\n        \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\TMASutility.exe\",\n        \"?:\\\\Program Files*\\\\Windows Defender\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\EPSecurityService.exe\",\n        \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n        \"?:\\\\Program Files\\\\Common Files\\\\McAfee\\\\AVSolution\\\\mcshield.exe\",\n        \"?:\\\\Program Files\\\\EA\\\\AC\\\\EAAntiCheat.GameService.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\agentbeat.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\metricbeat.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\osqueryd.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\packetbeat.exe\",\n        \"?:\\\\Program Files\\\\ESET\\\\ESET Security\\\\ekrn.exe\",\n        \"?:\\\\Program Files\\\\Fortinet\\\\FortiClient\\\\FortiProxy.exe\",\n        \"?:\\\\Program Files\\\\Fortinet\\\\FortiClient\\\\FortiSSLVPNdaemon.exe\",\n        \"?:\\\\Program Files\\\\Goverlan Inc\\\\GoverlanAgent\\\\GovAgentx64.exe\",\n        \"?:\\\\Program Files\\\\Huntress\\\\HuntressAgent.exe\",\n        \"?:\\\\Program Files\\\\LogicMonitor\\\\Agent\\\\bin\\\\sbshutdown.exe\",\n        \"?:\\\\Program Files\\\\Malwarebytes\\\\Anti-Malware\\\\MBAMService.exe\",\n        \"?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\*\\\\pmfexe.exe\", \n        \"?:\\\\Program Files\\\\Microsoft Security Client\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files\\\\Qualys\\\\QualysAgent\\\\QualysAgent.exe\",\n        \"?:\\\\Program Files\\\\smart-x\\\\controlupagent\\\\version*\\\\cuagent.exe\",\n        \"?:\\\\Program Files\\\\TDAgent\\\\ossec-agent\\\\ossec-agent.exe\",\n        \"?:\\\\Program Files\\\\Topaz OFD\\\\Warsaw\\\\core.exe\",\n        \"?:\\\\Program Files\\\\Trend Micro\\\\Deep Security Agent\\\\netagent\\\\tm_netagent.exe\",\n        \"?:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe\",\n        \"?:\\\\Program Files\\\\Windows Defender Advanced Threat Protection\\\\MsSense.exe\",\n        \"?:\\\\Program Files\\\\Wise\\\\Wise Memory Optimizer\\\\WiseMemoryOptimzer.exe\",\n        \"?:\\\\Windows\\\\AdminArsenal\\\\PDQDeployRunner\\\\*\\\\exec\\\\Sysmon64.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"?:\\\\Windows\\\\System32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n        \"?:\\\\Windows\\\\System32\\\\RtkAudUService64.exe\",\n        \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\tenable_mw_scan_142a90001fb65e0beb1751cc8c63edd0.exe\"\n    ) and not ?process.code_signature.trusted == false\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.api-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "MS Office Macro Security Registry Modifications",
        "description": "Microsoft Office Products offer options for users and developers to control the security settings for running and using Macros. Adversaries may abuse these security settings to modify the default behavior of the Office Application to trust future macros and/or disable security warnings, which could increase their chances of establishing persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating MS Office Macro Security Registry Modifications\n\nMacros are small programs that are used to automate repetitive tasks in Microsoft Office applications. Historically, macros have been used for a variety of reasons -- from automating part of a job, to building entire processes and data flows. Macros are written in Visual Basic for Applications (VBA) and are saved as part of Microsoft Office files.\n\nMacros are often created for legitimate reasons, but they can also be written by attackers to gain access, harm a system, or bypass other security controls such as application allow listing. In fact, exploitation from malicious macros is one of the top ways that organizations are compromised today. These attacks are often conducted through phishing or spear phishing campaigns.\n\nAttackers can convince victims to modify Microsoft Office security settings, so their macros are trusted by default and no warnings are displayed when they are executed. These settings include:\n\n- *Trust access to the VBA project object model* - When enabled, Microsoft Office will trust all macros and run any code without showing a security warning or requiring user permission.\n- *VbaWarnings* - When set to 1, Microsoft Office will trust all macros and run any code without showing a security warning or requiring user permission.\n\nThis rule looks for registry changes affecting the conditions above.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user and check if the change was done manually.\n- Verify whether malicious macros were executed after the registry change.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve recently executed Office documents and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Reset the registry key value.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Explore using GPOs to manage security settings for Microsoft Office macros.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "12bb6a81-e666-414e-9988-92db1495b026",
        "rule_id": "feeed87c-5e95-4339-aef1-47fd79bcfbe3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.570Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:22.729Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : (\"AccessVBOM\", \"VbaWarnings\") and\n    registry.path : (\n        /* Sysmon */\n        \"HKU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"HKU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        /* MDE */\n        \"HKCU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKCU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"HKCU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKCU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        /* Endgame */\n        \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        /* SentinelOne */\n        \"USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\"\n        ) and\n    registry.data.strings : (\"0x00000001\", \"1\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Sudo Token Manipulation via Process Injection",
        "description": "This rule detects potential sudo token manipulation attacks through process injection by monitoring the use of a debugger (gdb) process followed by a successful uid change event during the execution of the sudo process. A sudo token manipulation attack is performed by injecting into a process that has a valid sudo token, which can then be used by attackers to activate their own sudo token. This attack requires ptrace to be enabled in conjunction with the existence of a living process that has a valid sudo token with the same uid as the current user.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/nongiach/sudo_inject"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.008",
                    "name": "Ptrace System Calls",
                    "reference": "https://attack.mitre.org/techniques/T1055/008/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.session_leader.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8822f8b2-7b76-4086-a31a-6879feeef95f",
        "rule_id": "ff9bc8b9-f03b-4283-be58-ee0a16f5a11b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T10:23:16.678Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T10:22:18.615Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.session_leader.entity_id with maxspan=15s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n  process.name == \"gdb\" and process.user.id != \"0\" and process.group.id != \"0\" ]\n[ process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n  process.name == \"sudo\" and process.user.id == \"0\" and process.group.id == \"0\" ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      }
    ],
    "skipped": []
  },
  "errors": [
    {
      "message": "Rule update for rule 8a1b0278-0f9a-487d-96bd-d4833298e87a has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "8a1b0278-0f9a-487d-96bd-d4833298e87a"
        }
      ]
    },
    {
      "message": "Rule update for rule 93075852-b0f5-4b8b-89c3-a226efae5726 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "93075852-b0f5-4b8b-89c3-a226efae5726"
        }
      ]
    },
    {
      "message": "Rule update for rule 9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae9 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae9"
        }
      ]
    },
    {
      "message": "Rule update for rule bf1073bf-ce26-4607-b405-ba1ed8e9e204 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "bf1073bf-ce26-4607-b405-ba1ed8e9e204"
        }
      ]
    },
    {
      "message": "Rule update for rule cd89602e-9db0-48e3-9391-ae3bf241acd8 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "cd89602e-9db0-48e3-9391-ae3bf241acd8"
        }
      ]
    },
    {
      "message": "Rule update for rule 96d11d31-9a79-480f-8401-da28b194608f has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "96d11d31-9a79-480f-8401-da28b194608f"
        }
      ]
    },
    {
      "message": "Rule update for rule a1329140-8de3-4445-9f87-908fb6d824f4 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "a1329140-8de3-4445-9f87-908fb6d824f4"
        }
      ]
    },
    {
      "message": "Rule update for rule debff20a-46bc-4a4d-bae5-5cdd14222795 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "debff20a-46bc-4a4d-bae5-5cdd14222795"
        }
      ]
    },
    {
      "message": "Rule update for rule e052c845-48d0-4f46-8a13-7d0aba05df82 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "e052c845-48d0-4f46-8a13-7d0aba05df82"
        }
      ]
    },
    {
      "message": "Rule update for rule eb9eb8ba-a983-41d9-9c93-a1c05112ca5e has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "eb9eb8ba-a983-41d9-9c93-a1c05112ca5e"
        }
      ]
    },
    {
      "message": "Rule update for rule b9554892-5e0e-424b-83a0-5aef95aa43bf has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "b9554892-5e0e-424b-83a0-5aef95aa43bf"
        }
      ]
    },
    {
      "message": "Rule update for rule 7fb500fa-8e24-4bd1-9480-2a819352602c has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "7fb500fa-8e24-4bd1-9480-2a819352602c"
        }
      ]
    },
    {
      "message": "Rule update for rule 88fdcb8c-60e5-46ee-9206-2663adf1b1ce has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "88fdcb8c-60e5-46ee-9206-2663adf1b1ce"
        }
      ]
    },
    {
      "message": "Rule update for rule ff10d4d8-fea7-422d-afb1-e5a2702369a9 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "ff10d4d8-fea7-422d-afb1-e5a2702369a9"
        }
      ]
    }
  ]
}