#!/usr/bin/env bash
set -euo pipefail

report_step() {
  echo "--- $1"
}

# Ensure we're in the repo root
cd "${KIBANA_DIR:-$(pwd)}"

# Target branch for the PR (set by Buildkite from the schedule's branch; override via BUILDKITE_BRANCH when triggering manually)
TARGET_BRANCH="${BUILDKITE_BRANCH:-main}"
echo "Target branch for PR: $TARGET_BRANCH"

# Capture working tree state before bootstrap so we can detect bootstrap-induced changes
report_step "Capturing pre-bootstrap state"
pre_bootstrap_diff=$(git diff --no-ext-diff 2>/dev/null || true)
pre_bootstrap_untracked=$(git status -s -u 2>/dev/null || true)

report_step "Bootstrap Kibana"
.buildkite/scripts/bootstrap.sh

# Fail if bootstrap changed anything; only metadata update changes should be committed
report_step "Verifying bootstrap did not change files"
post_bootstrap_diff=$(git diff --no-ext-diff 2>/dev/null || true)
post_bootstrap_untracked=$(git status -s -u 2>/dev/null || true)
if [[ "$pre_bootstrap_diff" != "$post_bootstrap_diff" || "$pre_bootstrap_untracked" != "$post_bootstrap_untracked" ]]; then
  echo "Bootstrap produced changes to the working tree. Only Scout metadata updates should be committed. Aborting."
  exit 1
fi

report_step "Update Scout test config manifests"
node scripts/scout.js update-test-config-manifests

# Check for changes from the metadata update
if git diff --exit-code --quiet 2>/dev/null && git diff --cached --exit-code --quiet 2>/dev/null; then
  echo "No Scout metadata changes. Nothing to commit."
  exit 0
fi

report_step "Scout metadata changed. Creating pull request."

KIBANA_MACHINE_USERNAME="kibanamachine"
git config --global user.name "$KIBANA_MACHINE_USERNAME"
git config --global user.email '42973632+kibanamachine@users.noreply.github.com'

PR_TITLE='[Scout] Update test config manifests'
BRANCH_NAME="scout_metadata_update_$(date +%s)"

# Check if an open PR with the same title targeting this base already exists
existing_pr_json=$(gh pr list --base "$TARGET_BRANCH" --search "$PR_TITLE" --state open --author "$KIBANA_MACHINE_USERNAME" --limit 1 --json number,headRefName,title 2>/dev/null || true)
existing_pr_title=$(echo "$existing_pr_json" | jq -r '.[0].title // empty')
if [[ "$existing_pr_title" == "$PR_TITLE" ]]; then
  existing_branch=$(echo "$existing_pr_json" | jq -r '.[0].headRefName // empty')
  existing_pr_number=$(echo "$existing_pr_json" | jq -r '.[0].number // empty')
  echo "An open PR for Scout metadata update (base $TARGET_BRANCH) already exists. Updating PR #$existing_pr_number (branch: $existing_branch) via force-push."
  git checkout -b "$BRANCH_NAME"
  git add -A
  git commit -m "[Scout] Update test config manifests"
  git push origin "$BRANCH_NAME:$existing_branch" --force
  echo "Updated existing PR: https://github.com/elastic/kibana/pull/$existing_pr_number"
  exit 0
fi

git checkout -b "$BRANCH_NAME"
git add -A
git commit -m "[Scout] Update test config manifests"

report_step "Pushing branch and creating PR (base: $TARGET_BRANCH)"
git push origin "$BRANCH_NAME"

pr_url=$(gh pr create --repo elastic/kibana --base "$TARGET_BRANCH" --head "$BRANCH_NAME" \
  --title "$PR_TITLE" \
  --body "Generated by $BUILDKITE_BUILD_URL" \
  --label 'release_note:skip')
echo "Opened PR: $pr_url"

gh pr merge --repo elastic/kibana --auto --squash "$pr_url"
