env:
  KBN_EVALS: '1'
steps:
  - label: 'ðŸ‘¨â€ðŸ”§ Pre-Build'
    command: .buildkite/scripts/lifecycle/pre_build.sh
    agents:
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-2

  - wait

  - label: 'ðŸ§‘â€ðŸ­ Build Kibana Distribution'
    command: .buildkite/scripts/steps/build_kibana.sh
    agents:
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-8
    key: build
    if: "build.env('KIBANA_BUILD_ID') == null || build.env('KIBANA_BUILD_ID') == ''"

  - wait

  - label: 'ES|QL Generation Evaluations'
    command: |
      # Bootstrap workspace deps + download build artifacts (same setup as FTR/Scout CI steps)
      source .buildkite/scripts/steps/functional/common.sh

      # Write kibana.dev.yml with env var placeholders for Phoenix tracing
      cat > config/kibana.dev.yml <<'EOF'
      telemetry:
        enabled: true
        tracing:
          enabled: true
          exporters:
            - phoenix:
                base_url: '$${PHOENIX_BASE_URL}'
                public_url: '$${PHOENIX_PUBLIC_URL}'
                project_name: '$${PHOENIX_PROJECT_NAME}'
                api_key: '$${PHOENIX_API_KEY}'
      EOF

      # Start Scout server in background
      node scripts/scout start-server --stateful &
      SCOUT_PID=$!

      # Wait for server to be ready
      sleep 120

      # Run ES|QL evaluations
      EVALUATION_REPETITIONS=1 \
      EVALUATION_CONNECTOR_ID="gemini-2-5-pro" \
      TRACING_ES_URL="${TRACING_ES_URL}" \
      EVALUATIONS_ES_URL="${EVALUATIONS_ES_URL}" \
      node scripts/playwright test \
        --config x-pack/platform/packages/shared/onechat/kbn-evals-suite-onechat/playwright.config.ts \
        evals/esql/esql.spec.ts

      # Cleanup
      kill $SCOUT_PID 2>/dev/null || true
    key: esql-evals
    timeout_in_minutes: 60
    agents:
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-8
      preemptible: true
    retry:
      automatic:
        - exit_status: '-1'
          limit: 3
        - exit_status: '*'
          limit: 1
