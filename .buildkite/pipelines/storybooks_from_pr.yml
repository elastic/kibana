steps:
  - label: "Build Storybooks"
    commands:
      - .buildkite/scripts/steps/storybooks/build_and_upload.sh
      - |
          STORYBOOK_URL=$$(buildkite-agent meta-data get pr_comment:storybooks:head)

          ts-node .buildkite/scripts/lifecycle/comment_on_pr.ts \
            --message "$$STORYBOOK_URL" \
            --context "kibana-storybooks-from-pr" \
            --clear-previous
    agents:
      provider: gcp
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      machineType: n2-standard-2
    timeout_in_minutes: 50
    retry:
      automatic:
        - exit_status: '-1'
          limit: 1

  - wait: ~
    continue_on_failure: true

  - label: "Post failure comment"
    if: build.state == "failed"
    command: |
      ts-node .buildkite/scripts/lifecycle/comment_on_pr.ts \
        --message "‚ùå Storybooks build failed" \
        --context "kibana-storybooks-from-pr" \
        --clear-previous
    agents:
      provider: gcp
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      machineType: n2-standard-2
    timeout_in_minutes: 5

