steps:
  - group: "Serverless MKI QA Detection Engine - Cypress Tests"
    key: cypress_test_detections_engine
    steps:
      - command: .buildkite/scripts/pipelines/security_solution_quality_gate/security_solution_cypress/mki_security_solution_cypress.sh cypress:run:qa:serverless:detection_engine
        label: "Serverless MKI QA Detection Engine - Security Solution Cypress Tests"
        key: test_detection_engine
        env:
          BK_TEST_SUITE_KEY: "serverless-cypress-detection-engine"
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        # TODO : Revise the timeout when the pipeline will be officially integrated with the quality gate.
        timeout_in_minutes: 300
        parallelism: 1
        retry:
          automatic:
            - exit_status: "-1"
              limit: 1

      - command: .buildkite/scripts/pipelines/security_solution_quality_gate/security_solution_cypress/mki_security_solution_cypress.sh cypress:run:qa:serverless:detection_engine:exceptions
        label: "Serverless MKI QA Detection Engine - Exceptions - Security Solution Cypress Tests"
        key: test_detection_engine_exceptions
        env:
          BK_TEST_SUITE_KEY: "serverless-cypress-detection-engine"
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
          # TODO : Revise the timeout when the pipeline will be officially integrated with the quality gate.
        timeout_in_minutes: 300
        parallelism: 1
        retry:
          automatic:
            - exit_status: "-1"
              limit: 1

  - group: "Serverless MKI QA Detection Engine - API Integration"
    key: api_test_detections_engine
    steps:
      - label: Running exception_lists_items:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_lists_items:qa:serverless:release
        key: exception_lists_items:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running lists_items:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh entity_analytics:essentials:qa:serverless:release
        key: lists_items:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running user_roles:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh user_roles:qa:serverless:release
        key: user_roles:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running telemetry:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh telemetry:qa:serverless:release
        key: telemetry:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running exception_workflows:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_workflows:essentials:qa:serverless:release
        key: exception_workflows:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running exception_operators_date_numeric_types:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_operators_date_numeric_types:essentials:qa:serverless:release
        key: exception_operators_date_numeric_types:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running exception_operators_keyword:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_operators_keyword:essentials:qa:serverless:release
        key: exception_operators_keyword:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running exception_operators_ips:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_operators_ips:essentials:qa:serverless:release
        key: exception_operators_ips:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running exception_operators_long:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_operators_long:essentials:qa:serverless:release
        key: exception_operators_long:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running exception_operators_text:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh exception_operators_text:essentials:qa:serverless:release
        key: exception_operators_text:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running actions:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh actions:qa:serverless:release
        key: actions:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running alerts:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh alerts:qa:serverless:release
        key: alerts:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running alerts:essentials:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh alerts:essentials:qa:serverless:release
        key: alerts:essentials:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2

      - label: Running rule_execution_logic:qa:serverless:release
        command: .buildkite/scripts/pipelines/security_solution_quality_gate/api_integration/api-integration-tests.sh rule_execution_logic:qa:serverless:release
        key: rule_execution_logic:qa:serverless:release
        agents:
          image: family/kibana-ubuntu-2004
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-4
          preemptible: true
        timeout_in_minutes: 120
        retry:
          automatic:
            - exit_status: "1"
              limit: 2
