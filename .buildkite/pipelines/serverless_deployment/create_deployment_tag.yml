## Creates deploy@<timestamp> tag on Kibana

agents:
 queue: kibana-default

# TODO: Replace inline buildkite-agent commands with a central script that manages contexts/banners better

steps:
  - label: "Select target commit to deploy"
    commands:
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state initialize
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state collect_commits
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/generate_commit_selector.ts 50
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state wait_for_selection
    key: select_commit

  - wait: ~

  - label: "Collect commit info"
    commands:
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state collect_commit_info
      - .buildkite/scripts/serverless/create_deploy_tag/collect_commit_info.sh
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state wait_for_confirmation
    key: collect_data
    depends_on: select_commit

  - wait: ~

  - block: "Confirm deployment"
    prompt: "Are you sure you want to deploy to production?"
    depends_on: collect_data

  - wait: ~

  - label: ":ship: Create Deploy Tag"
    commands:
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state create_deploy_tag
      - .buildkite/scripts/serverless/create_deploy_tag/create_deploy_tag.sh
      - ts-node .buildkite/scripts/serverless/create_deploy_tag/release_events.ts --state tag_created
    env:
      DRY_RUN: $DRY_RUN
