# These pipeline steps constitute the quality gate for your service within the production environment.
# Incorporate any necessary additional logic to validate the service's integrity.
# A failure in this pipeline build will prevent further progression to the subsequent stage.

steps:
  - label: ':kibana: SLO check (60 minutes)'
    trigger: 'serverless-quality-gates' # https://buildkite.com/elastic/serverless-quality-gates
    build:
      message: '${BUILDKITE_MESSAGE} (triggered by pipeline.tests-production.yaml)'
      env:
        TARGET_ENV: production
        CHECK_SLO: true
        CHECK_SLO_TAG: kbn-quality-gate
        CHECK_SLO_WAITING_PERIOD: 60m
        CHECK_SLO_BURN_RATE_THRESHOLD: 0.1
        DEPLOYMENT_SLICES: ${DEPLOYMENT_SLICES:-""}
    soft_fail: true

  - label: ':rocket: Run serverless synthetics check'
    if: build.env("ENVIRONMENT") == "production-canary"
    trigger: 'serverless-quality-gates'
    build:
      message: '${BUILDKITE_MESSAGE} (triggered by pipeline.tests-production.yaml)'
      env:
        TARGET_ENV: production
        SERVICE: kibana
        CHECK_SYNTHETICS: true
        CHECK_SYNTHETICS_TAG: serverless-platform-core-validation

  - input: 'Cancel bake time step early?'
    if: build.env("ENVIRONMENT") == "production-canary"
    fields:
      - select: 'Enable the option below to skip the remaining bake time'
        key: 'early-bake-time-cancel' # set BK meta-data key, which is checked during bake time wait
        options:
          - label: 'Cancel bake time'
            value: 'cancel'

  - label: ':cookie: 20h bake time before continuing promotion'
    if: build.env("ENVIRONMENT") == "production-canary"
    command: BAKE_SECONDS=72000 .buildkite/scripts/pipelines/quality_gates/bake_time_with_cancellation_check.sh
    soft_fail:
      # Cancelling the bake time earlier through the BK input makes the script exit with code 42.
      # We're treating this case as a soft fail to allow manual bake time skipping.
      # To stop the promotion entirely, instead click the "Cancel" button at the top of the page.
      - exit_status: 42
    retry:
      manual: false
    agents:
      # How long can this agent live for in minutes - 21 hours
      instanceMaxAge: 1260
