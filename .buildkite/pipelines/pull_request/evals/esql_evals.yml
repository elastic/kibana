steps:
  - group: ES|QL Evaluations
    key: esql-evaluations
    depends_on:
      - build
      - quick_checks
      - checks
      - linting
      - linting_with_types
      - check_types
      - check_oas_snapshot
    steps:
      - label: 'ES|QL Generation Evaluations'
        command: |
          # Bootstrap workspace deps + download build artifacts (same setup as FTR/Scout CI steps)
          source .buildkite/scripts/steps/functional/common.sh

          # Write kibana.dev.yml with env var placeholders for Phoenix tracing
          cat > config/kibana.dev.yml <<'EOF'
          telemetry:
            enabled: true
            tracing:
              enabled: true
              exporters:
                - phoenix:
                    base_url: '$${PHOENIX_BASE_URL}'
                    public_url: '$${PHOENIX_PUBLIC_URL}'
                    project_name: '$${PHOENIX_PROJECT_NAME}'
                    api_key: '$${PHOENIX_API_KEY}'
          EOF

          # Start Scout server in background
          node scripts/scout start-server --stateful --kibana-install-dir "$KIBANA_BUILD_LOCATION" &
          SCOUT_PID=$!

          # Wait for Scout to write servers config (and fail fast if the Scout server process exits)
          for i in {1..60}; do
            if [[ -f .scout/servers/local.json ]]; then
              break
            fi
            if ! kill -0 "$$SCOUT_PID" 2>/dev/null; then
              echo "Scout server exited before writing .scout/servers/local.json"
              wait "$$SCOUT_PID" || true
              exit 1
            fi
            sleep 1
          done

          if [[ ! -f .scout/servers/local.json ]]; then
            echo "Timed out waiting for .scout/servers/local.json"
            exit 1
          fi

          # Wait for Kibana to be ready (and fail fast if the Scout server process exits)
          KIBANA_URL="$(jq -r '.hosts.kibana' .scout/servers/local.json)"
          KIBANA_URL="$(printf '%s' "$$KIBANA_URL" | sed 's:/*$::')"

          for i in {1..180}; do
            if ! kill -0 "$$SCOUT_PID" 2>/dev/null; then
              echo "Scout server exited before Kibana became ready"
              wait "$$SCOUT_PID" || true
              exit 1
            fi

            if curl -sSf "$$KIBANA_URL/api/status" >/dev/null; then
              echo "Kibana is ready at $$KIBANA_URL"
              break
            fi

            sleep 5
          done

          # Run ES|QL evaluations
          EVALUATION_REPETITIONS=1 \
          EVALUATION_CONNECTOR_ID="gemini-2-5-pro" \
          TRACING_ES_URL="${TRACING_ES_URL}" \
          EVALUATIONS_ES_URL="${EVALUATIONS_ES_URL}" \
          node scripts/playwright test \
            --config x-pack/platform/packages/shared/onechat/kbn-evals-suite-onechat/playwright.config.ts \
            evals/esql/esql.spec.ts

          # Cleanup
          kill $$SCOUT_PID 2>/dev/null || true
        env:
          KBN_EVALS: '1'
        key: esql-evals
        timeout_in_minutes: 60
        agents:
          machineType: n2-standard-8
          preemptible: true
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3
            - exit_status: '*'
              limit: 1
