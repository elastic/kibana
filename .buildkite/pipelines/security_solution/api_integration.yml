steps:
  - input: "Flow parameterisation input"
    key: "configuration_pane"
    fields:
      - select: "The environment to test against"
        key: "environment"
        default: "QA"
        required: false
        options:
          - label: "QA"
            value: "QA"
      - select: "Override kibana"
        key: "kibana_override"
        default: "False"
        required: false
        options:
          - label: "Enable"
            value: "1"
          - label: "Disable"
            value: "0"

  - command: .buildkite/scripts/pipelines/security_solution_quality_gate/upload_runtime_info.sh
    label: "Upload runtime info"
    key: upload_runtime_info
    agents:
      queue: n2-4-spot
    timeout_in_minutes: 300
    retry:
      automatic:
        - exit_status: "*"
          limit: 1

  - command: echo "Building kibana docker image"
    # .buildkite/scripts/steps/artifacts/docker_image.sh
    label: Build serverless container images
    depends_on:
    agents:
      queue: n2-16-spot
    timeout_in_minutes: 60
    retry:
      automatic:
        - exit_status: "-1"
          limit: 3
    if: env('KIBANA_BUILD_NEW') == "1"

  # - label: Running exception_workflows:runner:serverless
  #   command: .buildkite/scripts/pipelines/security_solution_quality_gate/api-integration-tests.sh exception_workflows:qa:serverless
  #   key: exception_workflows:runner:serverless
  #   depends_on: upload_runtime_info
  #   agents:
  #     queue: n2-4-spot
  #   timeout_in_minutes: 120
  #   retry:
  #     automatic:
  #       - exit_status: "*"
  #         limit: 2

  # - label: Running exception_operators_date_numeric_types:runner:serverless
  #   command: .buildkite/scripts/pipelines/security_solution_quality_gate/api-integration-tests.sh exception_operators_date_numeric_types:qa:serverless
  #   key: exception_operators_date_numeric_types:runner:serverless
  #   depends_on: upload_runtime_info
  #   agents:
  #     queue: n2-4-spot
  #   timeout_in_minutes: 120
  #   retry:
  #     automatic:
  #       - exit_status: "*"
  #         limit: 2

  # - label: Running exception_operators_keyword_text_long:runner:serverless
  #   command: .buildkite/scripts/pipelines/security_solution_quality_gate/api-integration-tests.sh exception_operators_keyword_text_long:qa:serverless
  #   key: exception_operators_keyword_text_long:runner:serverless
  #   depends_on: upload_runtime_info
  #   agents:
  #     queue: n2-4-spot
  #   timeout_in_minutes: 120
  #   retry:
  #     automatic:
  #       - exit_status: "*"
  #         limit: 2

  # - label: Running exception_operators_ips_text_array:runner:serverless
  #   command: .buildkite/scripts/pipelines/security_solution_quality_gate/api-integration-tests.sh exception_operators_ips_text_array:qa:serverless
  #   key: exception_operators_ips_text_array:runner:serverless
  #   depends_on: upload_runtime_info
  #   agents:
  #     queue: n2-4-spot
  #   timeout_in_minutes: 120
  #   retry:
  #     automatic:
  #       - exit_status: "1"
  #         limit: 2

  # - label: Running rule_creation:runner:serverless
  #   command: .buildkite/scripts/pipelines/security_solution_quality_gate/api-integration-tests.sh rule_creation:qa:serverless
  #   key: rule_creation:runner:serverless
  #   depends_on: upload_runtime_info
  #   agents:
  #     queue: n2-4-spot
  #   timeout_in_minutes: 120
  #   retry:
  #     automatic:
  #       - exit_status: "1"
  #         limit: 2

  # - label: Running actions:qa:serverless
  #   command: .buildkite/scripts/pipelines/security_solution_quality_gate/api-integration-tests.sh actions:qa:serverless
  #   key: actions:qa:serverless
  #   depends_on: upload_runtime_info
  #   agents:
  #     queue: n2-4-spot
  #   timeout_in_minutes: 120
  #   retry:
  #     automatic:
  #       - exit_status: "1"
  #         limit: 2
