steps:
  - key: create_deployment
    label: ':elastic-cloud: Create Elastic Cloud deployment'
    agents:
      image: docker.elastic.co/appex-qa/qaf:ftr-latest
    env:
      EC_REGISTER_BACKEND: appex-qa-team-cluster
      EC_DEPLOYMENT_NAME: 9.2-SNAPSHOT-test
      STACK_VERSION: 9.2.0-SNAPSHOT
      EC_REGION: gcp-us-central1
      EC_ENV: qa
      EC_PLAN: default_gcp
      EC_AUTOSCALING_ENABLED: false
      EC_API_TRANSPORT_DELAY_ENABLED: true
    commands:
      - qaf vault preload-common-secrets
      - qaf elastic-cloud deployments create

  - key: run_tests
    depends_on:
      - step: create_deployment
        allow_failure: false
    label: ':test_tube: OOM tests'
    timeout_in_minutes: 120
    agents:
      image: docker.elastic.co/appex-qa/qaf:ftr-latest
    env:
      EC_REGISTER_BACKEND: appex-qa-team-cluster
      EC_DEPLOYMENT_NAME: 9.2-SNAPSHOT-test
      STACK_VERSION: 9.2.0-SNAPSHOT
      EC_REGION: gcp-us-central1
      EC_ENV: qa
      EC_PLAN: default_gcp
      EC_AUTOSCALING_ENABLED: false
      EC_API_TRANSPORT_DELAY_ENABLED: true
    command: qaf kibana ftr run-config x-pack/solutions/security/test/security_solution_api_integration/test_suites/detections_response/rules_management/prebuilt_rules/common/configs/edge_cases/ess_trial_license.config.ts

  - key: remove_deployment
    label: ':elastic-cloud::broom::sparkles: Remove Elastic Cloud deployment'
    depends_on:
      - step: run_tests
        allow_failure: true
    agents:
      image: docker.elastic.co/appex-qa/qaf:ftr-latest
    env:
      EC_REGISTER_BACKEND: appex-qa-team-cluster
      EC_DEPLOYMENT_NAME: 9.2-SNAPSHOT-test
    command: qaf elastic-cloud deployments remove
