env:
  ELASTIC_PR_COMMENTS_ENABLED: 'true'
  ELASTIC_GITHUB_BUILD_COMMIT_STATUS_ENABLED: 'true'
  GITHUB_BUILD_COMMIT_STATUS_CONTEXT: kibana-entity-store-performance-from-pr

steps:
  - group: 'Entity Store Performance Tests'
    if: "build.env('GITHUB_PR_LABELS') =~ /ci:entity-store-performance/"

    steps:
      - command: .buildkite/scripts/lifecycle/pre_build.sh
        label: Pre-Build
        timeout_in_minutes: 10
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-2
        retry:
          automatic:
            - exit_status: '*'
              limit: 1

      - command: |
          ts-node .buildkite/scripts/lifecycle/comment_on_pr.ts \
            --message "Entity store performance tests started at: $BUILDKITE_BUILD_URL" \
            --context "entity-store-performance-job" \
            --clear-previous
        label: Comment with job URL
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-2
        timeout_in_minutes: 5

      - wait: ~

      - command: .buildkite/scripts/steps/build_kibana.sh
        label: Build Kibana Distribution
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-8
          preemptible: true
          diskSizeGb: 125
        if: "build.env('KIBANA_BUILD_ID') == null || build.env('KIBANA_BUILD_ID') == ''"
        timeout_in_minutes: 90
        key: build
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3

      - command: .buildkite/scripts/steps/cloud/build_and_deploy.sh
        env:
          ES_ZONE_COUNT: 2
        label: 'Build and Deploy to Cloud'
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-2
          preemptible: true
        timeout_in_minutes: 30
        depends_on: build
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3

      - wait: ~

      - command: .buildkite/scripts/steps/entity_store_performance/run_performance_tests_orchestrator.sh
        label: 'Run Entity Store Performance Tests'
        env:
          SECURITY_DOCS_GEN_BRANCH: dg-update-entity-store-perf #TODO: Remove this after debugging
          PERF_INTERVAL: 150
          PERF_COUNT: 1
          # Optional: Baseline comparison configuration
          PERF_BASELINE_FILE: baselines/baseline-v1  # Optional: specific baseline file to use
          PERF_DEGRADATION_THRESHOLD: 30  # Optional: degradation threshold % (default: 25)
          PERF_WARNING_THRESHOLD: 20  # Optional: warning threshold % (default: 15)
          PERF_IMPROVEMENT_THRESHOLD: 20  # Optional: improvement threshold % (default: 15)
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-2
        timeout_in_minutes: 60
        retry:
          automatic:
            - exit_status: '-1'
              limit: 1

      - wait: ~

      - command: |
          ts-node .buildkite/scripts/lifecycle/comment_on_pr.ts \
            --message "Entity store performance tests completed, see results at: $BUILDKITE_BUILD_URL" \
            --context "entity-store-performance-job" \
            --clear-previous
        label: Comment with results
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-2
        timeout_in_minutes: 5

      - wait: ~

      - command: .buildkite/scripts/lifecycle/post_build.sh
        label: Post-Build
        agents:
          provider: gcp
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          machineType: n2-standard-2
