steps:
  - label: 'üë®‚Äçüîß Pre-Build'
    command: .buildkite/scripts/lifecycle/pre_build.sh
    agents:
      image: family/kibana-ubuntu-2004
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-2

  - wait

  - label: 'üßë‚Äçüè≠ Build Kibana Distribution'
    command: .buildkite/scripts/steps/build_kibana.sh
    agents:
      image: family/kibana-ubuntu-2004
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-8
    key: build
    if: "build.env('KIBANA_BUILD_ID') == null || build.env('KIBANA_BUILD_ID') == ''"

  - label: 'üí™ Performance Tests with Playwright config'
    plugins:
      - custom-checkout#v1.0.0:
          skip_checkout: true
    command:
      - echo "Manually fetching Kibana with SHA=$BUILDKITE_COMMIT..."
      - wget -q "https://github.com/elastic/kibana/archive/$BUILDKITE_COMMIT.tar.gz" -O "kibana.tar.gz"
      - echo "Extracting Kibana archive..."
      - tar -xzf kibana.tar.gz
      - echo "Setting executable permissions for the script..."
      - chmod +x kibana-$BUILDKITE_COMMIT/.buildkite/scripts/steps/functional/performance_playwright.sh
      - echo "Running Performance Playwright script..."
      - ./kibana-$BUILDKITE_COMMIT/.buildkite/scripts/steps/functional/performance_playwright.sh
    env:
      PERFORMANCE_ENABLE_TELEMETRY: true
    agents:
      queue: kb-static-ubuntu
    depends_on: build
    key: tests
    timeout_in_minutes: 90

  - label: 'üìà Report performance metrics to ci-stats'
    command: .buildkite/scripts/steps/functional/report_performance_metrics.sh
    agents:
      image: family/kibana-ubuntu-2004
      imageProject: elastic-images-prod
      provider: gcp
      localSsds: 1
      localSsdInterface: nvme
      machineType: n2-standard-2
    depends_on: tests

  - wait: ~
    continue_on_failure: true

  - label: 'ü¶∏ Post-Build'
    command: .buildkite/scripts/lifecycle/post_build.sh
    agents:
      image: family/kibana-ubuntu-2004
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-2
