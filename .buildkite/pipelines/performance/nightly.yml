steps:
  - block: ":gear: Performance Tests Configuration"
    prompt: "Fill out the details for performance test"
    fields:
      - text: ":arrows_counterclockwise: Iterations"
        key: "performance-test-iteration-count"
        hint: "How many times you want to run tests? "
        required: true
    if: build.env('ITERATION_COUNT_ENV') == null

  - label: ":male-mechanic::skin-tone-2: Pre-Build"
    command: .buildkite/scripts/lifecycle/pre_build.sh

  - wait

  - label: ":factory_worker: Build Kibana Distribution and Plugins"
    command: .buildkite/scripts/steps/build_kibana.sh
    agents:
      queue: c2-16
    key: build

  - label: ":muscle: Performance Tests with FTR config"
    command: .buildkite/scripts/steps/functional/performance_ftr.sh
    agents:
      queue: ci-group-6
    depends_on: build
    if: build.env('TEST_RUNNER') == null || build.env('TEST_RUNNER') == "FTR"

  - label: ":muscle: Performance Tests with Synthetics config"
    command: .buildkite/scripts/steps/functional/performance_synthetics.sh
    agents:
      queue: ci-group-6
    depends_on: build
    if: build.env('TEST_RUNNER') == "SYNTHETICS"

  - wait: ~
    continue_on_failure: true

  - label: ":male_superhero::skin-tone-2: Post-Build"
    command: .buildkite/scripts/lifecycle/post_build.sh

