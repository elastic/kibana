# Kibana API reference documentation

Kibana's API reference documentation is autogenerated from OpenAPI bundles while OpenAPI bundles are built automatically. This documentation explains OpenAPI bundling workflow and configuration.

## Workflow

The workflow consists of two steps where the final goal is to produce Kibana OpenAPI bundle containing Kibana's API endpoints we expect to be published on the API reference documentation platform.

ESS and Serverless OpenAPI bundles generation workflows are pretty similar so an there is a common workflow is depicted below

![alt text](workflow.png)

### Step 1

At the first step domain OpenAPI bundles are produces. It depends on solution/team what approach to choose. There are three ways to get a domain OpenAPI bundle

- Use **Specification first approach** via [`kbn-openapi-bundler`](../packages/kbn-openapi-bundler/README.md) to process source OpenAPI specs describing individual OpenAPI endpoints. It works well with OpenAPI code generation and provides a lot of flexibility during development to avoid publishing documentation for not yet released API endpoints.

- Use **Code first approach** via `scripts/capture_oas_snapshot.js` to capture OpenAPI specs from routes source code. It allows to produce a domain bundle with minimum effort but requires running ES and Kibana for that and makes it hard to control what documentation is published eventually.

- Use **Manually written** domain OpenAPI bundles if neither of the above doesn't work. It's considered as a temporary measure and highly discouraged as a long term approach.

### Step 2

At the second step domain OpenAPI bundles are merged together by `kbn-openapi-bundler` to produce the result bundle.

### Scripts

`scripts` folder contains scripts describing source domain OpenAPI bundles, result document configuration and output path. There are two groups currently

- `merge_ess_oas.js` and `merge_serverless_oas.js` to produce production ready Kibana OpenAPI bundles for ESS and Serverless respectively.

- `merge_ess_oas_staging.js` and `merge_serverless_oas_staging.js` to produce staging Kibana OpenAPI bundles for ESS and Serverless respectively. Staging bundles currently aren't published anywhere and required for polishing API reference documentation on domains not yet included in the production ready Kibana OpenAPI bundles.

### Output Kibana OpenAPI bundles

`output` folder contains result Kibana OpenAPI bundles. There are two groups currently

- `kibana.yaml` and `kibana.serverless.yaml` are production ready ESS and Serverless Kibana OpenAPI bundles to be published on the API reference documentation platform. Publishing process isn't fully automated yet and performed by the Docs Engineering team.

- `kibana.staging.yaml` and `kibana.serverless.staging.yaml` are staging ESS and Serverless Kibana OpenAPI bundles. Staging bundles currently aren't published anywhere and required for polishing API reference documentation on domains not yet included in the production ready Kibana OpenAPI bundles.

## Bundling commands

Scripts in the `scripts` folder bundle individual Kibana OpenAPI bundles. There is a makefile to simplify the workflow. The following makefile targets are available

| Command                    | Description                                                                                                                                                                                                        |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `api-docs`                 | Builds ESS Kibana OpenAPI bundle                                                                                                                                                                                   |
| `api-docs-serverless`      | Builds Serverless Kibana OpenAPI bundle                                                                                                                                                                            |
| `api-docs-lint`            | Lints built result bundles                                                                                                                                                                                         |
| `api-docs-lint-errs`       | Lints built result bundles for errors                                                                                                                                                                              |
| `api-docs-preview`         | Generates (ESS + Serverless) Kibana OpenAPI bundles preview                                                                                                                                                        |
| `api-docs-overlay`         | Applies [overlays](https://docs.bump.sh/help/specification-support/overlays/) from `overlays` folder to the Kibana OpenAPI bundles and generate `*.new.yaml` files. Overlays help to fine tune the result bundles. |
| `api-docs-overlay-preview` | Generates a preview for bundles produced by `api-docs-overlay`                                                                                                                                                     |

## Bundling automation

To have always up to date Kibana OpenAPI bundles bundling runs as a part of `Checks` step in CI on every PR build and on merge builds. If there are any changes in source OpenAPI files these changes get to the updated Kibana OpenAPI bundles and CI commits the changes. In that case CI is marked as failed and needs to be restarted.

## Bundling solution domains

### Security Solution

Security Solution uses **specification first approach**. There are multiple OpenAPI files describing individual API endpoints. It helps to enable code generation besides automatic API reference documentation. That OpenAPI files are bundled into domain OpenAPI bundles by `kbn-openapi-bundler`. Paths to produced Security Solution domain OpenAPI bundles were added to the merge scripts `merge_ess_oas.js` and `merge_serverless_oas.js` to include these bundles in Kibana OpenAPI bundle. There are the following API domains in Security Solution included in the Kibana OpenAPI bundle

#### Security AI Assistant

Root folder `x-pack/packages/kbn-elastic-assistant-common`.

|                             |                                                                                |
| --------------------------- | ------------------------------------------------------------------------------ |
| Source OpenAPI files folder | `impl`                                                                         |
| Bundling script             | `scripts/openapi/bundle.js`                                                    |
| Result Serverless bundle    | `docs/openapi/serverless/elastic_assistant_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/elastic_assistant_api_2023_10_31.bundled.schema.yaml`        |

#### Security Detections

Root folder `x-pack/plugins/security_solution`.

|                             |                                                                                           |
| --------------------------- | ----------------------------------------------------------------------------------------- |
| Source OpenAPI files folder | `common/api/detection_engine`                                                             |
| Bundling script             | `scripts/openapi/bundle_detections.js`                                                    |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_detections_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_detections_api_2023_10_31.bundled.schema.yaml`        |

#### Security Endpoint Exceptions

Root folder `packages/kbn-securitysolution-endpoint-exceptions-common`.

|                             |                                                                                                    |
| --------------------------- | -------------------------------------------------------------------------------------------------- |
| Source OpenAPI files folder | `api`                                                                                              |
| Bundling script             | `scripts/openapi_bundle.js`                                                                        |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_endpoint_exceptions_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_endpoint_exceptions_api_2023_10_31.bundled.schema.yaml`        |

#### Security Endpoint Management

Root folder `x-pack/plugins/security_solution`.

|                             |                                                                                                    |
| --------------------------- | -------------------------------------------------------------------------------------------------- |
| Source OpenAPI files folder | `common/api/endpoint`                                                                              |
| Bundling script             | `scripts/openapi/bundle_endpoint_management.js`                                                    |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_endpoint_management_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_endpoint_management_api_2023_10_31.bundled.schema.yaml`        |

#### Security Entity Analytics

Root folder `x-pack/plugins/security_solution`.

|                             |                                                                                                 |
| --------------------------- | ----------------------------------------------------------------------------------------------- |
| Source OpenAPI files folder | `common/api/entity_analytics`                                                                   |
| Bundling script             | `scripts/openapi/bundle_entity_analytics.js`                                                    |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_entity_analytics_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_entity_analytics_api_2023_10_31.bundled.schema.yaml`        |

#### Security Exceptions

Root folder `packages/kbn-securitysolution-exceptions-common`.

|                             |                                                                                           |
| --------------------------- | ----------------------------------------------------------------------------------------- |
| Source OpenAPI files folder | `api`                                                                                     |
| Bundling script             | `scripts/openapi_bundle.js`                                                               |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_exceptions_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_exceptions_api_2023_10_31.bundled.schema.yaml`        |

#### Security Lists

Root folder `packages/kbn-securitysolution-lists-common`.

|                             |                                                                                      |
| --------------------------- | ------------------------------------------------------------------------------------ |
| Source OpenAPI files folder | `api`                                                                                |
| Bundling script             | `scripts/openapi_bundle.js`                                                          |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_lists_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_lists_api_2023_10_31.bundled.schema.yaml`        |

#### Security Osquery

Root folder `x-pack/plugins/osquery`.

|                             |                                                                      |
| --------------------------- | -------------------------------------------------------------------- |
| Source OpenAPI files folder | `osquery/common/api`                                                 |
| Bundling script             | `scripts/openapi/bundle.js`                                          |
| Result Serverless bundle    | `docs/openapi/serverless/osquery_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/osquery_api_2023_10_31.bundled.schema.yaml`        |

#### Security Timeline

Root folder `x-pack/plugins/security_solution`.

|                             |                                                                                         |
| --------------------------- | --------------------------------------------------------------------------------------- |
| Source OpenAPI files folder | `common/api/timeline`                                                                   |
| Bundling script             | `scripts/openapi/bundle_timeline.js`                                                    |
| Result Serverless bundle    | `docs/openapi/serverless/security_solution_timeline_api_2023_10_31.bundled.schema.yaml` |
| Result ESS bundle           | `docs/openapi/ess/security_solution_timeline_api_2023_10_31.bundled.schema.yaml`        |
