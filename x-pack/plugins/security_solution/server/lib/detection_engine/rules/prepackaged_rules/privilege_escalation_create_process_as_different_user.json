{
  "author": [
    "Elastic"
  ],
  "description": "Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.",
  "from": "now-9m",
  "index": [
    "winlogbeat-*",
    "logs-system.*"
  ],
  "language": "eql",
  "license": "Elastic License v2",
  "name": "Process Creation via Secondary Logon",
  "note": "",
  "query": "sequence by host.id with maxspan=1m\n\n[authentication where event.action:\"logged-in\" and\n event.outcome == \"success\" and user.id:\"S-1-5-21-*\" and\n\n /* seclogon service */\n process.name == \"svchost.exe\" and \n winlog.event_data.LogonProcessName : \"seclogo*\" and source.ip == \"::1\" ] by winlog.event_data.TargetLogonId\n\n[process where event.type == \"start\"] by winlog.event_data.TargetLogonId\n",
  "references": [
    "https://attack.mitre.org/techniques/T1134/002/"
  ],
  "required_fields": [
    {
      "ecs": true,
      "name": "event.action",
      "type": "keyword"
    },
    {
      "ecs": true,
      "name": "event.outcome",
      "type": "keyword"
    },
    {
      "ecs": true,
      "name": "event.type",
      "type": "keyword"
    },
    {
      "ecs": true,
      "name": "host.id",
      "type": "keyword"
    },
    {
      "ecs": true,
      "name": "process.name",
      "type": "keyword"
    },
    {
      "ecs": true,
      "name": "source.ip",
      "type": "ip"
    },
    {
      "ecs": true,
      "name": "user.id",
      "type": "keyword"
    },
    {
      "ecs": false,
      "name": "winlog.event_data.LogonProcessName",
      "type": "keyword"
    },
    {
      "ecs": false,
      "name": "winlog.event_data.TargetLogonId",
      "type": "keyword"
    }
  ],
  "risk_score": 47,
  "rule_id": "42eeee3d-947f-46d3-a14d-7036b962c266",
  "setup": "Audit events 4624 and 4688 are needed to trigger this rule.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2, events will not define `event.ingested` and default fallback for EQL rules was not added until 8.2, so you will need to add a custom pipeline to populate `event.ingested` to @timestamp for this rule to work.",
  "severity": "medium",
  "tags": [
    "Elastic",
    "Host",
    "Windows",
    "Threat Detection",
    "Privilege Escalation"
  ],
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0004",
        "name": "Privilege Escalation",
        "reference": "https://attack.mitre.org/tactics/TA0004/"
      },
      "technique": [
        {
          "id": "T1134",
          "name": "Access Token Manipulation",
          "reference": "https://attack.mitre.org/techniques/T1134/",
          "subtechnique": [
            {
              "id": "T1134.002",
              "name": "Create Process with Token",
              "reference": "https://attack.mitre.org/techniques/T1134/002/"
            },
            {
              "id": "T1134.003",
              "name": "Make and Impersonate Token",
              "reference": "https://attack.mitre.org/techniques/T1134/003/"
            }
          ]
        }
      ]
    }
  ],
  "type": "eql",
  "version": 1
}
