{
  "author": [
    "Elastic"
  ],
  "description": "Identifies probable exploitation of the Web Proxy Auto-Discovery Protocol (WPAD) service. Attackers who have access to the local network or upstream DNS traffic can inject malicious JavaScript to the WPAD service which can lead to a full system compromise.",
  "from": "now-9m",
  "index": [
    "logs-endpoint.events.*",
    "winlogbeat-*"
  ],
  "language": "eql",
  "license": "Elastic License",
  "name": "WPAD Service Exploit",
  "query": "/* preference would be to use user.sid rather than domain+name, once it is available in ECS + datasources */\n\nsequence with maxspan=5s\n  [process where event.type in (\"start\", \"process_started\") and process.name == \"svchost.exe\" and\n     user.domain == \"NT AUTHORITY\" and user.name == \"LOCAL SERVICE\"] by process.entity_id\n  [network where network.protocol == \"dns\" and process.name == \"svchost.exe\" and\n     dns.question.name == \"wpad\" and process.name == \"svchost.exe\"] by process.entity_id\n  [network where event.type == \"connection\" and process.name == \"svchost.exe\"\n     and network.direction == \"outgoing\" and destination.port == 80] by process.entity_id\n  [library where event.type == \"start\" and process.name == \"svchost.exe\" and\n     file.name == \"jscript.dll\" and process.name == \"svchost.exe\"] by process.entity_id\n  [process where event.type in (\"start\", \"process_started\") and\n     process.parent.name == \"svchost.exe\"] by process.parent.entity_id\n",
  "risk_score": 21,
  "rule_id": "ec328da1-d5df-482b-866c-4a435692b1f3",
  "severity": "high",
  "tags": [
    "Elastic",
    "Windows"
  ],
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0002",
        "name": "Execution",
        "reference": "https://attack.mitre.org/tactics/TA0002/"
      },
      "technique": [
        {
          "id": "T1068",
          "name": "Exploitation for Privilege Escalation",
          "reference": "https://attack.mitre.org/techniques/T1068/"
        }
      ]
    }
  ],
  "type": "eql",
  "version": 1
}
