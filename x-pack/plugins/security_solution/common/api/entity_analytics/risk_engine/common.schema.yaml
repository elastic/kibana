openapi: 3.0.0
info:
  title: Risk Engine Common Schema
  description: Common schema for Risk Engine APIs
  version: 1.0.0

paths: { }

components:
  schemas:

    AfterKeys:
      type: object
      properties:
        host:
          type: object
          additionalProperties:
            type: string
        user:
          type: object
          additionalProperties:
            type: string
      example:
        host:
          'host.name': 'example.host'
        user:
          'user.name': 'example_user_name'

    DataViewId:
      description: The identifier of the Kibana data view to be used when generating risk scores.
      example: security-solution-default
      type: string

    Filter:
      type: object
      description: An elasticsearch DSL filter object. Used to filter the risk inputs involved, which implicitly filters the risk scores themselves. See https://cloud.elastic.co/api/v1/api-docs/spec.json#/definitions/QueryContainer

    PageSize:
      description: Specifies how many scores will be involved in a given calculation. Note that this value is per `identifier_type`, i.e. a value of 10 will calculate 10 host scores and 10 user scores, if available. To avoid missed data, keep this value consistent while paginating through scores.
      default: 1000
      type: number

    KibanaDate:
      oneOf:
        - type: string
          format: date
        - type: string
          format: date-time
        - type: string
          format: datemath
      example: '2017-07-21T17:32:28Z'

    DateRange:
      description: Defines the time period on which risk inputs will be filtered.
      type: object
      required:
        - start
        - end
      properties:
        start:
          $ref: '#/components/schemas/KibanaDate'
        end:
          $ref: '#/components/schemas/KibanaDate'

    IdentifierType:
      type: string
      enum:
        - host
        - user

    RiskScoreInput:
      description: A generic representation of a document contributing to a Risk Score.
      type: object
      properties:
        id:
          type: string
          example: 91a93376a507e86cfbf282166275b89f9dbdb1f0be6c8103c6ff2909ca8e1a1c
          description: The unique identifier (`_id`) of the original source document
        index:
          type: string
          example: .internal.alerts-security.alerts-default-000001
          description: The unique index (`_index`) of the original source document
        category:
          type: string
          example: category_1
          description: The risk category of the risk input document.
        description:
          type: string
          example: 'Generated from Detection Engine Rule: Malware Prevention Alert'
          description: A human-readable description of the risk input document.
        risk_score:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: The weighted risk score of the risk input document.
        timestamp:
          type: string
          example: '2017-07-21T17:32:28Z'
          description: The @timestamp of the risk input document.


    RiskScore:
      type: object
      required:
        - '@timestamp'
        - id_field
        - id_value
        - calculated_level
        - calculated_score
        - calculated_score_norm
        - category_1_score
        - category_1_count
        - inputs
      properties:
        '@timestamp':
          type: string
          format: 'date-time'
          example: '2017-07-21T17:32:28Z'
          description: The time at which the risk score was calculated.
        id_field:
          type: string
          example: 'host.name'
          description: The identifier field defining this risk score. Coupled with `id_value`, uniquely identifies the entity being scored.
        id_value:
          type: string
          example: 'example.host'
          description: The identifier value defining this risk score. Coupled with `id_field`, uniquely identifies the entity being scored.
        calculated_level:
          type: string
          example: 'Critical'
          description: Lexical description of the entity's risk.
        calculated_score:
          type: number
          format: double
          description: The raw numeric value of the given entity's risk score.
        calculated_score_norm:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: The normalized numeric value of the given entity's risk score. Useful for comparing with other entities.
        category_1_score:
          type: number
          format: double
          description: The contribution of Category 1 to the overall risk score (`calculated_score_norm`). Category 1 contains Detection Engine Alerts.
        category_1_count:
          type: number
          format: integer
          description: The number of risk input documents that contributed to the Category 1 score (`category_1_score`).
        category_2_score:
          type: number
          format: double
          description: The contribution of Category 2 to the overall risk score (`calculated_score_norm`). Category 2 contains context from external sources.
        category_2_count:
          type: number
          format: integer
          description: The number of risk input documents that contributed to the Category 2 score (`category_2_score`).
        criticality_level:
          type: string
          example: extreme_impact
          description: The designated criticality level of the entity. Possible values are `low_impact`, `medium_impact`, `high_impact`, and `extreme_impact`.
        criticality_modifier:
          type: number
          format: double
          description: The numeric modifier corresponding to the criticality level of the entity, which is used as an input to the risk score calculation.
        inputs:
          type: array
          description: A list of the highest-risk documents contributing to this risk score. Useful for investigative purposes.
          items:
            $ref: '#/components/schemas/RiskScoreInput'

    RiskScoreWeight:
      description: "Configuration used to tune risk scoring. Weights can be used to change the score contribution of risk inputs for hosts and users at both a global level and also for Risk Input categories (e.g. 'category_1')."
      type: object
      required:
        - type
      properties:
        type:
          type: string
        value:
          type: string
        host:
          type: number
          format: double
          minimum: 0
          maximum: 1
        user:
          type: number
          format: double
          minimum: 0
          maximum: 1
      example:
        type: 'risk_category'
        value: 'category_1'
        host: 0.8
        user: 0.4

    RiskScoreWeights:
      description: 'A list of weights to be applied to the scoring calculation.'
      type: array
      items:
        $ref: '#/components/schemas/RiskScoreWeight'
      example:
        - type: 'risk_category'
          value: 'category_1'
          host: 0.8
          user: 0.4
        - type: 'global_identifier'
          host: 0.5
          user: 0.1

    RiskEngineInitStep:
      type: object
      required:
        - type
        - success
      properties:
        type:
          type: string
        success:
          type: boolean
        error:
          type: string
