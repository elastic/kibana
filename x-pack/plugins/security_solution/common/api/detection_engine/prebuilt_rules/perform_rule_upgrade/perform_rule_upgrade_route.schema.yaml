openapi: 3.0.0
info:
  title: Perform Rule Upgrade API endpoint
  version: '2023-10-31'
paths:
  /api/detection_engine/rules/prebuilt/_perform_upgrade:
    post:
      x-labels: [ess]
      x-codegen-enabled: true
      operationId: PerformRuleUpgrade
      summary: Perform rule upgrade
      description: Upgrade prebuilt detection rules.
      tags:
        - Rules API
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/UpgradeAllRulesRequest'
                - $ref: '#/components/schemas/UpgradeSpecificRulesRequest'
      responses:
        200:
          description: Indicates a successful call.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformRuleUpgradeResponseBody'

components:
  schemas:
    RulePickVersionValues:
      type: string
      enum: [BASE, CURRENT, TARGET, MERGED]

    FieldPickVersionValues:
      type: string
      enum: [BASE, CURRENT, TARGET, MERGED, RESOLVED]

    RuleUpgradeSpecifier:
      type: object
      required:
        - rule_id
        - revision
        - version
      properties:
        rule_id:
          $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleSignatureId'
        revision:
          type: number
        version:
          $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleVersion'
        pick_version:
          $ref: '#/components/schemas/RulePickVersionValues'
        fields:
          type: object
          description: |
           Fields that can be customized during the upgrade workflow
           as decided in: https://github.com/elastic/kibana/issues/186544
           Fields listed here, which are not specified in the request body,
           will default to a `pick_version` of `MERGED`.
          properties:
            name:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            tags:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            description:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            severity:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            severity_mapping:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            risk_score:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            risk_score_mapping:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            references:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            false_positives:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            note:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            setup:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            related_integrations:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            required_fields:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            max_signals:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            building_block_type:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            from:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            interval:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            exceptions_list:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            rule_name_override:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            timestamp_override:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            timestamp_override_fallback_disabled:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            timeline_id:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            timeline_title:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            index:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            data_view_id:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            query:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            language:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            filters:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            saved_id:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            machine_learning_job_id:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            anomaly_threshold:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat_query:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat_mapping:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat_index:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat_filters:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat_indicator_path:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            threat_language:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            new_terms_fields:
              $ref: '#/components/schemas/FieldUpgradeRequest'
            history_window_start:
              $ref: '#/components/schemas/FieldUpgradeRequest'

    FieldUpgradeRequest:
      type: object
      required:
        - pick_version
      properties:
        pick_version:
          type: string
          enum: [BASE, CURRENT, TARGET, MERGED, RESOLVED]
        resolved_value:
          oneOf:
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleName'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleTagArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleDescription'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/Severity'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/SeverityMapping'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RiskScore'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RiskScoreMapping'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleReferenceArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleFalsePositiveArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/ThreatArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/InvestigationGuide'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/SetupGuide'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RelatedIntegrationArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RequiredFieldArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RequiredFieldArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/MaxSignals'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/BuildingBlockType'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleIntervalFrom'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleInterval'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleExceptionList'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleNameOverride'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimestampOverride'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimestampOverrideFallbackDisabled'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimelineTemplateId'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimelineTemplateTitle'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/IndexPatternArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/DataViewId'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleQuery'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/QueryLanguage'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleFilterArray'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/SavedQueryId'
            - $ref: '../../model/rule_schema/specific_attributes/ml_attributes.schema.yaml#/components/schemas/MachineLearningJobId'
            - $ref: '../../model/rule_schema/specific_attributes/ml_attributes.schema.yaml#/components/schemas/AnomalyThreshold'
            - $ref: '../../model/rule_schema/specific_attributes/ml_attributes.schema.yaml#/components/schemas/AnomalyThreshold'
            - $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatQuery'
            - $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatMapping'
            - $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatIndex'
            - $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatFilters'
            - $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatIndicatorPath'
            - $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/KqlQueryLanguage' # threat_language
            - $ref: '../../model/rule_schema/specific_attributes/new_terms_attributes.schema.yaml#/components/schemas/NewTermsFields'
            - $ref: '../../model/rule_schema/specific_attributes/new_terms_attributes.schema.yaml#/components/schemas/HistoryWindowStart'

    UpgradeSpecificRulesRequest:
      type: object
      required:
        - mode
        - rules
      properties:
        mode:
          type: string
          enum: [SPECIFIC_RULES]
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleUpgradeSpecifier'
        pick_version:
          $ref: '#/components/schemas/RulePickVersionValues'

    UpgradeAllRulesRequest:
      type: object
      required:
        - mode
      properties:
        mode:
          type: string
          enum: [ALL_RULES]
        pick_version:
          $ref: '#/components/schemas/RulePickVersionValues'

    SkipRuleUpgradeReason:
      type: string
      enum: [RULE_UP_TO_DATE]

    SkippedRuleUpgrade:
      type: object
      required:
        - rule_id
        - reason
      properties:
        rule_id:
          type: string
        reason:
          $ref: '#/components/schemas/SkipRuleUpgradeReason'

    PerformRuleUpgradeResponseBody:
      type: object
      required:
        - summary
        - results
        - errors
      properties:
        summary:
          type: object
          required:
            - total
            - succeeded
            - skipped
            - failed
          properties:
            total:
              type: number
            succeeded:
              type: number
            skipped:
              type: number
            failed:
              type: number
        results:
          type: object
          required:
            - updated
            - skipped
          properties:
            updated:
              type: array
              items:
                $ref: '../../model/rule_schema/rule_schemas.schema.yaml#/components/schemas/RuleResponse'
            skipped:
              type: array
              items:
                $ref: '#/components/schemas/SkippedRuleUpgrade'
        errors:
          type: array
          items:
            $ref: '../../model/error_schema.schema.yaml#/components/schemas/ErrorSchema'