openapi: 3.0.0
info:
  title: Perform Rule Upgrade API endpoint
  version: '1'
paths:
  /internal/detection_engine/prebuilt_rules/upgrade/_perform:
    post:
      x-labels: [ess, serverless]
      x-codegen-enabled: true
      operationId: PerformRuleUpgrade
      summary: Perform rule upgrade
      description: Upgrade prebuilt detection rules.
      tags:
        - Rules API
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/UpgradeAllRulesRequest'
                - $ref: '#/components/schemas/UpgradeSpecificRulesRequest'
      responses:
        200:
          description: Indicates a successful call.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformRuleUpgradeResponseBody'

components:
  schemas:
    PickVersionValues:
      type: string
      description: |
        The version of the rule (or a specific field within a rule) to use for the upgrade.
        BASE - The version of a rule authored by Elastic as it is installed from the Prebuilt Security Detection Rules package, with no user customizations.
        CURRENT - The version of a rule as it is currently installed on the system. Consists of the base version of the rule plus all user customizations.
        TARGET - The updated version of a rule as it is distributed in the next version of the Prebuilt Security Detection Rules package.
        MERGED - The output version of a rule (or any of its fields) as a three way merge of the base, current, and target versions. This option is not always possible: if the three way merge results in a conflict which can't be automatically solved, the update will be rejected.
      enum: [BASE, CURRENT, TARGET, MERGED]

    RuleUpgradeSpecifier:
      type: object
      required:
        - rule_id
        - revision
        - version
      properties:
        rule_id:
          description: Rule's unique identifier. Should match the rule's signature ID returned from the Review Rule Upgrade API endpoint.
          $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleSignatureId'
        revision:
          description: Rule's current revision number. Should match the rule's revision number returned from the Review Rule Upgrade API endpoint.
          type: number
        version:
          description: The number of the version to which the rule is being upgraded to. Should match the rule's version number returned from the Review Rule Upgrade API endpoint.
          $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleVersion'
        pick_version:
          $ref: '#/components/schemas/PickVersionValues'
        fields:
          type: object
          description: |
            Fields that can be customized during the upgrade workflow
            as decided in: https://github.com/elastic/kibana/issues/186544
            Fields listed here, which are not specified in the request body,
            will default to a `pick_version` of `MERGED`.
          properties:
            name:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleName'
            tags:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleTagArray'
            description:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleDescription'
            severity:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/Severity'
            severity_mapping:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/SeverityMapping'
            risk_score:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RiskScore'
            risk_score_mapping:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RiskScoreMapping'
            references:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleReferenceArray'
            false_positives:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleFalsePositiveArray'
            threat:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/ThreatArray'
            note:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/InvestigationGuide'
            setup:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/SetupGuide'
            related_integrations:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RelatedIntegrationArray'
            required_fields:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RequiredFieldArray'
            max_signals:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/MaxSignals'
            building_block_type:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/BuildingBlockType'
            from:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleIntervalFrom'
            interval:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleInterval'
            exceptions_list:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleExceptionList'
            rule_name_override:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleNameOverride'
            timestamp_override:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimestampOverride'
            timestamp_override_fallback_disabled:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimestampOverrideFallbackDisabled'
            timeline_id:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimelineTemplateId'
            timeline_title:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/TimelineTemplateTitle'
            index:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/IndexPatternArray'
            data_view_id:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/DataViewId'
            query:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleQuery'
            language:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/QueryLanguage'
            filters:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/RuleFilterArray'
            saved_id:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/SavedQueryId'
            machine_learning_job_id:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/ml_attributes.schema.yaml#/components/schemas/MachineLearningJobId'
            anomaly_threshold:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/ml_attributes.schema.yaml#/components/schemas/AnomalyThreshold'
            threat_query:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatQuery'
            threat_mapping:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatMapping'
            threat_index:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatIndex'
            threat_filters:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatFilters'
            threat_indicator_path:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/threat_match_attributes.schema.yaml#/components/schemas/ThreatIndicatorPath'
            threat_language:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/common_attributes.schema.yaml#/components/schemas/KqlQueryLanguage'
            new_terms_fields:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/new_terms_attributes.schema.yaml#/components/schemas/NewTermsFields'
            history_window_start:
              oneOf:
                - type: object
                  required:
                    - pick_version
                  properties:
                    pick_version:
                      $ref: '#/components/schemas/PickVersionValues'
                - type: object
                  required:
                    - pick_version
                    - resolved_value
                  properties:
                    pick_version:
                      type: string
                      enum: [RESOLVED]
                    resolved_value:
                      $ref: '../../model/rule_schema/specific_attributes/new_terms_attributes.schema.yaml#/components/schemas/HistoryWindowStart'



    UpgradeSpecificRulesRequest:
      type: object
      required:
        - mode
        - rules
      properties:
        mode:
          type: string
          enum: [SPECIFIC_RULES]
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleUpgradeSpecifier'
        pick_version:
          $ref: '#/components/schemas/PickVersionValues'

    UpgradeAllRulesRequest:
      type: object
      required:
        - mode
      properties:
        mode:
          type: string
          enum: [ALL_RULES]
        pick_version:
          $ref: '#/components/schemas/PickVersionValues'

    SkipRuleUpgradeReason:
      type: string
      enum: [RULE_UP_TO_DATE, RULE_NOT_FOUND]

    SkippedRuleUpgrade:
      type: object
      required:
        - rule_id
        - reason
      properties:
        rule_id:
          type: string
        reason:
          $ref: '#/components/schemas/SkipRuleUpgradeReason'

    PerformRuleUpgradeResponseBody:
      type: object
      required:
        - summary
        - results
        - errors
      properties:
        summary:
          type: object
          required:
            - total
            - succeeded
            - skipped
            - failed
          properties:
            total:
              type: number
            succeeded:
              type: number
            skipped:
              type: number
            failed:
              type: number
        results:
          type: object
          required:
            - updated
            - skipped
          properties:
            updated:
              type: array
              items:
                $ref: '../../model/rule_schema/rule_schemas.schema.yaml#/components/schemas/RuleResponse'
            skipped:
              type: array
              items:
                $ref: '#/components/schemas/SkippedRuleUpgrade'
        errors:
          type: array
          items:
            $ref: '../../model/error_schema.schema.yaml#/components/schemas/ErrorSchema'