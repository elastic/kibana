/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import React, { useState } from 'react';
import {
  EuiPanel,
  EuiSkeletonText,
  EuiSpacer,
  EuiSteps,
  EuiButtonGroup,
  EuiIconTip,
  EuiCodeBlock,
  EuiLink,
} from '@elastic/eui';
import { i18n } from '@kbn/i18n';
import { useKibana } from '@kbn/kibana-react-plugin/public';
import { FormattedMessage } from '@kbn/i18n-react';
import { useFetcher } from '../../../hooks/use_fetcher';
import { EmptyPrompt } from '../shared/empty_prompt';
import { GetStartedPanel } from '../shared/get_started_panel';
import { FeedbackButtons } from '../shared/feedback_buttons';
import { CopyToClipboardButton } from '../shared/copy_to_clipboard_button';
import { ObservabilityOnboardingContextValue } from '../../../plugin';

export const OtelKubernetesPanel: React.FC = () => {
  const { data, error, refetch } = useFetcher(
    (callApi) => {
      return callApi('POST /internal/observability_onboarding/kubernetes/flow');
    },
    [],
    { showToastOnError: false }
  );
  const [idSelected, setIdSelected] = useState('nodejs');
  const {
    services: { share },
  } = useKibana<ObservabilityOnboardingContextValue>();
  const apmLocator = share.url.locators.get('APM_LOCATOR');

  if (error) {
    return <EmptyPrompt error={error} onRetryClick={refetch} />;
  }

  const addRepoCommand = `helm repo add open-telemetry 'https://open-telemetry.github.io/opentelemetry-helm-charts' --force-update`;

  const installStackCommand = data
    ? `kubectl create namespace opentelemetry-operator-system
kubectl create secret generic elastic-secret-otel \\
  --namespace opentelemetry-operator-system \\
  --from-literal=elastic_endpoint='${data.elasticsearchUrl}' \\
  --from-literal=elastic_api_key='${data.apiKeyEncoded}'
helm install opentelemetry-kube-stack open-telemetry/opentelemetry-kube-stack \\
  --namespace opentelemetry-operator-system \\
  --create-namespace \\
  --values 'https://raw.githubusercontent.com/elastic/opentelemetry-dev/main/docs/ingest/dev-docs/elastic-otel-collector/operator/onprem_kube_stack_values.yaml?token=GHSAT0AAAAAACR6STPQWQLOQA6I5ASIQ3WWZXALL7Q'`
    : undefined;

  return (
    <EuiPanel hasBorder paddingSize="xl">
      <EuiSteps
        steps={[
          {
            title: i18n.translate(
              'xpack.observability_onboarding.otelKubernetesPanel.addRepositoryStepTitle',
              {
                defaultMessage: 'Add the OpenTelemetry repository to Helm',
              }
            ),
            children: (
              <>
                <EuiCodeBlock paddingSize="m" language="bash">
                  {addRepoCommand}
                </EuiCodeBlock>
                <EuiSpacer />
                <CopyToClipboardButton textToCopy={addRepoCommand} />
              </>
            ),
          },
          {
            title: i18n.translate(
              'xpack.observability_onboarding.otelKubernetesPanel.installStackStepTitle',
              {
                defaultMessage: 'Install the OpenTelemetry Kube Stack',
              }
            ),
            children: installStackCommand ? (
              <>
                <p>
                  {i18n.translate(
                    'xpack.observability_onboarding.otelKubernetesPanel.p.injectAutoinstrumentationLibrariesForLabel',
                    {
                      defaultMessage:
                        'Upgrade the kube-stack Helm chart using the values file. This setup has an expiration of 365 days.',
                    }
                  )}{' '}
                  <EuiIconTip
                    content={i18n.translate(
                      'xpack.observability_onboarding.otelKubernetesPanel.helmsAutogeneratedTLSCertificatesTextLabel',
                      {
                        defaultMessage:
                          "Helm's autogenerated TLS certificates have a default expiration period of 365 days. These certificates are not renewed automatically unless theÂ release is manually updated. Enabling cert-manager allows for automatic certificate renewal.",
                      }
                    )}
                    position="top"
                    type="iInCircle"
                  />
                </p>
                <EuiSpacer />
                <EuiCodeBlock paddingSize="m" language="bash">
                  {installStackCommand}
                </EuiCodeBlock>
                <EuiSpacer />
                <CopyToClipboardButton textToCopy={installStackCommand} />
              </>
            ) : (
              <EuiSkeletonText lines={6} />
            ),
          },
          {
            title: i18n.translate(
              'xpack.observability_onboarding.otelKubernetesPanel.instrumentApplicationStepTitle',
              {
                defaultMessage: 'Instrument your applications',
              }
            ),
            children: (
              <>
                <p>
                  {i18n.translate(
                    'xpack.observability_onboarding.otelKubernetesPanel.p.injectAutoinstrumentationLibrariesForLabel',
                    {
                      defaultMessage:
                        'Annotate your applications to inject auto-instrumentation libraries for the languages below:',
                    }
                  )}
                </p>
                <EuiSpacer />
                <EuiButtonGroup
                  legend="Select a programming languages"
                  idSelected={idSelected}
                  onChange={(optionId) => setIdSelected(optionId)}
                  options={[
                    {
                      id: 'nodejs',
                      label: 'Node.js',
                    },
                    {
                      id: 'java',
                      label: 'Java',
                    },
                    {
                      id: 'python',
                      label: 'Python',
                    },
                    {
                      id: 'dotnet',
                      label: '.NET',
                    },
                    {
                      id: 'go',
                      label: 'Go',
                    },
                  ]}
                />
                <EuiSpacer />
                <EuiCodeBlock paddingSize="m" language="yaml" lineNumbers={{ highlight: '5-6' }}>
                  {`apiVersion: v1
kind: Pod
metadata:
  name: my-app
  annotations:
    instrumentation.opentelemetry.io/inject-${idSelected}: "true"
spec:
  containers:
  - name: my-app
    image: my-app:latest`}
                </EuiCodeBlock>
                <EuiSpacer />
                <CopyToClipboardButton
                  textToCopy={`annotations:
    instrumentation.opentelemetry.io/inject-${idSelected}: "true"`}
                />
                <EuiSpacer />
                <p>
                  <FormattedMessage
                    id="xpack.observability_onboarding.otelKubernetesPanel.p.forOtherLanguagesThatLabel"
                    defaultMessage="For other languages that require dependencies to be added to the source code, {link}"
                    values={{
                      link: (
                        <EuiLink
                          href={`/path`}
                          data-test-subj="observabilityOnboardingOtelKubernetesPanelReferToTheDocumentationLink"
                          target="_blank"
                        >
                          {i18n.translate(
                            'xpack.observability_onboarding.otelKubernetesPanel.referToTheDocumentationLinkLabel',
                            { defaultMessage: 'refer to the documentation' }
                          )}
                        </EuiLink>
                      ),
                    }}
                  />
                </p>
              </>
            ),
          },
          {
            title: i18n.translate(
              'xpack.observability_onboarding.otelKubernetesPanel.monitorStepTitle',
              {
                defaultMessage: 'Visualize your data',
              }
            ),
            children: (
              <GetStartedPanel
                newTab={false}
                isLoading={false}
                actionLinks={[
                  {
                    id: 'services',
                    title: i18n.translate(
                      'xpack.observability_onboarding.otelKubernetesPanel.servicesTitle',
                      {
                        defaultMessage: 'Check your application services:',
                      }
                    ),
                    label: i18n.translate(
                      'xpack.observability_onboarding.otelKubernetesPanel.servicesLabel',
                      {
                        defaultMessage: 'Explore Services Inventory',
                      }
                    ),
                    href: apmLocator?.getRedirectUrl({ serviceName: undefined }) ?? '',
                  },
                ]}
              />
            ),
          },
        ]}
      />
      <FeedbackButtons flow="otel_kubernetes" />
    </EuiPanel>
  );
};
