/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import React, { useMemo } from 'react';
import {
  Chart,
  Settings,
  Axis,
  BarSeries,
  timeFormatter,
  niceTimeFormatByDay,
  PartialTheme,
} from '@elastic/charts';
import { EuiButton } from '@elastic/eui';
import { i18n } from '@kbn/i18n';
import { FormattedMessage } from '@kbn/i18n-react';
import { useNavigateVulnerabilities } from '../../common/hooks/use_navigate_findings';
import { VulnSeverity } from '../../../common/types';
import { useVulnerabilityDashboardApi } from '../../common/api/use_vulnerability_dashboard_api';
import { getSeverityStatusColor } from '../../common/utils/get_vulnerability_colors';
import { ChartPanel } from '../../components/chart_panel';
import { VULNERABILITIES_SEVERITY } from '../../../common/constants';

const stackAccessors: VulnSeverity[] = [
  VULNERABILITIES_SEVERITY.CRITICAL,
  VULNERABILITIES_SEVERITY.HIGH,
  VULNERABILITIES_SEVERITY.MEDIUM,
  VULNERABILITIES_SEVERITY.LOW,
];

const chartStyle = { width: '100%', height: 300 };

const theme: PartialTheme = {
  scales: {
    barsPadding: 0.05, // Maintains low margins between bars when chart is full
  },
  legend: {
    spacingBuffer: 45,
  },
};

const ViewAllButton = () => {
  const navToVulnerabilities = useNavigateVulnerabilities();

  return (
    <EuiButton onClick={() => navToVulnerabilities()} size="s">
      <FormattedMessage
        id="xpack.csp.vulnerabilityDashboard.viewAllButton.buttonTitle"
        defaultMessage="View All"
      />
    </EuiButton>
  );
};

export const VulnerabilityTrendGraph = () => {
  const getVulnerabilityDashboard = useVulnerabilityDashboardApi();
  const trendData = getVulnerabilityDashboard.data?.vulnTrends || [];

  const bars: Array<{
    yAccessors: string[];
    color: string;
    id: VulnSeverity;
  }> = useMemo(
    () => [
      {
        id: VULNERABILITIES_SEVERITY.CRITICAL,
        yAccessors: ['critical'],
        color: getSeverityStatusColor(VULNERABILITIES_SEVERITY.CRITICAL),
      },
      {
        id: VULNERABILITIES_SEVERITY.HIGH,
        yAccessors: ['high'],
        color: getSeverityStatusColor(VULNERABILITIES_SEVERITY.HIGH),
      },
      {
        id: VULNERABILITIES_SEVERITY.MEDIUM,
        yAccessors: ['medium'],
        color: getSeverityStatusColor(VULNERABILITIES_SEVERITY.MEDIUM),
      },
      {
        id: VULNERABILITIES_SEVERITY.LOW,
        yAccessors: ['low'],
        color: getSeverityStatusColor(VULNERABILITIES_SEVERITY.LOW),
      },
    ],
    []
  );

  return (
    <ChartPanel
      title={i18n.translate(
        'xpack.csp.vulnerabilityDashboard.trendGraphChart.trendBySeverityTitle',
        {
          defaultMessage: 'Trend by severity',
        }
      )}
      rightSideItems={[<ViewAllButton key={'vulnerability-trend-graph-view-all-button'} />]}
    >
      <div style={chartStyle}>
        <Chart>
          <Settings legendPosition="right" showLegend theme={theme} />
          <Axis
            id="bottom"
            position={'bottom'}
            tickFormat={timeFormatter(niceTimeFormatByDay(2))}
          />
          <Axis id="left" position={'left'} tickFormat={(number) => number.toLocaleString()} />
          {bars.map((bar) => (
            <BarSeries
              key={bar.id}
              id={bar.id}
              xAccessor={'@timestamp'}
              yAccessors={bar.yAccessors}
              stackAccessors={stackAccessors}
              data={trendData}
              color={bar.color}
              minBarHeight={5}
              barSeriesStyle={{
                rect: {
                  // Limiting bars max width before 25 days of data
                  widthPixel: trendData.length < 25 ? 50 : undefined,
                },
              }}
            />
          ))}
        </Chart>
      </div>
    </ChartPanel>
  );
};
