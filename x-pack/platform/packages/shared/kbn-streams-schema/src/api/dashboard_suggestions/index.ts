/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import type { ChatCompletionTokenCount } from '@kbn/inference-common';
import type { TaskStatus } from '../../tasks/types';

/**
 * Column metadata for a panel's query result.
 * Used to map ESQL query columns to Lens visualization dimensions.
 */
export interface ColumnMetadata {
  columnId: string;
  fieldName: string;
  label: string;
  customLabel: boolean;
  meta: {
    type: string;
    esType?: string;
  };
  inMetricDimension?: boolean;
}

/**
 * Panel dimensions - maps query result columns to visual dimensions.
 */
export interface PanelDimensions {
  /** Column name for X axis (bar/line/area charts) */
  x?: string;
  /** Column name for Y axis/metric (bar/line/area charts) */
  y?: string;
  /** Column name for partitions (pie chart) */
  partition?: string;
  /** Column name for values/metric (pie chart) */
  value?: string;
  /** Column names to display (data table) */
  columns?: string[];
}

/**
 * Panel position in the dashboard grid.
 * Grid width is 48 units total.
 */
export interface PanelPosition {
  /** X position in grid columns (0-47) */
  x: number;
  /** Y position in grid rows */
  y: number;
  /** Panel width in grid units (max 48) */
  width: number;
  /** Panel height in grid units */
  height: number;
}

/**
 * Supported visualization types.
 */
export type PanelType = 'line_chart' | 'area_chart' | 'bar_chart' | 'pie_chart' | 'data_table';

/**
 * A single panel in the dashboard.
 */
export interface DashboardPanel {
  id: string;
  title: string;
  description?: string;
  type: PanelType;
  query: string;
  dimensions: PanelDimensions;
  position: PanelPosition;
  config?: Record<string, unknown>;
  columnMetadata?: ColumnMetadata[];
}

/**
 * Time range for the dashboard.
 */
export interface TimeRange {
  from: string;
  to: string;
}

/**
 * Dashboard filter definition.
 */
export interface DashboardFilter {
  field: string;
  label: string;
  type: 'terms' | 'range' | 'exists' | 'match';
  options?: string[];
}

/**
 * Raw dashboard structure as generated by the LLM.
 */
export interface RawDashboard {
  title: string;
  description?: string;
  panels: DashboardPanel[];
  timeRange: TimeRange;
  refreshInterval?: string;
  filters?: DashboardFilter[];
  tags?: string[];
}

/**
 * Input type indicator for dashboard suggestion.
 */
export type DashboardSuggestionInputType = 'ingest' | 'query';

/**
 * Result of dashboard suggestion for a single stream.
 * Suitable for storage in task completion payloads.
 */
export interface DashboardSuggestionResult {
  /** Name of the stream */
  streamName: string;
  /** Type of input data source used */
  inputType: DashboardSuggestionInputType;
  /** The generated dashboard suggestion (if successful) */
  dashboardSuggestion?: {
    /** Raw dashboard as generated by LLM */
    rawDashboard: RawDashboard;
  };
  /** Warning messages during generation */
  warnings: string[];
  /** Error message if generation failed */
  error?: string;
  /** Token usage statistics */
  tokensUsed?: ChatCompletionTokenCount;
}

/**
 * Task result type for dashboard suggestion task.
 * Uses discriminated union based on status.
 */
export type DashboardSuggestionTaskResult =
  | {
      status:
        | TaskStatus.NotStarted
        | TaskStatus.InProgress
        | TaskStatus.Stale
        | TaskStatus.BeingCanceled
        | TaskStatus.Canceled;
    }
  | {
      status: TaskStatus.Failed;
      error: string;
    }
  | ({
      status: TaskStatus.Completed | TaskStatus.Acknowledged;
    } & DashboardSuggestionResult);
