/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import expect from '@kbn/expect';
import type { Response as SupertestResponse } from 'supertest';
import { connectorsSpecs } from '@kbn/connector-specs';
import type { FtrProviderContext } from '../../ftr_provider_context';

const actionTypeIdsFromSpecs = new Set(
  Object.values(connectorsSpecs).map(({ metadata }) => `actions:${metadata.id}`)
);

export default function ({ getService }: FtrProviderContext) {
  const supertest = getService('supertest');

  function getRegisteredTypes() {
    return supertest
      .get(`/api/registered_tasks`)
      .expect(200)
      .then((response: SupertestResponse) => response.body);
  }

  const TEST_TYPES = [
    'sampleAdHocTaskTimingOut',
    'lowPriorityTask',
    'normalLongRunningPriorityTask',
    'sampleOneTimeTaskThrowingError',
    'sampleRecurringTaskDisablesItself',
    'sampleRecurringTaskTimingOut',
    'sampleRecurringTaskWhichHangs',
    'sampleRecurringTaskThatDeletesItself',
    'sampleTask',
    'sampleRecurringTask',
    'sampleTaskWithLimitedConcurrency',
    'sampleTaskWithSingleConcurrency',
    'sampleTaskSharedConcurrencyType1',
    'sampleTaskSharedConcurrencyType2',
    'singleAttemptSampleTask',
    'timedTask',
    'timedTaskWithLimitedConcurrency',
    'timedTaskWithSingleConcurrency',
    'taskToDisable',
    'sampleLongRunningRecurringTask',
  ];

  // This test is meant to fail when any change is made in task manager registered types.
  // The intent is to trigger a code review from the Response Ops team to review the new task type changes.
  describe('check_registered_task_types', () => {
    it('should check changes on all registered task types', async () => {
      const types = (await getRegisteredTypes())
        .filter((t: string) => !TEST_TYPES.includes(t) && !actionTypeIdsFromSpecs.has(t))
        .sort();
      expect(types).to.eql([
        'Fleet-Metrics-Task',
        'Fleet-Usage-Logger',
        'Fleet-Usage-Sender',
        'IndicesMetadata:IndicesMetadataTask',
        'ML:saved-objects-sync',
        'ProductDocBase:EnsureSecurityLabsUpToDate',
        'ProductDocBase:EnsureUpToDate',
        'ProductDocBase:InstallAll',
        'ProductDocBase:UninstallAll',
        'SLO:ORPHAN_SUMMARIES-CLEANUP-TASK',
        'SampleDataIngest:InstallSampleData',
        'Synthetics:Clean-Up-Package-Policies',
        'Synthetics:Sync-Global-Params-Private-Locations',
        'Synthetics:Sync-Private-Location-Monitors',
        'UPTIME:SyntheticsService:Sync-Saved-Monitor-Objects',
        'actions:.bedrock',
        'actions:.cases',
        'actions:.cases-webhook',
        'actions:.crowdstrike',
        'actions:.d3security',
        'actions:.email',
        'actions:.gemini',
        'actions:.gen-ai',
        'actions:.index',
        'actions:.inference',
        'actions:.jira',
        'actions:.jira-service-management',
        'actions:.mcp',
        'actions:.microsoft_defender_endpoint',
        'actions:.observability-ai-assistant',
        'actions:.opsgenie',
        'actions:.pagerduty',
        'actions:.resilient',
        `actions:.sentinelone`,
        'actions:.server-log',
        'actions:.servicenow',
        'actions:.servicenow-itom',
        'actions:.servicenow-sir',
        'actions:.slack',
        'actions:.slack_api',
        'actions:.swimlane',
        'actions:.teams',
        'actions:.thehive',
        'actions:.tines',
        'actions:.torq',
        'actions:.webhook',
        'actions:.workflows',
        'actions:.xmatters',
        'actions:.xsoar',
        'actions:connector_usage_reporting',
        'actions_telemetry',
        'ad_hoc_run-backfill',
        'agent-builder:run-agent',
        'alert-deletion',
        'alerting:.es-query',
        'alerting:.geo-containment',
        'alerting:.index-threshold',
        'alerting:apm.anomaly',
        'alerting:apm.error_rate',
        'alerting:apm.transaction_duration',
        'alerting:apm.transaction_error_rate',
        'alerting:attack-discovery',
        'alerting:datasetQuality.degradedDocs',
        'alerting:logs.alert.document.count',
        'alerting:metrics.alert.inventory.threshold',
        'alerting:metrics.alert.threshold',
        'alerting:monitoring_alert_cluster_health',
        'alerting:monitoring_alert_cpu_usage',
        'alerting:monitoring_alert_disk_usage',
        'alerting:monitoring_alert_elasticsearch_version_mismatch',
        'alerting:monitoring_alert_jvm_memory_usage',
        'alerting:monitoring_alert_kibana_version_mismatch',
        'alerting:monitoring_alert_license_expiration',
        'alerting:monitoring_alert_logstash_version_mismatch',
        'alerting:monitoring_alert_missing_monitoring_data',
        'alerting:monitoring_alert_nodes_changed',
        'alerting:monitoring_alert_thread_pool_search_rejections',
        'alerting:monitoring_alert_thread_pool_write_rejections',
        'alerting:monitoring_ccr_read_exceptions',
        'alerting:monitoring_shard_size',
        'alerting:observability.rules.custom_threshold',
        'alerting:siem.eqlRule',
        'alerting:siem.esqlRule',
        'alerting:siem.indicatorRule',
        'alerting:siem.mlRule',
        'alerting:siem.newTermsRule',
        'alerting:siem.notifications',
        'alerting:siem.queryRule',
        'alerting:siem.savedQueryRule',
        'alerting:siem.thresholdRule',
        'alerting:slo.rules.burnRate',
        'alerting:streams.rules.esql',
        'alerting:transform_health',
        'alerting:xpack.ml.anomaly_detection_alert',
        'alerting:xpack.ml.anomaly_detection_jobs_health',
        'alerting:xpack.synthetics.alerts.monitorStatus',
        'alerting:xpack.synthetics.alerts.tls',
        'alerting:xpack.uptime.alerts.durationAnomaly',
        'alerting:xpack.uptime.alerts.monitorStatus',
        'alerting:xpack.uptime.alerts.tls',
        'alerting:xpack.uptime.alerts.tlsCertificate',
        'alerting_health_check',
        'alerting_telemetry',
        'alerts_invalidate_api_keys',
        'apm-source-map-migration-task',
        'apm-telemetry-task',
        'cai:cases_analytics_index_backfill',
        'cai:cases_analytics_index_scheduler',
        'cai:cases_analytics_index_synchronization',
        'cases-telemetry-task',
        'cases_incremental_id_assignment',
        'cloud_security_posture-stats_task',
        'dashboard_telemetry',
        'data-sources:bulk-delete-task',
        'endpoint:complete-external-response-actions',
        'endpoint:metadata-check-transforms-task',
        'endpoint:user-artifact-packager',
        'entity_analytics:monitoring:privileges:engine',
        'entity_store:data_view:refresh',
        'entity_store:field_retention:enrichment',
        'entity_store:health',
        'entity_store:snapshot',
        'entity_store:v2:extract_entity_task:generic',
        'entity_store:v2:extract_entity_task:host',
        'entity_store:v2:extract_entity_task:service',
        'entity_store:v2:extract_entity_task:user',
        'fleet:agent-status-change-task',
        'fleet:agentless-deployment-sync-task',
        'fleet:auto-install-content-packages-task',
        'fleet:automatic-agent-upgrade-task',
        'fleet:bump_agent_policies',
        'fleet:check-deleted-files-task',
        'fleet:delete-unenrolled-agents-task',
        'fleet:deploy_agent_policies',
        'fleet:migrate_action:retry',
        'fleet:packages-bulk-operations',
        'fleet:policy-revisions-cleanup-task',
        'fleet:privilege_level_change:retry',
        'fleet:reassign_action:retry',
        'fleet:reassign_agents_to_version_specific_policies',
        'fleet:reindex_integration_knowledge',
        'fleet:request_diagnostics:retry',
        'fleet:rollback_action:retry',
        'fleet:setup',
        'fleet:setup:upgrade_managed_package_policies',
        'fleet:sync-integrations-task',
        'fleet:unenroll-inactive-agents-task',
        'fleet:unenroll_action:retry',
        'fleet:update_agent_tags:retry',
        'fleet:upgrade-agentless-deployments-task',
        'fleet:upgrade_action:retry',
        'fleet:version-specific-policy-assignment-task',
        'gap-auto-fill-scheduler-task',
        'maintenance-window:generate-events',
        'osquery:telemetry-configs',
        'osquery:telemetry-packs',
        'osquery:telemetry-saved-queries',
        'report:execute',
        'report:execute-scheduled',
        'reporting_telemetry',
        'risk_engine:risk_scoring',
        'search:agentless-connectors-manager',
        'security-solution-ea-asset-criticality-ecs-migration',
        'security:endpoint-diagnostics',
        'security:endpoint-meta-telemetry',
        'security:health-diagnostic',
        'security:indices-metadata-telemetry',
        'security:ingest-pipelines-stats-telemetry',
        'security:telemetry-configuration',
        'security:telemetry-detection-rules',
        'security:telemetry-diagnostic-timelines',
        'security:telemetry-filterlist-artifact',
        'security:telemetry-lists',
        'security:telemetry-prebuilt-rule-alerts',
        'security:telemetry-response-actions-rules',
        'security:telemetry-timelines',
        'security:trial-companion-milestone',
        'session_cleanup',
        'slo:bulk-delete-task',
        'slo:health-scan-task',
        'slo:stale-instances-cleanup-task',
        'slo:temp-summary-cleanup-task',
        'streams_description_generation',
        'streams_features_identification',
        'streams_insights_discovery',
        'streams_onboarding',
        'streams_significant_events_queries_generation',
        'streams_systems_identification',
        'task_manager:delete_inactive_background_task_nodes',
        'task_manager:invalidate_api_keys',
        'task_manager:mark_removed_tasks_as_unrecognized',
        'unusedUrlsCleanupTask',
        'workflow:resume',
        'workflow:run',
        'workflow:scheduled',
      ]);
    });
  });
}
