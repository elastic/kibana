# COMPLETION

The `COMPLETION` command provides a general-purpose interface for
text generation tasks using a Large Language Model (LLM) in ES|QL.
`COMPLETION` supports a wide range of text generation tasks. Depending on your
prompt and the model you use, you can perform arbitrary text generation tasks
including:
- Question answering
- Summarization
- Translation
- Content rewriting
- Creative generation

The `COMPLETION` command allows you to send prompts and context to a Large Language Model (LLM) directly within your ESQL queries, to perform text generation tasks.
<important>
  **Every row processed by the COMPLETION command generates a separate API call to the LLM endpoint.**
  <tab-set>
    <tab-item title="9.3.0+">
      Starting in version 9.3.0, `COMPLETION` automatically limits processing to **100 rows by default** to prevent accidental high consumption and costs. This limit is applied before the `COMPLETION` command executes.If you need to process more rows, you can adjust the limit using the cluster setting:
      ```
      PUT _cluster/settings
      {
        "persistent": {
          "esql.command.completion.limit": 500
        }
      }
      ```
      You can also disable the command entirely if needed:
      ```
      PUT _cluster/settings
      {
        "persistent": {
          "esql.command.completion.enabled": false
        }
      }
      ```
    </tab-item>

    <tab-item title="9.1.x - 9.2.x">
      Be careful to test with small datasets first before running on production data or in automated workflows, to avoid unexpected costs.Best practices:
      1. **Start with dry runs**: Validate your query logic and row counts by running without `COMPLETION` initially. Use `| STATS count = COUNT(*)` to check result size.
      2. **Filter first**: Use `WHERE` clauses to limit rows before applying `COMPLETION`.
      3. **Test with `LIMIT`**: Always start with a low `LIMIT` and gradually increase.
      4. **Monitor usage**: Track your LLM API consumption and costs.
    </tab-item>
  </tab-set>
</important>

**Syntax**
<tab-set>
  <tab-item title="9.2.0+">
    ```esql
    COMPLETION [column =] prompt WITH { "inference_id" : "my_inference_endpoint" }
    ```
  </tab-item>

  <tab-item title="9.1.x only">
    ```esql
    COMPLETION [column =] prompt WITH my_inference_endpoint
    ```
  </tab-item>
</tab-set>

### Parameters

#### `column`

(Optional) The name of the output column containing the LLM's response.
 If not specified, the results will be stored in a column named `completion`.
 If the specified column already exists, it will be overwritten with the new results.

#### `prompt`

The input text or expression used to prompt the LLM.
 This can be a string literal or a reference to a column containing text.

#### `my_inference_endpoint`

The ID of the inference endpoint to use for the task.
 The inference endpoint must be configured with the `completion` task type.

**Requirements**
To use this command, you must deploy your LLM model in Elasticsearch as
an inference endpoint with the
task type `completion`.

#### Handling timeouts

`COMPLETION` commands may time out when processing large datasets or complex prompts. The default timeout is 10 minutes, but you can increase this limit if necessary.
How you increase the timeout depends on your deployment type:
<tab-set>
  <tab-item title="Elastic Cloud Hosted">
    - You can adjust Elasticsearch settings in the Elastic Cloud Console
    - You can also adjust the `search.default_search_timeout` cluster setting using Kibana's Advanced settings
  </tab-item>

  <tab-item title="Self-managed">
    - You can configure at the cluster level by setting `search.default_search_timeout` in `elasticsearch.yml` or updating via Cluster Settings API
    - You can also adjust the `search:timeout` setting using Kibana's Advanced settings
    - Alternatively, you can add timeout parameters to individual queries
  </tab-item>

  <tab-item title="Elastic Cloud Serverless">
    - Requires a manual override from Elastic Support because you cannot modify timeout settings directly
  </tab-item>
</tab-set>

If you don't want to increase the timeout limit, try the following:
- Reduce data volume with `LIMIT` or more selective filters before the `COMPLETION` command
- Split complex operations into multiple simpler queries
- Configure your HTTP client's response timeout (Refer to HTTP client configuration)

**Examples**
Use the default column name (results stored in `completion` column):
```esql
ROW question = "What is Elasticsearch?"
| COMPLETION question WITH { "inference_id" : "my_inference_endpoint" }
| KEEP question, completion
```

Specify the output column (results stored in `answer` column):
```esql
ROW question = "What is Elasticsearch?"
| COMPLETION answer = question WITH { "inference_id" : "my_inference_endpoint" }
| KEEP question, answer
```

Summarize the top 10 highest-rated movies using a prompt:
```esql
FROM movies
| SORT rating DESC
| LIMIT 10
| EVAL prompt = CONCAT(
   "Summarize this movie using the following information: \n",
   "Title: ", title, "\n",
   "Synopsis: ", synopsis, "\n",
   "Actors: ", MV_CONCAT(actors, ", "), "\n",
  )
| COMPLETION summary = prompt WITH { "inference_id" : "my_inference_endpoint" }
| KEEP title, summary, rating
```

