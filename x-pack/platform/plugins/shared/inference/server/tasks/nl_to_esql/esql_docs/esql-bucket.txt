# BUCKET

The BUCKET function creates groups of values, known as buckets, from a datetime or numeric input. Buckets can be sized directly or determined based on a recommended count and value range.

## Syntax

`BUCKET(field, buckets, from, to)`

### Parameters

#### field

Numeric or date expression from which to derive buckets.

#### buckets

Target number of buckets, or desired bucket size if `from` and `to` parameters are omitted.

#### from

Start of the range. Can be a number, a date, or a date expressed as a string.

#### to

End of the range. Can be a number, a date, or a date expressed as a string.

## Examples

Create monthly buckets for a year by specifying a target number of buckets and a date range:

This query selects employees hired in 1985, sorts their hire dates, and groups them into approximately 20 buckets (roughly monthly) within the year 1985.

```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hire_date = MV_SORT(VALUES(hire_date)) BY month = BUCKET(hire_date, 20, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
```

Combine BUCKET with an aggregation to create a histogram of hires per month:

This query counts how many employees were hired in each month of 1985 by grouping hire dates into 20 buckets (roughly monthly) and sorting the results by month.

```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hires_per_month = COUNT(*) BY month = BUCKET(hire_date, 20, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
| SORT month
```

Create weekly buckets by asking for more buckets in the same range:

This query counts the number of employees hired each week in 1985 by dividing the year into 100 buckets (approximately weekly).

```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hires_per_week = COUNT(*) BY week = BUCKET(hire_date, 100, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
```

Specify the bucket size directly when known, such as weekly buckets:

This query creates buckets of exactly one week for hire dates in 1985 and counts the number of hires per week, sorting the results by week.

```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hires_per_week = COUNT(*) BY week = BUCKET(hire_date, 1 week)
| SORT week
```

Create a salary histogram by bucketing numeric values:

This query divides salary values into 20 buckets between 25,324 and 74,999 and counts the number of employees in each salary bucket, sorting the results by bucket.

```esql
FROM employees
| STATS COUNT(*) by bs = BUCKET(salary, 20, 25324, 74999)
| SORT bs
```

Specify the bucket size directly for numeric fields:

This query creates salary buckets of size 5,000 for employees hired in 1985 and counts the number of employees in each bucket, sorting the results by bucket.

```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS c = COUNT(1) BY b = BUCKET(salary, 5000.)
| SORT b
```

Create hourly buckets for the last 24 hours and count events per hour:

This query counts the number of events that occurred in each hour over the last 24 hours by dividing the time range into 25 buckets (approximately one per hour).

```esql
FROM sample_data
| WHERE @timestamp >= NOW() - 1 day and @timestamp < NOW()
| STATS COUNT(*) BY bucket = BUCKET(@timestamp, 25, NOW() - 1 day, NOW())
```

Calculate average salary by hiring month using monthly buckets:

This query calculates the average salary of employees hired in each month of 1985 by grouping hire dates into 20 buckets (roughly monthly).

```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS AVG(salary) BY bucket = BUCKET(hire_date, 20, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
```

Use BUCKET in both the aggregating and grouping part of the STATS command:

This query demonstrates advanced usage of the BUCKET function by applying it to both the aggregation and grouping expressions. It creates two sets of buckets based on salary calculations, performs arithmetic on the results, and sorts the output.

```esql
FROM employees
| STATS s1 = b1 + 1, s2 = BUCKET(salary / 1000 + 999, 50.) + 2 BY b1 = BUCKET(salary / 100 + 99, 50.), b2 = BUCKET(salary / 1000 + 999, 50.)
| SORT b1, b2
| KEEP s1, b1, s2, b2
```

Adjust the start value of each bucket by a given duration, such as offsetting buckets by one hour:

This query creates yearly buckets for employee birth dates, offsetting each bucket by one hour, and counts the number of dates in each bucket.

```esql
FROM employees
| STATS dates = MV_SORT(VALUES(birth_date)) BY b = BUCKET(birth_date + 1 HOUR, 1 YEAR) - 1 HOUR
| EVAL d_count = MV_COUNT(dates)
```

## Limitations

- BUCKET does not create buckets that do not match any documents; only buckets with matching data are returned.
- BUCKET does not filter rows outside the provided range; it assigns out-of-range values to corresponding buckets outside the range. Use WHERE to filter rows as needed.
- When specifying the bucket size directly, the value must be a time duration or date period, and the reference epoch is `0001-01-01T00:00:00Z`.
- For numeric fields, you must manually determine the minimum and maximum values for the range, as automatic calculation is not available.