# BUCKET

The BUCKET function creates groups of values, called buckets, from a datetime or numeric input. Buckets can be sized directly or determined based on a recommended count and value range.

## Syntax

`BUCKET(field, buckets, from, to)`

### Parameters

#### field

Numeric or date expression from which to derive buckets.

#### buckets

Target number of buckets, or desired bucket size if `from` and `to` parameters are omitted.

#### from

Start of the range. Can be a number, a date, or a date expressed as a string.

#### to

End of the range. Can be a number, a date, or a date expressed as a string.

## Examples

Generate monthly buckets for a year by specifying a target number of buckets and a date range:
This query groups employee hire dates from 1985 into 20 monthly buckets and sorts the dates within each bucket.
```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hire_date = MV_SORT(VALUES(hire_date)) BY month = BUCKET(hire_date, 20, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
```

Create a histogram of hires per month using BUCKET with aggregation:
Counts the number of employees hired in each of 20 monthly buckets for the year 1985 and sorts the results by month.
```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hires_per_month = COUNT(*) BY month = BUCKET(hire_date, 20, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
| SORT month
```

Generate weekly buckets for a year by requesting more buckets:
Counts the number of employees hired in each of 100 weekly buckets for the year 1985.
```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hires_per_week = COUNT(*) BY week = BUCKET(hire_date, 100, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
```

Specify the bucket size directly to create weekly buckets:
Counts the number of employees hired in each week of 1985 by directly specifying a weekly bucket size and sorts the results by week.
```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS hires_per_week = COUNT(*) BY week = BUCKET(hire_date, 1 week)
| SORT week
```

Create a salary histogram by bucketing numeric values:
Counts the number of employees whose salaries fall into each of 20 buckets between 25,324 and 74,999, and sorts the buckets.
```esql
FROM employees
| STATS COUNT(*) by bs = BUCKET(salary, 20, 25324, 74999)
| SORT bs
```

Bucket numeric values by a fixed size:
Counts the number of employees in each salary bucket of size 5,000 for hires in 1985, and sorts the buckets.
```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS c = COUNT(1) BY b = BUCKET(salary, 5000.)
| SORT b
```

Create hourly buckets for the last 24 hours and count events per hour:
Counts the number of events in each hourly bucket over the last 24 hours.
```esql
FROM sample_data
| WHERE @timestamp >= NOW() - 1 day and @timestamp < NOW()
| STATS COUNT(*) BY bucket = BUCKET(@timestamp, 25, NOW() - 1 day, NOW())
```

Calculate the average salary by hiring month using monthly buckets:
Calculates the average salary of employees hired in each of 20 monthly buckets for the year 1985.
```esql
FROM employees
| WHERE hire_date >= "1985-01-01T00:00:00Z" AND hire_date < "1986-01-01T00:00:00Z"
| STATS AVG(salary) BY bucket = BUCKET(hire_date, 20, "1985-01-01T00:00:00Z", "1986-01-01T00:00:00Z")
```

Use BUCKET in both the aggregating and grouping part of the STATS command:
Performs calculations and bucketing on salary values, grouping and aggregating by two different bucketed salary ranges, then sorts and keeps selected columns.
```esql
FROM employees
| STATS s1 = b1 + 1, s2 = BUCKET(salary / 1000 + 999, 50.) + 2 BY b1 = BUCKET(salary / 100 + 99, 50.), b2 = BUCKET(salary / 1000 + 999, 50.)
| SORT b1, b2
| KEEP s1, b1, s2, b2
```

Adjust the start value of each bucket by a given duration, such as offsetting buckets by one hour:
Groups birth dates into yearly buckets offset by one hour, sorts the dates within each bucket, and counts the number of dates per bucket.
```esql
FROM employees
| STATS dates = MV_SORT(VALUES(birth_date)) BY b = BUCKET(birth_date + 1 HOUR, 1 YEAR) - 1 HOUR
| EVAL d_count = MV_COUNT(dates)
```

## Limitations

- BUCKET does not create buckets that do not match any documents; only buckets with matching data are returned.
- BUCKET does not filter rows outside the provided range; it returns bucket values for all rows, including those outside the range. Use WHERE to filter rows as needed.
- When specifying the bucket size directly, the value must be a time duration or date period, and the reference is the epoch starting at `0001-01-01T00:00:00Z`.
- For numeric bucketing, you must manually determine the minimum and maximum values for the range, as there is no automatic way to do this.