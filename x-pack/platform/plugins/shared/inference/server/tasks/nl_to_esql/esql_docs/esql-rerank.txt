# RERANK

The RERANK command uses an inference model to compute a new relevance score for an initial set of documents. It is typically used after filtering and limiting the dataset to a manageable size, balancing performance and accuracy. RERANK processes each row through an inference model, which can impact performance and costs. By default, processing is limited to 1000 rows starting from version 9.3.0, but this can be adjusted or disabled via cluster settings. For earlier versions, it is recommended to use LIMIT before or after RERANK to control the number of documents processed. Timeout settings may need adjustment for large datasets or complex queries.

## Syntax

`RERANK [column =] query ON field [, field, ...] [WITH { "inference_id" : "my_inference_endpoint" }]`

### Parameters

#### column

Optional. The name of the output column containing the reranked scores. If not specified, results are stored in a column named `_score`. If the specified column already exists, it will be overwritten.

#### query

The query text used to rerank the documents. This is typically the same query used in the initial search.

#### field

One or more fields to use for reranking. These fields should contain the text that the reranking model will evaluate.

#### my_inference_endpoint

The ID of the inference endpoint to use for the task. The inference endpoint must be configured with the `rerank` task type.

## Examples

Rerank search results using a simple query and a single field:

This query retrieves books whose description matches "hobbit", sorts them by their initial relevance score, limits the results to the top 100, and then reranks those results using a machine learning model based on the description field. Finally, it limits the output to the top 3 reranked books and displays their titles and scores.

```esql
FROM books METADATA _score
| WHERE MATCH(description, "hobbit")
| SORT _score DESC
| LIMIT 100
| RERANK "hobbit" ON description WITH { "inference_id" : "test_reranker" }
| LIMIT 3
| KEEP title, _score
```

Rerank search results using a query and multiple fields, and store the new score in a column named `rerank_score`:

This query finds books where either the description contains "hobbit" or the author is "Tolkien", sorts them by their initial score, and limits to the top 100. It then reranks these results using a model that considers both the description and author fields, storing the new score in a column called `rerank_score`. The results are sorted by the reranked score, limited to the top 3, and the output includes the title, original score, and reranked score.

```esql
FROM books METADATA _score
| WHERE MATCH(description, "hobbit") OR MATCH(author, "Tolkien")
| SORT _score DESC
| LIMIT 100
| RERANK rerank_score = "hobbit" ON description, author WITH { "inference_id" : "test_reranker" }
| SORT rerank_score
| LIMIT 3
| KEEP title, _score, rerank_score
```

Combine the original score with the reranked score:

This query retrieves books matching "hobbit" in the description or "Tolkien" as the author, sorts and limits to the top 100 by initial score, and reranks them using a model based on both description and author fields. It then creates a new column for the original score, combines it with the reranked score to produce a final score, sorts by this combined score, and limits the output to the top 3 books, showing the title, original score, reranked score, and combined score.

```esql
FROM books METADATA _score
| WHERE MATCH(description, "hobbit") OR MATCH(author, "Tolkien")
| SORT _score DESC
| LIMIT 100
| RERANK rerank_score = "hobbit" ON description, author WITH { "inference_id" : "test_reranker" }
| EVAL original_score = _score, _score = rerank_score + original_score
| SORT _score
| LIMIT 3
| KEEP title, original_score, rerank_score, _score
```

## Limitations

- Starting in version 9.3.0, RERANK automatically limits processing to 1000 rows by default. This limit can be changed or the command disabled via cluster settings.
- In version 9.2.x, no automatic row limit is applied. It is recommended to use LIMIT before or after RERANK to avoid high latency and increased costs.
- RERANK may time out when processing large datasets or complex queries. The default timeout is 10 minutes, and increasing it depends on your deployment type.
- To use RERANK, you must deploy your reranking model in Elasticsearch as an inference endpoint with the task type `rerank`.
- For Elastic Cloud Serverless, timeout settings require a manual override from Elastic Support.