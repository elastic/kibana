# RERANK

The RERANK command uses an inference model to compute a new relevance score for an initial set of documents. Typically, you first retrieve a set of documents using a `WHERE` clause with a function like `MATCH`, sort them by `_score`, and reduce the results using `LIMIT`. The RERANK command then processes this refined subset to balance performance and accuracy.

RERANK processes each row through an inference model, which can impact performance and costs. Starting with version 9.3.0, RERANK automatically limits processing to 1000 rows by default to prevent accidental high consumption. You can adjust this limit or disable the command entirely using cluster settings. In version 9.2.x, no automatic row limit is applied, so you should always use `LIMIT` before or after RERANK to control the number of documents processed.

## Syntax

`RERANK [column =] query ON field [, field, ...] [WITH { "inference_id" : "my_inference_endpoint" }]`

### Parameters

#### column

(Optional) The name of the output column containing the reranked scores. If not specified, the results are stored in a column named `_score`. If the specified column already exists, it will be overwritten with the new results.

#### query

The query text used to rerank the documents. This is typically the same query used in the initial search.

#### field

One or more fields to use for reranking. These fields should contain the text that the reranking model will evaluate.

#### my_inference_endpoint

The ID of the inference endpoint to use for the task. The inference endpoint must be configured with the `rerank` task type.

## Examples

Rerank search results using a simple query and a single field:

This query retrieves the top 100 books whose description matches "hobbit", reranks them using a model based on the description field, and returns the top 3 titles and their scores.

```esql
FROM books METADATA _score
| WHERE MATCH(description, "hobbit")
| SORT _score DESC
| LIMIT 100
| RERANK "hobbit" ON description WITH { "inference_id" : "test_reranker" }
| LIMIT 3
| KEEP title, _score
```

Rerank search results using a query and multiple fields, and store the new score in a column named `rerank_score`:

This query selects the top 100 books matching "hobbit" in the description or "Tolkien" as the author, reranks them using both fields, stores the new score in `rerank_score`, and returns the top 3 results with their titles and scores.

```esql
FROM books METADATA _score
| WHERE MATCH(description, "hobbit") OR MATCH(author, "Tolkien")
| SORT _score DESC
| LIMIT 100
| RERANK rerank_score = "hobbit" ON description, author WITH { "inference_id" : "test_reranker" }
| SORT rerank_score
| LIMIT 3
| KEEP title, _score, rerank_score
```

Combine the original score with the reranked score:

This query reranks the top 100 books matching "hobbit" or "Tolkien", adds the original and reranked scores together, and returns the top 3 results with both scores and the combined score.

```esql
FROM books METADATA _score
| WHERE MATCH(description, "hobbit") OR MATCH(author, "Tolkien")
| SORT _score DESC
| LIMIT 100
| RERANK rerank_score = "hobbit" ON description, author WITH { "inference_id" : "test_reranker" }
| EVAL original_score = _score, _score = rerank_score + original_score
| SORT _score
| LIMIT 3
| KEEP title, original_score, rerank_score, _score
```

## Limitations

- RERANK processes each row through an inference model, which can impact performance and costs.
- Starting in version 9.3.0, RERANK automatically limits processing to 1000 rows by default. You can adjust this limit or disable the command using cluster settings.
- In version 9.2.x, no automatic row limit is applied. You should always use `LIMIT` before or after RERANK to control the number of documents processed.
- RERANK commands may time out when processing large datasets or complex queries. The default timeout is 10 minutes, but you can increase this limit depending on your deployment type.
- To use this command, you must deploy your reranking model as an inference endpoint with the task type `rerank`.