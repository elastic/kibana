# FUSE

The FUSE command merges rows from multiple result sets and assigns new relevance scores. It enables hybrid search by combining and scoring results from multiple queries, typically used together with the FORK command. FUSE works by merging rows with matching key column values and assigning new relevance scores using the specified algorithm and values from the group and score columns.

## Syntax

Use default parameters:
`FUSE`

Specify custom parameters:
`FUSE <fuse_method> SCORE BY <score_column> GROUP BY <group_column> KEY BY <key_columns> WITH <options>`

### Parameters

#### fuse_method

Defaults to `RRF`. Can be either `RRF` (Reciprocal Rank Fusion) or `LINEAR` (linear combination of scores). Specifies the method used to assign new relevance scores.

#### options

Options for the selected fuse_method.

- For `RRF`:
  - `rank_constant`: Defaults to `60`. Represents the constant used in the RRF formula.
  - `weights`: Defaults to `{}`. Allows setting different weights for RRF scores based on group column values.

- For `LINEAR`:
  - `normalizer`: Defaults to `none`. Can be `none` or `minmax`. Specifies the score normalization method.
  - `weights`: Defaults to `{}`. Allows setting different weights for scores based on group column values.

#### score_column

Defaults to `_score`. Specifies which column to use for retrieving relevance scores of input rows and where to output the new relevance scores of merged rows.

#### group_column

Defaults to `_fork`. Specifies which column represents the result set.

#### key_columns

Defaults to `_id, _index`. Rows with matching key column values are merged.

## Examples

This query retrieves books, runs two separate searches (one using a lexical match on the title and one using a semantic match), and then merges the results using Reciprocal Rank Fusion (RRF) to calculate new relevance scores for each book.

```esql
FROM books METADATA _id, _index, _score 
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE 
```

This query retrieves books, performs two searches (lexical and semantic), and then combines the scores from both result sets using a linear combination method to produce new relevance scores.

```esql
FROM books METADATA _id, _index, _score 
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE LINEAR 
```

This query retrieves books, runs two searches (lexical and semantic), normalizes the scores from each result set using minmax normalization, and then combines them using a linear method to produce new relevance scores.

```esql
FROM books METADATA _id, _index, _score
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE LINEAR WITH { "normalizer": "minmax" } 
```

This query retrieves books, runs two searches (lexical and semantic), normalizes the scores using minmax normalization, and combines them using a linear method with custom weights (0.7 for the first fork and 0.3 for the second fork) to control the importance of each query branch in the final relevance score.

```esql
FROM books METADATA _id, _index, _score
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE LINEAR WITH { "weights": { "fork1": 0.7, "fork2": 0.3 }, "normalizer": "minmax" } 
```

## Limitations

- FUSE assumes that key_columns are single valued. If key_columns are multivalued, FUSE can produce unreliable relevance scores.
- FUSE automatically assigns a score value of NULL if the score_column or group_column are multivalued.
- FUSE assumes that the combination of key_columns and group_column is unique. If not, FUSE can produce unreliable relevance scores.