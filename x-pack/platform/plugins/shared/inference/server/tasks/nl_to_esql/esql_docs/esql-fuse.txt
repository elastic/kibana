# FUSE

The FUSE command merges rows from multiple result sets and assigns new relevance scores. It enables hybrid search by combining and scoring results from multiple queries, typically used together with the FORK command. FUSE works by merging rows with matching key column values and assigning new relevance scores using the specified algorithm and the values from the group and score columns.

## Syntax

Use default parameters:  
`FUSE`

Specify custom parameters:  
`FUSE <fuse_method> SCORE BY <score_column> GROUP BY <group_column> KEY BY <key_columns> WITH <options>`

### Parameters

#### fuse_method

Defaults to `RRF`. Can be either `RRF` (Reciprocal Rank Fusion) or `LINEAR` (linear combination of scores). Specifies the method used to assign new relevance scores.

#### options

Options for the selected `fuse_method`.

- When `fuse_method` is `RRF`:
  - **rank_constant**  
    Defaults to `60`. Represents the constant used in the RRF formula.
  - **weights**  
    Defaults to `{}`. Allows you to set different weights for RRF scores based on `group_column` values.

- When `fuse_method` is `LINEAR`:
  - **normalizer**  
    Defaults to `none`. Can be `none` or `minmax`. Specifies the score normalization method to apply.
  - **weights**  
    Defaults to `{}`. Allows you to set different weights for scores based on `group_column` values.

#### score_column

Defaults to `_score`. Specifies which column to use for retrieving the relevance scores of the input row and where to output the new relevance scores of the merged rows.

#### group_column

Defaults to `_fork`. Specifies which column represents the result set.

#### key_columns

Defaults to `_id, _index`. Rows with matching key column values are merged.

## Examples

Calculates fused relevance scores for books matching "Shakespeare" in either the title or semantic_title fields using Reciprocal Rank Fusion (RRF) by default:

```esql
FROM books METADATA _id, _index, _score 
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE 
```

Combines relevance scores for books matching "Shakespeare" in title or semantic_title using a linear combination method:

```esql
FROM books METADATA _id, _index, _score 
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE LINEAR 
```

Normalizes scores with the minmax method before linearly combining relevance scores for books matching "Shakespeare" in title or semantic_title:

```esql
FROM books METADATA _id, _index, _score
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE LINEAR WITH { "normalizer": "minmax" } 
```

Applies custom weights to scores from different query branches and normalizes them with minmax when combining relevance scores for books matching "Shakespeare":

```esql
FROM books METADATA _id, _index, _score
| FORK (WHERE title:"Shakespeare" | SORT _score DESC) 
       (WHERE semantic_title:"Shakespeare" | SORT _score DESC) 
| FUSE LINEAR WITH { "weights": { "fork1": 0.7, "fork2": 0.3 }, "normalizer": "minmax" } 
```

## Limitations

- FUSE assumes that `key_columns` are single valued. If `key_columns` are multivalued, FUSE can produce unreliable relevance scores.
- FUSE automatically assigns a score value of `NULL` if the `score_column` or `group_column` are multivalued.
- FUSE assumes that the combination of `key_columns` and `group_column` is unique. If not, FUSE can produce unreliable relevance scores.
- These limitations can occur if FUSE is not combined with FORK or if FUSE does not use the default metadata columns `_id`, `_index`, `_score`, and `_fork`.