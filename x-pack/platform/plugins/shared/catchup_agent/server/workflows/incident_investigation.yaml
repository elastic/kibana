version: '1'
name: 'Incident Investigation'
description: 'Comprehensive incident investigation workflow that fetches security alert/case details, searches observability alerts, Slack messages, GitHub PRs, and correlates all sources using entity extraction.'
enabled: true
tags:
  - security
  - incident
  - investigation
triggers:
  - type: manual
inputs:
  - type: string
    name: incident_id
    description: 'Security alert ID or case ID to investigate'
    required: true
  - type: string
    name: service_name
    description: 'Optional service name to search for related issues'
    required: false
  - type: string
    name: start
    description: 'ISO datetime string for the start time (defaults to 7 days ago)'
    required: false
    default: '__DYNAMIC_7D_AGO__'
steps:
  - name: fetch_security_alert_case
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.security.detections'
        tool_params:
          start: '{{ inputs.start }}'
          alert_id: '{{ inputs.incident_id }}'

  - name: search_observability_alerts
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.observability.summary'
        tool_params:
          start: '{{ inputs.start }}'
          service_name: '{{ inputs.service_name }}'

  - name: search_slack_for_mentions
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.external.slack'
        tool_params:
          since: '{{ inputs.start }}'
          keywords:
            - '{{ inputs.incident_id }}'
            - '{{ inputs.service_name }}'
          includeDMs: false

  - name: search_github
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.external.github'
        tool_params:
          since: '{{ inputs.start }}'
          keywords:
            - '{{ inputs.incident_id }}'
            - '{{ inputs.service_name }}'

  - name: extract_entities
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.correlation.entity_extraction'
        tool_params:
          data:
            security: '{{ steps.fetch_security_alert_case.output }}'
            observability: '{{ steps.search_observability_alerts.output }}'
            slack: '{{ steps.search_slack_for_mentions.output }}'
            github: '{{ steps.search_github.output }}'

  - name: correlate_all_sources
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.correlation.engine'
        tool_params:
          results:
            security_summary: '{{ steps.fetch_security_alert_case.output }}'
            observability: '{{ steps.search_observability_alerts.output }}'
            external:
              slack: '{{ steps.search_slack_for_mentions.output }}'
              github: '{{ steps.search_github.output }}'
          entities: '{{ steps.extract_entities.output }}'

  - name: generate_investigation_report
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'platform.catchup.summary.generator'
        tool_params:
          correlatedData:
            security_summary: '{{ steps.fetch_security_alert_case.output }}'
            observability: '{{ steps.search_observability_alerts.output }}'
            external:
              slack: '{{ steps.search_slack_for_mentions.output }}'
              github: '{{ steps.search_github.output }}'
            correlations: '{{ steps.correlate_all_sources.output }}'
          format: 'markdown'
