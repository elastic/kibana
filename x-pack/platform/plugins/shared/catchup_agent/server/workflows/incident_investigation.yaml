version: '1'
name: 'Incident Investigation'
description: 'Comprehensive incident investigation workflow that fetches security and observability data (alerts, cases, attack discoveries), extracts entities (host.name, user.name, service.name) from the incident, and correlates those entities across observability, security, and Slack.'
enabled: true
tags:
  - security
  - incident
  - investigation
triggers:
  - type: manual
inputs:
  - type: string
    name: incidentId
    description: 'Incident ID to investigate. Can be: security case ID, observability case ID, security alert ID, observability alert ID, or attack discovery ID. The workflow will fetch all data types and search for the specific incident across all sources.'
    required: true
  - type: string
    name: start
    description: 'ISO datetime string for the start time (defaults to 7 days ago)'
    required: false
    default: '__DYNAMIC_7D_AGO__'
  - type: string
    name: end
    description: 'ISO datetime string for the end time (defaults to now)'
    required: false
    default: '__DYNAMIC_NOW__'
steps:
  - name: calculate_time_range
    type: console
    with:
      message: 'Calculating time range for incident investigation'

  - name: fetch_incident
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.incident.fetch'
        tool_params:
          incidentId: '{{ inputs.incidentId }}'

  - name: fetch_security_data
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.workflow_tool_summarizer'
        tool_params:
          toolId: 'hackathon.catchup.security.summary'
          toolParams:
            start: '{{ inputs.start }}'
            end: '{{ inputs.end }}'

  - name: fetch_observability_data
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.observability.summary'
        tool_params:
          start: '{{ inputs.start }}'
          end: '{{ inputs.end }}'

  - name: extract_entities_from_incident
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.correlation.entity_extraction'
        tool_params:
          data:
            incident: '{{ steps.fetch_incident.output }}'
            security_summary: '{{ steps.fetch_security_data.output }}'
            observability: '{{ steps.fetch_observability_data.output }}'
            incidentId: '{{ inputs.incidentId }}'

  - name: search_alerts_by_entities
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.alerts.by_entities'
        tool_params:
          start: '{{ inputs.start }}'
          end: '{{ inputs.end }}'
          service_name: '{{ steps.extract_entities_from_incident.output.entities.service_names[0] }}'
          user_name: '{{ steps.extract_entities_from_incident.output.entities.user_names[0] }}'
          host_name: '{{ steps.extract_entities_from_incident.output.entities.host_names[0] }}'
          alert_types: ['both']
          limit: 100

  - name: search_slack_for_mentions
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.workflow_tool_summarizer'
        tool_params:
          toolId: 'hackathon.catchup.external.slack'
          toolParams:
            start: '{{ inputs.start }}'
            keywords:
              - '{{ inputs.incidentId }}'
              - '{{ steps.extract_entities_from_incident.output.entities.service_names[0] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.service_names[1] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.service_names[2] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.host_names[0] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.host_names[1] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.host_names[2] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.user_names[0] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.source_ips[0] }}'
              - '{{ steps.extract_entities_from_incident.output.entities.destination_ips[0] }}'
            includeDMs: false

  - name: correlate_all_sources
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.workflow_tool_summarizer'
        tool_params:
          toolId: 'hackathon.catchup.correlation.engine'
          toolParams:
            results:
              security_summary: '{{ steps.fetch_security_data.output }}'
              observability: '{{ steps.fetch_observability_data.output }}'
              external:
                slack: '{{ steps.search_slack_for_mentions.output }}'
            entities: '{{ steps.extract_entities_from_incident.output }}'

  - name: prioritize_correlations
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.workflow_tool_summarizer'
        tool_params:
          toolId: 'hackathon.catchup.prioritization.rerank'
          toolParams:
            items: '{{ steps.correlate_all_sources.output }}'
            query: 'security incident investigation critical alerts observability cases attack discoveries'
            limit: 20

  - name: generate_investigation_report
    type: kibana.request
    with:
      method: 'POST'
      path: '/api/agent_builder/tools/_execute'
      body:
        tool_id: 'hackathon.catchup.workflow_tool_summarizer'
        tool_params:
          toolId: 'hackathon.catchup.summary.generator'
          toolParams:
            correlatedData:
              security_summary: '{{ steps.fetch_security_data.output }}'
              observability: '{{ steps.fetch_observability_data.output }}'
              external:
                slack: '{{ steps.search_slack_for_mentions.output }}'
              correlations: '{{ steps.prioritize_correlations.output }}'
              entities: '{{ steps.extract_entities_from_incident.output }}'
              related_alerts: '{{ steps.search_alerts_by_entities.output }}'
            format: 'markdown'
            instructions: 'REQUIRED: All cases mentioned in the investigation report MUST include clickable links to their case detail pages. Format all case references as markdown links: [Case Title](case_url).'
