/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import { formatData } from './format_data';

describe('formatData', () => {
  test('should format data as expected', () => {
    expect(
      formatData({
        numRecurringTasks: 36,
        numNonrecurringTasks: 1,
        numTasks: 37,
        numBackgroundNodes: 2,
        byNode: [
          {
            serverUuid: '5b2de169-2785-441b-ae8c-186a1936b17d',
            claim: {
              success: 307,
              failure: 3,
              total: 310,
              metrics: [
                {
                  key: 1740512130000,
                  count: 11,
                  maxDuration: 2233,
                  avgDuration: 263.8,
                  maxLoad: 100,
                  avgLoad: 38.18181818181818,
                },
                {
                  key: 1740512140000,
                  count: 3,
                  maxDuration: 25,
                  avgDuration: 24.666666666666668,
                  maxLoad: 0,
                  avgLoad: 0,
                },
                {
                  key: 1740512150000,
                  count: 4,
                  maxDuration: 36,
                  avgDuration: 22,
                  maxLoad: 0,
                  avgLoad: 0,
                },
                {
                  key: 1740512160000,
                  count: 3,
                  maxDuration: 62,
                  avgDuration: 46.666666666666664,
                  maxLoad: 0,
                  avgLoad: 0,
                },
                {
                  key: 1740512170000,
                  count: 3,
                  maxDuration: 34,
                  avgDuration: 22.666666666666668,
                  maxLoad: 0,
                  avgLoad: 0,
                },
                {
                  key: 1740512180000,
                  count: 4,
                  maxDuration: 77,
                  avgDuration: 36.5,
                  maxLoad: 20,
                  avgLoad: 5,
                },
              ],
            },
            run: {
              success: 48,
              failure: 3,
              total: 51,
              by_task_type: {
                'Fleet-Metrics-Task': { success: 8, failure: 0, total: 8 },
                'endpoint:complete-external-response-actions': { success: 8, failure: 0, total: 8 },
                'endpoint:user-artifact-packager': { success: 8, failure: 0, total: 8 },
                'task_manager:delete_inactive_background_task_nodes': {
                  success: 8,
                  failure: 0,
                  total: 8,
                },
                alerting_health_check: { success: 2, failure: 0, total: 2 },
                alerts_invalidate_api_keys: { success: 2, failure: 0, total: 2 },
                'fleet:sync-integrations-task': { success: 2, failure: 0, total: 2 },
                'security:endpoint-diagnostics': { success: 0, failure: 2, total: 2 },
                'Fleet-Usage-Logger': { success: 1, failure: 0, total: 1 },
                'ML:saved-objects-sync': { success: 0, failure: 1, total: 1 },
              },
              errors: [
                {
                  message: 'fail fail fail',
                  byTaskType: [
                    {
                      count: 38,
                      type: 'alerting:example.always-firing',
                    },
                  ],
                },
              ],
              metrics: [
                {
                  key: 1740512130000,
                  count: 10,
                  maxDuration: 630,
                  avgDuration: 262.2,
                  maxScheduleDelay: 454572,
                  avgScheduleDelay: 241208.3,
                  maxEventLoop: 152,
                },
                {
                  key: 1740512140000,
                  count: 4,
                  maxDuration: 1272,
                  avgDuration: 376,
                  maxScheduleDelay: 214574,
                  avgScheduleDelay: 54540.25,
                  maxEventLoop: 152,
                },
                {
                  key: 1740512150000,
                  count: 3,
                  maxDuration: 39,
                  avgDuration: 33.666666666666664,
                  maxScheduleDelay: 1110,
                  avgScheduleDelay: 844.6666666666666,
                  maxEventLoop: 14,
                },
                {
                  key: 1740512160000,
                  count: 1,
                  maxDuration: 22,
                  avgDuration: 22,
                  maxScheduleDelay: 2770,
                  avgScheduleDelay: 2770,
                  maxEventLoop: 11,
                },
                {
                  key: 1740512170000,
                  count: 1,
                  maxDuration: 18,
                  avgDuration: 18,
                  maxScheduleDelay: 2844,
                  avgScheduleDelay: 2844,
                  maxEventLoop: 0,
                },
                {
                  key: 1740512180000,
                  count: 2,
                  maxDuration: 13,
                  avgDuration: 12,
                  maxScheduleDelay: 1092,
                  avgScheduleDelay: 1091.5,
                  maxEventLoop: 0,
                },
              ],
            },
          },
          {
            serverUuid: 'af7f16b1-8882-43fe-9942-c690b0a6da1d',
            claim: {
              success: 250,
              failure: 50,
              total: 300,
              metrics: [
                {
                  key: 1740512130000,
                  count: 3,
                  maxDuration: 54,
                  avgDuration: 34,
                  maxLoad: 20,
                  avgLoad: 16,
                },
                {
                  key: 1740512140000,
                  count: 3,
                  maxDuration: 78,
                  avgDuration: 30,
                  maxLoad: 60,
                  avgLoad: 44,
                },
                {
                  key: 1740512150000,
                  count: 2,
                  maxDuration: 120,
                  avgDuration: 33,
                  maxLoad: 80,
                  avgLoad: 10,
                },
                {
                  key: 1740512160000,
                  count: 3,
                  maxDuration: 99,
                  avgDuration: 77,
                  maxLoad: 30,
                  avgLoad: 10,
                },
                {
                  key: 1740512170000,
                  count: 5,
                  maxDuration: 44,
                  avgDuration: 12,
                  maxLoad: 0,
                  avgLoad: 0,
                },
                {
                  key: 1740512180000,
                  count: 1,
                  maxDuration: 20,
                  avgDuration: 20,
                  maxLoad: 10,
                  avgLoad: 10,
                },
              ],
            },
            run: {
              success: 34,
              failure: 0,
              total: 34,
              by_task_type: {
                'Fleet-Metrics-Task': { success: 8, failure: 0, total: 8 },
                'endpoint:user-artifact-packager': { success: 8, failure: 0, total: 8 },
                'task_manager:delete_inactive_background_task_nodes': {
                  success: 8,
                  failure: 0,
                  total: 8,
                },
                alerting_health_check: { success: 2, failure: 0, total: 2 },
                alerts_invalidate_api_keys: { success: 2, failure: 0, total: 2 },
                'fleet:sync-integrations-task': { success: 2, failure: 0, total: 2 },
                'security:endpoint-diagnostics': { success: 2, failure: 0, total: 2 },
                'Fleet-Usage-Logger': { success: 1, failure: 0, total: 1 },
                'ML:saved-objects-sync': { success: 1, failure: 0, total: 1 },
              },
              errors: [
                {
                  message: 'fail fail fail',
                  byTaskType: [
                    {
                      count: 21,
                      type: 'alerting:example.always-firing',
                    },
                  ],
                },
                {
                  message: 'something went wrong',
                  byTaskType: [
                    {
                      count: 3,
                      type: 'test.ruleType1',
                    },
                    {
                      count: 9,
                      type: 'test.ruleType2',
                    },
                  ],
                },
              ],
              metrics: [
                {
                  key: 1740512130000,
                  count: 10,
                  maxDuration: 630,
                  avgDuration: 262.2,
                  maxScheduleDelay: 2453,
                  avgScheduleDelay: 1532,
                  maxEventLoop: 99,
                },
                {
                  key: 1740512140000,
                  count: 4,
                  maxDuration: 1272,
                  avgDuration: 376,
                  maxScheduleDelay: 214574,
                  avgScheduleDelay: 54540.25,
                  maxEventLoop: 152,
                },
                {
                  key: 1740512150000,
                  count: 3,
                  maxDuration: 39,
                  avgDuration: 33.666666666666664,
                  maxScheduleDelay: 1110,
                  avgScheduleDelay: 844.6666666666666,
                  maxEventLoop: 14,
                },
                {
                  key: 1740512160000,
                  count: 1,
                  maxDuration: 22,
                  avgDuration: 22,
                  maxScheduleDelay: 2770,
                  avgScheduleDelay: 2770,
                  maxEventLoop: 11,
                },
                {
                  key: 1740512170000,
                  count: 1,
                  maxDuration: 18,
                  avgDuration: 18,
                  maxScheduleDelay: 2844,
                  avgScheduleDelay: 2844,
                  maxEventLoop: 0,
                },
                {
                  key: 1740512180000,
                  count: 2,
                  maxDuration: 13,
                  avgDuration: 12,
                  maxScheduleDelay: 1092,
                  avgScheduleDelay: 1091.5,
                  maxEventLoop: 0,
                },
              ],
            },
          },
        ],
      })
    ).toEqual({
      numBackgroundNodes: 2,
      numTasks: 37,
      numRecurringTasks: 36,
      taskRunErrors: [
        {
          message: 'fail fail fail',
          byTaskType: [
            {
              count: 59,
              type: 'alerting:example.always-firing',
            },
          ],
        },
        {
          message: 'something went wrong',
          byTaskType: [
            {
              count: 3,
              type: 'test.ruleType1',
            },
            {
              count: 9,
              type: 'test.ruleType2',
            },
          ],
        },
      ],
      taskTypeSuccess: [
        { success: 16, total: 16, type: 'Fleet-Metrics-Task' },
        { success: 8, total: 8, type: 'endpoint:complete-external-response-actions' },
        { success: 16, total: 16, type: 'endpoint:user-artifact-packager' },
        { success: 16, total: 16, type: 'task_manager:delete_inactive_background_task_nodes' },
        { success: 4, total: 4, type: 'alerting_health_check' },
        { success: 4, total: 4, type: 'alerts_invalidate_api_keys' },
        { success: 4, total: 4, type: 'fleet:sync-integrations-task' },
        { success: 2, total: 4, type: 'security:endpoint-diagnostics' },
        { success: 2, total: 2, type: 'Fleet-Usage-Logger' },
        { success: 1, total: 2, type: 'ML:saved-objects-sync' },
      ],
      claimDurationMetric: [
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 263.8],
            [1740512140000, 24.666666666666668],
            [1740512150000, 22],
            [1740512160000, 46.666666666666664],
            [1740512170000, 22.666666666666668],
            [1740512180000, 36.5],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each claim cycle',
            format: '0,0.[00]',
            label: `avg 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'avg',
            title: 'Avg Claim Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 34],
            [1740512140000, 30],
            [1740512150000, 33],
            [1740512160000, 77],
            [1740512170000, 12],
            [1740512180000, 20],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each claim cycle',
            format: '0,0.[00]',
            label: `avg af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'avg',
            title: 'Avg Claim Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 2233],
            [1740512140000, 25],
            [1740512150000, 36],
            [1740512160000, 62],
            [1740512170000, 34],
            [1740512180000, 77],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each claim cycle',
            format: '0,0.[00]',
            label: `max 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'max',
            title: 'Max Claim Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 54],
            [1740512140000, 78],
            [1740512150000, 120],
            [1740512160000, 99],
            [1740512170000, 44],
            [1740512180000, 20],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each claim cycle',
            format: '0,0.[00]',
            label: `max af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'max',
            title: 'Max Claim Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
      ],
      loadMetric: [
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 38.18181818181818],
            [1740512140000, 0],
            [1740512150000, 0],
            [1740512160000, 0],
            [1740512170000, 0],
            [1740512180000, 5],
          ],
          metric: {
            app: 'kibana',
            description: 'Task load during each claim cycle',
            format: '0,0.[00]',
            label: `avg 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'avg',
            title: 'Avg Load',
            units: '%',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 16],
            [1740512140000, 44],
            [1740512150000, 10],
            [1740512160000, 10],
            [1740512170000, 0],
            [1740512180000, 10],
          ],
          metric: {
            app: 'kibana',
            description: 'Task load during each claim cycle',
            format: '0,0.[00]',
            label: `avg af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'avg',
            title: 'Avg Load',
            units: '%',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 100],
            [1740512140000, 0],
            [1740512150000, 0],
            [1740512160000, 0],
            [1740512170000, 0],
            [1740512180000, 20],
          ],
          metric: {
            app: 'kibana',
            description: 'Task load during each claim cycle',
            format: '0,0.[00]',
            label: `max 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'max',
            title: 'Max Load',
            units: '%',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 20],
            [1740512140000, 60],
            [1740512150000, 80],
            [1740512160000, 30],
            [1740512170000, 0],
            [1740512180000, 10],
          ],
          metric: {
            app: 'kibana',
            description: 'Task load during each claim cycle',
            format: '0,0.[00]',
            label: `max af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'max',
            title: 'Max Load',
            units: '%',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
      ],
      runDurationMetric: [
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 262.2],
            [1740512140000, 376],
            [1740512150000, 33.666666666666664],
            [1740512160000, 22],
            [1740512170000, 18],
            [1740512180000, 12],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each task run',
            format: '0,0.[00]',
            label: `avg 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'avg',
            title: 'Avg Task Run Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 262.2],
            [1740512140000, 376],
            [1740512150000, 33.666666666666664],
            [1740512160000, 22],
            [1740512170000, 18],
            [1740512180000, 12],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each task run',
            format: '0,0.[00]',
            label: `avg af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'avg',
            title: 'Avg Task Run Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 630],
            [1740512140000, 1272],
            [1740512150000, 39],
            [1740512160000, 22],
            [1740512170000, 18],
            [1740512180000, 13],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each task run',
            format: '0,0.[00]',
            label: `max 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'max',
            title: 'Max Task Run Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 630],
            [1740512140000, 1272],
            [1740512150000, 39],
            [1740512160000, 22],
            [1740512170000, 18],
            [1740512180000, 13],
          ],
          metric: {
            app: 'kibana',
            description: 'Duration of each task run',
            format: '0,0.[00]',
            label: `max af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'max',
            title: 'Max Task Run Duration',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
      ],
      scheduleDelayMetric: [
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 241208.3],
            [1740512140000, 54540.25],
            [1740512150000, 844.6666666666666],
            [1740512160000, 2770],
            [1740512170000, 2844],
            [1740512180000, 1091.5],
          ],
          metric: {
            app: 'kibana',
            description: 'Schedule delay of each task',
            format: '0,0.[00]',
            label: `avg 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'avg',
            title: 'Avg Schedule Delay',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 1532],
            [1740512140000, 54540.25],
            [1740512150000, 844.6666666666666],
            [1740512160000, 2770],
            [1740512170000, 2844],
            [1740512180000, 1091.5],
          ],
          metric: {
            app: 'kibana',
            description: 'Schedule delay of each task',
            format: '0,0.[00]',
            label: `avg af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'avg',
            title: 'Avg Schedule Delay',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 454572],
            [1740512140000, 214574],
            [1740512150000, 1110],
            [1740512160000, 2770],
            [1740512170000, 2844],
            [1740512180000, 1092],
          ],
          metric: {
            app: 'kibana',
            description: 'Schedule delay of each task',
            format: '0,0.[00]',
            label: `max 5b2de169-2785-441b-ae8c-186a1936b17d`,
            metricAgg: 'max',
            title: 'Max Schedule Delay',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
        {
          bucket_size: '10 seconds',
          data: [
            [1740512130000, 2453],
            [1740512140000, 214574],
            [1740512150000, 1110],
            [1740512160000, 2770],
            [1740512170000, 2844],
            [1740512180000, 1092],
          ],
          metric: {
            app: 'kibana',
            description: 'Schedule delay of each task',
            format: '0,0.[00]',
            label: `max af7f16b1-8882-43fe-9942-c690b0a6da1d`,
            metricAgg: 'max',
            title: 'Max Schedule Delay',
            units: 'ms',
          },
          timeRange: {
            min: 1740512130000,
            max: 1740512180000,
          },
        },
      ],
    });
  });
});
