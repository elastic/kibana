version: "2.4"
services:
  cypress:
    build:
      context: ./ci
    container_name: cypress
    network_mode: "host"
    command: >
      /bin/bash -c "set -x
        export HOME=/tmp
        npm config set cache /tmp
        cd /app/x-pack/legacy/plugins/apm/cypress
        npm install
        yarn install
        ./node_modules/.bin/cypress run"
    volumes:
      - ../../../../..:/app
    user: ${USER_ID}
    depends_on:
      wait:
        condition: service_healthy

  ## https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds
  wait:
    image: yauritux/busybox-curl
    network_mode: "host"
    command: tail -f /dev/null
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "curl -s -o /dev/null -w '%{http_code}' host.docker.internal:5601/status"]
      retries: 50
      interval: 10s
