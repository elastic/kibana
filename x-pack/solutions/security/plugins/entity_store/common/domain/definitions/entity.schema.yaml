openapi: 3.0.0
info:
  title: Common Entities Schemas
  description: Common Entities schemas for the Entity Store
  version: '1'
paths: {}
components:
  schemas:
    EngineMetadata: 
      type: object
      additionalProperties: false
      required: 
        - Type
      properties:
        Type:
          type: string

    EntityField:
      type: object
      additionalProperties: false
      required:
        - id
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
        sub_type:
          type: string
        source:
          type: string
        EngineMetadata:
          $ref: '#/components/schemas/EngineMetadata'
        attributes:
          type: object
          additionalProperties: false
          properties:
            privileged:
              type: boolean
            asset:
              type: boolean
            managed:
              type: boolean
            mfa_enabled:
              type: boolean
        behaviors: 
          type: object
          additionalProperties: false
          properties:
            brute_force_victim:
              type: boolean
            new_country_login:
              type: boolean
            used_usb_device:
              type: boolean
        lifecycle:
          type: object
          additionalProperties: false
          properties:
            first_seen:
              type: string
              format: date-time
            last_activity:
              type: string
              format: date-time
        relationships:
          type: object
          additionalProperties: false
          properties:
            communicates_with:
              type: array
              items:
                type: string
            depends_on:
              type: array
              items:
                type: string
            dependent_of:
              type: array
              items:
                type: string
            owns:
              type: array
              items:
                type: string
            owned_by:
              type: array
              items:
                type: string
            accesses_frequently:
              type: array
              items:
                type: string
            accessed_frequently_by:
              type: array
              items:
                type: string
            supervises:
              type: array
              items:
                type: string
            supervised_by:
              type: array
              items:
                type: string
        risk:
          type: object
          additionalProperties: false
          properties:
            calculated_level:
              $ref: '#/components/schemas/EntityRiskLevels'
              example: 'Critical'
              description: Lexical description of the entity's risk.
            calculated_score:
              type: number
              format: double
              description: The raw numeric value of the given entity's risk score.
            calculated_score_norm:
              type: number
              format: double
              minimum: 0
              maximum: 100
              description: The normalized numeric value of the given entity's risk score. Useful for comparing with other entities.

    Asset:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        name:
          type: string
        owner:
          type: string
        serial_number:
          type: string
        model:
          type: string
        vendor:
          type: string
        environment:
          type: string
        criticality:
          $ref: '#/components/schemas/AssetCriticalityLevel'
        business_unit:
          type: string

    UserEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        user:
          type: object
          additionalProperties: false
          properties:
            full_name:
              type: array
              items:
                type: string
            domain:
              type: array
              items:
                type: string
            roles:
              type: array
              items:
                type: string
            name:
              type: string
            id:
              type: array
              items:
                type: string
            email:
              type: array
              items:
                type: string
            hash:
              type: array
              items:
                type: string
            risk:
             $ref: '#/components/schemas/EntityRiskScoreRecord'
             additionalProperties: false
          required:
            - name
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
        event:
          type: object
          additionalProperties: false
          properties:
            ingested:
              type: string
              format: date-time
    
    HostEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        host:
          type: object
          additionalProperties: false
          properties:
            hostname:
              type: array
              items:
                type: string
            domain:
              type: array
              items:
                type: string
            ip:
              type: array
              items:
                type: string
            name:
              type: string
            id:
              type: array
              items:
                type: string
            type:
              type: array
              items:
                type: string
            mac:
              type: array
              items:
                type: string
            architecture:
              type: array
              items:
                type: string
            risk:
              $ref: '#/components/schemas/EntityRiskScoreRecord'
            entity:
              $ref: '#/components/schemas/EntityField'
          required:
            - name
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
        event:
          type: object
          additionalProperties: false
          properties:
            ingested:
              type: string
              format: date-time
   
    ServiceEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        service:
          type: object
          additionalProperties: false
          properties:
            name:
              type: string
            risk:
              $ref: '#/components/schemas/EntityRiskScoreRecord'
            entity:
              $ref: '#/components/schemas/EntityField'
          required:
            - name
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
        event:
          type: object
          additionalProperties: false
          properties:
            ingested:
              type: string
              format: date-time

    # The Generic Entity definition maps more than just entity.
    # however I don't see a reason to duplicate the definition 
    # of all the fields just for the sake of doing. 
    # Thus the current mapping maps entity and asset only 
    # (used in code). If you end up needing the fields mapped 
    # in the schema just add it.              
    GenericEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
    
    # These entities represent the API of Entity Store
    # where entity is a root field, as it's in the final
    # index for entities. Note that this is different from the 
    # source logs mapping where `entity` will be nested under
    # `host`, `user` and `service`
    Entity:
      oneOf:
        - $ref: '#/components/schemas/UserEntity'
        - $ref: '#/components/schemas/HostEntity'
        - $ref: '#/components/schemas/ServiceEntity'
        - $ref: '#/components/schemas/GenericEntity'
         
    # Temporary addition of risk score and asset criticality assets
    AssetCriticalityLevel:
      type: string
      enum:
        - low_impact
        - medium_impact
        - high_impact
        - extreme_impact
      description: The criticality level of the asset.

    EntityRiskLevels:
      type: string
      enum:
        - "Unknown"
        - "Low"
        - "Moderate"
        - "High"
        - "Critical"

    RiskScoreInput:
      description: A generic representation of a document contributing to a Risk Score.
      type: object
      required:
        - id
        - index
        - description
        - category
      properties:
        id:
          type: string
          example: 91a93376a507e86cfbf282166275b89f9dbdb1f0be6c8103c6ff2909ca8e1a1c
          description: The unique identifier (`_id`) of the original source document
        index:
          type: string
          example: .internal.alerts-security.alerts-default-000001
          description: The unique index (`_index`) of the original source document
        category:
          type: string
          example: category_1
          description: The risk category of the risk input document.
        description:
          type: string
          example: "Generated from Detection Engine Rule: Malware Prevention Alert"
          description: A human-readable description of the risk input document.
        risk_score:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: The weighted risk score of the risk input document.
        timestamp:
          type: string
          example: "2017-07-21T17:32:28Z"
          description: The @timestamp of the risk input document.
        contribution_score:
          type: number
          format: double

    EntityRiskScoreRecord:
      type: object
      required:
        - "@timestamp"
        - id_field
        - id_value
        - calculated_level
        - calculated_score
        - calculated_score_norm
        - category_1_score
        - category_1_count
        - inputs
        - notes
      properties:
        "@timestamp":
          type: string
          format: "date-time"
          example: "2017-07-21T17:32:28Z"
          description: The time at which the risk score was calculated.
        id_field:
          type: string
          example: "host.name"
          description: The identifier field defining this risk score. Coupled with `id_value`, uniquely identifies the entity being scored.
        id_value:
          type: string
          example: "example.host"
          description: The identifier value defining this risk score. Coupled with `id_field`, uniquely identifies the entity being scored.
        calculated_level:
          $ref: "#/components/schemas/EntityRiskLevels"
          example: "Critical"
          description: Lexical description of the entity's risk.
        calculated_score:
          type: number
          format: double
          description: The raw numeric value of the given entity's risk score.
        calculated_score_norm:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: The normalized numeric value of the given entity's risk score. Useful for comparing with other entities.
        category_1_score:
          type: number
          format: double
          description: The contribution of Category 1 to the overall risk score (`calculated_score`). Category 1 contains Detection Engine Alerts.
        category_1_count:
          type: integer
          description: The number of risk input documents that contributed to the Category 1 score (`category_1_score`).
        inputs:
          type: array
          description: A list of the highest-risk documents contributing to this risk score. Useful for investigative purposes.
          items:
            $ref: "#/components/schemas/RiskScoreInput"
        category_2_score:
          type: number
          format: double
        category_2_count:
          type: integer
        notes:
          type: array
          items:
            type: string
        criticality_modifier:
          type: number
          format: double
        criticality_level:
          $ref: "#/components/schemas/AssetCriticalityLevel"

        modifiers:
          type: array
          description: A list of modifiers that were applied to the risk score calculation.
          items:
            type: object
            properties:
              type:
                type: string
              subtype:
                type: string
              modifier_value:
                type: number
                format: double
              contribution:
                type: number
                format: double
              metadata:
                type: object
                additionalProperties: true
            required:
              - type
              - contribution