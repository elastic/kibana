/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import { defineSkillType } from '@kbn/agent-builder-server/skills/type_definition';

/**
 * Skill for retrieving and analyzing security alerts.
 * This skill provides knowledge about how to query, filter, and analyze alerts
 * in the Elastic Security solution.
 */
export const GET_ALERTS_SKILL = defineSkillType({
  id: 'security.get_alerts',
  name: 'get_alerts',
  basePath: 'skills/security',
  description: 'Instructions for retrieving security alerts',
  content: `# Security Alerts Retrieval Guide

This skill provides comprehensive knowledge about working with security alerts in Elastic Security.

## Overview
Security alerts are generated by detection rules and represent potential security threats or suspicious activities detected in your environment.

## IMPORTANT: How to Use This Tool

The \`security.alerts\` tool accepts **natural language queries**, NOT Elasticsearch DSL.

### Correct Usage (Natural Language)
\`\`\`
invoke_skill({
  name: "security.alerts",
  parameters: {
    query: "show me all critical alerts from the last 24 hours",
    isCount: false
  }
})
\`\`\`

### For Counting Alerts
\`\`\`
invoke_skill({
  name: "security.alerts",
  parameters: {
    query: "how many open alerts do I have",
    isCount: true
  }
})
\`\`\`

### WRONG - Do NOT use Elasticsearch DSL
\`\`\`
// WRONG - query should be a string, not an object!
invoke_skill({
  name: "security.alerts",
  parameters: {
    query: { "range": { "@timestamp": { "gte": "now-24h" } } }  // WRONG!
  }
})
\`\`\`

## Tool Parameters

### Read Operations (search)
- \`query\` (required, string): Natural language description of what alerts you want
- \`isCount\` (optional, boolean): Set to \`true\` when asking "how many" questions
- \`index\` (optional, string): Alerts index (defaults to current space index)

### Write Operations (acknowledge alerts)
- \`operation\`: \`"acknowledge"\` or \`"set_workflow_status"\`
- \`alertIds\`: Array of alert IDs to update
- \`status\`: \`"open"\`, \`"acknowledged"\`, or \`"closed"\`
- \`confirm\`: **Must be \`true\`** to perform write operations

## Example Queries

### Count all alerts
\`\`\`
{ "query": "how many alerts do I have", "isCount": true }
\`\`\`

### Get recent critical alerts
\`\`\`
{ "query": "show critical severity alerts from the last 24 hours" }
\`\`\`

### Find alerts by rule name
\`\`\`
{ "query": "find alerts from the 'Brute Force' detection rule" }
\`\`\`

### Get open alerts requiring investigation
\`\`\`
{ "query": "show all open alerts with high or critical severity" }
\`\`\`

### Acknowledge alerts (write operation)
\`\`\`
{
  "operation": "acknowledge",
  "alertIds": ["alert-id-1", "alert-id-2"],
  "confirm": true,
  "confirmReason": "Reviewed and determined to be false positives"
}
\`\`\`

## Key Concepts

### Alert States
- **Open**: New alerts that require investigation
- **Acknowledged**: Alerts that have been reviewed but not resolved
- **Closed**: Alerts that have been resolved or dismissed

### Alert Severity Levels
- **Critical**: Immediate attention required
- **High**: Important security events
- **Medium**: Moderate security concerns
- **Low**: Minor security observations

### Common Alert Fields (for reference)
- \`@timestamp\`: When the alert was generated
- \`kibana.alert.rule.name\`: Name of the detection rule
- \`kibana.alert.severity\`: Severity level
- \`kibana.alert.workflow_status\`: Current workflow status
- \`kibana.alert.risk_score\`: Calculated risk score

## Best Practices

1. **Use natural language**: Describe what you want in plain English
2. **Set isCount for counting**: Use \`isCount: true\` for "how many" questions
3. **Include time ranges**: Mention time periods like "last 24 hours" or "this week"
4. **Workflow status updates**: Always identify alerts first, then require explicit confirmation with \`confirm: true\` (required for write operations)
`,
  getAllowedTools: () => ['security.alerts'],
});
