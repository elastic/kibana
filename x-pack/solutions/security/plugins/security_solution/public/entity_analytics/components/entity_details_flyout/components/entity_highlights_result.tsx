/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import {
  EuiButtonIcon,
  EuiCopy,
  EuiFlexGroup,
  EuiFlexItem,
  EuiHorizontalRule,
  EuiIcon,
  EuiMarkdownFormat,
  EuiSpacer,
  EuiText,
  EuiTitle,
} from '@elastic/eui';
import React, { useMemo } from 'react';
import {
  replaceAnonymizedValuesWithOriginalValues,
  type Replacements,
} from '@kbn/elastic-assistant-common';
import { FormattedMessage } from '@kbn/i18n-react';
import { i18n } from '@kbn/i18n';
import moment from 'moment';
import type { EntityHighlightsResponse } from '../types';
import { useGradientStyles } from './entity_highlights_gradients';

interface EntityHighlightsResultProps {
  assistantResult: {
    response: EntityHighlightsResponse | null;
    replacements: Replacements;
  } | null;
  showAnonymizedValues: boolean;
  generatedAt: number | null;
  onRefresh: () => void;
}

export const EntityHighlightsResult: React.FC<EntityHighlightsResultProps> = ({
  assistantResult,
  showAnonymizedValues,
  generatedAt,
  onRefresh,
}) => {
  const { gradientPanelStyle, iconGradientStyle } = useGradientStyles();

  const anonymizedResult = useAnonymizedResponse(assistantResult, showAnonymizedValues);
  const textToCopy = useMemo(() => formatTextToCopy(anonymizedResult), [anonymizedResult]);

  if (!anonymizedResult) {
    return null;
  }

  return (
    <div css={gradientPanelStyle}>
      {anonymizedResult.highlights.length > 0 ? (
        anonymizedResult.highlights.map((highlight, index) => (
          <React.Fragment key={index}>
            <EuiText size="xs" color="default">
              <strong>{highlight.title}</strong>
            </EuiText>
            <EuiSpacer size="xs" />
            <EuiMarkdownFormat textSize="xs" color="default">
              {highlight.text}
            </EuiMarkdownFormat>
            {index < anonymizedResult.highlights.length - 1 && <EuiSpacer size="m" />}
          </React.Fragment>
        ))
      ) : (
        <EuiText size="xs" color="subdued" textAlign="center">
          <FormattedMessage
            id="xpack.securitySolution.flyout.entityDetails.highlights.emptyState"
            defaultMessage="There's not enough data to create an AI summary."
          />
        </EuiText>
      )}
      {anonymizedResult.recommendedActions && anonymizedResult.recommendedActions.length > 0 && (
        <>
          <EuiHorizontalRule margin="m" />
          <EuiFlexGroup alignItems="center" gutterSize="xs">
            <EuiFlexItem grow={false}>
              <EuiIcon type="documentation" size="m" css={iconGradientStyle} />
            </EuiFlexItem>
            <EuiFlexItem grow={false}>
              <EuiTitle size="xxs">
                <h4>
                  <FormattedMessage
                    id="xpack.securitySolution.flyout.entityDetails.highlights.recommendedActions"
                    defaultMessage="Recommended actions"
                  />
                </h4>
              </EuiTitle>
            </EuiFlexItem>
          </EuiFlexGroup>
          <EuiSpacer size="s" />
          <EuiMarkdownFormat textSize="xs" color="default">
            {anonymizedResult.recommendedActions.map((action) => `- ${action}`).join('\n')}
          </EuiMarkdownFormat>
        </>
      )}
      <>
        <EuiSpacer size="xs" />
        <EuiHorizontalRule margin="m" />
        <EuiFlexGroup alignItems="center" justifyContent="spaceBetween" responsive={false}>
          <EuiFlexItem grow={false}>
            {generatedAt && anonymizedResult.highlights.length > 0 && (
              <EuiText size="xs" color="subdued">
                <FormattedMessage
                  id="xpack.securitySolution.flyout.entityDetails.highlights.generatedTimestamp"
                  defaultMessage="Generated by AI on {timestamp}"
                  values={{
                    timestamp: moment(generatedAt).format('MMM DD, YYYY [at] HH:mm'),
                  }}
                />
              </EuiText>
            )}
          </EuiFlexItem>

          <EuiFlexItem grow={false}>
            <EuiFlexGroup gutterSize="xs" responsive={false}>
              <EuiFlexItem grow={false}>
                <EuiButtonIcon
                  iconType="refresh"
                  aria-label={i18n.translate(
                    'xpack.securitySolution.flyout.entityDetails.highlights.refreshAriaLabel',
                    { defaultMessage: 'Regenerate summary' }
                  )}
                  onClick={onRefresh}
                  size="xs"
                />
              </EuiFlexItem>
              {textToCopy && (
                <EuiFlexItem grow={false}>
                  <EuiCopy textToCopy={textToCopy}>
                    {(copy) => (
                      <EuiButtonIcon
                        iconType="copy"
                        aria-label={i18n.translate(
                          'xpack.securitySolution.flyout.entityDetails.highlights.copyAriaLabel',
                          { defaultMessage: 'Copy summary' }
                        )}
                        onClick={copy}
                        size="xs"
                      />
                    )}
                  </EuiCopy>
                </EuiFlexItem>
              )}
            </EuiFlexGroup>
          </EuiFlexItem>
        </EuiFlexGroup>
      </>
    </div>
  );
};

const useAnonymizedResponse = (
  assistantResult: {
    response: EntityHighlightsResponse | null;
    replacements: Replacements;
  } | null,
  showAnonymizedValues: boolean
): EntityHighlightsResponse | null => {
  return useMemo(() => {
    if (!assistantResult?.response) return null;
    const response = assistantResult.response;

    if (!showAnonymizedValues) {
      return {
        highlights: response.highlights.map((highlight) => ({
          title: highlight.title,
          text: replaceAnonymizedValuesWithOriginalValues({
            messageContent: highlight.text,
            replacements: assistantResult.replacements,
          }),
        })),
        recommendedActions: response.recommendedActions
          ? response.recommendedActions.map((action) =>
              replaceAnonymizedValuesWithOriginalValues({
                messageContent: action,
                replacements: assistantResult.replacements,
              })
            )
          : null,
      };
    }

    return response;
  }, [assistantResult, showAnonymizedValues]);
};

const formatTextToCopy = (response: EntityHighlightsResponse | null): string => {
  if (!response) return '';
  return response.highlights
    .map((highlight) => `- ${highlight.title}\n${highlight.text}\n`)
    .join('\n')
    .concat(
      response.recommendedActions
        ? `\nRecommended actions:\n${response.recommendedActions
            .map((action) => `- ${action} \n`)
            .join('\n')}`
        : ''
    );
};
