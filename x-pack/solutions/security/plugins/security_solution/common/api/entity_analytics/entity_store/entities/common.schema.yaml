openapi: 3.0.0
info:
  title: Common Entities Schemas
  description: Common Entities schemas for the Entity Store
  version: '1'
paths: {}
components:
  schemas:
    EngineMetadata: 
      type: object
      additionalProperties: false
      required: 
        - Type
      properties:
        Type:
          type: string

    EntityField:
      type: object
      additionalProperties: false
      required:
        - id
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
        sub_type:
          type: string
        source:
          type: string
        EngineMetadata:
          $ref: '#/components/schemas/EngineMetadata'
        attributes:
          type: object
          additionalProperties: false
          properties:
            privileged:
              type: boolean
            asset:
              type: boolean
            managed:
              type: boolean
            mfa_enabled:
              type: boolean
        behaviors: 
          type: object
          additionalProperties: false
          properties:
            brute_force_victim:
              type: boolean
            new_country_login:
              type: boolean
            used_usb_device:
              type: boolean
        lifecycle:
          type: object
          additionalProperties: false
          properties:
            first_seen:
              type: string
              format: date-time
            last_activity:
              type: string
              format: date-time
        relationships:
          type: object
          additionalProperties: false
          properties:
            communicates_with:
              type: array
              items:
                type: string
            depends_on:
              type: array
              items:
                type: string
            dependent_of:
              type: array
              items:
                type: string
            owns:
              type: array
              items:
                type: string
            owned_by:
              type: array
              items:
                type: string
            accesses_frequently:
              type: array
              items:
                type: string
            accessed_frequently_by:
              type: array
              items:
                type: string
            supervises:
              type: array
              items:
                type: string
            supervised_by:
              type: array
              items:
                type: string
        risk:
          type: object
          additionalProperties: false
          properties:
            calculated_level:
              $ref: '../../common/common.schema.yaml#/components/schemas/EntityRiskLevels'
              example: 'Critical'
              description: Lexical description of the entity's risk.
            calculated_score:
              type: number
              format: double
              description: The raw numeric value of the given entity's risk score.
            calculated_score_norm:
              type: number
              format: double
              minimum: 0
              maximum: 100
              description: The normalized numeric value of the given entity's risk score. Useful for comparing with other entities.

    Asset:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        name:
          type: string
        owner:
          type: string
        serial_number:
          type: string
        model:
          type: string
        vendor:
          type: string
        environment:
          type: string
        criticality:
          $ref: '../../asset_criticality/common.schema.yaml#/components/schemas/AssetCriticalityLevel'
        business_unit:
          type: string
        # CAASM endpoint asset fields
        category:
          type: string
          description: Asset category (e.g., endpoint, server, network)
        platform:
          type: string
          description: Platform type (e.g., windows, ubuntu, rhel, macos)

    # Endpoint Trust Intelligence schema for CAASM data from osquery
    EndpointTrust:
      type: object
      additionalProperties: false
      description: Endpoint trust intelligence fields collected via osquery for CAASM
      properties:
        lifecycle:
          type: object
          additionalProperties: false
          properties:
            first_seen:
              type: string
              format: date-time
            last_seen:
              type: string
              format: date-time
        posture:
          type: object
          additionalProperties: false
          properties:
            score:
              type: number
              description: Trust/posture score (0-100)
            level:
              type: string
              description: Posture level (LOW, MEDIUM, HIGH)
            failed_checks:
              type: array
              items:
                type: string
            checks:
              type: object
              additionalProperties: false
              properties:
                total:
                  type: integer
                passed:
                  type: integer
                failed:
                  type: integer
            firewall_enabled:
              type: boolean
            firewall_enabled_raw:
              type: string
            secure_boot:
              type: boolean
            secure_boot_raw:
              type: string
            disk_encryption:
              type: string
            disk_encryption_raw:
              type: string
            gatekeeper_enabled:
              type: boolean
            gatekeeper_enabled_raw:
              type: string
            sip_enabled:
              type: boolean
            sip_enabled_raw:
              type: string
        privileges:
          type: object
          additionalProperties: false
          properties:
            admin_count:
              type: integer
            ssh_keys_count:
              type: integer
            elevated_risk:
              type: boolean
            local_admins:
              type: array
              items:
                type: string
            root_users:
              type: array
              items:
                type: string
        software:
          type: object
          additionalProperties: false
          properties:
            installed_count:
              type: integer
            services_count:
              type: integer
            scheduled_tasks_count:
              type: integer
            startup_items_count:
              type: integer
            browser_extensions_count:
              type: integer
            chrome_extensions_count:
              type: integer
            launch_agents_count:
              type: integer
            launch_daemons_count:
              type: integer
            unsigned_apps_count:
              type: integer
        hardware:
          type: object
          additionalProperties: false
          properties:
            vendor:
              type: string
            cpu:
              type: string
            model:
              type: string
            usb_removable_count:
              type: integer
            disk:
              type: object
              additionalProperties: false
              properties:
                total_capacity_gb:
                  type: number
                free_space_gb:
                  type: number
        network:
          type: object
          additionalProperties: false
          properties:
            listening_ports_count:
              type: integer
            interfaces:
              type: array
              items:
                type: string
        detections:
          type: object
          additionalProperties: false
          properties:
            encoded_powershell_count:
              type: integer
            suspicious_ports_count:
              type: integer
            hidden_temp_files_count:
              type: integer
        drift:
          type: object
          additionalProperties: false
          properties:
            recently_changed:
              type: boolean
            change_types:
              type: array
              items:
                type: string
        queries:
          type: object
          additionalProperties: false
          properties:
            total_results:
              type: integer

    UserEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        user:
          type: object
          additionalProperties: false
          properties:
            full_name:
              type: array
              items:
                type: string
            domain:
              type: array
              items:
                type: string
            roles:
              type: array
              items:
                type: string
            name:
              type: string
            id:
              type: array
              items:
                type: string
            email:
              type: array
              items:
                type: string
            hash:
              type: array
              items:
                type: string
            risk:
              $ref: '../../common/common.schema.yaml#/components/schemas/EntityRiskScoreRecord'
              additionalProperties: false
          required:
            - name
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
        event:
          type: object
          additionalProperties: false
          properties:
            ingested:
              type: string
              format: date-time
    
    HostEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        host:
          type: object
          additionalProperties: false
          properties:
            hostname:
              type: array
              items:
                type: string
            domain:
              type: array
              items:
                type: string
            ip:
              type: array
              items:
                type: string
            name:
              type: string
            id:
              type: array
              items:
                type: string
            type:
              type: array
              items:
                type: string
            mac:
              type: array
              items:
                type: string
            architecture:
              type: array
              items:
                type: string
            # OS information from osquery
            os:
              type: object
              additionalProperties: false
              properties:
                name:
                  type: array
                  items:
                    type: string
                type:
                  type: array
                  items:
                    type: string
                family:
                  type: string
                kernel:
                  type: string
                version:
                  type: string
                platform:
                  type: string
                build:
                  type: string
            risk:
              $ref: '../../common/common.schema.yaml#/components/schemas/EntityRiskScoreRecord'
            entity:
              $ref: '#/components/schemas/EntityField'
          required:
            - name
        # Agent information from osquery
        agent:
          type: object
          additionalProperties: false
          properties:
            id:
              type: string
            name:
              type: string
            type:
              type: string
            version:
              type: string
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
        # Endpoint trust intelligence fields from CAASM/osquery
        endpoint:
          $ref: '#/components/schemas/EndpointTrust'
        event:
          type: object
          additionalProperties: false
          properties:
            ingested:
              type: string
              format: date-time
   
    ServiceEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        service:
          type: object
          additionalProperties: false
          properties:
            name:
              type: string
            risk:
              $ref: '../../common/common.schema.yaml#/components/schemas/EntityRiskScoreRecord'
            entity:
              $ref: '#/components/schemas/EntityField'
          required:
            - name
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
        event:
          type: object
          additionalProperties: false
          properties:
            ingested:
              type: string
              format: date-time

    # The Generic Entity definition maps more than just entity.
    # however I don't see a reason to duplicate the definition 
    # of all the fields just for the sake of doing. 
    # Thus the current mapping maps entity and asset only 
    # (used in code). If you end up needing the fields mapped 
    # in the schema just add it.              
    GenericEntity:
      type: object
      additionalProperties: false
      required:
        - entity
      properties:
        "@timestamp":
          type: string
          format: date-time
        entity:
          $ref: '#/components/schemas/EntityField'
        asset:
          $ref: '#/components/schemas/Asset'
          additionalProperties: false
    
    # These entities represent the API of Entity Store
    # where entity is a root field, as it's in the final
    # index for entities. Note that this is different from the 
    # source logs mapping where `entity` will be nested under
    # `host`, `user` and `service`
    Entity:
      oneOf:
        - $ref: '#/components/schemas/UserEntity'
        - $ref: '#/components/schemas/HostEntity'
        - $ref: '#/components/schemas/ServiceEntity'
        - $ref: '#/components/schemas/GenericEntity'
         
