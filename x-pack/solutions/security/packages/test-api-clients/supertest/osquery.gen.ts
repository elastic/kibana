/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

/*
 * NOTICE: Do not edit this file manually.
 * This file is automatically generated by the OpenAPI Generator, @kbn/openapi-generator.
 *
 * info:
 *   title: API client for tests
 *   version: Bundle (no version)
 */

import supertest_ from 'supertest';
import type SuperTest from 'supertest';
import { format as formatUrl } from 'url';
import {
  ELASTIC_HTTP_VERSION_HEADER,
  X_ELASTIC_INTERNAL_ORIGIN_REQUEST,
} from '@kbn/core-http-common';
import { replaceParams } from '@kbn/openapi-common/shared';

import type {
  GetAgentDetailsRequestParamsInput,
  GetAgentPolicyRequestParamsInput,
  GetAgentsRequestQueryInput,
} from '@kbn/osquery-plugin/common/api/fleet_wrapper/fleet_wrapper.gen';
import type {
  OsqueryCopyPacksRequestParamsInput,
  OsqueryCreatePacksRequestBodyInput,
  OsqueryDeletePacksRequestParamsInput,
  OsqueryFindPacksRequestQueryInput,
  OsqueryGetPacksDetailsRequestParamsInput,
  OsqueryUpdatePacksRequestParamsInput,
  OsqueryUpdatePacksRequestBodyInput,
} from '@kbn/osquery-plugin/common/api/packs/packs.gen';
import type {
  OsqueryCopySavedQueryRequestParamsInput,
  OsqueryCreateSavedQueryRequestBodyInput,
  OsqueryDeleteSavedQueryRequestParamsInput,
  OsqueryFindSavedQueriesRequestQueryInput,
  OsqueryGetSavedQueryDetailsRequestParamsInput,
  OsqueryUpdateSavedQueryRequestParamsInput,
  OsqueryUpdateSavedQueryRequestBodyInput,
} from '@kbn/osquery-plugin/common/api/saved_query/saved_query.gen';
import type {
  OsqueryCreateLiveQueryRequestBodyInput,
  OsqueryFindLiveQueriesRequestQueryInput,
  OsqueryGetLiveQueryDetailsRequestParamsInput,
  OsqueryGetLiveQueryResultsRequestQueryInput,
  OsqueryGetLiveQueryResultsRequestParamsInput,
} from '@kbn/osquery-plugin/common/api/live_query/live_queries.gen';
import type {
  ReadAssetsStatusRequestQueryInput,
  UpdateAssetsStatusRequestQueryInput,
} from '@kbn/osquery-plugin/common/api/asset/assets.gen';

import type { FtrProviderContext } from '@kbn/ftr-common-functional-services';
import { getRouteUrlForSpace } from '@kbn/spaces-plugin/common';

const securitySolutionApiServiceFactory = (supertest: SuperTest.Agent) => ({
  getAgentDetails(props: GetAgentDetailsProps, kibanaSpace: string = 'default') {
    return supertest
      .get(
        getRouteUrlForSpace(
          replaceParams('/internal/osquery/fleet_wrapper/agents/{id}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  getAgentPackagePolicies(kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/internal/osquery/fleet_wrapper/package_policies', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  getAgentPolicies(kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/internal/osquery/fleet_wrapper/agent_policies', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  getAgentPolicy(props: GetAgentPolicyProps, kibanaSpace: string = 'default') {
    return supertest
      .get(
        getRouteUrlForSpace(
          replaceParams('/internal/osquery/fleet_wrapper/agent_policies/{id}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  getAgents(props: GetAgentsProps, kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/internal/osquery/fleet_wrapper/agents', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
  /**
   * Create a copy of a query pack with a unique name by appending a `_copy` suffix. If the name already exists, a numeric suffix is added (e.g., `_copy_2`). The copied pack is always created with `enabled` set to `false`.
   */
  osqueryCopyPacks(props: OsqueryCopyPacksProps, kibanaSpace: string = 'default') {
    return supertest
      .post(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/packs/{id}/copy', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
   * Create a copy of a saved query with a unique name by appending a `_copy` suffix. If the name already exists, a numeric suffix is added (e.g., `_copy_2`).
   */
  osqueryCopySavedQuery(props: OsqueryCopySavedQueryProps, kibanaSpace: string = 'default') {
    return supertest
      .post(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/saved_queries/{id}/copy', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
   * Create and run a live query.
   */
  osqueryCreateLiveQuery(props: OsqueryCreateLiveQueryProps, kibanaSpace: string = 'default') {
    return supertest
      .post(getRouteUrlForSpace('/api/osquery/live_queries', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .send(props.body as object);
  },
  /**
   * Create a query pack.
   */
  osqueryCreatePacks(props: OsqueryCreatePacksProps, kibanaSpace: string = 'default') {
    return supertest
      .post(getRouteUrlForSpace('/api/osquery/packs', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .send(props.body as object);
  },
  /**
   * Create and run a saved query.
   */
  osqueryCreateSavedQuery(props: OsqueryCreateSavedQueryProps, kibanaSpace: string = 'default') {
    return supertest
      .post(getRouteUrlForSpace('/api/osquery/saved_queries', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .send(props.body as object);
  },
  /**
   * Delete a query pack using the pack ID.
   */
  osqueryDeletePacks(props: OsqueryDeletePacksProps, kibanaSpace: string = 'default') {
    return supertest
      .delete(
        getRouteUrlForSpace(replaceParams('/api/osquery/packs/{id}', props.params), kibanaSpace)
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
   * Delete a saved query using the query ID.
   */
  osqueryDeleteSavedQuery(props: OsqueryDeleteSavedQueryProps, kibanaSpace: string = 'default') {
    return supertest
      .delete(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/saved_queries/{id}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
   * Get a list of all live queries.
   */
  osqueryFindLiveQueries(props: OsqueryFindLiveQueriesProps, kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/api/osquery/live_queries', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
  /**
   * Get a list of all query packs.
   */
  osqueryFindPacks(props: OsqueryFindPacksProps, kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/api/osquery/packs', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
  /**
   * Get a list of all saved queries.
   */
  osqueryFindSavedQueries(props: OsqueryFindSavedQueriesProps, kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/api/osquery/saved_queries', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
  /**
   * Get the details of a live query using the query ID.
   */
  osqueryGetLiveQueryDetails(
    props: OsqueryGetLiveQueryDetailsProps,
    kibanaSpace: string = 'default'
  ) {
    return supertest
      .get(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/live_queries/{id}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
   * Get the results of a live query using the query action ID.
   */
  osqueryGetLiveQueryResults(
    props: OsqueryGetLiveQueryResultsProps,
    kibanaSpace: string = 'default'
  ) {
    return supertest
      .get(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/live_queries/{id}/results/{actionId}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
  /**
   * Get the details of a query pack using the pack ID.
   */
  osqueryGetPacksDetails(props: OsqueryGetPacksDetailsProps, kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace(replaceParams('/api/osquery/packs/{id}', props.params), kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
   * Get the details of a saved query using the query ID.
   */
  osqueryGetSavedQueryDetails(
    props: OsqueryGetSavedQueryDetailsProps,
    kibanaSpace: string = 'default'
  ) {
    return supertest
      .get(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/saved_queries/{id}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  /**
      * Update a query pack using the pack ID.
> info
> You cannot update a prebuilt pack.

      */
  osqueryUpdatePacks(props: OsqueryUpdatePacksProps, kibanaSpace: string = 'default') {
    return supertest
      .put(getRouteUrlForSpace(replaceParams('/api/osquery/packs/{id}', props.params), kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .send(props.body as object);
  },
  /**
      * Update a saved query using the query ID.
> info
> You cannot update a prebuilt saved query.

      */
  osqueryUpdateSavedQuery(props: OsqueryUpdateSavedQueryProps, kibanaSpace: string = 'default') {
    return supertest
      .put(
        getRouteUrlForSpace(
          replaceParams('/api/osquery/saved_queries/{id}', props.params),
          kibanaSpace
        )
      )
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '2023-10-31')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .send(props.body as object);
  },
  readAssetsStatus(props: ReadAssetsStatusProps, kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/internal/osquery/assets', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
  readInstallationStatus(kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/internal/osquery/status', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  readPrivilegesCheck(kibanaSpace: string = 'default') {
    return supertest
      .get(getRouteUrlForSpace('/internal/osquery/privileges_check', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana');
  },
  updateAssetsStatus(props: UpdateAssetsStatusProps, kibanaSpace: string = 'default') {
    return supertest
      .post(getRouteUrlForSpace('/internal/osquery/assets/update', kibanaSpace))
      .set('kbn-xsrf', 'true')
      .set(ELASTIC_HTTP_VERSION_HEADER, '1')
      .set(X_ELASTIC_INTERNAL_ORIGIN_REQUEST, 'kibana')
      .query(props.query);
  },
});

export function SecuritySolutionApiProvider({ getService }: FtrProviderContext) {
  const supertestService = getService('supertest');
  const config = getService('config');

  return {
    ...securitySolutionApiServiceFactory(supertestService),
    withUser: (user: { username: string; password: string }) => {
      const kbnUrl = formatUrl({ ...config.get('servers.kibana'), auth: false });

      return securitySolutionApiServiceFactory(
        supertest_.agent(kbnUrl).auth(user.username, user.password)
      );
    },
  };
}

export interface GetAgentDetailsProps {
  params: GetAgentDetailsRequestParamsInput;
}
export interface GetAgentPolicyProps {
  params: GetAgentPolicyRequestParamsInput;
}
export interface GetAgentsProps {
  query: GetAgentsRequestQueryInput;
}
export interface OsqueryCopyPacksProps {
  params: OsqueryCopyPacksRequestParamsInput;
}
export interface OsqueryCopySavedQueryProps {
  params: OsqueryCopySavedQueryRequestParamsInput;
}
export interface OsqueryCreateLiveQueryProps {
  body: OsqueryCreateLiveQueryRequestBodyInput;
}
export interface OsqueryCreatePacksProps {
  body: OsqueryCreatePacksRequestBodyInput;
}
export interface OsqueryCreateSavedQueryProps {
  body: OsqueryCreateSavedQueryRequestBodyInput;
}
export interface OsqueryDeletePacksProps {
  params: OsqueryDeletePacksRequestParamsInput;
}
export interface OsqueryDeleteSavedQueryProps {
  params: OsqueryDeleteSavedQueryRequestParamsInput;
}
export interface OsqueryFindLiveQueriesProps {
  query: OsqueryFindLiveQueriesRequestQueryInput;
}
export interface OsqueryFindPacksProps {
  query: OsqueryFindPacksRequestQueryInput;
}
export interface OsqueryFindSavedQueriesProps {
  query: OsqueryFindSavedQueriesRequestQueryInput;
}
export interface OsqueryGetLiveQueryDetailsProps {
  params: OsqueryGetLiveQueryDetailsRequestParamsInput;
}
export interface OsqueryGetLiveQueryResultsProps {
  query: OsqueryGetLiveQueryResultsRequestQueryInput;
  params: OsqueryGetLiveQueryResultsRequestParamsInput;
}
export interface OsqueryGetPacksDetailsProps {
  params: OsqueryGetPacksDetailsRequestParamsInput;
}
export interface OsqueryGetSavedQueryDetailsProps {
  params: OsqueryGetSavedQueryDetailsRequestParamsInput;
}
export interface OsqueryUpdatePacksProps {
  params: OsqueryUpdatePacksRequestParamsInput;
  body: OsqueryUpdatePacksRequestBodyInput;
}
export interface OsqueryUpdateSavedQueryProps {
  params: OsqueryUpdateSavedQueryRequestParamsInput;
  body: OsqueryUpdateSavedQueryRequestBodyInput;
}
export interface ReadAssetsStatusProps {
  query: ReadAssetsStatusRequestQueryInput;
}
export interface UpdateAssetsStatusProps {
  query: UpdateAssetsStatusRequestQueryInput;
}
