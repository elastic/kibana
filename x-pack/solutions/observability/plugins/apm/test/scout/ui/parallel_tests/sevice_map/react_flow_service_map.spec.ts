/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import { expect } from '@kbn/scout-oblt';
import { test, testData } from '../../fixtures';

/**
 * React Flow Service Map E2E Tests
 *
 * These tests verify the React Flow implementation of the APM Service Map.
 * React Flow is currently implemented at global and service-group levels only.
 * Individual service maps still use Cytoscape.
 *
 * Tests are designed as user flow tests with multiple steps per test.
 */
test.describe('React Flow Service Map', { tag: ['@ess', '@svlOblt'] }, () => {
  test.beforeEach(async ({ browserAuth }) => {
    await browserAuth.loginAsViewer();
  });

  test('displays all expected service nodes and labels on the global map', async ({
    page,
    pageObjects: { serviceMapPage },
  }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    expect(page.url()).toContain('/app/apm/react-flow-service-map');
    await serviceMapPage.waitForReactFlowServiceMapToLoad();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    // Step 2: Verify expected node and edge counts
    const totalNodes = await serviceMapPage.getNodeCount();
    const serviceNodes = await serviceMapPage.getServiceNodeCount();
    const dependencyNodes = await serviceMapPage.getDependencyNodeCount();
    const edgeCount = await serviceMapPage.getEdgeCount();

    // We expect at least 5 services based on opbeans synthtrace data
    expect(totalNodes).toBeGreaterThanOrEqual(5);
    expect(serviceNodes).toBeGreaterThanOrEqual(5);
    expect(dependencyNodes).toBeGreaterThanOrEqual(0);
    expect(edgeCount).toBeGreaterThanOrEqual(0);

    // Step 3: Verify all expected service nodes are visible
    // These services are generated by the opbeans synthtrace scenario
    const expectedServices = [
      testData.SERVICE_OPBEANS_JAVA,
      testData.SERVICE_OPBEANS_NODE,
      testData.SERVICE_OPBEANS_RUM,
      testData.SERVICE_GO,
      testData.SERVICE_NODE,
    ];

    for (const serviceName of expectedServices) {
      const isVisible = await serviceMapPage.isServiceNodeVisible(serviceName);
      expect(isVisible, `Service node ${serviceName} should be visible`).toBe(true);
    }

    // Step 4: Verify service node labels contain the expected service names
    const labels = await serviceMapPage.getServiceNodeLabels();
    expect(labels.length).toBeGreaterThanOrEqual(expectedServices.length);

    for (const serviceName of expectedServices) {
      const hasLabel = labels.some((label) => label.includes(serviceName));
      expect(hasLabel, `Label for ${serviceName} should be present`).toBe(true);
    }
  });

  test('user can view global service map and navigate to service details via popover', async ({
    page,
    pageObjects: { serviceMapPage },
  }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    // Step 2: Filter for specific service to reduce flakiness
    await serviceMapPage.typeInTheSearchBar(`service.name : ${testData.SERVICE_OPBEANS_JAVA}`);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 3: Verify opbeans-java service node is visible
    const isServiceVisible = await serviceMapPage.isServiceNodeVisible(
      testData.SERVICE_OPBEANS_JAVA
    );
    expect(isServiceVisible).toBe(true);

    // Step 4: Click on the service node and verify popover appears
    await serviceMapPage.clickServiceNode(testData.SERVICE_OPBEANS_JAVA);
    await expect(serviceMapPage.serviceMapPopover).toBeVisible();

    // Step 5: Verify popover shows correct service name and navigation buttons
    await expect(serviceMapPage.serviceMapPopoverContent.locator('h3')).toContainText(
      testData.SERVICE_OPBEANS_JAVA
    );
    await expect(serviceMapPage.serviceDetailsButton).toBeVisible();
    await expect(serviceMapPage.focusMapButton).toBeVisible();

    // Step 6: Click Service Details button and verify navigation
    await serviceMapPage.clickServiceDetailsButton();
    await page.waitForURL(/\/services\/opbeans-java\/overview/);
    expect(page.url()).toContain(`/services/${testData.SERVICE_OPBEANS_JAVA}/overview`);
  });

  test('user can view global service map and navigate to focused service map via popover', async ({
    page,
    pageObjects: { serviceMapPage },
  }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    // Step 2: Filter for specific service to reduce flakiness
    await serviceMapPage.typeInTheSearchBar(`service.name : ${testData.SERVICE_OPBEANS_JAVA}`);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 3: Click on a service node and verify popover
    await serviceMapPage.clickServiceNode(testData.SERVICE_OPBEANS_JAVA);
    await expect(serviceMapPage.serviceMapPopover).toBeVisible();

    // Step 4: Click Focus map button and verify navigation to Cytoscape service map
    await serviceMapPage.clickFocusMapButton();
    await page.waitForURL(/\/services\/opbeans-java\/service-map/);
    expect(page.url()).toContain(`/services/${testData.SERVICE_OPBEANS_JAVA}/service-map`);

    // Step 5: Verify the Cytoscape service map loads (focused view)
    await serviceMapPage.waitForServiceMapToLoad();
    await expect(serviceMapPage.serviceMap).toBeVisible();
  });

  test('user can interact with map controls and layout toggle', async ({
    pageObjects: { serviceMapPage },
  }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 2: Verify zoom controls are visible and functional
    await expect(serviceMapPage.reactFlowZoomIn).toBeVisible();
    await expect(serviceMapPage.reactFlowZoomOut).toBeVisible();
    await expect(serviceMapPage.reactFlowFitView).toBeVisible();

    await serviceMapPage.clickReactFlowZoomIn();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    await serviceMapPage.clickReactFlowZoomOut();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    await serviceMapPage.clickReactFlowFitView();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    // Step 3: Verify layout toggle is visible and can switch directions
    await expect(serviceMapPage.layoutToggle).toBeVisible();

    await serviceMapPage.toggleLayoutDirection('vertical');
    await serviceMapPage.waitForReactFlowServiceMapToLoad();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();

    await serviceMapPage.toggleLayoutDirection('horizontal');
    await serviceMapPage.waitForReactFlowServiceMapToLoad();
    await expect(serviceMapPage.reactFlowContainer).toBeVisible();
  });

  test('popover closes when pressing Escape key', async ({ pageObjects: { serviceMapPage } }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 2: Filter for specific service to reduce flakiness
    await serviceMapPage.typeInTheSearchBar(`service.name : ${testData.SERVICE_OPBEANS_JAVA}`);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 3: Click on service node and verify popover opens
    await serviceMapPage.clickServiceNode(testData.SERVICE_OPBEANS_JAVA);
    await expect(serviceMapPage.serviceMapPopover).toBeVisible();

    // Step 4: Close popover by pressing Escape key
    await serviceMapPage.closePopover();
    await expect(serviceMapPage.serviceMapPopoverContent).toBeHidden();
  });

  test('shows empty state when filtering returns no results', async ({
    pageObjects: { serviceMapPage },
  }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 2: Apply filter that returns no results
    await serviceMapPage.typeInTheSearchBar('_id : foo');
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 3: Verify empty state is shown
    await expect(serviceMapPage.noServicesPlaceholder).toBeVisible();
    await expect(serviceMapPage.noServicesPlaceholder).toHaveText('No services available');
  });

  test('has no detectable a11y violations', async ({ page, pageObjects: { serviceMapPage } }) => {
    // Step 1: Navigate to the React Flow service map
    await serviceMapPage.gotoWithDateSelected(testData.START_DATE, testData.END_DATE);
    await serviceMapPage.waitForReactFlowServiceMapToLoad();

    // Step 2: Check for accessibility violations
    const { violations } = await page.checkA11y({ include: ['main'] });
    expect(violations).toHaveLength(0);
  });
});
