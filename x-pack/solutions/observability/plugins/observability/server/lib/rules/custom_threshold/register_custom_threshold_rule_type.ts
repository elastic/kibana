/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import { DEFAULT_APP_CATEGORIES } from '@kbn/core/server';
import { extractReferences, injectReferences } from '@kbn/data-plugin/common';
import { i18n } from '@kbn/i18n';
import { IRuleTypeAlerts, GetViewInAppRelativeUrlFnOpts } from '@kbn/alerting-plugin/server';
import { IBasePath, Logger } from '@kbn/core/server';
import { legacyExperimentalFieldMap } from '@kbn/alerts-as-data-utils';
import { OBSERVABILITY_THRESHOLD_RULE_TYPE_ID } from '@kbn/rule-data-utils';
import { LicenseType } from '@kbn/licensing-plugin/server';
import { EsQueryRuleParamsExtractedParams } from '@kbn/stack-alerts-plugin/server/rule_types/es_query/rule_type_params';
import { customThresholdParamsSchema } from '@kbn/response-ops-rule-params/custom_threshold';
import { observabilityFeatureId, observabilityPaths } from '../../../../common';
import { THRESHOLD_RULE_REGISTRATION_CONTEXT } from '../../../common/constants';
import {
  alertDetailUrlActionVariableDescription,
  cloudActionVariableDescription,
  containerActionVariableDescription,
  groupActionVariableDescription,
  groupingObjectActionVariableDescription,
  hostActionVariableDescription,
  labelsActionVariableDescription,
  orchestratorActionVariableDescription,
  reasonActionVariableDescription,
  tagsActionVariableDescription,
  timestampActionVariableDescription,
  valueActionVariableDescription,
  viewInAppUrlActionVariableDescription,
} from './translations';
import {
  createCustomThresholdExecutor,
  CustomThresholdLocators,
} from './custom_threshold_executor';
import { CUSTOM_THRESHOLD_AAD_FIELDS, FIRED_ACTION, NO_DATA_ACTION } from './constants';
import { ObservabilityConfig } from '../../..';
import { CustomThresholdAlert } from './types';

export const MetricsRulesTypeAlertDefinition: IRuleTypeAlerts<CustomThresholdAlert> = {
  context: THRESHOLD_RULE_REGISTRATION_CONTEXT,
  mappings: {
    // dynamic: true,
    fieldMap: {
      ...legacyExperimentalFieldMap,
      '0001': { type: 'keyword', array: false, required: false },
      '0002': { type: 'keyword', array: false, required: false },
      '0003': { type: 'keyword', array: false, required: false },
      '0004': { type: 'keyword', array: false, required: false },
      '0005': { type: 'keyword', array: false, required: false },
      '0006': { type: 'keyword', array: false, required: false },
      '0007': { type: 'keyword', array: false, required: false },
      '0008': { type: 'keyword', array: false, required: false },
      '0009': { type: 'keyword', array: false, required: false },
      '0010': { type: 'keyword', array: false, required: false },
      '0011': { type: 'keyword', array: false, required: false },
      '0012': { type: 'keyword', array: false, required: false },
      '0013': { type: 'keyword', array: false, required: false },
      '0014': { type: 'keyword', array: false, required: false },
      '0015': { type: 'keyword', array: false, required: false },
      '0016': { type: 'keyword', array: false, required: false },
      '0017': { type: 'keyword', array: false, required: false },
      '0018': { type: 'keyword', array: false, required: false },
      '0019': { type: 'keyword', array: false, required: false },
      '0020': { type: 'keyword', array: false, required: false },
      '0021': { type: 'keyword', array: false, required: false },
      '0022': { type: 'keyword', array: false, required: false },
      '0023': { type: 'keyword', array: false, required: false },
      '0024': { type: 'keyword', array: false, required: false },
      '0025': { type: 'keyword', array: false, required: false },
      '0026': { type: 'keyword', array: false, required: false },
      '0027': { type: 'keyword', array: false, required: false },
      '0028': { type: 'keyword', array: false, required: false },
      '0029': { type: 'keyword', array: false, required: false },
      '0030': { type: 'keyword', array: false, required: false },
      '0031': { type: 'keyword', array: false, required: false },
      '0032': { type: 'keyword', array: false, required: false },
      '0033': { type: 'keyword', array: false, required: false },
      '0034': { type: 'keyword', array: false, required: false },
      '0035': { type: 'keyword', array: false, required: false },
      '0036': { type: 'keyword', array: false, required: false },
      '0037': { type: 'keyword', array: false, required: false },
      '0038': { type: 'keyword', array: false, required: false },
      '0039': { type: 'keyword', array: false, required: false },
      '0040': { type: 'keyword', array: false, required: false },
      '0041': { type: 'keyword', array: false, required: false },
      '0042': { type: 'keyword', array: false, required: false },
      '0043': { type: 'keyword', array: false, required: false },
      '0044': { type: 'keyword', array: false, required: false },
      '0045': { type: 'keyword', array: false, required: false },
      '0046': { type: 'keyword', array: false, required: false },
      '0047': { type: 'keyword', array: false, required: false },
      '0048': { type: 'keyword', array: false, required: false },
      '0049': { type: 'keyword', array: false, required: false },
      '0050': { type: 'keyword', array: false, required: false },
      '0051': { type: 'keyword', array: false, required: false },
      '0052': { type: 'keyword', array: false, required: false },
      '0053': { type: 'keyword', array: false, required: false },
      '0054': { type: 'keyword', array: false, required: false },
      '0055': { type: 'keyword', array: false, required: false },
      '0056': { type: 'keyword', array: false, required: false },
      '0057': { type: 'keyword', array: false, required: false },
      '0058': { type: 'keyword', array: false, required: false },
      '0059': { type: 'keyword', array: false, required: false },
      '0060': { type: 'keyword', array: false, required: false },
      '0061': { type: 'keyword', array: false, required: false },
      '0062': { type: 'keyword', array: false, required: false },
      '0063': { type: 'keyword', array: false, required: false },
      '0064': { type: 'keyword', array: false, required: false },
      '0065': { type: 'keyword', array: false, required: false },
      '0066': { type: 'keyword', array: false, required: false },
      '0067': { type: 'keyword', array: false, required: false },
      '0068': { type: 'keyword', array: false, required: false },
      '0069': { type: 'keyword', array: false, required: false },
      '0070': { type: 'keyword', array: false, required: false },
      '0071': { type: 'keyword', array: false, required: false },
      '0072': { type: 'keyword', array: false, required: false },
      '0073': { type: 'keyword', array: false, required: false },
      '0074': { type: 'keyword', array: false, required: false },
      '0075': { type: 'keyword', array: false, required: false },
      '0076': { type: 'keyword', array: false, required: false },
      '0077': { type: 'keyword', array: false, required: false },
      '0078': { type: 'keyword', array: false, required: false },
      '0079': { type: 'keyword', array: false, required: false },
      '0080': { type: 'keyword', array: false, required: false },
      '0081': { type: 'keyword', array: false, required: false },
      '0082': { type: 'keyword', array: false, required: false },
      '0083': { type: 'keyword', array: false, required: false },
      '0084': { type: 'keyword', array: false, required: false },
      '0085': { type: 'keyword', array: false, required: false },
      '0086': { type: 'keyword', array: false, required: false },
      '0087': { type: 'keyword', array: false, required: false },
      '0088': { type: 'keyword', array: false, required: false },
      '0089': { type: 'keyword', array: false, required: false },
      '0090': { type: 'keyword', array: false, required: false },
      '0091': { type: 'keyword', array: false, required: false },
      '0092': { type: 'keyword', array: false, required: false },
      '0093': { type: 'keyword', array: false, required: false },
      '0094': { type: 'keyword', array: false, required: false },
      '0095': { type: 'keyword', array: false, required: false },
      '0096': { type: 'keyword', array: false, required: false },
      '0097': { type: 'keyword', array: false, required: false },
      '0098': { type: 'keyword', array: false, required: false },
      '0099': { type: 'keyword', array: false, required: false },
      '0100': { type: 'keyword', array: false, required: false },
      '0101': { type: 'keyword', array: false, required: false },
      '0102': { type: 'keyword', array: false, required: false },
      '0103': { type: 'keyword', array: false, required: false },
      '0104': { type: 'keyword', array: false, required: false },
      '0105': { type: 'keyword', array: false, required: false },
      '0106': { type: 'keyword', array: false, required: false },
      '0107': { type: 'keyword', array: false, required: false },
      '0108': { type: 'keyword', array: false, required: false },
      '0109': { type: 'keyword', array: false, required: false },
      '0110': { type: 'keyword', array: false, required: false },
      '0111': { type: 'keyword', array: false, required: false },
      '0112': { type: 'keyword', array: false, required: false },
      '0113': { type: 'keyword', array: false, required: false },
      '0114': { type: 'keyword', array: false, required: false },
      '0115': { type: 'keyword', array: false, required: false },
      '0116': { type: 'keyword', array: false, required: false },
      '0117': { type: 'keyword', array: false, required: false },
      '0118': { type: 'keyword', array: false, required: false },
      '0119': { type: 'keyword', array: false, required: false },
      '0120': { type: 'keyword', array: false, required: false },
      '0121': { type: 'keyword', array: false, required: false },
      '0122': { type: 'keyword', array: false, required: false },
      '0123': { type: 'keyword', array: false, required: false },
      '0124': { type: 'keyword', array: false, required: false },
      '0125': { type: 'keyword', array: false, required: false },
      '0126': { type: 'keyword', array: false, required: false },
      '0127': { type: 'keyword', array: false, required: false },
      '0128': { type: 'keyword', array: false, required: false },
      '0129': { type: 'keyword', array: false, required: false },
      '0130': { type: 'keyword', array: false, required: false },
      '0131': { type: 'keyword', array: false, required: false },
      '0132': { type: 'keyword', array: false, required: false },
      '0133': { type: 'keyword', array: false, required: false },
      '0134': { type: 'keyword', array: false, required: false },
      '0135': { type: 'keyword', array: false, required: false },
      '0136': { type: 'keyword', array: false, required: false },
      '0137': { type: 'keyword', array: false, required: false },
      '0138': { type: 'keyword', array: false, required: false },
      '0139': { type: 'keyword', array: false, required: false },
      '0140': { type: 'keyword', array: false, required: false },
      '0141': { type: 'keyword', array: false, required: false },
      '0142': { type: 'keyword', array: false, required: false },
      '0143': { type: 'keyword', array: false, required: false },
      '0144': { type: 'keyword', array: false, required: false },
      '0145': { type: 'keyword', array: false, required: false },
      '0146': { type: 'keyword', array: false, required: false },
      '0147': { type: 'keyword', array: false, required: false },
      '0148': { type: 'keyword', array: false, required: false },
      '0149': { type: 'keyword', array: false, required: false },
      '0150': { type: 'keyword', array: false, required: false },
      '0151': { type: 'keyword', array: false, required: false },
      '0152': { type: 'keyword', array: false, required: false },
      '0153': { type: 'keyword', array: false, required: false },
      '0154': { type: 'keyword', array: false, required: false },
      '0155': { type: 'keyword', array: false, required: false },
      '0156': { type: 'keyword', array: false, required: false },
      '0157': { type: 'keyword', array: false, required: false },
      '0158': { type: 'keyword', array: false, required: false },
      '0159': { type: 'keyword', array: false, required: false },
      '0160': { type: 'keyword', array: false, required: false },
      '0161': { type: 'keyword', array: false, required: false },
      '0162': { type: 'keyword', array: false, required: false },
      '0163': { type: 'keyword', array: false, required: false },
      '0164': { type: 'keyword', array: false, required: false },
      '0165': { type: 'keyword', array: false, required: false },
      '0166': { type: 'keyword', array: false, required: false },
      '0167': { type: 'keyword', array: false, required: false },
      '0168': { type: 'keyword', array: false, required: false },
      '0169': { type: 'keyword', array: false, required: false },
      '0170': { type: 'keyword', array: false, required: false },
      '0171': { type: 'keyword', array: false, required: false },
      '0172': { type: 'keyword', array: false, required: false },
      '0173': { type: 'keyword', array: false, required: false },
      '0174': { type: 'keyword', array: false, required: false },
      '0175': { type: 'keyword', array: false, required: false },
      '0176': { type: 'keyword', array: false, required: false },
      '0177': { type: 'keyword', array: false, required: false },
      '0178': { type: 'keyword', array: false, required: false },
      '0179': { type: 'keyword', array: false, required: false },
      '0180': { type: 'keyword', array: false, required: false },
      '0181': { type: 'keyword', array: false, required: false },
      '0182': { type: 'keyword', array: false, required: false },
      '0183': { type: 'keyword', array: false, required: false },
      '0184': { type: 'keyword', array: false, required: false },
      '0185': { type: 'keyword', array: false, required: false },
      '0186': { type: 'keyword', array: false, required: false },
      '0187': { type: 'keyword', array: false, required: false },
      '0188': { type: 'keyword', array: false, required: false },
      '0189': { type: 'keyword', array: false, required: false },
      '0190': { type: 'keyword', array: false, required: false },
      '0191': { type: 'keyword', array: false, required: false },
      '0192': { type: 'keyword', array: false, required: false },
      '0193': { type: 'keyword', array: false, required: false },
      '0194': { type: 'keyword', array: false, required: false },
      '0195': { type: 'keyword', array: false, required: false },
      '0196': { type: 'keyword', array: false, required: false },
      '0197': { type: 'keyword', array: false, required: false },
      '0198': { type: 'keyword', array: false, required: false },
      '0199': { type: 'keyword', array: false, required: false },
      '0200': { type: 'keyword', array: false, required: false },
      '0201': { type: 'keyword', array: false, required: false },
      '0202': { type: 'keyword', array: false, required: false },
      '0203': { type: 'keyword', array: false, required: false },
      '0204': { type: 'keyword', array: false, required: false },
      '0205': { type: 'keyword', array: false, required: false },
      '0206': { type: 'keyword', array: false, required: false },
      '0207': { type: 'keyword', array: false, required: false },
      '0208': { type: 'keyword', array: false, required: false },
      '0209': { type: 'keyword', array: false, required: false },
      '0210': { type: 'keyword', array: false, required: false },
      '0211': { type: 'keyword', array: false, required: false },
      '0212': { type: 'keyword', array: false, required: false },
      '0213': { type: 'keyword', array: false, required: false },
      '0214': { type: 'keyword', array: false, required: false },
      '0215': { type: 'keyword', array: false, required: false },
      '0216': { type: 'keyword', array: false, required: false },
      '0217': { type: 'keyword', array: false, required: false },
      '0218': { type: 'keyword', array: false, required: false },
      '0219': { type: 'keyword', array: false, required: false },
      '0220': { type: 'keyword', array: false, required: false },
      '0221': { type: 'keyword', array: false, required: false },
      '0222': { type: 'keyword', array: false, required: false },
      '0223': { type: 'keyword', array: false, required: false },
      '0224': { type: 'keyword', array: false, required: false },
      '0225': { type: 'keyword', array: false, required: false },
      '0226': { type: 'keyword', array: false, required: false },
      '0227': { type: 'keyword', array: false, required: false },
      '0228': { type: 'keyword', array: false, required: false },
      '0229': { type: 'keyword', array: false, required: false },
      '0230': { type: 'keyword', array: false, required: false },
      '0231': { type: 'keyword', array: false, required: false },
      '0232': { type: 'keyword', array: false, required: false },
      '0233': { type: 'keyword', array: false, required: false },
      '0234': { type: 'keyword', array: false, required: false },
      '0235': { type: 'keyword', array: false, required: false },
      '0236': { type: 'keyword', array: false, required: false },
      '0237': { type: 'keyword', array: false, required: false },
      '0238': { type: 'keyword', array: false, required: false },
      '0239': { type: 'keyword', array: false, required: false },
      '0240': { type: 'keyword', array: false, required: false },
      '0241': { type: 'keyword', array: false, required: false },
      '0242': { type: 'keyword', array: false, required: false },
      '0243': { type: 'keyword', array: false, required: false },
      '0244': { type: 'keyword', array: false, required: false },
      '0245': { type: 'keyword', array: false, required: false },
      '0246': { type: 'keyword', array: false, required: false },
      '0247': { type: 'keyword', array: false, required: false },
      '0248': { type: 'keyword', array: false, required: false },
      '0249': { type: 'keyword', array: false, required: false },
      '0250': { type: 'keyword', array: false, required: false },
      '0251': { type: 'keyword', array: false, required: false },
      '0252': { type: 'keyword', array: false, required: false },
      '0253': { type: 'keyword', array: false, required: false },
      '0254': { type: 'keyword', array: false, required: false },
      '0255': { type: 'keyword', array: false, required: false },
      '0256': { type: 'keyword', array: false, required: false },
      '0257': { type: 'keyword', array: false, required: false },
      '0258': { type: 'keyword', array: false, required: false },
      '0259': { type: 'keyword', array: false, required: false },
      '0260': { type: 'keyword', array: false, required: false },
      '0261': { type: 'keyword', array: false, required: false },
      '0262': { type: 'keyword', array: false, required: false },
      '0263': { type: 'keyword', array: false, required: false },
      '0264': { type: 'keyword', array: false, required: false },
      '0265': { type: 'keyword', array: false, required: false },
      '0266': { type: 'keyword', array: false, required: false },
      '0267': { type: 'keyword', array: false, required: false },
      '0268': { type: 'keyword', array: false, required: false },
      '0269': { type: 'keyword', array: false, required: false },
      '0270': { type: 'keyword', array: false, required: false },
      '0271': { type: 'keyword', array: false, required: false },
      '0272': { type: 'keyword', array: false, required: false },
      '0273': { type: 'keyword', array: false, required: false },
      '0274': { type: 'keyword', array: false, required: false },
      '0275': { type: 'keyword', array: false, required: false },
      '0276': { type: 'keyword', array: false, required: false },
      '0277': { type: 'keyword', array: false, required: false },
      '0278': { type: 'keyword', array: false, required: false },
      '0279': { type: 'keyword', array: false, required: false },
      '0280': { type: 'keyword', array: false, required: false },
      '0281': { type: 'keyword', array: false, required: false },
      '0282': { type: 'keyword', array: false, required: false },
      '0283': { type: 'keyword', array: false, required: false },
      '0284': { type: 'keyword', array: false, required: false },
      '0285': { type: 'keyword', array: false, required: false },
      '0286': { type: 'keyword', array: false, required: false },
      '0287': { type: 'keyword', array: false, required: false },
      '0288': { type: 'keyword', array: false, required: false },
      '0289': { type: 'keyword', array: false, required: false },
      '0290': { type: 'keyword', array: false, required: false },
      '0291': { type: 'keyword', array: false, required: false },
      '0292': { type: 'keyword', array: false, required: false },
      '0293': { type: 'keyword', array: false, required: false },
      '0294': { type: 'keyword', array: false, required: false },
      '0295': { type: 'keyword', array: false, required: false },
      '0296': { type: 'keyword', array: false, required: false },
      '0297': { type: 'keyword', array: false, required: false },
      '0298': { type: 'keyword', array: false, required: false },
      '0299': { type: 'keyword', array: false, required: false },
      '0300': { type: 'keyword', array: false, required: false },
      '0301': { type: 'keyword', array: false, required: false },
      '0302': { type: 'keyword', array: false, required: false },
      '0303': { type: 'keyword', array: false, required: false },
      '0304': { type: 'keyword', array: false, required: false },
      '0305': { type: 'keyword', array: false, required: false },
      '0306': { type: 'keyword', array: false, required: false },
      '0307': { type: 'keyword', array: false, required: false },
      '0308': { type: 'keyword', array: false, required: false },
      '0309': { type: 'keyword', array: false, required: false },
      '0310': { type: 'keyword', array: false, required: false },
      '0311': { type: 'keyword', array: false, required: false },
      '0312': { type: 'keyword', array: false, required: false },
      '0313': { type: 'keyword', array: false, required: false },
      '0314': { type: 'keyword', array: false, required: false },
      '0315': { type: 'keyword', array: false, required: false },
      '0316': { type: 'keyword', array: false, required: false },
      '0317': { type: 'keyword', array: false, required: false },
      '0318': { type: 'keyword', array: false, required: false },
      '0319': { type: 'keyword', array: false, required: false },
      '0320': { type: 'keyword', array: false, required: false },
      '0321': { type: 'keyword', array: false, required: false },
      '0322': { type: 'keyword', array: false, required: false },
      '0323': { type: 'keyword', array: false, required: false },
      '0324': { type: 'keyword', array: false, required: false },
      '0325': { type: 'keyword', array: false, required: false },
      '0326': { type: 'keyword', array: false, required: false },
      '0327': { type: 'keyword', array: false, required: false },
      '0328': { type: 'keyword', array: false, required: false },
      '0329': { type: 'keyword', array: false, required: false },
      '0330': { type: 'keyword', array: false, required: false },
      '0331': { type: 'keyword', array: false, required: false },
      '0332': { type: 'keyword', array: false, required: false },
      '0333': { type: 'keyword', array: false, required: false },
      '0334': { type: 'keyword', array: false, required: false },
      '0335': { type: 'keyword', array: false, required: false },
      '0336': { type: 'keyword', array: false, required: false },
      '0337': { type: 'keyword', array: false, required: false },
      '0338': { type: 'keyword', array: false, required: false },
      '0339': { type: 'keyword', array: false, required: false },
      '0340': { type: 'keyword', array: false, required: false },
      '0341': { type: 'keyword', array: false, required: false },
      '0342': { type: 'keyword', array: false, required: false },
      '0343': { type: 'keyword', array: false, required: false },
      '0344': { type: 'keyword', array: false, required: false },
      '0345': { type: 'keyword', array: false, required: false },
      '0346': { type: 'keyword', array: false, required: false },
      '0347': { type: 'keyword', array: false, required: false },
      '0348': { type: 'keyword', array: false, required: false },
      '0349': { type: 'keyword', array: false, required: false },
      '0350': { type: 'keyword', array: false, required: false },
      '0351': { type: 'keyword', array: false, required: false },
      '0352': { type: 'keyword', array: false, required: false },
      '0353': { type: 'keyword', array: false, required: false },
      '0354': { type: 'keyword', array: false, required: false },
      '0355': { type: 'keyword', array: false, required: false },
      '0356': { type: 'keyword', array: false, required: false },
      '0357': { type: 'keyword', array: false, required: false },
      '0358': { type: 'keyword', array: false, required: false },
      '0359': { type: 'keyword', array: false, required: false },
      '0360': { type: 'keyword', array: false, required: false },
      '0361': { type: 'keyword', array: false, required: false },
      '0362': { type: 'keyword', array: false, required: false },
      '0363': { type: 'keyword', array: false, required: false },
      '0364': { type: 'keyword', array: false, required: false },
      '0365': { type: 'keyword', array: false, required: false },
      '0366': { type: 'keyword', array: false, required: false },
      '0367': { type: 'keyword', array: false, required: false },
      '0368': { type: 'keyword', array: false, required: false },
      '0369': { type: 'keyword', array: false, required: false },
      '0370': { type: 'keyword', array: false, required: false },
      '0371': { type: 'keyword', array: false, required: false },
      '0372': { type: 'keyword', array: false, required: false },
      '0373': { type: 'keyword', array: false, required: false },
      '0374': { type: 'keyword', array: false, required: false },
      '0375': { type: 'keyword', array: false, required: false },
      '0376': { type: 'keyword', array: false, required: false },
      '0377': { type: 'keyword', array: false, required: false },
      '0378': { type: 'keyword', array: false, required: false },
      '0379': { type: 'keyword', array: false, required: false },
      '0380': { type: 'keyword', array: false, required: false },
      '0381': { type: 'keyword', array: false, required: false },
      '0382': { type: 'keyword', array: false, required: false },
      '0383': { type: 'keyword', array: false, required: false },
      '0384': { type: 'keyword', array: false, required: false },
      '0385': { type: 'keyword', array: false, required: false },
      '0386': { type: 'keyword', array: false, required: false },
      '0387': { type: 'keyword', array: false, required: false },
      '0388': { type: 'keyword', array: false, required: false },
      '0389': { type: 'keyword', array: false, required: false },
      '0390': { type: 'keyword', array: false, required: false },
      '0391': { type: 'keyword', array: false, required: false },
      '0392': { type: 'keyword', array: false, required: false },
      '0393': { type: 'keyword', array: false, required: false },
      '0394': { type: 'keyword', array: false, required: false },
      '0395': { type: 'keyword', array: false, required: false },
      '0396': { type: 'keyword', array: false, required: false },
      '0397': { type: 'keyword', array: false, required: false },
      '0398': { type: 'keyword', array: false, required: false },
      '0399': { type: 'keyword', array: false, required: false },
      '0400': { type: 'keyword', array: false, required: false },
      '0401': { type: 'keyword', array: false, required: false },
      '0402': { type: 'keyword', array: false, required: false },
      '0403': { type: 'keyword', array: false, required: false },
      '0404': { type: 'keyword', array: false, required: false },
      '0405': { type: 'keyword', array: false, required: false },
      '0406': { type: 'keyword', array: false, required: false },
      '0407': { type: 'keyword', array: false, required: false },
      '0408': { type: 'keyword', array: false, required: false },
      '0409': { type: 'keyword', array: false, required: false },
      '0410': { type: 'keyword', array: false, required: false },
      '0411': { type: 'keyword', array: false, required: false },
      '0412': { type: 'keyword', array: false, required: false },
      // '0413': { type: 'keyword', array: false, required: false },
    },
    dynamicTemplates: [
      {
        strings_as_keywords: {
          path_match: 'kibana.alert.grouping.*',
          match_mapping_type: 'string',
          mapping: {
            type: 'keyword',
            ignore_above: 1024,
          },
        },
      },
    ],
  },
  useEcs: true,
  useLegacyAlerts: false,
  shouldWrite: true,
};

export function thresholdRuleType(
  basePath: IBasePath,
  config: ObservabilityConfig,
  logger: Logger,
  locators: CustomThresholdLocators
) {
  return {
    id: OBSERVABILITY_THRESHOLD_RULE_TYPE_ID,
    name: i18n.translate('xpack.observability.threshold.ruleName', {
      defaultMessage: 'Custom threshold',
    }),
    fieldsForAAD: CUSTOM_THRESHOLD_AAD_FIELDS,
    validate: {
      params: customThresholdParamsSchema,
    },
    schemas: {
      params: {
        type: 'config-schema' as const,
        schema: customThresholdParamsSchema,
      },
    },
    defaultActionGroupId: FIRED_ACTION.id,
    actionGroups: [FIRED_ACTION, NO_DATA_ACTION],
    minimumLicenseRequired: 'basic' as LicenseType,
    isExportable: true,
    executor: createCustomThresholdExecutor({ basePath, logger, config, locators }),
    doesSetRecoveryContext: true,
    actionVariables: {
      context: [
        { name: 'group', description: groupActionVariableDescription },
        { name: 'grouping', description: groupingObjectActionVariableDescription },
        {
          name: 'alertDetailsUrl',
          description: alertDetailUrlActionVariableDescription,
          usesPublicBaseUrl: true,
        },
        { name: 'reason', description: reasonActionVariableDescription },
        { name: 'timestamp', description: timestampActionVariableDescription },
        { name: 'value', description: valueActionVariableDescription },
        { name: 'cloud', description: cloudActionVariableDescription },
        { name: 'host', description: hostActionVariableDescription },
        { name: 'container', description: containerActionVariableDescription },
        { name: 'orchestrator', description: orchestratorActionVariableDescription },
        { name: 'labels', description: labelsActionVariableDescription },
        { name: 'tags', description: tagsActionVariableDescription },
        { name: 'viewInAppUrl', description: viewInAppUrlActionVariableDescription },
      ],
    },
    useSavedObjectReferences: {
      // TODO revisit types https://github.com/elastic/kibana/issues/159714
      extractReferences: (params: any) => {
        const [searchConfiguration, references] = extractReferences(params.searchConfiguration);
        const newParams = { ...params, searchConfiguration } as EsQueryRuleParamsExtractedParams;

        return { params: newParams, references };
      },
      injectReferences: (params: any, references: any) => {
        return {
          ...params,
          searchConfiguration: injectReferences(params.searchConfiguration, references),
        };
      },
    },
    category: DEFAULT_APP_CATEGORIES.observability.id,
    producer: observabilityFeatureId,
    solution: 'observability' as const,
    alerts: MetricsRulesTypeAlertDefinition,
    getViewInAppRelativeUrl: ({ rule }: GetViewInAppRelativeUrlFnOpts<{}>) =>
      observabilityPaths.ruleDetails(rule.id),
  };
}
