/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import type { IScopedClusterClient } from '@kbn/core/server';
import type { QueryDslQueryContainer } from '@kbn/data-views-plugin/common/types';
import { getTypedSearch } from '../../../utils/get_typed_search';
import { timeRangeFilter, termFilter } from '../../../utils/dsl_filters';
import { environmentFilter, getTraceIndices } from '../query_builders';

// CI/CD-specific fields for traces/spans (OTel Semantic Conventions)
const CICD_TRACE_FIELDS = [
  '@timestamp',
  'service.name',
  'service.version',
  'service.environment',
  // CI/CD Pipeline attributes (OTel SemConv)
  'cicd.pipeline.name',
  'cicd.pipeline.run.id',
  'cicd.pipeline.run.state',
  'cicd.pipeline.run.url.full',
  'cicd.pipeline.result',
  'cicd.pipeline.task.name',
  'cicd.pipeline.task.type',
  'cicd.pipeline.task.run.result',
  // Span-specific fields
  'span.name',
  'trace.id',
  'span.id',
];

const MAX_CICD_TRACE_EVENTS = 5;

/**
 * Search traces indices for CI/CD pipeline spans using OTel Semantic Conventions.
 * These are typically generated by OTel Jenkins, GitHub Actions, GitLab CI plugins.
 */
export async function searchTracesForCicdEvents({
  esClient,
  apmIndices,
  parsedTimeRange,
  serviceName,
  environment,
}: {
  esClient: IScopedClusterClient;
  apmIndices: { transaction: string; span: string };
  parsedTimeRange: { start: number; end: number };
  serviceName?: string;
  environment?: string;
}): Promise<Array<Record<string, unknown>>> {
  const search = getTypedSearch(esClient.asCurrentUser);

  const mustFilter: QueryDslQueryContainer[] = [
    ...timeRangeFilter('@timestamp', parsedTimeRange),
    ...termFilter('service.name', serviceName),
    ...environmentFilter(environment),
    // Must have CI/CD pipeline attributes (OTel SemConv)
    {
      bool: {
        minimum_should_match: 1,
        should: [
          { exists: { field: 'cicd.pipeline.run.id' } },
          { exists: { field: 'cicd.pipeline.name' } },
          { term: { 'cicd.pipeline.task.type': 'deploy' } },
        ],
      },
    },
  ];

  // Prefer root spans (pipeline runs) over child spans (tasks)
  // Root spans have no parent.id
  const shouldPreferRootSpans: QueryDslQueryContainer[] = [
    { bool: { must_not: { exists: { field: 'parent.id' } } } },
  ];

  const traceIndices = getTraceIndices(apmIndices);

  const response = await search<
    {
      '@timestamp': string;
      [key: string]: unknown;
    },
    any
  >({
    track_total_hits: false,
    index: traceIndices,
    size: MAX_CICD_TRACE_EVENTS,
    _source: CICD_TRACE_FIELDS,
    sort: [{ '@timestamp': 'desc' }],
    query: {
      bool: {
        filter: mustFilter,
        should: shouldPreferRootSpans,
      },
    },
  });

  const sources = response.hits.hits.map((hit) => ({
    ...hit._source,
  }));

  return sources;
}
