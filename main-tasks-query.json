{
  "query": {
    "bool": {
      "must": [
        {
          "bool": {
            "must": [
              {
                "term": {
                  "task.enabled": true
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "bool": {
                  "must": [
                    {
                      "term": {
                        "task.status": "idle"
                      }
                    },
                    {
                      "range": {
                        "task.runAt": {
                          "lte": "now"
                        }
                      }
                    }
                  ]
                }
              },
              {
                "bool": {
                  "must": [
                    {
                      "bool": {
                        "should": [
                          {
                            "term": {
                              "task.status": "running"
                            }
                          },
                          {
                            "term": {
                              "task.status": "claiming"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "range": {
                        "task.retryAt": {
                          "lte": "now"
                        }
                      }
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "term": {
                  "task.taskType": "sampleTaskRemovedType"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.signals"
                }
              },
              {
                "term": {
                  "task.taskType": "search_sessions_monitor"
                }
              },
              {
                "term": {
                  "task.taskType": "search_sessions_cleanup"
                }
              },
              {
                "term": {
                  "task.taskType": "search_sessions_expire"
                }
              },
              {
                "term": {
                  "task.taskType": "cleanup_failed_action_executions"
                }
              },
              {
                "term": {
                  "task.taskType": "reports:monitor"
                }
              },
              {
                "term": {
                  "task.taskType": "session_cleanup"
                }
              },
              {
                "term": {
                  "task.taskType": "actions_telemetry"
                }
              },
              {
                "term": {
                  "task.taskType": "observabilityAIAssistant:indexQueuedDocumentsTaskType"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting_telemetry"
                }
              },
              {
                "term": {
                  "task.taskType": "alerts_invalidate_api_keys"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting_health_check"
                }
              },
              {
                "term": {
                  "task.taskType": "dashboard_telemetry"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:transform_health"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.email"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.index"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.pagerduty"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.swimlane"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.slack"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.slack_api"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.webhook"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.cases-webhook"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.xmatters"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.servicenow"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.servicenow-sir"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.servicenow-itom"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.jira"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.resilient"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.teams"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.torq"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.opsgenie"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.tines"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.gen-ai"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.bedrock"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.d3security"
                }
              },
              {
                "term": {
                  "task.taskType": "actions:.sentinelone"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:.geo-containment"
                }
              },
              {
                "term": {
                  "task.taskType": "cases-telemetry-task"
                }
              },
              {
                "term": {
                  "task.taskType": "Fleet-Usage-Sender"
                }
              },
              {
                "term": {
                  "task.taskType": "Fleet-Usage-Logger"
                }
              },
              {
                "term": {
                  "task.taskType": "Fleet-Metrics-Task"
                }
              },
              {
                "term": {
                  "task.taskType": "fleet:reassign_action:retry"
                }
              },
              {
                "term": {
                  "task.taskType": "fleet:unenroll_action:retry"
                }
              },
              {
                "term": {
                  "task.taskType": "fleet:upgrade_action:retry"
                }
              },
              {
                "term": {
                  "task.taskType": "fleet:update_agent_tags:retry"
                }
              },
              {
                "term": {
                  "task.taskType": "fleet:request_diagnostics:retry"
                }
              },
              {
                "term": {
                  "task.taskType": "fleet:check-deleted-files-task"
                }
              },
              {
                "term": {
                  "task.taskType": "osquery:telemetry-packs"
                }
              },
              {
                "term": {
                  "task.taskType": "osquery:telemetry-saved-queries"
                }
              },
              {
                "term": {
                  "task.taskType": "osquery:telemetry-configs"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:slo.rules.burnRate"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:observability.rules.custom_threshold"
                }
              },
              {
                "term": {
                  "task.taskType": "SLO:ORPHAN_SUMMARIES-CLEANUP-TASK"
                }
              },
              {
                "term": {
                  "task.taskType": "cloud_security_posture-stats_task"
                }
              },
              {
                "term": {
                  "task.taskType": "ML:saved-objects-sync"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.ml.anomaly_detection_alert"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.ml.anomaly_detection_jobs_health"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.uptime.alerts.monitorStatus"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.uptime.alerts.tlsCertificate"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.uptime.alerts.durationAnomaly"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.uptime.alerts.tls"
                }
              },
              {
                "term": {
                  "task.taskType": "UPTIME:SyntheticsService:Sync-Saved-Monitor-Objects"
                }
              },
              {
                "term": {
                  "task.taskType": "Synthetics:Clean-Up-Package-Policies"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.synthetics.alerts.monitorStatus"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:xpack.synthetics.alerts.tls"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:logs.alert.document.count"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:metrics.alert.inventory.threshold"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:metrics.alert.threshold"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_cluster_health"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_license_expiration"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_cpu_usage"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_missing_monitoring_data"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_disk_usage"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_thread_pool_search_rejections"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_thread_pool_write_rejections"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_jvm_memory_usage"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_nodes_changed"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_logstash_version_mismatch"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_kibana_version_mismatch"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_alert_elasticsearch_version_mismatch"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_ccr_read_exceptions"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:monitoring_shard_size"
                }
              },
              {
                "term": {
                  "task.taskType": "apm-telemetry-task"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:apm.transaction_duration"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:apm.anomaly"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:apm.error_rate"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:apm.transaction_error_rate"
                }
              },
              {
                "term": {
                  "task.taskType": "apm-source-map-migration-task"
                }
              },
              {
                "term": {
                  "task.taskType": "risk_engine:risk_scoring"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.eqlRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.esqlRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.savedQueryRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.indicatorRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.mlRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.queryRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.thresholdRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.newTermsRule"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:siem.notifications"
                }
              },
              {
                "term": {
                  "task.taskType": "endpoint:user-artifact-packager"
                }
              },
              {
                "term": {
                  "task.taskType": "security:endpoint-diagnostics"
                }
              },
              {
                "term": {
                  "task.taskType": "security:endpoint-meta-telemetry"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-lists"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-detection-rules"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-prebuilt-rule-alerts"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-timelines"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-diagnostic-timelines"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-configuration"
                }
              },
              {
                "term": {
                  "task.taskType": "security:telemetry-filterlist-artifact"
                }
              },
              {
                "term": {
                  "task.taskType": "endpoint:metadata-check-transforms-task"
                }
              }
            ]
          }
        }
      ],
      "filter": [
        {
          "bool": {
            "must_not": [
              {
                "bool": {
                  "should": [
                    {
                      "term": {
                        "task.status": "running"
                      }
                    },
                    {
                      "term": {
                        "task.status": "claiming"
                      }
                    }
                  ],
                  "must": {
                    "range": {
                      "task.retryAt": {
                        "gt": "now"
                      }
                    }
                  }
                }
              }
            ]
          }
        }
      ]
    }
  },
  "sort": [
    {
      "_script": {
        "type": "number",
        "order": "desc",
        "script": {
          "lang": "painless",
          "source": "\n            String taskType = doc['task.taskType'].value;\n            if (params.priority_map.containsKey(taskType)) {\n              return params.priority_map[taskType];\n            } else {\n              return 20;\n            }\n          ",
          "params": {
            "priority_map": {
              "alerting_health_check": 70,
              "alerting:transform_health": 40,
              "actions:.email": 40,
              "actions:.index": 40,
              "actions:.pagerduty": 40,
              "actions:.swimlane": 40,
              "actions:.server-log": 50,
              "actions:.slack": 40,
              "actions:.slack_api": 40,
              "actions:.webhook": 40,
              "actions:.cases-webhook": 40,
              "actions:.xmatters": 40,
              "actions:.servicenow": 40,
              "actions:.servicenow-sir": 40,
              "actions:.servicenow-itom": 40,
              "actions:.jira": 40,
              "actions:.resilient": 40,
              "actions:.teams": 40,
              "actions:.torq": 40,
              "actions:.opsgenie": 40,
              "actions:.tines": 40,
              "actions:.gen-ai": 40,
              "actions:.bedrock": 40,
              "actions:.d3security": 40,
              "actions:.sentinelone": 40,
              "alerting:.index-threshold": 50,
              "alerting:.geo-containment": 40,
              "alerting:.es-query": 50,
              "report:execute": 60,
              "alerting:slo.rules.burnRate": 40,
              "alerting:observability.rules.custom_threshold": 40,
              "alerting:xpack.ml.anomaly_detection_alert": 40,
              "alerting:xpack.ml.anomaly_detection_jobs_health": 40,
              "alerting:xpack.uptime.alerts.monitorStatus": 40,
              "alerting:xpack.uptime.alerts.tlsCertificate": 40,
              "alerting:xpack.uptime.alerts.durationAnomaly": 40,
              "alerting:xpack.uptime.alerts.tls": 40,
              "alerting:xpack.synthetics.alerts.monitorStatus": 40,
              "alerting:xpack.synthetics.alerts.tls": 40,
              "alerting:logs.alert.document.count": 40,
              "alerting:metrics.alert.inventory.threshold": 40,
              "alerting:metrics.alert.threshold": 40,
              "alerting:monitoring_alert_cluster_health": 40,
              "alerting:monitoring_alert_license_expiration": 40,
              "alerting:monitoring_alert_cpu_usage": 40,
              "alerting:monitoring_alert_missing_monitoring_data": 40,
              "alerting:monitoring_alert_disk_usage": 40,
              "alerting:monitoring_alert_thread_pool_search_rejections": 40,
              "alerting:monitoring_alert_thread_pool_write_rejections": 40,
              "alerting:monitoring_alert_jvm_memory_usage": 40,
              "alerting:monitoring_alert_nodes_changed": 40,
              "alerting:monitoring_alert_logstash_version_mismatch": 40,
              "alerting:monitoring_alert_kibana_version_mismatch": 40,
              "alerting:monitoring_alert_elasticsearch_version_mismatch": 40,
              "alerting:monitoring_ccr_read_exceptions": 40,
              "alerting:monitoring_shard_size": 40,
              "alerting:apm.transaction_duration": 40,
              "alerting:apm.anomaly": 40,
              "alerting:apm.error_rate": 40,
              "alerting:apm.transaction_error_rate": 40,
              "alerting:siem.eqlRule": 40,
              "alerting:siem.esqlRule": 40,
              "alerting:siem.savedQueryRule": 40,
              "alerting:siem.indicatorRule": 40,
              "alerting:siem.mlRule": 40,
              "alerting:siem.queryRule": 40,
              "alerting:siem.thresholdRule": 40,
              "alerting:siem.newTermsRule": 40,
              "alerting:siem.notifications": 40
            }
          }
        }
      }
    },
    {
      "_script": {
        "type": "number",
        "order": "asc",
        "script": {
          "lang": "painless",
          "source": "\nif (doc['task.retryAt'].size()!=0) {\n  return doc['task.retryAt'].value.toInstant().toEpochMilli();\n}\nif (doc['task.runAt'].size()!=0) {\n  return doc['task.runAt'].value.toInstant().toEpochMilli();\n}\n    "
        }
      }
    }
  ],
  "size": 10
}
