{
  "query": {
    "bool": {
      "must": [
        {
          "bool": {
            "must": [
              {
                "term": {
                  "task.enabled": true
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "bool": {
                  "must": [
                    {
                      "term": {
                        "task.status": "idle"
                      }
                    },
                    {
                      "range": {
                        "task.runAt": {
                          "lte": "now"
                        }
                      }
                    }
                  ]
                }
              },
              {
                "bool": {
                  "must": [
                    {
                      "bool": {
                        "should": [
                          {
                            "term": {
                              "task.status": "running"
                            }
                          },
                          {
                            "term": {
                              "task.status": "claiming"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "range": {
                        "task.retryAt": {
                          "lte": "now"
                        }
                      }
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "term": {
                  "task.taskType": "actions:.server-log"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:.index-threshold"
                }
              },
              {
                "term": {
                  "task.taskType": "alerting:.es-query"
                }
              }
            ]
          }
        }
      ],
      "filter": [
        {
          "bool": {
            "must_not": [
              {
                "bool": {
                  "should": [
                    {
                      "term": {
                        "task.status": "running"
                      }
                    },
                    {
                      "term": {
                        "task.status": "claiming"
                      }
                    }
                  ],
                  "must": {
                    "range": {
                      "task.retryAt": {
                        "gt": "now"
                      }
                    }
                  }
                }
              }
            ]
          }
        }
      ]
    }
  },
  "sort": [
    {
      "_script": {
        "type": "number",
        "order": "desc",
        "script": {
          "lang": "painless",
          "source": "\n            String taskType = doc['task.taskType'].value;\n            if (params.priority_map.containsKey(taskType)) {\n              return params.priority_map[taskType];\n            } else {\n              return 20;\n            }\n          ",
          "params": {
            "priority_map": {
              "alerting_health_check": 70,
              "alerting:transform_health": 40,
              "actions:.email": 40,
              "actions:.index": 40,
              "actions:.pagerduty": 40,
              "actions:.swimlane": 40,
              "actions:.server-log": 50,
              "actions:.slack": 40,
              "actions:.slack_api": 40,
              "actions:.webhook": 40,
              "actions:.cases-webhook": 40,
              "actions:.xmatters": 40,
              "actions:.servicenow": 40,
              "actions:.servicenow-sir": 40,
              "actions:.servicenow-itom": 40,
              "actions:.jira": 40,
              "actions:.resilient": 40,
              "actions:.teams": 40,
              "actions:.torq": 40,
              "actions:.opsgenie": 40,
              "actions:.tines": 40,
              "actions:.gen-ai": 40,
              "actions:.bedrock": 40,
              "actions:.d3security": 40,
              "actions:.sentinelone": 40,
              "alerting:.index-threshold": 50,
              "alerting:.geo-containment": 40,
              "alerting:.es-query": 50,
              "report:execute": 60,
              "alerting:slo.rules.burnRate": 40,
              "alerting:observability.rules.custom_threshold": 40,
              "alerting:xpack.ml.anomaly_detection_alert": 40,
              "alerting:xpack.ml.anomaly_detection_jobs_health": 40,
              "alerting:xpack.uptime.alerts.monitorStatus": 40,
              "alerting:xpack.uptime.alerts.tlsCertificate": 40,
              "alerting:xpack.uptime.alerts.durationAnomaly": 40,
              "alerting:xpack.uptime.alerts.tls": 40,
              "alerting:xpack.synthetics.alerts.monitorStatus": 40,
              "alerting:xpack.synthetics.alerts.tls": 40,
              "alerting:logs.alert.document.count": 40,
              "alerting:metrics.alert.inventory.threshold": 40,
              "alerting:metrics.alert.threshold": 40,
              "alerting:monitoring_alert_cluster_health": 40,
              "alerting:monitoring_alert_license_expiration": 40,
              "alerting:monitoring_alert_cpu_usage": 40,
              "alerting:monitoring_alert_missing_monitoring_data": 40,
              "alerting:monitoring_alert_disk_usage": 40,
              "alerting:monitoring_alert_thread_pool_search_rejections": 40,
              "alerting:monitoring_alert_thread_pool_write_rejections": 40,
              "alerting:monitoring_alert_jvm_memory_usage": 40,
              "alerting:monitoring_alert_nodes_changed": 40,
              "alerting:monitoring_alert_logstash_version_mismatch": 40,
              "alerting:monitoring_alert_kibana_version_mismatch": 40,
              "alerting:monitoring_alert_elasticsearch_version_mismatch": 40,
              "alerting:monitoring_ccr_read_exceptions": 40,
              "alerting:monitoring_shard_size": 40,
              "alerting:apm.transaction_duration": 40,
              "alerting:apm.anomaly": 40,
              "alerting:apm.error_rate": 40,
              "alerting:apm.transaction_error_rate": 40,
              "alerting:siem.eqlRule": 40,
              "alerting:siem.esqlRule": 40,
              "alerting:siem.savedQueryRule": 40,
              "alerting:siem.indicatorRule": 40,
              "alerting:siem.mlRule": 40,
              "alerting:siem.queryRule": 40,
              "alerting:siem.thresholdRule": 40,
              "alerting:siem.newTermsRule": 40,
              "alerting:siem.notifications": 40
            }
          }
        }
      }
    },
    {
      "_script": {
        "type": "number",
        "order": "asc",
        "script": {
          "lang": "painless",
          "source": "\nif (doc['task.retryAt'].size()!=0) {\n  return doc['task.retryAt'].value.toInstant().toEpochMilli();\n}\nif (doc['task.runAt'].size()!=0) {\n  return doc['task.runAt'].value.toInstant().toEpochMilli();\n}\n    "
        }
      }
    }
  ],
  "size": 100
}
