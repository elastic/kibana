- name: gather ansible processor facts
  setup:
    gather_subset:
      - "!all"
      - "!min"
      - "processor_cores"
  when: ansible_processor_vcpus is not defined

- name: ensure usr/share/kibana dir exists
  become: yes
  file:
    path: /usr/share/kibana
    state: directory

- name: find kibana distribution
  find:
    paths: /packages/
    patterns: kibana-*-linux-x86_64.tar.gz
  register: kibana_tar

- name: extract kibana distribution
  become: yes
  unarchive:
    src: "{{ kibana_tar.files[0].path }}"
    dest: /usr/share/kibana
    remote_src: yes
    extra_opts: ["--strip-components=1"]

- name: copy configuration
  become: yes
  template:
    src: templates/kibana.yml
    dest: /usr/share/kibana/config/kibana.yml
  register: config

- name: copy FIPS node.options
  become: yes
  template:
    src: templates/fips/node.options
    dest: /usr/share/kibana/config/node.options

- name: copy FIPS openssl config
  become: yes
  template:
    src: templates/fips/nodejs.cnf
    dest: /usr/share/kibana/config/nodejs.cnf

- name: download FIPS certified OpenSSL
  become: yes
  retries: 5
  delay: 10
  get_url:
    url: https://www.openssl.org/source/openssl-3.0.8.tar.gz
    dest: /usr/share/kibana/openssl-3.0.8.tar.gz
    checksum: "sha256:6c13d2bf38fdf31eac3ce2a347073673f5d63263398f1f69d0df4a41253e4b3e"

- name: extract OpenSSL
  become: yes
  unarchive:
    src: /usr/share/kibana/openssl-3.0.8.tar.gz
    dest: /usr/share/kibana
    remote_src: yes

- name: configure OpenSSL for FIPS
  become: yes
  shell:
    chdir: /usr/share/kibana/openssl-3.0.8
    cmd: ./Configure enable-fips

- name: compile OpenSSL with FIPS
  become: yes
  make:
    chdir: /usr/share/kibana/openssl-3.0.8
    jobs: "{{ ansible_facts['processor_vcpus'] }}"

- name: install OpenSSL with FIPS
  become: yes
  make:
    chdir: /usr/share/kibana/openssl-3.0.8
    target: install

- name: link OpenSSL package
  become: yes
  shell:
    cmd: ldconfig /usr/local/lib64/
