- name: find docker image
  find:
    paths: /packages/
    patterns: kibana-ubi-fips-[0-9]*-docker-image.tar.gz
  register: kibana_fips

- name: set image tag
  set_fact:
    kibana_commit: "{{ lookup('env','BUILDKITE_COMMIT') }}"  
    kibana_ver: "{{ kibana_fips.files[0].path | basename| regex_search('kibana-ubi-fips-(.*)-docker-image.tar.gz', '\\1') | first }}" 
    kibana_image_tag: "{{ kibana_ver }}-{{ kibana_commit }}"

- name: load image
  become: yes
  docker_image:
    name: "docker.elastic.co/kibana-ci/kibana-ubi-fips"
    tag: "{{ kibana_image_tag }}"
    load_path: '{{ kibana_fips.files[0].path }}'
    timeout: 300
    source: load
    state: present

- name: start kibana
  become: yes
  docker_container:
    name: kibana
    image: "docker.elastic.co/kibana-ci/kibana-ubi-fips:{{ kibana_image_tag }}"
    network_mode: host
    env:
      SERVER_HOST: 0.0.0.0
      ELASTICSEARCH_HOSTS: http://192.168.56.1:9200
      ELASTICSEARCH_USERNAME: '{{ elasticsearch_username }}'
      ELASTICSEARCH_PASSWORD: '{{ elasticsearch_password }}'
      XPACK_REPORTING_CAPTURE_BROWSER_CHROMIUM_DISABLESANDBOX: 'true'
