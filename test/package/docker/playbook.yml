---
- name: install docker
  hosts: all
  environment:
    PYTHONPATH: "/home/path/.local/lib/python3.8/site-packages"
  vars:
    DOCKER_PACKAGES:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg-agent
      - software-properties-common
      - python3-pip

  tasks:
  - name: update apt packages
    become: yes
    apt:
      update_cache: "yes"
      cache_valid_time: 3600

  - name: install packages needed for Docker
    become: yes
    apt:
      name: "{{ DOCKER_PACKAGES }}"
      state: present
      force_apt_get: "yes"

  - name: add docker gpg key
    become: yes
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present

  - name: save the current Ubuntu release version into a variable
    shell: lsb_release -cs
    register: ubuntu_version
    changed_when: false

  - name: add docker repository
    become: yes
    apt_repository:
      repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ubuntu_version.stdout }} stable"
      state: present

  - name: update apt packages
    become: yes
    apt:
      update_cache: "yes"
      cache_valid_time: 3600

  - name: install docker
    become: yes
    apt:
      name: "docker-ce"
      state: present
      force_apt_get: "yes"

  - name: install docker sdk
    become: yes
    pip:
      name: docker

  - name: load kibana
    become: yes
    docker_image:
      name: kibana
      load_path: /packages/kibana-8.0.0-SNAPSHOT-docker-image.tar.gz
      source: load
      state: present

  - name: start kibana
    become: yes
    community.general.docker_container:
      name: kibana
      image: docker.elastic.co/kibana/kibana:8.0.0-SNAPSHOT
      container_default_behavior: no_defaults
      network_mode: host
      env:
        SERVER_HOST: 0.0.0.0
        ELASTICSEARCH_HOSTS: http://192.168.50.1
