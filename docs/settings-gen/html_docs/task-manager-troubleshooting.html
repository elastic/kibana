<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Task Manager troubleshooting | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Task Manager troubleshooting | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="task-manager-production-considerations.html" title="Task Manager"/>
<link rel="prev" href="task-manager-health-monitoring.html" title="Task Manager health monitoring"/>
<link rel="next" href="discover.html" title="Discover"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="navheader">
<span class="prev">
<a href="task-manager-health-monitoring.html">« Task Manager health monitoring</a>
</span>
<span class="next">
<a href="discover.html">Discover »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="production.html">Use Kibana in a production environment</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="task-manager-production-considerations.html">Task Manager</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Task Manager troubleshooting</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="task-manager-troubleshooting"></a>Task Manager troubleshooting</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div></div></div>

<p>Task Manager is used by a wide range of services in Kibana, such as <a class="xref" href="alerting-production-considerations.html" title="Alerting production considerations">Alerting</a>, Actions, Reporting, and Telemetry.
Unexpected behavior in these services might be a downstream issue originating in Task Manager.</p>
<p>This page describes how to resolve common problems you might encounter with Task Manager.
If your problem isn’t described here, please review open issues in the following GitHub repositories:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/elastic/kibana/issues" class="ulink" target="_top">Kibana</a> (<a href="https://github.com/elastic/kibana/issues?q=is%3Aopen+is%3Aissue+label%3A%22Feature%3ATask+Manager%22" class="ulink" target="_top">Task Manager issues</a>)
</li>
</ul>
</div>
<p>Have a question? Contact us in the <a href="https://discuss.elastic.co/" class="ulink" target="_top">discuss forum</a>.</p>
<div class="position-relative"><h4><a id="task-manager-health-scheduled-tasks-small-schedule-interval-run-late"></a>Tasks with small schedule intervals run late</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Problem</strong></span>:</p>
<p>Tasks are scheduled to run every 2 seconds, but seem to be running late.</p>
<p><span class="strong strong"><strong>Solution</strong></span>:</p>
<p>Task Manager polls for tasks at the cadence specified by the <a class="xref" href="task-manager-settings-kb.html#task-manager-settings" title="Task Manager settings"><code class="literal">xpack.task_manager.poll_interval</code></a> setting, which is 3 seconds by default. This means that a task could run late if it uses a schedule that is smaller than this setting.</p>
<p>You can adjust the <a class="xref" href="task-manager-settings-kb.html#task-manager-settings" title="Task Manager settings"><code class="literal">xpack.task_manager.poll_interval</code></a> setting.  However, this will add additional load to both Kibana and Elasticsearch instances in the cluster, as they will perform more queries.</p>
<div class="position-relative"><h4><a id="task-manager-health-tasks-run-late"></a>Tasks run late</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Problem</strong></span>:</p>
<p>The most common symptom of an underlying problem in Task Manager is that tasks appear to run late.
For instance, recurring tasks might run at an inconsistent cadence, or long after their scheduled time.</p>
<p><span class="strong strong"><strong>Solution</strong></span>:</p>
<p>By default, Kibana polls for tasks at a rate of 10 tasks every 3 seconds.</p>
<p>If many tasks are scheduled to run at the same time, pending tasks will queue in Elasticsearch. Each Kibana instance then polls for pending tasks at a rate of up to 10 tasks at a time, at 3 second intervals. It is possible for pending tasks in the queue to exceed this capacity and run late as a result.</p>
<p>This type of delay is known as <em>drift</em>.The root cause for drift depends on the specific usage, and there are no hard and fast rules for addressing drift.</p>
<p>For example:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If drift is caused by <span class="strong strong"><strong>an excess of concurrent tasks</strong></span> relative to the available capacity of Kibana instances in the cluster, expand the throughput of the cluster.
</li>
<li class="listitem">
If drift is caused by <span class="strong strong"><strong>long running tasks</strong></span> that overrun their scheduled cadence,  reconfigure the tasks in question.
</li>
</ul>
</div>
<p>Refer to <a class="xref" href="task-manager-troubleshooting.html#task-manager-diagnosing-root-cause" title="Diagnose a root cause for drift">Diagnose a root cause for drift</a> for step-by-step instructions on identifying the correct resolution.</p>
<p><em>Drift</em> is often addressed by adjusting the scaling the deployment to better suit your usage.
For details on scaling Task Manager, see <a class="xref" href="task-manager-production-considerations.html#task-manager-scaling-guidance" title="Scaling guidance">Scaling guidance</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="task-manager-diagnosing-root-cause"></a>Diagnose a root cause for drift</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>The following guide helps you identify a root cause for <em>drift</em> by making sense of the output from the <a class="xref" href="task-manager-health-monitoring.html" title="Task Manager health monitoring">Health monitoring</a> endpoint.</p>
<p>By analyzing the different sections of the output, you can evaluate different theories that explain the drift in a deployment.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><a class="xref" href="task-manager-troubleshooting.html#task-manager-health-evaluate-the-configuration" title="Evaluate the Configuration">Evaluate the Configuration</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-reduced-polling-rate">Kibana is configured to poll for tasks at a reduced rate</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><a class="xref" href="task-manager-troubleshooting.html#task-manager-health-evaluate-the-runtime" title="Evaluate the Runtime">Evaluate the Runtime</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-actual-polling-frequently">Kibana is not actually polling as frequently as it should</a>
</li>
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-insufficient-throughput">Kibana is polling as frequently as it should, but that isn&#8217;t often enough to keep up with the workload</a>
</li>
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-long-running-tasks">Tasks run for too long, overrunning their schedule</a>
</li>
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-high-fail-rate">Tasks take multiple attempts to succeed</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-health-evaluate-the-workload" title="Evaluate the Workload">Evaluate the Workload</a>
</li>
<li class="listitem">
<a class="xref" href="task-manager-troubleshooting.html#task-manager-health-evaluate-the-capacity-estimation" title="Evaluate the Capacity Estimation">Evaluate the Capacity Estimation</a>
</li>
</ul>
</div>
<p>Retrieve the latest monitored health stats of a Kibana instance Task Manager:</p>
<div class="pre_wrapper lang-kibana">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-kibana">$ curl -X GET api/task_manager/_health</pre>
</div>
<div class="kibana_widget" data-snippet="snippets/11.kibana"></div>
<p>The API returns the following:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "id": "15415ecf-cdb0-4fef-950a-f824bd277fe4",
  "timestamp": "2021-02-16T11:38:10.077Z",
  "status": "OK",
  "last_update": "2021-02-16T11:38:09.934Z",
  "stats": {
    "configuration": {
      "timestamp": "2021-02-16T11:29:05.055Z",
      "value": {
        "request_capacity": 1000,
        "monitored_aggregated_stats_refresh_rate": 60000,
        "monitored_stats_running_average_window": 50,
        "monitored_task_execution_thresholds": {
          "default": {
            "error_threshold": 90,
            "warn_threshold": 80
          },
          "custom": {}
        },
        "poll_interval": 3000,
        "max_workers": 10
      },
      "status": "OK"
    },
    "runtime": {
      "timestamp": "2021-02-16T11:38:09.934Z",
      "value": {
        "polling": {
          "last_successful_poll": "2021-02-16T11:38:09.934Z",
          "last_polling_delay": "2021-02-16T11:29:05.053Z",
          "duration": {
            "p50": 13,
            "p90": 128,
            "p95": 143,
            "p99": 168
          },
          "claim_conflicts": {
            "p50": 0,
            "p90": 0,
            "p95": 0,
            "p99": 0
          },
          "claim_mismatches": {
            "p50": 0,
            "p90": 0,
            "p95": 0,
            "p99": 0
          },
          "result_frequency_percent_as_number": {
            "Failed": 0,
            "NoAvailableWorkers": 0,
            "NoTasksClaimed": 80,
            "RanOutOfCapacity": 0,
            "RunningAtCapacity": 0,
            "PoolFilled": 20
          }
        },
        "drift": {
          "p50": 99,
          "p90": 1245,
          "p95": 1845,
          "p99": 2878
        },
        "load": {
          "p50": 0,
          "p90": 0,
          "p95": 10,
          "p99": 20
        },
        "execution": {
          "duration": {
            "alerting:.index-threshold": {
              "p50": 95,
              "p90": 1725,
              "p95": 2761,
              "p99": 2761
            },
            "alerting:xpack.uptime.alerts.monitorStatus": {
              "p50": 149,
              "p90": 1071,
              "p95": 1171,
              "p99": 1171
            },
            "actions:.index": {
              "p50": 166,
              "p90": 166,
              "p95": 166,
              "p99": 166
            }
          },
          "persistence": {
            "recurring": 88,
            "non_recurring": 4,
            "ephemeral": 8
          },
          "result_frequency_percent_as_number": {
            "alerting:.index-threshold": {
              "Success": 100,
              "RetryScheduled": 0,
              "Failed": 0,
              "status": "OK"
            },
            "alerting:xpack.uptime.alerts.monitorStatus": {
              "Success": 100,
              "RetryScheduled": 0,
              "Failed": 0,
              "status": "OK"
            },
            "actions:.index": {
              "Success": 10,
              "RetryScheduled": 0,
              "Failed": 90,
              "status": "error"
            }
          }
        }
      },
      "status": "OK"
    },
    "workload": {
      "timestamp": "2021-02-16T11:38:05.826Z",
      "value": {
        "count": 26,
        "task_types": {
          "alerting:.index-threshold": {
            "count": 2,
            "status": {
              "idle": 2
            }
          },
          "actions:.index": {
            "count": 14,
            "status": {
              "idle": 2,
              "running": 2,
              "failed": 10
            }
          },
          "alerting:xpack.uptime.alerts.monitorStatus": {
            "count": 10,
            "status": {
              "idle": 10
            }
          },
        },
        "schedule": [
          ["10s", 2],
          ["1m", 2],
          ["60s", 2],
          ["5m", 2],
          ["60m", 4],
          ["3600s", 1],
          ["720m", 1]
        ],
        "non_recurring": 18,
        "owner_ids": 0,
        "overdue": 10,
        "overdue_non_recurring": 10,
        "estimated_schedule_density": [0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 3, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0],
        "capacity_requirements": {
          "per_minute": 6,
          "per_hour": 28,
          "per_day": 2
        }
      },
      "status": "OK"
    },
    "capacity_estimation": {
      "timestamp": "2021-02-16T11:38:06.826Z",
      "value": {
        "observed": {
          "observed_kibana_instances": 1,
          "max_throughput_per_minute_per_kibana": 200,
          "max_throughput_per_minute": 200,
          "minutes_to_drain_overdue": 1,
          "avg_recurring_required_throughput_per_minute": 28,
          "avg_recurring_required_throughput_per_minute_per_kibana": 28,
          "avg_required_throughput_per_minute": 28,
          "avg_required_throughput_per_minute_per_kibana": 28
        },
        "proposed": {
          "min_required_kibana": 1,
          "provisioned_kibana": 1,
          "avg_recurring_required_throughput_per_minute_per_kibana": 28,
          "avg_required_throughput_per_minute_per_kibana": 28
        }
      }
      "status": "OK"
    }
  }
}</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="task-manager-health-evaluate-the-configuration"></a>Evaluate the Configuration</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div></div></div>
<p><a id="task-manager-theory-reduced-polling-rate"></a><span class="strong strong"><strong>Theory</strong></span>:
Kibana is configured to poll for tasks at a reduced rate.</p>
<p><span class="strong strong"><strong>Diagnosis</strong></span>:
Evaluating the health stats, you can see the following output under <code class="literal">stats.configuration.value</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "request_capacity": 1000,
  "monitored_aggregated_stats_refresh_rate": 60000,
  "monitored_stats_running_average_window": 50,
  "monitored_task_execution_thresholds": {
    "default": {
      "error_threshold": 90,
      "warn_threshold": 80
    },
    "custom": {}
  },
  "poll_interval": 3000, <a id="CO10-1"></a><i class="conum" data-value="1"></i>
  "max_workers": 10 <a id="CO10-2"></a><i class="conum" data-value="2"></i>
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO10-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">poll_interval</code> is set to the default value of 3000 milliseconds</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO10-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">max_workers</code> is set to the default value of 10 workers</p>
</td>
</tr>
</table>
</div>
<p>You can infer from this output that the Kibana instance polls for work every 3 seconds and can run 10 concurrent tasks.</p>
<p>Now suppose the output under <code class="literal">stats.configuration.value</code> is the following:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "request_capacity": 1000,
  "monitored_aggregated_stats_refresh_rate": 60000,
  "monitored_stats_running_average_window": 50,
  "monitored_task_execution_thresholds": {
    "default": {
      "error_threshold": 90,
      "warn_threshold": 80
    },
    "custom": {}
  },
  "poll_interval": 60000, <a id="CO11-1"></a><i class="conum" data-value="1"></i>
  "max_workers": 1 <a id="CO11-2"></a><i class="conum" data-value="2"></i>
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO11-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">poll_interval</code> is set to 60000 milliseconds, far higher than the default</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO11-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">max_workers</code> is set to 1 worker, far lower than the default</p>
</td>
</tr>
</table>
</div>
<p>You can infer from this output that the Kibana instance only polls for work once a minute and only picks up one task at a time. This throughput is unlikely to support mission critical services, such as Alerting or Reporting, and tasks will usually run late.</p>
<p>There are two possible reasons for such a configuration:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
These settings have been configured manually, which can be resolved by reconfiguring these settings.
For details, see <a class="xref" href="task-manager-settings-kb.html" title="Task Manager settings in Kibana">Task Manager Settings</a>.
</li>
<li class="listitem">
<p>Kibana has reduced its own throughput in reaction to excessive load on the Elasticsearch cluster.</p>
<p>Task Manager is equipped with a reactive self-healing mechanism in response to an increase in load related errors in Elasticsearch. This mechanism will increase the <code class="literal">poll_interval</code> setting (reducing the rate at which it queries Elasticsearch), and decrease the <code class="literal">max_workers</code> (reducing the amount of operations it executes against Elasticsearch). Once the error rate reduces, these settings are incrementally dialed up again, returning them to the configured settings.</p>
<p>This scenario can be identified by searching the Kibana Server Log for messages such as:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">Max workers configuration is temporarily reduced after Elasticsearch returned 25 "too many request" error(s).</pre>
</div>
<p>Deeper investigation into the high error rate experienced by the Elasticsearch cluster is required.</p>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="task-manager-health-evaluate-the-runtime"></a>Evaluate the Runtime</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div></div></div>
<p><a id="task-manager-theory-actual-polling-frequently"></a><span class="strong strong"><strong>Theory</strong></span>:
Kibana is not polling as frequently as it should</p>
<p><span class="strong strong"><strong>Diagnosis</strong></span>:
Evaluating the health stats, you see the following output under <code class="literal">stats.runtime.value.polling</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "last_successful_poll": "2021-02-16T11:38:09.934Z", <a id="CO12-1"></a><i class="conum" data-value="1"></i>
  "last_polling_delay": "2021-02-14T11:29:05.053Z",
  "duration": { <a id="CO12-2"></a><i class="conum" data-value="2"></i>
    "p50": 13,
    "p90": 128,
    "p95": 143,
    "p99": 168
  },
  "claim_conflicts": { <a id="CO12-3"></a><i class="conum" data-value="3"></i>
    "p50": 0,
    "p90": 0,
    "p95": 0,
    "p99": 2
  },
  "claim_mismatches": {
    "p50": 0,
    "p90": 0,
    "p95": 0,
    "p99": 0
  },
  "result_frequency_percent_as_number": { <a id="CO12-4"></a><i class="conum" data-value="4"></i>
    "Failed": 0,
    "NoAvailableWorkers": 0,
    "NoTasksClaimed": 80,
    "RanOutOfCapacity": 0,
    "RunningAtCapacity": 0,
    "PoolFilled": 20
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Ensure the last successful polling cycle was completed no more than a couple of multiples of <code class="literal">poll_interval</code> in the past.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Ensure the duration of polling cycles is usually below 100ms. Longer durations are possible, but unexpected.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Ensure Kibana instances in the cluster are not encountering a high rate of version conflicts.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Ensure the majority of polling cycles result in positive outcomes, such as <code class="literal">RunningAtCapacity</code> or <code class="literal">PoolFilled</code>.</p>
</td>
</tr>
</table>
</div>
<p>You can infer from this output that the Kibana instance is polling regularly.
This assessment is based on the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Comparing the <code class="literal">last_successful_poll</code> to the <code class="literal">timestamp</code> (value of <code class="literal">2021-02-16T11:38:10.077Z</code>) at the root, where you can see the last polling cycle took place 1 second before the monitoring stats were exposed by the health monitoring API.
</li>
<li class="listitem">
Comparing the <code class="literal">last_polling_delay</code> to the <code class="literal">timestamp</code> (value of <code class="literal">2021-02-16T11:38:10.077Z</code>) at the root, where you can see the last polling cycle delay took place 2 days ago, suggesting Kibana instances are not conflicting often.
</li>
<li class="listitem">
The <code class="literal">p50</code> of the <code class="literal">duration</code> shows that at least 50% of polling cycles take, at most, 13 milliseconds to complete.
</li>
<li class="listitem">
<p>Evaluating the <code class="literal">result_frequency_percent_as_number</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
80% of the polling cycles completed without claiming any tasks (suggesting that there aren&#8217;t any overdue tasks).
</li>
<li class="listitem">
20% completed with Task Manager claiming tasks that were then executed.
</li>
<li class="listitem">
None of the polling cycles ended up occupying all of the available workers, as <code class="literal">RunningAtCapacity</code> has a frequency of 0%, suggesting there is enough capacity in Task Manager to handle the workload.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>All of these stats are tracked as a running average, which means that they give a snapshot of a period of time (by default Kibana tracks up to 50 cycles), rather than giving a complete history.</p>
<p>Suppose the output under <code class="literal">stats.runtime.value.polling.result_frequency_percent_as_number</code> was the following:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "Failed": 30, <a id="CO13-1"></a><i class="conum" data-value="1"></i>
  "NoAvailableWorkers": 20, <a id="CO13-2"></a><i class="conum" data-value="2"></i>
  "NoTasksClaimed": 10,
  "RanOutOfCapacity": 10, <a id="CO13-3"></a><i class="conum" data-value="3"></i>
  "RunningAtCapacity": 10, <a id="CO13-4"></a><i class="conum" data-value="4"></i>
  "PoolFilled": 20
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>30% of polling cycles failed, which is a high rate.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>20% of polling cycles are skipped as Task Manager has no capacity left to run tasks.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>10% of polling cycles result in Task Manager claiming more tasks than it has capacity to run.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>10% of polling cycles result in Task Manager claiming precisely as many tasks as it has capacity to run.</p>
</td>
</tr>
</table>
</div>
<p>You can infer from this output that Task Manager is not healthy, as the failure rate is high, and Task Manager is fetching tasks it has no capacity to run.
Analyzing the Kibana Server Log should reveal the underlying issue causing the high error rate and capacity issues.</p>
<p>The high <code class="literal">NoAvailableWorkers</code> rate of 20% suggests that there are many tasks running for durations longer than the <code class="literal">poll_interval</code>.
For details on analyzing long task execution durations, see the <a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-long-running-tasks">long running tasks</a> theory.</p>
<p><a id="task-manager-theory-insufficient-throughput"></a><span class="strong strong"><strong>Theory</strong></span>:
Kibana is polling as frequently as it should, but that isn&#8217;t often enough to keep up with the workload</p>
<p><span class="strong strong"><strong>Diagnosis</strong></span>:
Evaluating the health stats, you can see the following output of <code class="literal">drift</code> and <code class="literal">load</code> under <code class="literal">stats.runtime.value</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "drift": { <a id="CO14-1"></a><i class="conum" data-value="1"></i>
    "p50": 99,
    "p90": 1245,
    "p95": 1845,
    "p99": 2878
  },
  "load": { <a id="CO14-2"></a><i class="conum" data-value="2"></i>
    "p50": 0,
    "p90": 0,
    "p95": 10,
    "p99": 20
  },
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO14-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">drift</code> shows us that at least 95% of tasks are running within 2 seconds of their scheduled time.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO14-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">load</code> shows us that Task Manager is idle at least 90% of the time, and never uses more than 20% of its available workers.</p>
</td>
</tr>
</table>
</div>
<p>You can infer from these stats that this Kibana has plenty of capacity, and any delays you might be experiencing are unlikely to be addressed by expanding the throughput.</p>
<p>Suppose the output of <code class="literal">drift</code> and <code class="literal">load</code> was the following:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "drift": { <a id="CO15-1"></a><i class="conum" data-value="1"></i>
    "p50": 2999,
    "p90": 3845,
    "p95": 3845.75,
    "p99": 4078
  },
  "load": { <a id="CO15-2"></a><i class="conum" data-value="2"></i>
    "p50": 80,
    "p90": 100,
    "p95": 100,
    "p99": 100
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO15-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">drift</code> shows us that all tasks are running 3 to 4 seconds after their scheduled time.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO15-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">load</code> shows us that at least half of the time Task Manager is running at a load of 80%.</p>
</td>
</tr>
</table>
</div>
<p>You can infer from these stats that this Kibana is using most of its capacity, but seems to keep up with the work most of the time.
This assessment is based on the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">p90</code> of <code class="literal">load</code> is at 100%, and <code class="literal">p50</code> is also quite high at 80%. This means that there is little to no room for maneuvering, and a spike of work might cause Task Manager to exceed its capacity.
</li>
<li class="listitem">
Tasks run soon after their scheduled time, which is to be expected. A <code class="literal">poll_interval</code> of <code class="literal">3000</code> milliseconds would often experience a consistent drift of somewhere between <code class="literal">0</code> and <code class="literal">3000</code> milliseconds. A <code class="literal">p50 drift</code> of <code class="literal">2999</code> suggests that there is room for improvement, and you could benefit from a higher throughput.
</li>
</ul>
</div>
<p>For details on achieving higher throughput by adjusting your scaling strategy, see <a class="xref" href="task-manager-production-considerations.html#task-manager-scaling-guidance" title="Scaling guidance">Scaling guidance</a>.</p>
<p><a id="task-manager-theory-long-running-tasks"></a><span class="strong strong"><strong>Theory</strong></span>:
Tasks run for too long, overrunning their schedule</p>
<p><span class="strong strong"><strong>Diagnosis</strong></span>:
The <a class="xref" href="task-manager-troubleshooting.html#task-manager-theory-insufficient-throughput">Insufficient throughput to handle the scheduled workload</a> theory analyzed a hypothetical scenario where both drift and load were unusually high.</p>
<p>Suppose an alternate scenario, where <code class="literal">drift</code> is high, but <code class="literal">load</code> is not, such as the following:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    "drift": { <a id="CO16-1"></a><i class="conum" data-value="1"></i>
        "p50": 9799,
        "p90": 83845,
        "p95": 90328,
        "p99": 123845
    },
    "load": { <a id="CO16-2"></a><i class="conum" data-value="2"></i>
        "p50": 40,
        "p90": 75,
        "p95": 80,
        "p99": 100
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO16-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">drift</code> shows that most (if not all) tasks are running at least 32 seconds too late.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO16-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">load</code> shows that, for the most part, you have capacity to run more concurrent tasks.</p>
</td>
</tr>
</table>
</div>
<p>In the preceding scenario, the  tasks are running far too late, but you have sufficient capacity to run more concurrent tasks.
A high capacity allows Kibana to run multiple different tasks concurrently. If a task is already running when its next schedule run is due, Kibana will avoid running it a second time, and instead wait for the first execution to complete.</p>
<p>If a task takes longer to execute than the cadence of its schedule, then that task will always overrun and experience a high drift. For example, suppose a task is scheduled to execute every 3 seconds, but takes 6 seconds to complete. It will consistently suffer from a drift of, at least, 3 seconds.</p>
<p>Evaluating the health stats in this hypothetical scenario, you see the following output under <code class="literal">stats.runtime.value.execution.duration</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "alerting:.index-threshold": { <a id="CO17-1"></a><i class="conum" data-value="1"></i>
    "p50": 95,
    "p90": 1725,
    "p95": 2761,
    "p99": 2761
  },
  "alerting:.es-query": { <a id="CO17-2"></a><i class="conum" data-value="2"></i>
    "p50": 7149,
    "p90": 40071,
    "p95": 45282,
    "p99": 121845
  },
  "actions:.index": {
    "p50": 166,
    "p90": 166,
    "p95": 166,
    "p99": 166
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>50% of the tasks backing index threshold alerts complete in less than 100 milliseconds.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>50% of the tasks backing Elasticsearch query alerts complete in 7 seconds, but at least 10% take longer than 40 seconds.</p>
</td>
</tr>
</table>
</div>
<p>You can infer from these stats that the high drift the Task Manager is experiencing is most likely due to Elasticsearch query alerts that are running for a long time.</p>
<p>Resolving this issue is context dependent and changes from case to case.
In the preceding example, this would be resolved by modifying the queries in these alerts to make them faster, or improving the Elasticsearch throughput to speed up the exiting query.</p>
<p><a id="task-manager-theory-high-fail-rate"></a><span class="strong strong"><strong>Theory</strong></span>:
Tasks take multiple attempts to succeed</p>
<p><span class="strong strong"><strong>Diagnosis</strong></span>:
A high error rate could cause a task to appear to run late, when in fact it runs on time, but experiences a high failure rate.</p>
<p>Evaluating the preceding health stats, you see the following output under <code class="literal">stats.runtime.value.execution.result_frequency_percent_as_number</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "alerting:.index-threshold": { <a id="CO18-1"></a><i class="conum" data-value="1"></i>
    "Success": 100,
    "RetryScheduled": 0,
    "Failed": 0,
    "status": "OK"
  },
  "alerting:xpack.uptime.alerts.monitorStatus": {
    "Success": 100,
    "RetryScheduled": 0,
    "Failed": 0,
    "status": "OK"
  },
  "actions:.index": { <a id="CO18-2"></a><i class="conum" data-value="2"></i>
    "Success": 8,
    "RetryScheduled": 0,
    "Failed": 92,
    "status": "error" <a id="CO18-3"></a><i class="conum" data-value="3"></i>
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>100% of the tasks backing index threshold alerts successfully complete.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>92% of the tasks backing ES index actions fail to complete.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The tasks backing ES index actions have exceeded the default <code class="literal">monitored_task_execution_thresholds</code> <em>error</em> configuration.</p>
</td>
</tr>
</table>
</div>
<p>You can infer from these stats that most <code class="literal">actions:.index</code> tasks, which back the ES Index Kibana action, fail.
Resolving that would require deeper investigation into the Kibana Server Log, where the exact errors are logged, and addressing these specific errors.</p>
<p><a id="task-manager-theory-spikes-in-non-recurring-tasks"></a><span class="strong strong"><strong>Theory</strong></span>:
Spikes in non-recurring and ephemeral tasks are consuming a high percentage of the available capacity</p>
<p><span class="strong strong"><strong>Diagnosis</strong></span>:
Task Manager uses ad-hoc non-recurring tasks to load balance operations across multiple Kibana instances.
Additionally, Kibana can use Task Manager to allocate resources for expensive operations by executing an ephemeral task. Ephemeral tasks are identical in operation to non-recurring tasks, but are not persisted and cannot be load balanced across Kibana instances.</p>
<p>Evaluating the preceding health stats, you see the following output under <code class="literal">stats.runtime.value.execution.persistence</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "recurring": 88, <a id="CO19-1"></a><i class="conum" data-value="1"></i>
  "non_recurring": 4, <a id="CO19-2"></a><i class="conum" data-value="2"></i>
  "ephemeral": 8 <a id="CO19-3"></a><i class="conum" data-value="3"></i>
},</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>88% of executed tasks are recurring tasks</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>4% of executed tasks are non-recurring tasks</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>8% of executed tasks are ephemeral tasks</p>
</td>
</tr>
</table>
</div>
<p>You can infer from these stats that the majority of executions consist of recurring tasks at 88%.
You can use the <code class="literal">execution.persistence</code> stats to evaluate the ratio of consumed capacity, but on their own, you should not make assumptions about the sufficiency of the available capacity.</p>
<p>To assess the capacity, you should evaluate these stats against the <code class="literal">load</code> under <code class="literal">stats.runtime.value</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    "load": { <a id="CO20-1"></a><i class="conum" data-value="2"></i>
        "p50": 40,
        "p90": 40,
        "p95": 60,
        "p99": 80
    }
}</pre>
</div>
<p>You can infer from these stats that it is very unusual for Task Manager to run out of capacity, so the capacity is likely sufficient to handle the amount of non-recurring and ephemeral tasks.</p>
<p>Suppose you have an alternate scenario, where you see the following output under <code class="literal">stats.runtime.value.execution.persistence</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "recurring": 60, <a id="CO20-2"></a><i class="conum" data-value="1"></i>
  "non_recurring": 30, <a id="CO20-3"></a><i class="conum" data-value="2"></i>
  "ephemeral": 10 <a id="CO20-4"></a><i class="conum" data-value="3"></i>
},</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-2"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>60% of executed tasks are recurring tasks</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-1"><i class="conum" data-value="2"></i></a><a href="#CO20-3"></a></p>
</td>
<td align="left" valign="top">
<p>30% of executed tasks are non-recurring tasks</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-4"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>10% of executed tasks are ephemeral tasks</p>
</td>
</tr>
</table>
</div>
<p>You can infer from these stats that even though most executions are recurring tasks, a substantial percentage of executions are non-recurring and ephemeral tasks at 40%.</p>
<p>Evaluating the <code class="literal">load</code> under <code class="literal">stats.runtime.value</code>, you see the following:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    "load": { <a id="CO21-1"></a><i class="conum" data-value="2"></i>
        "p50": 70,
        "p90": 100,
        "p95": 100,
        "p99": 100
    }
}</pre>
</div>
<p>You can infer from these stats that it is quite common for this Kibana instance to run out of capacity.
Given the high rate of non-recurring and ephemeral tasks, it would be reasonable to assess that there is insufficient capacity in the Kibana cluster to handle the amount of tasks.</p>
<p>Keep in mind that these stats give you a glimpse at a moment in time, and even though there has been insufficient capacity in recent minutes, this might not be true in other times where fewer non-recurring or ephemeral tasks are used. We recommend tracking these stats over time and identifying the source of these tasks before making sweeping changes to your infrastructure.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="task-manager-health-evaluate-the-workload"></a>Evaluate the Workload</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div></div></div>
<p>Predicting the required throughput a deployment might need to support Task Manager is difficult, as features can schedule an unpredictable number of tasks at a variety of scheduled cadences.</p>
<p><a class="xref" href="task-manager-health-monitoring.html" title="Task Manager health monitoring">Health monitoring</a> provides statistics that make it easier to monitor the adequacy of the existing throughput.
By evaluating the workload, the required throughput can be estimated, which is used when following the Task Manager <a class="xref" href="task-manager-production-considerations.html#task-manager-scaling-guidance" title="Scaling guidance">Scaling guidance</a>.</p>
<p>Evaluating the preceding health stats in the previous example, you see the following output under <code class="literal">stats.workload.value</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "count": 26, <a id="CO21-2"></a><i class="conum" data-value="1"></i>
  "task_types": {
    "alerting:.index-threshold": {
      "count": 2, <a id="CO21-3"></a><i class="conum" data-value="2"></i>
      "status": {
        "idle": 2
      }
    },
    "actions:.index": {
      "count": 14,
      "status": {
        "idle": 2,
        "running": 2,
        "failed": 10 <a id="CO21-4"></a><i class="conum" data-value="3"></i>
      }
    },
    "alerting:xpack.uptime.alerts.monitorStatus": {
      "count": 10,
      "status": {
        "idle": 10
      }
    },
  },
  "non_recurring": 0, <a id="CO21-5"></a><i class="conum" data-value="4"></i>
  "owner_ids": 1, <a id="CO21-6"></a><i class="conum" data-value="5"></i>
  "schedule": [ <a id="CO21-7"></a><i class="conum" data-value="6"></i>
    ["10s", 2],
    ["1m", 2],
    ["90s", 2],
    ["5m", 8]
  ],
  "overdue_non_recurring": 0, <a id="CO21-8"></a><i class="conum" data-value="7"></i>
  "overdue": 0, <a id="CO21-9"></a><i class="conum" data-value="8"></i>
  "estimated_schedule_density": [ <a id="CO21-10"></a><i class="conum" data-value="9"></i>
    0, 1, 0, 0, 0, 1, 0, 1, 0, 1,
    0, 0, 0, 1, 0, 0, 1, 1, 1, 0,
    0, 3, 0, 0, 0, 1, 0, 1, 0, 1,
    0, 0, 0, 1, 0, 0, 1, 1, 1, 0
  ],
  "capacity_requirements": { <a id="CO21-11"></a><i class="conum" data-value="10"></i>
    "per_minute": 14,
    "per_hour": 240,
    "per_day": 0
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-2"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are 26 tasks in the system, including regular tasks, recurring tasks, and failed tasks.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-1"><i class="conum" data-value="2"></i></a><a href="#CO21-3"></a></p>
</td>
<td align="left" valign="top">
<p>There are 2 <code class="literal">idle</code> index threshold alert tasks, meaning they are scheduled to run at some point in the future.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-4"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Of the 14 tasks backing the ES index action, 10 have failed and 2 are running.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-5"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are no non-recurring tasks in the queue.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-6"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>There is one Task Manager actively executing tasks. There might be additional idle Task Managers, but they aren&#8217;t actively executing tasks at this moment in time.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-7"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>A histogram of all scheduled recurring tasks shows that 2 tasks are scheduled to run every 10 seconds, 2  tasks are scheduled to run once a minute, and so on.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-8"><i class="conum" data-value="7"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are no overdue non-recurring tasks. Non-recurring tasks are usually scheduled to execute immediately, so overdue non-recurring tasks are often a symptom of a congested system.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-9"><i class="conum" data-value="8"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are no overdue tasks, which means that all tasks that <span class="strong strong"><strong>should</strong></span> have run by now <span class="strong strong"><strong>have</strong></span> run.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-10"><i class="conum" data-value="9"></i></a></p>
</td>
<td align="left" valign="top">
<p>This histogram shows the tasks scheduled to run throughout the upcoming 20 polling cycles. The histogram represents the entire deployment, rather than just this Kibana instance.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-11"><i class="conum" data-value="10"></i></a></p>
</td>
<td align="left" valign="top">
<p>The capacity required to handle the recurring tasks in the system. These are buckets, rather than aggregated sums, and we recommend <a class="xref" href="task-manager-troubleshooting.html#task-manager-health-evaluate-the-capacity-estimation" title="Evaluate the Capacity Estimation">evaluating the Capacity Estimation</a> section, rather than evaluating these buckets  yourself.</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">workload</code> section summarizes the work load across the cluster, listing the tasks in the system, their types, schedules, and current status.</p>
<p>You can infer from these stats that a default deployment should suffice.
This assessment is based on the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The estimated schedule density is low.
</li>
<li class="listitem">
There aren&#8217;t many tasks in the system relative to the default capacity.
</li>
</ul>
</div>
<p>Suppose the output of <code class="literal">stats.workload.value</code> looked something like this:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "count": 2191, <a id="CO22-1"></a><i class="conum" data-value="1"></i>
  "task_types": {
    "alerting:.index-threshold": {
      "count": 202,
      "status": {
        "idle": 183,
        "claiming": 2,
        "running": 19
      }
    },
    "alerting:.es-query": {
      "count": 225,
      "status": {
        "idle": 225,
      }
    },
    "actions:.index": {
      "count": 89,
      "status": {
        "idle": 24,
        "running": 2,
        "failed": 63
      }
    },
    "alerting:xpack.uptime.alerts.monitorStatus": {
      "count": 87,
      "status": {
        "idle": 74,
        "running": 13
      }
    },
  },
  "non_recurring": 0,
  "owner_ids": 1,
  "schedule": [ <a id="CO22-2"></a><i class="conum" data-value="2"></i>
    ["10s", 38],
    ["1m", 101],
    ["90s", 55],
    ["5m", 89],
    ["20m", 62],
    ["60m", 106],
    ["1d", 61]
  ],
  "overdue_non_recurring": 0,
  "overdue": 0, <a id="CO22-3"></a><i class="conum" data-value="5"></i>
  "estimated_schedule_density": [  <a id="CO22-4"></a><i class="conum" data-value="3"></i>
    10, 1, 0, 10, 0, 20, 0, 1, 0, 1,
    9, 0, 3, 10, 0, 0, 10, 10, 7, 0,
    0, 31, 0, 12, 16, 31, 0, 10, 0, 10,
    3, 22, 0, 10, 0, 2, 10, 10, 1, 0
  ],
  "capacity_requirements": {
    "per_minute": 329, <a id="CO22-5"></a><i class="conum" data-value="4"></i>
    "per_hour": 4272, <a id="CO22-6"></a><i class="conum" data-value="5"></i>
    "per_day": 61 <a id="CO22-7"></a><i class="conum" data-value="6"></i>
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are 2,191 tasks in the system.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The scheduled tasks are distributed across a variety of cadences.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-4"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The schedule density shows that you expect to exceed the default 10 concurrent tasks.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-5"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are 329 task executions that recur  within the space of every minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-3"><i class="conum" data-value="5"></i></a><a href="#CO22-6"></a></p>
</td>
<td align="left" valign="top">
<p>There are 4,273 task executions that recur within the space of every hour.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-7"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>There are 61 task executions that recur within the space of every day.</p>
</td>
</tr>
</table>
</div>
<p>You can infer several important attributes of your workload from this output:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
There are many tasks in your system and ensuring these tasks run on their scheduled cadence will require attention to the Task Manager throughput.
</li>
<li class="listitem">
Assessing the high frequency tasks (tasks that recur at a cadence of a couple of minutes or less), you must support a throughput of approximately 330 task executions per minute (38 every 10 seconds + 101 every minute).
</li>
<li class="listitem">
Assessing the medium frequency tasks (tasks that recur at a cadence of an hour or less), you must support an additional throughput of over 4,272 task executions per hour (55 every 90 seconds + 89 every 5 minutes, + 62 every 20 minutes + 106 each hour). You can average the needed throughput for the hour by counting these tasks as an additional 70 - 80 tasks per minute.
</li>
<li class="listitem">
Assessing the estimated schedule density, there are cycles that are due to run upwards of 31 tasks concurrently, and along side these cycles, there are empty cycles. You can expect Task Manager to load balance these tasks throughout the empty cycles, but this won&#8217;t leave much capacity to handle spikes in fresh tasks that might be scheduled in the future.
</li>
</ul>
</div>
<p>These rough calculations give you a lower bound to the required throughput, which is <em>at least</em> 410 tasks per minute to ensure recurring tasks are executed, at their scheduled time. This throughput doesn&#8217;t account for nonrecurring tasks that might have been scheduled, nor does it account for tasks (recurring or otherwise) that might be scheduled in the future.</p>
<p>Given these inferred attributes, it would be safe to assume that a single Kibana instance with default settings <span class="strong strong"><strong>would not</strong></span> provide the required throughput. It is possible that scaling horizontally by adding a couple more Kibana instances will.</p>
<p>For details on scaling Task Manager, see <a class="xref" href="task-manager-production-considerations.html#task-manager-scaling-guidance" title="Scaling guidance">Scaling guidance</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="task-manager-health-evaluate-the-capacity-estimation"></a>Evaluate the Capacity Estimation</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
</div></div></div>
<p>Task Manager is constantly evaluating its runtime operations and workload. This enables Task Manager to make rough estimates about the sufficiency of its capacity.</p>
<p>As the name suggests, these are estimates based on historical data and should not be used as predictions. These estimations should be evaluated alongside the detailed <a class="xref" href="task-manager-health-monitoring.html" title="Task Manager health monitoring">Health monitoring</a> stats before making changes to infrastructure. These estimations assume all Kibana instances are configured identically.</p>
<p>We recommend using these estimations when following the Task Manager <a class="xref" href="task-manager-production-considerations.html#task-manager-scaling-guidance" title="Scaling guidance">Scaling guidance</a>.</p>
<p>Evaluating the health stats in the previous example, you can see the following output under <code class="literal">stats.capacity_estimation.value</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "observed": {
    "observed_kibana_instances": 1, <a id="CO23-1"></a><i class="conum" data-value="1"></i>
    "minutes_to_drain_overdue": 1, <a id="CO23-2"></a><i class="conum" data-value="2"></i>
    "max_throughput_per_minute_per_kibana": 200,
    "max_throughput_per_minute": 200, <a id="CO23-3"></a><i class="conum" data-value="3"></i>
    "avg_recurring_required_throughput_per_minute": 28, <a id="CO23-4"></a><i class="conum" data-value="4"></i>
    "avg_recurring_required_throughput_per_minute_per_kibana": 28,
    "avg_required_throughput_per_minute": 28, <a id="CO23-5"></a><i class="conum" data-value="5"></i>
    "avg_required_throughput_per_minute_per_kibana": 28
  },
  "proposed": {
    "min_required_kibana": 1, <a id="CO23-6"></a><i class="conum" data-value="6"></i>
    "provisioned_kibana": 1, <a id="CO23-7"></a><i class="conum" data-value="7"></i>
    "avg_recurring_required_throughput_per_minute_per_kibana": 28,
    "avg_required_throughput_per_minute_per_kibana": 28
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>These estimates assume that there is one Kibana instance actively executing tasks.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Based on past throughput the overdue tasks in the system could be executed within 1 minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Assuming all Kibana instances in the cluster are configured the same as this instance, the maximum available throughput is 200 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>On average, the recurring tasks in the system have historically required a throughput of 28 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>On average, regardless of whether they are recurring or otherwise, the tasks in the system have historically required a throughput of 28 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>One Kibana instance should be sufficient to run the current recurring workload.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-7"><i class="conum" data-value="7"></i></a></p>
</td>
<td align="left" valign="top">
<p>We propose waiting for the workload to change before additional Kibana instances are provisioned.</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">capacity_estimation</code> section is made up of two subsections:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">observed</code> estimates the current capacity by observing historical runtime and workload statistics
</li>
<li class="listitem">
<code class="literal">proposed</code> estimates the baseline Kibana cluster size and the expected throughput under such a deployment strategy
</li>
</ul>
</div>
<p>You can infer from these estimates that the current system is under-utilized and has enough capacity to handle many more tasks than it currently does.</p>
<p>Suppose an alternate scenario, where you see the following output under <code class="literal">stats.capacity_estimation.value</code>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "observed": {
    "observed_kibana_instances": 2, <a id="CO24-1"></a><i class="conum" data-value="1"></i>
    "max_throughput_per_minute_per_kibana": 200,
    "max_throughput_per_minute": 400, <a id="CO24-2"></a><i class="conum" data-value="2"></i>
    "minutes_to_drain_overdue": 12, <a id="CO24-3"></a><i class="conum" data-value="3"></i>
    "avg_recurring_required_throughput_per_minute": 354, <a id="CO24-4"></a><i class="conum" data-value="4"></i>
    "avg_recurring_required_throughput_per_minute_per_kibana": 177, <a id="CO24-5"></a><i class="conum" data-value="5"></i>
    "avg_required_throughput_per_minute": 434, <a id="CO24-6"></a><i class="conum" data-value="6"></i>
    "avg_required_throughput_per_minute_per_kibana": 217
  },
  "proposed": {
    "min_required_kibana": 2, <a id="CO24-7"></a><i class="conum" data-value="7"></i>
    "provisioned_kibana": 3, <a id="CO24-8"></a><i class="conum" data-value="8"></i>
    "avg_recurring_required_throughput_per_minute_per_kibana": 118, <a id="CO24-9"></a><i class="conum" data-value="9"></i>
    "avg_required_throughput_per_minute_per_kibana": 145 <a id="CO24-10"></a><i class="conum" data-value="10"></i>
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>These estimates assume that there are two Kibana instance actively executing tasks.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The maximum available throughput in the system currently is 400 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Based on past throughput the overdue tasks in the system should be executed within 12 minutes.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>On average, the recurring tasks in the system have historically required a throughput of 354 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>On average, each Kibana instance utilizes 177 tasks per minute of its capacity to execute recurring tasks.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>On average the tasks in the system have historically required a throughput of 434 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-7"><i class="conum" data-value="7"></i></a></p>
</td>
<td align="left" valign="top">
<p>The system estimates that at least two Kibana instances are required to run the current recurring workload.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-8"><i class="conum" data-value="8"></i></a></p>
</td>
<td align="left" valign="top">
<p>The system recommends provisioning three Kibana instances to handle the workload.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-9"><i class="conum" data-value="9"></i></a></p>
</td>
<td align="left" valign="top">
<p>Once a third Kibana instance is provisioned, the capacity utilized by each instance to execute recurring tasks should drop from 177 to 118 tasks per minute.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-10"><i class="conum" data-value="10"></i></a></p>
</td>
<td align="left" valign="top">
<p>Taking into account historical ad-hoc task execution, we estimate the throughput required of each Kibana instance will drop from 217 task per minute to 145, once a third Kibana instance is provisioned.</p>
</td>
</tr>
</table>
</div>
<p>Evaluating by these estimates, we can infer some interesting attributes of our system:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
These estimates are produced based on the assumption that there are two Kibana instances in the cluster. This number is based on the number of Kibana instances actively executing tasks in recent minutes. At times this number might fluctuate if Kibana instances remain idle, so validating these estimates against what you know about the system is recommended.
</li>
<li class="listitem">
There appear to be so many overdue tasks that it would take 12 minutes of executions to catch up with that backlog. This does not take into account tasks that might become overdue during those 12 minutes. Although this congestion might be temporary, the system could also remain consistently under provisioned and might never drain the backlog entirely.
</li>
<li class="listitem">
Evaluating the recurring tasks in the workload, the system requires a throughput of 354 tasks per minute on average to execute tasks on time, which is lower then the estimated maximum throughput of 400 tasks per minute. Once we take into account historical throughput though, we estimate the required throughput at 434 tasks per minute. This suggests that, historically, approximately 20% of tasks have been ad-hoc non-recurring tasks, the scale of which are harder to predict than recurring tasks.
</li>
</ul>
</div>
<p>You can infer from these estimates that the capacity in the current system is insufficient and at least one additional Kibana instance is required to keep up with the workload.</p>
<p>For details on scaling Task Manager, see <a class="xref" href="task-manager-production-considerations.html#task-manager-scaling-guidance" title="Scaling guidance">Scaling guidance</a>.</p>
<div class="position-relative"><h4><a id="task-manager-cannot-operate-when-inline-scripts-are-disabled"></a>Inline scripts are disabled in Elasticsearch</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Problem</strong></span>:</p>
<p>Tasks are not running, and the server logs contain the following error message:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[warning][plugins][taskManager] Task Manager cannot operate when inline scripts are disabled in {es}</pre>
</div>
<p><span class="strong strong"><strong>Solution</strong></span>:</p>
<p>Inline scripts are a hard requirement for Task Manager to function.
To enable inline scripting, see the Elasticsearch documentation for <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-security.html#allowed-script-types-setting" class="ulink" target="_top">configuring allowed script types setting</a>.</p>
<div class="position-relative"><h4><a id="task-runat-is-in-the-past"></a>What do I do if the Task’s <code class="literal">runAt</code> is in the past?</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Problem</strong></span>:</p>
<p>Tasks' property <code class="literal">runAt</code> is in the past.</p>
<p><span class="strong strong"><strong>Solution</strong></span>:</p>
<p>Wait a bit before declaring it as a lost cause, as Task Manager might just be falling behind on its work.
You should take a look at the Kibana log and see what you can find that relates to Task Manager.
In a healthy environment you should see a log line that indicates that Task Manager was successfully started when Kibana was:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">server log [12:41:33.672] [info][plugins][taskManager][taskManager] TaskManager is identified by the Kibana UUID: 5b2de169-2785-441b-ae8c-186a1936b17d</pre>
</div>
<p>If you see that message and no other errors that relate to Task Manager, it’s most likely that Task Manager is running fine and has simply not had the chance to pick the task up yet.
If, on the other hand, the runAt is severely overdue, then it’s worth looking for other Task Manager or alerting-related errors, as something else may have gone wrong.
It’s worth looking at the status field, as it might have failed, which would explain why it hasn’t been picked up or it might be running which means the task might simply be a very long running one.</p>
<div class="position-relative"><h4><a id="task-marked-failed"></a>What do I do if the Task is marked as failed?</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Problem</strong></span>:</p>
<p>Tasks marked as failed.</p>
<p><span class="strong strong"><strong>Solution</strong></span>:</p>
<p>Broadly speaking the Alerting framework is meant to gracefully handle the cases where a task is failing by rescheduling a fresh run in the future. If this fails to happen, then that means something has gone wrong in the underlying implementation and this isn’t expected.
Ideally you should try and find any log lines that relate to this rule and its task, and use these to help us investigate further.</p>
<div class="position-relative"><h4><a id="task-manager-kibana-log"></a>Task Manager Kibana Log</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/production-considerations/task-manager-troubleshooting.asciidoc">edit</a></div>
<p>Task manager will write log lines to the Kibana Log on certain occasions. Below are some common log lines and what they mean.</p>
<p>Task Manager has run out of Available Workers:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">server log [12:41:33.672] [info][plugins][taskManager][taskManager] [Task Ownership]: Task Manager has skipped Claiming Ownership of available tasks at it has ran out Available Workers.
server log [12:41:33.672] [warn][plugins][taskManager][taskManager] taskManager plugin is now degraded: Task Manager is unhealthy - Reason: setting HealthStatus.Error because of expired hot timestamps</pre>
</div>
<p>This log message tells us that Task Manager is not managing to keep up with the sheer amount of work it has been tasked with completing. This might mean that rules are not running at the frequency that was expected (instead of running every 5 minutes, it runs every 7-8 minutes, just as an example).</p>
<p>By default Task Manager is limited to 10 tasks and this can be bumped up by setting a higher number in the kibana.yml file using the <code class="literal">xpack.task_manager.max_workers</code> configuration. It is important to keep in mind that a higher number of tasks running at any given time means more load on both Kibana and Elasticsearch, so only change this setting if increasing load in your environment makes sense.</p>
<p>Another approach to addressing this might be to tell workers to run at a higher rate, rather than adding more of them, which would be configured using xpack.task_manager.poll_interval. This value dictates how often Task Manager checks to see if there’s more work to be done and uses milliseconds (by default it is 3000, which means an interval of 3 seconds).</p>
<p>Before changing either of these numbers it’s highly recommended to investigate what Task Manager can’t keep up - Are there an unusually high number of rules in the system? Are rules failing often, forcing Task Manager to re-run them constantly? Is Kibana under heavy load? There could be a variety of issues, none of which should be solved by simply changing these configurations.</p>
<p>Task TaskType failed in attempt to run:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">server log [12:41:33.672] [info][plugins][taskManager][taskManager] Task TaskType "alerting:example.always-firing" failed in attempt to run: Unable to load resource ‘/api/something’</pre>
</div>
<p>This log message tells us that when Task Manager was running one of our rules, it’s task errored and, as a result, failed. In this case we can tell that the rule that failed was of type alerting:example.always-firing and that the reason it failed was Unable to load resource ‘/api/something’ . This is a contrived example, but broadly, if you see a message with this kind of format, then this tells you a lot about where the problem might be.</p>
<p>For example, in this case, we’d expect to see a corresponding log line from the Alerting framework itself, saying that the rule failed. You should look in the Kibana log for a line similar to the log line below (probably shortly before the Task Manager log line):</p>
<p>Executing Rule "27559295-44e4-4983-aa1b-94fe043ab4f9" has resulted in Error: Unable to load resource ‘/api/something’</p>
<p>This would confirm that the error did in fact happen in the rule itself (rather than the Task Manager) and it would help us pin-point the specific ID of the rule which failed: 27559295-44e4-4983-aa1b-94fe043ab4f9</p>
<p>We can now use the ID to find out more about that rule by using the http endpoint to find that rule’s configuration and current state to help investigate what might have caused the issue.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="task-manager-health-monitoring.html">« Task Manager health monitoring</a>
</span>
<span class="next">
<a href="discover.html">Discover »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
