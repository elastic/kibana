<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Manage the integration | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Manage the integration | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="osquery.html" title="Osquery"/>
<link rel="prev" href="osquery.html" title="Osquery"/>
<link rel="next" href="exported-fields-osquery.html" title="Exported fields reference"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="osquery.html">« Osquery</a>
</span>
<span class="next">
<a href="exported-fields-osquery.html">Exported fields reference »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="osquery.html">Osquery</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Manage the integration</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="manage-osquery-integration"></a>Manage the integration</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
</div></div></div>
<div class="position-relative"><h3><a id="_system_requirements"></a>System requirements</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.elastic.co/guide/en/fleet/master/fleet-overview.html" class="ulink" target="_top">Fleet</a> is enabled on your cluster, and
one or more <a href="https://www.elastic.co/guide/en/fleet/master/elastic-agent-installation.html" class="ulink" target="_top">Elastic Agents</a> is enrolled.
</li>
<li class="listitem">
The <a href="https://docs.elastic.co/en/integrations/osquery_manager" class="ulink" target="_top"><span class="strong strong"><strong>Osquery Manager</strong></span></a> integration
has been added and configured
for an agent policy through Fleet.
This integration supports x64 architecture on Windows, MacOS, and Linux platforms,
and ARM64 architecture on Linux.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The original <a href="https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-module-osquery.html" class="ulink" target="_top">Filebeat Osquery module</a>
and the <a href="https://docs.elastic.co/en/integrations/osquery" class="ulink" target="_top">Osquery</a>
integration collect logs from self-managed Osquery deployments.
The <span class="strong strong"><strong>Osquery Manager</strong></span> integration manages Osquery deployments
and supports running and scheduling queries from Kibana.
</li>
<li class="listitem">
<span class="strong strong"><strong>Osquery Manager</strong></span> cannot be integrated with an Elastic Agent in standalone mode.
</li>
</ul>
</div>
</div>
</div>
<div class="position-relative"><h3><a id="_customize_osquery_sub_feature_privileges"></a>Customize Osquery sub-feature privileges</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
<p>Depending on your <a href="https://www.elastic.co/subscriptions" class="ulink" target="_top">subscription level</a>,
you can further customize the sub-feature privileges
for <span class="strong strong"><strong>Osquery Manager</strong></span>. These include options to grant specific access for running live queries,
running saved queries, saving queries, and scheduling packs. For example,
you can create roles for users who can only run live or saved queries, but who cannot save or schedule queries.
This is useful for teams who need in-depth and detailed control.</p>
<div class="position-relative"><h3><a id="osquery-custom-config"></a>Customize Osquery configuration</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> By default, all Osquery Manager integrations share the same osquery configuration. However, you can customize how Osquery is configured by editing the Osquery Manager integration for each agent policy
you want to adjust. The custom configuration is then applied to all agents in the policy.
This powerful feature allows you to configure
<a href="https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring" class="ulink" target="_top">File Integrity Monitoring</a>, <a href="https://osquery.readthedocs.io/en/stable/deployment/process-auditing" class="ulink" target="_top">Process auditing</a>,
and <a href="https://osquery.readthedocs.io/en/stable/deployment/configuration/#configuration-specification" class="ulink" target="_top">others</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Take caution when editing this configuration. The changes you make are distributed to all agents in the policy.
</li>
<li class="listitem">
Take caution when editing <code class="literal">packs</code> using the Advanced <span class="strong strong"><strong>Osquery config</strong></span> field.
Any changes you make to <code class="literal">packs</code> from this field are not reflected in the UI on the Osquery <span class="strong strong"><strong>Packs</strong></span> page in Kibana, however, these changes are deployed to agents in the policy.
While this allows you to use advanced Osquery functionality like pack discovery queries, you do lose the ability to manage packs defined this way from the Osquery <span class="strong strong"><strong>Packs</strong></span> page.
</li>
</ul>
</div>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
From the Kibana main menu, click <span class="strong strong"><strong>Fleet</strong></span>, then the <span class="strong strong"><strong>Agent policies</strong></span> tab.
</li>
<li class="listitem">
Click the name of the agent policy where you want to adjust the Osquery configuration. The configuration changes you make only apply to the policy you select.
</li>
<li class="listitem">
Click the name of the <span class="strong strong"><strong>Osquery Manager</strong></span> integration, or add the integration first if the agent policy does not yet have it.
</li>
<li class="listitem">
From the <span class="strong strong"><strong>Edit Osquery Manager integration</strong></span> page, expand the <span class="strong strong"><strong>Advanced</strong></span> section.
</li>
<li class="listitem">
<p>Edit the <span class="strong strong"><strong>Osquery config</strong></span> JSON field to apply your preferred Osquery configuration. Note the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The field may already have content if you&#8217;ve scheduled packs for this agent policy. To keep these packs scheduled, do not remove the <code class="literal">packs</code> section. The <code class="literal">shard</code> field value is the percentage of agents in the policy using the pack.
</li>
<li class="listitem">
Refer to the <a href="https://osquery.readthedocs.io/en/stable/" class="ulink" target="_top">Osquery documentation</a> for configuration options.
</li>
<li class="listitem">
Some fields are protected and cannot be set. A warning is displayed with details about which fields should be removed.
</li>
<li class="listitem">
(Optional) To load a full configuration file, drag and drop an Osquery <code class="literal">.conf</code> file into the area at the bottom of the page.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Save integration</strong></span> to apply the custom configuration to all agents in the policy.</p>
<p>As an example, the following configuration disables two tables.</p>
<div class="pre_wrapper lang-ts">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ts">{
   "options": {
      "disable_tables":"file,process_envs"
   }
}</pre>
</div>
</li>
</ol>
</div>
<div class="position-relative"><h4><a id="enable-curl-table"></a>Enabling the <code class="literal">curl</code> table</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
<p>By default, the <a href="https://osquery.io/schema/#curl" class="ulink" target="_top">curl table</a> is disabled.
If preferred, you can enable it using the Advanced <span class="strong strong"><strong>Osquery config</strong></span>.</p>
<p><span class="strong strong"><strong>Why is the <code class="literal">curl</code> table disabled?</strong></span></p>
<p>When you query the <a href="https://osquery.io/schema/#curl" class="ulink" target="_top">curl table</a>, this results in an HTTP request.
The query results include the response to the request. As a simple example, if you run the query
<code class="literal">SELECT * FROM curl WHERE url='https://www.elastic.co/';</code>, the <code class="literal">result</code> field contains the
webpage content.</p>
<p>This table can be misused in some environments, for example, when used to issue HTTP requests
to an AWS metadata service or to services on your internal network.</p>
<p>Out of an abundance of caution, we have opted to disable access to this table by default.
However, if you need access to the table for your own monitoring purposes, you can enable it
as needed.</p>
<p><span class="strong strong"><strong>How to enable the <code class="literal">curl</code> table:</strong></span></p>
<p>For each agent policy where you want to allow <code class="literal">curl</code> table queries, edit the
Osquery Manager integration to add the following Advanced <span class="strong strong"><strong>Osquery config</strong></span>:</p>
<div class="pre_wrapper lang-ts">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ts">{
   "options": {
      "enable_tables":"curl"
   }
}</pre>
</div>
<div class="position-relative"><h3><a id="_upgrade_osquery_versions"></a>Upgrade Osquery versions</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
<p>The <a href="https://github.com/osquery/osquery/releases" class="ulink" target="_top">Osquery version</a> available on an Elastic Agent
is associated to the version of Osquery Beat on the Agent.
To get the latest version of Osquery Beat,
<a href="https://www.elastic.co/guide/en/fleet/master/upgrade-elastic-agent.html" class="ulink" target="_top">upgrade your Elastic Agent</a>.</p>
<div class="position-relative"><h3><a id="_debug_issues"></a>Debug issues</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/osquery/manage-integration.asciidoc">edit</a></div>
<p>If you encounter issues with <span class="strong strong"><strong>Osquery Manager</strong></span>, find the relevant logs for Elastic Agent
and Osquerybeat in the agent directory. Refer to the <a href="https://www.elastic.co/guide/en/fleet/master/installation-layout.html" class="ulink" target="_top">Fleet Installation layout</a> to find the log file location for your OS.</p>
<div class="pre_wrapper lang-ts">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ts">../data/elastic-agent-*/logs/elastic-agent-json.log-*
../data/elastic-agent-*/logs/default/osquerybeat-json.log</pre>
</div>
<p>To get more details in the logs, change the agent logging level to debug:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the main menu, and then select <span class="strong strong"><strong>Fleet</strong></span>.
</li>
<li class="listitem">
Select the agent that you want to debug.
</li>
<li class="listitem">
<p>On the <span class="strong strong"><strong>Logs</strong></span> tab, change the <span class="strong strong"><strong>Agent logging level</strong></span> to <span class="strong strong"><strong>debug</strong></span>, and then click <span class="strong strong"><strong>Apply changes</strong></span>.</p>
<p><code class="literal">agent.logging.level</code> is updated in <code class="literal">fleet.yml</code>, and the logging level is changed to <code class="literal">debug</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="osquery.html">« Osquery</a>
</span>
<span class="next">
<a href="exported-fields-osquery.html">Exported fields reference »</a>
</span>
</div>
</body>
</html>
