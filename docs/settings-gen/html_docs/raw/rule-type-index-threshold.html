<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create an index threshold rule | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Create an index threshold rule | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="rule-types.html" title="Rule types"/>
<link rel="prev" href="rule-types.html" title="Rule types"/>
<link rel="next" href="rule-type-es-query.html" title="Create an Elasticsearch query rule"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="rule-types.html">« Rule types</a>
</span>
<span class="next">
<a href="rule-type-es-query.html">Create an Elasticsearch query rule »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="alerting-getting-started.html">Alerting</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rule-types.html">Rule types</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Create an index threshold rule</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/rule-types/index-threshold.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="rule-type-index-threshold"></a>Create an index threshold rule</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/rule-types/index-threshold.asciidoc">edit</a></div>
</div></div></div>

<p>The index threshold rule type runs an Elasticsearch query. It aggregates field values from documents, compares them to threshold values, and schedules actions to run when the thresholds are met.</p>
<p>In <span class="strong strong"><strong>Stack Management</strong></span> &gt; <span class="strong strong"><strong>Rules</strong></span>, click <span class="strong strong"><strong>Create rule</strong></span>.
Select the <span class="strong strong"><strong>Index threshold</strong></span> rule type then fill in the name and optional tags.</p>
<div class="position-relative"><h4><a id="_define_the_conditions"></a>Define the conditions</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/rule-types/index-threshold.asciidoc">edit</a></div>
<p>When you create an index threshold rule, you must define the conditions for the rule to detect. For example:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-conditions.png" alt="Defining index threshold rule conditions in Kibana">
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Specify the indices to query and a time field that will be used for the time window.
</li>
<li class="listitem">
In the <code class="literal">WHEN</code> clause, specify how to calculate the value that is compared to the threshold.
The value is calculated by aggregating a numeric field in a time window.
The aggregation options are: count, average, sum, min, and max.
When using count the document count is used and an aggregation field is not necessary.
</li>
<li class="listitem">
In the <code class="literal">OVER</code> or <code class="literal">GROUPED OVER</code> clause, specify whether the aggregation is applied over all documents or split into groups using a grouping field.
If grouping is used, an alert will be created for each group when it exceeds the threshold.
To limit the number of alerts on high cardinality fields, you must specify the number of groups to check against the threshold.
Only the top groups are checked.
</li>
<li class="listitem">
Choose a threshold value and a comparison operator (<code class="literal">is above</code>, <code class="literal">is above or equals</code>, <code class="literal">is below</code>, <code class="literal">is below or equals</code>, or <code class="literal">is between</code>).
The result of the aggregation is compared to this threshold.
</li>
<li class="listitem">
In the <code class="literal">FOR THE LAST</code> clause, specify a time window.
It determines how far back to search for documents and uses the time field set in the index clause.
</li>
<li class="listitem">
Optionally add a KQL expression to further refine the conditions that the rule detects.
</li>
<li class="listitem">
Set the check interval, which defines how often to evaluate the rule conditions.
Generally this value should be set to a value that is smaller than the time window, to avoid gaps in detection.
</li>
<li class="listitem">
In the advanced options, you can change the number of consecutive runs that must meet the rule conditions before an alert occurs.
The default value is <code class="literal">1</code>.
</li>
</ol>
</div>
<p>If data is available and all clauses have been defined, a preview chart will render the threshold value and display a line chart showing the value for the last 30 intervals.
This can provide an indication of recent values and their proximity to the threshold, and help you tune the clauses.</p>
<div class="position-relative"><h4><a id="actions-index-threshold"></a>Add actions</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/rule-types/index-threshold.asciidoc">edit</a></div>
<p>You can optionally send notifications when the rule conditions are met and when they are no longer met.
In particular, this rule type supports:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
alert summaries
</li>
<li class="listitem">
actions that run when the threshold is met
</li>
<li class="listitem">
recovery actions that run when the rule conditions are no longer met
</li>
</ul>
</div>
<p>For each action, you must choose a connector, which provides connection information for a Kibana service or third party integration.
For more information about all the supported connectors, go to <a class="xref" href="action-types.html" title="Connectors"><em>Connectors</em></a>.</p>
<p>After you select a connector, you must set the action frequency.
You can choose to create a summary of alerts on each check interval or on a custom interval.
For example, summarize the new, ongoing, and recovered alerts at a custom interval:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-action-summary.png" alt="UI for defining alert summary action in an index threshold rule">
</div>
</div>
<p>Alternatively, you can set the action frequency such that actions run for each alert.
Choose how often the action runs (at each check interval, only when the alert status changes, or at a custom action interval).
You must also choose an action group, which indicates whether the action runs when the threshold is met or when the alert is recovered.
Each connector supports a specific set of actions for each action group.
For example:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-action.png" alt="UI for defining an action for each alert">
</div>
</div>
<p>You can further refine the conditions under which actions run by specifying that actions only run when they match a KQL query or when an alert occurs within a specific time frame.</p>
<div class="position-relative"><h4><a id="action-variables-index-threshold"></a>Add action variables</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/rule-types/index-threshold.asciidoc">edit</a></div>
<p>The following action variables are specific to the index threshold rule.
You can also specify <a class="xref" href="rule-action-variables.html" title="Rule action variables">variables common to all rules</a>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">context.conditions</code>
</span>
</dt>
<dd>
A description of the threshold condition. Example: <code class="literal">count greater than 4</code>
</dd>
<dt>
<span class="term">
<code class="literal">context.date</code>
</span>
</dt>
<dd>
The date, in ISO format, that the rule met the threshold condition. Example: <code class="literal">2020-01-01T00:00:00.000Z</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.group</code>
</span>
</dt>
<dd>
The name of the action group associated with the threshold condition. Example: <code class="literal">threshold met</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.message</code>
</span>
</dt>
<dd>
A preconstructed message for the rule. Example:<br>
<code class="literal">rule 'kibana sites - high egress' is active for group 'threshold met':</code><br>
<code class="literal">- Value: 42</code><br>
<code class="literal">- Conditions Met: count greater than 4 over 5m</code><br>
<code class="literal">- Timestamp: 2020-01-01T00:00:00.000Z</code>
</dd>
<dt>
<span class="term">
<code class="literal">context.title</code>
</span>
</dt>
<dd>
A preconstructed title for the rule. Example: <code class="literal">rule kibana sites - high egress met threshold</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.value</code>
</span>
</dt>
<dd>
The value for the rule that met the threshold condition.
</dd>
</dl>
</div>
<div class="position-relative"><h4><a id="_example"></a>Example</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/rule-types/index-threshold.asciidoc">edit</a></div>
<p>In this example, you will use the Kibana <a class="xref" href="add-sample-data.html" title="Add sample data">sample weblog data set</a> to set up and tune the conditions on an index threshold rule. For this example, you want to detect when any of the top four sites serve more than 420,000 bytes over a 24 hour period.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Stack Management &gt; Rules</strong></span> and click <span class="strong strong"><strong>Create rule</strong></span>.
</li>
<li class="listitem">
<p>Select the <span class="strong strong"><strong>Index threshold</strong></span> rule type.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Provide a rule name.
</li>
<li class="listitem">
<p>Select an index. Click <span class="strong strong"><strong>Index</strong></span>, and set <span class="strong strong"><strong>Indices to query</strong></span> to <code class="literal">kibana_sample_data_logs</code>. Set the <span class="strong strong"><strong>Time field</strong></span> to <code class="literal">@timestamp</code>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-index.png" alt="Choosing an index">
</div>
</div>
</li>
<li class="listitem">
<p>To detect the number of bytes served during the time window, click <span class="strong strong"><strong>When</strong></span> and select <code class="literal">sum</code> as the aggregation, and <code class="literal">bytes</code> as the field to aggregate.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-aggregation.png" alt="Choosing the aggregation">
</div>
</div>
</li>
<li class="listitem">
<p>To detect the four sites that have the most traffic, click <span class="strong strong"><strong>Over</strong></span> and select <code class="literal">top</code>, enter <code class="literal">4</code>, and select <code class="literal">host.keyword</code> as the field.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-grouping.png" alt="Choosing the groups">
</div>
</div>
</li>
<li class="listitem">
<p>To trigger the rule when any of the top four sites exceeds 420,000 bytes over a 24 hour period, select <code class="literal">is above</code> and enter <code class="literal">420000</code>. Then click <span class="strong strong"><strong>For the last</strong></span>, enter <code class="literal">24</code>, and select <code class="literal">hours</code>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-threshold.png" alt="Setting the threshold">
</div>
</div>
</li>
<li class="listitem">
<p>Schedule the rule to check every four hours.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-preview.png" alt="Setting the check interval">
</div>
</div>
<p>The preview chart will render showing the 24 hour sum of bytes at 4 hours intervals for the past 120 hours (the last 30 intervals).</p>
</li>
<li class="listitem">
Change the time window and observe the effect it has on the chart. Compare a 24 window to a 12 hour window. Notice the variability in the sum of bytes, due to different traffic levels during the day compared to at night. This variability would result in noisy rules, so the 24 hour window is better. The preview chart can help you find the right values for your rule.
</li>
<li class="listitem">
<p>Define the actions for your rule.</p>
<p>You can add one or more actions to your rule to generate notifications when its conditions are met and when they are no longer met. For each action, you must select a connector, set the action frequency, and compose the notification details.
For example, add an action that uses a server log connector to write an entry to the Kibana server log:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-action.png" alt="Add an action to the rule">
</div>
</div>
<p>The unique action variables that you can use in the notification are listed in <a class="xref" href="rule-type-index-threshold.html#action-variables-index-threshold" title="Add action variables">Add action variables</a>. For more information, refer to <a class="xref" href="create-and-manage-rules.html#defining-rules-actions-details" title="Actions">Actions</a> and <a class="xref" href="action-types.html" title="Connectors"><em>Connectors</em></a>.</p>
</li>
<li class="listitem">
Save the rule.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Find the rule and view its details in <span class="strong strong"><strong>Stack Management &gt; Rules</strong></span>. For example, you can see the status of the rule and its alerts:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-index-threshold-example-alerts.png" alt="View the list of alerts for the rule">
</div>
</div>
</li>
<li class="listitem">
Delete or disable this example rule when it&#8217;s no longer useful. In the detailed rule view, select <span class="strong strong"><strong>Delete rule</strong></span> from the actions menu.
</li>
</ol>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="rule-types.html">« Rule types</a>
</span>
<span class="next">
<a href="rule-type-es-query.html">Create an Elasticsearch query rule »</a>
</span>
</div>
</body>
</html>
