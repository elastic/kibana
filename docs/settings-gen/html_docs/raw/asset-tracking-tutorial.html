<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Track, visualize, and alert on assets in real time | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Track, visualize, and alert on assets in real time | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="maps.html" title="Maps"/>
<link rel="prev" href="maps-getting-started.html" title="Build a map to compare metrics by country or region"/>
<link rel="next" href="reverse-geocoding-tutorial.html" title="Map custom regions with reverse geocoding"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="maps-getting-started.html">« Build a map to compare metrics by country or region</a>
</span>
<span class="next">
<a href="reverse-geocoding-tutorial.html">Map custom regions with reverse geocoding »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="maps.html">Maps</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Track, visualize, and alert on assets in real time</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter xpack">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="asset-tracking-tutorial"></a>Track, visualize, and alert on assets in real time</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
</div></div></div>
<p>Are you interested in asset tracking? Good news! Visualizing and analyzing data that moves is easy with <span class="strong strong"><strong>Maps</strong></span>. You can track the location of an IoT device and monitor a package or vehicle in transit.</p>
<p>In this tutorial, you’ll look at live urban transit data from the city of Portland, Oregon. You’ll watch the city buses, tram, and trains, use the data to visualize congestion, and notify a dispatch team when a vehicle enters a construction zone.</p>
<p>You’ll learn to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Use Elastic Agent to ingest the <a href="https://developer.trimet.org/ws_docs/" class="ulink" target="_top">TriMet REST API</a> into Elasticsearch.
</li>
<li class="listitem">
Create a map with layers that visualize asset tracks and last-known locations.
</li>
<li class="listitem">
Use symbols and colors to style data values and show which direction an asset is heading.
</li>
<li class="listitem">
Set up tracking containment alerts to monitor moving vehicles.
</li>
<li class="listitem">
Display those alerts on a map.
</li>
</ul>
</div>
<p>When you complete this tutorial, you’ll have a map that looks like this:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/construction_zones.png" alt="construction zones">
</div>
</div>
<div class="position-relative"><h3><a id="_prerequisites_3"></a>Prerequisites</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If you don’t already have Kibana, set it up with <a href="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" class="ulink" target="_top">our free trial</a>. Download the deployment credentials.
</li>
<li class="listitem">
Obtain an API key for <a href="https://developer.trimet.org/" class="ulink" target="_top">TriMet web services</a> at <a href="https://developer.trimet.org/appid/registration/" class="ulink" target="_top">https://developer.trimet.org/appid/registration/</a>.
</li>
<li class="listitem">
<a href="https://www.elastic.co/guide/en/fleet/master/fleet-overview.html" class="ulink" target="_top">Fleet</a> is enabled on your cluster, and one or more <a href="https://www.elastic.co/guide/en/fleet/master/elastic-agent-installation.html" class="ulink" target="_top">Elastic Agents</a> is enrolled.
</li>
</ul>
</div>
<div class="position-relative"><h3><a id="_part_1_ingest_the_portland_public_transport_data"></a>Part 1: Ingest the Portland public transport data</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>To get to the fun of visualizing and alerting on Portland public transport vehicles, you must first add the <span class="strong strong"><strong>Custom API</strong></span> integration to an Elastic Agent policy to get the TriMet Portland data into Elasticsearch.</p>
<div class="position-relative"><h4><a id="_step_1_set_up_an_elasticsearch_index"></a>Step 1: Set up an Elasticsearch index</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Kibana, open the main menu, then click <span class="strong strong"><strong>Dev Tools</strong></span>.
</li>
<li class="listitem">
<p>In <span class="strong strong"><strong>Console</strong></span>, create the <code class="literal">tri_met_tracks</code> index lifecyle policy. This policy will keep the events in the hot data phase for 7 days. The data then moves to the warm phase. After 365 days in the warm phase, the data is deleted.</p>
<details open>
<summary class="title">ILM policy definition</summary>
<div class="content">
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">PUT _ilm/policy/tri_met_tracks
{
 "policy": {
   "phases": {
     "hot": {
       "min_age": "0ms",
       "actions": {
         "rollover": {
           "max_primary_shard_size": "50gb",
           "max_age": "7d"
         },
         "set_priority": {
           "priority": 100
         }
       }
     },
     "warm": {
       "min_age": "0d",
       "actions": {
         "set_priority": {
           "priority": 50
         }
       }
     },
     "delete": {
       "min_age": "365d",
       "actions": {
         "delete": {
           "delete_searchable_snapshot": true
         }
       }
     }
   }
 }
}</pre>
</div>
</div>
</details>
</li>
<li class="listitem">
<p>In <span class="strong strong"><strong>Console</strong></span>, add the <code class="literal">tri_met_tracks_for_elastic_agent</code> ingest pipeline.</p>
<details open>
<summary class="title">Ingest policy definition</summary>
<div class="content">
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">PUT _ingest/pipeline/tri_met_tracks_for_elastic_agent
{
 "processors": [
   {
     "set": {
       "field": "trimet.inCongestion",
       "value": "false",
       "if": "ctx?.trimet?.inCongestion == null"
     }
   },
   {
     "convert": {
       "field": "trimet.bearing",
       "type": "float"
     }
   },
   {
     "convert": {
       "field": "trimet.inCongestion",
       "type": "boolean"
     }
   },
   {
     "script": {
       "source": """
         double lat=Math.round(ctx['trimet']['latitude']*1e6)/1e6;
         double lon=Math.round(ctx['trimet']['longitude']*1e6)/1e6;
         ctx['trimet']['location'] = lat + "," + lon
         """,
       "description": "Generate the geometry rounding to six decimals"
     }
   },
   {
     "script": {
       "source": """ctx['_id'] = ctx['trimet']['vehicleID'] + "_" + ctx['trimet']['time']""",
       "description": "Generate documentID"
     }
   },
   {
     "remove": {
       "field": [
         "message",
         "input",
         "agent",
         "ecs",
         "host",
         "event",
         "trimet.longitude",
         "trimet.latitude"
       ]
     }
   }
 ]
}</pre>
</div>
</div>
</details>
</li>
<li class="listitem">
<p>In <span class="strong strong"><strong>Console</strong></span>, create the component and index template, which is configured to use datastreams and the previous ILM policy and ingest pipeline:</p>
<details open>
<summary class="title">Index component template</summary>
<div class="content">
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">PUT _component_template/logs-httpjson.trimet@package
{
 "template": {
   "settings": {
     "index": {
       "lifecycle": {
         "name": "tri_met_tracks"
       },
       "codec": "best_compression",
       "default_pipeline": "tri_met_tracks_for_elastic_agent"
     }
   },
   "mappings": {
     "_routing": {
       "required": false
     },
     "numeric_detection": false,
     "dynamic_date_formats": [
       "strict_date_optional_time",
       "yyyy/MM/dd HH:mm:ss Z||yyyy/MM/dd Z"
     ],
     "dynamic": true,
     "_source": {
       "excludes": [],
       "includes": [],
       "enabled": true
     },
     "dynamic_templates": [],
     "date_detection": true,
     "properties": {
       "input": {
         "properties": {
           "type": {
             "ignore_above": 1024,
             "type": "keyword"
           }
         }
       },
       "@timestamp": {
         "ignore_malformed": false,
         "type": "date"
       },
       "ecs": {
         "properties": {
           "version": {
             "ignore_above": 1024,
             "type": "keyword"
           }
         }
       },
       "data_stream": {
         "properties": {
           "namespace": {
             "type": "constant_keyword"
           },
           "type": {
             "type": "constant_keyword"
           },
           "dataset": {
             "type": "constant_keyword"
           }
         }
       },
       "event": {
         "properties": {
           "created": {
             "type": "date"
           },
           "module": {
             "type": "constant_keyword",
             "value": "httpjson"
           },
           "dataset": {
             "type": "constant_keyword",
             "value": "httpjson.trimet"
           }
         }
       },
       "message": {
         "type": "match_only_text"
       },
       "tags": {
         "ignore_above": 1024,
         "type": "keyword"
       },
       "trimet": {
         "type": "object",
         "properties": {
           "expires": {
             "type": "date"
           },
           "signMessage": {
             "type": "text"
           },
           "serviceDate": {
             "type": "date"
           },
           "loadPercentage": {
             "type": "float"
           },
           "nextStopSeq": {
             "type": "integer"
           },
           "source": {
             "type": "keyword"
           },
           "type": {
             "type": "keyword"
           },
           "blockID": {
             "type": "integer"
           },
           "signMessageLong": {
             "type": "text"
           },
           "lastLocID": {
             "type": "keyword"
           },
           "nextLocID": {
             "type": "keyword"
           },
           "locationInScheduleDay": {
             "type": "integer"
           },
           "newTrip": {
             "type": "boolean"
           },
           "direction": {
             "type": "integer"
           },
           "inCongestion": {
             "type": "boolean"
           },
           "routeNumber": {
             "type": "integer"
           },
           "bearing": {
             "type": "integer"
           },
           "garage": {
             "type": "keyword"
           },
           "tripID": {
             "type": "keyword"
           },
           "delay": {
             "type": "integer"
           },
           "extraBlockID": {
             "type": "keyword"
           },
           "messageCode": {
             "type": "integer"
           },
           "lastStopSeq": {
             "type": "integer"
           },
           "location": {
             "type": "geo_point"
           },
           "time": {
             "index": true,
             "ignore_malformed": false,
             "store": false,
             "type": "date",
             "doc_values": true
           },
           "vehicleID": {
             "type": "keyword"
           },
           "offRoute": {
             "type": "boolean"
           }
         }
       }
     }
   }
 }
}</pre>
</div>
</div>
</details>
<details open>
<summary class="title">Index template</summary>
<div class="content">
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">PUT _index_template/logs-httpjson.trimet
{
 "index_patterns": [
   "logs-httpjson.trimet-*"
 ],
 "composed_of": [
   "logs-httpjson.trimet@package",
   ".fleet_globals-1",
   ".fleet_agent_id_verification-1"
 ],
 "priority": 200,
 "data_stream": {
   "hidden": false,
   "allow_custom_routing": false
 }
}</pre>
</div>
</div>
</details>
</li>
</ol>
</div>
<div class="position-relative"><h4><a id="_step_2_configure_elastic_agent"></a>Step 2: Configure Elastic Agent</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<div class="tabs" data-tab-group="get-policy-id">
 <div role="tablist" aria-label="Get the agent policy id">
   <button role="tab"
           aria-selected="true"
           aria-controls="get-policy-tab-existing"
           id="get-policy-id-existing">
     Existing agent policy
   </button>
   <button role="tab"
           aria-selected="false"
           aria-controls="get-policy-tab-create"
           id="get-policy-group-create"
           tabindex="-1">
     Create a new agent policy
   </button>
 </div>
 <div tabindex="0"
      role="tabpanel"
      id="get-policy-tab-existing"
      aria-labelledby="get-policy-id-existing">
<p>If you already have an agent policy, get its identifier from the <code class="literal">View policy</code> action fly out</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/agent-policy-id.png" alt="agent policy id">
</div>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/policy_id.png" alt="policy id">
</div>
</div>
 </div>
 <div tabindex="1"
      role="tabpanel"
      id="get-policy-tab-create"
      aria-labelledby="get-policy-group-create"
      hidden="">
<p>If you don&#8217;t have yet an agent policy ready:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Still in the <span class="strong strong"><strong>Console</strong></span>, create an agent policy for this data source</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">POST kbn:/api/fleet/agent_policies?sys_monitoring=true
{
 "name": "trimet",
 "description": "Policy to gather TriMet data",
 "namespace": "default",
 "monitoring_enabled": ["logs", "metrics"],
 "inactivity_timeout": 1209600,
 "is_protected": false
}</pre>
</div>
</li>
<li class="listitem">
Note the <code class="literal">item.id</code> value of the request result, it will be used later when registering your integration
</li>
<li class="listitem">
Enroll a new Elastic Agent into this new policy using any of the methods provided by the UI (linux, Mac, Windows, etc.)
</li>
</ol>
</div>
 </div>
</div>
<p>Execute the following request from the <span class="strong strong"><strong>Console</strong></span> to install a new Custom API integration. Put the corresponding values for the <code class="literal">policy_id</code> and <code class="literal">tri_met_app_id</code>.</p>
<details open>
<summary class="title">Create a new Custom API integration</summary>
<div class="content">
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">POST kbn:/api/fleet/package_policies
{
 "policy_id": "&lt;policy_id&gt;", <a id="CO32-6"></a><i class="conum" data-value="1"></i>
 "package": {
   "name": "httpjson",
   "version": "1.18.0"
 },
 "name": "httpjson-trimet",
 "description": "TriMet data upload",
 "namespace": "default",
 "inputs": {
   "generic-httpjson": {
     "enabled": true,
     "streams": {
       "httpjson.generic": {
         "enabled": true,
         "vars": {
           "data_stream.dataset": "httpjson.trimet",
           "request_url": "https://developer.trimet.org/ws/v2/vehicles?appID=&lt;tri_met_app_id&gt;", <a id="CO32-7"></a><i class="conum" data-value="2"></i>
           "request_interval": "1m", <a id="CO32-8"></a><i class="conum" data-value="3"></i>
           "request_method": "GET",
           "response_split": "target: body.resultSet.vehicle",
           "request_redirect_headers_ban_list": [],
           "oauth_scopes": [],
           "processors": "- decode_json_fields:\n    fields: [\"message\"]\n    target: \"trimet\"\n",
           "tags": [
             "trimet"
             ]
         }
       }
     }
   }
 }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO32-1"><i class="conum" data-value="1"></i></a><a href="#CO32-6"></a></p>
</td>
<td align="left" valign="top">
<p>Agent policy identifier</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO32-2"><i class="conum" data-value="2"></i></a><a href="#CO32-7"></a></p>
</td>
<td align="left" valign="top">
<p>TriMet application identifier</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO32-3"><i class="conum" data-value="3"></i></a><a href="#CO32-8"></a></p>
</td>
<td align="left" valign="top">
<p>Retrieve vehicle positions every minute</p>
</td>
</tr>
</table>
</div>
</div>
</details>
<p>This request will configure the integration to make requests to the TriMet REST API every minute, splitting the API response into one message per vehicle into the <code class="literal">httpjson.trimet</code> data stream, and encoding the vehicle&#8217;s data into the <code class="literal">trimet</code> field. The rest of the data management will be handled by the ingest policy defined in the first step.</p>
<div class="position-relative"><h4><a id="_step_3_create_a_data_view_for_the_tri_met_tracks_elasticsearch_index"></a>Step 3: Create a data view for the tri_met_tracks Elasticsearch index</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>In <span class="strong strong"><strong>Console</strong></span> execute this request to create a new Kibana Data View called TriMet Positions:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">POST kbn:/api/data_views/data_view
{
 "data_view": {
    "title": "logs-httpjson.trimet-*",
    "name": "TriMet Positions",
    "timeFieldName": "trimet.time"
 }
}</pre>
</div>
<p>Kibana shows the fields in your data view.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/data_view.png" alt="data view">
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>You may want to tweak this Data View to adjust the field names and number or date formatting to your personal preferences. These settings are honored by the Maps application in the tooltips and other UI elements. Check <a class="xref" href="managing-data-views.html#managing-fields" title="Format data fields">Format data fields</a> for more details.</p>
</div>
</div>
<div class="position-relative"><h4><a id="_step_4_explore_the_portland_trimet_data"></a>Step 4: Explore the Portland TriMet data</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the main menu, and click <span class="strong strong"><strong>Discover</strong></span>.
</li>
<li class="listitem">
Set the data view to <span class="strong strong"><strong>TriMet Positions</strong></span>.
</li>
<li class="listitem">
Open the <a class="xref" href="set-time-filter.html" title="Set the time range">time filter</a>, and set the time range to the last 15 minutes.
</li>
<li class="listitem">
Expand a document and explore some of the fields that you will use later in this tutorial: <code class="literal">trimet.bearing</code>, <code class="literal">trimet.inCongestion</code>, <code class="literal">trimet.location</code>, and <code class="literal">trimet.vehicleID</code>.
</li>
</ol>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/discover.png" alt="discover">
</div>
</div>
<div class="position-relative"><h3><a id="_part_2_build_an_operational_map"></a>Part 2: Build an operational map</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>It&#8217;s hard to get an overview of Portland vehicles by looking at individual events. Let&#8217;s create a map to show the routes and current location for each vehicle, along with the direction they are heading.</p>
<div class="position-relative"><h4><a id="_step_1_create_your_map"></a>Step 1: Create your map</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>Create your map and set the theme for the default layer to dark mode.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the main menu, and click <span class="strong strong"><strong>Maps</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create map</strong></span>.
</li>
<li class="listitem">
In the <span class="strong strong"><strong>Layers</strong></span> list, click <span class="strong strong"><strong>Road map</strong></span>, and then click <span class="strong strong"><strong>Edit layer settings</strong></span>.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Tile service</strong></span> dropdown, and select <span class="strong strong"><strong>Road map - dark</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Keep changes</strong></span>.
</li>
</ol>
</div>
<div class="position-relative"><h4><a id="_step_2_add_a_tracks_layer"></a>Step 2. Add a tracks layer</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>Add a layer to show the vehicle routes for the last 15 minutes.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add layer</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Tracks</strong></span>.
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>TriMet Positions</strong></span> data view.
</li>
<li class="listitem">
<p>Define the tracks:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Set <span class="strong strong"><strong>Entity</strong></span> to <code class="literal">trimet.vehicleID</code>.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Sort</strong></span> to <code class="literal">trimet.time</code>.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add and continue</strong></span>.
</li>
<li class="listitem">
<p>In Layer settings:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Set <span class="strong strong"><strong>Name</strong></span> to <span class="strong strong"><strong>Tracks</strong></span>.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Opacity</strong></span> to 80%.
</li>
</ol>
</div>
</li>
<li class="listitem">
Scroll to <span class="strong strong"><strong>Layer Style</strong></span>, and set <span class="strong strong"><strong>Border color</strong></span> to pink.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Keep changes</strong></span>.
</li>
<li class="listitem">
In the <span class="strong strong"><strong>Layers</strong></span> list, click <span class="strong strong"><strong>Tracks</strong></span>, and then click <span class="strong strong"><strong>Fit to data</strong></span>.
</li>
</ol>
</div>
<p>At this point, you have a map with lines that represent the routes of the TriMet vehicles as they move around the city.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/tracks_layer.png" alt="tracks layer">
</div>
</div>
<div class="position-relative"><h4><a id="_step_3_indicate_the_direction_of_the_vehicle_tracks"></a>Step 3. Indicate the direction of the vehicle tracks</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>Add a layer that uses attributes in the data to set the style and orientation of the vehicles. You’ll see the direction vehicles are headed and what traffic is like.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add layer</strong></span>, and then select <span class="strong strong"><strong>Top Hits per entity</strong></span>.
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>TriMet Positions</strong></span> data view.
</li>
<li class="listitem">
<p>To display the most recent location per vehicle:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Set <span class="strong strong"><strong>Entity</strong></span> to <code class="literal">trimet.vehicleID</code>.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Documents per entity</strong></span> to 1.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Sort field</strong></span> to <code class="literal">trimet.time</code>.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Sort order</strong></span> to <span class="strong strong"><strong>descending</strong></span>.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add and continue</strong></span>.
</li>
<li class="listitem">
Change the name to <span class="strong strong"><strong>Latest positions</strong></span>.
</li>
<li class="listitem">
<p>Scroll to <span class="strong strong"><strong>Layer Style</strong></span>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Set <span class="strong strong"><strong>Symbol type</strong></span> to <span class="strong strong"><strong>icon</strong></span>.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Icon</strong></span> to <span class="strong strong"><strong>Arrow</strong></span>.
</li>
<li class="listitem">
<p>Set the <span class="strong strong"><strong>Fill color</strong></span>:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li class="listitem">
Select <span class="strong strong"><strong>By value</strong></span> styling, and set the field to <code class="literal">trimet.inCongestion</code>.
</li>
<li class="listitem">
Use a <span class="strong strong"><strong>Custom color palette</strong></span>.
</li>
<li class="listitem">
Set the <span class="strong strong"><strong>Other</strong></span> color to a dark grey.
</li>
<li class="listitem">
Add a green class for <code class="literal">false</code>, meaning the vehicle is not in traffic.
</li>
<li class="listitem">
Add a red class for <code class="literal">true</code>, meaning the vehicle is in congestion.
</li>
</ol>
</div>
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Border width</strong></span> to 0.
</li>
<li class="listitem">
<p>Change <span class="strong strong"><strong>Symbol orientation</strong></span> to use <span class="strong strong"><strong>By value</strong></span> and the <code class="literal">trimet.bearing</code> field.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/top_hits_layer_style.png" alt="top hits layer style">
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Keep changes</strong></span>.
</li>
<li class="listitem">
Open the <a class="xref" href="set-time-filter.html" title="Set the time range">time filter</a>, and set <span class="strong strong"><strong>Refresh every</strong></span> to 10 seconds, and click <span class="strong strong"><strong>Start</strong></span>.
</li>
</ol>
</div>
<p>Your map should automatically refresh every 10 seconds to show the latest vehicle positions and tracks.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/tracks_and_top_hits.png" alt="tracks and top hits">
</div>
</div>
<div class="position-relative"><h3><a id="_part_3_setup_geo_fencing_alerts"></a>Part 3: Setup geo-fencing alerts</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>Let&#8217;s make TriMet Portland data actionable and alert when vehicles enter construction zones.</p>
<div class="position-relative"><h4><a id="_step_1_add_a_construction_zone"></a>Step 1. Add a construction zone</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>Add a layer for construction zones, which you will draw on the map. The construction zones will be used as your geofence boundary or threshold that serves as the basis for triggering alerts.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add layer</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create index</strong></span>.
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Index name</strong></span> to <code class="literal">trimet_construction_zones</code>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create index</strong></span>.
</li>
<li class="listitem">
<p>Draw 2 or 3 construction zones on your map:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In the toolbar on left side of the map, select the bounding box icon <span class="image"><img src="maps/images/asset-tracking-tutorial/bounding_box_icon.png" alt="bounding box icon"></span>.
</li>
<li class="listitem">
To draw a construction zone, click a start point on the map and drag.
</li>
<li class="listitem">
Click an endpoint to finish.
</li>
</ol>
</div>
</li>
<li class="listitem">
When you finish drawing the construction zones, click <span class="strong strong"><strong>Exit</strong></span> under the layer name in the legend.
</li>
<li class="listitem">
In <span class="strong strong"><strong>Layer settings</strong></span>, set <span class="strong strong"><strong>Name</strong></span> to <span class="strong strong"><strong>Construction zones</strong></span>.
</li>
<li class="listitem">
Scroll to <span class="strong strong"><strong>Layer Style</strong></span>, and set <span class="strong strong"><strong>Fill color</strong></span> to yellow.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Keep changes</strong></span>.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Save</strong></span> the map.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Give the map a title.
</li>
<li class="listitem">
Under <span class="strong strong"><strong>Add to dashboard</strong></span>, select <span class="strong strong"><strong>None</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save and add to library</strong></span>.
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>The map now represents an operational view of live public transport traffic.  You’ll see the direction that the vehicles are traveling, and whether they are near or have entered a construction zone.</p>
<p>Your map is now complete for now, congratulations!</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/construction_zones.png" alt="construction zones">
</div>
</div>
<div class="position-relative"><h4><a id="_step_2_configure_an_alert"></a>Step 2. Configure an alert</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>Create a new alert by defining a rule and a connector. The rule includes the conditions that will trigger the alert, and the connector defines what action takes place once the alert is triggered. In this case, each alert will insert a new document into an Elasticsearch index.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For this example, you will set the rule to check every minute. However, when running in production this value may need to be adjusted to a higher check interval to avoid performance issues. Refer to <a class="xref" href="alerting-production-considerations.html" title="Alerting production considerations">Alerting production considerations</a> for more information.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>In the Kibana <span class="strong strong"><strong>Console</strong></span> create a new index and Data view</p>
<details open>
<summary class="title">Create an index and Data View for the alerts</summary>
<div class="content">
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js"># Create the alerts index
PUT trimet_alerts
{
 "settings": {
   "number_of_replicas": 1,
   "number_of_shards": 1
 },
 "mappings": {
   "properties": {
     "vehicleId": {"type": "keyword"},
     "documentId": {"type": "text"},
     "vehicleTime": {"type": "date"},
     "detectionTime": {"type": "date"},
     "location": {"type": "geo_point"},
     "boundaryId": {"type": "keyword"},
     "message": {"type": "text"}
   }
 }
}


# Create the alerts index data view
POST kbn:/api/data_views/data_view
{
 "data_view": {
    "title": "trimet_alerts",
    "name": "TriMet Alerts",
    "timeFieldName": "detectionTime"
 }
}</pre>
</div>
</div>
</details>
</li>
<li class="listitem">
Open <span class="strong strong"><strong>Stack Management</strong></span>, and then click <span class="strong strong"><strong>Rules</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create rule</strong></span>.
</li>
<li class="listitem">
Name the rule <span class="strong strong"><strong>TriMet Alerts</strong></span>.
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>Tracking containment</strong></span> rule type.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Entities</strong></span> block</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select the <span class="strong strong"><strong>TriMet Positions</strong></span> Data View
</li>
<li class="listitem">
Select <code class="literal">trimet.time</code> as the <span class="strong strong"><strong>time field</strong></span>
</li>
<li class="listitem">
Select <code class="literal">trimet.location</code> as the <span class="strong strong"><strong>location field</strong></span>
</li>
<li class="listitem">
Select <code class="literal">trimet.vehicleID</code> as the <span class="strong strong"><strong>entity field</strong></span>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Boundaries</strong></span> block</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select the <span class="strong strong"><strong>trimet_construction_zones</strong></span> Data View
</li>
<li class="listitem">
Select <code class="literal">coordinates</code> as the <span class="strong strong"><strong>location field</strong></span>
</li>
<li class="listitem">
Leave the <span class="strong strong"><strong>Display name</strong></span> and <span class="strong strong"><strong>Filter</strong></span> empty
</li>
</ol>
</div>
</li>
<li class="listitem">
Select the rule to check every minute
</li>
<li class="listitem">
Set <span class="strong strong"><strong>Check every</strong></span> to <span class="strong strong"><strong>1 minute</strong></span>.
</li>
<li class="listitem">
<p>Notify <span class="strong strong"><strong>Only on status change</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/rule_configuration.png" alt="rule configuration">
</div>
</div>
</li>
<li class="listitem">
Under <span class="strong strong"><strong>Actions</strong></span>, select the <span class="strong strong"><strong>Index</strong></span> connector type.
</li>
<li class="listitem">
<p>Add a new conector named <span class="strong strong"><strong>TriMet Alerts</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select the <code class="literal">trimet_alerts</code> index
</li>
<li class="listitem">
Define time field for each document with the <code class="literal">detectionTime</code> field
</li>
</ol>
</div>
</li>
<li class="listitem">
Leave the <span class="strong strong"><strong>Action frequency</strong></span> with the default option: <span class="strong strong"><strong>On status changes</strong></span>
</li>
<li class="listitem">
Leave the <span class="strong strong"><strong>Run when</strong></span> selector with the default option: <span class="strong strong"><strong>Tracking containment met</strong></span>
</li>
<li class="listitem">
<p>Use the following template to create new index documents:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
 "vehicleId": "{{context.entityId}}",
 "vehicleTime": "{{context.entityDateTime}}",
 "documentId": "{{context.entityDocumentId}}",
 "detectionTime": "{{context.detectionDateTime}}",
 "location": "{{context.entityLocation}}",
 "boundaryId": "{{context.containingBoundaryId}}"
}</pre>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/alert_connector.png" alt="alert connector">
</div>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save</strong></span>.
</li>
</ol>
</div>
<p>The <span class="strong strong"><strong>TriMet Alerts connector</strong></span> is added to the <span class="strong strong"><strong>Connectors</strong></span> page. For more information on common connectors, refer to the <a class="xref" href="slack-action-type.html" title="Slack connector and action">Slack</a> and <a class="xref" href="email-action-type.html" title="Email connector and action">Email</a> connectors.</p>
<div class="position-relative"><h4><a id="_step_3_view_alerts_in_real_time"></a>Step 3. View alerts in real time</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/asset-tracking-tutorial.asciidoc">edit</a></div>
<p>With the alert configured and running, in a few minutes your <code class="literal">trimet_alerts</code> index should start getting data. You can add this data to the operational map easily:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Open your operational map
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add layer</strong></span>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Documents</strong></span>
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>TriMet Alerts</strong></span> Data View
</li>
<li class="listitem">
Change the <span class="strong strong"><strong>Symbol type</strong></span> to <span class="strong strong"><strong>Icon</strong></span> and select the <span class="strong strong"><strong>Bus</strong></span> icon
</li>
<li class="listitem">
Change the color to pink
</li>
<li class="listitem">
Enable the <span class="strong strong"><strong>Label</strong></span> option with the <code class="literal">vehicleId</code> field
</li>
<li class="listitem">
<p>Add the <code class="literal">vehicleId</code>, <code class="literal">boundaryId</code>, <code class="literal">detectionTime</code>, and <code class="literal">vehicleTime</code> fields to the tooltip configuration to allow viewing alert details on the map.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="maps/images/asset-tracking-tutorial/vehicle_alerts.png" alt="vehicle alerts">
</div>
</div>
</li>
</ul>
</div>
<p>Congratulations! You have completed the tutorial and have the recipe for tracking assets. You can now try replicating this same analysis with your own data.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="maps-getting-started.html">« Build a map to compare metrics by country or region</a>
</span>
<span class="next">
<a href="reverse-geocoding-tutorial.html">Map custom regions with reverse geocoding »</a>
</span>
</div>
</body>
</html>
