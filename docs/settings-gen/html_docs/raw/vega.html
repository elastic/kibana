<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Vega | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Vega | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="aggregation-reference.html" title="Create panels with editors"/>
<link rel="prev" href="tsvb.html" title="TSVB"/>
<link rel="next" href="add-aggregation-based-visualization-panels.html" title="Aggregation-based"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="tsvb.html">« TSVB</a>
</span>
<span class="next">
<a href="add-aggregation-based-visualization-panels.html">Aggregation-based »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="dashboard.html">Dashboard and visualizations</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="aggregation-reference.html">Create panels with editors</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Vega</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="vega"></a>Vega</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Vega</strong></span> and <span class="strong strong"><strong>Vega-Lite</strong></span> are both grammars for creating custom visualizations. They are recommended for advanced users who are comfortable writing Elasticsearch queries manually.
<span class="strong strong"><strong>Vega-Lite</strong></span> is a good starting point for users who are new to both grammars, but they are not compatible.</p>
<p><span class="strong strong"><strong>Vega</strong></span> and <span class="strong strong"><strong>Vega-Lite</strong></span> panels can display one or more data sources, including Elasticsearch, Elastic Map Service,
URL, or static data, and support <a class="xref" href="vega.html#reference-for-kibana-extensions" title="Reference for Kibana extensions">Kibana extensions</a> that allow you to embed the panels on your dashboard and add interactive tools.</p>
<p>Use <span class="strong strong"><strong>Vega</strong></span> or <span class="strong strong"><strong>Vega-Lite</strong></span> when you want to create visualizations with:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Aggregations that use <code class="literal">nested</code> or <code class="literal">parent/child</code> mapping
</li>
<li class="listitem">
Aggregations without a data view
</li>
<li class="listitem">
Queries that use custom time filters
</li>
<li class="listitem">
Complex calculations
</li>
<li class="listitem">
Extracted data from _source instead of aggregations
</li>
<li class="listitem">
Scatter charts, sankey charts, and custom maps
</li>
<li class="listitem">
An unsupported visual theme
</li>
</ul>
</div>
<p>These grammars have some limitations: they do not support tables, and can&#8217;t run queries conditionally.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega.png" alt="Vega UI">
</div>
</div>
<p>Both <span class="strong strong"><strong>Vega</strong></span> and <span class="strong strong"><strong>Vega-Lite</strong></span> use JSON, but Kibana has made this simpler to type by integrating
<a href="https://hjson.github.io/" class="ulink" target="_top">HJSON</a>. HJSON supports the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Optional quotes
</li>
<li class="listitem">
Double quotes or single quotes
</li>
<li class="listitem">
Optional commas
</li>
<li class="listitem">
Comments using // or /* syntax
</li>
<li class="listitem">
Multiline strings
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="_tutorials_create_custom_panels"></a>Tutorials: Create custom panels</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>Learn how to connect <span class="strong strong"><strong>Vega-Lite</strong></span> with Kibana filters and Elasticsearch data, then learn how to create more Kibana interaction using <span class="strong strong"><strong>Vega</strong></span>.</p>
<p>As you edit the specs, work in small steps, and frequently save your work. Small changes can cause unexpected results. To save, click <span class="strong strong"><strong>Save</strong></span> in the toolbar.</p>
<p>Before starting, add the eCommerce sample data that you&#8217;ll use in your spec, then create the dashboard.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
On the home page, click <span class="strong strong"><strong>Try sample data</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Other sample data sets</strong></span>.
</li>
<li class="listitem">
On the <span class="strong strong"><strong>Sample eCommerce orders</strong></span> card, click <span class="strong strong"><strong>Add data</strong></span>.
</li>
<li class="listitem">
Open the main menu, then click <span class="strong strong"><strong>Dashboard</strong></span>.
</li>
<li class="listitem">
On the <span class="strong strong"><strong>Dashboards</strong></span> page, click <span class="strong strong"><strong>Create dashboard</strong></span>.
</li>
</ol>
</div>
<div class="position-relative"><h5><a id="_open_and_set_up_vega_lite"></a>Open and set up Vega-Lite</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>Open <span class="strong strong"><strong>Vega-Lite</strong></span> and change the time range.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>On the dashboard, click <span class="strong strong"><strong>Select type</strong></span>, then select <span class="strong strong"><strong>Custom visualization</strong></span>.</p>
<p>A pre-populated line chart displays the total number of documents.</p>
</li>
<li class="listitem">
Make sure the <a class="xref" href="set-time-filter.html" title="Set the time range">time filter</a> is <span class="strong strong"><strong>Last 7 days</strong></span>.
</li>
</ol>
</div>
<div class="position-relative"><h3><a id="vega-tutorial-create-a-stacked-area-chart"></a>Tutorial: Create a stacked area chart from an Elasticsearch search query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>Learn how to query Elasticsearch from <span class="strong strong"><strong>Vega-Lite</strong></span>, displaying the results in a stacked area chart.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In the <span class="strong strong"><strong>Vega-Lite</strong></span> spec, replace <code class="literal">index: _all</code> with the following, then click <span class="strong strong"><strong>Update</strong></span>:
</li>
</ol>
</div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">index: kibana_sample_data_ecommerce</pre>
</div>
<p>A flat line appears with zero results.</p>
<p>To add the data fields from the <span class="strong strong"><strong>kibana_sample_data_ecommerce</strong></span> data view, replace the following, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">%timefield%: @timestamp</code> with <code class="literal">%timefield%: order_date</code>
</li>
<li class="listitem">
<code class="literal">field: @timestamp</code> with <code class="literal">field: order_date</code>
</li>
</ul>
</div>
<div class="position-relative"><h5><a id="_add_the_aggregations"></a>Add the aggregations</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>To create the stacked area chart, add the aggregations.</p>
<p>To check your work, open and use the <a class="xref" href="console-kibana.html" title="Run API requests"><span class="strong strong"><strong>Console</strong></span></a> on a separate browser tab.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open Kibana on a new tab.
</li>
<li class="listitem">
Open the main menu, then click <span class="strong strong"><strong>Dev Tools</strong></span>.
</li>
<li class="listitem">
On the <span class="strong strong"><strong>Console</strong></span> editor, enter the aggregation, then click <span class="strong strong"><strong>Click to send request</strong></span>:
</li>
</ol>
</div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">POST kibana_sample_data_ecommerce/_search
{
  "query": {
    "range": {
      "order_date": {
        "gte": "now-7d"
      }
    }
  },
  "aggs": {
    "time_buckets": {
      "date_histogram": {
        "field": "order_date",
        "fixed_interval": "1d",
        "extended_bounds": {
          "min": "now-7d"
        },
        "min_doc_count": 0
      }
    }
  },
  "size": 0
}</pre>
</div>
<p>Add the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-aggregations-bucket-terms-aggregation.html" class="ulink" target="_top">terms aggregation</a>, then click <span class="strong strong"><strong>Click to send request</strong></span>:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">POST kibana_sample_data_ecommerce/_search
{
  "query": {
    "range": {
      "order_date": {
        "gte": "now-7d"
      }
    }
  },
  "aggs": {
    "categories": {
      "terms": { "field": "category.keyword" },
      "aggs": {
        "time_buckets": {
          "date_histogram": {
            "field": "order_date",
            "fixed_interval": "1d",
            "extended_bounds": {
              "min": "now-7d"
            },
            "min_doc_count": 0
          }
        }
      }
    }
  },
  "size": 0
}</pre>
</div>
<p>The response format is different from the first aggregation query:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "aggregations" : {
    "categories" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [{
        "key" : "Men's Clothing",
        "doc_count" : 1661,
        "time_buckets" : {
          "buckets" : [{
            "key_as_string" : "2020-06-30T00:00:00.000Z",
            "key" : 1593475200000,
            "doc_count" : 19
          }, {
            "key_as_string" : "2020-07-01T00:00:00.000Z",
            "key" : 1593561600000,
            "doc_count" : 71
          }]
        }
      }]
    }
  }
}</pre>
</div>
<p>In the <span class="strong strong"><strong>Vega-Lite</strong></span> spec, enter the aggregations, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  data: {
    url: {
      %context%: true
      %timefield%: order_date
      index: kibana_sample_data_ecommerce
      body: {
        aggs: {
          categories: {
            terms: { field: "category.keyword" }
            aggs: {
              time_buckets: {
                date_histogram: {
                  field: order_date
                  interval: {%autointerval%: true}
                  extended_bounds: {
                    min: {%timefilter%: "min"}
                    max: {%timefilter%: "max"}
                  }
                  min_doc_count: 0
                }
              }
            }
          }
        }
        size: 0
      }
    }
    format: {property: "aggregations.categories.buckets" }
  }</pre>
</div>
<p>For information about the queries, refer to <a class="xref" href="vega.html#vega-queries" title="Writing Elasticsearch queries in Vega">reference for writing Elasticsearch queries in Vega</a>.</p>
<div class="position-relative"><h5><a id="_debug_the_warning"></a>Debug the warning</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>To generate the data, <span class="strong strong"><strong>Vega-Lite</strong></span> uses the <code class="literal">source_0</code> and <code class="literal">data_0</code>. <code class="literal">source_0</code> contains
the results from the Elasticsearch query, and <code class="literal">data_0</code> contains the visually encoded results that are shown on the chart.
To debug the warning, compare <code class="literal">source_0</code> and <code class="literal">data_0</code>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In the toolbar, click <span class="strong strong"><strong>Inspect</strong></span>.
</li>
<li class="listitem">
From the <span class="strong strong"><strong>View</strong></span> dropdown, select <span class="strong strong"><strong>Vega debug</strong></span>.
</li>
<li class="listitem">
<p>From the dropdown, select <span class="strong strong"><strong>source_0</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_lite_tutorial_4.png" alt="Table for data_0 with columns key" width="doc_count and array of time_buckets">
</div>
</div>
</li>
<li class="listitem">
<p>To compare to the visually encoded data, select <span class="strong strong"><strong>data_0</strong></span> from the dropdown.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_lite_tutorial_5.png" alt="Table for data_0 where the key is NaN instead of a string">
</div>
</div>
<p><span class="strong strong"><strong>key</strong></span> is unable to convert because the property is category (<code class="literal">Men's Clothing</code>, <code class="literal">Women's Clothing</code>, etc.) instead of a timestamp.</p>
</li>
</ol>
</div>
<div class="position-relative"><h5><a id="_add_and_debug_the_encoding_block"></a>Add and debug the encoding block</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>In the <span class="strong strong"><strong>Vega-Lite</strong></span> spec, add the <code class="literal">encoding</code> block:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  encoding: {
    x: {
      field: time_buckets.buckets.key
      type: temporal
      axis: { title: null }
    }
    y: {
      field: time_buckets.buckets.doc_count
      type: quantitative
      axis: { title: "Document count" }
    }
  }</pre>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Inspect</strong></span>, then select <span class="strong strong"><strong>Vega Debug</strong></span> from the <span class="strong strong"><strong>View</strong></span> dropdown.
</li>
<li class="listitem">
<p>From the dropdown, select <span class="strong strong"><strong>data_0</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_lite_tutorial_6.png" alt="Table for data_0 showing that the column time_buckets.buckets.key is undefined">
</div>
</div>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Vega-Lite</strong></span> is unable to extract the <code class="literal">time_buckets.buckets</code> inner array.</p>
<div class="position-relative"><h5><a id="_extract_the_time_buckets_buckets_inner_array"></a>Extract the <code class="literal">time_buckets.buckets</code> inner array</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>In Kibana 7.9 and later, use the <span class="strong strong"><strong>Vega-Lite</strong></span> <a href="https://vega.github.io/vega-lite/docs/flatten.html" class="ulink" target="_top">flatten transformation</a> to extract the <code class="literal">time_buckets.buckets</code> inner array.</p>
<p>If you are using Kibana 7.8 and earlier, the flatten transformation is available only in <span class="strong strong"><strong>Vega</strong></span>.</p>
<p>In the <span class="strong strong"><strong>Vega-Lite</strong></span> spec, add a <code class="literal">transform</code> block, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  transform: [{
    flatten: ["time_buckets.buckets"]
  }]</pre>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Inspect</strong></span>, then select <span class="strong strong"><strong>Vega Debug</strong></span> from the <span class="strong strong"><strong>View</strong></span> dropdown.
</li>
<li class="listitem">
<p>From the dropdown, select <span class="strong strong"><strong>data_0</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_lite_tutorial_7.png" alt="Table showing data_0 with multiple pages of results" width="but undefined values in the column time_buckets.buckets.key">
</div>
</div>
<p>Vega-Lite displays <span class="strong strong"><strong>undefined</strong></span> values because there are duplicate names.</p>
</li>
<li class="listitem">
To resolve the duplicate names, add the <code class="literal">transform</code> and <code class="literal">encoding</code> blocks, then click <span class="strong strong"><strong>Update</strong></span>:
</li>
</ol>
</div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  transform: [{
    flatten: ["time_buckets.buckets"],
    as: ["buckets"]
  }]

  mark: area

  encoding: {
    x: {
      field: buckets.key
      type: temporal
      axis: { title: null }
    }
    y: {
      field: buckets.doc_count
      type: quantitative
      axis: { title: "Document count" }
    }
    color: {
      field: key
      type: nominal
    }
  }</pre>
</div>
<div class="position-relative"><h5><a id="_add_hover_states_and_tooltips"></a>Add hover states and tooltips</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>With the <span class="strong strong"><strong>Vega-Lite</strong></span> spec, you can add hover states and tooltips to the stacked area chart with the <code class="literal">selection</code> block.</p>
<p>In the <span class="strong strong"><strong>Vega-Lite</strong></span> spec, add the <code class="literal">encoding</code> block, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  encoding: {
    tooltip: [{
      field: buckets.key
      type: temporal
      title: "Date"
    }, {
      field: key
      type: nominal
      title: "Category"
    }, {
      field: buckets.doc_count
      type: quantitative
      title: "Count"
    }]
  }</pre>
</div>
<p>When you hover over the area series on the stacked area chart, a multi-line tooltip
appears, but is unable to indicate the nearest point. To
indicate the nearest point, add a second layer.</p>
<p>Add composite marks, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  layer: [{
    mark: area
  }, {
    mark: point
  }]</pre>
</div>
<p>The points are unable to stack and align with the stacked area chart.</p>
<p>Change the y <code class="literal">encoding</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">    y: {
      field: buckets.doc_count
      type: quantitative
      axis: { title: "Document count" }
      stack: true
    }</pre>
</div>
<p>Add a <code class="literal">selection</code> block inside <code class="literal">mark: point</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  layer: [{
    mark: area
  }, {
    mark: point

    selection: {
      pointhover: {
        type: single
        on: mouseover
        clear: mouseout
        empty: none
        fields: ["buckets.key", "key"]
        nearest: true
      }
    }

    encoding: {
      size: {
        condition: {
          selection: pointhover
          value: 100
        }
        value: 5
      }
      fill: {
        condition: {
          selection: pointhover
          value: white
        }
      }
    }
  }]</pre>
</div>
<p>Move your cursor around the stacked area chart. The points are able to
indicate the nearest point.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_lite_tutorial_2.png" alt="Vega-Lite tutorial selection enabled">
</div>
</div>
<p>The selection is controlled by a signal. To view the signal, click <span class="strong strong"><strong>Inspect</strong></span> in the toolbar.</p>
<details>
<summary class="title">Expand final Vega-Lite spec</summary>
<div class="content">
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  $schema: https://vega.github.io/schema/vega-lite/v4.json
  title: Event counts from ecommerce
  data: {
    url: {
      %context%: true
      %timefield%: order_date
      index: kibana_sample_data_ecommerce
      body: {
        aggs: {
          categories: {
            terms: { field: "category.keyword" }
            aggs: {
              time_buckets: {
                date_histogram: {
                  field: order_date
                  interval: {%autointerval%: true}
                  extended_bounds: {
                    min: {%timefilter%: "min"}
                    max: {%timefilter%: "max"}
                  }
                  min_doc_count: 0
                }
              }
            }
          }
        }
        size: 0
      }
    }
    format: {property: "aggregations.categories.buckets" }
  }

  transform: [{
    flatten: ["time_buckets.buckets"]
    as: ["buckets"]
  }]

  encoding: {
    x: {
      field: buckets.key
      type: temporal
      axis: { title: null }
    }
    y: {
      field: buckets.doc_count
      type: quantitative
      axis: { title: "Document count" }
      stack: true
    }
    color: {
      field: key
      type: nominal
      title: "Category"
    }
    tooltip: [{
      field: buckets.key
      type: temporal
      title: "Date"
    }, {
      field: key
      type: nominal
      title: "Category"
    }, {
      field: buckets.doc_count
      type: quantitative
      title: "Count"
    }]
  }

  layer: [{
    mark: area
  }, {
    mark: point

    selection: {
      pointhover: {
        type: single
        on: mouseover
        clear: mouseout
        empty: none
        fields: ["buckets.key", "key"]
        nearest: true
      }
    }

    encoding: {
      size: {
        condition: {
          selection: pointhover
          value: 100
        }
        value: 5
      }
      fill: {
        condition: {
          selection: pointhover
          value: white
        }
      }
    }
  }]
}</pre>
</div>
</div>
</details>
<div class="position-relative"><h3><a id="vega-tutorial-update-kibana-filters-from-vega"></a>Tutorial: Update Kibana filters from Vega</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>To build an area chart using an Elasticsearch search query, edit the <span class="strong strong"><strong>Vega</strong></span> spec, then add click and drag handlers to update the Kibana filters.</p>
<p>In the <span class="strong strong"><strong>Vega</strong></span> spec, enter the following, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  $schema: "https://vega.github.io/schema/vega/v5.json"
  data: [{
    name: source_0
  }]

  scales: [{
    name: x
    type: time
    range: width
  }, {
    name: y
    type: linear
    range: height
  }]

  axes: [{
    orient: bottom
    scale: x
  }, {
    orient: left
    scale: y
  }]

  marks: [
    {
      type: area
      from: {
        data: source_0
      }
      encode: {
        update: {
        }
      }
    }
  ]
}</pre>
</div>
<p>Add the Elasticsearch search query with the <code class="literal">data</code> block, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  data: [
    {
      name: source_0
      url: {
        %context%: true
        %timefield%: order_date
        index: kibana_sample_data_ecommerce
        body: {
          aggs: {
            time_buckets: {
              date_histogram: {
                field: order_date
                fixed_interval: "3h"
                extended_bounds: {
                  min: {%timefilter%: "min"}
                  max: {%timefilter%: "max"}
                }
                min_doc_count: 0
              }
            }
          }
          size: 0
        }
      }
      format: { property: "aggregations.time_buckets.buckets" }
    }
  ]</pre>
</div>
<div class="position-relative"><h5><a id="_change_the_x_and_y_axes"></a>Change the x- and y-axes</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>Display labels for the x- and y-axes.</p>
<p>In the <span class="strong strong"><strong>Vega</strong></span> spec, add the <code class="literal">scales</code> block, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  scales: [{
    name: x
    type: time
    range: width
    domain: {
      data: source_0
      field: key
    }
  }, {
    name: y
    type: linear
    range: height
    domain: {
      data: source_0
      field: doc_count
    }
  }]</pre>
</div>
<p>Add the <code class="literal">key</code> and <code class="literal">doc_count</code> fields as the X- and Y-axis values, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  marks: [
    {
      type: area
      from: {
        data: source_0
      }
      encode: {
        update: {
          x: {
            scale: x
            field: key
          }
          y: {
            scale: y
            value: 0
          }
          y2: {
            scale: y
            field: doc_count
          }
        }
      }
    }
  ]</pre>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_tutorial_3.png" alt="vega tutorial 3">
</div>
</div>
<div class="position-relative"><h5><a id="_add_a_block_to_the_marks_section"></a>Add a block to the <code class="literal">marks</code> section</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>Show the clickable points on the area chart to filter for a specific date.</p>
<p>In the <span class="strong strong"><strong>Vega</strong></span> spec, add to the <code class="literal">marks</code> block, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  {
    name: point
    type: symbol
    style: ["point"]
    from: {
      data: source_0
    }
    encode: {
      update: {
        x: {
          scale: x
          field: key
        }
        y: {
          scale: y
          field: doc_count
        }
        size: {
          value: 100
        }
        fill: {
          value: black
        }
      }
    }
  }</pre>
</div>
<div class="position-relative"><h5><a id="_create_a_signal"></a>Create a signal</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>To make the points clickable, create a <span class="strong strong"><strong>Vega</strong></span> signal. You can access the clicked <code class="literal">datum</code> in the expression used to update.</p>
<p>In the <span class="strong strong"><strong>Vega</strong></span> spec, add a <code class="literal">signals</code> block to specify that the cursor clicks add a time filter with the three hour interval, then click <span class="strong strong"><strong>Update</strong></span>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  signals: [
    {
      name: point_click
      on: [{
        events: {
          source: scope
          type: click
          markname: point
        }
        update: '''kibanaSetTimeFilter(datum.key, datum.key + 3 * 60 * 60 * 1000)'''
      }]
    }
  ]</pre>
</div>
<p>The event uses the <code class="literal">kibanaSetTimeFilter</code> custom function to generate a filter that
applies to the entire dashboard on a click.</p>
<p>To make the area chart interactive, locate the <code class="literal">marks</code> block,
then update the <code class="literal">point</code> and add <code class="literal">cursor: { value: "pointer" }</code> to
<code class="literal">encoding</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  {
    name: point
    type: symbol
    style: ["point"]
    from: {
      data: source_0
    }
    encode: {
      update: {
        ...
        cursor: { value: "pointer" }
      }
    }
  }</pre>
</div>
<div class="position-relative"><h5><a id="_add_a_drag_interaction"></a>Add a drag interaction</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega.asciidoc">edit</a></div>
<p>To allow users to filter based on a time range, add a drag interaction, which requires additional signals and a rectangle overlay.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_tutorial_4.png" alt="vega tutorial 4">
</div>
</div>
<p>In the <span class="strong strong"><strong>Vega</strong></span> spec, add a <code class="literal">signal</code> to track the X position of the cursor:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">    {
      name: currentX
      value: -1
      on: [{
        events: {
          type: mousemove
          source: view
        },
        update: "clamp(x(), 0, width)"
      }, {
        events: {
          type: mouseout
          source: view
        }
        update: "-1"
      }]
    }</pre>
</div>
<p>To indicate the current cursor position, add a <code class="literal">mark</code> block:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">    {
      type: rule
      interactive: false
      encode: {
        update: {
          y: {value: 0}
          y2: {signal: "height"}
          stroke: {value: "gray"}
          strokeDash: {
            value: [2, 1]
          }
          x: {signal: "max(currentX,0)"}
          defined: {signal: "currentX &gt; 0"}
        }
      }
    }</pre>
</div>
<p>To track the selected time range, add a signal that updates
until the user releases their cursor or presses Return:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">    {
      name: selected
      value: [0, 0]
      on: [{
        events: {
          type: mousedown
          source: view
        }
        update: "[clamp(x(), 0, width), clamp(x(), 0, width)]"
      }, {
        events: {
          type: mousemove
          source: window
          consume: true
          between: [{
            type: mousedown
            source: view
          }, {
            merge: [{
              type: mouseup
              source: window
            }, {
              type: keydown
              source: window
              filter: "event.key === 'Escape'"
            }]
          }]
        }
        update: "[selected[0], clamp(x(), 0, width)]"
      }, {
        events: {
          type: keydown
          source: window
          filter: "event.key === 'Escape'"
        }
        update: "[0, 0]"
      }]
    }</pre>
</div>
<p>There is a signal that tracks the time range from the user.</p>
<p>To indicate the range visually, add a mark that only appears conditionally:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">    {
      type: rect
      name: selectedRect
      encode: {
        update: {
          height: {signal: "height"}
          fill: {value: "#333"}
          fillOpacity: {value: 0.2}
          x: {signal: "selected[0]"}
          x2: {signal: "selected[1]"}
          defined: {signal: "selected[0] !== selected[1]"}
        }
      }
    }</pre>
</div>
<p>Add a signal that updates the Kibana time filter when the cursor is released while
dragging:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">    {
      name: applyTimeFilter
      value: null
      on: [{
        events: {
          type: mouseup
          source: view
        }
        update: '''selected[0] !== selected[1] ? kibanaSetTimeFilter(
               invert('x',selected[0]),
               invert('x',selected[1])) : null'''
      }]
    }</pre>
</div>
<details>
<summary class="title">Expand final Vega spec</summary>
<div class="content">
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  $schema: "https://vega.github.io/schema/vega/v5.json"
  data: [
    {
      name: source_0
      url: {
        %context%: true
        %timefield%: order_date
        index: kibana_sample_data_ecommerce
        body: {
          aggs: {
            time_buckets: {
              date_histogram: {
                field: order_date
                fixed_interval: "3h"
                extended_bounds: {
                  min: {%timefilter%: "min"}
                  max: {%timefilter%: "max"}
                }
                min_doc_count: 0
              }
            }
          }
          size: 0
        }
      }
      format: { property: "aggregations.time_buckets.buckets" }
    }
  ]

  scales: [{
    name: x
    type: time
    range: width
    domain: {
      data: source_0
      field: key
    }
  }, {
    name: y
    type: linear
    range: height
    domain: {
      data: source_0
      field: doc_count
    }
  }]

  axes: [{
    orient: bottom
    scale: x
  }, {
    orient: left
    scale: y
  }]

  marks: [
    {
      type: area
      from: {
        data: source_0
      }
      encode: {
        update: {
          x: {
            scale: x
            field: key
          }
          y: {
            scale: y
            value: 0
          }
          y2: {
            scale: y
            field: doc_count
          }
        }
      }
    },
    {
      name: point
      type: symbol
      style: ["point"]
      from: {
        data: source_0
      }
      encode: {
        update: {
          x: {
            scale: x
            field: key
          }
          y: {
            scale: y
            field: doc_count
          }
          size: {
            value: 100
          }
          fill: {
            value: black
          }
          cursor: { value: "pointer" }
        }
      }
    },
    {
      type: rule
      interactive: false
      encode: {
        update: {
          y: {value: 0}
          y2: {signal: "height"}
          stroke: {value: "gray"}
          strokeDash: {
            value: [2, 1]
          }
          x: {signal: "max(currentX,0)"}
          defined: {signal: "currentX &gt; 0"}
        }
      }
    },
    {
      type: rect
      name: selectedRect
      encode: {
        update: {
          height: {signal: "height"}
          fill: {value: "#333"}
          fillOpacity: {value: 0.2}
          x: {signal: "selected[0]"}
          x2: {signal: "selected[1]"}
          defined: {signal: "selected[0] !== selected[1]"}
        }
      }
    }
  ]

  signals: [
    {
      name: point_click
      on: [{
        events: {
          source: scope
          type: click
          markname: point
        }
        update: '''kibanaSetTimeFilter(datum.key, datum.key + 3 * 60 * 60 * 1000)'''
      }]
    }
    {
      name: currentX
      value: -1
      on: [{
        events: {
          type: mousemove
          source: view
        },
        update: "clamp(x(), 0, width)"
      }, {
        events: {
          type: mouseout
          source: view
        }
        update: "-1"
      }]
    }
    {
      name: selected
      value: [0, 0]
      on: [{
        events: {
          type: mousedown
          source: view
        }
        update: "[clamp(x(), 0, width), clamp(x(), 0, width)]"
      }, {
        events: {
          type: mousemove
          source: window
          consume: true
          between: [{
            type: mousedown
            source: view
          }, {
            merge: [{
              type: mouseup
              source: window
            }, {
              type: keydown
              source: window
              filter: "event.key === 'Escape'"
            }]
          }]
        }
        update: "[selected[0], clamp(x(), 0, width)]"
      }, {
        events: {
          type: keydown
          source: window
          filter: "event.key === 'Escape'"
        }
        update: "[0, 0]"
      }]
    }
    {
      name: applyTimeFilter
      value: null
      on: [{
        events: {
          type: mouseup
          source: view
        }
        update: '''selected[0] !== selected[1] ? kibanaSetTimeFilter(
               invert('x',selected[0]),
               invert('x',selected[1])) : null'''
      }]
    }
  ]
}</pre>
</div>
</div>
</details>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="vega-reference"></a>Vega reference</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
</div></div></div>
<p>Learn more about Kibana extension, additional <span class="strong strong"><strong>Vega</strong></span> resources, and examples.</p>
<div class="position-relative"><h5><a id="reference-for-kibana-extensions"></a>Reference for Kibana extensions</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Kibana has extended Vega and Vega-Lite with extensions that support:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Automatic sizing
</li>
<li class="listitem">
Default theme to match Kibana
</li>
<li class="listitem">
Writing Elasticsearch queries using the time range and filters from dashboards
</li>
<li class="listitem">
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> Using the Elastic Map Service in Vega maps
</li>
<li class="listitem">
Additional tooltip styling
</li>
<li class="listitem">
Advanced setting to enable URL loading from any domain
</li>
<li class="listitem">
Debugging support using the Kibana inspector or browser console
</li>
<li class="listitem">
(Vega only) Expression functions which can update the time range and dashboard filters
</li>
</ul>
</div>
<div class="position-relative"><h6><a id="vega-sizing-and-positioning"></a>Automatic sizing</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Most users will want their Vega visualizations to take the full available space, so unlike
Vega examples, <code class="literal">width</code> and <code class="literal">height</code> are not required parameters in Kibana because your
spec will be merged with the default Kibana settings in most cases:</p>
<pre class="screen">autosize: {
  type: fit
  contains: padding
}
width: container
height: container</pre>
<p>These default settings are <span class="strong strong"><strong>not</strong></span> applied if:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="vega.html#vega-with-a-map" title="Vega with a Map">Your spec uses <code class="literal">type=map</code></a>
</li>
<li class="listitem">
Your spec is Vega-Lite and contains a facet, row, column, repeat, or concat operator. In these
cases, providing <code class="literal">width</code> and <code class="literal">height</code> will affect the child size.
</li>
</ul>
</div>
<p>To set the width or height manually, set <code class="literal">autosize: none</code> and provide the exact pixel sizes, including
padding for the title, legend and axes.</p>
<pre class="screen">autosize: none
width: 600
height: 200
padding: {
  top: 20
  bottom: 20
  left: 55
  right: 150
}</pre>
<p>To learn more, read about
<a href="https://vega.github.io/vega/docs/specification/#autosize" class="ulink" target="_top">Vega autosize</a>
and <a href="https://vega.github.io/vega-lite/docs/size.html" class="ulink" target="_top">Vega-Lite autosize</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Autosize in Vega-Lite has <a href="https://vega.github.io/vega-lite/docs/size.html#limitations" class="ulink" target="_top">several limitations</a>
which can affect the height and width of your visualization, but these limitations do not exist in Vega.
If you need full control, convert your spec to Vega using the <a class="xref" href="vega.html#vega-browser-debugging-console" title="Browser debugging console">browser console</a>
<code class="literal">VEGA_DEBUG.vega_spec</code> output.
To disable these warnings, you can <a class="xref" href="vega.html#vega-additional-configuration-options" title="Additional configuration options">add extra options to your spec</a>.</p>
</div>
</div>
<div class="position-relative"><h6><a id="vega-theme"></a>Default theme to match Kibana</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Kibana registers a default <a href="https://vega.github.io/vega/docs/schemes/" class="ulink" target="_top">Vega color scheme</a>
with the id <code class="literal">elastic</code>, and sets a default color for each <code class="literal">mark</code> type.
Override it by providing a different <code class="literal">stroke</code>, <code class="literal">fill</code>, or <code class="literal">color</code> (Vega-Lite) value.</p>
<div class="position-relative"><h6><a id="vega-queries"></a>Writing Elasticsearch queries in Vega</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Kibana extends the Vega <a href="https://vega.github.io/vega/docs/data/" class="ulink" target="_top">data</a> elements
with support for direct Elasticsearch queries specified as <code class="literal">url</code>.</p>
<p>Kibana is <span class="strong strong"><strong>unable to support dynamically loaded data</strong></span>,
which would otherwise work in Vega. All data is fetched before it&#8217;s passed to
the Vega renderer.</p>
<p>To define an Elasticsearch query in Vega, set the <code class="literal">url</code> to an object. Kibana parses
the object looking for special tokens that allow your query to integrate with Kibana.</p>
<p>Tokens include the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">%context%: true</code>: Set at the top level, and replaces the <code class="literal">query</code> section with filters from dashboard
</li>
<li class="listitem">
<code class="literal">%timefield%: &lt;name&gt;</code>: Set at the top level, integrates the query with the dashboard time filter
</li>
<li class="listitem">
<code class="literal">{%timefilter%: true}</code>: Replaced by an Elasticsearch range query with upper and lower bounds
</li>
<li class="listitem">
<code class="literal">{%timefilter%: "min" | "max"}</code>: Replaced only by the upper or lower bounds
</li>
<li class="listitem">
<code class="literal">{%timefilter: true, shift: -1, unit: 'hour'}</code>: Generates a time range query one hour in the past
</li>
<li class="listitem">
<code class="literal">{%autointerval%: true}</code>: Replaced by the string which contains the automatic Kibana time interval, such as <code class="literal">1h</code>
</li>
<li class="listitem">
<code class="literal">{%autointerval%: 10}</code>: Replaced by a string which is approximately dividing the time into 10 ranges, allowing
you to influence the automatic interval
</li>
<li class="listitem">
<code class="literal">"%dashboard_context-must_clause%"</code>: String replaced by object containing filters
</li>
<li class="listitem">
<code class="literal">"%dashboard_context-filter_clause%"</code>: String replaced by an object containing filters
</li>
<li class="listitem">
<code class="literal">"%dashboard_context-must_not_clause%"</code>: String replaced by an object containing filters
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Vega supports the <code class="literal">interval</code> parameter, which is unsupported Elasticsearch 8.0.0 and later. To use intervals, use <code class="literal">fixed_interval</code> or <code class="literal">calendar_interval</code> instead.</p>
</div>
</div>
<p>For example, the following query counts the number of documents in a specific index:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">// An object instead of a string for the URL value
// is treated as a context-aware Elasticsearch query.
url: {
  // Specify the time filter.
  %timefield%: @timestamp
  // Apply dashboard context filters when set
  %context%: true

  // Which indexes to search
  index: kibana_sample_data_logs
  // The body element may contain "aggs" and "query" keys
  body: {
    aggs: {
      time_buckets: {
        date_histogram: {
          // Use date histogram aggregation on @timestamp field
          field: @timestamp <a id="CO25-1"></a><i class="conum" data-value="1"></i>
          // interval value will depend on the time filter
          // Use an integer to set approximate bucket count
          interval: { %autointerval%: true }
          // Make sure we get an entire range, even if it has no data
          extended_bounds: {
            min: { %timefilter%: "min" }
            max: { %timefilter%: "max" }
          }
          // Use this for linear (e.g. line, area) graphs
          // Without it, empty buckets will not show up
          min_doc_count: 0
        }
      }
    }
    // Speed up the response by only including aggregation results
    size: 0
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO25-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">@timestamp</code> &mdash; Filters the time range and breaks it into histogram
buckets.</p>
</td>
</tr>
</table>
</div>
<p>The full result includes the following structure:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  "aggregations": {
    "time_buckets": {
      "buckets": [{
          "key_as_string": "2015-11-30T22:00:00.000Z",
          "key": 1448920800000,<a id="CO26-1"></a><i class="conum" data-value="1"></i>
          "doc_count": 28
        }, {
          "key_as_string": "2015-11-30T23:00:00.000Z",
          "key": 1448924400000, <a id="CO26-2"></a><i class="conum" data-value="1"></i>
          "doc_count": 330
        }, ...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-1"><i class="conum" data-value="1"></i></a><a href="#CO26-2"></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">"key"</code> &mdash; The unix timestamp you can use without conversions by the
Vega date expressions.</p>
</td>
</tr>
</table>
</div>
<p>For most visualizations, you only need the list of bucket values. To focus on
only the data you need, use <code class="literal">format: {property: "aggregations.time_buckets.buckets"}</code>.</p>
<p>Specify a query with individual range and dashboard context. The query is
equivalent to <code class="literal">"%context%": true, "%timefield%": "@timestamp"</code>,
except that the time range is shifted back by 10 minutes:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  body: {
    query: {
      bool: {
        must: [
          // This string will be replaced
          // with the auto-generated "MUST" clause
          "%dashboard_context-must_clause%"
          {
            range: {
              // apply timefilter (upper right corner)
              // to the @timestamp variable
              @timestamp: {
                // "%timefilter%" will be replaced with
                // the current values of the time filter
                // (from the upper right corner)
                "%timefilter%": true
                // Only work with %timefilter%
                // Shift current timefilter by 10 units back
                shift: 10
                // week, day (default), hour, minute, second
                unit: minute
              }
            }
          }
        ]
        must_not: [
          // This string will be replaced with
          // the auto-generated "MUST-NOT" clause
          "%dashboard_context-must_not_clause%"
        ]
        filter: [
          // This string will be replaced
          // with the auto-generated "FILTER" clause
          "%dashboard_context-filter_clause%"
        ]
      }
    }
  }
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When using <code class="literal">"%context%": true</code> or defining a value for <code class="literal">"%timefield%"</code> the body cannot contain a query. To customize the query within the VEGA specification (e.g. add an additional filter, or shift the timefilter), define your query and use the placeholders as in the example above. The placeholders will be replaced by the actual context of the dashboard or visualization once parsed.</p>
</div>
</div>
<p>The <code class="literal">"%timefilter%"</code> can also be used to specify a single min or max
value. The date_histogram&#8217;s <code class="literal">extended_bounds</code> can be set
with two values - min and max. Instead of hardcoding a value, you may
use <code class="literal">"min": {"%timefilter%": "min"}</code>, which will be replaced with the
beginning of the current time range. The <code class="literal">shift</code> and <code class="literal">unit</code> values are
also supported. The <code class="literal">"interval"</code> can also be set dynamically, depending
on the currently picked range: <code class="literal">"interval": {"%autointerval%": 10}</code> will
try to get about 10-15 data points (buckets).</p>
<div class="position-relative"><h5><a id="vega-esmfiles"></a>Access Elastic Map Service files</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> Access the Elastic Map Service files via the same mechanism:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">url: {
  // "type" defaults to "elasticsearch" otherwise
  %type%: emsfile
  // Name of the file, exactly as in https://maps.elastic.co
  name: World Countries
}
// The result is either a topojson file or a geojson file.
// Refer to the Default format for the file at https://maps.elastic.co
// Get its features to use this data source with the "shape" marks
// https://vega.github.io/vega/docs/marks/shape/
// For a topojson file use
format: {type: "topojson", feature: "data"}

// For a geojson file use
format: {property: "features"}</pre>
</div>
<div class="position-relative"><h4><a id="vega-with-a-map"></a>Vega with a Map</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> To enable <span class="strong strong"><strong>Maps</strong></span>, the graph must specify <code class="literal">type=map</code> in the host configuration:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  "config": {
    "kibana": {
      "type": "map",

      // Initial map position
      "latitude": 40.7,   // default 0
      "longitude": -74,   // default 0
      "zoom": 7,          // default 2

      // Defaults to 'true', disables the base map layer.
      "mapStyle": false,

      // When 'mapStyle' is 'undefined' or 'true', sets the EMS-layer for the map.
      // May either be: "road_map", "road_map_desaturated", "dark_map".
      // If 'emsTileServiceId' is 'undefined', it falls back to the auto-switch-dark-light behavior.
      "emsTileServiceId": "road_map",

      // default 0
      "minZoom": 5,

      // defaults to the maximum for the given style,
      // or 25 when base is disabled
      "maxZoom": 13,

      // Defaults to 'true', shows +/- buttons to zoom in/out
      "zoomControl": false,

      // Defaults to 'false', disables mouse wheel zoom. If set to
      // 'true', map may zoom unexpectedly while scrolling dashboard
      "scrollWheelZoom": false,

      // When false, repaints on each move frame.
      // Makes the graph slower when moving the map
      "delayRepaint": true, // default true
    }
  },
  /* the rest of Vega JSON */
}</pre>
</div>
<p>The visualization automatically injects a <code class="literal">"projection"</code>, which you can use to
calculate the position of all geo-aware marks.
Additionally, you can use <code class="literal">latitude</code>, <code class="literal">longitude</code>, and <code class="literal">zoom</code> signals.
These signals can be used in the graph, or can be updated to modify the
position of the map.</p>
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> You can use the <span class="strong strong"><strong>Vega</strong></span> <a href="https://vega.github.io/vega/docs/data/" class="ulink" target="_top">data</a> element to access <a href="https://www.elastic.co/elastic-maps-service" class="ulink" target="_top">Elastic Maps Service (EMS)</a> vector shapes of administrative boundaries in your Vega map by setting <code class="literal">url.data</code> to <code class="literal">emsFile</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  "data": [
    {
      "name": "countries",
      "url": {
        // "type" defaults to "elasticsearch" otherwise
        %type%: emsfile
        // Name of the file, exactly as in the Region map visualization
        name: World Countries
      },
      // The result is a topojson file, get its features to use
      // this data source with the "shape" marks
      // https://vega.github.io/vega/docs/marks/shape/
      "format": {"type": "topojson", "feature": "data"},
    }
  ],
  "marks": [
    {
      "type": "shape",
      "from": {"data": "countries"},
      "transform": [{"type": "geoshape", "projection": "projection"}]
    }
  ]</pre>
</div>
<div class="position-relative"><h6><a id="vega-tooltip"></a>Additional tooltip styling</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Kibana has installed the <a href="https://vega.github.io/vega-lite/docs/tooltip.html" class="ulink" target="_top">Vega tooltip plugin</a>,
so tooltips can be defined in the ways documented there. Beyond that, Kibana also supports
a configuration option for changing the tooltip position and padding:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
  config: {
    kibana: {
      tooltips: {
        position: 'top',
        padding: 15,
        textTruncate: true,
      }
    }
  }
}</pre>
</div>
<div class="position-relative"><h6><a id="vega-url-loading"></a>Enable URL loading from any domain</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Vega</strong></span> can load data from any URL. To enable, set <code class="literal">vis_type_vega.enableExternalUrls: true</code> in <code class="literal">kibana.yml</code>,
then restart Kibana.</p>
<p>The files that the external URLs load must allow <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" class="ulink" target="_top">CORS</a>.
The remote URL must include <code class="literal">Access-Control-Allow-Origin</code>, which allows requests from the Kibana URL.</p>
<p>You can make the current time range part of the external as a millisecond timestamp by using the placeholders <code class="literal">%timefilter_min%</code> and <code class="literal">%timefilter_max%</code>, e.g. <code class="literal">http://example.com?min=%timefilter_min%</code>.</p>
<div class="position-relative"><h6><a id="vega-inspector"></a>Vega Inspector</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Use the contextual <span class="strong strong"><strong>Inspect</strong></span> tool to gain insights into different elements.</p>
<div class="position-relative"><h6><a id="inspect-elasticsearch-requests"></a>Inspect Elasticsearch requests</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Vega</strong></span> uses the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-search.html" class="ulink" target="_top">Elasticsearch search API</a> to get documents and aggregation
results from Elasticsearch. To troubleshoot these requests, click <span class="strong strong"><strong>Inspect</strong></span>, which shows the most recent requests.
In case your specification has more than one request, you can switch between the views using the <span class="strong strong"><strong>View</strong></span> dropdown.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_tutorial_inspect_requests.png" alt="vega tutorial inspect requests">
</div>
</div>
<div class="position-relative"><h5><a id="vega-debugging"></a>Vega debugging</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>With the <span class="strong strong"><strong>Vega debug</strong></span> view, you can inspect the <span class="strong strong"><strong>Data sets</strong></span> and <span class="strong strong"><strong>Signal Values</strong></span> runtime data.</p>
<p>The runtime data is read from the
<a href="https://vega.github.io/vega/docs/api/debugging/#scope" class="ulink" target="_top">runtime scope</a>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_tutorial_inspect_data_sets.png" alt="vega tutorial inspect data sets">
</div>
</div>
<p>To debug more complex specs, access to the <code class="literal">view</code> variable.  For more information, refer to
the <a class="xref" href="vega.html#vega-browser-debugging-console" title="Browser debugging console">Vega browser debugging process</a>.</p>
<div class="position-relative"><h6><a id="asking-for-help-with-a-vega-spec"></a>Asking for help with a Vega spec</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Because of the dynamic nature of the data in Elasticsearch, it is hard to help you with
<span class="strong strong"><strong>Vega</strong></span> specs unless you can share a dataset. To do this, click <span class="strong strong"><strong>Inspect</strong></span>, select the <span class="strong strong"><strong>Vega debug</strong></span> view,
then select <span class="strong strong"><strong>Spec</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/vega_tutorial_getting_help.png" alt="vega tutorial getting help">
</div>
</div>
<p>To copy the response, click <span class="strong strong"><strong>Copy to clipboard</strong></span>. Paste the copied data to
<a href="https://gist.github.com/" class="ulink" target="_top">gist.github.com</a>, possibly with a .json extension. Use the [raw] button,
and share that when asking for help.</p>
<div class="position-relative"><h5><a id="vega-browser-debugging-console"></a>Browser debugging console</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> Use browser debugging tools (for example, F12 or Ctrl+Shift+J in Chrome) to
inspect the <code class="literal">VEGA_DEBUG</code> variable:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">view</code> &mdash; Access to the Vega View object. See <a href="https://vega.github.io/vega/docs/api/debugging/" class="ulink" target="_top">Vega Debugging Guide</a>
on how to inspect data and signals at runtime. For Vega-Lite,
<code class="literal">VEGA_DEBUG.view.data('source_0')</code> gets the pre-transformed data, and <code class="literal">VEGA_DEBUG.view.data('data_0')</code>
gets the encoded data. For Vega, it uses the data name as defined in your Vega spec.
</li>
<li class="listitem">
<code class="literal">vega_spec</code> &mdash; Vega JSON graph specification after some modifications by Kibana. In case
of Vega-Lite, this is the output of the Vega-Lite compiler.
</li>
<li class="listitem">
<code class="literal">vegalite_spec</code> &mdash; If this is a Vega-Lite graph, JSON specification of the graph before
Vega-Lite compilation.
</li>
</ul>
</div>
<div class="position-relative"><h5><a id="vega-expression-functions"></a>(Vega only) Expression functions which can update the time range and dashboard filters</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>Kibana has extended the Vega expression language with these functions.
These functions will trigger new data to be fetched, which by default will reset Vega signals.
To keep signal values set <code class="literal">restoreSignalValuesOnRefresh: true</code> in the Vega config.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">/**
  * @param {object} query Elastic Query DSL snippet, as used in the query DSL editor
  * @param {string} [index] as defined in Kibana, or default if missing
  * @param {string} Custom label of the filter shown in the filter bar
  */
kibanaAddFilter(query, index, alias)

/**
  * @param {object} query Elastic Query DSL snippet, as used in the query DSL editor
  * @param {string} [index] as defined in Kibana, or default if missing
  */
kibanaRemoveFilter(query, index)

kibanaRemoveAllFilters()

/**
  * Update dashboard time filter to the new values
  * @param {number|string|Date} start
  * @param {number|string|Date} end
  */
kibanaSetTimeFilter(start, end)</pre>
</div>
<div class="position-relative"><h5><a id="vega-additional-configuration-options"></a>Additional configuration options</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">{
  config: {
    kibana: {
      // Placement of the Vega-defined signal bindings.
      // Can be `left`, `right`, `top`, or `bottom` (default).
      controlsLocation: top
      // Can be `vertical` or `horizontal` (default).
      controlsDirection: vertical
      // If true, hides most of Vega and Vega-Lite warnings
      hideWarnings: true
      // Vega renderer to use: `svg` or `canvas` (default)
      renderer: canvas
      // Defaults to 'false', restores Vega signal values on refresh
      restoreSignalValuesOnRefresh: false
    }
  }
}</pre>
</div>
<div class="position-relative"><h4><a id="resources-and-examples"></a>Resources and examples</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>To learn more about Vega and Vega-Lite, refer to the resources and examples.</p>
<div class="position-relative"><h5><a id="vega-editor"></a>Vega editor</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<p>The <a href="https://vega.github.io/editor/" class="ulink" target="_top">Vega Editor</a> includes examples for Vega &amp; Vega-Lite, but does not support any
Kibana-specific features like Elasticsearch requests and interactive base maps.</p>
<div class="position-relative"><h5><a id="vega-lite-resources"></a>Vega-Lite resources</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://vega.github.io/vega-lite/tutorials/getting_started.html" class="ulink" target="_top">Tutorials</a>
</li>
<li class="listitem">
<a href="https://vega.github.io/vega-lite/docs/" class="ulink" target="_top">Docs</a>
</li>
<li class="listitem">
<a href="https://vega.github.io/vega-lite/examples/" class="ulink" target="_top">Examples</a>
</li>
</ul>
</div>
<div class="position-relative"><h5><a id="vega-resources"></a>Vega resources</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/dashboard/vega-reference.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://vega.github.io/vega/tutorials/" class="ulink" target="_top">Tutorials</a>
</li>
<li class="listitem">
<a href="https://vega.github.io/vega/docs/" class="ulink" target="_top">Docs</a>
</li>
<li class="listitem">
<a href="https://vega.github.io/vega/examples/" class="ulink" target="_top">Examples</a>
</li>
</ul>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you use the examples in Kibana, you may
need to modify the "data" section to use absolute URL. For example,
replace <code class="literal">"url": "data/world-110m.json"</code> with
<code class="literal">"url": "https://vega.github.io/editor/data/world-110m.json"</code>.</p>
</div>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="tsvb.html">« TSVB</a>
</span>
<span class="next">
<a href="add-aggregation-based-visualization-panels.html">Aggregation-based »</a>
</span>
</div>
</body>
</html>
