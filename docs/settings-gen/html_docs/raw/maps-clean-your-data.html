<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Clean your data | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Clean your data | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="import-geospatial-data.html" title="Import geospatial data"/>
<link rel="prev" href="import-geospatial-data.html" title="Import geospatial data"/>
<link rel="next" href="indexing-geojson-data-tutorial.html" title="Tutorial: Index GeoJSON data"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="import-geospatial-data.html">« Import geospatial data</a>
</span>
<span class="next">
<a href="indexing-geojson-data-tutorial.html">Tutorial: Index GeoJSON data »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="maps.html">Maps</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="import-geospatial-data.html">Import geospatial data</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Clean your data</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="maps-clean-your-data"></a>Clean your data</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
</div></div></div>
<p>Geospatial fields in Elasticsearch have certain restrictions that need to be addressed before upload. On this section a few recipes will be presented to help troubleshooting common issues on this type of data.</p>
<div class="position-relative"><h4><a id="_convert_to_geojson_or_shapefile"></a>Convert to GeoJSON or Shapefile</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p>Use <a href="https://gdal.org/programs/ogr2ogr.html" class="ulink" target="_top">ogr2ogr</a> (part of the <a href="https://gdal.org" class="ulink" target="_top">GDAL/OGR</a> suite) to convert datasets into a GeoJSON or Esri Shapefile. For example, use the following commands to convert a GPX file into JSON:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh"># Example GPX file from https://www.topografix.com/gpx_sample_files.asp
#
# Convert the GPX waypoints layer into a GeoJSON file
$ ogr2ogr \
  -f GeoJSON "waypoints.geo.json" \ # Output format and file name
  "fells_loop.gpx" \ # Input File Name
  "waypoints" # Input Layer (usually same as file name)

# Extract the routes layer into a GeoJSON file
$ ogr2ogr -f "GeoJSON" "routes.geo.json" "fells_loop.gpx" "routes"</pre>
</div>
<div class="position-relative"><h4><a id="_convert_to_wgs84_coordinate_reference_system"></a>Convert to WGS84 Coordinate Reference System</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p>Elasticsearch only supports WGS84 Coordinate Reference System. Use <code class="literal">ogr2ogr</code> to convert from other coordinate systems to WGS84.</p>
<p>On the following example, <code class="literal">ogr2ogr</code> transforms a shapefile from <a href="https://epsg.org/crs_4269/NAD83.html" class="ulink" target="_top">NAD83</a> to <a href="https://epsg.org/crs_4326/WGS-84.html" class="ulink" target="_top">WGS84</a>. The input CRS is detected automatically thanks to the <code class="literal">.prj</code> sidecar file in the source dataset.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh"># Example NAD83 file from https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_5m.zip
#
# Convert the Census Counties shapefile to WGS84 (EPSG:4326)
$ ogr2ogr -f "Esri Shapefile" \
  "cb_2018_us_county_5m.4326.shp" \ # Output file
  -t_srs "EPSG:4326" \ # EPSG:4326 is the code for WGS84
  "cb_2018_us_county_5m.shp" \ # Input file
  "cb_2018_us_county_5m" # Input layer</pre>
</div>
<div class="position-relative"><h4><a id="_improve_performance_by_breaking_out_complex_geometries_into_one_geometry_per_document"></a>Improve performance by breaking out complex geometries into one geometry per document</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p>Sometimes geospatial datasets are composed by a small amount of geometries that contain a very large amount of individual part geometries. A good example of this situation is on detailed world country boundaries datasets where records for countries like Canada or Philippines have hundreds of small island geometries. Depending on the final usage of a dataset, you may want to break out this type of dataset to keep one geometry per document, considerably increasing the performance of your index.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh"># Example NAD83 file from www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/ler_000b16a_e.zip
#
# Check the number of input features
$ ogrinfo -summary ler_000b16a_e.shp ler_000b16a_e \
  | grep "Feature Count"
Feature Count: 76

# Convert to WGS84 exploding the multiple geometries
$ ogr2ogr \
  -f "Esri Shapefile" \
  "ler_000b16a_e.4326-parts.shp" \ # Output file
  -explodecollections \ # Convert multiparts into single records
  -t_srs "EPSG:4326" \ # Transform to WGS84
  "ler_000b16a_e.shp" \ # Input file
  "ler_000b16a_e" # Input layer

# Check the number of geometries in the output file
# to confirm the 76 records are exploded into 27 thousand rows
$ ogrinfo -summary ler_000b16a_e.4326-parts.shp ler_000b16a_e.4326 \
  | grep "Feature Count"
Feature Count: 27059</pre>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>A dataset containing records with a very large amount of parts as the one from the example above may even hang in Kibana Maps file uploader.</p>
</div>
</div>
<div class="position-relative"><h4><a id="_reduce_the_precision"></a>Reduce the precision</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p>Some machine generated datasets are stored with more decimals than are strictly necessary. For reference, the GeoJSON RFC 7946 <a href="https://datatracker.ietf.org/doc/html/rfc7946#section-11.2" class="ulink" target="_top">coordinate precision section</a> specifies six digits to be a common default to around 10 centimeters on the ground. The file uploader in the Maps application will automatically reduce the precision to 6 decimals but for big datasets it is better to do this before uploading.</p>
<p><code class="literal">ogr2ogr</code> generates GeoJSON files with 7 decimal degrees when requesting <code class="literal">RFC7946</code> compliant files but using the <code class="literal">COORDINATE_PRECISION</code> <a href="https://gdal.org/drivers/vector/geojson.html#layer-creation-options" class="ulink" target="_top">GeoJSON layer creation option</a> it can be downsized even more if that is OK for the usage of the data.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh"># Example NAD83 file from https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_5m.zip
#
# Generate a 2008 GeoJSON file
$ ogr2ogr \
  -f GeoJSON \
  "cb_2018_us_county_5m.4326.geo.json" \ # Output file
  -t_srs "EPSG:4326" \ # Convert to WGS84
  -lco "RFC7946=NO" \ # Request a 2008 GeoJSON file
  "cb_2018_us_county_5m.shp" \
  "cb_2018_us_county_5m"

# Generate a RFC7946 GeoJSON file
$ ogr2ogr \
  -f GeoJSON \
  "cb_2018_us_county_5m.4326.RFC7946.geo.json" \ # Output file
  -t_srs "EPSG:4326" \ # Convert to WGS84
  -lco "RFC7946=YES" \ # Request a RFC7946 GeoJSON file
  "cb_2018_us_county_5m.shp" \
  "cb_2018_us_county_5m"

# Generate a RFC7946 GeoJSON file with just 5 decimal figures
$ ogr2ogr \
  -f GeoJSON \
  "cb_2018_us_county_5m.4326.RFC7946_mini.geo.json" \ # Output file
  -t_srs "EPSG:4326" \  # Convert to WGS84
  -lco "RFC7946=YES" \ # Request a RFC7946 GeoJSON file
  -lco "COORDINATE_PRECISION=5" \ # Downsize to just 5 decimal positions
  "cb_2018_us_county_5m.shp" \
  "cb_2018_us_county_5m"

# Compare the disk size of the three output files
$ du -h cb_2018_us_county_5m.4326*.geo.json
7,4M	cb_2018_us_county_5m.4326.geo.json
6,7M	cb_2018_us_county_5m.4326.RFC7946.geo.json
6,1M	cb_2018_us_county_5m.4326.RFC7946_mini.geo.json</pre>
</div>
<div class="position-relative"><h4><a id="_simplifying_region_datasets"></a>Simplifying region datasets</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p>Region datasets are polygon datasets where the boundaries of the documents don&#8217;t overlap. This is common for administrative boundaries, land usage, and other continuous datasets. This type of datasets has the special feature that any geospatial operation modifying the lines of the polygons needs to be applied in the same way to the common sides of the polygons to avoid the generation of thin gap and overlap artifacts.</p>
<p><a href="https://github.com/mbloch/mapshaper" class="ulink" target="_top"><code class="literal">mapshaper</code></a> is an excellent tool to work with this type of datasets as it understands datasets of this nature and works with them accordingly.</p>
<p>Depending on the usage of a region dataset, different geospatial precisions may be adequate. A world countries dataset that is displayed for the entire planet does not need the same precision as a map of the countries in the South Asian continent.</p>
<p><code class="literal">mapshaper</code> offers a <a href="https://github.com/mbloch/mapshaper/wiki/Command-Reference#-simplify" class="ulink" target="_top"><code class="literal">simplify</code></a> command that accepts percentages, resolutions, and different simplification algorithms.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh"># Example NAD83 file from https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_5m.zip
#
# Generate a baseline GeoJSON file from OGR
$ ogr2ogr \
  -f GeoJSON "cb_2018_us_county_5m.ogr.geo.json" \
  -t_srs "EPSG:4326" \
  -lco RFC7946=YES \
  "cb_2018_us_county_5m.shp" \
  "cb_2018_us_county_5m"

# Simplify at different percentages with mapshaper
$ for pct in 10 50 75 99; do \
  mapshaper \
    -i "cb_2018_us_county_5m.shp" \ # Input file
    -proj "EPSG:4326" \ # Output projection
    -simplify "${pct}%" \ # Simplification
    -o cb_2018_us_county_5m.mapshaper_${pct}.geo.json; \ # Output file
  done

# Compare the size of the output files
$ du -h cb_2018_us_county_5m*.geo.json
2,0M	cb_2018_us_county_5m.mapshaper_10.geo.json
4,1M	cb_2018_us_county_5m.mapshaper_50.geo.json
5,3M	cb_2018_us_county_5m.mapshaper_75.geo.json
6,7M	cb_2018_us_county_5m.mapshaper_99.geo.json
6,7M	cb_2018_us_county_5m.ogr.geo.json</pre>
</div>
<div class="position-relative"><h4><a id="_fixing_incorrect_geometries"></a>Fixing incorrect geometries</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p>The Maps application expects valid GeoJSON or Shapefile datasets. Apart from the mentioned CRS requirement, geometries need to be valid. Both <code class="literal">ogr2ogr</code> and <code class="literal">mapshaper</code> have options to try to fix invalid geometries:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
OGR <a href="https://gdal.org/programs/ogr2ogr.html#cmdoption-ogr2ogr-makevalid" class="ulink" target="_top"><code class="literal">-makevalid</code></a> option
</li>
<li class="listitem">
Mapshaper <a href="https://github.com/mbloch/mapshaper/wiki/Command-Reference#-clean" class="ulink" target="_top"><code class="literal">-clean</code></a> command
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="_and_so_much_more"></a>And so much more</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/maps/clean-data.asciidoc">edit</a></div>
<p><code class="literal">ogr2ogr</code> and <code class="literal">mapshaper</code> are excellent geospatial ETL (Extract Transform and Load) utilities that can do much more than viewed here. Reading the documentation in detail is worth investment to improve the quality of the datasets by removing unwanted fields, refining data types, validating value domains, etc. Finally, being command line utilities, both can be automated and added to QA pipelines.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="import-geospatial-data.html">« Import geospatial data</a>
</span>
<span class="next">
<a href="indexing-geojson-data-tutorial.html">Tutorial: Index GeoJSON data »</a>
</span>
</div>
</body>
</html>
