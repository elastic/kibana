<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="Kibana diagnostic, diagnostics">
<title>Typescript | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Typescript | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="development-best-practices.html" title="Best practices"/>
<link rel="prev" href="security-best-practices.html" title="Security best practices"/>
<link rel="next" href="kibana-architecture.html" title="Architecture"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="security-best-practices.html">« Security best practices</a>
</span>
<span class="next">
<a href="kibana-architecture.html">Architecture »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="development.html">Developer guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="development-best-practices.html">Best practices</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Typescript</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/developer/best-practices/typescript.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="typescript"></a>Typescript</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/developer/best-practices/typescript.asciidoc">edit</a></div>
</div></div></div>
<p>Although this is not a requirement, we encourage if all new code is developed in <a href="https://www.typescriptlang.org/" class="ulink" target="_top">Typescript</a>.</p>
<div class="position-relative"><h4><a id="_project_references"></a>Project references</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/developer/best-practices/typescript.asciidoc">edit</a></div>
<p>Kibana has crossed the 2m LoC mark. The current situation creates some scaling problems when the default out-of-the-box setup stops working. As a result, developers suffer from slow project compilation and IDE unresponsiveness. As a part of <a href="https://github.com/elastic/kibana/projects/63" class="ulink" target="_top">Developer Experience project</a>, we are migrating our tooling to use built-in TypeScript features addressing the scaling problems - <a href="https://www.typescriptlang.org/docs/handbook/project-references.html" class="ulink" target="_top">project references</a> &amp; <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-4.html#faster-subsequent-builds-with-the---incremental-flag" class="ulink" target="_top">incremental builds</a></p>
<p>In a nutshell - instead of compiling the whole Kibana codebase at once, this setup enforces splitting the code base into independent projects that form a directed acyclic graph (DAG). This allows the TypeScript compiler (<code class="literal">tsc</code>) to apply several advanced optimizations:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Every project emits <code class="literal">public</code> interfaces in the form of <code class="literal">d.ts</code> type declarations generated by the TypeScript compiler
</li>
<li class="listitem">
These generated <code class="literal">d.ts</code> type declarations are used whenever a referenced project is imported in a depending project
</li>
<li class="listitem">
This makes it possible to determine which project needs rebuilding when the source code has changed to use a more aggressive caching strategy.
</li>
</ul>
</div>
<p>More details are available in the <a href="https://www.typescriptlang.org/docs/handbook/project-references.html" class="ulink" target="_top">official docs</a></p>
<div class="position-relative"><h5><a id="_caveats"></a>Caveats</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/developer/best-practices/typescript.asciidoc">edit</a></div>
<p>This architecture imposes several limitations to which we must comply:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Projects cannot have circular dependencies. Even though the Kibana platform doesn&#8217;t support circular dependencies between Kibana plugins, TypeScript (and ES6 modules) does allow circular imports between files. So in theory, you may face a problem when migrating to the TS project references and you will have to resolve this circular dependency. We&#8217;ve built a tool that can be used to find such problems. Please read the prerequisites section below to know how to use it.
</li>
<li class="listitem">
<p>A project must emit its type declaration. It&#8217;s not always possible to generate a type declaration if the compiler cannot infer a type. There are two basic cases:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Your plugin exports a type inferring an internal type declared in Kibana codebase. In this case, you&#8217;ll have to either export an internal type or to declare an exported type explicitly.
</li>
<li class="listitem">
Your plugin exports something inferring a type from a 3rd party library that doesn&#8217;t export this type. To fix the problem, you have to declare the exported type manually.
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="position-relative"><h5><a id="_prerequisites_18"></a>Prerequisites</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/developer/best-practices/typescript.asciidoc">edit</a></div>
<p>Since project refs rely on generated <code class="literal">d.ts</code> files, the migration order does matter. You can migrate your plugin only when all the plugin dependencies already have migrated. It creates a situation where commonly used plugins (such as <code class="literal">data</code> or <code class="literal">kibana_react</code>) have to migrate first.
Run <code class="literal">node scripts/find_plugins_without_ts_refs.js --id your_plugin_id</code> to get a list of plugins that should be switched to TS project refs to unblock your plugin migration.</p>
<p>Additionally, in order to migrate into project refs, you also need to make sure your plugin doesn&#8217;t have circular dependencies with other plugins both on code and type imports. We run a job in the CI for each PR trying to find if new circular dependencies are being added which runs our tool with <code class="literal">node scripts/find_plugins_with_circular_deps</code>. However there are also a couple of circular dependencies already identified and that are in an allowed list to be solved. You also need to make sure your plugin don&#8217;t rely in any other plugin into that allowed list. For a complete overview of the circular dependencies both found and in the allowed list as well as the complete circular dependencies path please run the following script locally with the debug flag <code class="literal">node scripts/find_plugins_with_circular_deps --debug</code> .</p>
<div class="position-relative"><h5><a id="_implementation"></a>Implementation</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/developer/best-practices/typescript.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Make sure all the plugins listed as dependencies in <span class="strong strong"><strong>requiredPlugins</strong></span>, <span class="strong strong"><strong>optionalPlugins</strong></span> &amp; <span class="strong strong"><strong>requiredBundles</strong></span> properties of <code class="literal">kibana.json</code> manifest file have migrated to TS project references.
</li>
<li class="listitem">
Add <code class="literal">tsconfig.json</code> in the root folder of your plugin.
</li>
</ul>
</div>
<pre class="screen">{
  "extends": "../../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./target/types",
    "emitDeclarationOnly": true,
    "declaration": true,
    "declarationMap": true
  },
  "include": [
    // add all the folders containing files to be compiled
  ],
  "references": [
    { "path": "../../core/tsconfig.json" },
    // add references to other TypeScript projects your plugin depends on
  ]
}</pre>
<p>If your plugin imports a file not listed in <code class="literal">include</code>, the build will fail with the next message <code class="literal">File ‘…’ is not listed within the file list of project …’. Projects must list all files or use an 'include' pattern.</code></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Build you plugin <code class="literal">./node_modules/.bin/tsc -b src/plugins/my_plugin</code>. Fix errors if <code class="literal">tsc</code> cannot generate type declarations for your project.
</li>
<li class="listitem">
Add your project reference to <code class="literal">references</code> property of <code class="literal">tsconfig.refs.json</code>
</li>
<li class="listitem">
Add your plugin to <code class="literal">references</code> property and plugin folder to <code class="literal">exclude</code> property of the <code class="literal">tsconfig.json</code> it used to belong to (for example, for <code class="literal">src/plugins/**</code> it&#8217;s <code class="literal">tsconfig.json</code>; for <code class="literal">x-pack/plugins/**</code> it’s <code class="literal">x-pack/tsconfig.json</code>).
</li>
<li class="listitem">
List the reference to your newly created project in all the Kibana <code class="literal">tsconfig.json</code> files that could import your project: <code class="literal">tsconfig.json</code>, <code class="literal">test/tsconfig.json</code>, <code class="literal">x-pack/tsconfig.json</code>, <code class="literal">x-pack/test/tsconfig.json</code>. And in all the plugin-specific <code class="literal">tsconfig.refs.json</code> for dependent plugins.
</li>
<li class="listitem">
You can measure how your changes affect <code class="literal">tsc</code> compiler performance with <code class="literal">node --max-old-space-size=4096 ./node_modules/.bin/tsc -p tsconfig.json --extendedDiagnostics --noEmit</code>. Compare with <code class="literal">master</code> branch.
</li>
</ul>
</div>
<p>You can use <a href="https://github.com/elastic/kibana/pull/79446" class="ulink" target="_top">https://github.com/elastic/kibana/pull/79446</a> as an example.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="security-best-practices.html">« Security best practices</a>
</span>
<span class="next">
<a href="kibana-architecture.html">Architecture »</a>
</span>
</div>
</body>
</html>
