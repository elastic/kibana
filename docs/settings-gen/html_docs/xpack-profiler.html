<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Profile queries and aggregations | Kibana Guide | Elastic</title>
<meta class="elastic" name="content" content="Profile queries and aggregations | Kibana Guide">

<link rel="home" href="index.html" title="Kibana Guide"/>
<link rel="up" href="devtools-kibana.html" title="Dev Tools"/>
<link rel="prev" href="console-kibana.html" title="Run API requests"/>
<link rel="next" href="xpack-grokdebugger.html" title="Debug grok expressions"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="navheader">
<span class="prev">
<a href="console-kibana.html">« Run API requests</a>
</span>
<span class="next">
<a href="xpack-grokdebugger.html">Debug grok expressions »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="devtools-kibana.html">Dev Tools</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Profile queries and aggregations</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/dev-tools/searchprofiler/index.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter xpack">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="xpack-profiler"></a>Profile queries and aggregations</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/dev-tools/searchprofiler/index.asciidoc">edit</a></div>
</div></div></div>
<p>Elasticsearch has a powerful <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-profile.html" class="ulink" target="_top">Profile API</a> that you can use to inspect and analyze
your search queries. The response returns a large JSON blob, which can be
difficult to analyze manually.</p>
<p>The <span class="strong strong"><strong>Search Profiler</strong></span> tool can transform this JSON output
into a visualization that is easy to navigate, allowing you to diagnose and debug
poorly performing queries much faster.</p>
<div class="position-relative"><h3><a id="search-profiler-getting-started"></a>Get started</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/dev-tools/searchprofiler/index.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Search Profiler</strong></span> is automatically enabled in Kibana. Open the main menu,
click <span class="strong strong"><strong>Dev Tools</strong></span>, and then click <span class="strong strong"><strong>Search Profiler</strong></span>
to get started.</p>
<p><span class="strong strong"><strong>Search Profiler</strong></span> displays the names of the indices searched, the shards in each index,
and how long it took for the query to complete. To try it out, replace the default <code class="literal">match_all</code> query
with the query you want to profile, and then click <span class="strong strong"><strong>Profile</strong></span>.</p>
<p>The following example shows the results of profiling the <code class="literal">match_all</code> query.
If you take a closer look at the information for the <code class="literal">.security_7</code> sample index, the
<span class="strong strong"><strong>Cumulative time</strong></span> field shows you that the query took 0.028ms to execute.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="dev-tools/searchprofiler/images/overview.png" alt="Search Profiler visualization">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The cumulative time metric is the sum of individual shard times.
It is not necessarily the actual time it took for the query to return (wall clock time).
Because shards might be processed in parallel on multiple nodes, the wall clock time can
be significantly less than the cumulative time. However, if shards are colocated on the
same node and executed serially, the wall clock time is closer to the cumulative time.</p>
<p>While the cumulative time metric is useful for comparing the performance of your
indices and shards, it doesn&#8217;t necessarily represent the actual physical query times.</p>
</div>
</div>
<p>To see more profiling information, click <span class="strong strong"><strong>View details</strong></span>. You&#8217;ll
see details about the query components that ran on the shard and the timing
breakdown of low-level methods. For more information, refer to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-profile.html#profiling-queries" class="ulink" target="_top">Profiling queries</a>.</p>
<div class="position-relative"><h3><a id="_filter_for_an_index_or_type"></a>Filter for an index or type</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/dev-tools/searchprofiler/index.asciidoc">edit</a></div>
<p>By default, all queries executed by the <span class="strong strong"><strong>Search Profiler</strong></span> are sent
to <code class="literal">GET /_search</code>. It searches across your entire cluster (all indices, all types).</p>
<p>To query a specific index or type, you can use the <span class="strong strong"><strong>Index</strong></span> filter.</p>
<p>In the following example, the query is executed against the indices <code class="literal">.security-7</code> and <code class="literal">kibana_sample_data_ecommerce</code>.
This is equivalent making a request to <code class="literal">GET /test,kibana_1/_search</code>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="dev-tools/searchprofiler/images/filter.png" alt="Filtering by index and type">
</div>
</div>
<div class="position-relative"><h3><a id="profile-complicated-query"></a>Profile a more complicated query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/dev-tools/searchprofiler/index.asciidoc">edit</a></div>
<p>To understand how the query trees are displayed inside the <span class="strong strong"><strong>Search Profiler</strong></span>,
take a look at a more complicated query.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Index the following data via <span class="strong strong"><strong>Console</strong></span>:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST test/_bulk
{"index":{}}
{"name":"aaron","age":23,"hair":"brown"}
{"index":{}}
{"name":"sue","age":19,"hair":"red"}
{"index":{}}
{"name":"sally","age":19,"hair":"blonde"}
{"index":{}}
{"name":"george","age":19,"hair":"blonde"}
{"index":{}}
{"name":"fred","age":69,"hair":"blonde"}</pre>
</div>
<div class="console_widget" data-snippet="snippets/15.console"></div>
</li>
<li class="listitem">
From the <span class="strong strong"><strong>Search Profiler</strong></span>, enter <span class="strong strong"><strong>test</strong></span> in the <span class="strong strong"><strong>Index</strong></span> field to restrict profiled
queries to the <code class="literal">test</code> index.
</li>
<li class="listitem">
<p>Replace the default <code class="literal">match_all</code> query in the query editor with a query that has two sub-query
components and includes a simple aggregation:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
   "query": {
      "bool": {
         "should": [
            {
               "match": {
                  "name": "fred"
               }
            },
            {
               "terms": {
                  "name": [
                      "sue",
                      "sally"
                  ]
               }
            }
         ]
      }
   },
   "aggs": {
      "stats": {
         "stats": {
            "field": "price"
         }
      }
   }
}</pre>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Profile</strong></span> to profile the query and visualize the results.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="dev-tools/searchprofiler/images/gs8.png" alt="Profiling the more complicated query">
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The top <code class="literal">BooleanQuery</code> component corresponds to the bool in the query.
</li>
<li class="listitem">
The second <code class="literal">BooleanQuery</code> corresponds to the terms query, which is internally
converted to a <code class="literal">Boolean</code> of should clauses. It has two child queries that correspond
to "sally" and "sue from the terms query.
</li>
<li class="listitem">
<p>The <code class="literal">TermQuery</code> that&#8217;s labeled with "name:fred" corresponds to match: fred in the query.</p>
<p>If you look at the time columns, you can see that <span class="strong strong"><strong>Self time</strong></span> and <span class="strong strong"><strong>Total time</strong></span> are no longer
identical on all the rows.  <span class="strong strong"><strong>Self time</strong></span> represents how long the query component took to execute.
<span class="strong strong"><strong>Total time</strong></span> is the time a query component and all its children took to execute.
Therefore, queries like the Boolean queries often have a larger total time than self time.</p>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Aggregation Profile</strong></span> to view aggregation profiling statistics.</p>
<p>This query includes a <code class="literal">stats</code> agg on the <code class="literal">"age"</code> field.
The <span class="strong strong"><strong>Aggregation Profile</strong></span> tab is only enabled when the query being profiled contains an aggregation.</p>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>View details</strong></span> to view the timing breakdown.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="dev-tools/searchprofiler/images/gs10.png" alt="Drilling into the first shard&#8217;s details">
</div>
</div>
<p>For more information about how the <span class="strong strong"><strong>Search Profiler</strong></span> works, how timings are calculated, and
how to interpret various results, see
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-profile.html#profiling-queries" class="ulink" target="_top">Profiling queries</a>.</p>
</li>
</ol>
</div>
<div class="position-relative"><h3><a id="profiler-render-JSON"></a>Render pre-captured profiler JSON</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/dev-tools/searchprofiler/index.asciidoc">edit</a></div>
<p>The <span class="strong strong"><strong>Search Profiler</strong></span> queries the cluster that the Kibana node is attached to.
It does this by executing the query against the cluster and collecting the results.</p>
<p>Sometimes you might want to investigate performance problems that are temporal in nature.
For example, a query might only be slow at certain time of day when many customers are using your system.
You can set up a process to automatically profile slow queries when they occur and then
save those profile responses for later analysis.</p>
<p>The <span class="strong strong"><strong>Search Profiler</strong></span> supports this workflow by allowing you to paste the
pre-captured JSON in the query editor.  The <span class="strong strong"><strong>Search Profiler</strong></span> will detect that you
have entered a JSON response (rather than a query) and will render just the visualization,
rather than querying the cluster.</p>
<p>To see how this works, copy and paste the following profile response into the
query editor and click <span class="strong strong"><strong>Profile</strong></span>.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
   "took": 3,
   "timed_out": false,
   "_shards": {
      "total": 1,
      "successful": 1,
      "failed": 0
   },
   "hits": {
      "total": 1,
      "max_score": 1.3862944,
      "hits": [
         {
            "_index": "test",
            "_type": "test",
            "_id": "AVi3aRDmGKWpaS38wV57",
            "_score": 1.3862944,
            "_source": {
               "name": "fred",
               "age": 69,
               "hair": "blonde"
            }
         }
      ]
   },
   "profile": {
      "shards": [
         {
            "id": "[O-l25nM4QN6Z68UA5rUYqQ][test][0]",
            "searches": [
               {
                  "query": [
                     {
                        "type": "BooleanQuery",
                        "description": "+name:fred #(ConstantScore(*:*))^0.0",
                        "time": "0.5884370000ms",
                        "breakdown": {
                           "score": 7243,
                           "build_scorer_count": 1,
                           "match_count": 0,
                           "create_weight": 196239,
                           "next_doc": 9851,
                           "match": 0,
                           "create_weight_count": 1,
                           "next_doc_count": 2,
                           "score_count": 1,
                           "build_scorer": 375099,
                           "advance": 0,
                           "advance_count": 0
                        },
                        "children": [
                           {
                              "type": "TermQuery",
                              "description": "name:fred",
                              "time": "0.3016880000ms",
                              "breakdown": {
                                 "score": 4218,
                                 "build_scorer_count": 1,
                                 "match_count": 0,
                                 "create_weight": 132425,
                                 "next_doc": 2196,
                                 "match": 0,
                                 "create_weight_count": 1,
                                 "next_doc_count": 2,
                                 "score_count": 1,
                                 "build_scorer": 162844,
                                 "advance": 0,
                                 "advance_count": 0
                              }
                           },
                           {
                              "type": "BoostQuery",
                              "description": "(ConstantScore(*:*))^0.0",
                              "time": "0.1223030000ms",
                              "breakdown": {
                                 "score": 0,
                                 "build_scorer_count": 1,
                                 "match_count": 0,
                                 "create_weight": 17366,
                                 "next_doc": 0,
                                 "match": 0,
                                 "create_weight_count": 1,
                                 "next_doc_count": 0,
                                 "score_count": 0,
                                 "build_scorer": 102329,
                                 "advance": 2604,
                                 "advance_count": 2
                              },
                              "children": [
                                 {
                                    "type": "MatchAllDocsQuery",
                                    "description": "*:*",
                                    "time": "0.03307600000ms",
                                    "breakdown": {
                                       "score": 0,
                                       "build_scorer_count": 1,
                                       "match_count": 0,
                                       "create_weight": 6068,
                                       "next_doc": 0,
                                       "match": 0,
                                       "create_weight_count": 1,
                                       "next_doc_count": 0,
                                       "score_count": 0,
                                       "build_scorer": 25615,
                                       "advance": 1389,
                                       "advance_count": 2
                                    }
                                 }
                              ]
                           }
                        ]
                     }
                  ],
                  "rewrite_time": 168640,
                  "collector": [
                     {
                        "name": "CancellableCollector",
                        "reason": "search_cancelled",
                        "time": "0.02952900000ms",
                        "children": [
                           {
                              "name": "SimpleTopScoreDocCollector",
                              "reason": "search_top_hits",
                              "time": "0.01931700000ms"
                           }
                        ]
                     }
                  ]
               }
            ],
            "aggregations": []
         }
      ]
   }
}</pre>
</div>
<p>Your output should look similar to this:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="dev-tools/searchprofiler/images/search-profiler-json.png" alt="Rendering pre-captured profiler JSON">
</div>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="console-kibana.html">« Run API requests</a>
</span>
<span class="next">
<a href="xpack-grokdebugger.html">Debug grok expressions »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
