[chapter]
[role="xpack"]
[[osquery]]
= Osquery

*Osquery* enables you to search, analyze, and visualize Osquery data ingested in {es}.  You can:

 * Run live queries with one or more agents
 * View a history of past queries and their results
 * Schedule queries to capture changes to OS state over time
 * Save queries and build a library of queries for specific use cases

A common use case is to centralize security analytics and contextualize the
Osquery results against other event data, anomalies, and threats.
Then use that context to improve host visibility, analytical power, and monitoring.

[float]
== System requirements

* {fleet-guide}/fleet-overview.html[Fleet] is enabled on your cluster, and
one or more {fleet-guide}/elastic-agent-installation-configuration.html[Elastic Agents] is enrolled.
* The https://docs.elastic.co/en/integrations/osquery_manager[Osquery Manager] has been added and configured
integration through Fleet.
This integration supports x86_64 bit Windows, Darwin, Arm64, and Linux platforms.
* *Osquery Manager* has one or more policies.

[float]
== Required privileges

To use *Osquery Manager*, you must be assigned to a role with the following privileges:

* `Read` privileges for the `logs-osquery_manager.result*` index.
* {kib} privileges for **Osquery Manager**. The `MatchAllFilter` privilege
enables you to run, schedule, and save queries. `Read`**` enables you to view and scheduled queries.

[float]
[[osquery-run-query]]
==  Run live queries

Run a query against one or more agents or policies
and view the results. This is useful for testing your query and
troubleshooting problems.

. Open the main menu, and then click *Osquery*.
. In the *Live queries* view, click **New live query**.
. Select one or more agents or groups to query. Start typing in the search field,
and you'll get suggestions for agents by name, ID, platform, and policy.
. Enter a query or select a query from your saved queries.
+
[role="screenshot"]
image::images/enter-query.png[Select saved query dropdown name showing query name and description]
. Click **Submit**.
. Review the results in a table, or navigate to *Discover* to dive deeper into the response
or to *Lens* to build visualizations.
. To view more information about the request, for example, if there are any failures, open the *Status* tab.
. When your query captures the data you want, click *Save for later* and define the ID,
description, and other
<<osquery-manage-query,details>>.

[float]
[[osquery-view-history]]
== View past queries

View a history of past queries and their results.

. Open the *Live queries history*.
. To replay a query, click image:images/play-icon.png[Right-pointing triangle].
. To view the query <<osquery-results,results>> and <<osquery-status,status>>,
click image:images/table-icon.png[Table icon].
+
[role="screenshot"]
image::images/live-query-check-results.png[Results of OSquery]


[float]
[[osquery-schedule-query]]
== Schedule queries

Group and schedule queries to run on a specified interval, in seconds.
For example, you might create a group that checks
for IT compliance-type issues and
another group that monitors for evidence of malware.

. Open the **Scheduled query groups** tab.

. Click a group name o view its details.
+
[role="screenshot"]
image::images/schedule-query.png[Each query has a name, id, query, platform, and min osquery version]

. Click *Edit* to make changes.
.. To add a query to the group, click *Add query*, and then enter the query ID and interval.
Optionally, set the minimum Osquery version and platform.
.. To upload queries from a .conf query pack, drag the pack to the drop zone under the query table. To explore the community packs that Osquery publishes, click *Example packs*.
. Click *Save query*. The queries run once the policy receives the update.

[float]
== Map Osquery fields to ECS fields

When scheduling queries, you can optionally map query results to ECS fields,
so that you can standardize your Osquery data for use across detections, machine learning,
and any other areas that rely on ECS-compliant data.
The query results then include both the original `osquery.<field>`
and the mapped ECS field. For example, if you update a query to map `osquery.name` to `user.name`
in ECS, the query results include both fields.

. Edit a scheduled query group, and then click the edit icon for the query that you want to map.

. In **ECS mapping**, select which Osquery result fields you want to map to ECS fields.
+
The fields available in the **Osquery.results** column are based on the SQL query entered
and only include fields that will be returned by the query.

. When mapping fields:
.. To add a new row for additional fields to map, click the plus icon.
.. To remove any mapped rows, click the trash icon.

. Click *Save* to save changes to the query.

. Click *Save query* to save changes to the group.


[float]
[[osquery-manage-query]]
== Manage your saved queries

View, run, and edit your saved queries on the *Saved queries* tab.
Queries have the following information:

* A unique identifier.
* A brief description.
* The SQL query.
* The defaults for the scheduled query group. This information is included when you
add the query to a scheduled query group.
** The frequency at which at which to run the query.
** The minimum https://github.com/osquery/osquery/releases)[version of osquery] required to run the query.
** The operating system required to run the query. For information about supported platforms per table, click the *OSquery schema* link on the *Edit query* flyout.



[float]
[[osquery-status]]
== Osquery status

A query can have the following status:

[cols="2*<"]
|===
| Successful | The query completed as expected.
| Failed | The query encountered a problem and might have failed, because there was an issue with the query or the agent was disconnected.
| Not yet responded | The query has not been sent to the agent.
| Expired | The action request timed out. The agent may be offline.
|===

NOTE: If an agent is offline, the request status remains **pending** as {kib} retries the request.
By default, a query request times out after 5 minutes. The time out applies to the time it takes
to deliver the action request to an agent to run a query. If the action completes after the timeout period,
the results are still returned.


[float]
[[osquery-results]]
== Osquery results

Osquery responses include the following information:

* Everything prefaced with `osquery.` is part of the query response. These fields are not mapped to ECS.
* The `host.*` and `agent.*` fields are mapped to ECS.
* The `action_data.query` has the query that was sent.
* All query results are https://osquery.readthedocs.io/en/stable/deployment/logging/#snapshot-logs[snapshot logs]
that represent a point in time with a set of results, with no differentials.
https://osquery.readthedocs.io/en/stable/deployment/logging/#differential-logs[Differential logs] are not supported.
* Osquery data is stored in the `logs-osquery_manager.result-default` datastream, and the result row data is under the `osquery` property in the document.

This example shows a successful osquery result.


```ts
{
  "_index": ".ds-logs-osquery_manager.result-default-2021.04.12-2021.04.12-000001",
  "_id": "R3ZwxngBKwN-X8eyQbxy",
  "_version": 1,
  "_score": null,
  "fields": {
    "osquery.seconds": [
      "7"
    ],
    "action_data.id": [
      "72d3ec71-7635-461e-a15d-f728819ae27f"
    ],
    "osquery.seconds.number": [
      7
    ],
    "osquery.hours.number": [
      6
    ],
    "host.hostname": [
      "MacBook-Pro.local"
    ],
    "type": [
      "MacBook-Pro.local"
    ],
    "host.mac": [
      "ad:de:48:00:12:22",
      "a6:83:e7:cb:91:ee"
    ],
    "osquery.total_seconds.number": [
      1060627
    ],
    "host.os.build": [
      "20D91"
    ],
    "host.ip": [
      "192.168.31.171",
      "fe80::b5b1:39ff:faa1:3b39"
    ],
    "agent.type": [
      "osquerybeat"
    ],
    "action_data.query": [
      "select * from uptime;"
    ],
    "osquery.minutes": [
      "37"
    ],
    "action_id": [
      "5099c02d-bd6d-4b88-af90-d80dcdc945df"
    ],
    "host.os.version": [
      "10.16"
    ],
    "host.os.kernel": [
      "20.3.0"
    ],
    "host.os.name": [
      "Mac OS X"
    ],
    "agent.name": [
      "MacBook-Pro.local"
    ],
    "host.name": [
      "MacBook-Pro.local"
    ],
    "osquery.total_seconds": [
      "1060627"
    ],
    "host.id": [
      "155D977D-8EA8-5BDE-94A2-D78A7B545198"
    ],
    "osquery.hours": [
      "6"
    ],
    "osquery.days": [
      "12"
    ],
    "host.os.type": [
      "macos"
    ],
    "osquery.days.number": [
      12
    ],
    "host.architecture": [
      "x86_64"
    ],
    "@timestamp": [
      "2021-04-12T14:15:45.060Z"
    ],
    "agent.id": [
      "196a0086-a612-48b1-930a-300565b3efaf"
    ],
    "host.os.platform": [
      "darwin"
    ],
    "ecs.version": [
      "1.8.0"
    ],
    "agent.ephemeral_id": [
      "5cb88e34-50fe-4c13-b81c-d2b7187505ea"
    ],
    "agent.version": [
      "7.13.0"
    ],
    "host.os.family": [
      "darwin"
    ],
    "osquery.minutes.number": [
      37
    ]
  }
}
```

This is an example of an **error response** for an undefined action query.

```ts
{
  "_index": ".ds-.fleet-actions-results-2021.04.10-000001",
  "_id": "qm7mvHgBKwN-X8eyYB1x",
  "_version": 1,
  "_score": null,
  "fields": {
    "completed_at": [
      "2021-04-10T17:48:32.268Z"
    ],
    "error.keyword": [
      "action undefined"
    ],
    "@timestamp": [
      "2021-04-10T17:48:32.000Z"
    ],
    "action_data.query": [
      "select * from uptime;"
    ],
    "action_data.id": [
      "2c95bb2c-8ab6-4e8c-ac01-a1abb693ea00"
    ],
    "agent_id": [
      "c21b4c9c-6f36-49f0-8b60-08490fc619ce"
    ],
    "action_id": [
      "53454d3b-c8cd-4a50-b5b4-f85da17b4be2"
    ],
    "started_at": [
      "2021-04-10T17:48:32.267Z"
    ],
    "error": [
      "action undefined"
    ]
  }
}
```

[float]
== Upgrade osquery versions

The https://github.com/osquery/osquery/releases[osquery version] available on an Elastic Agent
is tied to the version of Osquery Beat on the Agent.
To get the latest version of Osquery Beat,
https://www.elastic.co/guide/en/fleet/master/upgrade-elastic-agent.html[upgrade your Elastic Agent].

[float]
== Debug issues
If you encounter issues using Osquery Manager, find the relevant logs for the {elastic-agent}
and Osquerybeat in the installed agent directory, which will look similar to the following example paths.
Adjust the agent path as needed for your setup.

```ts
`/data/elastic-agent-054e22/logs/elastic-agent-json.log-*`
`/data/elastic-agent-054e22/logs/default/osquerybeat-json.log`
```

To get more details in the logs, change the agent logging level to debug:

. Open the main menu, and then select **Fleet**.
. Select the agent that you want to debug.
. On the **Logs** tab, change the **Agent logging level** to **debug**, and then click **Apply changes**.
+
This updates `agent.logging.level` in the `fleet.yml` file and sets the logging level to `debug`.
