[[TSVB]]
=== TSVB

*TSVB* requires a date field and supports <<aggregation-reference, most {es} metric aggregations>>, multiple visualization types, custom functions,
and some math. 

TIP: With *TSVB*, you can visualize the data from multiple series, but only *Timelion* can perform math across layers.

[role="screenshot"]
image::visualize/images/tsvb-screenshot.png[TSVB overview]

[float]
[[tsvb-required-choices]]
==== Open and set up TSVB

To create visualization panels with *TSVB*, 

. On the dashboard, click *Create panel*.

. On the *New visualization* window, click *TSVB*.

. In *TSVB*, click *Panel options*.

. Make sure the following settings are configured:

* *Index pattern*
* *Time field*
* *Interval*

. Specify if you want to display the last bucket, which usually contains partial data.

. In the *Panel filter* field, specify any <<kuery-query, KQL filters>> to select specific documents.

[float]
[[configure-the-data-series]]
==== Configure the series

Each of the series can be thought of as a separate {es} aggregation, which prevents
them from being compared with math. For each series, you configure the *Aggregation*, 
or function, and the *Options* that control the styling and {es} options. *Options* are inherited from *Panel options*.
When you have separate options for each series, you can compare different
{es} indices, and view two time ranges from the same index.

. From the *Aggregation* dropdown, select the function for the series. 

. To display each group separately, select one of the following options from the dropdown:

* *Filters* &mdash; Assigns a color to each filter.

* *Terms* &mdash; Displays special behavior in the *Time series* visualization. 
To configure the *Terms* options, click *Options*, then select an option from the *Split color theme* dropdown.

. Click *Options*, then configure the inputs for the function. 
+
Only the last function is displayed.

[float]
[[configure-the-visualizations]]
==== Configure the visualization-specific options

To configure *TSVB* visualizations, configure the visualization-specific options.

*Time Series*::
  By default, the y-axis displays the full range of data, including zero. To automatically scale the y-axis from
  the minimum to maximum values of the data:
  
  . Click Data > Options > Fill*.

  . In the *Fill* field, enter `0`.

  To add annotations to the x-axis based on timestamped documents in a separate {es} index:

  . Click *Annotations*.

  . Click *Add data source*, then configure the options.

All chart types except *Time Series*::
  To specify the timespan used for matching documents:
  
  . Click *Panel options*.
  
  . From the *Data timerange mode* dropdown, select an option. 

*Metric*, *Top N*, and *Gauge*::
  To add conditional coloring based on values:
  
  . Click *Panel options*.

  . Specify the *Color rules* options.

*Top N* and *Table*::
  When you click a series, *TSVB* applies a filter based
  on the series name. To open a URL instead of applying a filter:
  
  . Click *Panel options*.
  
  . In the *Item URL* field, enter the URL you want to open when you click the series.

*Markdown*::
  Use the Handlebar (mustache) syntax to insert dynamic data, or create
  custom CSS using the LESS syntax.

[float]
[[tsvb-function-reference]]
==== TSVB function reference

*TSVB* provides you with shortcuts for some frequently-used functions.

*Filter Ratio*::
  Returns a percent value by calculating a metric on two sets of documents. 
  For example, calculate the error rate as a percentage of the overall events over time.

*Counter Rate*::
  Used when dealing with monotonically increasing counters. Shortcut for *Max*, *Derivative*, and *Positive Only*.

*Positive Only*::
  Removes any negative values from the results, which can be used as a post-processing step
  after a derivative.

*Series Agg*::
  Applies a function to all of the *Group by* series to reduce the values to a single number.
  This function must always be the last metric in the series.
  For example, if the *Time Series* visualization shows 10 series, the sum *Series Agg* calculates
  the sum of all 10 bars and output a single Y value per X value. This is often confused
  with the overall sum function, which outputs a single Y value per unique series.

Math::
  The math context is able to do simple and advanced calculations per series.
  This function must always be the last metric in the series.

[float]
[[tsvb-faq]]
==== Frequently asked questions

Why is my TSVB visualization missing data?::
  * For *Time series* with a derivative function, increase the time interval. Click *Panel options*, then increase the *Interval* field. Derivatives require sequential values.
  * For all other *TSVB* visualizations, click *Panel options*, then select *Entire time range* from the *Data timerange mode* dropdown. 
    By default, *TSVB* displays the last whole bucket. For example, when you set the time filter to *Last 24 hours*, and the
    current time is 9:41, then *TSVB* metrics display only 10 minutes --- from 9:30 to 9:40.

How do I calculate the difference between two data series?::
  Performing math across data series is unsupported in *TSVB*. To calculate the difference between two data series, use <<create-panels-with-timelion, Timelion>> or <<vega, Vega>>.

How do I compare the current versus previous month?::
  While math is unsupported in *TSVB*, you can use time offsets to compare the data.

  . Click *Clone Series*, then choose a color for the new series.
  +
  [role="screenshot"]
  image::visualize/images/tsvb_clone_series.png[Clone Series action]
  
  . Click *Options*, then enter the offset value in the *Offset series time by* field.

How do I calculate a month over month change?::
  This is not fully supported in *TSVB*, but there is a special case that is supported _if_ the *TSVB*
  time filter is set to 3 months or more _and_ the *Interval* is `1m`. Use the `derivative`
  to get the absolute monthly change. To convert to a percent, add the *Math* function with the 
  `params.current / (params.current - params.derivative)` formula, then select *Percent* from the *Data Formatter* dropdown.
  +
  For other types of month over month calculations, use <<create-panels-with-timelion, Timelion>> or <<vega, Vega>>.

How do I calculate the duration between the start and end of an event?::
  *TSVB* requires pre-calculated durations and is unable to calculate the duration between the start and end of an event.
