# Models Elasticsearch response data as remote taint sources.
#
# In Kibana, data from Elasticsearch indices (log messages, user-generated content, etc.)
# flows through utility functions into React components. Since this data can contain
# arbitrary user-controlled content, it should be treated as a remote source for
# taint tracking purposes.
#
# This allows built-in CodeQL queries (XSS, injection, etc.) to automatically detect
# dangerous flows from ES data to security-sensitive sinks like dangerouslySetInnerHTML.

extensions:
  # ── @kbn/discover-utils: DataTableRecord builders ──────────────────────
  #
  # buildDataTableRecord wraps raw ES hits (SearchHit) into DataTableRecord objects.
  # The .flattened property contains field values directly from Elasticsearch.
  - addsTo:
      pack: codeql/javascript-all
      extensible: sourceModel
    data:
      # buildDataTableRecord(doc: EsHitRecord, ...) => DataTableRecord
      - ["@kbn/discover-utils", "Member[buildDataTableRecord].ReturnValue", "remote"]
      # buildDataTableRecordList({ records, ... }) => DataTableRecord[]
      - ["@kbn/discover-utils", "Member[buildDataTableRecordList].ReturnValue", "remote"]

  # ── @kbn/discover-utils: field value extractors ────────────────────────
  #
  # These functions extract field values from flattened ES documents.
  # Their return values contain user-controlled data from ES indices.
  - addsTo:
      pack: codeql/javascript-all
      extensible: sourceModel
    data:
      # getMessageFieldWithFallbacks(doc, opts) => { field, value, formattedValue }
      - ["@kbn/discover-utils", "Member[getMessageFieldWithFallbacks].ReturnValue", "remote"]
      # formatHit(hit, dataView, ...) => formatted record
      - ["@kbn/discover-utils", "Member[formatHit].ReturnValue", "remote"]
      # formatFieldValue(value, ...) => formatted string
      - ["@kbn/discover-utils", "Member[formatFieldValue].ReturnValue", "remote"]

  # ── @elastic/elasticsearch: search client ──────────────────────────────
  #
  # The Elasticsearch client's search methods return data from ES indices.
  # This covers server-side code that directly uses the ES client.
  - addsTo:
      pack: codeql/javascript-all
      extensible: sourceModel
    data:
      # client.search() => SearchResponse
      - ["@elastic/elasticsearch", "Member[Client].Instance.Member[search].ReturnValue", "remote"]
      # client.get() => GetResponse
      - ["@elastic/elasticsearch", "Member[Client].Instance.Member[get].ReturnValue", "remote"]
      # client.mget() => MgetResponse
      - ["@elastic/elasticsearch", "Member[Client].Instance.Member[mget].ReturnValue", "remote"]
