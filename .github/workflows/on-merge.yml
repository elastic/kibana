on:
  pull_request_target:
    types:
      - closed
      - labeled
      - unlabeled

jobs:
  on-merge:
    name: 'Label and Backport'
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
        (github.event.action == 'closed' ||
          (github.event.action == 'labeled' &&
            (github.event.label.name == 'backport:prev-minor' ||
              github.event.label.name == 'backport:prev-major' ||
              github.event.label.name == 'backport:current-major' ||
              github.event.label.name == 'backport:all-open' ||
              github.event.label.name == 'backport:version' ||
              github.event.label.name == 'auto-backport')) ||
          (github.event.action == 'unlabeled' &&
            github.event.label.name == 'backport:skip' &&
            (contains(github.event.pull_request.labels.*.name, 'backport:prev-minor') ||
              contains(github.event.pull_request.labels.*.name, 'backport:prev-major') ||
              contains(github.event.pull_request.labels.*.name, 'backport:current-major') ||
              contains(github.event.pull_request.labels.*.name, 'backport:all-open') ||
              contains(github.event.pull_request.labels.*.name, 'backport:version') ||
              contains(github.event.pull_request.labels.*.name, 'auto-backport'))))
    steps:
      - name: Checkout Actions
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0
        with:
          repository: 'elastic/kibana-github-actions'
          ref: main
          path: ./actions

      - name: Install Actions
        run: npm install --production --prefix ./actions

      - name: Run On-Merge
        uses: ./actions/on-merge
        with:
          github_token: ${{secrets.KIBANAMACHINE_TOKEN}}
