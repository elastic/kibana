name: Check and Complete Team Labels

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  issues: write

jobs:
  ensure-team-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Check and add missing labels
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const currentLabels = context.payload.issue.labels.map(l => l.name);

            const hasDetectionEngine = currentLabels.includes("Team:Detection Engine");
            const hasRuleManagement = currentLabels.includes("Team:Detection Rule Management");

            const detectionGroup = [
              "Team:Detection Engine",
              "Team:Detections and Resp",
              "Team:Security Solution",
              "triage_needed"
            ];

            const ruleManagementGroup = [
              "Team:Detection Rule Management",
              "Team:Detections and Resp",
              "Team:Security Solution",
              "triage_needed"
            ];

            const labelsToAdd = new Set();

            // Add missing labels for Detection Engine group
            if (hasDetectionEngine) {
              for (const label of detectionGroup) {
                if (!currentLabels.includes(label)) {
                  labelsToAdd.add(label);
                }
              }
            }

            // Add missing labels for Rule Management group
            if (hasRuleManagement) {
              for (const label of ruleManagementGroup) {
                if (!currentLabels.includes(label)) {
                  labelsToAdd.add(label);
                }
              }
            }

            // Add 'needs-team' when only shared labels are present (ambiguous ownership)
            const hasOnlyShared =
              !hasDetectionEngine &&
              !hasRuleManagement &&
              (currentLabels.includes("Team:Security Solution") || currentLabels.includes("Team:Detections and Resp"));

            if (hasOnlyShared) {
              if (!currentLabels.includes("needs-team")) {
                labelsToAdd.add("needs-team");
              }
              if (!currentLabels.includes("triage_needed")) {
                labelsToAdd.add("triage_needed");
              }
            }

            if (labelsToAdd.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labelsToAdd)
              });
              console.log(`Added missing labels: ${Array.from(labelsToAdd).join(", ")}`);
            } else {
              console.log("No labels to add.");
            }