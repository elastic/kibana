name: Generate machine learning API docs
on:
  pull_request_target:
    paths:
     - 'x-pack/plugins/ml/common/openapi/ml_apis_v3.yaml'
    types:
      - opened
      - synchronize
    brances:
      - main
      - 8.6
jobs:
  runs-on: ubuntu-latest
  steps:
    - name: checkout_pr_branch
      uses: actions/checkout@v2
      with:
        repository: 'origin/kibana'
        ref: ${{ github.head_ref }}
        token: ${{secrets.KIBANAMACHINE_TOKEN}}
    - name: install_libraries
      needs: [checkout_pr_branch]
      run: |
        npm install -g yarn
        yarn global add @openapitools/openapi-generator-cli standard-version
    - name: run_generator
      needs: [install_libraries]
      run: |
        openapi-generator-cli generate -i x-pack/plugins/ml/common/openapi/ml_apis_v3.yaml -g html -o docs/api-generated/machine-learning -t docs/api-generated/template
    - name: rename_output_file
      needs: [run_generator]
      run:
        mv docs/api-generated/machine-learning/index.html docs/api-generated/machine-learning/ml-apis-passthru.asciidoc
    - name: commit_changes
      needs: [rename_output_file]
      run: |
        git config user.name "Github Actions Bot"
        git config user.email "<>"
        git add docs/api-generated/machine-learning/ml-apis-passthru.asciidoc
        git clean -f docs/api-generated/machine-learning/.openapi-generator
        git clean -f
        git commit -m "Automated APIs" --allow-empty
    - name: push_changes
      needs: [commit_changes]
      if: ${{ success() }}
      run: |
        git push origin ${{ github.head_ref }}