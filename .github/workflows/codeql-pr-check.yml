name: "CodeQL PR Check"

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, ready_for_review ]

jobs:
  check:
    name: Check CodeQL conditions
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'ci:codeql')
    permissions:
      contents: read
      actions: write
    outputs:
      granted: ${{ contains(fromJSON('["MEMBER", "COLLABORATOR", "CONTRIBUTOR"]'), github.event.pull_request.author_association) && github.event.pull_request.user.type != 'Bot' && github.event.pull_request.draft == false }}
    steps:
      - name: Check conditions
        run: |
          if [[ "${{ job.outputs.granted }}" == "true" ]]; then
            echo "Triggering CodeQL analysis"
          else
            echo "Skipping CodeQL analysis"
          fi

      - name: Trigger CodeQL Analysis
        if: job.outputs.granted == 'true'
        uses: peter-evans/repository-dispatch@2.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: codeql-analyze
          client-payload: |
            {
              "pr_number": ${{ github.event.pull_request.number }},
              "pr_head_sha": "${{ github.event.pull_request.head.sha }}",
              "pr_head_ref": "${{ github.event.pull_request.head.ref }}"
            }
