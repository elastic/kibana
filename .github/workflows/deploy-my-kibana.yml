---
##
## This the automation to let Observability team members to deploy a Kibana instance
## using the Observability test environments.
## It will deploy a new instance for those who add a comment /oblt-deploy
## only supported for Elasticians.
##
## Owner: @elastic/observablt-robots
## Further details: https://ela.st/oblt-deploy-my-kibana
##
name: deploy-my-kibana

on:
  issue_comment:
    types:
      - created

permissions:
  contents: read

jobs:
  trim-github-comment:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/oblt-deploy') }}
    runs-on: ubuntu-latest
    outputs:
      comment: ${{ steps.trim.outputs.result }}
    steps:
      - id: trim
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            core.setOutput("result", `${{ github.event.comment.body }}`.trim());

  deploy-my-kibana:
    runs-on: ubuntu-latest
    needs: [ trim-github-comment ]
    if: ${{ needs.trim-github-comment.outputs.comment == '/oblt-deploy' }}
    permissions:
      # if you listen for PRs, use this to use some comment reactions
      pull-requests: write
    steps:
      - uses: elastic/oblt-actions/oblt-cli/deploy-my-kibana@v1
        with:
          github-app-id: ${{ secrets.OBS_AUTOMATION_APP_ID }}
          github-app-private-key: ${{ secrets.OBS_AUTOMATION_APP_PEM }}
