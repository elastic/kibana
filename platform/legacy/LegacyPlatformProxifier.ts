import { Server } from 'net';
import { IncomingMessage, OutgoingMessage } from 'http';
import { EventEmitter } from 'events';

import { Logger } from '../logging';

/**
 * Represents "proxy" between legacy and current platform.
 * @internal
 */
export class LegacyPlatformProxifier extends EventEmitter {
  private server: Server;
  private readonly eventHandlers: any;

  constructor(
    private readonly log: Logger,
    private readonly startPlatform: () => Promise<void>,
    private readonly stopPlatform: () => Promise<void>
  ) {
    super();

    const forwardEvent = (name: string) => (...args: any[]) => {
      this.log.debug(`Event is being forwarded: ${name}`);
      this.emit(name, ...args);
    };

    // HapiJS expects that the following events will be generated by `listener`, see:
    // https://github.com/hapijs/hapi/blob/v14.2.0/lib/connection.js.
    this.eventHandlers = {
      listening: forwardEvent('listening'),
      error: forwardEvent('error'),
      clientError: forwardEvent('clientError'),
      connection: forwardEvent('connection')
    };
  }

  address() {
    return this.server && this.server.address();
  }

  async listen(port: number, host: string, callback?: () => void) {
    this.log.debug(`"listen" has been called (${host}:${port}).`);

    await this.startPlatform();

    callback && callback();
  }

  async close(callback?: () => void) {
    this.log.debug('"close" has been called.');

    await this.stopPlatform();

    callback && callback();
  }

  getConnections(callback: (error?: Error, count?: number) => void) {
    // This method is used by `even-better` (before we start platform).
    // It seems that the latest version of parent `good` doesn't use this anymore.
    if (this.server) {
      this.server.getConnections(callback);
    } else {
      callback(undefined, 0);
    }
  }

  bind(server: Server) {
    if (this.server) {
      for (const [eventName, eventHandler] of Object.entries(
        this.eventHandlers
      )) {
        this.server.removeListener(eventName, eventHandler);
      }
    }

    this.server = server;
    for (const [eventName, eventHandler] of Object.entries(
      this.eventHandlers
    )) {
      this.server.addListener(eventName, eventHandler);
    }
  }

  proxy(request: IncomingMessage, response: OutgoingMessage) {
    this.log.debug(
      `Request will be handled by proxy ${request.method}:${request.url}.`
    );
    this.emit('request', request, response);
  }
}
