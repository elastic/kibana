define("panels/trends/module",["angular","app","underscore","kbn"],function(e,t,n,r){var i=e.module("kibana.panels.trends",[]);t.useModule(i),i.controller("trends",["$scope","kbnIndex","querySrv","dashboard","filterSrv",function(e,t,i,s,o){function f(e,t){return e===0?null:100*(t-e)/e}e.panelMeta={editorTabs:[{title:"Queries",src:"app/partials/querySelect.html"}],status:"Beta",description:'A stock-ticker style representation of how queries are moving over time. For example, if the time is 1:10pm, your time picker was set to "Last 10m", and the "Time Ago" parameter was set to \'1h\', the panel would show how much the query results have changed since 12:00-12:10pm'};var u={queries:{mode:"all",ids:[]},style:{"font-size":"14pt"},ago:"1d",arrangement:"vertical"};n.defaults(e.panel,u),e.init=function(){e.hits=0,e.$on("refresh",function(){e.get_data()}),e.get_data()},e.get_data=function(u,f){delete e.panel.error,e.panelMeta.loading=!0;if(s.indices.length===0)return;e.index=u>0?e.index:s.indices
,e.panel.queries.ids=i.idsByMode(e.panel.queries);var l=n.uniq(n.pluck(o.getByType("time"),"field"));if(l.length>1){e.panel.error="Time field must be consistent amongst time filters";return}if(l.length===0){e.panel.error="A time filter must exist for this panel to function";return}l=l[0],e.time=o.timeRange("min"),e.old_time={from:new Date(e.time.from.getTime()-r.interval_to_seconds(e.panel.ago)*1e3),to:new Date(e.time.to.getTime()-r.interval_to_seconds(e.panel.ago)*1e3)};var c=n.isUndefined(u)?0:u,h=e.ejs.Request(),p=n.difference(o.ids,o.idsByType("time"));n.each(e.panel.queries.ids,function(t){var n=e.ejs.FilteredQuery(i.getEjsObj(t),o.getBoolFilter(p).must(e.ejs.RangeFilter(l).from(e.time.from).to(e.time.to)));h=h.facet(e.ejs.QueryFacet(t).query(n)).size(0)}),n.each(e.panel.queries.ids,function(t){var n=e.ejs.FilteredQuery(i.getEjsObj(t),o.getBoolFilter(p).must(e.ejs.RangeFilter(l).from(e.old_time.from).to(e.old_time.to)));h=h.facet(e.ejs.QueryFacet("old_"+t).query(n)).size(0)}),c===0?
t.indices(e.old_time.from,e.old_time.to,s.current.index.pattern,s.current.index.interval).then(function(t){e.index=n.union(t,e.index),h=h.indices(e.index[c]),a(h.doSearch(),c,f)}):a(h.indices(e.index[c]).doSearch(),c,f)};var a=function(t,r,s){t.then(function(t){e.panelMeta.loading=!1,r===0&&(e.hits={},e.data=[],s=e.query_id=(new Date).getTime());if(!n.isUndefined(t.error)){e.panel.error=e.parse_error(t.error);return}var o=n.map(n.keys(t.facets),function(e){if(!isNaN(e))return parseInt(e,10)});if(e.query_id===s&&n.intersection(o,e.panel.queries.ids).length===e.panel.queries.ids.length){var u=0;n.each(e.panel.queries.ids,function(s){var o=t.facets[s].count,a=t.facets["old_"+s].count,l={"new":n.isUndefined(e.data[u])||r===0?o:e.data[u].hits.new+o,old:n.isUndefined(e.data[u])||r===0?a:e.data[u].hits.old+a};e.hits.new+=o,e.hits.old+=a;var c=f(l.old,l.new)==null?"?":Math.round(f(l.old,l.new)*100)/100;e.data[u]={info:i.list[s],hits:{"new":l.new,old:l.old},percent:c},u++}),e.$emit("render"),r<e
.index.length-1?e.get_data(r+1,s):e.trends=e.data}})};e.set_refresh=function(t){e.refresh=t},e.close_edit=function(){e.refresh&&e.get_data(),e.refresh=!1,e.$emit("render")}}])});