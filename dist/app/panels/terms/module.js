define("panels/terms/module",["angular","app","underscore","jquery","kbn"],function(e,t,n,r,i){var s=e.module("kibana.panels.terms",[]);t.useModule(s),s.controller("terms",["$scope","querySrv","dashboard","filterSrv",function(t,r,i,s){t.panelMeta={editorTabs:[{title:"Queries",src:"app/partials/querySelect.html"}],status:"Beta",description:"Displays the results of an elasticsearch facet as a pie chart, bar chart, or a table"};var o={queries:{mode:"all",ids:[]},field:"_type",exclude:[],missing:!0,other:!0,size:10,order:"count",style:{"font-size":"10pt"},donut:!1,tilt:!1,labels:!0,arrangement:"horizontal",chart:"bar",counter_pos:"above",spyable:!0};n.defaults(t.panel,o),t.init=function(){t.hits=0,t.$on("refresh",function(){t.get_data()}),t.get_data()},t.get_data=function(){if(i.indices.length===0)return;t.panelMeta.loading=!0;var o,u,a;o=t.ejs.Request().indices(i.indices),t.panel.queries.ids=r.idsByMode(t.panel.queries),a=t.ejs.BoolQuery(),n.each(t.panel.queries.ids,function(e){a=a.should(
r.getEjsObj(e))}),o=o.facet(t.ejs.TermsFacet("terms").field(t.panel.field).size(t.panel.size).order(t.panel.order).exclude(t.panel.exclude).facetFilter(t.ejs.QueryFilter(t.ejs.FilteredQuery(a,s.getBoolFilter(s.ids))))).size(0),t.inspector=e.toJson(JSON.parse(o.toString()),!0),u=o.doSearch(),u.then(function(e){var r=0;t.panelMeta.loading=!1,t.hits=e.hits.total,t.data=[],n.each(e.facets.terms.terms,function(e){var n={label:e.term,data:[[r,e.count]],actions:!0};t.data.push(n),r+=1}),t.data.push({label:"Missing field",data:[[r,e.facets.terms.missing]],meta:"missing",color:"#aaa",opacity:0}),t.data.push({label:"Other values",data:[[r+1,e.facets.terms.other]],meta:"other",color:"#444"}),t.$emit("render")})},t.build_search=function(e,r){if(n.isUndefined(e.meta))s.set({type:"terms",field:t.panel.field,value:e.label,mandate:r?"mustNot":"must"});else{if(e.meta!=="missing")return;s.set({type:"exists",field:t.panel.field,mandate:r?"must":"mustNot"})}i.refresh()},t.set_refresh=function(e){t.refresh=
e},t.close_edit=function(){t.refresh&&t.get_data(),t.refresh=!1,t.$emit("render")},t.showMeta=function(e){return n.isUndefined(e.meta)?!0:e.meta==="other"&&!t.panel.other?!1:e.meta==="missing"&&!t.panel.missing?!1:!0}}]),s.directive("termsChart",["querySrv",function(t){return{restrict:"A",link:function(s,o){function u(){var e,i;o.css({height:s.panel.height||s.row.height}),i=n.clone(s.data),i=s.panel.missing?i:n.without(i,n.findWhere(i,{meta:"missing"})),i=s.panel.other?i:n.without(i,n.findWhere(i,{meta:"other"})),require(["jquery.flot.pie"],function(){try{s.panel.chart==="bar"&&(e=r.plot(o,i,{legend:{show:!1},series:{lines:{show:!1},bars:{show:!0,fill:1,barWidth:.8,horizontal:!1},shadowSize:1},yaxis:{show:!0,min:0,color:"#c8c8c8"},xaxis:{show:!1},grid:{borderWidth:0,borderColor:"#eee",color:"#eee",hoverable:!0,clickable:!0},colors:t.colors}));if(s.panel.chart==="pie"){var n=function(e,t){return"<div ng-click=\"build_search(panel.field,'"+e+"')"+' "style="font-size:8pt;text-align:center;padding:2px;color:white;">'+
e+"<br/>"+Math.round(t.percent)+"%</div>"};e=r.plot(o,i,{legend:{show:!1},series:{pie:{innerRadius:s.panel.donut?.4:0,tilt:s.panel.tilt?.45:1,radius:1,show:!0,combine:{color:"#999",label:"The Rest"},stroke:{width:0},label:{show:s.panel.labels,radius:2/3,formatter:n,threshold:.1}}},grid:{hoverable:!0,clickable:!0},colors:t.colors})}o.is(":visible")&&setTimeout(function(){s.legend=e.getData(),s.$$phase||s.$apply()})}catch(u){o.text(u)}})}s.$on("render",function(){u()}),e.element(window).bind("resize",function(){u()}),o.bind("plotclick",function(e,t,n){n&&s.build_search(s.data[n.seriesIndex])});var a=r("<div>");o.bind("plothover",function(e,t,n){if(n){var r=s.panel.chart==="bar"?n.datapoint[1]:n.datapoint[1][0][1];a.html(i.query_color_dot(n.series.color,20)+" "+n.series.label+" ("+r.toFixed(0)+")").place_tt(t.pageX,t.pageY)}else a.remove()})}}}])});