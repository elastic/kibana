define("panels/derivequeries/module",["angular","app","underscore"],function(e,t,n){var r=e.module("kibana.panels.derivequeries",[]);t.useModule(r),r.controller("derivequeries",["$scope","$rootScope","querySrv","fields","dashboard","filterSrv",function(t,r,i,s,o,u){t.panelMeta={status:"Experimental",description:"Creates a new set of queries using the Elasticsearch terms facet. For example, you might want to create 5 queries showing the most frequent HTTP response codes. Be careful not to select a high cardinality field, as Elasticsearch must load all unique values into memory."};var a={loading:!1,label:"Search",query:"*",ids:[],field:"_type",fields:[],spyable:!0,rest:!1,size:5,mode:"terms only",exclude:[],history:[],remember:10};n.defaults(t.panel,a),t.init=function(){t.editing=!1,t.panel.fields=s.list},t.get_data=function(){f(t.panel.query);if(o.indices.length===0)return;t.panelMeta.loading=!0;var e=t.ejs.Request().indices(o.indices);e=e.facet(t.ejs.TermsFacet("query").field(t.panel.field
).size(t.panel.size).exclude(t.panel.exclude).facetFilter(t.ejs.QueryFilter(t.ejs.FilteredQuery(t.ejs.QueryStringQuery(t.panel.query||"*"),u.getBoolFilter(u.ids))))).size(0),t.populate_modal(e);var r=e.doSearch();r.then(function(e){t.panelMeta.loading=!1;var r;t.panel.query===""||t.panel.mode==="terms only"?r="":t.panel.mode==="AND"?r=" AND ("+t.panel.query+")":t.panel.mode==="OR"&&(r=" OR ("+t.panel.query+")");var s=[],u=e.facets.query.terms,a=[];n.each(u,function(e){var n=t.panel.field+':"'+e.term+'"'+r,o=i.findQuery(n);o?s.push(o.id):s.push(i.set({alias:e.term,query:n})),a.push("NOT ("+n+")")});if(t.panel.rest){var f=a.join(" AND "),l=i.findQuery(f);l?s.push(l.id):s.push(i.set({alias:"other",query:f}))}n.each(n.difference(t.panel.ids,s),function(e){i.remove(e)}),t.panel.ids=s,o.refresh()})},t.set_refresh=function(e){t.refresh=e},t.close_edit=function(){t.refresh&&t.get_data(),t.refresh=!1},t.populate_modal=function(n){t.inspector=e.toJson(JSON.parse(n.toString()),!0)};var f=function(
e){e=n.isArray(e)?e:[e];if(t.panel.remember>0){t.panel.history=n.union(e.reverse(),t.panel.history);var r=t.panel.history.length;r>t.panel.remember&&(t.panel.history=t.panel.history.slice(0,t.panel.remember))}}}])});